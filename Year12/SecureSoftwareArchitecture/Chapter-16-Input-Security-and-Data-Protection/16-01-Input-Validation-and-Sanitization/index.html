
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Comprehensive educational resource for NSW HSC Software Engineering syllabus">
      
      
      
        <link rel="canonical" href="https://eatham532.github.io/Software-Engineering-HSC-Textbook/Year12/SecureSoftwareArchitecture/Chapter-16-Input-Security-and-Data-Protection/16-01-Input-Validation-and-Sanitization/">
      
      
        <link rel="prev" href="../../Chapter-15-Core-Security-Principles/15-02-Cryptography-and-Data-Protection/quiz/">
      
      
        <link rel="next" href="quiz/">
      
      
      <link rel="icon" href="../../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.21">
    
    
      
        <title>Content - Software Engineering Textbook HSC</title>
      
    
    
      <link rel="stylesheet" href="../../../../assets/stylesheets/main.2a3383ac.min.css">
      
        
        <link rel="stylesheet" href="../../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../../assets/diagram-modal.css">
    
      <link rel="stylesheet" href="../../../../assets/quiz.css">
    
      <link rel="stylesheet" href="../../../../assets/common.css">
    
      <link rel="stylesheet" href="../../../../assets/diagram-fix.css">
    
      <link rel="stylesheet" href="../../../../assets/cross-reference.css">
    
      <link rel="stylesheet" href="../../../../assets/site-banner.css">
    
      <link rel="stylesheet" href="../../../../assets/code-runner.css">
    
      <link rel="stylesheet" href="../../../../assets/code-editor.css">
    
    <script>__md_scope=new URL("../../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config","G-58275RL1P9"),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","G-58275RL1P9",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=G-58275RL1P9",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script>
  
    <script>if("undefined"!=typeof __md_analytics){var consent=__md_get("__consent");consent&&consent.analytics&&__md_analytics()}</script>
  

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#section-161-input-validation-sanitization" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
  
  
    
    
    
    <div class="site-banner site-banner--warning" data-banner data-banner-version="1" role="status" aria-live="polite">
      <div class="site-banner__inner">
        <span class="site-banner__icon" aria-hidden="true">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            
              <path d="M12 9v4"/><path d="M12 17h.01"/><path d="M10.29 3.86 1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0Z"/>
            
          </svg>
        </span>
        <p class="site-banner__text">
          This textbook is in <strong>beta</strong> – content is actively being refined.
          
            <a class="site-banner__link" href="https://github.com/Eatham532/Software-Engineering-HSC-Textbook/issues/new/choose" target="_blank" rel="noopener">Report issues or suggestions</a>
          
        </p>
        <button type="button" class="site-banner__close" aria-label="Dismiss banner" title="Dismiss" data-banner-dismiss>&times;</button>
      </div>
    </div>
    <script>
      (function(){
        var banner=document.querySelector('[data-banner]');
        if(!banner) return;
        var version=banner.getAttribute('data-banner-version')||'1';
        var KEY='site_banner_dismissed_v'+version;
        try{ if(localStorage.getItem(KEY)){ banner.remove(); return;} }catch(e){}
        var btn=banner.querySelector('[data-banner-dismiss]');
        if(btn){ btn.addEventListener('click',function(){
          banner.classList.add('is-hiding');
          setTimeout(function(){ banner && banner.remove(); },200);
          try{ localStorage.setItem(KEY,'1'); }catch(e){}
        }); }
      })();
    </script>
  
  
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../../.." title="Software Engineering Textbook HSC" class="md-header__button md-logo" aria-label="Software Engineering Textbook HSC" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Software Engineering Textbook HSC
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Content
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m14.3 16-.7-2h-3.2l-.7 2H7.8L11 7h2l3.2 9zM20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12zm-9.15 3.96h2.3L12 9z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="black" data-md-color-accent="indigo"  aria-label="Switch to system preference"  type="radio" name="__palette" id="__palette_2">
    
      <label class="md-header__button md-icon" title="Switch to system preference" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/Eatham532/Software-Engineering-HSC-Textbook/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    Eatham532/Software-Engineering-HSC-Textbook
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    

    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../.." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../Year11/ProgrammingFundamentals/" class="md-tabs__link">
          
  
  
  Year 11

        </a>
      </li>
    
  

    
  

      
        
  
  
  
    
  
  
    
    
      
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../../../ProgrammingForTheWeb/" class="md-tabs__link">
          
  
  
  Year 12

        </a>
      </li>
    
  

    
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../../code-editor/" class="md-tabs__link">
        
  
  
    
  
  Code Editor

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../.." title="Software Engineering Textbook HSC" class="md-nav__button md-logo" aria-label="Software Engineering Textbook HSC" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Software Engineering Textbook HSC
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/Eatham532/Software-Engineering-HSC-Textbook/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    Eatham532/Software-Engineering-HSC-Textbook
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
  
    
  
  
  
    <a href="../../../../Year11/ProgrammingFundamentals/" class="md-nav__link">
      
  
  
  <span class="md-ellipsis">
    Year 11
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

  

      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
      
    
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Year 12
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Year 12
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
  
    <a href="../../../ProgrammingForTheWeb/" class="md-nav__link">
      
  
  
  <span class="md-ellipsis">
    Programming For The Web
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
    
      
      
    
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_2" checked>
        
          
          <label class="md-nav__link" for="__nav_3_2" id="__nav_3_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Secure Software Architecture
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3_2">
            <span class="md-nav__icon md-icon"></span>
            Secure Software Architecture
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
  
    
  
  
  
    <a href="../../Chapter-14-Security-Foundations/14-01-The-Business-Case-for-Security/" class="md-nav__link">
      
  
  
  <span class="md-ellipsis">
    Chapter 14 — Security Foundations
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
  
    
  
  
  
    <a href="../../Chapter-15-Core-Security-Principles/15-01-Security-Fundamentals-CIA-Triad-and-AAA/" class="md-nav__link">
      
  
  
  <span class="md-ellipsis">
    Chapter 15 — Core Security Principles
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

  

      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
    
      
      
    
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_2_4" checked>
        
          
          <label class="md-nav__link" for="__nav_3_2_4" id="__nav_3_2_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Chapter 16 — Input Security and Data Protection
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_2_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3_2_4">
            <span class="md-nav__icon md-icon"></span>
            Chapter 16 — Input Security and Data Protection
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    
    
    
    
      
      
    
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_2_4_1" checked>
        
          
          <label class="md-nav__link" for="__nav_3_2_4_1" id="__nav_3_2_4_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    16.1 Input Validation and Sanitization
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_3_2_4_1_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3_2_4_1">
            <span class="md-nav__icon md-icon"></span>
            16.1 Input Validation and Sanitization
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Content
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Content
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#learning-objectives" class="md-nav__link">
    <span class="md-ellipsis">
      Learning Objectives
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#why-input-validation-matters" class="md-nav__link">
    <span class="md-ellipsis">
      Why Input Validation Matters
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sql-injection-prevention" class="md-nav__link">
    <span class="md-ellipsis">
      SQL Injection Prevention
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SQL Injection Prevention">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#vulnerable-code-example" class="md-nav__link">
    <span class="md-ellipsis">
      Vulnerable Code Example
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#secure-implementation-with-parameterized-queries" class="md-nav__link">
    <span class="md-ellipsis">
      Secure Implementation with Parameterized Queries
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cross-site-scripting-xss-prevention" class="md-nav__link">
    <span class="md-ellipsis">
      Cross-Site Scripting (XSS) Prevention
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Cross-Site Scripting (XSS) Prevention">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#types-of-xss-attacks" class="md-nav__link">
    <span class="md-ellipsis">
      Types of XSS Attacks
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#secure-input-sanitization-and-output-encoding" class="md-nav__link">
    <span class="md-ellipsis">
      Secure Input Sanitization and Output Encoding
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#input-validation-strategies-whitelist-vs-blacklist" class="md-nav__link">
    <span class="md-ellipsis">
      Input Validation Strategies: Whitelist vs Blacklist
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Input Validation Strategies: Whitelist vs Blacklist">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#whitelist-approach-recommended" class="md-nav__link">
    <span class="md-ellipsis">
      Whitelist Approach (Recommended)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#blacklist-approach-use-with-caution" class="md-nav__link">
    <span class="md-ellipsis">
      Blacklist Approach (Use with Caution)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#safe-error-message-design" class="md-nav__link">
    <span class="md-ellipsis">
      Safe Error Message Design
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#file-upload-security" class="md-nav__link">
    <span class="md-ellipsis">
      File Upload Security
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#summary" class="md-nav__link">
    <span class="md-ellipsis">
      Summary
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="quiz/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Quiz
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
  
    <a href="../16-02-Privacy-by-Design/" class="md-nav__link">
      
  
  
  <span class="md-ellipsis">
    16.2 Privacy by Design
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
  
    
  
  
  
    <a href="../../Chapter-17-System-Security-and-APIs/17-01-Secure-API-Design/" class="md-nav__link">
      
  
  
  <span class="md-ellipsis">
    Chapter 17 — System Security and APIs
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
  
    
  
  
  
    <a href="../../Chapter-18-Security-Testing-and-Vulnerabilities/18-01-Security-Testing-Fundamentals/" class="md-nav__link">
      
  
  
  <span class="md-ellipsis">
    Chapter 18 — Security Testing & Vulnerabilities
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
  
    
  
  
  
    <a href="../../Chapter-19-Security-in-Context/19-01-Security-in-Development-Teams/" class="md-nav__link">
      
  
  
  <span class="md-ellipsis">
    Chapter 19 — Security in Context
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

  

      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
  
    <a href="../../../SoftwareAutomation/" class="md-nav__link">
      
  
  
  <span class="md-ellipsis">
    Software Automation
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
  
    <a href="../../../SoftwareEngineeringProject/" class="md-nav__link">
      
  
  
  <span class="md-ellipsis">
    Software Engineering Project
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../code-editor/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Code Editor
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#learning-objectives" class="md-nav__link">
    <span class="md-ellipsis">
      Learning Objectives
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#why-input-validation-matters" class="md-nav__link">
    <span class="md-ellipsis">
      Why Input Validation Matters
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sql-injection-prevention" class="md-nav__link">
    <span class="md-ellipsis">
      SQL Injection Prevention
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SQL Injection Prevention">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#vulnerable-code-example" class="md-nav__link">
    <span class="md-ellipsis">
      Vulnerable Code Example
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#secure-implementation-with-parameterized-queries" class="md-nav__link">
    <span class="md-ellipsis">
      Secure Implementation with Parameterized Queries
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cross-site-scripting-xss-prevention" class="md-nav__link">
    <span class="md-ellipsis">
      Cross-Site Scripting (XSS) Prevention
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Cross-Site Scripting (XSS) Prevention">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#types-of-xss-attacks" class="md-nav__link">
    <span class="md-ellipsis">
      Types of XSS Attacks
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#secure-input-sanitization-and-output-encoding" class="md-nav__link">
    <span class="md-ellipsis">
      Secure Input Sanitization and Output Encoding
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#input-validation-strategies-whitelist-vs-blacklist" class="md-nav__link">
    <span class="md-ellipsis">
      Input Validation Strategies: Whitelist vs Blacklist
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Input Validation Strategies: Whitelist vs Blacklist">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#whitelist-approach-recommended" class="md-nav__link">
    <span class="md-ellipsis">
      Whitelist Approach (Recommended)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#blacklist-approach-use-with-caution" class="md-nav__link">
    <span class="md-ellipsis">
      Blacklist Approach (Use with Caution)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#safe-error-message-design" class="md-nav__link">
    <span class="md-ellipsis">
      Safe Error Message Design
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#file-upload-security" class="md-nav__link">
    <span class="md-ellipsis">
      File Upload Security
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#summary" class="md-nav__link">
    <span class="md-ellipsis">
      Summary
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
    <a href="https://github.com/Eatham532/Software-Engineering-HSC-Textbook/edit/main/docs/Year12/SecureSoftwareArchitecture/Chapter-16-Input-Security-and-Data-Protection/16-01-Input-Validation-and-Sanitization/index.md" title="Edit this page" class="md-content__button md-icon" rel="edit">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4zm10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1z"/></svg>
    </a>
  
  
    
      
    
    <a href="https://github.com/Eatham532/Software-Engineering-HSC-Textbook/raw/main/docs/Year12/SecureSoftwareArchitecture/Chapter-16-Input-Security-and-Data-Protection/16-01-Input-Validation-and-Sanitization/index.md" title="View source of this page" class="md-content__button md-icon">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 18c.56 0 1 .44 1 1s-.44 1-1 1-1-.44-1-1 .44-1 1-1m0-3c-2.73 0-5.06 1.66-6 4 .94 2.34 3.27 4 6 4s5.06-1.66 6-4c-.94-2.34-3.27-4-6-4m0 6.5a2.5 2.5 0 0 1-2.5-2.5 2.5 2.5 0 0 1 2.5-2.5 2.5 2.5 0 0 1 2.5 2.5 2.5 2.5 0 0 1-2.5 2.5M9.27 20H6V4h7v5h5v4.07c.7.08 1.36.25 2 .49V8l-6-6H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h4.5a8.2 8.2 0 0 1-1.23-2"/></svg>
    </a>
  


<h1 id="section-161-input-validation-sanitization">Section 16.1: Input Validation &amp; Sanitization<a class="headerlink" href="#section-161-input-validation-sanitization" title="Permanent link">&para;</a></h1>
<h2 id="learning-objectives">Learning Objectives<a class="headerlink" href="#learning-objectives" title="Permanent link">&para;</a></h2>
<p>By the end of this section, you will be able to:</p>
<ul>
<li>
<p><strong>Prevent SQL injection attacks</strong> through proper input validation and parameterized queries</p>
</li>
<li>
<p><strong>Mitigate XSS (Cross-Site Scripting)</strong> vulnerabilities with input sanitization and output encoding</p>
</li>
<li>
<p><strong>Apply input validation strategies</strong> using whitelist and blacklist approaches effectively</p>
</li>
<li>
<p><strong>Design safe error messages</strong> that don&rsquo;t leak sensitive system information</p>
</li>
<li>
<p><strong>Implement secure file upload</strong> functionality with proper validation and restrictions</p>
</li>
</ul>
<h2 id="why-input-validation-matters">Why Input Validation Matters<a class="headerlink" href="#why-input-validation-matters" title="Permanent link">&para;</a></h2>
<p>Input validation is the first line of defense against many of the most dangerous web application vulnerabilities. According to the OWASP Top 10, injection attacks consistently rank as the #1 security risk.</p>
<p><strong>Without proper input validation:</strong></p>
<ul>
<li>
<p>Attackers can inject malicious SQL commands to access or modify database data</p>
</li>
<li>
<p>Cross-site scripting attacks can steal user sessions and execute malicious scripts</p>
</li>
<li>
<p>File uploads can introduce malware or allow system compromise</p>
</li>
<li>
<p>Data corruption can occur from malformed input</p>
</li>
<li>
<p>System resources can be exhausted through malicious input</p>
</li>
</ul>
<h2 id="sql-injection-prevention">SQL Injection Prevention<a class="headerlink" href="#sql-injection-prevention" title="Permanent link">&para;</a></h2>
<p>SQL injection occurs when user input is directly concatenated into SQL queries, allowing attackers to inject malicious SQL commands.</p>
<h3 id="vulnerable-code-example">Vulnerable Code Example<a class="headerlink" href="#vulnerable-code-example" title="Permanent link">&para;</a></h3>
<div class="language-python highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">sqlite3</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="c1"># VULNERABLE: Never do this!</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_user_vulnerable</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Example of vulnerable SQL injection code - DO NOT USE&quot;&quot;&quot;</span>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>    <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;users.db&#39;</span><span class="p">)</span>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>    <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>    <span class="c1"># Dangerous: Direct string concatenation</span>
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>    <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;SELECT * FROM users WHERE username = &#39;</span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s2">&#39; AND password = &#39;</span><span class="si">{</span><span class="n">password</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>
</span><span id="__span-0-14"><a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Executing query: </span><span class="si">{</span><span class="n">query</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># This would reveal the vulnerability</span>
</span><span id="__span-0-15"><a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>
</span><span id="__span-0-16"><a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
</span><span id="__span-0-17"><a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>    <span class="n">result</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
</span><span id="__span-0-18"><a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>
</span><span id="__span-0-19"><a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="__span-0-20"><a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>    <span class="k">return</span> <span class="n">result</span>
</span><span id="__span-0-21"><a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>
</span><span id="__span-0-22"><a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a><span class="c1"># How an attacker could exploit this:</span>
</span><span id="__span-0-23"><a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a><span class="c1"># username: admin&#39; OR &#39;1&#39;=&#39;1&#39; --</span>
</span><span id="__span-0-24"><a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a><span class="c1"># This creates the query: SELECT * FROM users WHERE username = &#39;admin&#39; OR &#39;1&#39;=&#39;1&#39; --&#39; AND password = &#39;...&#39;</span>
</span><span id="__span-0-25"><a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a><span class="c1"># The -- comments out the password check, bypassing authentication</span>
</span></code></pre></div>
<h3 id="secure-implementation-with-parameterized-queries">Secure Implementation with Parameterized Queries<a class="headerlink" href="#secure-implementation-with-parameterized-queries" title="Permanent link">&para;</a></h3>
<div class="highlight python-template" data-fence-type="template" data-language="python">
<pre><code class="language-python"><span class="kn">import</span><span class="w"> </span><span class="nn">sqlite3</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">hashlib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">secrets</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span>

<span class="k">class</span><span class="w"> </span><span class="nc">SecureDatabaseManager</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;secure_users.db&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db_path</span> <span class="o">=</span> <span class="n">db_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setup_database</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">setup_database</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize database with secure schema&quot;&quot;&quot;</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db_path</span><span class="p">)</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

        <span class="c1"># Create users table with proper constraints</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">            CREATE TABLE IF NOT EXISTS users (</span>
<span class="s1">                id INTEGER PRIMARY KEY AUTOINCREMENT,</span>
<span class="s1">                username TEXT UNIQUE NOT NULL,</span>
<span class="s1">                email TEXT UNIQUE NOT NULL,</span>
<span class="s1">                password_hash TEXT NOT NULL,</span>
<span class="s1">                salt TEXT NOT NULL,</span>
<span class="s1">                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,</span>
<span class="s1">                last_login TIMESTAMP,</span>
<span class="s1">                failed_login_attempts INTEGER DEFAULT 0,</span>
<span class="s1">                account_locked BOOLEAN DEFAULT FALSE</span>
<span class="s1">            )</span>
<span class="s1">        &#39;&#39;&#39;</span><span class="p">)</span>

        <span class="c1"># Create audit log table</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">            CREATE TABLE IF NOT EXISTS audit_log (</span>
<span class="s1">                id INTEGER PRIMARY KEY AUTOINCREMENT,</span>
<span class="s1">                user_id INTEGER,</span>
<span class="s1">                action TEXT NOT NULL,</span>
<span class="s1">                ip_address TEXT,</span>
<span class="s1">                timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP,</span>
<span class="s1">                success BOOLEAN,</span>
<span class="s1">                details TEXT</span>
<span class="s1">            )</span>
<span class="s1">        &#39;&#39;&#39;</span><span class="p">)</span>

        <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">authenticate_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">ip_address</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;unknown&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Securely authenticate user with parameterized queries&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_username</span><span class="p">(</span><span class="n">username</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_password</span><span class="p">(</span><span class="n">password</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log_authentication_attempt</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;authentication&quot;</span><span class="p">,</span> <span class="n">ip_address</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;Invalid input format&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db_path</span><span class="p">)</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Use parameterized query to prevent SQL injection</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">                SELECT id, username, email, password_hash, salt, account_locked, failed_login_attempts</span>
<span class="s1">                FROM users </span>
<span class="s1">                WHERE username = ? AND account_locked = FALSE</span>
<span class="s1">            &#39;&#39;&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">username</span><span class="p">,))</span>

            <span class="n">user_data</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">user_data</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log_authentication_attempt</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;authentication&quot;</span><span class="p">,</span> <span class="n">ip_address</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;User not found or locked&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>

            <span class="n">user_id</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">password_hash</span><span class="p">,</span> <span class="n">salt</span><span class="p">,</span> <span class="n">account_locked</span><span class="p">,</span> <span class="n">failed_attempts</span> <span class="o">=</span> <span class="n">user_data</span>

            <span class="c1"># Verify password</span>
            <span class="n">provided_hash</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hash_password</span><span class="p">(</span><span class="n">password</span><span class="p">,</span> <span class="n">salt</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">secrets</span><span class="o">.</span><span class="n">compare_digest</span><span class="p">(</span><span class="n">provided_hash</span><span class="p">,</span> <span class="n">password_hash</span><span class="p">):</span>
                <span class="c1"># Successful authentication</span>
                <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">                    UPDATE users </span>
<span class="s1">                    SET last_login = CURRENT_TIMESTAMP, failed_login_attempts = 0</span>
<span class="s1">                    WHERE id = ?</span>
<span class="s1">                &#39;&#39;&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">user_id</span><span class="p">,))</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_log_authentication_attempt</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="s2">&quot;authentication&quot;</span><span class="p">,</span> <span class="n">ip_address</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;Successful login&quot;</span><span class="p">)</span>

                <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

                <span class="k">return</span> <span class="p">{</span>
                    <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">,</span>
                    <span class="s1">&#39;username&#39;</span><span class="p">:</span> <span class="n">username</span><span class="p">,</span>
                    <span class="s1">&#39;email&#39;</span><span class="p">:</span> <span class="n">email</span><span class="p">,</span>
                    <span class="s1">&#39;authenticated&#39;</span><span class="p">:</span> <span class="kc">True</span>
                <span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Failed authentication - increment failed attempts</span>
                <span class="n">new_failed_attempts</span> <span class="o">=</span> <span class="n">failed_attempts</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">account_locked</span> <span class="o">=</span> <span class="n">new_failed_attempts</span> <span class="o">&gt;=</span> <span class="mi">5</span>

                <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">                    UPDATE users </span>
<span class="s1">                    SET failed_login_attempts = ?, account_locked = ?</span>
<span class="s1">                    WHERE id = ?</span>
<span class="s1">                &#39;&#39;&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">new_failed_attempts</span><span class="p">,</span> <span class="n">account_locked</span><span class="p">,</span> <span class="n">user_id</span><span class="p">))</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_log_authentication_attempt</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="s2">&quot;authentication&quot;</span><span class="p">,</span> <span class="n">ip_address</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> 
                                               <span class="sa">f</span><span class="s2">&quot;Failed password attempt </span><span class="si">{</span><span class="n">new_failed_attempts</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
                <span class="k">return</span> <span class="kc">None</span>

        <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">Error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log_authentication_attempt</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;authentication&quot;</span><span class="p">,</span> <span class="n">ip_address</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Database error: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Securely create new user with input validation&quot;&quot;&quot;</span>

        <span class="c1"># Validate all inputs</span>
        <span class="n">validation_errors</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_username</span><span class="p">(</span><span class="n">username</span><span class="p">):</span>
            <span class="n">validation_errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Invalid username format&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_email</span><span class="p">(</span><span class="n">email</span><span class="p">):</span>
            <span class="n">validation_errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Invalid email format&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_password_strength</span><span class="p">(</span><span class="n">password</span><span class="p">):</span>
            <span class="n">validation_errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Password does not meet security requirements&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">validation_errors</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="n">validation_errors</span>

        <span class="c1"># Generate salt and hash password</span>
        <span class="n">salt</span> <span class="o">=</span> <span class="n">secrets</span><span class="o">.</span><span class="n">token_hex</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>
        <span class="n">password_hash</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hash_password</span><span class="p">(</span><span class="n">password</span><span class="p">,</span> <span class="n">salt</span><span class="p">)</span>

        <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db_path</span><span class="p">)</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Use parameterized query to safely insert user</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">                INSERT INTO users (username, email, password_hash, salt)</span>
<span class="s1">                VALUES (?, ?, ?, ?)</span>
<span class="s1">            &#39;&#39;&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">password_hash</span><span class="p">,</span> <span class="n">salt</span><span class="p">))</span>

            <span class="n">user_id</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">lastrowid</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_log_authentication_attempt</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="s2">&quot;user_creation&quot;</span><span class="p">,</span> <span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;User created successfully&quot;</span><span class="p">)</span>

            <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;User created successfully&quot;</span>

        <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">IntegrityError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;username&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;Username already exists&quot;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="s2">&quot;email&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;Email already registered&quot;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;User creation failed&quot;</span><span class="p">]</span>
        <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">Error</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;Database error occurred&quot;</span><span class="p">]</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">search_users</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">search_term</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">search_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;username&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Securely search users with parameterized queries&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_search_input</span><span class="p">(</span><span class="n">search_term</span><span class="p">,</span> <span class="n">search_type</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db_path</span><span class="p">)</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">search_type</span> <span class="o">==</span> <span class="s2">&quot;username&quot;</span><span class="p">:</span>
                <span class="c1"># Use LIKE with parameterized query for safe search</span>
                <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">                    SELECT id, username, email, created_at</span>
<span class="s1">                    FROM users</span>
<span class="s1">                    WHERE username LIKE ? AND account_locked = FALSE</span>
<span class="s1">                    LIMIT 50</span>
<span class="s1">                &#39;&#39;&#39;</span><span class="p">,</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;%</span><span class="si">{</span><span class="n">search_term</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">,))</span>

            <span class="k">elif</span> <span class="n">search_type</span> <span class="o">==</span> <span class="s2">&quot;email&quot;</span><span class="p">:</span>
                <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">                    SELECT id, username, email, created_at</span>
<span class="s1">                    FROM users</span>
<span class="s1">                    WHERE email LIKE ? AND account_locked = FALSE</span>
<span class="s1">                    LIMIT 50</span>
<span class="s1">                &#39;&#39;&#39;</span><span class="p">,</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;%</span><span class="si">{</span><span class="n">search_term</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">,))</span>

            <span class="n">results</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>

            <span class="k">return</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="s1">&#39;username&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                    <span class="s1">&#39;email&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                    <span class="s1">&#39;created_at&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                <span class="p">}</span>
                <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">results</span>
            <span class="p">]</span>

        <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">Error</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_username</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate username format&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">username</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">username</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">username</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Only allow alphanumeric characters and underscores</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^[a-zA-Z0-9_]+$&#39;</span><span class="p">,</span> <span class="n">username</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_email</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate email format&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">email</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">email</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">254</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
        <span class="n">email_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$&#39;</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">email_pattern</span><span class="p">,</span> <span class="n">email</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_password</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Basic password validation&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">password</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">password</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">128</span>  <span class="c1"># Prevent DoS through large passwords</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_password_strength</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate password meets security requirements&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">password</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">password</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">8</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">password</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">128</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Check for required character types</span>
        <span class="n">has_upper</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">isupper</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">password</span><span class="p">)</span>
        <span class="n">has_lower</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">islower</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">password</span><span class="p">)</span>
        <span class="n">has_digit</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">password</span><span class="p">)</span>
        <span class="n">has_special</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">c</span> <span class="ow">in</span> <span class="s2">&quot;!@#$%^&amp;*()_+-=[]</span><span class="si">{}</span><span class="s2">|;:,.&lt;&gt;?&quot;</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">password</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">has_upper</span> <span class="ow">and</span> <span class="n">has_lower</span> <span class="ow">and</span> <span class="n">has_digit</span> <span class="ow">and</span> <span class="n">has_special</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_search_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">search_term</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">search_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate search parameters&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">search_term</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">search_term</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">search_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;username&quot;</span><span class="p">,</span> <span class="s2">&quot;email&quot;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Prevent injection through search terms</span>
        <span class="n">dangerous_chars</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s2">&quot;;&quot;</span><span class="p">,</span> <span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="s2">&quot;/*&quot;</span><span class="p">,</span> <span class="s2">&quot;*/&quot;</span><span class="p">,</span> <span class="s2">&quot;xp_&quot;</span><span class="p">,</span> <span class="s2">&quot;sp_&quot;</span><span class="p">]</span>
        <span class="n">search_lower</span> <span class="o">=</span> <span class="n">search_term</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

        <span class="k">return</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">dangerous</span> <span class="ow">in</span> <span class="n">search_lower</span> <span class="k">for</span> <span class="n">dangerous</span> <span class="ow">in</span> <span class="n">dangerous_chars</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_hash_password</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">salt</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Hash password with salt&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">pbkdf2_hmac</span><span class="p">(</span><span class="s1">&#39;sha256&#39;</span><span class="p">,</span> <span class="n">password</span><span class="o">.</span><span class="n">encode</span><span class="p">(),</span> <span class="n">salt</span><span class="o">.</span><span class="n">encode</span><span class="p">(),</span> <span class="mi">100000</span><span class="p">)</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_log_authentication_attempt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">action</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
                                  <span class="n">ip_address</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">success</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">details</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Log authentication attempts for security monitoring&quot;&quot;&quot;</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db_path</span><span class="p">)</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">                INSERT INTO audit_log (user_id, action, ip_address, success, details)</span>
<span class="s1">                VALUES (?, ?, ?, ?, ?)</span>
<span class="s1">            &#39;&#39;&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">ip_address</span><span class="p">,</span> <span class="n">success</span><span class="p">,</span> <span class="n">details</span><span class="p">))</span>

            <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">Error</span><span class="p">:</span>
            <span class="k">pass</span>  <span class="c1"># Don&#39;t let logging errors affect main functionality</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="c1"># Demonstration of SQL injection protection</span>
<span class="k">def</span><span class="w"> </span><span class="nf">demonstrate_sql_injection_protection</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Demonstrate secure database operations&quot;&quot;&quot;</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=== SQL Injection Protection Demo ===&quot;</span><span class="p">)</span>

    <span class="n">db_manager</span> <span class="o">=</span> <span class="n">SecureDatabaseManager</span><span class="p">()</span>

    <span class="c1"># Create test users</span>
    <span class="n">test_users</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="s2">&quot;admin&quot;</span><span class="p">,</span> <span class="s2">&quot;admin@school.edu&quot;</span><span class="p">,</span> <span class="s2">&quot;SecurePassword123!&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;student1&quot;</span><span class="p">,</span> <span class="s2">&quot;student1@school.edu&quot;</span><span class="p">,</span> <span class="s2">&quot;MyPassword456@&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;teacher&quot;</span><span class="p">,</span> <span class="s2">&quot;teacher@school.edu&quot;</span><span class="p">,</span> <span class="s2">&quot;TeachPass789#&quot;</span><span class="p">)</span>
    <span class="p">]</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Creating test users...&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">username</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">password</span> <span class="ow">in</span> <span class="n">test_users</span><span class="p">:</span>
        <span class="n">success</span><span class="p">,</span> <span class="n">message</span> <span class="o">=</span> <span class="n">db_manager</span><span class="o">.</span><span class="n">create_user</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">=== Testing Legitimate Authentication ===&quot;</span><span class="p">)</span>

    <span class="c1"># Test legitimate login</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">db_manager</span><span class="o">.</span><span class="n">authenticate_user</span><span class="p">(</span><span class="s2">&quot;admin&quot;</span><span class="p">,</span> <span class="s2">&quot;SecurePassword123!&quot;</span><span class="p">,</span> <span class="s2">&quot;192.168.1.100&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">user</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ Successful login: </span><span class="si">{</span><span class="n">user</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;❌ Authentication failed&quot;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">=== Testing SQL Injection Attempts ===&quot;</span><span class="p">)</span>

    <span class="c1"># Common SQL injection attempts that would fail</span>
    <span class="n">injection_attempts</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="s2">&quot;admin&#39; OR &#39;1&#39;=&#39;1&#39; --&quot;</span><span class="p">,</span> <span class="s2">&quot;anything&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;admin&#39;; DROP TABLE users; --&quot;</span><span class="p">,</span> <span class="s2">&quot;password&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;&#39; UNION SELECT * FROM users --&quot;</span><span class="p">,</span> <span class="s2">&quot;test&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;admin&#39; OR 1=1 #&quot;</span><span class="p">,</span> <span class="s2">&quot;password&quot;</span><span class="p">)</span>
    <span class="p">]</span>

    <span class="k">for</span> <span class="n">malicious_username</span><span class="p">,</span> <span class="n">password</span> <span class="ow">in</span> <span class="n">injection_attempts</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Attempting injection: </span><span class="si">{</span><span class="n">malicious_username</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">db_manager</span><span class="o">.</span><span class="n">authenticate_user</span><span class="p">(</span><span class="n">malicious_username</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="s2">&quot;192.168.1.200&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">user</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  ❌ SECURITY BREACH: Injection successful!&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  ✅ Injection blocked by parameterized queries&quot;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">=== Testing Secure Search ===&quot;</span><span class="p">)</span>

    <span class="c1"># Test search functionality</span>
    <span class="n">search_results</span> <span class="o">=</span> <span class="n">db_manager</span><span class="o">.</span><span class="n">search_users</span><span class="p">(</span><span class="s2">&quot;admin&quot;</span><span class="p">,</span> <span class="s2">&quot;username&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Search results for &#39;admin&#39;: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">search_results</span><span class="p">)</span><span class="si">}</span><span class="s2"> users found&quot;</span><span class="p">)</span>

    <span class="c1"># Test search with potential injection</span>
    <span class="n">malicious_search</span> <span class="o">=</span> <span class="s2">&quot;&#39;; DROP TABLE users; --&quot;</span>
    <span class="n">search_results</span> <span class="o">=</span> <span class="n">db_manager</span><span class="o">.</span><span class="n">search_users</span><span class="p">(</span><span class="n">malicious_search</span><span class="p">,</span> <span class="s2">&quot;username&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Malicious search results: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">search_results</span><span class="p">)</span><span class="si">}</span><span class="s2"> users found (should be 0)&quot;</span><span class="p">)</span>
</code></pre>
</div>
<h2 id="cross-site-scripting-xss-prevention">Cross-Site Scripting (XSS) Prevention<a class="headerlink" href="#cross-site-scripting-xss-prevention" title="Permanent link">&para;</a></h2>
<p>XSS attacks inject malicious scripts into web applications that execute in other users&rsquo; browsers, potentially stealing sessions, credentials, or personal data.</p>
<h3 id="types-of-xss-attacks">Types of XSS Attacks<a class="headerlink" href="#types-of-xss-attacks" title="Permanent link">&para;</a></h3>
<p><strong>Stored XSS</strong>: Malicious script stored in database and executed when data is displayed
<strong>Reflected XSS</strong>: Malicious script reflected back from server in response
<strong>DOM-based XSS</strong>: Client-side script modifies page DOM in unsafe way</p>
<h3 id="secure-input-sanitization-and-output-encoding">Secure Input Sanitization and Output Encoding<a class="headerlink" href="#secure-input-sanitization-and-output-encoding" title="Permanent link">&para;</a></h3>
<div class="highlight python-template" data-fence-type="template" data-language="python">
<pre><code class="language-python"><span class="kn">import</span><span class="w"> </span><span class="nn">html</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">bleach</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">urllib.parse</span><span class="w"> </span><span class="kn">import</span> <span class="n">quote</span><span class="p">,</span> <span class="n">unquote</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span>

<span class="k">class</span><span class="w"> </span><span class="nc">XSSProtectionManager</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Define allowed HTML tags and attributes for rich content</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">allowed_tags</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="s1">&#39;br&#39;</span><span class="p">,</span> <span class="s1">&#39;strong&#39;</span><span class="p">,</span> <span class="s1">&#39;em&#39;</span><span class="p">,</span> <span class="s1">&#39;u&#39;</span><span class="p">,</span> <span class="s1">&#39;ol&#39;</span><span class="p">,</span> <span class="s1">&#39;ul&#39;</span><span class="p">,</span> <span class="s1">&#39;li&#39;</span><span class="p">,</span> 
            <span class="s1">&#39;h1&#39;</span><span class="p">,</span> <span class="s1">&#39;h2&#39;</span><span class="p">,</span> <span class="s1">&#39;h3&#39;</span><span class="p">,</span> <span class="s1">&#39;h4&#39;</span><span class="p">,</span> <span class="s1">&#39;h5&#39;</span><span class="p">,</span> <span class="s1">&#39;h6&#39;</span><span class="p">,</span> <span class="s1">&#39;blockquote&#39;</span>
        <span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">allowed_attributes</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;*&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;class&#39;</span><span class="p">],</span>  <span class="c1"># Allow class attribute on all tags</span>
            <span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;href&#39;</span><span class="p">,</span> <span class="s1">&#39;title&#39;</span><span class="p">],</span>  <span class="c1"># Allow href and title on links</span>
            <span class="s1">&#39;img&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;src&#39;</span><span class="p">,</span> <span class="s1">&#39;alt&#39;</span><span class="p">,</span> <span class="s1">&#39;width&#39;</span><span class="p">,</span> <span class="s1">&#39;height&#39;</span><span class="p">]</span>  <span class="c1"># Allow specific attributes on images</span>
        <span class="p">}</span>

        <span class="c1"># Protocols allowed in links</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">allowed_protocols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;http&#39;</span><span class="p">,</span> <span class="s1">&#39;https&#39;</span><span class="p">,</span> <span class="s1">&#39;mailto&#39;</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">sanitize_html_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_input</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">allow_html</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sanitize HTML input to prevent XSS attacks&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">user_input</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">allow_html</span><span class="p">:</span>
            <span class="c1"># For plain text input, escape all HTML</span>
            <span class="k">return</span> <span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">user_input</span><span class="p">)</span>

        <span class="c1"># For rich text input, use bleach to allow safe HTML only</span>
        <span class="n">cleaned</span> <span class="o">=</span> <span class="n">bleach</span><span class="o">.</span><span class="n">clean</span><span class="p">(</span>
            <span class="n">user_input</span><span class="p">,</span>
            <span class="n">tags</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">allowed_tags</span><span class="p">,</span>
            <span class="n">attributes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">allowed_attributes</span><span class="p">,</span>
            <span class="n">protocols</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">allowed_protocols</span><span class="p">,</span>
            <span class="n">strip</span><span class="o">=</span><span class="kc">True</span>  <span class="c1"># Remove disallowed tags entirely</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">cleaned</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">sanitize_url_parameter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param_value</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sanitize URL parameters to prevent XSS through URL manipulation&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">param_value</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>

        <span class="c1"># URL decode first to catch double-encoded attacks</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">decoded</span> <span class="o">=</span> <span class="n">unquote</span><span class="p">(</span><span class="n">param_value</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">decoded</span> <span class="o">=</span> <span class="n">param_value</span>

        <span class="c1"># Check for common XSS patterns</span>
        <span class="n">dangerous_patterns</span> <span class="o">=</span> <span class="p">[</span>
            <span class="sa">r</span><span class="s1">&#39;&lt;script[^&gt;]*&gt;.*?&lt;/script&gt;&#39;</span><span class="p">,</span>
            <span class="sa">r</span><span class="s1">&#39;javascript:&#39;</span><span class="p">,</span>
            <span class="sa">r</span><span class="s1">&#39;vbscript:&#39;</span><span class="p">,</span>
            <span class="sa">r</span><span class="s1">&#39;onload\s*=&#39;</span><span class="p">,</span>
            <span class="sa">r</span><span class="s1">&#39;onerror\s*=&#39;</span><span class="p">,</span>
            <span class="sa">r</span><span class="s1">&#39;onclick\s*=&#39;</span><span class="p">,</span>
            <span class="sa">r</span><span class="s1">&#39;onmouseover\s*=&#39;</span><span class="p">,</span>
            <span class="sa">r</span><span class="s1">&#39;&lt;iframe[^&gt;]*&gt;&#39;</span><span class="p">,</span>
            <span class="sa">r</span><span class="s1">&#39;&lt;object[^&gt;]*&gt;&#39;</span><span class="p">,</span>
            <span class="sa">r</span><span class="s1">&#39;&lt;embed[^&gt;]*&gt;&#39;</span>
        <span class="p">]</span>

        <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">dangerous_patterns</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">decoded</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">):</span>
                <span class="k">return</span> <span class="s2">&quot;&quot;</span>  <span class="c1"># Reject the entire parameter if dangerous content found</span>

        <span class="c1"># Escape HTML entities</span>
        <span class="n">sanitized</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">decoded</span><span class="p">)</span>

        <span class="c1"># Limit length to prevent DoS</span>
        <span class="k">return</span> <span class="n">sanitized</span><span class="p">[:</span><span class="mi">1000</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_safe_html_output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">context</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;general&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create safe HTML output with proper encoding based on context&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">context</span> <span class="o">==</span> <span class="s2">&quot;html_content&quot;</span><span class="p">:</span>
            <span class="c1"># For HTML content context</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sanitize_html_input</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">content</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;html&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)),</span> <span class="n">allow_html</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">context</span> <span class="o">==</span> <span class="s2">&quot;html_attribute&quot;</span><span class="p">:</span>
            <span class="c1"># For HTML attribute context (like title, alt text)</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">content</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
            <span class="c1"># Escape quotes and HTML entities</span>
            <span class="k">return</span> <span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">quote</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">context</span> <span class="o">==</span> <span class="s2">&quot;javascript_string&quot;</span><span class="p">:</span>
            <span class="c1"># For JavaScript string context</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">content</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
            <span class="c1"># Escape for JavaScript context</span>
            <span class="n">escaped</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\\\</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&#39;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&quot;&#39;</span><span class="p">)</span>
            <span class="n">escaped</span> <span class="o">=</span> <span class="n">escaped</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">n&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">r&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">t&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">escaped</span>

        <span class="k">elif</span> <span class="n">context</span> <span class="o">==</span> <span class="s2">&quot;css_value&quot;</span><span class="p">:</span>
            <span class="c1"># For CSS value context</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">content</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
            <span class="c1"># Only allow alphanumeric and safe CSS characters</span>
            <span class="n">safe_css</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[^a-zA-Z0-9\-_\s#.]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">safe_css</span><span class="p">[:</span><span class="mi">100</span><span class="p">]</span>  <span class="c1"># Limit length</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Default: plain text context</span>
            <span class="k">return</span> <span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">content</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">validate_and_sanitize_form_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form_data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate and sanitize form data comprehensively&quot;&quot;&quot;</span>

        <span class="n">sanitized_data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">validation_errors</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">field_value</span> <span class="ow">in</span> <span class="n">form_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

            <span class="k">if</span> <span class="n">field_name</span> <span class="o">==</span> <span class="s2">&quot;username&quot;</span><span class="p">:</span>
                <span class="n">sanitized_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sanitize_username</span><span class="p">(</span><span class="n">field_value</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">sanitized_value</span><span class="p">:</span>
                    <span class="n">validation_errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid username: </span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">sanitized_data</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">sanitized_value</span>

            <span class="k">elif</span> <span class="n">field_name</span> <span class="o">==</span> <span class="s2">&quot;email&quot;</span><span class="p">:</span>
                <span class="n">sanitized_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sanitize_email</span><span class="p">(</span><span class="n">field_value</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">sanitized_value</span><span class="p">:</span>
                    <span class="n">validation_errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid email: </span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">sanitized_data</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">sanitized_value</span>

            <span class="k">elif</span> <span class="n">field_name</span> <span class="o">==</span> <span class="s2">&quot;password&quot;</span><span class="p">:</span>
                <span class="c1"># Don&#39;t log or store raw passwords</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_password_format</span><span class="p">(</span><span class="n">field_value</span><span class="p">):</span>
                    <span class="n">sanitized_data</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">field_value</span>  <span class="c1"># Keep original for hashing</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">validation_errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Password does not meet requirements&quot;</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;comment&quot;</span><span class="p">,</span> <span class="s2">&quot;description&quot;</span><span class="p">,</span> <span class="s2">&quot;bio&quot;</span><span class="p">]:</span>
                <span class="c1"># Rich text fields - allow some HTML</span>
                <span class="n">sanitized_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sanitize_html_input</span><span class="p">(</span><span class="n">field_value</span><span class="p">,</span> <span class="n">allow_html</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">sanitized_data</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">sanitized_value</span>

            <span class="k">elif</span> <span class="n">field_name</span> <span class="o">==</span> <span class="s2">&quot;website_url&quot;</span><span class="p">:</span>
                <span class="n">sanitized_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sanitize_url</span><span class="p">(</span><span class="n">field_value</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">field_value</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">sanitized_value</span><span class="p">:</span>
                    <span class="n">validation_errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Invalid website URL&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">sanitized_data</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">sanitized_value</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Default: treat as plain text</span>
                <span class="n">sanitized_data</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sanitize_html_input</span><span class="p">(</span><span class="n">field_value</span><span class="p">,</span> <span class="n">allow_html</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">sanitized_data</span><span class="p">,</span>
            <span class="s1">&#39;errors&#39;</span><span class="p">:</span> <span class="n">validation_errors</span><span class="p">,</span>
            <span class="s1">&#39;is_valid&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">validation_errors</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_sanitize_username</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sanitize username input&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">username</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>

        <span class="c1"># Remove HTML and limit to alphanumeric plus underscores</span>
        <span class="n">cleaned</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">username</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>

        <span class="c1"># Only allow safe characters</span>
        <span class="n">safe_username</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[^a-zA-Z0-9_]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">cleaned</span><span class="p">)</span>

        <span class="c1"># Length limits</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">safe_username</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">safe_username</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>

        <span class="k">return</span> <span class="n">safe_username</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_sanitize_email</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sanitize email input&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">email</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>

        <span class="c1"># Basic email validation and sanitization</span>
        <span class="n">cleaned</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">email</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>

        <span class="c1"># Simple email regex validation</span>
        <span class="n">email_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$&#39;</span>

        <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">email_pattern</span><span class="p">,</span> <span class="n">cleaned</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">cleaned</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">254</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">cleaned</span>

        <span class="k">return</span> <span class="s2">&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_sanitize_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sanitize URL input&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">url</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>

        <span class="n">cleaned</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="c1"># Ensure URL starts with safe protocol</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cleaned</span><span class="o">.</span><span class="n">startswith</span><span class="p">((</span><span class="s1">&#39;http://&#39;</span><span class="p">,</span> <span class="s1">&#39;https://&#39;</span><span class="p">)):</span>
            <span class="n">cleaned</span> <span class="o">=</span> <span class="s1">&#39;https://&#39;</span> <span class="o">+</span> <span class="n">cleaned</span>

        <span class="c1"># Basic URL validation</span>
        <span class="n">url_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;^https?://[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}([/\w.-]*)*/?$&#39;</span>

        <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">url_pattern</span><span class="p">,</span> <span class="n">cleaned</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">cleaned</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">2000</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">cleaned</span>

        <span class="k">return</span> <span class="s2">&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_password_format</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate password format without logging content&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">password</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Length check</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">password</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">8</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">password</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">128</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Check for required character types</span>
        <span class="n">has_upper</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">isupper</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">password</span><span class="p">)</span>
        <span class="n">has_lower</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">islower</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">password</span><span class="p">)</span>
        <span class="n">has_digit</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">password</span><span class="p">)</span>
        <span class="n">has_special</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">c</span> <span class="ow">in</span> <span class="s2">&quot;!@#$%^&amp;*()_+-=[]</span><span class="si">{}</span><span class="s2">|;:,.&lt;&gt;?&quot;</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">password</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">has_upper</span> <span class="ow">and</span> <span class="n">has_lower</span> <span class="ow">and</span> <span class="n">has_digit</span> <span class="ow">and</span> <span class="n">has_special</span>

<span class="c1"># Demonstration of XSS protection</span>
<span class="k">def</span><span class="w"> </span><span class="nf">demonstrate_xss_protection</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Demonstrate XSS protection techniques&quot;&quot;&quot;</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=== XSS Protection Demo ===&quot;</span><span class="p">)</span>

    <span class="n">xss_manager</span> <span class="o">=</span> <span class="n">XSSProtectionManager</span><span class="p">()</span>

    <span class="c1"># Test various XSS attack vectors</span>
    <span class="n">malicious_inputs</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;&lt;script&gt;alert(&#39;XSS Attack!&#39;);&lt;/script&gt;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;&lt;img src=&#39;x&#39; onerror=&#39;alert(</span><span class="se">\&quot;</span><span class="s2">XSS</span><span class="se">\&quot;</span><span class="s2">)&#39;&gt;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;javascript:alert(&#39;XSS&#39;)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;&lt;iframe src=&#39;javascript:alert(</span><span class="se">\&quot;</span><span class="s2">XSS</span><span class="se">\&quot;</span><span class="s2">)&#39;&gt;&lt;/iframe&gt;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;&lt;svg onload=&#39;alert(</span><span class="se">\&quot;</span><span class="s2">XSS</span><span class="se">\&quot;</span><span class="s2">)&#39;&gt;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Hello &lt;script&gt;document.cookie&lt;/script&gt; World&quot;</span><span class="p">,</span>
        <span class="s2">&quot;&lt;a href=&#39;javascript:alert(</span><span class="se">\&quot;</span><span class="s2">XSS</span><span class="se">\&quot;</span><span class="s2">)&#39;&gt;Click me&lt;/a&gt;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;&lt;div onclick=&#39;alert(</span><span class="se">\&quot;</span><span class="s2">XSS</span><span class="se">\&quot;</span><span class="s2">)&#39;&gt;Clickable content&lt;/div&gt;&quot;</span>
    <span class="p">]</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Testing malicious inputs (plain text context):&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">malicious_input</span> <span class="ow">in</span> <span class="n">malicious_inputs</span><span class="p">:</span>
        <span class="n">sanitized</span> <span class="o">=</span> <span class="n">xss_manager</span><span class="o">.</span><span class="n">sanitize_html_input</span><span class="p">(</span><span class="n">malicious_input</span><span class="p">,</span> <span class="n">allow_html</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Input:  </span><span class="si">{</span><span class="n">malicious_input</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Output: </span><span class="si">{</span><span class="n">sanitized</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Safe:   </span><span class="si">{</span><span class="s1">&#39;✅&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="s1">&#39;&lt;script&#39;</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">sanitized</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="s1">&#39;javascript:&#39;</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">sanitized</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;❌&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">()</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=== Testing Rich Text Sanitization ===&quot;</span><span class="p">)</span>

    <span class="n">rich_text_inputs</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;&lt;p&gt;This is &lt;strong&gt;safe&lt;/strong&gt; HTML content.&lt;/p&gt;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;&lt;p&gt;This has a &lt;script&gt;alert(&#39;bad&#39;)&lt;/script&gt; script tag.&lt;/p&gt;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;&lt;h1&gt;Title&lt;/h1&gt;&lt;p&gt;Paragraph with &lt;em&gt;emphasis&lt;/em&gt;&lt;/p&gt;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;&lt;a href=&#39;https://safe.com&#39;&gt;Safe link&lt;/a&gt;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;&lt;a href=&#39;javascript:alert(</span><span class="se">\&quot;</span><span class="s2">bad</span><span class="se">\&quot;</span><span class="s2">)&#39;&gt;Dangerous link&lt;/a&gt;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;&lt;img src=&#39;image.jpg&#39; alt=&#39;Safe image&#39;&gt;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;&lt;img src=&#39;x&#39; onerror=&#39;alert(</span><span class="se">\&quot;</span><span class="s2">bad</span><span class="se">\&quot;</span><span class="s2">)&#39; alt=&#39;Dangerous image&#39;&gt;&quot;</span>
    <span class="p">]</span>

    <span class="k">for</span> <span class="n">rich_input</span> <span class="ow">in</span> <span class="n">rich_text_inputs</span><span class="p">:</span>
        <span class="n">sanitized</span> <span class="o">=</span> <span class="n">xss_manager</span><span class="o">.</span><span class="n">sanitize_html_input</span><span class="p">(</span><span class="n">rich_input</span><span class="p">,</span> <span class="n">allow_html</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Input:  </span><span class="si">{</span><span class="n">rich_input</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Output: </span><span class="si">{</span><span class="n">sanitized</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">()</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=== Testing Form Data Validation ===&quot;</span><span class="p">)</span>

    <span class="c1"># Test form data with mixed content</span>
    <span class="n">test_form_data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;student&lt;script&gt;alert(&#39;xss&#39;)&lt;/script&gt;123&quot;</span><span class="p">,</span>
        <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;test@example.com&lt;script&gt;alert(&#39;xss&#39;)&lt;/script&gt;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;password&quot;</span><span class="p">:</span> <span class="s2">&quot;SecurePass123!&quot;</span><span class="p">,</span>
        <span class="s2">&quot;bio&quot;</span><span class="p">:</span> <span class="s2">&quot;&lt;p&gt;I&#39;m a student at &lt;strong&gt;Example School&lt;/strong&gt;.&lt;/p&gt;&lt;script&gt;alert(&#39;xss&#39;)&lt;/script&gt;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;website_url&quot;</span><span class="p">:</span> <span class="s2">&quot;https://mystudentblog.com&quot;</span><span class="p">,</span>
        <span class="s2">&quot;comment&quot;</span><span class="p">:</span> <span class="s2">&quot;This is my comment with &lt;em&gt;emphasis&lt;/em&gt; and &lt;script&gt;bad content&lt;/script&gt;&quot;</span>
    <span class="p">}</span>

    <span class="n">validation_result</span> <span class="o">=</span> <span class="n">xss_manager</span><span class="o">.</span><span class="n">validate_and_sanitize_form_data</span><span class="p">(</span><span class="n">test_form_data</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Form validation results:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Valid: </span><span class="si">{</span><span class="n">validation_result</span><span class="p">[</span><span class="s1">&#39;is_valid&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Errors: </span><span class="si">{</span><span class="n">validation_result</span><span class="p">[</span><span class="s1">&#39;errors&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Sanitized data:&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">field</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">validation_result</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">field</span> <span class="o">!=</span> <span class="s1">&#39;password&#39;</span><span class="p">:</span>  <span class="c1"># Don&#39;t display password</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre>
</div>
<h2 id="input-validation-strategies-whitelist-vs-blacklist">Input Validation Strategies: Whitelist vs Blacklist<a class="headerlink" href="#input-validation-strategies-whitelist-vs-blacklist" title="Permanent link">&para;</a></h2>
<p>Understanding when and how to use whitelist (allow-list) and blacklist (deny-list) approaches is crucial for effective input validation.</p>
<h3 id="whitelist-approach-recommended">Whitelist Approach (Recommended)<a class="headerlink" href="#whitelist-approach-recommended" title="Permanent link">&para;</a></h3>
<p><strong>Whitelist validation</strong> explicitly defines what input is allowed, rejecting everything else.</p>
<p><strong>Advantages:</strong></p>
<ul>
<li>
<p>More secure by default</p>
</li>
<li>
<p>Easier to maintain comprehensive security</p>
</li>
<li>
<p>Prevents unknown attack vectors</p>
</li>
<li>
<p>Clear specification of expected input</p>
</li>
</ul>
<p><strong>Use whitelist for:</strong></p>
<ul>
<li>
<p>User registration forms</p>
</li>
<li>
<p>Configuration settings</p>
</li>
<li>
<p>File type uploads</p>
</li>
<li>
<p>API parameters with known formats</p>
</li>
</ul>
<div class="highlight python-template" data-fence-type="template" data-language="python">
<pre><code class="language-python"><span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">enum</span><span class="w"> </span><span class="kn">import</span> <span class="n">Enum</span>

<span class="k">class</span><span class="w"> </span><span class="nc">ValidationResult</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="n">VALID</span> <span class="o">=</span> <span class="s2">&quot;valid&quot;</span>
    <span class="n">INVALID_FORMAT</span> <span class="o">=</span> <span class="s2">&quot;invalid_format&quot;</span>
    <span class="n">INVALID_LENGTH</span> <span class="o">=</span> <span class="s2">&quot;invalid_length&quot;</span>
    <span class="n">INVALID_CHARACTERS</span> <span class="o">=</span> <span class="s2">&quot;invalid_characters&quot;</span>
    <span class="n">MISSING_REQUIRED</span> <span class="o">=</span> <span class="s2">&quot;missing_required&quot;</span>

<span class="k">class</span><span class="w"> </span><span class="nc">WhitelistValidator</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Define allowed patterns for different input types</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validation_patterns</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;username&#39;</span><span class="p">:</span> <span class="sa">r</span><span class="s1">&#39;^[a-zA-Z0-9_]{3,50}$&#39;</span><span class="p">,</span>
            <span class="s1">&#39;email&#39;</span><span class="p">:</span> <span class="sa">r</span><span class="s1">&#39;^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$&#39;</span><span class="p">,</span>
            <span class="s1">&#39;phone&#39;</span><span class="p">:</span> <span class="sa">r</span><span class="s1">&#39;^\+?[1-9]\d{1,14}$&#39;</span><span class="p">,</span>  <span class="c1"># International format</span>
            <span class="s1">&#39;postal_code&#39;</span><span class="p">:</span> <span class="sa">r</span><span class="s1">&#39;^[A-Z0-9]{3,10}$&#39;</span><span class="p">,</span>
            <span class="s1">&#39;student_id&#39;</span><span class="p">:</span> <span class="sa">r</span><span class="s1">&#39;^S[0-9]</span><span class="si">{6}</span><span class="s1">$&#39;</span><span class="p">,</span>  <span class="c1"># School-specific format</span>
            <span class="s1">&#39;course_code&#39;</span><span class="p">:</span> <span class="sa">r</span><span class="s1">&#39;^[A-Z]{2,4}[0-9]{3,4}$&#39;</span>
        <span class="p">}</span>

        <span class="c1"># Define allowed values for specific fields</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">allowed_values</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;grade_level&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;7&#39;</span><span class="p">,</span> <span class="s1">&#39;8&#39;</span><span class="p">,</span> <span class="s1">&#39;9&#39;</span><span class="p">,</span> <span class="s1">&#39;10&#39;</span><span class="p">,</span> <span class="s1">&#39;11&#39;</span><span class="p">,</span> <span class="s1">&#39;12&#39;</span><span class="p">],</span>
            <span class="s1">&#39;subject&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Mathematics&#39;</span><span class="p">,</span> <span class="s1">&#39;English&#39;</span><span class="p">,</span> <span class="s1">&#39;Science&#39;</span><span class="p">,</span> <span class="s1">&#39;History&#39;</span><span class="p">,</span> <span class="s1">&#39;Art&#39;</span><span class="p">,</span> <span class="s1">&#39;PE&#39;</span><span class="p">],</span>
            <span class="s1">&#39;user_role&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;student&#39;</span><span class="p">,</span> <span class="s1">&#39;teacher&#39;</span><span class="p">,</span> <span class="s1">&#39;admin&#39;</span><span class="p">,</span> <span class="s1">&#39;parent&#39;</span><span class="p">],</span>
            <span class="s1">&#39;file_extension&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;.pdf&#39;</span><span class="p">,</span> <span class="s1">&#39;.doc&#39;</span><span class="p">,</span> <span class="s1">&#39;.docx&#39;</span><span class="p">,</span> <span class="s1">&#39;.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;.jpg&#39;</span><span class="p">,</span> <span class="s1">&#39;.png&#39;</span><span class="p">],</span>
            <span class="s1">&#39;country_code&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;AU&#39;</span><span class="p">,</span> <span class="s1">&#39;US&#39;</span><span class="p">,</span> <span class="s1">&#39;UK&#39;</span><span class="p">,</span> <span class="s1">&#39;CA&#39;</span><span class="p">,</span> <span class="s1">&#39;NZ&#39;</span><span class="p">,</span> <span class="s1">&#39;SG&#39;</span><span class="p">]</span>
        <span class="p">}</span>

        <span class="c1"># Define length limits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">length_limits</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;username&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">50</span><span class="p">),</span>
            <span class="s1">&#39;password&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">128</span><span class="p">),</span>
            <span class="s1">&#39;email&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">254</span><span class="p">),</span>
            <span class="s1">&#39;first_name&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">50</span><span class="p">),</span>
            <span class="s1">&#39;last_name&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">50</span><span class="p">),</span>
            <span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1000</span><span class="p">),</span>
            <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2000</span><span class="p">)</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">validate_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">required</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate a field using whitelist approach&quot;&quot;&quot;</span>

        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;field&#39;</span><span class="p">:</span> <span class="n">field_name</span><span class="p">,</span>
            <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">value</span><span class="p">,</span>
            <span class="s1">&#39;is_valid&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;sanitized_value&#39;</span><span class="p">:</span> <span class="kc">None</span>
        <span class="p">}</span>

        <span class="c1"># Check if field is required</span>
        <span class="k">if</span> <span class="n">required</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">value</span> <span class="ow">or</span> <span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ValidationResult</span><span class="o">.</span><span class="n">MISSING_REQUIRED</span>
            <span class="k">return</span> <span class="n">result</span>

        <span class="c1"># If not required and empty, consider valid</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">required</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">value</span> <span class="ow">or</span> <span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;is_valid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;sanitized_value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">return</span> <span class="n">result</span>

        <span class="c1"># Trim whitespace</span>
        <span class="n">sanitized</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="c1"># Check length limits</span>
        <span class="k">if</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">length_limits</span><span class="p">:</span>
            <span class="n">min_len</span><span class="p">,</span> <span class="n">max_len</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">length_limits</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sanitized</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">min_len</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">sanitized</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_len</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ValidationResult</span><span class="o">.</span><span class="n">INVALID_LENGTH</span>
                <span class="k">return</span> <span class="n">result</span>

        <span class="c1"># Check against allowed values (exact match)</span>
        <span class="k">if</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">allowed_values</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sanitized</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">allowed_values</span><span class="p">[</span><span class="n">field_name</span><span class="p">]:</span>
                <span class="n">result</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ValidationResult</span><span class="o">.</span><span class="n">INVALID_FORMAT</span>
                <span class="k">return</span> <span class="n">result</span>

        <span class="c1"># Check against regex patterns</span>
        <span class="k">elif</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">validation_patterns</span><span class="p">:</span>
            <span class="n">pattern</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validation_patterns</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">sanitized</span><span class="p">):</span>
                <span class="n">result</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ValidationResult</span><span class="o">.</span><span class="n">INVALID_FORMAT</span>
                <span class="k">return</span> <span class="n">result</span>

        <span class="c1"># Special validation for complex fields</span>
        <span class="k">elif</span> <span class="n">field_name</span> <span class="o">==</span> <span class="s1">&#39;password&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_password_complexity</span><span class="p">(</span><span class="n">sanitized</span><span class="p">):</span>
                <span class="n">result</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ValidationResult</span><span class="o">.</span><span class="n">INVALID_FORMAT</span>
                <span class="k">return</span> <span class="n">result</span>

        <span class="k">elif</span> <span class="n">field_name</span> <span class="o">==</span> <span class="s1">&#39;date_of_birth&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_date_format</span><span class="p">(</span><span class="n">sanitized</span><span class="p">):</span>
                <span class="n">result</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ValidationResult</span><span class="o">.</span><span class="n">INVALID_FORMAT</span>
                <span class="k">return</span> <span class="n">result</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Default: allow alphanumeric and basic punctuation only</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^[a-zA-Z0-9\s\-_.@!?]+$&#39;</span><span class="p">,</span> <span class="n">sanitized</span><span class="p">):</span>
                <span class="n">result</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ValidationResult</span><span class="o">.</span><span class="n">INVALID_CHARACTERS</span>
                <span class="k">return</span> <span class="n">result</span>

        <span class="c1"># If we reach here, validation passed</span>
        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;is_valid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;sanitized_value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sanitized</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">validate_form</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form_data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> 
                     <span class="n">required_fields</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate entire form using whitelist approach&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">required_fields</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">required_fields</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">validation_results</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">sanitized_data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Validate each field</span>
        <span class="k">for</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">field_value</span> <span class="ow">in</span> <span class="n">form_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">is_required</span> <span class="o">=</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="n">required_fields</span>

            <span class="n">validation_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_field</span><span class="p">(</span><span class="n">field_name</span><span class="p">,</span> <span class="n">field_value</span><span class="p">,</span> <span class="n">is_required</span><span class="p">)</span>
            <span class="n">validation_results</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">validation_result</span>

            <span class="k">if</span> <span class="n">validation_result</span><span class="p">[</span><span class="s1">&#39;is_valid&#39;</span><span class="p">]:</span>
                <span class="n">sanitized_data</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">validation_result</span><span class="p">[</span><span class="s1">&#39;sanitized_value&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s1">&#39;field&#39;</span><span class="p">:</span> <span class="n">field_name</span><span class="p">,</span>
                    <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="n">validation_result</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                    <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_error_message</span><span class="p">(</span><span class="n">field_name</span><span class="p">,</span> <span class="n">validation_result</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">])</span>
                <span class="p">})</span>

        <span class="c1"># Check for required fields that weren&#39;t provided</span>
        <span class="k">for</span> <span class="n">required_field</span> <span class="ow">in</span> <span class="n">required_fields</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">required_field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">form_data</span><span class="p">:</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s1">&#39;field&#39;</span><span class="p">:</span> <span class="n">required_field</span><span class="p">,</span>
                    <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="n">ValidationResult</span><span class="o">.</span><span class="n">MISSING_REQUIRED</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                    <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">required_field</span><span class="si">}</span><span class="s2"> is required&quot;</span>
                <span class="p">})</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;is_valid&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;sanitized_data&#39;</span><span class="p">:</span> <span class="n">sanitized_data</span><span class="p">,</span>
            <span class="s1">&#39;errors&#39;</span><span class="p">:</span> <span class="n">errors</span><span class="p">,</span>
            <span class="s1">&#39;field_results&#39;</span><span class="p">:</span> <span class="n">validation_results</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_password_complexity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate password meets complexity requirements&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">password</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">8</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">password</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">128</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Check for required character types</span>
        <span class="n">has_upper</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">isupper</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">password</span><span class="p">)</span>
        <span class="n">has_lower</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">islower</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">password</span><span class="p">)</span>
        <span class="n">has_digit</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">password</span><span class="p">)</span>
        <span class="n">has_special</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">c</span> <span class="ow">in</span> <span class="s2">&quot;!@#$%^&amp;*()_+-=[]</span><span class="si">{}</span><span class="s2">|;:,.&lt;&gt;?&quot;</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">password</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">has_upper</span> <span class="ow">and</span> <span class="n">has_lower</span> <span class="ow">and</span> <span class="n">has_digit</span> <span class="ow">and</span> <span class="n">has_special</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_date_format</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">date_string</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate date is in YYYY-MM-DD format and valid&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
            <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">date_string</span><span class="p">,</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_error_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">error_type</span><span class="p">:</span> <span class="n">ValidationResult</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get user-friendly error message&quot;&quot;&quot;</span>

        <span class="n">messages</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">ValidationResult</span><span class="o">.</span><span class="n">MISSING_REQUIRED</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2"> is required&quot;</span><span class="p">,</span>
            <span class="n">ValidationResult</span><span class="o">.</span><span class="n">INVALID_FORMAT</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2"> format is invalid&quot;</span><span class="p">,</span>
            <span class="n">ValidationResult</span><span class="o">.</span><span class="n">INVALID_LENGTH</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2"> length is invalid&quot;</span><span class="p">,</span>
            <span class="n">ValidationResult</span><span class="o">.</span><span class="n">INVALID_CHARACTERS</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2"> contains invalid characters&quot;</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">messages</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">error_type</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2"> is invalid&quot;</span><span class="p">)</span>

<span class="c1"># Example usage of whitelist validation</span>
<span class="k">def</span><span class="w"> </span><span class="nf">demonstrate_whitelist_validation</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Demonstrate whitelist validation approach&quot;&quot;&quot;</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=== Whitelist Validation Demo ===&quot;</span><span class="p">)</span>

    <span class="n">validator</span> <span class="o">=</span> <span class="n">WhitelistValidator</span><span class="p">()</span>

    <span class="c1"># Test form data with various inputs</span>
    <span class="n">test_form_data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;username&#39;</span><span class="p">:</span> <span class="s1">&#39;student123&#39;</span><span class="p">,</span>
        <span class="s1">&#39;email&#39;</span><span class="p">:</span> <span class="s1">&#39;student@school.edu&#39;</span><span class="p">,</span>
        <span class="s1">&#39;grade_level&#39;</span><span class="p">:</span> <span class="s1">&#39;11&#39;</span><span class="p">,</span>
        <span class="s1">&#39;password&#39;</span><span class="p">:</span> <span class="s1">&#39;SecurePass123!&#39;</span><span class="p">,</span>
        <span class="s1">&#39;first_name&#39;</span><span class="p">:</span> <span class="s1">&#39;Alice&#39;</span><span class="p">,</span>
        <span class="s1">&#39;last_name&#39;</span><span class="p">:</span> <span class="s1">&#39;Johnson&#39;</span><span class="p">,</span>
        <span class="s1">&#39;student_id&#39;</span><span class="p">:</span> <span class="s1">&#39;S123456&#39;</span><span class="p">,</span>
        <span class="s1">&#39;course_code&#39;</span><span class="p">:</span> <span class="s1">&#39;MATH1001&#39;</span>
    <span class="p">}</span>

    <span class="n">required_fields</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">,</span> <span class="s1">&#39;email&#39;</span><span class="p">,</span> <span class="s1">&#39;password&#39;</span><span class="p">,</span> <span class="s1">&#39;first_name&#39;</span><span class="p">,</span> <span class="s1">&#39;last_name&#39;</span><span class="p">]</span>

    <span class="c1"># Validate form</span>
    <span class="n">validation_result</span> <span class="o">=</span> <span class="n">validator</span><span class="o">.</span><span class="n">validate_form</span><span class="p">(</span><span class="n">test_form_data</span><span class="p">,</span> <span class="n">required_fields</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Form is valid: </span><span class="si">{</span><span class="n">validation_result</span><span class="p">[</span><span class="s1">&#39;is_valid&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">validation_result</span><span class="p">[</span><span class="s1">&#39;errors&#39;</span><span class="p">]:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Validation errors:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">error</span> <span class="ow">in</span> <span class="n">validation_result</span><span class="p">[</span><span class="s1">&#39;errors&#39;</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">error</span><span class="p">[</span><span class="s1">&#39;field&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">error</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Sanitized data:&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">field</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">validation_result</span><span class="p">[</span><span class="s1">&#39;sanitized_data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">field</span> <span class="o">!=</span> <span class="s1">&#39;password&#39;</span><span class="p">:</span>  <span class="c1"># Don&#39;t display password</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">=== Testing Invalid Inputs ===&quot;</span><span class="p">)</span>

    <span class="c1"># Test invalid inputs</span>
    <span class="n">invalid_inputs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;username&#39;</span><span class="p">:</span> <span class="s1">&#39;user@#$%&#39;</span><span class="p">,</span>  <span class="c1"># Invalid characters</span>
        <span class="s1">&#39;email&#39;</span><span class="p">:</span> <span class="s1">&#39;invalid-email&#39;</span><span class="p">,</span>  <span class="c1"># Invalid format</span>
        <span class="s1">&#39;grade_level&#39;</span><span class="p">:</span> <span class="s1">&#39;13&#39;</span><span class="p">,</span>  <span class="c1"># Not in allowed values</span>
        <span class="s1">&#39;student_id&#39;</span><span class="p">:</span> <span class="s1">&#39;123456&#39;</span><span class="p">,</span>  <span class="c1"># Wrong format</span>
        <span class="s1">&#39;password&#39;</span><span class="p">:</span> <span class="s1">&#39;weak&#39;</span>  <span class="c1"># Too simple</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="n">field</span><span class="p">,</span> <span class="n">invalid_value</span> <span class="ow">in</span> <span class="n">invalid_inputs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">validator</span><span class="o">.</span><span class="n">validate_field</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">invalid_value</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s2">: &#39;</span><span class="si">{</span><span class="n">invalid_value</span><span class="si">}</span><span class="s2">&#39; -&gt; </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;VALID&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre>
</div>
<h3 id="blacklist-approach-use-with-caution">Blacklist Approach (Use with Caution)<a class="headerlink" href="#blacklist-approach-use-with-caution" title="Permanent link">&para;</a></h3>
<p><strong>Blacklist validation</strong> defines what input is forbidden, allowing everything else.</p>
<p><strong>Disadvantages:</strong></p>
<ul>
<li>
<p>Difficult to anticipate all attack vectors</p>
</li>
<li>
<p>New threats bypass existing blacklists</p>
</li>
<li>
<p>Often leads to incomplete protection</p>
</li>
<li>
<p>Harder to maintain comprehensive security</p>
</li>
</ul>
<p><strong>Use blacklist only for:</strong></p>
<ul>
<li>
<p>Content filtering (profanity, spam)</p>
</li>
<li>
<p>Basic malware detection</p>
</li>
<li>
<p>Supplementary protection alongside whitelists</p>
</li>
</ul>
<div class="highlight python-template" data-fence-type="template" data-language="python">
<pre><code class="language-python"><span class="k">class</span><span class="w"> </span><span class="nc">BlacklistValidator</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Define dangerous patterns to block</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dangerous_patterns</span> <span class="o">=</span> <span class="p">[</span>
            <span class="c1"># SQL injection patterns</span>
            <span class="sa">r</span><span class="s1">&#39;union\s+select&#39;</span><span class="p">,</span>
            <span class="sa">r</span><span class="s1">&#39;drop\s+table&#39;</span><span class="p">,</span>
            <span class="sa">r</span><span class="s1">&#39;delete\s+from&#39;</span><span class="p">,</span>
            <span class="sa">r</span><span class="s1">&#39;insert\s+into&#39;</span><span class="p">,</span>
            <span class="sa">r</span><span class="s1">&#39;update\s+.*set&#39;</span><span class="p">,</span>
            <span class="sa">r</span><span class="s1">&#39;exec\s*\(&#39;</span><span class="p">,</span>
            <span class="sa">r</span><span class="s1">&#39;script\s*&gt;&#39;</span><span class="p">,</span>

            <span class="c1"># XSS patterns</span>
            <span class="sa">r</span><span class="s1">&#39;&lt;script[^&gt;]*&gt;&#39;</span><span class="p">,</span>
            <span class="sa">r</span><span class="s1">&#39;javascript:&#39;</span><span class="p">,</span>
            <span class="sa">r</span><span class="s1">&#39;vbscript:&#39;</span><span class="p">,</span>
            <span class="sa">r</span><span class="s1">&#39;onload\s*=&#39;</span><span class="p">,</span>
            <span class="sa">r</span><span class="s1">&#39;onerror\s*=&#39;</span><span class="p">,</span>
            <span class="sa">r</span><span class="s1">&#39;onclick\s*=&#39;</span><span class="p">,</span>

            <span class="c1"># File system attacks</span>
            <span class="sa">r</span><span class="s1">&#39;\.\./&#39;</span><span class="p">,</span>
            <span class="sa">r</span><span class="s1">&#39;\.\.\/&#39;</span><span class="p">,</span>
            <span class="sa">r</span><span class="s1">&#39;/etc/passwd&#39;</span><span class="p">,</span>
            <span class="sa">r</span><span class="s1">&#39;/windows/system32&#39;</span><span class="p">,</span>

            <span class="c1"># Command injection</span>
            <span class="sa">r</span><span class="s1">&#39;;\s*rm\s+&#39;</span><span class="p">,</span>
            <span class="sa">r</span><span class="s1">&#39;;\s*del\s+&#39;</span><span class="p">,</span>
            <span class="sa">r</span><span class="s1">&#39;&amp;&amp;\s*rm\s+&#39;</span><span class="p">,</span>
            <span class="sa">r</span><span class="s1">&#39;\|\s*nc\s+&#39;</span>
        <span class="p">]</span>

        <span class="c1"># Blocked words for content filtering</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">blocked_words</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">&#39;password&#39;</span><span class="p">,</span> <span class="s1">&#39;admin&#39;</span><span class="p">,</span> <span class="s1">&#39;root&#39;</span><span class="p">,</span> <span class="s1">&#39;system&#39;</span><span class="p">,</span>
            <span class="s1">&#39;confidential&#39;</span><span class="p">,</span> <span class="s1">&#39;secret&#39;</span><span class="p">,</span> <span class="s1">&#39;private&#39;</span>
        <span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">check_dangerous_patterns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check input against blacklist patterns&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">input_text</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;is_safe&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;threats_found&#39;</span><span class="p">:</span> <span class="p">[]}</span>

        <span class="n">input_lower</span> <span class="o">=</span> <span class="n">input_text</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">threats_found</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Check against dangerous patterns</span>
        <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dangerous_patterns</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">input_lower</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">):</span>
                <span class="n">threats_found</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;dangerous_pattern&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;pattern&#39;</span><span class="p">:</span> <span class="n">pattern</span><span class="p">,</span>
                    <span class="s1">&#39;location&#39;</span><span class="p">:</span> <span class="s1">&#39;input_text&#39;</span>
                <span class="p">})</span>

        <span class="c1"># Check for blocked words in non-password fields</span>
        <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">blocked_words</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">input_lower</span><span class="p">:</span>
                <span class="n">threats_found</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;blocked_word&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;word&#39;</span><span class="p">:</span> <span class="n">word</span><span class="p">,</span>
                    <span class="s1">&#39;location&#39;</span><span class="p">:</span> <span class="s1">&#39;input_text&#39;</span>
                <span class="p">})</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;is_safe&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">threats_found</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;threats_found&#39;</span><span class="p">:</span> <span class="n">threats_found</span><span class="p">,</span>
            <span class="s1">&#39;threat_count&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">threats_found</span><span class="p">)</span>
        <span class="p">}</span>

<span class="c1"># Demonstrate why blacklist alone is insufficient</span>
<span class="k">def</span><span class="w"> </span><span class="nf">demonstrate_blacklist_limitations</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Show limitations of blacklist-only validation&quot;&quot;&quot;</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=== Blacklist Validation Limitations ===&quot;</span><span class="p">)</span>

    <span class="n">blacklist_validator</span> <span class="o">=</span> <span class="n">BlacklistValidator</span><span class="p">()</span>

    <span class="c1"># These attacks might bypass a simple blacklist</span>
    <span class="n">evasion_attempts</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;uni/**/on sel/**/ect&quot;</span><span class="p">,</span>  <span class="c1"># SQL injection with comments</span>
        <span class="s2">&quot;ScRiPt&gt;&quot;</span><span class="p">,</span>  <span class="c1"># Case variation</span>
        <span class="s2">&quot;java&amp;#115;cript:&quot;</span><span class="p">,</span>  <span class="c1"># HTML entity encoding</span>
        <span class="s2">&quot;j%61vascript:&quot;</span><span class="p">,</span>  <span class="c1"># URL encoding</span>
        <span class="s2">&quot;%3Cscript</span><span class="si">%3E</span><span class="s2">&quot;</span><span class="p">,</span>  <span class="c1"># URL encoded script tag</span>
        <span class="s2">&quot;&#39; OR &#39;1&#39;=&#39;1&#39; --&quot;</span><span class="p">,</span>  <span class="c1"># Basic SQL injection</span>
        <span class="s2">&quot;&lt;img src=x onerror=alert(1)&gt;&quot;</span><span class="p">,</span>  <span class="c1"># XSS without &#39;script&#39;</span>
        <span class="s2">&quot;eval(String.fromCharCode(97,108,101,114,116,40,49,41))&quot;</span>  <span class="c1"># Obfuscated JavaScript</span>
    <span class="p">]</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Testing evasion attempts against blacklist:&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">attempt</span> <span class="ow">in</span> <span class="n">evasion_attempts</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">blacklist_validator</span><span class="o">.</span><span class="n">check_dangerous_patterns</span><span class="p">(</span><span class="n">attempt</span><span class="p">)</span>
        <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;🛡️ BLOCKED&quot;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;is_safe&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;⚠️ BYPASSED&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">status</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">attempt</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;threats_found&#39;</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">threat</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;threats_found&#39;</span><span class="p">]:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Detected: </span><span class="si">{</span><span class="n">threat</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">threat</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pattern&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">threat</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;word&#39;</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">()</span>
</code></pre>
</div>
<h2 id="safe-error-message-design">Safe Error Message Design<a class="headerlink" href="#safe-error-message-design" title="Permanent link">&para;</a></h2>
<p>Error messages must be informative for legitimate users while avoiding information disclosure to attackers.</p>
<div class="highlight python-template" data-fence-type="template" data-language="python">
<pre><code class="language-python"><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span>

<span class="k">class</span><span class="w"> </span><span class="nc">SafeErrorHandler</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Setup logging for security events</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span>
            <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
            <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> - </span><span class="si">%(levelname)s</span><span class="s1"> - </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="n">handlers</span><span class="o">=</span><span class="p">[</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">FileHandler</span><span class="p">(</span><span class="s1">&#39;security.log&#39;</span><span class="p">),</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">()</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;SecurityHandler&#39;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">handle_authentication_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">ip_address</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
                                  <span class="n">error_details</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle authentication errors safely&quot;&quot;&quot;</span>

        <span class="c1"># Log detailed information for security monitoring</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Authentication failed - IP: </span><span class="si">{</span><span class="n">ip_address</span><span class="si">}</span><span class="s2">, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Username: </span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s2">, Details: </span><span class="si">{</span><span class="n">error_details</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Return generic message to user (don&#39;t reveal specific failure reason)</span>
        <span class="k">return</span> <span class="s2">&quot;Invalid username or password. Please try again.&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">handle_validation_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">error_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
                              <span class="n">user_input</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">ip_address</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle validation errors safely&quot;&quot;&quot;</span>

        <span class="c1"># Log for monitoring (be careful with sensitive data)</span>
        <span class="n">safe_input</span> <span class="o">=</span> <span class="n">user_input</span><span class="p">[:</span><span class="mi">50</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;...&quot;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">user_input</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">50</span> <span class="k">else</span> <span class="n">user_input</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Validation error - Field: </span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">, Type: </span><span class="si">{</span><span class="n">error_type</span><span class="si">}</span><span class="s2">, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;IP: </span><span class="si">{</span><span class="n">ip_address</span><span class="si">}</span><span class="s2">, Input: </span><span class="si">{</span><span class="n">safe_input</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Return safe, helpful message to user</span>
        <span class="n">safe_messages</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;invalid_format&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2"> format is incorrect. Please check and try again.&quot;</span><span class="p">,</span>
            <span class="s1">&#39;invalid_length&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2"> must be the correct length.&quot;</span><span class="p">,</span>
            <span class="s1">&#39;missing_required&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2"> is required.&quot;</span><span class="p">,</span>
            <span class="s1">&#39;invalid_characters&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2"> contains invalid characters.&quot;</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">safe_messages</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">error_type</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2"> is invalid.&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">handle_database_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">operation</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">ip_address</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
                            <span class="n">error_details</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle database errors safely&quot;&quot;&quot;</span>

        <span class="c1"># Log detailed error for administrators</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Database error - Operation: </span><span class="si">{</span><span class="n">operation</span><span class="si">}</span><span class="s2">, IP: </span><span class="si">{</span><span class="n">ip_address</span><span class="si">}</span><span class="s2">, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Error: </span><span class="si">{</span><span class="n">error_details</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Return generic message to user (don&#39;t reveal database structure)</span>
        <span class="k">return</span> <span class="s2">&quot;A temporary error occurred. Please try again later.&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">handle_file_upload_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">error_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
                               <span class="n">ip_address</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle file upload errors safely&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;File upload error - File: </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">, Type: </span><span class="si">{</span><span class="n">error_type</span><span class="si">}</span><span class="s2">, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;IP: </span><span class="si">{</span><span class="n">ip_address</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

        <span class="n">safe_messages</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;invalid_type&#39;</span><span class="p">:</span> <span class="s2">&quot;File type not allowed. Please upload a valid file.&quot;</span><span class="p">,</span>
            <span class="s1">&#39;too_large&#39;</span><span class="p">:</span> <span class="s2">&quot;File is too large. Maximum size is 10MB.&quot;</span><span class="p">,</span>
            <span class="s1">&#39;virus_detected&#39;</span><span class="p">:</span> <span class="s2">&quot;File upload blocked for security reasons.&quot;</span><span class="p">,</span>
            <span class="s1">&#39;invalid_name&#39;</span><span class="p">:</span> <span class="s2">&quot;Invalid file name. Please rename and try again.&quot;</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">safe_messages</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">error_type</span><span class="p">,</span> <span class="s2">&quot;File upload failed.&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">handle_rate_limit_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ip_address</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle rate limiting errors&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Rate limit exceeded - IP: </span><span class="si">{</span><span class="n">ip_address</span><span class="si">}</span><span class="s2">, Endpoint: </span><span class="si">{</span><span class="n">endpoint</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="s2">&quot;Too many requests. Please wait before trying again.&quot;</span>
</code></pre>
</div>
<h2 id="file-upload-security">File Upload Security<a class="headerlink" href="#file-upload-security" title="Permanent link">&para;</a></h2>
<p>File uploads are a common attack vector that require comprehensive security measures.</p>
<div class="highlight python-template" data-fence-type="template" data-language="python">
<pre><code class="language-python"><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">magic</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">hashlib</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span>

<span class="k">class</span><span class="w"> </span><span class="nc">SecureFileUploadManager</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">upload_directory</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;uploads&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">upload_directory</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">upload_directory</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">upload_directory</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="mo">0o755</span><span class="p">)</span>

        <span class="c1"># Configure allowed file types</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">allowed_extensions</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;.pdf&#39;</span><span class="p">,</span> <span class="s1">&#39;.doc&#39;</span><span class="p">,</span> <span class="s1">&#39;.docx&#39;</span><span class="p">,</span> <span class="s1">&#39;.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;.rtf&#39;</span><span class="p">,</span>  <span class="c1"># Documents</span>
            <span class="s1">&#39;.jpg&#39;</span><span class="p">,</span> <span class="s1">&#39;.jpeg&#39;</span><span class="p">,</span> <span class="s1">&#39;.png&#39;</span><span class="p">,</span> <span class="s1">&#39;.gif&#39;</span><span class="p">,</span> <span class="s1">&#39;.bmp&#39;</span><span class="p">,</span>  <span class="c1"># Images</span>
            <span class="s1">&#39;.zip&#39;</span><span class="p">,</span> <span class="s1">&#39;.rar&#39;</span><span class="p">,</span> <span class="s1">&#39;.7z&#39;</span>  <span class="c1"># Archives (with caution)</span>
        <span class="p">}</span>

        <span class="c1"># MIME type validation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">allowed_mime_types</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;application/pdf&#39;</span><span class="p">,</span>
            <span class="s1">&#39;application/msword&#39;</span><span class="p">,</span>
            <span class="s1">&#39;application/vnd.openxmlformats-officedocument.wordprocessingml.document&#39;</span><span class="p">,</span>
            <span class="s1">&#39;text/plain&#39;</span><span class="p">,</span>
            <span class="s1">&#39;text/rtf&#39;</span><span class="p">,</span>
            <span class="s1">&#39;image/jpeg&#39;</span><span class="p">,</span>
            <span class="s1">&#39;image/png&#39;</span><span class="p">,</span>
            <span class="s1">&#39;image/gif&#39;</span><span class="p">,</span>
            <span class="s1">&#39;image/bmp&#39;</span><span class="p">,</span>
            <span class="s1">&#39;application/zip&#39;</span><span class="p">,</span>
            <span class="s1">&#39;application/x-rar-compressed&#39;</span><span class="p">,</span>
            <span class="s1">&#39;application/x-7z-compressed&#39;</span>
        <span class="p">}</span>

        <span class="c1"># Size limits (in bytes)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_file_size</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span>  <span class="c1"># 10MB</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_total_size</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span>  <span class="c1"># 100MB per session</span>

        <span class="c1"># File name restrictions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">forbidden_names</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;con&#39;</span><span class="p">,</span> <span class="s1">&#39;prn&#39;</span><span class="p">,</span> <span class="s1">&#39;aux&#39;</span><span class="p">,</span> <span class="s1">&#39;nul&#39;</span><span class="p">,</span>  <span class="c1"># Windows reserved names</span>
            <span class="s1">&#39;com1&#39;</span><span class="p">,</span> <span class="s1">&#39;com2&#39;</span><span class="p">,</span> <span class="s1">&#39;com3&#39;</span><span class="p">,</span> <span class="s1">&#39;com4&#39;</span><span class="p">,</span> <span class="s1">&#39;com5&#39;</span><span class="p">,</span> <span class="s1">&#39;com6&#39;</span><span class="p">,</span> <span class="s1">&#39;com7&#39;</span><span class="p">,</span> <span class="s1">&#39;com8&#39;</span><span class="p">,</span> <span class="s1">&#39;com9&#39;</span><span class="p">,</span>
            <span class="s1">&#39;lpt1&#39;</span><span class="p">,</span> <span class="s1">&#39;lpt2&#39;</span><span class="p">,</span> <span class="s1">&#39;lpt3&#39;</span><span class="p">,</span> <span class="s1">&#39;lpt4&#39;</span><span class="p">,</span> <span class="s1">&#39;lpt5&#39;</span><span class="p">,</span> <span class="s1">&#39;lpt6&#39;</span><span class="p">,</span> <span class="s1">&#39;lpt7&#39;</span><span class="p">,</span> <span class="s1">&#39;lpt8&#39;</span><span class="p">,</span> <span class="s1">&#39;lpt9&#39;</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">validate_file_upload</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_data</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
                           <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Comprehensively validate file upload&quot;&quot;&quot;</span>

        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;is_valid&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s1">&#39;errors&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;safe_filename&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;file_hash&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;detected_type&#39;</span><span class="p">:</span> <span class="kc">None</span>
        <span class="p">}</span>

        <span class="c1"># 1. Validate filename</span>
        <span class="n">filename_validation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_filename</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">filename_validation</span><span class="p">[</span><span class="s1">&#39;is_valid&#39;</span><span class="p">]:</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;errors&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">filename_validation</span><span class="p">[</span><span class="s1">&#39;errors&#39;</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">result</span>

        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;safe_filename&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">filename_validation</span><span class="p">[</span><span class="s1">&#39;safe_filename&#39;</span><span class="p">]</span>

        <span class="c1"># 2. Validate file size</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">file_data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;errors&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;File is empty&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">result</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">file_data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_file_size</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;errors&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File too large. Maximum size: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_file_size</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="mi">1024</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="mi">1024</span><span class="si">}</span><span class="s2">MB&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">result</span>

        <span class="c1"># 3. Validate file content and type</span>
        <span class="n">content_validation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_file_content</span><span class="p">(</span><span class="n">file_data</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">content_validation</span><span class="p">[</span><span class="s1">&#39;is_valid&#39;</span><span class="p">]:</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;errors&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">content_validation</span><span class="p">[</span><span class="s1">&#39;errors&#39;</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">result</span>

        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;detected_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">content_validation</span><span class="p">[</span><span class="s1">&#39;detected_type&#39;</span><span class="p">]</span>

        <span class="c1"># 4. Generate file hash for deduplication and integrity</span>
        <span class="n">file_hash</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">file_data</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;file_hash&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">file_hash</span>

        <span class="c1"># 5. Check for existing file</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file_exists</span><span class="p">(</span><span class="n">file_hash</span><span class="p">):</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;errors&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;File already exists&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">result</span>

        <span class="c1"># 6. Virus scan (placeholder - integrate with actual antivirus)</span>
        <span class="n">virus_scan_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scan_for_viruses</span><span class="p">(</span><span class="n">file_data</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">virus_scan_result</span><span class="p">[</span><span class="s1">&#39;is_clean&#39;</span><span class="p">]:</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;errors&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;File failed security scan&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">result</span>

        <span class="c1"># If we reach here, file is valid</span>
        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;is_valid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">save_file_securely</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_data</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">validation_result</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> 
                          <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Save validated file securely&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">validation_result</span><span class="p">[</span><span class="s1">&#39;is_valid&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;File validation failed&#39;</span><span class="p">}</span>

        <span class="n">safe_filename</span> <span class="o">=</span> <span class="n">validation_result</span><span class="p">[</span><span class="s1">&#39;safe_filename&#39;</span><span class="p">]</span>
        <span class="n">file_hash</span> <span class="o">=</span> <span class="n">validation_result</span><span class="p">[</span><span class="s1">&#39;file_hash&#39;</span><span class="p">]</span>

        <span class="c1"># Create user-specific directory</span>
        <span class="n">user_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">upload_directory</span> <span class="o">/</span> <span class="n">user_id</span>
        <span class="n">user_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="mo">0o755</span><span class="p">)</span>

        <span class="c1"># Generate unique filename to prevent conflicts</span>
        <span class="n">timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">_%H%M%S&#39;</span><span class="p">)</span>
        <span class="n">unique_filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">timestamp</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">file_hash</span><span class="p">[:</span><span class="mi">8</span><span class="p">]</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">safe_filename</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="n">file_path</span> <span class="o">=</span> <span class="n">user_dir</span> <span class="o">/</span> <span class="n">unique_filename</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Write file with restricted permissions</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">file_data</span><span class="p">)</span>

            <span class="c1"># Set restrictive permissions</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="mo">0o644</span><span class="p">)</span>  <span class="c1"># Read/write for owner, read for group</span>

            <span class="c1"># Store file metadata</span>
            <span class="n">metadata</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;original_filename&#39;</span><span class="p">:</span> <span class="n">safe_filename</span><span class="p">,</span>
                <span class="s1">&#39;stored_filename&#39;</span><span class="p">:</span> <span class="n">unique_filename</span><span class="p">,</span>
                <span class="s1">&#39;file_hash&#39;</span><span class="p">:</span> <span class="n">file_hash</span><span class="p">,</span>
                <span class="s1">&#39;file_size&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">file_data</span><span class="p">),</span>
                <span class="s1">&#39;mime_type&#39;</span><span class="p">:</span> <span class="n">validation_result</span><span class="p">[</span><span class="s1">&#39;detected_type&#39;</span><span class="p">],</span>
                <span class="s1">&#39;upload_time&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
                <span class="s1">&#39;user_id&#39;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">,</span>
                <span class="s1">&#39;file_path&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="p">{</span>
                <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s1">&#39;file_id&#39;</span><span class="p">:</span> <span class="n">file_hash</span><span class="p">,</span>
                <span class="s1">&#39;metadata&#39;</span><span class="p">:</span> <span class="n">metadata</span>
            <span class="p">}</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Failed to save file: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_filename</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate and sanitize filename&quot;&quot;&quot;</span>

        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;is_valid&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;errors&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;safe_filename&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">filename</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;errors&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Filename is required&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">result</span>

        <span class="c1"># Check length</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">255</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;errors&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Filename too long&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">result</span>

        <span class="c1"># Extract extension</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">extension</span> <span class="o">=</span> <span class="n">file_path</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

        <span class="c1"># Check extension</span>
        <span class="k">if</span> <span class="n">extension</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">allowed_extensions</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;errors&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File type &#39;</span><span class="si">{</span><span class="n">extension</span><span class="si">}</span><span class="s2">&#39; not allowed&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">result</span>

        <span class="c1"># Check forbidden names</span>
        <span class="n">name_without_ext</span> <span class="o">=</span> <span class="n">file_path</span><span class="o">.</span><span class="n">stem</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">name_without_ext</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">forbidden_names</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;errors&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Reserved filename not allowed&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">result</span>

        <span class="c1"># Sanitize filename</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
        <span class="c1"># Remove dangerous characters</span>
        <span class="n">safe_name</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[&lt;&gt;:&quot;/</span><span class="se">\\</span><span class="s1">|?*]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">file_path</span><span class="o">.</span><span class="n">stem</span><span class="p">)</span>
        <span class="n">safe_name</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[\x00-\x1f]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">safe_name</span><span class="p">)</span>  <span class="c1"># Remove control characters</span>
        <span class="n">safe_name</span> <span class="o">=</span> <span class="n">safe_name</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;. &#39;</span><span class="p">)</span>  <span class="c1"># Remove leading/trailing dots and spaces</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">safe_name</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;errors&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Invalid filename&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">result</span>

        <span class="c1"># Reconstruct safe filename</span>
        <span class="n">safe_filename</span> <span class="o">=</span> <span class="n">safe_name</span> <span class="o">+</span> <span class="n">extension</span>

        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;is_valid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;safe_filename&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">safe_filename</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_file_content</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_data</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate file content matches declared type&quot;&quot;&quot;</span>

        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;is_valid&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;errors&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;detected_type&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Detect actual MIME type from content</span>
            <span class="n">detected_mime</span> <span class="o">=</span> <span class="n">magic</span><span class="o">.</span><span class="n">from_buffer</span><span class="p">(</span><span class="n">file_data</span><span class="p">,</span> <span class="n">mime</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;detected_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">detected_mime</span>

            <span class="c1"># Check if detected type is allowed</span>
            <span class="k">if</span> <span class="n">detected_mime</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">allowed_mime_types</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="s1">&#39;errors&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File content type &#39;</span><span class="si">{</span><span class="n">detected_mime</span><span class="si">}</span><span class="s2">&#39; not allowed&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">result</span>

            <span class="c1"># Verify extension matches content</span>
            <span class="n">file_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="n">extension</span> <span class="o">=</span> <span class="n">file_path</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

            <span class="c1"># Basic extension-to-MIME validation</span>
            <span class="n">extension_mime_map</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;.pdf&#39;</span><span class="p">:</span> <span class="s1">&#39;application/pdf&#39;</span><span class="p">,</span>
                <span class="s1">&#39;.doc&#39;</span><span class="p">:</span> <span class="s1">&#39;application/msword&#39;</span><span class="p">,</span>
                <span class="s1">&#39;.docx&#39;</span><span class="p">:</span> <span class="s1">&#39;application/vnd.openxmlformats-officedocument.wordprocessingml.document&#39;</span><span class="p">,</span>
                <span class="s1">&#39;.txt&#39;</span><span class="p">:</span> <span class="s1">&#39;text/plain&#39;</span><span class="p">,</span>
                <span class="s1">&#39;.jpg&#39;</span><span class="p">:</span> <span class="s1">&#39;image/jpeg&#39;</span><span class="p">,</span>
                <span class="s1">&#39;.jpeg&#39;</span><span class="p">:</span> <span class="s1">&#39;image/jpeg&#39;</span><span class="p">,</span>
                <span class="s1">&#39;.png&#39;</span><span class="p">:</span> <span class="s1">&#39;image/png&#39;</span><span class="p">,</span>
                <span class="s1">&#39;.gif&#39;</span><span class="p">:</span> <span class="s1">&#39;image/gif&#39;</span>
            <span class="p">}</span>

            <span class="n">expected_mime</span> <span class="o">=</span> <span class="n">extension_mime_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">extension</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">expected_mime</span> <span class="ow">and</span> <span class="n">expected_mime</span> <span class="o">!=</span> <span class="n">detected_mime</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="s1">&#39;errors&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;File extension doesn&#39;t match content type&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">result</span>

            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;is_valid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">return</span> <span class="n">result</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;errors&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not analyze file content: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_file_exists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_hash</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if file with same hash already exists&quot;&quot;&quot;</span>
        <span class="c1"># In production, check database or file index</span>
        <span class="c1"># For demo, just return False</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_scan_for_viruses</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_data</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Basic virus scanning (integrate with real antivirus)&quot;&quot;&quot;</span>

        <span class="c1"># Simple heuristic checks</span>
        <span class="n">suspicious_patterns</span> <span class="o">=</span> <span class="p">[</span>
            <span class="sa">b</span><span class="s1">&#39;&lt;script&#39;</span><span class="p">,</span>
            <span class="sa">b</span><span class="s1">&#39;javascript:&#39;</span><span class="p">,</span>
            <span class="sa">b</span><span class="s1">&#39;vbscript:&#39;</span><span class="p">,</span>
            <span class="sa">b</span><span class="s1">&#39;eval(&#39;</span><span class="p">,</span>
            <span class="sa">b</span><span class="s1">&#39;document.cookie&#39;</span><span class="p">,</span>
            <span class="sa">b</span><span class="s1">&#39;window.location&#39;</span>
        <span class="p">]</span>

        <span class="n">file_lower</span> <span class="o">=</span> <span class="n">file_data</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">suspicious_patterns</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">file_lower</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;is_clean&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;threat&#39;</span><span class="p">:</span> <span class="s1">&#39;Suspicious content detected&#39;</span><span class="p">}</span>

        <span class="c1"># In production, integrate with ClamAV or similar</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;is_clean&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>

<span class="c1"># Demonstration of secure file upload</span>
<span class="k">def</span><span class="w"> </span><span class="nf">demonstrate_secure_file_upload</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Demonstrate secure file upload handling&quot;&quot;&quot;</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=== Secure File Upload Demo ===&quot;</span><span class="p">)</span>

    <span class="n">upload_manager</span> <span class="o">=</span> <span class="n">SecureFileUploadManager</span><span class="p">()</span>

    <span class="c1"># Simulate file upload tests</span>
    <span class="n">test_files</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s1">&#39;filename&#39;</span><span class="p">:</span> <span class="s1">&#39;document.pdf&#39;</span><span class="p">,</span>
            <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="sa">b</span><span class="s1">&#39;%PDF-1.4</span><span class="se">\n</span><span class="s1">1 0 obj</span><span class="se">\n</span><span class="s1">&lt;&lt;</span><span class="se">\n</span><span class="s1">/Type /Catalog&#39;</span><span class="p">,</span>  <span class="c1"># PDF header</span>
            <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;Valid PDF file&#39;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s1">&#39;filename&#39;</span><span class="p">:</span> <span class="s1">&#39;malicious.exe&#39;</span><span class="p">,</span>
            <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="sa">b</span><span class="s1">&#39;MZ</span><span class="se">\x90\x00</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="c1"># PE executable header</span>
            <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;Executable file (should be blocked)&#39;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s1">&#39;filename&#39;</span><span class="p">:</span> <span class="s1">&#39;script.txt&#39;</span><span class="p">,</span>
            <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="sa">b</span><span class="s1">&#39;&lt;script&gt;alert(&quot;xss&quot;)&lt;/script&gt;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;Text file with suspicious content&#39;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s1">&#39;filename&#39;</span><span class="p">:</span> <span class="s1">&#39;../../../etc/passwd&#39;</span><span class="p">,</span>
            <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="sa">b</span><span class="s1">&#39;root:x:0:0:root:/root:/bin/bash&#39;</span><span class="p">,</span>
            <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;Path traversal attempt&#39;</span>
        <span class="p">}</span>
    <span class="p">]</span>

    <span class="k">for</span> <span class="n">test_file</span> <span class="ow">in</span> <span class="n">test_files</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Testing: </span><span class="si">{</span><span class="n">test_file</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Filename: </span><span class="si">{</span><span class="n">test_file</span><span class="p">[</span><span class="s1">&#39;filename&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">validation_result</span> <span class="o">=</span> <span class="n">upload_manager</span><span class="o">.</span><span class="n">validate_file_upload</span><span class="p">(</span>
            <span class="n">test_file</span><span class="p">[</span><span class="s1">&#39;content&#39;</span><span class="p">],</span>
            <span class="n">test_file</span><span class="p">[</span><span class="s1">&#39;filename&#39;</span><span class="p">],</span>
            <span class="s1">&#39;test_user&#39;</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">validation_result</span><span class="p">[</span><span class="s1">&#39;is_valid&#39;</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;✅ File validation passed&quot;</span><span class="p">)</span>

            <span class="n">save_result</span> <span class="o">=</span> <span class="n">upload_manager</span><span class="o">.</span><span class="n">save_file_securely</span><span class="p">(</span>
                <span class="n">test_file</span><span class="p">[</span><span class="s1">&#39;content&#39;</span><span class="p">],</span>
                <span class="n">validation_result</span><span class="p">,</span>
                <span class="s1">&#39;test_user&#39;</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">save_result</span><span class="p">[</span><span class="s1">&#39;success&#39;</span><span class="p">]:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ File saved as: </span><span class="si">{</span><span class="n">save_result</span><span class="p">[</span><span class="s1">&#39;metadata&#39;</span><span class="p">][</span><span class="s1">&#39;stored_filename&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ Save failed: </span><span class="si">{</span><span class="n">save_result</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;❌ File validation failed:&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">error</span> <span class="ow">in</span> <span class="n">validation_result</span><span class="p">[</span><span class="s1">&#39;errors&#39;</span><span class="p">]:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - </span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Example: Complete secure user registration system</span>
<span class="k">def</span><span class="w"> </span><span class="nf">demonstrate_complete_secure_registration</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Demonstrate complete secure user registration with all protections&quot;&quot;&quot;</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=== Complete Secure Registration System Demo ===&quot;</span><span class="p">)</span>

    <span class="c1"># Initialize all security components</span>
    <span class="n">db_manager</span> <span class="o">=</span> <span class="n">SecureDatabaseManager</span><span class="p">()</span>
    <span class="n">xss_manager</span> <span class="o">=</span> <span class="n">XSSProtectionManager</span><span class="p">()</span>
    <span class="n">validator</span> <span class="o">=</span> <span class="n">WhitelistValidator</span><span class="p">()</span>
    <span class="n">error_handler</span> <span class="o">=</span> <span class="n">SafeErrorHandler</span><span class="p">()</span>

    <span class="c1"># Simulate user registration form submission</span>
    <span class="n">registration_data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;username&#39;</span><span class="p">:</span> <span class="s1">&#39;newstudent123&#39;</span><span class="p">,</span>
        <span class="s1">&#39;email&#39;</span><span class="p">:</span> <span class="s1">&#39;newstudent@school.edu&#39;</span><span class="p">,</span>
        <span class="s1">&#39;password&#39;</span><span class="p">:</span> <span class="s1">&#39;SecureStudentPass123!&#39;</span><span class="p">,</span>
        <span class="s1">&#39;first_name&#39;</span><span class="p">:</span> <span class="s1">&#39;John&#39;</span><span class="p">,</span>
        <span class="s1">&#39;last_name&#39;</span><span class="p">:</span> <span class="s1">&#39;Smith&#39;</span><span class="p">,</span>
        <span class="s1">&#39;grade_level&#39;</span><span class="p">:</span> <span class="s1">&#39;11&#39;</span><span class="p">,</span>
        <span class="s1">&#39;bio&#39;</span><span class="p">:</span> <span class="s1">&#39;&lt;p&gt;I enjoy &lt;strong&gt;mathematics&lt;/strong&gt; and science.&lt;/p&gt;&#39;</span>
    <span class="p">}</span>

    <span class="n">required_fields</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">,</span> <span class="s1">&#39;email&#39;</span><span class="p">,</span> <span class="s1">&#39;password&#39;</span><span class="p">,</span> <span class="s1">&#39;first_name&#39;</span><span class="p">,</span> <span class="s1">&#39;last_name&#39;</span><span class="p">]</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;1. Input Validation...&quot;</span><span class="p">)</span>

    <span class="c1"># Step 1: Whitelist validation</span>
    <span class="n">validation_result</span> <span class="o">=</span> <span class="n">validator</span><span class="o">.</span><span class="n">validate_form</span><span class="p">(</span><span class="n">registration_data</span><span class="p">,</span> <span class="n">required_fields</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">validation_result</span><span class="p">[</span><span class="s1">&#39;is_valid&#39;</span><span class="p">]:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;❌ Validation failed:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">error</span> <span class="ow">in</span> <span class="n">validation_result</span><span class="p">[</span><span class="s1">&#39;errors&#39;</span><span class="p">]:</span>
            <span class="n">safe_error</span> <span class="o">=</span> <span class="n">error_handler</span><span class="o">.</span><span class="n">handle_validation_error</span><span class="p">(</span>
                <span class="n">error</span><span class="p">[</span><span class="s1">&#39;field&#39;</span><span class="p">],</span> <span class="n">error</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">],</span> 
                <span class="n">registration_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">error</span><span class="p">[</span><span class="s1">&#39;field&#39;</span><span class="p">],</span> <span class="s1">&#39;&#39;</span><span class="p">),</span> 
                <span class="s1">&#39;192.168.1.100&#39;</span>
            <span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">safe_error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;✅ Input validation passed&quot;</span><span class="p">)</span>

    <span class="c1"># Step 2: XSS protection</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;2. XSS Protection...&quot;</span><span class="p">)</span>
    <span class="n">xss_result</span> <span class="o">=</span> <span class="n">xss_manager</span><span class="o">.</span><span class="n">validate_and_sanitize_form_data</span><span class="p">(</span><span class="n">registration_data</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">xss_result</span><span class="p">[</span><span class="s1">&#39;is_valid&#39;</span><span class="p">]:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;❌ XSS protection failed:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">error</span> <span class="ow">in</span> <span class="n">xss_result</span><span class="p">[</span><span class="s1">&#39;errors&#39;</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;✅ XSS protection passed&quot;</span><span class="p">)</span>

    <span class="c1"># Step 3: Database insertion with SQL injection protection</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;3. Secure Database Operation...&quot;</span><span class="p">)</span>

    <span class="n">sanitized_data</span> <span class="o">=</span> <span class="n">validation_result</span><span class="p">[</span><span class="s1">&#39;sanitized_data&#39;</span><span class="p">]</span>

    <span class="n">success</span><span class="p">,</span> <span class="n">message</span> <span class="o">=</span> <span class="n">db_manager</span><span class="o">.</span><span class="n">create_user</span><span class="p">(</span>
        <span class="n">sanitized_data</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">],</span>
        <span class="n">sanitized_data</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">],</span>
        <span class="n">sanitized_data</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ User registration successful: </span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">safe_error</span> <span class="o">=</span> <span class="n">error_handler</span><span class="o">.</span><span class="n">handle_database_error</span><span class="p">(</span>
            <span class="s1">&#39;user_creation&#39;</span><span class="p">,</span> <span class="s1">&#39;192.168.1.100&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ Registration failed: </span><span class="si">{</span><span class="n">safe_error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre>
</div>
<h2 id="summary">Summary<a class="headerlink" href="#summary" title="Permanent link">&para;</a></h2>
<p><strong>Input validation and sanitization form the foundation of secure web applications:</strong></p>
<p><strong>SQL Injection Prevention:</strong></p>
<ul>
<li>
<p><strong>Always use parameterized queries</strong> - never concatenate user input directly into SQL</p>
</li>
<li>
<p><strong>Validate all input</strong> before database operations</p>
</li>
<li>
<p><strong>Apply principle of least privilege</strong> to database accounts</p>
</li>
<li>
<p><strong>Monitor and log</strong> authentication attempts and database errors</p>
</li>
</ul>
<p><strong>XSS Protection:</strong></p>
<ul>
<li>
<p><strong>Escape output by default</strong> - encode data when displaying to users</p>
</li>
<li>
<p><strong>Use whitelist validation</strong> for rich content</p>
</li>
<li>
<p><strong>Apply context-aware encoding</strong> (HTML, JavaScript, CSS contexts require different approaches)</p>
</li>
<li>
<p><strong>Implement Content Security Policy</strong> to restrict script execution</p>
</li>
</ul>
<p><strong>Input Validation Strategy:</strong></p>
<ul>
<li>
<p><strong>Prefer whitelist over blacklist</strong> approaches</p>
</li>
<li>
<p><strong>Validate both format and content</strong> of uploaded files</p>
</li>
<li>
<p><strong>Implement multiple layers</strong> of validation</p>
</li>
<li>
<p><strong>Fail securely</strong> when validation errors occur</p>
</li>
</ul>
<p><strong>Safe Error Handling:</strong></p>
<ul>
<li>
<p><strong>Log detailed errors</strong> for administrators</p>
</li>
<li>
<p><strong>Return generic messages</strong> to users</p>
</li>
<li>
<p><strong>Avoid information disclosure</strong> in error responses</p>
</li>
<li>
<p><strong>Monitor error patterns</strong> for attack detection</p>
</li>
</ul>
<p><strong>File Upload Security:</strong></p>
<ul>
<li>
<p><strong>Validate file types</strong> by content, not just extension</p>
</li>
<li>
<p><strong>Scan for malware</strong> before storage</p>
</li>
<li>
<p><strong>Use secure file naming</strong> to prevent conflicts and attacks</p>
</li>
<li>
<p><strong>Apply size limits</strong> to prevent resource exhaustion</p>
</li>
</ul>
<p><strong>Implementation best practices:</strong></p>
<ul>
<li>
<p><strong>Defense in depth</strong>: Multiple validation layers</p>
</li>
<li>
<p><strong>Fail securely</strong>: Default to rejecting suspicious input</p>
</li>
<li>
<p><strong>Log security events</strong>: Monitor for attack patterns</p>
</li>
<li>
<p><strong>Regular updates</strong>: Keep security libraries current</p>
</li>
</ul>
<p>Understanding and implementing comprehensive input validation protects applications from the majority of common web vulnerabilities and provides a solid foundation for secure system design.</p>







  
    
  
  


  <aside class="md-source-file">
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="Last update">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date" title="October 15, 2025 07:03:58 UTC">October 15, 2025</span>
  </span>

    
    
    
    
  </aside>


  



  <form class="md-feedback" name="feedback" hidden>
    <fieldset>
      <legend class="md-feedback__title">
        Was this page helpful?
      </legend>
      <div class="md-feedback__inner">
        <div class="md-feedback__list">
          
            <button class="md-feedback__icon md-icon" type="submit" title="This page was helpful" data-md-value="1">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 12a8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8 8 8 0 0 0 8-8m2 0a10 10 0 0 1-10 10A10 10 0 0 1 2 12 10 10 0 0 1 12 2a10 10 0 0 1 10 10M10 9.5c0 .8-.7 1.5-1.5 1.5S7 10.3 7 9.5 7.7 8 8.5 8s1.5.7 1.5 1.5m7 0c0 .8-.7 1.5-1.5 1.5S14 10.3 14 9.5 14.7 8 15.5 8s1.5.7 1.5 1.5m-5 7.73c-1.75 0-3.29-.73-4.19-1.81L9.23 14c.45.72 1.52 1.23 2.77 1.23s2.32-.51 2.77-1.23l1.42 1.42c-.9 1.08-2.44 1.81-4.19 1.81"/></svg>
            </button>
          
            <button class="md-feedback__icon md-icon" type="submit" title="This page could be improved" data-md-value="0">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 12a8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8 8 8 0 0 0 8-8m2 0a10 10 0 0 1-10 10A10 10 0 0 1 2 12 10 10 0 0 1 12 2a10 10 0 0 1 10 10m-6.5-4c.8 0 1.5.7 1.5 1.5s-.7 1.5-1.5 1.5-1.5-.7-1.5-1.5.7-1.5 1.5-1.5M10 9.5c0 .8-.7 1.5-1.5 1.5S7 10.3 7 9.5 7.7 8 8.5 8s1.5.7 1.5 1.5m2 4.5c1.75 0 3.29.72 4.19 1.81l-1.42 1.42C14.32 16.5 13.25 16 12 16s-2.32.5-2.77 1.23l-1.42-1.42C8.71 14.72 10.25 14 12 14"/></svg>
            </button>
          
        </div>
        <div class="md-feedback__note">
          
            <div data-md-value="1" hidden>
              
              
                
              
              
              
                
                
              
              Thanks for your feedback!
            </div>
          
            <div data-md-value="0" hidden>
              
              
                
              
              
              
                
                
              
              Thanks for your feedback! Help us improve this page by creating an <a href="https://github.com/Eatham532/Software-Engineering-HSC-Textbook/issues/new/choose" target="_blank" rel="noopener">issue</a> on github.
            </div>
          
        </div>
      </div>
    </fieldset>
  </form>


                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        

<!-- Footer -->
<footer class="md-footer">
  
    <!-- Custom footer with left/right layout -->
    <div class="md-footer__inner md-grid">
      <!-- Left side: Copyright and cookie settings -->
      <div class="md-footer__left">
        <div class="md-footer__copyright">
          
            Copyright &copy; 2025 Eatham532 – <a href="#__consent">Change cookie settings</a>

          
        </div>
      </div>

      <!-- Right side: Page name and BETA -->
      <div class="md-footer__right">
        <div class="md-footer__page-info">
          <span class="md-footer__page-title">Content</span>
          
            <span class="md-footer__beta-badge">BETA</span>
          
        </div>
      </div>
    </div>
  
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
      <div class="md-progress" data-md-component="progress" role="progressbar"></div>
    
    
      <div class="md-consent" data-md-component="consent" id="__consent" hidden>
        <div class="md-consent__overlay"></div>
        <aside class="md-consent__inner">
          <form class="md-consent__form md-grid md-typeset" name="consent">
            



<h4>Cookie consent</h4>
<p>We use cookies to recognize your repeated visits and preferences, as well as to measure the effectiveness of the textbook. With your consent, you're helping us to make software engineering education better for everyone.</p>
<input class="md-toggle" type="checkbox" id="__settings" >
<div class="md-consent__settings">
  <ul class="task-list">
    
    
    
      
        
  
  
    
    
  
  <li class="task-list-item">
    <label class="task-list-control">
      <input type="checkbox" name="github" checked>
      <span class="task-list-indicator"></span>
      GitHub
    </label>
  </li>

      
    
    
      
        
  
  
    
    
  
  <li class="task-list-item">
    <label class="task-list-control">
      <input type="checkbox" name="analytics" checked>
      <span class="task-list-indicator"></span>
      Google Analytics
    </label>
  </li>

      
    
  </ul>
</div>
<div class="md-consent__controls">
  
    
      <button class="md-button md-button--primary">Accept</button>
    
    
    
  
    
    
    
      <label class="md-button" for="__settings">Manage settings</label>
    
  
</div>
          </form>
        </aside>
      </div>
      <script>var consent=__md_get("__consent");if(consent)for(var input of document.forms.consent.elements)input.name&&(input.checked=consent[input.name]||!1);else"file:"!==location.protocol&&setTimeout((function(){document.querySelector("[data-md-component=consent]").hidden=!1}),250);var form=document.forms.consent;for(var action of["submit","reset"])form.addEventListener(action,(function(e){if(e.preventDefault(),"reset"===e.type)for(var n of document.forms.consent.elements)n.name&&(n.checked=!1);__md_set("__consent",Object.fromEntries(Array.from(new FormData(form).keys()).map((function(e){return[e,!0]})))),location.hash="",location.reload()}))</script>
    
    
      
      <script id="__config" type="application/json">{"base": "../../../..", "features": ["navigation.tabs", "navigation.top", "navigation.instant", "navigation.instant.prefetch", "navigation.instant.progress", "navigation.prune", "search.highlight", "search.suggest", "content.code.annotate", "content.code.copy", "content.code.select", "content.tabs.link", "content.action.edit", "content.action.view", "toc.follow"], "search": "../../../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
        <script src="../../../../assets/diagram-modal.js"></script>
      
        <script src="../../../../assets/quiz.js"></script>
      
        <script src="../../../../assets/ide-utils.js"></script>
      
        <script src="../../../../assets/code-blocks.js"></script>
      
    
  </body>
</html>