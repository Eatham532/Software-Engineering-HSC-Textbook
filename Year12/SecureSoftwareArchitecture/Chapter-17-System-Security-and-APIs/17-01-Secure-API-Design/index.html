
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Comprehensive educational resource for NSW HSC Software Engineering syllabus">
      
      
      
        <link rel="canonical" href="https://eatham532.github.io/Software-Engineering-HSC-Textbook/Year12/SecureSoftwareArchitecture/Chapter-17-System-Security-and-APIs/17-01-Secure-API-Design/">
      
      
        <link rel="prev" href="../../Chapter-16-Input-Security-and-Data-Protection/16-02-Privacy-by-Design/quiz/">
      
      
        <link rel="next" href="quiz/">
      
      
      <link rel="icon" href="../../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.22">
    
    
      
        <title>17.1 Secure API Design - Software Engineering Textbook HSC</title>
      
    
    
      <link rel="stylesheet" href="../../../../assets/stylesheets/main.84d31ad4.min.css">
      
        
        <link rel="stylesheet" href="../../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../../assets/diagram-modal.css">
    
      <link rel="stylesheet" href="../../../../assets/quiz.css">
    
      <link rel="stylesheet" href="../../../../assets/common.css">
    
      <link rel="stylesheet" href="../../../../assets/diagram-fix.css">
    
      <link rel="stylesheet" href="../../../../assets/cross-reference.css">
    
      <link rel="stylesheet" href="../../../../assets/site-banner.css">
    
      <link rel="stylesheet" href="../../../../assets/code-runner.css">
    
      <link rel="stylesheet" href="../../../../assets/code-editor.css">
    
      <link rel="stylesheet" href="../../../../assets/glossary.css">
    
    <script>__md_scope=new URL("../../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config","G-58275RL1P9"),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","G-58275RL1P9",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=G-58275RL1P9",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script>
  
    <script>if("undefined"!=typeof __md_analytics){var consent=__md_get("__consent");consent&&consent.analytics&&__md_analytics()}</script>
  

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#171-secure-api-design" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
  
  
    
    
    
    <div class="site-banner site-banner--warning" data-banner data-banner-version="1" role="status" aria-live="polite">
      <div class="site-banner__inner">
        <span class="site-banner__icon" aria-hidden="true">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            
              <path d="M12 9v4"/><path d="M12 17h.01"/><path d="M10.29 3.86 1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0Z"/>
            
          </svg>
        </span>
        <p class="site-banner__text">
          This textbook is in <strong>beta</strong> – content is actively being refined.
          
            <a class="site-banner__link" href="https://github.com/Eatham532/Software-Engineering-HSC-Textbook/issues/new/choose" target="_blank" rel="noopener">Report issues or suggestions</a>
          
        </p>
        <button type="button" class="site-banner__close" aria-label="Dismiss banner" title="Dismiss" data-banner-dismiss>&times;</button>
      </div>
    </div>
    <script>
      (function(){
        var banner=document.querySelector('[data-banner]');
        if(!banner) return;
        var version=banner.getAttribute('data-banner-version')||'1';
        var KEY='site_banner_dismissed_v'+version;
        try{ if(localStorage.getItem(KEY)){ banner.remove(); return;} }catch(e){}
        var btn=banner.querySelector('[data-banner-dismiss]');
        if(btn){ btn.addEventListener('click',function(){
          banner.classList.add('is-hiding');
          setTimeout(function(){ banner && banner.remove(); },200);
          try{ localStorage.setItem(KEY,'1'); }catch(e){}
        }); }
      })();
    </script>
  
  
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../../.." title="Software Engineering Textbook HSC" class="md-header__button md-logo" aria-label="Software Engineering Textbook HSC" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Software Engineering Textbook HSC
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              17.1 Secure API Design
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m14.3 16-.7-2h-3.2l-.7 2H7.8L11 7h2l3.2 9zM20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12zm-9.15 3.96h2.3L12 9z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="black" data-md-color-accent="indigo"  aria-label="Switch to system preference"  type="radio" name="__palette" id="__palette_2">
    
      <label class="md-header__button md-icon" title="Switch to system preference" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/Eatham532/Software-Engineering-HSC-Textbook/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    Eatham532/Software-Engineering-HSC-Textbook
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    

    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../.." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../Year11/ProgrammingFundamentals/" class="md-tabs__link">
          
  
  
  Year 11

        </a>
      </li>
    
  

    
  

      
        
  
  
  
    
  
  
    
    
      
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../../../ProgrammingForTheWeb/" class="md-tabs__link">
          
  
  
  Year 12

        </a>
      </li>
    
  

    
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../../code-editor/" class="md-tabs__link">
        
  
  
    
  
  Code Editor

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../../glossary/" class="md-tabs__link">
        
  
  
    
  
  Glossary

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../.." title="Software Engineering Textbook HSC" class="md-nav__button md-logo" aria-label="Software Engineering Textbook HSC" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Software Engineering Textbook HSC
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/Eatham532/Software-Engineering-HSC-Textbook/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    Eatham532/Software-Engineering-HSC-Textbook
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
  
    
  
  
  
    <a href="../../../../Year11/ProgrammingFundamentals/" class="md-nav__link">
      
  
  
  <span class="md-ellipsis">
    Year 11
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

  

      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
      
    
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Year 12
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Year 12
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
  
    <a href="../../../ProgrammingForTheWeb/" class="md-nav__link">
      
  
  
  <span class="md-ellipsis">
    Programming For The Web
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
    
      
      
    
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_2" checked>
        
          
          <label class="md-nav__link" for="__nav_3_2" id="__nav_3_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Secure Software Architecture
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3_2">
            <span class="md-nav__icon md-icon"></span>
            Secure Software Architecture
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
  
    
  
  
  
    <a href="../../Chapter-14-Security-Foundations/14-01-The-Business-Case-for-Security/" class="md-nav__link">
      
  
  
  <span class="md-ellipsis">
    Chapter 14 — Security Foundations
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
  
    
  
  
  
    <a href="../../Chapter-15-Core-Security-Principles/15-01-Security-Fundamentals-CIA-Triad-and-AAA/" class="md-nav__link">
      
  
  
  <span class="md-ellipsis">
    Chapter 15 — Core Security Principles
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
  
    
  
  
  
    <a href="../../Chapter-16-Input-Security-and-Data-Protection/16-01-Input-Validation-and-Sanitization/" class="md-nav__link">
      
  
  
  <span class="md-ellipsis">
    Chapter 16 — Input Security and Data Protection
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

  

      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
    
      
      
    
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_2_5" checked>
        
          
          <label class="md-nav__link" for="__nav_3_2_5" id="__nav_3_2_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Chapter 17 — System Security and APIs
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_2_5_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3_2_5">
            <span class="md-nav__icon md-icon"></span>
            Chapter 17 — System Security and APIs
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    
    
    
    
      
      
    
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_2_5_1" checked>
        
          
          <label class="md-nav__link" for="__nav_3_2_5_1" id="__nav_3_2_5_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    17.1 Secure API Design
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_3_2_5_1_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3_2_5_1">
            <span class="md-nav__icon md-icon"></span>
            17.1 Secure API Design
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Content
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Content
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#why-it-matters" class="md-nav__link">
    <span class="md-ellipsis">
      Why It Matters
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#core-security-principles-for-apis" class="md-nav__link">
    <span class="md-ellipsis">
      Core Security Principles for APIs
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Core Security Principles for APIs">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-defense-in-depth" class="md-nav__link">
    <span class="md-ellipsis">
      1. Defense in Depth
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-principle-of-least-privilege" class="md-nav__link">
    <span class="md-ellipsis">
      2. Principle of Least Privilege
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-fail-securely" class="md-nav__link">
    <span class="md-ellipsis">
      3. Fail Securely
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-security-by-design" class="md-nav__link">
    <span class="md-ellipsis">
      4. Security by Design
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#api-authentication-methods" class="md-nav__link">
    <span class="md-ellipsis">
      API Authentication Methods
    </span>
  </a>
  
    <nav class="md-nav" aria-label="API Authentication Methods">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#understanding-authentication-vs-authorization" class="md-nav__link">
    <span class="md-ellipsis">
      Understanding Authentication vs Authorization
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1-api-keys" class="md-nav__link">
    <span class="md-ellipsis">
      1. API Keys
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1. API Keys">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#basic-api-key-implementation" class="md-nav__link">
    <span class="md-ellipsis">
      Basic API Key Implementation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#api-key-security-best-practices" class="md-nav__link">
    <span class="md-ellipsis">
      API Key Security Best Practices
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-json-web-tokens-jwt" class="md-nav__link">
    <span class="md-ellipsis">
      2. JSON Web Tokens (JWT)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2. JSON Web Tokens (JWT)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#jwt-implementation" class="md-nav__link">
    <span class="md-ellipsis">
      JWT Implementation
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-oauth-20-delegated-authorization" class="md-nav__link">
    <span class="md-ellipsis">
      3. OAuth 2.0 - Delegated Authorization
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3. OAuth 2.0 - Delegated Authorization">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#oauth-20-flow-implementation" class="md-nav__link">
    <span class="md-ellipsis">
      OAuth 2.0 Flow Implementation
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#choosing-the-right-authentication-method" class="md-nav__link">
    <span class="md-ellipsis">
      Choosing the Right Authentication Method
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rate-limiting-and-dos-protection" class="md-nav__link">
    <span class="md-ellipsis">
      Rate Limiting and DoS Protection
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Rate Limiting and DoS Protection">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#token-bucket-algorithm-implementation" class="md-nav__link">
    <span class="md-ellipsis">
      Token Bucket Algorithm Implementation
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#secure-session-management" class="md-nav__link">
    <span class="md-ellipsis">
      Secure Session Management
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Secure Session Management">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#session-security-principles" class="md-nav__link">
    <span class="md-ellipsis">
      Session Security Principles
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#comprehensive-session-manager-implementation" class="md-nav__link">
    <span class="md-ellipsis">
      Comprehensive Session Manager Implementation
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cors-and-cross-origin-security" class="md-nav__link">
    <span class="md-ellipsis">
      CORS and Cross-Origin Security
    </span>
  </a>
  
    <nav class="md-nav" aria-label="CORS and Cross-Origin Security">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#understanding-cors-security-model" class="md-nav__link">
    <span class="md-ellipsis">
      Understanding CORS Security Model
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#comprehensive-cors-implementation" class="md-nav__link">
    <span class="md-ellipsis">
      Comprehensive CORS Implementation
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#api-security-testing" class="md-nav__link">
    <span class="md-ellipsis">
      API Security Testing
    </span>
  </a>
  
    <nav class="md-nav" aria-label="API Security Testing">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#security-testing-methodology" class="md-nav__link">
    <span class="md-ellipsis">
      Security Testing Methodology
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#automated-security-testing-framework" class="md-nav__link">
    <span class="md-ellipsis">
      Automated Security Testing Framework
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#building-a-complete-secure-rest-api" class="md-nav__link">
    <span class="md-ellipsis">
      Building a Complete Secure REST API
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Building a Complete Secure REST API">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#secure-api-architecture" class="md-nav__link">
    <span class="md-ellipsis">
      Secure API Architecture
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#complete-secure-api-implementation" class="md-nav__link">
    <span class="md-ellipsis">
      Complete Secure API Implementation
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#summary-and-best-practices" class="md-nav__link">
    <span class="md-ellipsis">
      Summary and Best Practices
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Summary and Best Practices">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#essential-security-principles" class="md-nav__link">
    <span class="md-ellipsis">
      Essential Security Principles
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implementation-checklist" class="md-nav__link">
    <span class="md-ellipsis">
      Implementation Checklist
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Implementation Checklist">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#api-keys" class="md-nav__link">
    <span class="md-ellipsis">
      API Keys
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#jwt-tokens" class="md-nav__link">
    <span class="md-ellipsis">
      JWT Tokens
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#oauth-20" class="md-nav__link">
    <span class="md-ellipsis">
      OAuth 2.0
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#token-bucket-algorithm" class="md-nav__link">
    <span class="md-ellipsis">
      Token Bucket Algorithm
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#progressive-penalties" class="md-nav__link">
    <span class="md-ellipsis">
      Progressive Penalties
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#secure-session-ids" class="md-nav__link">
    <span class="md-ellipsis">
      Secure Session IDs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#security-features" class="md-nav__link">
    <span class="md-ellipsis">
      Security Features
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#origin-validation" class="md-nav__link">
    <span class="md-ellipsis">
      Origin Validation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#security-patterns" class="md-nav__link">
    <span class="md-ellipsis">
      Security Patterns
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#automated-testing" class="md-nav__link">
    <span class="md-ellipsis">
      Automated Testing
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#comprehensive-coverage" class="md-nav__link">
    <span class="md-ellipsis">
      Comprehensive Coverage
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#production-deployment-considerations" class="md-nav__link">
    <span class="md-ellipsis">
      Production Deployment Considerations
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#common-pitfalls-to-avoid" class="md-nav__link">
    <span class="md-ellipsis">
      Common Pitfalls to Avoid
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#practice-questions-and-exercises" class="md-nav__link">
    <span class="md-ellipsis">
      Practice Questions and Exercises
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Practice Questions and Exercises">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#exercise-1-secure-registration-system" class="md-nav__link">
    <span class="md-ellipsis">
      Exercise 1: Secure Registration System
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#exercise-2-api-rate-limiter" class="md-nav__link">
    <span class="md-ellipsis">
      Exercise 2: API Rate Limiter
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#exercise-3-cors-security-manager" class="md-nav__link">
    <span class="md-ellipsis">
      Exercise 3: CORS Security Manager
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#exercise-4-security-testing-suite" class="md-nav__link">
    <span class="md-ellipsis">
      Exercise 4: Security Testing Suite
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#case-study-e-commerce-api-security-breach" class="md-nav__link">
    <span class="md-ellipsis">
      Case Study: E-commerce API Security Breach
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#summary-checklist" class="md-nav__link">
    <span class="md-ellipsis">
      Summary Checklist
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Summary Checklist">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#authentication-authorization" class="md-nav__link">
    <span class="md-ellipsis">
      Authentication &amp; Authorization
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rate-limiting-dos-protection" class="md-nav__link">
    <span class="md-ellipsis">
      Rate Limiting &amp; DoS Protection
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#input-validation-sanitization" class="md-nav__link">
    <span class="md-ellipsis">
      Input Validation &amp; Sanitization
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#session-management" class="md-nav__link">
    <span class="md-ellipsis">
      Session Management
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cors-cross-origin-security" class="md-nav__link">
    <span class="md-ellipsis">
      CORS &amp; Cross-Origin Security
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitoring-testing" class="md-nav__link">
    <span class="md-ellipsis">
      Monitoring &amp; Testing
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deployment-security" class="md-nav__link">
    <span class="md-ellipsis">
      Deployment Security
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="quiz/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Quiz
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
  
    <a href="../17-02-Secure-Execution-and-Resource-Management/" class="md-nav__link">
      
  
  
  <span class="md-ellipsis">
    17.2 Secure Execution & Resource Management
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
  
    
  
  
  
    <a href="../../Chapter-18-Security-Testing-and-Vulnerabilities/18-01-Security-Testing-Fundamentals/" class="md-nav__link">
      
  
  
  <span class="md-ellipsis">
    Chapter 18 — Security Testing & Vulnerabilities
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
  
    
  
  
  
    <a href="../../Chapter-19-Security-in-Context/19-01-Security-in-Development-Teams/" class="md-nav__link">
      
  
  
  <span class="md-ellipsis">
    Chapter 19 — Security in Context
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

  

      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
  
    <a href="../../../SoftwareAutomation/" class="md-nav__link">
      
  
  
  <span class="md-ellipsis">
    Software Automation
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
  
    <a href="../../../SoftwareEngineeringProject/" class="md-nav__link">
      
  
  
  <span class="md-ellipsis">
    Software Engineering Project
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../code-editor/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Code Editor
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../glossary/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Glossary
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#why-it-matters" class="md-nav__link">
    <span class="md-ellipsis">
      Why It Matters
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#core-security-principles-for-apis" class="md-nav__link">
    <span class="md-ellipsis">
      Core Security Principles for APIs
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Core Security Principles for APIs">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-defense-in-depth" class="md-nav__link">
    <span class="md-ellipsis">
      1. Defense in Depth
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-principle-of-least-privilege" class="md-nav__link">
    <span class="md-ellipsis">
      2. Principle of Least Privilege
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-fail-securely" class="md-nav__link">
    <span class="md-ellipsis">
      3. Fail Securely
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-security-by-design" class="md-nav__link">
    <span class="md-ellipsis">
      4. Security by Design
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#api-authentication-methods" class="md-nav__link">
    <span class="md-ellipsis">
      API Authentication Methods
    </span>
  </a>
  
    <nav class="md-nav" aria-label="API Authentication Methods">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#understanding-authentication-vs-authorization" class="md-nav__link">
    <span class="md-ellipsis">
      Understanding Authentication vs Authorization
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1-api-keys" class="md-nav__link">
    <span class="md-ellipsis">
      1. API Keys
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1. API Keys">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#basic-api-key-implementation" class="md-nav__link">
    <span class="md-ellipsis">
      Basic API Key Implementation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#api-key-security-best-practices" class="md-nav__link">
    <span class="md-ellipsis">
      API Key Security Best Practices
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-json-web-tokens-jwt" class="md-nav__link">
    <span class="md-ellipsis">
      2. JSON Web Tokens (JWT)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2. JSON Web Tokens (JWT)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#jwt-implementation" class="md-nav__link">
    <span class="md-ellipsis">
      JWT Implementation
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-oauth-20-delegated-authorization" class="md-nav__link">
    <span class="md-ellipsis">
      3. OAuth 2.0 - Delegated Authorization
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3. OAuth 2.0 - Delegated Authorization">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#oauth-20-flow-implementation" class="md-nav__link">
    <span class="md-ellipsis">
      OAuth 2.0 Flow Implementation
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#choosing-the-right-authentication-method" class="md-nav__link">
    <span class="md-ellipsis">
      Choosing the Right Authentication Method
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rate-limiting-and-dos-protection" class="md-nav__link">
    <span class="md-ellipsis">
      Rate Limiting and DoS Protection
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Rate Limiting and DoS Protection">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#token-bucket-algorithm-implementation" class="md-nav__link">
    <span class="md-ellipsis">
      Token Bucket Algorithm Implementation
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#secure-session-management" class="md-nav__link">
    <span class="md-ellipsis">
      Secure Session Management
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Secure Session Management">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#session-security-principles" class="md-nav__link">
    <span class="md-ellipsis">
      Session Security Principles
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#comprehensive-session-manager-implementation" class="md-nav__link">
    <span class="md-ellipsis">
      Comprehensive Session Manager Implementation
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cors-and-cross-origin-security" class="md-nav__link">
    <span class="md-ellipsis">
      CORS and Cross-Origin Security
    </span>
  </a>
  
    <nav class="md-nav" aria-label="CORS and Cross-Origin Security">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#understanding-cors-security-model" class="md-nav__link">
    <span class="md-ellipsis">
      Understanding CORS Security Model
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#comprehensive-cors-implementation" class="md-nav__link">
    <span class="md-ellipsis">
      Comprehensive CORS Implementation
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#api-security-testing" class="md-nav__link">
    <span class="md-ellipsis">
      API Security Testing
    </span>
  </a>
  
    <nav class="md-nav" aria-label="API Security Testing">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#security-testing-methodology" class="md-nav__link">
    <span class="md-ellipsis">
      Security Testing Methodology
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#automated-security-testing-framework" class="md-nav__link">
    <span class="md-ellipsis">
      Automated Security Testing Framework
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#building-a-complete-secure-rest-api" class="md-nav__link">
    <span class="md-ellipsis">
      Building a Complete Secure REST API
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Building a Complete Secure REST API">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#secure-api-architecture" class="md-nav__link">
    <span class="md-ellipsis">
      Secure API Architecture
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#complete-secure-api-implementation" class="md-nav__link">
    <span class="md-ellipsis">
      Complete Secure API Implementation
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#summary-and-best-practices" class="md-nav__link">
    <span class="md-ellipsis">
      Summary and Best Practices
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Summary and Best Practices">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#essential-security-principles" class="md-nav__link">
    <span class="md-ellipsis">
      Essential Security Principles
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implementation-checklist" class="md-nav__link">
    <span class="md-ellipsis">
      Implementation Checklist
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Implementation Checklist">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#api-keys" class="md-nav__link">
    <span class="md-ellipsis">
      API Keys
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#jwt-tokens" class="md-nav__link">
    <span class="md-ellipsis">
      JWT Tokens
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#oauth-20" class="md-nav__link">
    <span class="md-ellipsis">
      OAuth 2.0
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#token-bucket-algorithm" class="md-nav__link">
    <span class="md-ellipsis">
      Token Bucket Algorithm
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#progressive-penalties" class="md-nav__link">
    <span class="md-ellipsis">
      Progressive Penalties
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#secure-session-ids" class="md-nav__link">
    <span class="md-ellipsis">
      Secure Session IDs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#security-features" class="md-nav__link">
    <span class="md-ellipsis">
      Security Features
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#origin-validation" class="md-nav__link">
    <span class="md-ellipsis">
      Origin Validation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#security-patterns" class="md-nav__link">
    <span class="md-ellipsis">
      Security Patterns
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#automated-testing" class="md-nav__link">
    <span class="md-ellipsis">
      Automated Testing
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#comprehensive-coverage" class="md-nav__link">
    <span class="md-ellipsis">
      Comprehensive Coverage
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#production-deployment-considerations" class="md-nav__link">
    <span class="md-ellipsis">
      Production Deployment Considerations
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#common-pitfalls-to-avoid" class="md-nav__link">
    <span class="md-ellipsis">
      Common Pitfalls to Avoid
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#practice-questions-and-exercises" class="md-nav__link">
    <span class="md-ellipsis">
      Practice Questions and Exercises
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Practice Questions and Exercises">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#exercise-1-secure-registration-system" class="md-nav__link">
    <span class="md-ellipsis">
      Exercise 1: Secure Registration System
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#exercise-2-api-rate-limiter" class="md-nav__link">
    <span class="md-ellipsis">
      Exercise 2: API Rate Limiter
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#exercise-3-cors-security-manager" class="md-nav__link">
    <span class="md-ellipsis">
      Exercise 3: CORS Security Manager
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#exercise-4-security-testing-suite" class="md-nav__link">
    <span class="md-ellipsis">
      Exercise 4: Security Testing Suite
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#case-study-e-commerce-api-security-breach" class="md-nav__link">
    <span class="md-ellipsis">
      Case Study: E-commerce API Security Breach
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#summary-checklist" class="md-nav__link">
    <span class="md-ellipsis">
      Summary Checklist
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Summary Checklist">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#authentication-authorization" class="md-nav__link">
    <span class="md-ellipsis">
      Authentication &amp; Authorization
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rate-limiting-dos-protection" class="md-nav__link">
    <span class="md-ellipsis">
      Rate Limiting &amp; DoS Protection
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#input-validation-sanitization" class="md-nav__link">
    <span class="md-ellipsis">
      Input Validation &amp; Sanitization
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#session-management" class="md-nav__link">
    <span class="md-ellipsis">
      Session Management
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cors-cross-origin-security" class="md-nav__link">
    <span class="md-ellipsis">
      CORS &amp; Cross-Origin Security
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitoring-testing" class="md-nav__link">
    <span class="md-ellipsis">
      Monitoring &amp; Testing
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deployment-security" class="md-nav__link">
    <span class="md-ellipsis">
      Deployment Security
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
    <a href="https://github.com/Eatham532/Software-Engineering-HSC-Textbook/edit/main/docs/Year12/SecureSoftwareArchitecture/Chapter-17-System-Security-and-APIs/17-01-Secure-API-Design/index.md" title="Edit this page" class="md-content__button md-icon" rel="edit">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4zm10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1z"/></svg>
    </a>
  
  
    
      
    
    <a href="https://github.com/Eatham532/Software-Engineering-HSC-Textbook/raw/main/docs/Year12/SecureSoftwareArchitecture/Chapter-17-System-Security-and-APIs/17-01-Secure-API-Design/index.md" title="View source of this page" class="md-content__button md-icon">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 18c.56 0 1 .44 1 1s-.44 1-1 1-1-.44-1-1 .44-1 1-1m0-3c-2.73 0-5.06 1.66-6 4 .94 2.34 3.27 4 6 4s5.06-1.66 6-4c-.94-2.34-3.27-4-6-4m0 6.5a2.5 2.5 0 0 1-2.5-2.5 2.5 2.5 0 0 1 2.5-2.5 2.5 2.5 0 0 1 2.5 2.5 2.5 2.5 0 0 1-2.5 2.5M9.27 20H6V4h7v5h5v4.07c.7.08 1.36.25 2 .49V8l-6-6H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h4.5a8.2 8.2 0 0 1-1.23-2"/></svg>
    </a>
  


<h1 id="171-secure-api-design">17.1 Secure API Design<a class="headerlink" href="#171-secure-api-design" title="Permanent link">&para;</a></h1>
<h2 id="why-it-matters">Why It Matters<a class="headerlink" href="#why-it-matters" title="Permanent link">&para;</a></h2>
<p><span class="glossary-term" data-glossary-category="Web Development" data-glossary-definition="A set of protocols and tools for building software applications, defining how components interact." data-glossary-full-form="Application Programming Interface" data-glossary-term="API">APIs</span> (Application Programming Interfaces) are the backbone of modern applications, enabling communication between different systems, services, and client applications. However, <span class="glossary-term" data-glossary-category="Web Development" data-glossary-definition="A set of protocols and tools for building software applications, defining how components interact." data-glossary-full-form="Application Programming Interface" data-glossary-term="API">APIs</span> also represent significant attack surfaces that can expose sensitive data, business logic, and system resources to malicious actors.</p>
<p><strong>Real-world Impact:</strong></p>
<ul>
<li>
<p><strong>2019 Facebook <span class="glossary-term" data-glossary-category="Web Development" data-glossary-definition="A set of protocols and tools for building software applications, defining how components interact." data-glossary-full-form="Application Programming Interface" data-glossary-term="API">API</span> breach</strong>: Exposed 50 million user accounts through improper access token validation</p>
</li>
<li>
<p><strong>2021 Peloton <span class="glossary-term" data-glossary-category="Web Development" data-glossary-definition="A set of protocols and tools for building software applications, defining how components interact." data-glossary-full-form="Application Programming Interface" data-glossary-term="API">API</span> vulnerability</strong>: Allowed unauthorized access to private user data through missing authentication</p>
</li>
<li>
<p><strong>2020 Venmo <span class="glossary-term" data-glossary-category="Web Development" data-glossary-definition="A set of protocols and tools for building software applications, defining how components interact." data-glossary-full-form="Application Programming Interface" data-glossary-term="API">API</span> issue</strong>: Public transaction data accessible without proper authorization controls</p>
</li>
</ul>
<p>Secure <span class="glossary-term" data-glossary-category="Web Development" data-glossary-definition="A set of protocols and tools for building software applications, defining how components interact." data-glossary-full-form="Application Programming Interface" data-glossary-term="API">API</span> design is critical because <span class="glossary-term" data-glossary-category="Web Development" data-glossary-definition="A set of protocols and tools for building software applications, defining how components interact." data-glossary-full-form="Application Programming Interface" data-glossary-term="API">APIs</span> often:</p>
<ul>
<li>
<p>Handle sensitive user data and business information</p>
</li>
<li>
<p>Provide direct access to backend systems and <span class="glossary-term" data-glossary-category="Web Development" data-glossary-definition="An organized collection of structured data stored electronically in a computer system, typically accessed via a database management system." data-glossary-term="Database">databases</span></p>
</li>
<li>
<p>Are exposed to public networks and untrusted clients</p>
</li>
<li>
<p>Serve as integration points between multiple applications</p>
</li>
</ul>
<h2 id="core-security-principles-for-apis">Core Security Principles for <span class="glossary-term" data-glossary-category="Web Development" data-glossary-definition="A set of protocols and tools for building software applications, defining how components interact." data-glossary-full-form="Application Programming Interface" data-glossary-term="API">APIs</span><a class="headerlink" href="#core-security-principles-for-apis" title="Permanent link">&para;</a></h2>
<h3 id="1-defense-in-depth">1. Defense in Depth<a class="headerlink" href="#1-defense-in-depth" title="Permanent link">&para;</a></h3>
<p>Implement multiple layers of security controls rather than relying on a single protection mechanism.</p>
<h3 id="2-principle-of-least-privilege">2. Principle of Least Privilege<a class="headerlink" href="#2-principle-of-least-privilege" title="Permanent link">&para;</a></h3>
<p>Grant the minimum access necessary for each <span class="glossary-term" data-glossary-category="Web Development" data-glossary-definition="A set of protocols and tools for building software applications, defining how components interact." data-glossary-full-form="Application Programming Interface" data-glossary-term="API">API</span> consumer to perform their intended <span class="glossary-term" data-glossary-category="Programming Fundamentals" data-glossary-definition="A reusable block of code that performs a specific task and returns a value to the caller." data-glossary-term="Function">function</span>.</p>
<h3 id="3-fail-securely">3. Fail Securely<a class="headerlink" href="#3-fail-securely" title="Permanent link">&para;</a></h3>
<p>When errors occur, ensure the system fails to a secure <span class="glossary-term" data-glossary-category="OOP" data-glossary-definition="The set of values of all attributes of an object at a particular point in time during program execution." data-glossary-term="State">state</span> rather than exposing sensitive information.</p>
<h3 id="4-security-by-design">4. Security by Design<a class="headerlink" href="#4-security-by-design" title="Permanent link">&para;</a></h3>
<p>Build security controls into the <span class="glossary-term" data-glossary-category="Web Development" data-glossary-definition="A set of protocols and tools for building software applications, defining how components interact." data-glossary-full-form="Application Programming Interface" data-glossary-term="API">API</span> from the initial design phase, not as an afterthought.</p>
<h2 id="api-authentication-methods"><span class="glossary-term" data-glossary-category="Web Development" data-glossary-definition="A set of protocols and tools for building software applications, defining how components interact." data-glossary-full-form="Application Programming Interface" data-glossary-term="API">API</span> Authentication <span class="glossary-term" data-glossary-category="OOP" data-glossary-definition="A function defined within a class that describes the behaviors of objects created from that class." data-glossary-term="Method">Methods</span><a class="headerlink" href="#api-authentication-methods" title="Permanent link">&para;</a></h2>
<h3 id="understanding-authentication-vs-authorization">Understanding Authentication vs Authorization<a class="headerlink" href="#understanding-authentication-vs-authorization" title="Permanent link">&para;</a></h3>
<p><strong>Authentication</strong> answers &ldquo;Who are you?&rdquo; - verifying the identity of the <span class="glossary-term" data-glossary-category="Web Development" data-glossary-definition="A set of protocols and tools for building software applications, defining how components interact." data-glossary-full-form="Application Programming Interface" data-glossary-term="API">API</span> consumer.</p>
<p><strong>Authorization</strong> answers &ldquo;What can you do?&rdquo; - determining what resources and actions are permitted.</p>
<p><strong>Why multiple authentication <span class="glossary-term" data-glossary-category="OOP" data-glossary-definition="A function defined within a class that describes the behaviors of objects created from that class." data-glossary-term="Method">methods</span> exist:</strong></p>
<p>Different applications have different security needs. We&rsquo;ll explore three main authentication approaches, from simplest to most sophisticated:</p>
<ol>
<li><strong><span class="glossary-term" data-glossary-category="Web Development" data-glossary-definition="A set of protocols and tools for building software applications, defining how components interact." data-glossary-full-form="Application Programming Interface" data-glossary-term="API">API</span> Keys</strong>: Simple tokens for basic identification (good for server-to-server)</li>
<li><strong>JWT (JSON Web Tokens)</strong>: Stateless tokens carrying user information (good for modern web/mobile apps)</li>
<li><strong>OAuth 2.0</strong>: Delegated authorization for third-party access (good for &ldquo;Login with&hellip;&rdquo; features)</li>
</ol>
<p>Each <span class="glossary-term" data-glossary-category="OOP" data-glossary-definition="A function defined within a class that describes the behaviors of objects created from that class." data-glossary-term="Method">method</span> builds on concepts from the previous one, adding complexity to solve specific security challenges.</p>
<div class="diagram-container" data-container-id="kroki-diagram-0"><button class="diagram-expand-btn" onclick="openDiagramModal('kroki-diagram-0')">🔍 View Larger</button><div id="kroki-diagram-0" class="diagram-content"><p><svg xmlns="http://www.w3.org/2000/svg" contentStyleType="text/css" data-diagram-type="SEQUENCE" height="416px" preserveAspectRatio="xMaxYMax meet" style="width:651px;height:416px;background:#FFFFFF;" version="1.1" viewBox="0 0 651 416" width="651px" zoomAndPan="magnify" id="Kroki" data-diagram-id="kroki-svg-0"><defs /><g><g><title>Client</title><rect fill="#000000" fill-opacity="0.00000" height="253.0625" width="8" x="29.2651" y="82.2969" /><line style="stroke:#000000;stroke-width:1;" x1="33" x2="33" y1="82.2969" y2="335.3594" /></g><g><title><span class="glossary-term" data-glossary-category="Web Development" data-glossary-definition="A set of protocols and tools for building software applications, defining how components interact." data-glossary-full-form="Application Programming Interface" data-glossary-term="API">API</span> Gateway</title><rect fill="#000000" fill-opacity="0.00000" height="253.0625" width="8" x="224.4805" y="82.2969" /><line style="stroke:#000000;stroke-width:1;" x1="228.2588" x2="228.2588" y1="82.2969" y2="335.3594" /></g><g><title>Auth Service</title><rect fill="#000000" fill-opacity="0.00000" height="253.0625" width="8" x="387.7036" y="82.2969" /><line style="stroke:#000000;stroke-width:1;" x1="391.2017" x2="391.2017" y1="82.2969" y2="335.3594" /></g><g><title><span class="glossary-term" data-glossary-category="Web Development" data-glossary-definition="A set of protocols and tools for building software applications, defining how components interact." data-glossary-full-form="Application Programming Interface" data-glossary-term="API">API</span> Service</title><rect fill="#000000" fill-opacity="0.00000" height="253.0625" width="8" x="515.3755" y="82.2969" /><line style="stroke:#000000;stroke-width:1;" x1="519.2056" x2="519.2056" y1="82.2969" y2="335.3594" /></g><g><title>User <span class="glossary-term" data-glossary-category="Web Development" data-glossary-definition="An organized collection of structured data stored electronically in a computer system, typically accessed via a database management system." data-glossary-term="Database">DB</span></title><rect fill="#000000" fill-opacity="0.00000" height="253.0625" width="8" x="612.918" y="82.2969" /><line style="stroke:#000000;stroke-width:1;" x1="616.5454" x2="616.5454" y1="82.2969" y2="335.3594" /></g><g class="participant participant-head" data-participant="Client"><text fill="#000000" font-family="Arial" font-size="14" lengthAdjust="spacing" textLength="40.5303" x="10" y="78.9951">Client</text><ellipse cx="33.2651" cy="14" fill="#FFFFFF" rx="8" ry="8" style="stroke:#000000;stroke-width:1;" /><path d="M33.2651,22 L33.2651,49 M20.2651,30 L46.2651,30 M33.2651,49 L20.2651,64 M33.2651,49 L46.2651,64" fill="none" style="stroke:#000000;stroke-width:1;" /></g><g class="participant participant-tail" data-participant="Client"><text fill="#000000" font-family="Arial" font-size="14" lengthAdjust="spacing" textLength="40.5303" x="10" y="347.3545">Client</text><ellipse cx="33.2651" cy="359.6563" fill="#FFFFFF" rx="8" ry="8" style="stroke:#000000;stroke-width:1;" /><path d="M33.2651,367.6563 L33.2651,394.6563 M20.2651,375.6563 L46.2651,375.6563 M33.2651,394.6563 L20.2651,409.6563 M33.2651,394.6563 L46.2651,409.6563" fill="none" style="stroke:#000000;stroke-width:1;" /></g><g class="participant participant-head" data-participant="Gateway"><rect fill="#FFFFFF" height="30.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="102.4434" x="177.2588" y="51" /><text fill="#000000" font-family="Arial" font-size="14" lengthAdjust="spacing" textLength="88.4434" x="184.2588" y="70.9951"><span class="glossary-term" data-glossary-category="Web Development" data-glossary-definition="A set of protocols and tools for building software applications, defining how components interact." data-glossary-full-form="Application Programming Interface" data-glossary-term="API">API</span> Gateway</text></g><g class="participant participant-tail" data-participant="Gateway"><rect fill="#FFFFFF" height="30.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="102.4434" x="177.2588" y="334.3594" /><text fill="#000000" font-family="Arial" font-size="14" lengthAdjust="spacing" textLength="88.4434" x="184.2588" y="354.3545"><span class="glossary-term" data-glossary-category="Web Development" data-glossary-definition="A set of protocols and tools for building software applications, defining how components interact." data-glossary-full-form="Application Programming Interface" data-glossary-term="API">API</span> Gateway</text></g><g class="participant participant-head" data-participant="Auth"><rect fill="#FFFFFF" height="30.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="103.0039" x="340.2017" y="51" /><text fill="#000000" font-family="Arial" font-size="14" lengthAdjust="spacing" textLength="89.0039" x="347.2017" y="70.9951">Auth Service</text></g><g class="participant participant-tail" data-participant="Auth"><rect fill="#FFFFFF" height="30.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="103.0039" x="340.2017" y="334.3594" /><text fill="#000000" font-family="Arial" font-size="14" lengthAdjust="spacing" textLength="89.0039" x="347.2017" y="354.3545">Auth Service</text></g><g class="participant participant-head" data-participant="API"><rect fill="#FFFFFF" height="30.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="92.3398" x="473.2056" y="51" /><text fill="#000000" font-family="Arial" font-size="14" lengthAdjust="spacing" textLength="78.3398" x="480.2056" y="70.9951"><span class="glossary-term" data-glossary-category="Web Development" data-glossary-definition="A set of protocols and tools for building software applications, defining how components interact." data-glossary-full-form="Application Programming Interface" data-glossary-term="API">API</span> Service</text></g><g class="participant participant-tail" data-participant="API"><rect fill="#FFFFFF" height="30.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="92.3398" x="473.2056" y="334.3594" /><text fill="#000000" font-family="Arial" font-size="14" lengthAdjust="spacing" textLength="78.3398" x="480.2056" y="354.3545"><span class="glossary-term" data-glossary-category="Web Development" data-glossary-definition="A set of protocols and tools for building software applications, defining how components interact." data-glossary-full-form="Application Programming Interface" data-glossary-term="API">API</span> Service</text></g><g class="participant participant-head" data-participant="DB"><text fill="#000000" font-family="Arial" font-size="14" lengthAdjust="spacing" textLength="56.7451" x="585.5454" y="78.9951">User <span class="glossary-term" data-glossary-category="Web Development" data-glossary-definition="An organized collection of structured data stored electronically in a computer system, typically accessed via a database management system." data-glossary-term="Database">DB</span></text><path d="M598.918,30 C598.918,20 616.918,20 616.918,20 C616.918,20 634.918,20 634.918,30 L634.918,56 C634.918,66 616.918,66 616.918,66 C616.918,66 598.918,66 598.918,56 L598.918,30" fill="#FFFFFF" style="stroke:#000000;stroke-width:1.5;" /><path d="M598.918,30 C598.918,40 616.918,40 616.918,40 C616.918,40 634.918,40 634.918,30" fill="none" style="stroke:#000000;stroke-width:1.5;" /></g><g class="participant participant-tail" data-participant="DB"><text fill="#000000" font-family="Arial" font-size="14" lengthAdjust="spacing" textLength="56.7451" x="585.5454" y="347.3545">User <span class="glossary-term" data-glossary-category="Web Development" data-glossary-definition="An organized collection of structured data stored electronically in a computer system, typically accessed via a database management system." data-glossary-term="Database">DB</span></text><path d="M598.918,360.6563 C598.918,350.6563 616.918,350.6563 616.918,350.6563 C616.918,350.6563 634.918,350.6563 634.918,360.6563 L634.918,386.6563 C634.918,396.6563 616.918,396.6563 616.918,396.6563 C616.918,396.6563 598.918,396.6563 598.918,386.6563 L598.918,360.6563" fill="#FFFFFF" style="stroke:#000000;stroke-width:1.5;" /><path d="M598.918,360.6563 C598.918,370.6563 616.918,370.6563 616.918,370.6563 C616.918,370.6563 634.918,370.6563 634.918,360.6563" fill="none" style="stroke:#000000;stroke-width:1.5;" /></g><g class="message" data-participant-1="Client" data-participant-2="Gateway"><polygon fill="#000000" points="216.4805,109.4297,226.4805,113.4297,216.4805,117.4297,220.4805,113.4297" style="stroke:#000000;stroke-width:1;" /><line style="stroke:#000000;stroke-width:1;" x1="33.2651" x2="222.4805" y1="113.4297" y2="113.4297" /><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="171.2153" x="40.2651" y="108.3638"><span class="glossary-term" data-glossary-category="Web Development" data-glossary-definition="A set of protocols and tools for building software applications, defining how components interact." data-glossary-full-form="Application Programming Interface" data-glossary-term="API">API</span> Request + Credentials</text></g><g class="message" data-participant-1="Gateway" data-participant-2="Auth"><polygon fill="#000000" points="379.7036,138.5625,389.7036,142.5625,379.7036,146.5625,383.7036,142.5625" style="stroke:#000000;stroke-width:1;" /><line style="stroke:#000000;stroke-width:1;" x1="228.4805" x2="385.7036" y1="142.5625" y2="142.5625" /><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="83.624" x="235.4805" y="137.4966">Authenticate</text></g><g class="message" data-participant-1="Auth" data-participant-2="DB"><polygon fill="#000000" points="604.918,167.6953,614.918,171.6953,604.918,175.6953,608.918,171.6953" style="stroke:#000000;stroke-width:1;" /><line style="stroke:#000000;stroke-width:1;" x1="391.7036" x2="610.918" y1="171.6953" y2="171.6953" /><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="131.498" x="398.7036" y="166.6294">Validate Credentials</text></g><g class="message" data-participant-1="DB" data-participant-2="Auth"><polygon fill="#000000" points="402.7036,196.8281,392.7036,200.8281,402.7036,204.8281,398.7036,200.8281" style="stroke:#000000;stroke-width:1;" /><line style="stroke:#000000;stroke-width:1;" x1="396.7036" x2="615.918" y1="200.8281" y2="200.8281" /><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="58.3667" x="408.7036" y="195.7622">User Info</text></g><g class="message" data-participant-1="Auth" data-participant-2="Gateway"><polygon fill="#000000" points="239.4805,225.9609,229.4805,229.9609,239.4805,233.9609,235.4805,229.9609" style="stroke:#000000;stroke-width:1;" /><line style="stroke:#000000;stroke-width:1;" x1="233.4805" x2="390.7036" y1="229.9609" y2="229.9609" /><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="139.2231" x="245.4805" y="224.895">Authentication Token</text></g><g class="message" data-participant-1="Gateway" data-participant-2="API"><polygon fill="#000000" points="507.3755,255.0938,517.3755,259.0938,507.3755,263.0938,511.3755,259.0938" style="stroke:#000000;stroke-width:1;" /><line style="stroke:#000000;stroke-width:1;" x1="228.4805" x2="513.3755" y1="259.0938" y2="259.0938" /><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="127.9751" x="235.4805" y="254.0278">Authorized Request</text></g><g class="message" data-participant-1="API" data-participant-2="Gateway"><polygon fill="#000000" points="239.4805,284.2266,229.4805,288.2266,239.4805,292.2266,235.4805,288.2266" style="stroke:#000000;stroke-width:1;" /><line style="stroke:#000000;stroke-width:1;" x1="233.4805" x2="518.3755" y1="288.2266" y2="288.2266" /><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="63.0195" x="245.4805" y="283.1606">Response</text></g><g class="message" data-participant-1="Gateway" data-participant-2="Client"><polygon fill="#000000" points="44.2651,313.3594,34.2651,317.3594,44.2651,321.3594,40.2651,317.3594" style="stroke:#000000;stroke-width:1;" /><line style="stroke:#000000;stroke-width:1;" x1="38.2651" x2="227.4805" y1="317.3594" y2="317.3594" /><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="87.7183" x="50.2651" y="312.2935"><span class="glossary-term" data-glossary-category="Web Development" data-glossary-definition="A set of protocols and tools for building software applications, defining how components interact." data-glossary-full-form="Application Programming Interface" data-glossary-term="API">API</span> Response</text></g></g></svg></p></div></div>
<h3 id="1-api-keys">1. <span class="glossary-term" data-glossary-category="Web Development" data-glossary-definition="A set of protocols and tools for building software applications, defining how components interact." data-glossary-full-form="Application Programming Interface" data-glossary-term="API">API</span> Keys<a class="headerlink" href="#1-api-keys" title="Permanent link">&para;</a></h3>
<p><span class="glossary-term" data-glossary-category="Web Development" data-glossary-definition="A set of protocols and tools for building software applications, defining how components interact." data-glossary-full-form="Application Programming Interface" data-glossary-term="API">API</span> keys are simple tokens that identify and authenticate <span class="glossary-term" data-glossary-category="Web Development" data-glossary-definition="A set of protocols and tools for building software applications, defining how components interact." data-glossary-full-form="Application Programming Interface" data-glossary-term="API">API</span> consumers. They&rsquo;re the easiest authentication <span class="glossary-term" data-glossary-category="OOP" data-glossary-definition="A function defined within a class that describes the behaviors of objects created from that class." data-glossary-term="Method">method</span> to implement, which makes them popular for public <span class="glossary-term" data-glossary-category="Web Development" data-glossary-definition="A set of protocols and tools for building software applications, defining how components interact." data-glossary-full-form="Application Programming Interface" data-glossary-term="API">APIs</span> and developer tools.</p>
<p><strong>How <span class="glossary-term" data-glossary-category="Web Development" data-glossary-definition="A set of protocols and tools for building software applications, defining how components interact." data-glossary-full-form="Application Programming Interface" data-glossary-term="API">API</span> keys work:</strong></p>
<ol>
<li>Application requests an <span class="glossary-term" data-glossary-category="Web Development" data-glossary-definition="A set of protocols and tools for building software applications, defining how components interact." data-glossary-full-form="Application Programming Interface" data-glossary-term="API">API</span> key from the service provider</li>
<li>Service generates a unique token and associates it with the application</li>
<li>Application includes this key in every <span class="glossary-term" data-glossary-category="Web Development" data-glossary-definition="A set of protocols and tools for building software applications, defining how components interact." data-glossary-full-form="Application Programming Interface" data-glossary-term="API">API</span> request (usually in headers or query parameters)</li>
<li>Service validates the key and processes the request</li>
</ol>
<p><strong><span class="glossary-term" data-glossary-category="Web Development" data-glossary-definition="A set of protocols and tools for building software applications, defining how components interact." data-glossary-full-form="Application Programming Interface" data-glossary-term="API">API</span> Key Limitations:</strong></p>
<p>While simple to use, <span class="glossary-term" data-glossary-category="Web Development" data-glossary-definition="A set of protocols and tools for building software applications, defining how components interact." data-glossary-full-form="Application Programming Interface" data-glossary-term="API">API</span> keys have several important security limitations:</p>
<ul>
<li><strong>No user context</strong>: Keys identify the application, not individual users - everyone using your app shares the same key</li>
<li><strong>Long-lived credentials</strong>: Keys often don&rsquo;t expire automatically, creating a larger window for compromise</li>
<li><strong>Hard to rotate</strong>: Changing keys requires updating all deployed applications, causing downtime</li>
<li><strong>Limited permissions</strong>: Most <span class="glossary-term" data-glossary-category="Web Development" data-glossary-definition="A set of protocols and tools for building software applications, defining how components interact." data-glossary-full-form="Application Programming Interface" data-glossary-term="API">API</span> key systems don&rsquo;t support fine-grained permissions or scopes</li>
<li><strong>Exposure risk</strong>: Keys can be accidentally <span class="glossary-term" data-glossary-category="Project Management" data-glossary-definition="A snapshot of changes to files in a version control system, representing a point in the project&#39;s history." data-glossary-term="Commit">committed</span> to code <span class="glossary-term" data-glossary-category="Project Management" data-glossary-definition="A storage location for software packages, code, and project files, often managed by version control systems like Git." data-glossary-term="Repository">repositories</span> or logged in plain text</li>
<li><strong>No built-in expiration</strong>: Unlike tokens, keys typically don&rsquo;t expire unless manually revoked</li>
</ul>
<p><strong>When to use <span class="glossary-term" data-glossary-category="Web Development" data-glossary-definition="A set of protocols and tools for building software applications, defining how components interact." data-glossary-full-form="Application Programming Interface" data-glossary-term="API">API</span> keys:</strong></p>
<ul>
<li>Server-to-server communication where the client is trusted</li>
<li>Public <span class="glossary-term" data-glossary-category="Web Development" data-glossary-definition="A set of protocols and tools for building software applications, defining how components interact." data-glossary-full-form="Application Programming Interface" data-glossary-term="API">APIs</span> with basic rate limiting needs</li>
<li>Simple authentication for internal tools</li>
<li>Scenarios where user-level authentication isn&rsquo;t required</li>
</ul>
<p><strong>When NOT to use <span class="glossary-term" data-glossary-category="Web Development" data-glossary-definition="A set of protocols and tools for building software applications, defining how components interact." data-glossary-full-form="Application Programming Interface" data-glossary-term="API">API</span> keys:</strong></p>
<ul>
<li>Mobile or web applications where keys can be extracted from client code</li>
<li>Systems requiring user-specific permissions</li>
<li>High-security environments handling sensitive data</li>
<li>Applications needing temporary or time-limited access</li>
</ul>
<h4 id="basic-api-key-implementation">Basic <span class="glossary-term" data-glossary-category="Web Development" data-glossary-definition="A set of protocols and tools for building software applications, defining how components interact." data-glossary-full-form="Application Programming Interface" data-glossary-term="API">API</span> Key Implementation<a class="headerlink" href="#basic-api-key-implementation" title="Permanent link">&para;</a></h4>
<div class="language-python highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">secrets</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">hashlib</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="nd">@dataclass</span>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="k">class</span><span class="w"> </span><span class="nc">APIKey</span><span class="p">:</span>
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Represents an API key with metadata&quot;&quot;&quot;</span>
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>    <span class="n">key_id</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>    <span class="n">key_hash</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># Hashed version of the actual key</span>
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-0-14"><a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>    <span class="n">created_at</span><span class="p">:</span> <span class="n">datetime</span>
</span><span id="__span-0-15"><a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>    <span class="n">expires_at</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">datetime</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-0-16"><a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>    <span class="n">is_active</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="__span-0-17"><a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>    <span class="n">rate_limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span>  <span class="c1"># requests per hour</span>
</span><span id="__span-0-18"><a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>    <span class="n">allowed_endpoints</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># None means all endpoints</span>
</span><span id="__span-0-19"><a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>
</span><span id="__span-0-20"><a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a><span class="k">class</span><span class="w"> </span><span class="nc">APIKeyManager</span><span class="p">:</span>
</span><span id="__span-0-21"><a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Secure API key management system&quot;&quot;&quot;</span>
</span><span id="__span-0-22"><a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>
</span><span id="__span-0-23"><a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-0-24"><a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">APIKey</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="__span-0-25"><a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">usage_tracking</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="__span-0-26"><a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>
</span><span id="__span-0-27"><a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">generate_api_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">expires_days</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="__span-0-28"><a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>                        <span class="n">rate_limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">allowed_endpoints</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
</span><span id="__span-0-29"><a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-0-30"><a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a><span class="sd">        Generate a new API key</span>
</span><span id="__span-0-31"><a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a><span class="sd">        Returns: (key_id, actual_key) - store key_id, give actual_key to user</span>
</span><span id="__span-0-32"><a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="__span-0-33"><a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a>        <span class="c1"># Generate cryptographically secure key</span>
</span><span id="__span-0-34"><a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a>        <span class="n">actual_key</span> <span class="o">=</span> <span class="n">secrets</span><span class="o">.</span><span class="n">token_urlsafe</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>
</span><span id="__span-0-35"><a id="__codelineno-0-35" name="__codelineno-0-35" href="#__codelineno-0-35"></a>        <span class="n">key_id</span> <span class="o">=</span> <span class="n">secrets</span><span class="o">.</span><span class="n">token_urlsafe</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
</span><span id="__span-0-36"><a id="__codelineno-0-36" name="__codelineno-0-36" href="#__codelineno-0-36"></a>
</span><span id="__span-0-37"><a id="__codelineno-0-37" name="__codelineno-0-37" href="#__codelineno-0-37"></a>        <span class="c1"># Hash the key for storage (never store plain text keys)</span>
</span><span id="__span-0-38"><a id="__codelineno-0-38" name="__codelineno-0-38" href="#__codelineno-0-38"></a>        <span class="n">key_hash</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">actual_key</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
</span><span id="__span-0-39"><a id="__codelineno-0-39" name="__codelineno-0-39" href="#__codelineno-0-39"></a>
</span><span id="__span-0-40"><a id="__codelineno-0-40" name="__codelineno-0-40" href="#__codelineno-0-40"></a>        <span class="c1"># Set expiration</span>
</span><span id="__span-0-41"><a id="__codelineno-0-41" name="__codelineno-0-41" href="#__codelineno-0-41"></a>        <span class="n">expires_at</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-0-42"><a id="__codelineno-0-42" name="__codelineno-0-42" href="#__codelineno-0-42"></a>        <span class="k">if</span> <span class="n">expires_days</span><span class="p">:</span>
</span><span id="__span-0-43"><a id="__codelineno-0-43" name="__codelineno-0-43" href="#__codelineno-0-43"></a>            <span class="n">expires_at</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">expires_days</span><span class="p">)</span>
</span><span id="__span-0-44"><a id="__codelineno-0-44" name="__codelineno-0-44" href="#__codelineno-0-44"></a>
</span><span id="__span-0-45"><a id="__codelineno-0-45" name="__codelineno-0-45" href="#__codelineno-0-45"></a>        <span class="c1"># Create API key record</span>
</span><span id="__span-0-46"><a id="__codelineno-0-46" name="__codelineno-0-46" href="#__codelineno-0-46"></a>        <span class="n">api_key</span> <span class="o">=</span> <span class="n">APIKey</span><span class="p">(</span>
</span><span id="__span-0-47"><a id="__codelineno-0-47" name="__codelineno-0-47" href="#__codelineno-0-47"></a>            <span class="n">key_id</span><span class="o">=</span><span class="n">key_id</span><span class="p">,</span>
</span><span id="__span-0-48"><a id="__codelineno-0-48" name="__codelineno-0-48" href="#__codelineno-0-48"></a>            <span class="n">key_hash</span><span class="o">=</span><span class="n">key_hash</span><span class="p">,</span>
</span><span id="__span-0-49"><a id="__codelineno-0-49" name="__codelineno-0-49" href="#__codelineno-0-49"></a>            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
</span><span id="__span-0-50"><a id="__codelineno-0-50" name="__codelineno-0-50" href="#__codelineno-0-50"></a>            <span class="n">created_at</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
</span><span id="__span-0-51"><a id="__codelineno-0-51" name="__codelineno-0-51" href="#__codelineno-0-51"></a>            <span class="n">expires_at</span><span class="o">=</span><span class="n">expires_at</span><span class="p">,</span>
</span><span id="__span-0-52"><a id="__codelineno-0-52" name="__codelineno-0-52" href="#__codelineno-0-52"></a>            <span class="n">rate_limit</span><span class="o">=</span><span class="n">rate_limit</span><span class="p">,</span>
</span><span id="__span-0-53"><a id="__codelineno-0-53" name="__codelineno-0-53" href="#__codelineno-0-53"></a>            <span class="n">allowed_endpoints</span><span class="o">=</span><span class="n">allowed_endpoints</span> <span class="ow">or</span> <span class="p">[]</span>
</span><span id="__span-0-54"><a id="__codelineno-0-54" name="__codelineno-0-54" href="#__codelineno-0-54"></a>        <span class="p">)</span>
</span><span id="__span-0-55"><a id="__codelineno-0-55" name="__codelineno-0-55" href="#__codelineno-0-55"></a>
</span><span id="__span-0-56"><a id="__codelineno-0-56" name="__codelineno-0-56" href="#__codelineno-0-56"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">[</span><span class="n">key_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">api_key</span>
</span><span id="__span-0-57"><a id="__codelineno-0-57" name="__codelineno-0-57" href="#__codelineno-0-57"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">usage_tracking</span><span class="p">[</span><span class="n">key_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-0-58"><a id="__codelineno-0-58" name="__codelineno-0-58" href="#__codelineno-0-58"></a>
</span><span id="__span-0-59"><a id="__codelineno-0-59" name="__codelineno-0-59" href="#__codelineno-0-59"></a>        <span class="k">return</span> <span class="n">key_id</span><span class="p">,</span> <span class="n">actual_key</span>
</span><span id="__span-0-60"><a id="__codelineno-0-60" name="__codelineno-0-60" href="#__codelineno-0-60"></a>
</span><span id="__span-0-61"><a id="__codelineno-0-61" name="__codelineno-0-61" href="#__codelineno-0-61"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">validate_api_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">provided_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">APIKey</span><span class="p">]:</span>
</span><span id="__span-0-62"><a id="__codelineno-0-62" name="__codelineno-0-62" href="#__codelineno-0-62"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-0-63"><a id="__codelineno-0-63" name="__codelineno-0-63" href="#__codelineno-0-63"></a><span class="sd">        Validate an API key and return associated metadata</span>
</span><span id="__span-0-64"><a id="__codelineno-0-64" name="__codelineno-0-64" href="#__codelineno-0-64"></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="__span-0-65"><a id="__codelineno-0-65" name="__codelineno-0-65" href="#__codelineno-0-65"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">provided_key</span><span class="p">:</span>
</span><span id="__span-0-66"><a id="__codelineno-0-66" name="__codelineno-0-66" href="#__codelineno-0-66"></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="__span-0-67"><a id="__codelineno-0-67" name="__codelineno-0-67" href="#__codelineno-0-67"></a>
</span><span id="__span-0-68"><a id="__codelineno-0-68" name="__codelineno-0-68" href="#__codelineno-0-68"></a>        <span class="c1"># Hash the provided key</span>
</span><span id="__span-0-69"><a id="__codelineno-0-69" name="__codelineno-0-69" href="#__codelineno-0-69"></a>        <span class="n">provided_hash</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">provided_key</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
</span><span id="__span-0-70"><a id="__codelineno-0-70" name="__codelineno-0-70" href="#__codelineno-0-70"></a>
</span><span id="__span-0-71"><a id="__codelineno-0-71" name="__codelineno-0-71" href="#__codelineno-0-71"></a>        <span class="c1"># Find matching key</span>
</span><span id="__span-0-72"><a id="__codelineno-0-72" name="__codelineno-0-72" href="#__codelineno-0-72"></a>        <span class="k">for</span> <span class="n">key_id</span><span class="p">,</span> <span class="n">api_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="__span-0-73"><a id="__codelineno-0-73" name="__codelineno-0-73" href="#__codelineno-0-73"></a>            <span class="k">if</span> <span class="n">api_key</span><span class="o">.</span><span class="n">key_hash</span> <span class="o">==</span> <span class="n">provided_hash</span><span class="p">:</span>
</span><span id="__span-0-74"><a id="__codelineno-0-74" name="__codelineno-0-74" href="#__codelineno-0-74"></a>                <span class="c1"># Check if key is active</span>
</span><span id="__span-0-75"><a id="__codelineno-0-75" name="__codelineno-0-75" href="#__codelineno-0-75"></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">api_key</span><span class="o">.</span><span class="n">is_active</span><span class="p">:</span>
</span><span id="__span-0-76"><a id="__codelineno-0-76" name="__codelineno-0-76" href="#__codelineno-0-76"></a>                    <span class="k">return</span> <span class="kc">None</span>
</span><span id="__span-0-77"><a id="__codelineno-0-77" name="__codelineno-0-77" href="#__codelineno-0-77"></a>
</span><span id="__span-0-78"><a id="__codelineno-0-78" name="__codelineno-0-78" href="#__codelineno-0-78"></a>                <span class="c1"># Check if key has expired</span>
</span><span id="__span-0-79"><a id="__codelineno-0-79" name="__codelineno-0-79" href="#__codelineno-0-79"></a>                <span class="k">if</span> <span class="n">api_key</span><span class="o">.</span><span class="n">expires_at</span> <span class="ow">and</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">api_key</span><span class="o">.</span><span class="n">expires_at</span><span class="p">:</span>
</span><span id="__span-0-80"><a id="__codelineno-0-80" name="__codelineno-0-80" href="#__codelineno-0-80"></a>                    <span class="k">return</span> <span class="kc">None</span>
</span><span id="__span-0-81"><a id="__codelineno-0-81" name="__codelineno-0-81" href="#__codelineno-0-81"></a>
</span><span id="__span-0-82"><a id="__codelineno-0-82" name="__codelineno-0-82" href="#__codelineno-0-82"></a>                <span class="k">return</span> <span class="n">api_key</span>
</span><span id="__span-0-83"><a id="__codelineno-0-83" name="__codelineno-0-83" href="#__codelineno-0-83"></a>
</span><span id="__span-0-84"><a id="__codelineno-0-84" name="__codelineno-0-84" href="#__codelineno-0-84"></a>        <span class="k">return</span> <span class="kc">None</span>
</span><span id="__span-0-85"><a id="__codelineno-0-85" name="__codelineno-0-85" href="#__codelineno-0-85"></a>
</span><span id="__span-0-86"><a id="__codelineno-0-86" name="__codelineno-0-86" href="#__codelineno-0-86"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">revoke_api_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="__span-0-87"><a id="__codelineno-0-87" name="__codelineno-0-87" href="#__codelineno-0-87"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Revoke an API key&quot;&quot;&quot;</span>
</span><span id="__span-0-88"><a id="__codelineno-0-88" name="__codelineno-0-88" href="#__codelineno-0-88"></a>        <span class="k">if</span> <span class="n">key_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">:</span>
</span><span id="__span-0-89"><a id="__codelineno-0-89" name="__codelineno-0-89" href="#__codelineno-0-89"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">[</span><span class="n">key_id</span><span class="p">]</span><span class="o">.</span><span class="n">is_active</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="__span-0-90"><a id="__codelineno-0-90" name="__codelineno-0-90" href="#__codelineno-0-90"></a>            <span class="k">return</span> <span class="kc">True</span>
</span><span id="__span-0-91"><a id="__codelineno-0-91" name="__codelineno-0-91" href="#__codelineno-0-91"></a>        <span class="k">return</span> <span class="kc">False</span>
</span><span id="__span-0-92"><a id="__codelineno-0-92" name="__codelineno-0-92" href="#__codelineno-0-92"></a>
</span><span id="__span-0-93"><a id="__codelineno-0-93" name="__codelineno-0-93" href="#__codelineno-0-93"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">track_usage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="__span-0-94"><a id="__codelineno-0-94" name="__codelineno-0-94" href="#__codelineno-0-94"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Track API key usage for rate limiting&quot;&quot;&quot;</span>
</span><span id="__span-0-95"><a id="__codelineno-0-95" name="__codelineno-0-95" href="#__codelineno-0-95"></a>        <span class="k">if</span> <span class="n">key_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">usage_tracking</span><span class="p">:</span>
</span><span id="__span-0-96"><a id="__codelineno-0-96" name="__codelineno-0-96" href="#__codelineno-0-96"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">usage_tracking</span><span class="p">[</span><span class="n">key_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-0-97"><a id="__codelineno-0-97" name="__codelineno-0-97" href="#__codelineno-0-97"></a>
</span><span id="__span-0-98"><a id="__codelineno-0-98" name="__codelineno-0-98" href="#__codelineno-0-98"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">usage_tracking</span><span class="p">[</span><span class="n">key_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span id="__span-0-99"><a id="__codelineno-0-99" name="__codelineno-0-99" href="#__codelineno-0-99"></a>            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
</span><span id="__span-0-100"><a id="__codelineno-0-100" name="__codelineno-0-100" href="#__codelineno-0-100"></a>            <span class="s1">&#39;endpoint&#39;</span><span class="p">:</span> <span class="n">endpoint</span>
</span><span id="__span-0-101"><a id="__codelineno-0-101" name="__codelineno-0-101" href="#__codelineno-0-101"></a>        <span class="p">})</span>
</span><span id="__span-0-102"><a id="__codelineno-0-102" name="__codelineno-0-102" href="#__codelineno-0-102"></a>
</span><span id="__span-0-103"><a id="__codelineno-0-103" name="__codelineno-0-103" href="#__codelineno-0-103"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">check_rate_limit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="__span-0-104"><a id="__codelineno-0-104" name="__codelineno-0-104" href="#__codelineno-0-104"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if API key is within rate limit (last hour)&quot;&quot;&quot;</span>
</span><span id="__span-0-105"><a id="__codelineno-0-105" name="__codelineno-0-105" href="#__codelineno-0-105"></a>        <span class="k">if</span> <span class="n">key_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">usage_tracking</span><span class="p">:</span>
</span><span id="__span-0-106"><a id="__codelineno-0-106" name="__codelineno-0-106" href="#__codelineno-0-106"></a>            <span class="k">return</span> <span class="kc">True</span>
</span><span id="__span-0-107"><a id="__codelineno-0-107" name="__codelineno-0-107" href="#__codelineno-0-107"></a>
</span><span id="__span-0-108"><a id="__codelineno-0-108" name="__codelineno-0-108" href="#__codelineno-0-108"></a>        <span class="n">api_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key_id</span><span class="p">)</span>
</span><span id="__span-0-109"><a id="__codelineno-0-109" name="__codelineno-0-109" href="#__codelineno-0-109"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">api_key</span><span class="p">:</span>
</span><span id="__span-0-110"><a id="__codelineno-0-110" name="__codelineno-0-110" href="#__codelineno-0-110"></a>            <span class="k">return</span> <span class="kc">False</span>
</span><span id="__span-0-111"><a id="__codelineno-0-111" name="__codelineno-0-111" href="#__codelineno-0-111"></a>
</span><span id="__span-0-112"><a id="__codelineno-0-112" name="__codelineno-0-112" href="#__codelineno-0-112"></a>        <span class="c1"># Count requests in the last hour</span>
</span><span id="__span-0-113"><a id="__codelineno-0-113" name="__codelineno-0-113" href="#__codelineno-0-113"></a>        <span class="n">one_hour_ago</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-0-114"><a id="__codelineno-0-114" name="__codelineno-0-114" href="#__codelineno-0-114"></a>        <span class="n">recent_requests</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="__span-0-115"><a id="__codelineno-0-115" name="__codelineno-0-115" href="#__codelineno-0-115"></a>            <span class="n">req</span> <span class="k">for</span> <span class="n">req</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">usage_tracking</span><span class="p">[</span><span class="n">key_id</span><span class="p">]</span>
</span><span id="__span-0-116"><a id="__codelineno-0-116" name="__codelineno-0-116" href="#__codelineno-0-116"></a>            <span class="k">if</span> <span class="n">req</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">one_hour_ago</span>
</span><span id="__span-0-117"><a id="__codelineno-0-117" name="__codelineno-0-117" href="#__codelineno-0-117"></a>        <span class="p">]</span>
</span><span id="__span-0-118"><a id="__codelineno-0-118" name="__codelineno-0-118" href="#__codelineno-0-118"></a>
</span><span id="__span-0-119"><a id="__codelineno-0-119" name="__codelineno-0-119" href="#__codelineno-0-119"></a>        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">recent_requests</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">api_key</span><span class="o">.</span><span class="n">rate_limit</span>
</span><span id="__span-0-120"><a id="__codelineno-0-120" name="__codelineno-0-120" href="#__codelineno-0-120"></a>
</span><span id="__span-0-121"><a id="__codelineno-0-121" name="__codelineno-0-121" href="#__codelineno-0-121"></a><span class="c1"># Example usage</span>
</span><span id="__span-0-122"><a id="__codelineno-0-122" name="__codelineno-0-122" href="#__codelineno-0-122"></a><span class="k">def</span><span class="w"> </span><span class="nf">api_key_authentication_example</span><span class="p">():</span>
</span><span id="__span-0-123"><a id="__codelineno-0-123" name="__codelineno-0-123" href="#__codelineno-0-123"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Demonstrate API key authentication&quot;&quot;&quot;</span>
</span><span id="__span-0-124"><a id="__codelineno-0-124" name="__codelineno-0-124" href="#__codelineno-0-124"></a>    <span class="n">key_manager</span> <span class="o">=</span> <span class="n">APIKeyManager</span><span class="p">()</span>
</span><span id="__span-0-125"><a id="__codelineno-0-125" name="__codelineno-0-125" href="#__codelineno-0-125"></a>
</span><span id="__span-0-126"><a id="__codelineno-0-126" name="__codelineno-0-126" href="#__codelineno-0-126"></a>    <span class="c1"># Generate API key for a client</span>
</span><span id="__span-0-127"><a id="__codelineno-0-127" name="__codelineno-0-127" href="#__codelineno-0-127"></a>    <span class="n">key_id</span><span class="p">,</span> <span class="n">actual_key</span> <span class="o">=</span> <span class="n">key_manager</span><span class="o">.</span><span class="n">generate_api_key</span><span class="p">(</span>
</span><span id="__span-0-128"><a id="__codelineno-0-128" name="__codelineno-0-128" href="#__codelineno-0-128"></a>        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Mobile App Client&quot;</span><span class="p">,</span>
</span><span id="__span-0-129"><a id="__codelineno-0-129" name="__codelineno-0-129" href="#__codelineno-0-129"></a>        <span class="n">expires_days</span><span class="o">=</span><span class="mi">365</span><span class="p">,</span>
</span><span id="__span-0-130"><a id="__codelineno-0-130" name="__codelineno-0-130" href="#__codelineno-0-130"></a>        <span class="n">rate_limit</span><span class="o">=</span><span class="mi">5000</span>
</span><span id="__span-0-131"><a id="__codelineno-0-131" name="__codelineno-0-131" href="#__codelineno-0-131"></a>    <span class="p">)</span>
</span><span id="__span-0-132"><a id="__codelineno-0-132" name="__codelineno-0-132" href="#__codelineno-0-132"></a>
</span><span id="__span-0-133"><a id="__codelineno-0-133" name="__codelineno-0-133" href="#__codelineno-0-133"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generated API Key ID: </span><span class="si">{</span><span class="n">key_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-0-134"><a id="__codelineno-0-134" name="__codelineno-0-134" href="#__codelineno-0-134"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;API Key (give to client): </span><span class="si">{</span><span class="n">actual_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-0-135"><a id="__codelineno-0-135" name="__codelineno-0-135" href="#__codelineno-0-135"></a>
</span><span id="__span-0-136"><a id="__codelineno-0-136" name="__codelineno-0-136" href="#__codelineno-0-136"></a>    <span class="c1"># Simulate API request validation</span>
</span><span id="__span-0-137"><a id="__codelineno-0-137" name="__codelineno-0-137" href="#__codelineno-0-137"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">authenticate_request</span><span class="p">(</span><span class="n">api_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="__span-0-138"><a id="__codelineno-0-138" name="__codelineno-0-138" href="#__codelineno-0-138"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Simulate API request authentication&quot;&quot;&quot;</span>
</span><span id="__span-0-139"><a id="__codelineno-0-139" name="__codelineno-0-139" href="#__codelineno-0-139"></a>        <span class="n">validated_key</span> <span class="o">=</span> <span class="n">key_manager</span><span class="o">.</span><span class="n">validate_api_key</span><span class="p">(</span><span class="n">api_key</span><span class="p">)</span>
</span><span id="__span-0-140"><a id="__codelineno-0-140" name="__codelineno-0-140" href="#__codelineno-0-140"></a>
</span><span id="__span-0-141"><a id="__codelineno-0-141" name="__codelineno-0-141" href="#__codelineno-0-141"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">validated_key</span><span class="p">:</span>
</span><span id="__span-0-142"><a id="__codelineno-0-142" name="__codelineno-0-142" href="#__codelineno-0-142"></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Invalid or expired API key&quot;</span><span class="p">,</span> <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="mi">401</span><span class="p">}</span>
</span><span id="__span-0-143"><a id="__codelineno-0-143" name="__codelineno-0-143" href="#__codelineno-0-143"></a>
</span><span id="__span-0-144"><a id="__codelineno-0-144" name="__codelineno-0-144" href="#__codelineno-0-144"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">key_manager</span><span class="o">.</span><span class="n">check_rate_limit</span><span class="p">(</span><span class="n">validated_key</span><span class="o">.</span><span class="n">key_id</span><span class="p">):</span>
</span><span id="__span-0-145"><a id="__codelineno-0-145" name="__codelineno-0-145" href="#__codelineno-0-145"></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Rate limit exceeded&quot;</span><span class="p">,</span> <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="mi">429</span><span class="p">}</span>
</span><span id="__span-0-146"><a id="__codelineno-0-146" name="__codelineno-0-146" href="#__codelineno-0-146"></a>
</span><span id="__span-0-147"><a id="__codelineno-0-147" name="__codelineno-0-147" href="#__codelineno-0-147"></a>        <span class="c1"># Track the usage</span>
</span><span id="__span-0-148"><a id="__codelineno-0-148" name="__codelineno-0-148" href="#__codelineno-0-148"></a>        <span class="n">key_manager</span><span class="o">.</span><span class="n">track_usage</span><span class="p">(</span><span class="n">validated_key</span><span class="o">.</span><span class="n">key_id</span><span class="p">,</span> <span class="s2">&quot;/api/endpoint&quot;</span><span class="p">)</span>
</span><span id="__span-0-149"><a id="__codelineno-0-149" name="__codelineno-0-149" href="#__codelineno-0-149"></a>
</span><span id="__span-0-150"><a id="__codelineno-0-150" name="__codelineno-0-150" href="#__codelineno-0-150"></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-0-151"><a id="__codelineno-0-151" name="__codelineno-0-151" href="#__codelineno-0-151"></a>            <span class="s2">&quot;authenticated&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="__span-0-152"><a id="__codelineno-0-152" name="__codelineno-0-152" href="#__codelineno-0-152"></a>            <span class="s2">&quot;key_name&quot;</span><span class="p">:</span> <span class="n">validated_key</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
</span><span id="__span-0-153"><a id="__codelineno-0-153" name="__codelineno-0-153" href="#__codelineno-0-153"></a>            <span class="s2">&quot;remaining_requests&quot;</span><span class="p">:</span> <span class="n">validated_key</span><span class="o">.</span><span class="n">rate_limit</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span>
</span><span id="__span-0-154"><a id="__codelineno-0-154" name="__codelineno-0-154" href="#__codelineno-0-154"></a>                <span class="n">key_manager</span><span class="o">.</span><span class="n">usage_tracking</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">validated_key</span><span class="o">.</span><span class="n">key_id</span><span class="p">,</span> <span class="p">[])</span>
</span><span id="__span-0-155"><a id="__codelineno-0-155" name="__codelineno-0-155" href="#__codelineno-0-155"></a>            <span class="p">)</span>
</span><span id="__span-0-156"><a id="__codelineno-0-156" name="__codelineno-0-156" href="#__codelineno-0-156"></a>        <span class="p">}</span>
</span><span id="__span-0-157"><a id="__codelineno-0-157" name="__codelineno-0-157" href="#__codelineno-0-157"></a>
</span><span id="__span-0-158"><a id="__codelineno-0-158" name="__codelineno-0-158" href="#__codelineno-0-158"></a>    <span class="c1"># Test authentication</span>
</span><span id="__span-0-159"><a id="__codelineno-0-159" name="__codelineno-0-159" href="#__codelineno-0-159"></a>    <span class="n">result</span> <span class="o">=</span> <span class="n">authenticate_request</span><span class="p">(</span><span class="n">actual_key</span><span class="p">)</span>
</span><span id="__span-0-160"><a id="__codelineno-0-160" name="__codelineno-0-160" href="#__codelineno-0-160"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Authentication result: </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-0-161"><a id="__codelineno-0-161" name="__codelineno-0-161" href="#__codelineno-0-161"></a>
</span><span id="__span-0-162"><a id="__codelineno-0-162" name="__codelineno-0-162" href="#__codelineno-0-162"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
</span><span id="__span-0-163"><a id="__codelineno-0-163" name="__codelineno-0-163" href="#__codelineno-0-163"></a>    <span class="n">api_key_authentication_example</span><span class="p">()</span>
</span></code></pre></div>
<h4 id="api-key-security-best-practices"><span class="glossary-term" data-glossary-category="Web Development" data-glossary-definition="A set of protocols and tools for building software applications, defining how components interact." data-glossary-full-form="Application Programming Interface" data-glossary-term="API">API</span> Key Security Best Practices<a class="headerlink" href="#api-key-security-best-practices" title="Permanent link">&para;</a></h4>
<div class="highlight python-template" data-fence-type="template" data-language="python">
<pre><code class="language-python"><span class="k">class</span><span class="w"> </span><span class="nc">SecureAPIKeyValidator</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Enhanced API key validation with security features&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">failed_attempts</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">blocked_ips</span><span class="p">:</span> <span class="nb">set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">validate_with_security_checks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">api_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">client_ip</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
                                    <span class="n">endpoint</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate API key with additional security checks&quot;&quot;&quot;</span>

        <span class="c1"># Check if IP is blocked</span>
        <span class="k">if</span> <span class="n">client_ip</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">blocked_ips</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;IP address blocked&quot;</span><span class="p">,</span> <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="mi">403</span><span class="p">}</span>

        <span class="c1"># Rate limiting on failed attempts</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_brute_force_attempts</span><span class="p">(</span><span class="n">client_ip</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_block_ip</span><span class="p">(</span><span class="n">client_ip</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Too many failed attempts&quot;</span><span class="p">,</span> <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="mi">429</span><span class="p">}</span>

        <span class="c1"># Validate API key</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_valid_api_key_format</span><span class="p">(</span><span class="n">api_key</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_track_failed_attempt</span><span class="p">(</span><span class="n">client_ip</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Invalid API key format&quot;</span><span class="p">,</span> <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="mi">400</span><span class="p">}</span>

        <span class="c1"># Additional timing attack protection</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>  <span class="c1"># Constant time delay</span>

        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;validated&quot;</span><span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_is_valid_api_key_format</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">api_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate API key format to prevent injection&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">api_key</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">api_key</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Check for only alphanumeric and safe characters</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^[A-Za-z0-9_-]+$&#39;</span><span class="p">,</span> <span class="n">api_key</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_track_failed_attempt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client_ip</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Track failed authentication attempts&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">client_ip</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">failed_attempts</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">failed_attempts</span><span class="p">[</span><span class="n">client_ip</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">failed_attempts</span><span class="p">[</span><span class="n">client_ip</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_check_brute_force_attempts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client_ip</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if IP has too many failed attempts&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">client_ip</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">failed_attempts</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Check last 15 minutes</span>
        <span class="n">fifteen_min_ago</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
        <span class="n">recent_failures</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">attempt</span> <span class="k">for</span> <span class="n">attempt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">failed_attempts</span><span class="p">[</span><span class="n">client_ip</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">attempt</span> <span class="o">&gt;</span> <span class="n">fifteen_min_ago</span>
        <span class="p">]</span>

        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">recent_failures</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span>  <span class="c1"># More than 10 failures in 15 minutes</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_block_ip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client_ip</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Block an IP address&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">blocked_ips</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">client_ip</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Blocked IP </span><span class="si">{</span><span class="n">client_ip</span><span class="si">}</span><span class="s2"> due to suspicious activity&quot;</span><span class="p">)</span>
</code></pre>
</div>
<h3 id="2-json-web-tokens-jwt">2. JSON Web Tokens (JWT)<a class="headerlink" href="#2-json-web-tokens-jwt" title="Permanent link">&para;</a></h3>
<p>JWTs solve many of the limitations of <strong>stateless authentication</strong> with <strong>user-specific information</strong> embedded in the token itself.<span class="glossary-term" data-glossary-category="Web Development" data-glossary-definition="A set of protocols and tools for building software applications, defining how components interact." data-glossary-full-form="Application Programming Interface" data-glossary-term="API">API</span> keys by providing </p>
<p><strong>What makes JWT better than <span class="glossary-term" data-glossary-category="Web Development" data-glossary-definition="A set of protocols and tools for building software applications, defining how components interact." data-glossary-full-form="Application Programming Interface" data-glossary-term="API">API</span> keys:</strong></p>
<ul>
<li><strong>User-specific</strong>: Each token represents a specific user, not just an application</li>
<li><strong>Time-limited</strong>: Tokens automatically expire, reducing risk if compromised</li>
<li><strong>Stateless</strong>: Servers don&rsquo;t need to store session data - everything is in the token</li>
<li><strong>Permission-based</strong>: Can include user roles and permissions within the token</li>
<li><strong>Tamper-proof</strong>: Cryptographically signed to prevent modification</li>
</ul>
<p><strong>How JWTs work:</strong></p>
<ol>
<li>User logs in with credentials</li>
<li>Server creates a JWT containing user ID, permissions, and expiration time</li>
<li>Server signs the JWT with a secret key</li>
<li>Client stores the JWT and includes it in subsequent <span class="glossary-term" data-glossary-category="Web Development" data-glossary-definition="A set of protocols and tools for building software applications, defining how components interact." data-glossary-full-form="Application Programming Interface" data-glossary-term="API">API</span> requests</li>
<li>Server validates the signature and checks expiration before processing requests</li>
</ol>
<p><strong>JWT Structure:</strong></p>
<p>A JWT has three parts separated by dots: <code>header.payload.signature</code></p>
<ul>
<li><strong>Header</strong>: <span class="glossary-term" data-glossary-category="Programming Fundamentals" data-glossary-definition="A finite sequence of well-defined instructions to solve a problem or perform a computation." data-glossary-term="Algorithm">Algorithm</span> and token type (<code>{"alg": "HS256", "typ": "JWT"}</code>)</li>
<li><strong>Payload</strong>: User data and claims (<code>{"user_id": "123", "role": "admin", "exp": 1640000000}</code>)</li>
<li><strong>Signature</strong>: Cryptographic signature to prevent tampering</li>
</ul>
<p><strong>When to use JWT:</strong></p>
<ul>
<li>Single-page applications (SPAs) that need user authentication</li>
<li>Mobile apps requiring secure <span class="glossary-term" data-glossary-category="Web Development" data-glossary-definition="A set of protocols and tools for building software applications, defining how components interact." data-glossary-full-form="Application Programming Interface" data-glossary-term="API">API</span> access</li>
<li>Microservices that need to verify user identity</li>
<li>Systems where server-side session storage is impractical</li>
</ul>
<p><strong>When NOT to use JWT:</strong></p>
<ul>
<li>When you need to revoke access immediately (tokens can&rsquo;t be invalidated until they expire)</li>
<li>For very long-lived credentials (use refresh tokens instead)</li>
<li>When the payload contains sensitive information (JWTs are encoded, not encrypted)</li>
</ul>
<h4 id="jwt-implementation">JWT Implementation<a class="headerlink" href="#jwt-implementation" title="Permanent link">&para;</a></h4>
<div class="language-python highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jwt</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a><span class="k">class</span><span class="w"> </span><span class="nc">JWTManager</span><span class="p">:</span>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Secure JWT token management&quot;&quot;&quot;</span>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a>
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">secret_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">algorithm</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;HS256&quot;</span><span class="p">):</span>
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">secret_key</span> <span class="o">=</span> <span class="n">secret_key</span>
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span> <span class="o">=</span> <span class="n">algorithm</span>
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">blacklisted_tokens</span><span class="p">:</span> <span class="nb">set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="__span-1-13"><a id="__codelineno-1-13" name="__codelineno-1-13" href="#__codelineno-1-13"></a>
</span><span id="__span-1-14"><a id="__codelineno-1-14" name="__codelineno-1-14" href="#__codelineno-1-14"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">generate_token</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">permissions</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> 
</span><span id="__span-1-15"><a id="__codelineno-1-15" name="__codelineno-1-15" href="#__codelineno-1-15"></a>                      <span class="n">expires_hours</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">24</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="__span-1-16"><a id="__codelineno-1-16" name="__codelineno-1-16" href="#__codelineno-1-16"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate a JWT token with user information and permissions&quot;&quot;&quot;</span>
</span><span id="__span-1-17"><a id="__codelineno-1-17" name="__codelineno-1-17" href="#__codelineno-1-17"></a>
</span><span id="__span-1-18"><a id="__codelineno-1-18" name="__codelineno-1-18" href="#__codelineno-1-18"></a>        <span class="c1"># Current time</span>
</span><span id="__span-1-19"><a id="__codelineno-1-19" name="__codelineno-1-19" href="#__codelineno-1-19"></a>        <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
</span><span id="__span-1-20"><a id="__codelineno-1-20" name="__codelineno-1-20" href="#__codelineno-1-20"></a>
</span><span id="__span-1-21"><a id="__codelineno-1-21" name="__codelineno-1-21" href="#__codelineno-1-21"></a>        <span class="c1"># Create payload</span>
</span><span id="__span-1-22"><a id="__codelineno-1-22" name="__codelineno-1-22" href="#__codelineno-1-22"></a>        <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-1-23"><a id="__codelineno-1-23" name="__codelineno-1-23" href="#__codelineno-1-23"></a>            <span class="s1">&#39;user_id&#39;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">,</span>
</span><span id="__span-1-24"><a id="__codelineno-1-24" name="__codelineno-1-24" href="#__codelineno-1-24"></a>            <span class="s1">&#39;permissions&#39;</span><span class="p">:</span> <span class="n">permissions</span><span class="p">,</span>
</span><span id="__span-1-25"><a id="__codelineno-1-25" name="__codelineno-1-25" href="#__codelineno-1-25"></a>            <span class="s1">&#39;iat&#39;</span><span class="p">:</span> <span class="n">now</span><span class="p">,</span>  <span class="c1"># issued at</span>
</span><span id="__span-1-26"><a id="__codelineno-1-26" name="__codelineno-1-26" href="#__codelineno-1-26"></a>            <span class="s1">&#39;exp&#39;</span><span class="p">:</span> <span class="n">now</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="n">expires_hours</span><span class="p">),</span>  <span class="c1"># expires</span>
</span><span id="__span-1-27"><a id="__codelineno-1-27" name="__codelineno-1-27" href="#__codelineno-1-27"></a>            <span class="s1">&#39;jti&#39;</span><span class="p">:</span> <span class="n">secrets</span><span class="o">.</span><span class="n">token_urlsafe</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>  <span class="c1"># unique token ID for blacklisting</span>
</span><span id="__span-1-28"><a id="__codelineno-1-28" name="__codelineno-1-28" href="#__codelineno-1-28"></a>        <span class="p">}</span>
</span><span id="__span-1-29"><a id="__codelineno-1-29" name="__codelineno-1-29" href="#__codelineno-1-29"></a>
</span><span id="__span-1-30"><a id="__codelineno-1-30" name="__codelineno-1-30" href="#__codelineno-1-30"></a>        <span class="c1"># Generate token</span>
</span><span id="__span-1-31"><a id="__codelineno-1-31" name="__codelineno-1-31" href="#__codelineno-1-31"></a>        <span class="n">token</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">secret_key</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span><span class="p">)</span>
</span><span id="__span-1-32"><a id="__codelineno-1-32" name="__codelineno-1-32" href="#__codelineno-1-32"></a>        <span class="k">return</span> <span class="n">token</span>
</span><span id="__span-1-33"><a id="__codelineno-1-33" name="__codelineno-1-33" href="#__codelineno-1-33"></a>
</span><span id="__span-1-34"><a id="__codelineno-1-34" name="__codelineno-1-34" href="#__codelineno-1-34"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">validate_token</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
</span><span id="__span-1-35"><a id="__codelineno-1-35" name="__codelineno-1-35" href="#__codelineno-1-35"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate JWT token and return payload if valid&quot;&quot;&quot;</span>
</span><span id="__span-1-36"><a id="__codelineno-1-36" name="__codelineno-1-36" href="#__codelineno-1-36"></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="__span-1-37"><a id="__codelineno-1-37" name="__codelineno-1-37" href="#__codelineno-1-37"></a>            <span class="c1"># Check if token is blacklisted</span>
</span><span id="__span-1-38"><a id="__codelineno-1-38" name="__codelineno-1-38" href="#__codelineno-1-38"></a>            <span class="k">if</span> <span class="n">token</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">blacklisted_tokens</span><span class="p">:</span>
</span><span id="__span-1-39"><a id="__codelineno-1-39" name="__codelineno-1-39" href="#__codelineno-1-39"></a>                <span class="k">return</span> <span class="kc">None</span>
</span><span id="__span-1-40"><a id="__codelineno-1-40" name="__codelineno-1-40" href="#__codelineno-1-40"></a>
</span><span id="__span-1-41"><a id="__codelineno-1-41" name="__codelineno-1-41" href="#__codelineno-1-41"></a>            <span class="c1"># Decode and validate token</span>
</span><span id="__span-1-42"><a id="__codelineno-1-42" name="__codelineno-1-42" href="#__codelineno-1-42"></a>            <span class="n">payload</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span>
</span><span id="__span-1-43"><a id="__codelineno-1-43" name="__codelineno-1-43" href="#__codelineno-1-43"></a>                <span class="n">token</span><span class="p">,</span> 
</span><span id="__span-1-44"><a id="__codelineno-1-44" name="__codelineno-1-44" href="#__codelineno-1-44"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">secret_key</span><span class="p">,</span> 
</span><span id="__span-1-45"><a id="__codelineno-1-45" name="__codelineno-1-45" href="#__codelineno-1-45"></a>                <span class="n">algorithms</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span><span class="p">]</span>
</span><span id="__span-1-46"><a id="__codelineno-1-46" name="__codelineno-1-46" href="#__codelineno-1-46"></a>            <span class="p">)</span>
</span><span id="__span-1-47"><a id="__codelineno-1-47" name="__codelineno-1-47" href="#__codelineno-1-47"></a>
</span><span id="__span-1-48"><a id="__codelineno-1-48" name="__codelineno-1-48" href="#__codelineno-1-48"></a>            <span class="k">return</span> <span class="n">payload</span>
</span><span id="__span-1-49"><a id="__codelineno-1-49" name="__codelineno-1-49" href="#__codelineno-1-49"></a>
</span><span id="__span-1-50"><a id="__codelineno-1-50" name="__codelineno-1-50" href="#__codelineno-1-50"></a>        <span class="k">except</span> <span class="n">jwt</span><span class="o">.</span><span class="n">ExpiredSignatureError</span><span class="p">:</span>
</span><span id="__span-1-51"><a id="__codelineno-1-51" name="__codelineno-1-51" href="#__codelineno-1-51"></a>            <span class="k">return</span> <span class="kc">None</span>  <span class="c1"># Token has expired</span>
</span><span id="__span-1-52"><a id="__codelineno-1-52" name="__codelineno-1-52" href="#__codelineno-1-52"></a>        <span class="k">except</span> <span class="n">jwt</span><span class="o">.</span><span class="n">InvalidTokenError</span><span class="p">:</span>
</span><span id="__span-1-53"><a id="__codelineno-1-53" name="__codelineno-1-53" href="#__codelineno-1-53"></a>            <span class="k">return</span> <span class="kc">None</span>  <span class="c1"># Token is invalid</span>
</span><span id="__span-1-54"><a id="__codelineno-1-54" name="__codelineno-1-54" href="#__codelineno-1-54"></a>
</span><span id="__span-1-55"><a id="__codelineno-1-55" name="__codelineno-1-55" href="#__codelineno-1-55"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">revoke_token</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="__span-1-56"><a id="__codelineno-1-56" name="__codelineno-1-56" href="#__codelineno-1-56"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Add token to blacklist (logout functionality)&quot;&quot;&quot;</span>
</span><span id="__span-1-57"><a id="__codelineno-1-57" name="__codelineno-1-57" href="#__codelineno-1-57"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">blacklisted_tokens</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
</span><span id="__span-1-58"><a id="__codelineno-1-58" name="__codelineno-1-58" href="#__codelineno-1-58"></a>
</span><span id="__span-1-59"><a id="__codelineno-1-59" name="__codelineno-1-59" href="#__codelineno-1-59"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">refresh_token</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">old_token</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
</span><span id="__span-1-60"><a id="__codelineno-1-60" name="__codelineno-1-60" href="#__codelineno-1-60"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate a new token from a valid existing token&quot;&quot;&quot;</span>
</span><span id="__span-1-61"><a id="__codelineno-1-61" name="__codelineno-1-61" href="#__codelineno-1-61"></a>        <span class="n">payload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_token</span><span class="p">(</span><span class="n">old_token</span><span class="p">)</span>
</span><span id="__span-1-62"><a id="__codelineno-1-62" name="__codelineno-1-62" href="#__codelineno-1-62"></a>
</span><span id="__span-1-63"><a id="__codelineno-1-63" name="__codelineno-1-63" href="#__codelineno-1-63"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">payload</span><span class="p">:</span>
</span><span id="__span-1-64"><a id="__codelineno-1-64" name="__codelineno-1-64" href="#__codelineno-1-64"></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="__span-1-65"><a id="__codelineno-1-65" name="__codelineno-1-65" href="#__codelineno-1-65"></a>
</span><span id="__span-1-66"><a id="__codelineno-1-66" name="__codelineno-1-66" href="#__codelineno-1-66"></a>        <span class="c1"># Revoke old token</span>
</span><span id="__span-1-67"><a id="__codelineno-1-67" name="__codelineno-1-67" href="#__codelineno-1-67"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">revoke_token</span><span class="p">(</span><span class="n">old_token</span><span class="p">)</span>
</span><span id="__span-1-68"><a id="__codelineno-1-68" name="__codelineno-1-68" href="#__codelineno-1-68"></a>
</span><span id="__span-1-69"><a id="__codelineno-1-69" name="__codelineno-1-69" href="#__codelineno-1-69"></a>        <span class="c1"># Generate new token with same permissions</span>
</span><span id="__span-1-70"><a id="__codelineno-1-70" name="__codelineno-1-70" href="#__codelineno-1-70"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_token</span><span class="p">(</span>
</span><span id="__span-1-71"><a id="__codelineno-1-71" name="__codelineno-1-71" href="#__codelineno-1-71"></a>            <span class="n">user_id</span><span class="o">=</span><span class="n">payload</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">],</span>
</span><span id="__span-1-72"><a id="__codelineno-1-72" name="__codelineno-1-72" href="#__codelineno-1-72"></a>            <span class="n">permissions</span><span class="o">=</span><span class="n">payload</span><span class="p">[</span><span class="s1">&#39;permissions&#39;</span><span class="p">]</span>
</span><span id="__span-1-73"><a id="__codelineno-1-73" name="__codelineno-1-73" href="#__codelineno-1-73"></a>        <span class="p">)</span>
</span><span id="__span-1-74"><a id="__codelineno-1-74" name="__codelineno-1-74" href="#__codelineno-1-74"></a>
</span><span id="__span-1-75"><a id="__codelineno-1-75" name="__codelineno-1-75" href="#__codelineno-1-75"></a><span class="c1"># JWT-based API authentication decorator</span>
</span><span id="__span-1-76"><a id="__codelineno-1-76" name="__codelineno-1-76" href="#__codelineno-1-76"></a><span class="k">def</span><span class="w"> </span><span class="nf">jwt_required</span><span class="p">(</span><span class="n">permissions_required</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="__span-1-77"><a id="__codelineno-1-77" name="__codelineno-1-77" href="#__codelineno-1-77"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Decorator for protecting API endpoints with JWT&quot;&quot;&quot;</span>
</span><span id="__span-1-78"><a id="__codelineno-1-78" name="__codelineno-1-78" href="#__codelineno-1-78"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">decorator</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
</span><span id="__span-1-79"><a id="__codelineno-1-79" name="__codelineno-1-79" href="#__codelineno-1-79"></a>        <span class="k">def</span><span class="w"> </span><span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="__span-1-80"><a id="__codelineno-1-80" name="__codelineno-1-80" href="#__codelineno-1-80"></a>            <span class="c1"># In a real Flask/FastAPI app, you&#39;d get this from request headers</span>
</span><span id="__span-1-81"><a id="__codelineno-1-81" name="__codelineno-1-81" href="#__codelineno-1-81"></a>            <span class="c1"># For demo purposes, we&#39;ll simulate it</span>
</span><span id="__span-1-82"><a id="__codelineno-1-82" name="__codelineno-1-82" href="#__codelineno-1-82"></a>            <span class="n">token</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;jwt_token&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
</span><span id="__span-1-83"><a id="__codelineno-1-83" name="__codelineno-1-83" href="#__codelineno-1-83"></a>
</span><span id="__span-1-84"><a id="__codelineno-1-84" name="__codelineno-1-84" href="#__codelineno-1-84"></a>            <span class="n">jwt_manager</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;jwt_manager&#39;</span><span class="p">)</span>
</span><span id="__span-1-85"><a id="__codelineno-1-85" name="__codelineno-1-85" href="#__codelineno-1-85"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">jwt_manager</span><span class="p">:</span>
</span><span id="__span-1-86"><a id="__codelineno-1-86" name="__codelineno-1-86" href="#__codelineno-1-86"></a>                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;JWT manager not configured&quot;</span><span class="p">,</span> <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="mi">500</span><span class="p">}</span>
</span><span id="__span-1-87"><a id="__codelineno-1-87" name="__codelineno-1-87" href="#__codelineno-1-87"></a>
</span><span id="__span-1-88"><a id="__codelineno-1-88" name="__codelineno-1-88" href="#__codelineno-1-88"></a>            <span class="c1"># Validate token</span>
</span><span id="__span-1-89"><a id="__codelineno-1-89" name="__codelineno-1-89" href="#__codelineno-1-89"></a>            <span class="n">payload</span> <span class="o">=</span> <span class="n">jwt_manager</span><span class="o">.</span><span class="n">validate_token</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
</span><span id="__span-1-90"><a id="__codelineno-1-90" name="__codelineno-1-90" href="#__codelineno-1-90"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">payload</span><span class="p">:</span>
</span><span id="__span-1-91"><a id="__codelineno-1-91" name="__codelineno-1-91" href="#__codelineno-1-91"></a>                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Invalid or expired token&quot;</span><span class="p">,</span> <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="mi">401</span><span class="p">}</span>
</span><span id="__span-1-92"><a id="__codelineno-1-92" name="__codelineno-1-92" href="#__codelineno-1-92"></a>
</span><span id="__span-1-93"><a id="__codelineno-1-93" name="__codelineno-1-93" href="#__codelineno-1-93"></a>            <span class="c1"># Check permissions</span>
</span><span id="__span-1-94"><a id="__codelineno-1-94" name="__codelineno-1-94" href="#__codelineno-1-94"></a>            <span class="k">if</span> <span class="n">permissions_required</span><span class="p">:</span>
</span><span id="__span-1-95"><a id="__codelineno-1-95" name="__codelineno-1-95" href="#__codelineno-1-95"></a>                <span class="n">user_permissions</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;permissions&#39;</span><span class="p">,</span> <span class="p">[])</span>
</span><span id="__span-1-96"><a id="__codelineno-1-96" name="__codelineno-1-96" href="#__codelineno-1-96"></a>                <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">perm</span> <span class="ow">in</span> <span class="n">user_permissions</span> <span class="k">for</span> <span class="n">perm</span> <span class="ow">in</span> <span class="n">permissions_required</span><span class="p">):</span>
</span><span id="__span-1-97"><a id="__codelineno-1-97" name="__codelineno-1-97" href="#__codelineno-1-97"></a>                    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Insufficient permissions&quot;</span><span class="p">,</span> <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="mi">403</span><span class="p">}</span>
</span><span id="__span-1-98"><a id="__codelineno-1-98" name="__codelineno-1-98" href="#__codelineno-1-98"></a>
</span><span id="__span-1-99"><a id="__codelineno-1-99" name="__codelineno-1-99" href="#__codelineno-1-99"></a>            <span class="c1"># Add user info to function call</span>
</span><span id="__span-1-100"><a id="__codelineno-1-100" name="__codelineno-1-100" href="#__codelineno-1-100"></a>            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;current_user&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">payload</span>
</span><span id="__span-1-101"><a id="__codelineno-1-101" name="__codelineno-1-101" href="#__codelineno-1-101"></a>            <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="__span-1-102"><a id="__codelineno-1-102" name="__codelineno-1-102" href="#__codelineno-1-102"></a>
</span><span id="__span-1-103"><a id="__codelineno-1-103" name="__codelineno-1-103" href="#__codelineno-1-103"></a>        <span class="k">return</span> <span class="n">wrapper</span>
</span><span id="__span-1-104"><a id="__codelineno-1-104" name="__codelineno-1-104" href="#__codelineno-1-104"></a>    <span class="k">return</span> <span class="n">decorator</span>
</span><span id="__span-1-105"><a id="__codelineno-1-105" name="__codelineno-1-105" href="#__codelineno-1-105"></a>
</span><span id="__span-1-106"><a id="__codelineno-1-106" name="__codelineno-1-106" href="#__codelineno-1-106"></a><span class="c1"># Example protected API endpoints</span>
</span><span id="__span-1-107"><a id="__codelineno-1-107" name="__codelineno-1-107" href="#__codelineno-1-107"></a><span class="k">class</span><span class="w"> </span><span class="nc">SecureAPI</span><span class="p">:</span>
</span><span id="__span-1-108"><a id="__codelineno-1-108" name="__codelineno-1-108" href="#__codelineno-1-108"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Example API with JWT protection&quot;&quot;&quot;</span>
</span><span id="__span-1-109"><a id="__codelineno-1-109" name="__codelineno-1-109" href="#__codelineno-1-109"></a>
</span><span id="__span-1-110"><a id="__codelineno-1-110" name="__codelineno-1-110" href="#__codelineno-1-110"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jwt_manager</span><span class="p">:</span> <span class="n">JWTManager</span><span class="p">):</span>
</span><span id="__span-1-111"><a id="__codelineno-1-111" name="__codelineno-1-111" href="#__codelineno-1-111"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">jwt_manager</span> <span class="o">=</span> <span class="n">jwt_manager</span>
</span><span id="__span-1-112"><a id="__codelineno-1-112" name="__codelineno-1-112" href="#__codelineno-1-112"></a>
</span><span id="__span-1-113"><a id="__codelineno-1-113" name="__codelineno-1-113" href="#__codelineno-1-113"></a>    <span class="nd">@jwt_required</span><span class="p">([</span><span class="s1">&#39;read_users&#39;</span><span class="p">])</span>
</span><span id="__span-1-114"><a id="__codelineno-1-114" name="__codelineno-1-114" href="#__codelineno-1-114"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_users</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jwt_token</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">jwt_manager</span><span class="p">:</span> <span class="n">JWTManager</span><span class="p">,</span> <span class="n">current_user</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
</span><span id="__span-1-115"><a id="__codelineno-1-115" name="__codelineno-1-115" href="#__codelineno-1-115"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Protected endpoint requiring &#39;read_users&#39; permission&quot;&quot;&quot;</span>
</span><span id="__span-1-116"><a id="__codelineno-1-116" name="__codelineno-1-116" href="#__codelineno-1-116"></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-1-117"><a id="__codelineno-1-117" name="__codelineno-1-117" href="#__codelineno-1-117"></a>            <span class="s2">&quot;users&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;user1&quot;</span><span class="p">,</span> <span class="s2">&quot;user2&quot;</span><span class="p">,</span> <span class="s2">&quot;user3&quot;</span><span class="p">],</span>
</span><span id="__span-1-118"><a id="__codelineno-1-118" name="__codelineno-1-118" href="#__codelineno-1-118"></a>            <span class="s2">&quot;accessed_by&quot;</span><span class="p">:</span> <span class="n">current_user</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]</span>
</span><span id="__span-1-119"><a id="__codelineno-1-119" name="__codelineno-1-119" href="#__codelineno-1-119"></a>        <span class="p">}</span>
</span><span id="__span-1-120"><a id="__codelineno-1-120" name="__codelineno-1-120" href="#__codelineno-1-120"></a>
</span><span id="__span-1-121"><a id="__codelineno-1-121" name="__codelineno-1-121" href="#__codelineno-1-121"></a>    <span class="nd">@jwt_required</span><span class="p">([</span><span class="s1">&#39;admin&#39;</span><span class="p">])</span>
</span><span id="__span-1-122"><a id="__codelineno-1-122" name="__codelineno-1-122" href="#__codelineno-1-122"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">delete_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">jwt_token</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
</span><span id="__span-1-123"><a id="__codelineno-1-123" name="__codelineno-1-123" href="#__codelineno-1-123"></a>                   <span class="n">jwt_manager</span><span class="p">:</span> <span class="n">JWTManager</span><span class="p">,</span> <span class="n">current_user</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
</span><span id="__span-1-124"><a id="__codelineno-1-124" name="__codelineno-1-124" href="#__codelineno-1-124"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Protected endpoint requiring &#39;admin&#39; permission&quot;&quot;&quot;</span>
</span><span id="__span-1-125"><a id="__codelineno-1-125" name="__codelineno-1-125" href="#__codelineno-1-125"></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-1-126"><a id="__codelineno-1-126" name="__codelineno-1-126" href="#__codelineno-1-126"></a>            <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;User </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2"> deleted&quot;</span><span class="p">,</span>
</span><span id="__span-1-127"><a id="__codelineno-1-127" name="__codelineno-1-127" href="#__codelineno-1-127"></a>            <span class="s2">&quot;deleted_by&quot;</span><span class="p">:</span> <span class="n">current_user</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]</span>
</span><span id="__span-1-128"><a id="__codelineno-1-128" name="__codelineno-1-128" href="#__codelineno-1-128"></a>        <span class="p">}</span>
</span><span id="__span-1-129"><a id="__codelineno-1-129" name="__codelineno-1-129" href="#__codelineno-1-129"></a>
</span><span id="__span-1-130"><a id="__codelineno-1-130" name="__codelineno-1-130" href="#__codelineno-1-130"></a><span class="k">def</span><span class="w"> </span><span class="nf">jwt_authentication_example</span><span class="p">():</span>
</span><span id="__span-1-131"><a id="__codelineno-1-131" name="__codelineno-1-131" href="#__codelineno-1-131"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Demonstrate JWT authentication&quot;&quot;&quot;</span>
</span><span id="__span-1-132"><a id="__codelineno-1-132" name="__codelineno-1-132" href="#__codelineno-1-132"></a>
</span><span id="__span-1-133"><a id="__codelineno-1-133" name="__codelineno-1-133" href="#__codelineno-1-133"></a>    <span class="c1"># Initialize JWT manager</span>
</span><span id="__span-1-134"><a id="__codelineno-1-134" name="__codelineno-1-134" href="#__codelineno-1-134"></a>    <span class="n">jwt_manager</span> <span class="o">=</span> <span class="n">JWTManager</span><span class="p">(</span><span class="n">secret_key</span><span class="o">=</span><span class="s2">&quot;your-secret-key-keep-this-secure&quot;</span><span class="p">)</span>
</span><span id="__span-1-135"><a id="__codelineno-1-135" name="__codelineno-1-135" href="#__codelineno-1-135"></a>
</span><span id="__span-1-136"><a id="__codelineno-1-136" name="__codelineno-1-136" href="#__codelineno-1-136"></a>    <span class="c1"># Generate token for a user</span>
</span><span id="__span-1-137"><a id="__codelineno-1-137" name="__codelineno-1-137" href="#__codelineno-1-137"></a>    <span class="n">token</span> <span class="o">=</span> <span class="n">jwt_manager</span><span class="o">.</span><span class="n">generate_token</span><span class="p">(</span>
</span><span id="__span-1-138"><a id="__codelineno-1-138" name="__codelineno-1-138" href="#__codelineno-1-138"></a>        <span class="n">user_id</span><span class="o">=</span><span class="s2">&quot;user123&quot;</span><span class="p">,</span>
</span><span id="__span-1-139"><a id="__codelineno-1-139" name="__codelineno-1-139" href="#__codelineno-1-139"></a>        <span class="n">permissions</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;read_users&quot;</span><span class="p">,</span> <span class="s2">&quot;write_posts&quot;</span><span class="p">]</span>
</span><span id="__span-1-140"><a id="__codelineno-1-140" name="__codelineno-1-140" href="#__codelineno-1-140"></a>    <span class="p">)</span>
</span><span id="__span-1-141"><a id="__codelineno-1-141" name="__codelineno-1-141" href="#__codelineno-1-141"></a>
</span><span id="__span-1-142"><a id="__codelineno-1-142" name="__codelineno-1-142" href="#__codelineno-1-142"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generated JWT: </span><span class="si">{</span><span class="n">token</span><span class="p">[:</span><span class="mi">50</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
</span><span id="__span-1-143"><a id="__codelineno-1-143" name="__codelineno-1-143" href="#__codelineno-1-143"></a>
</span><span id="__span-1-144"><a id="__codelineno-1-144" name="__codelineno-1-144" href="#__codelineno-1-144"></a>    <span class="c1"># Validate token</span>
</span><span id="__span-1-145"><a id="__codelineno-1-145" name="__codelineno-1-145" href="#__codelineno-1-145"></a>    <span class="n">payload</span> <span class="o">=</span> <span class="n">jwt_manager</span><span class="o">.</span><span class="n">validate_token</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
</span><span id="__span-1-146"><a id="__codelineno-1-146" name="__codelineno-1-146" href="#__codelineno-1-146"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Token payload: </span><span class="si">{</span><span class="n">payload</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-1-147"><a id="__codelineno-1-147" name="__codelineno-1-147" href="#__codelineno-1-147"></a>
</span><span id="__span-1-148"><a id="__codelineno-1-148" name="__codelineno-1-148" href="#__codelineno-1-148"></a>    <span class="c1"># Test API access</span>
</span><span id="__span-1-149"><a id="__codelineno-1-149" name="__codelineno-1-149" href="#__codelineno-1-149"></a>    <span class="n">api</span> <span class="o">=</span> <span class="n">SecureAPI</span><span class="p">(</span><span class="n">jwt_manager</span><span class="p">)</span>
</span><span id="__span-1-150"><a id="__codelineno-1-150" name="__codelineno-1-150" href="#__codelineno-1-150"></a>
</span><span id="__span-1-151"><a id="__codelineno-1-151" name="__codelineno-1-151" href="#__codelineno-1-151"></a>    <span class="c1"># This should work (user has &#39;read_users&#39; permission)</span>
</span><span id="__span-1-152"><a id="__codelineno-1-152" name="__codelineno-1-152" href="#__codelineno-1-152"></a>    <span class="n">result</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_users</span><span class="p">(</span><span class="n">jwt_token</span><span class="o">=</span><span class="n">token</span><span class="p">,</span> <span class="n">jwt_manager</span><span class="o">=</span><span class="n">jwt_manager</span><span class="p">)</span>
</span><span id="__span-1-153"><a id="__codelineno-1-153" name="__codelineno-1-153" href="#__codelineno-1-153"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;API result: </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-1-154"><a id="__codelineno-1-154" name="__codelineno-1-154" href="#__codelineno-1-154"></a>
</span><span id="__span-1-155"><a id="__codelineno-1-155" name="__codelineno-1-155" href="#__codelineno-1-155"></a>    <span class="c1"># This should fail (user doesn&#39;t have &#39;admin&#39; permission)</span>
</span><span id="__span-1-156"><a id="__codelineno-1-156" name="__codelineno-1-156" href="#__codelineno-1-156"></a>    <span class="n">result</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">delete_user</span><span class="p">(</span><span class="s2">&quot;user456&quot;</span><span class="p">,</span> <span class="n">jwt_token</span><span class="o">=</span><span class="n">token</span><span class="p">,</span> <span class="n">jwt_manager</span><span class="o">=</span><span class="n">jwt_manager</span><span class="p">)</span>
</span><span id="__span-1-157"><a id="__codelineno-1-157" name="__codelineno-1-157" href="#__codelineno-1-157"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Admin action result: </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-1-158"><a id="__codelineno-1-158" name="__codelineno-1-158" href="#__codelineno-1-158"></a>
</span><span id="__span-1-159"><a id="__codelineno-1-159" name="__codelineno-1-159" href="#__codelineno-1-159"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
</span><span id="__span-1-160"><a id="__codelineno-1-160" name="__codelineno-1-160" href="#__codelineno-1-160"></a>    <span class="n">jwt_authentication_example</span><span class="p">()</span>
</span></code></pre></div>
<h3 id="3-oauth-20-delegated-authorization">3. OAuth 2.0 - Delegated Authorization<a class="headerlink" href="#3-oauth-20-delegated-authorization" title="Permanent link">&para;</a></h3>
<p>OAuth 2.0 solves a different problem than <strong>How do I let a third-party application access my account without giving them my password?</strong><span class="glossary-term" data-glossary-category="Web Development" data-glossary-definition="A set of protocols and tools for building software applications, defining how components interact." data-glossary-full-form="Application Programming Interface" data-glossary-term="API">API</span> keys or JWT: </p>
<p><strong>The problem OAuth solves:</strong></p>
<p>Imagine you want to let a photo printing service access your Google Photos. You could give them your Google password, but that&rsquo;s dangerous:</p>
<ul>
<li>They&rsquo;d have access to everything (email, documents, calendar)</li>
<li>You&rsquo;d have to change your password if you stop using the service</li>
<li>They could misuse your credentials</li>
<li>You can&rsquo;t limit what they access</li>
</ul>
<p>OAuth provides a solution: <strong>delegated authorization with limited scope</strong>.</p>
<p><strong>How OAuth 2.0 works (simplified):</strong></p>
<ol>
<li><strong>Your app</strong> wants to access a user&rsquo;s data on <strong>their service</strong> (e.g., Google)</li>
<li><strong>Your app</strong> redirects the user to <strong>their service&rsquo;s</strong> authorization page</li>
<li><strong>User</strong> approves your app&rsquo;s request (with specific permissions/scopes)</li>
<li><strong>Their service</strong> gives your app a temporary authorization code</li>
<li><strong>Your app</strong> exchanges the code for an access token</li>
<li><strong>Your app</strong> uses the access token to make <span class="glossary-term" data-glossary-category="Web Development" data-glossary-definition="A set of protocols and tools for building software applications, defining how components interact." data-glossary-full-form="Application Programming Interface" data-glossary-term="API">API</span> requests on the user&rsquo;s behalf</li>
</ol>
<p><strong>Key OAuth 2.0 concepts:</strong></p>
<ul>
<li><strong>Scopes</strong>: Limited permissions (e.g., &ldquo;read emails&rdquo; vs &ldquo;full account access&rdquo;)</li>
<li><strong>Authorization code</strong>: Temporary code exchanged for an access token</li>
<li><strong>Access token</strong>: The credential used to make <span class="glossary-term" data-glossary-category="Web Development" data-glossary-definition="A set of protocols and tools for building software applications, defining how components interact." data-glossary-full-form="Application Programming Interface" data-glossary-term="API">API</span> requests</li>
<li><strong>Refresh token</strong>: Long-lived token used to get new access tokens</li>
<li><strong>Resource owner</strong>: The user who owns the data</li>
<li><strong>Client</strong>: Your application requesting access</li>
<li><strong>Authorization server</strong>: The service that authenticates the user and issues tokens</li>
</ul>
<p><strong>Real-world examples:</strong></p>
<ul>
<li>&ldquo;Login with Google&rdquo; on websites</li>
<li>Mobile apps accessing your Facebook photos</li>
<li>Third-party email clients accessing Gmail</li>
<li>Fitness apps syncing with Apple Health</li>
</ul>
<p><strong>When to use OAuth 2.0:</strong></p>
<ul>
<li>Building &ldquo;Login with&hellip;&rdquo; features</li>
<li>Third-party integrations with user accounts</li>
<li>Mobile/web apps that need limited access to user data</li>
<li>Any scenario where you need delegated authorization</li>
</ul>
<p><strong>When NOT to use OAuth 2.0:</strong></p>
<ul>
<li>First-party authentication (your own users logging into your own app - use JWT)</li>
<li>Server-to-server communication (use <span class="glossary-term" data-glossary-category="Web Development" data-glossary-definition="A set of protocols and tools for building software applications, defining how components interact." data-glossary-full-form="Application Programming Interface" data-glossary-term="API">API</span> keys or mTLS)</li>
<li>Simple authentication without third-party access needs</li>
</ul>
<h4 id="oauth-20-flow-implementation">OAuth 2.0 Flow Implementation<a class="headerlink" href="#oauth-20-flow-implementation" title="Permanent link">&para;</a></h4>
<div class="language-python highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">urllib.parse</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Optional</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="k">class</span><span class="w"> </span><span class="nc">OAuth2Manager</span><span class="p">:</span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;OAuth 2.0 authorization server implementation&quot;&quot;&quot;</span>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a>
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">client_secret</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a>                 <span class="n">authorization_base_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">token_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">client_id</span> <span class="o">=</span> <span class="n">client_id</span>
</span><span id="__span-2-11"><a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">client_secret</span> <span class="o">=</span> <span class="n">client_secret</span>
</span><span id="__span-2-12"><a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">authorization_base_url</span> <span class="o">=</span> <span class="n">authorization_base_url</span>
</span><span id="__span-2-13"><a id="__codelineno-2-13" name="__codelineno-2-13" href="#__codelineno-2-13"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">token_url</span> <span class="o">=</span> <span class="n">token_url</span>
</span><span id="__span-2-14"><a id="__codelineno-2-14" name="__codelineno-2-14" href="#__codelineno-2-14"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">authorization_codes</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="__span-2-15"><a id="__codelineno-2-15" name="__codelineno-2-15" href="#__codelineno-2-15"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">access_tokens</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="__span-2-16"><a id="__codelineno-2-16" name="__codelineno-2-16" href="#__codelineno-2-16"></a>
</span><span id="__span-2-17"><a id="__codelineno-2-17" name="__codelineno-2-17" href="#__codelineno-2-17"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">generate_authorization_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">redirect_uri</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
</span><span id="__span-2-18"><a id="__codelineno-2-18" name="__codelineno-2-18" href="#__codelineno-2-18"></a>                                 <span class="n">scope</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="__span-2-19"><a id="__codelineno-2-19" name="__codelineno-2-19" href="#__codelineno-2-19"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate OAuth authorization URL&quot;&quot;&quot;</span>
</span><span id="__span-2-20"><a id="__codelineno-2-20" name="__codelineno-2-20" href="#__codelineno-2-20"></a>
</span><span id="__span-2-21"><a id="__codelineno-2-21" name="__codelineno-2-21" href="#__codelineno-2-21"></a>        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-2-22"><a id="__codelineno-2-22" name="__codelineno-2-22" href="#__codelineno-2-22"></a>            <span class="s1">&#39;response_type&#39;</span><span class="p">:</span> <span class="s1">&#39;code&#39;</span><span class="p">,</span>
</span><span id="__span-2-23"><a id="__codelineno-2-23" name="__codelineno-2-23" href="#__codelineno-2-23"></a>            <span class="s1">&#39;client_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_id</span><span class="p">,</span>
</span><span id="__span-2-24"><a id="__codelineno-2-24" name="__codelineno-2-24" href="#__codelineno-2-24"></a>            <span class="s1">&#39;redirect_uri&#39;</span><span class="p">:</span> <span class="n">redirect_uri</span><span class="p">,</span>
</span><span id="__span-2-25"><a id="__codelineno-2-25" name="__codelineno-2-25" href="#__codelineno-2-25"></a>            <span class="s1">&#39;scope&#39;</span><span class="p">:</span> <span class="n">scope</span><span class="p">,</span>
</span><span id="__span-2-26"><a id="__codelineno-2-26" name="__codelineno-2-26" href="#__codelineno-2-26"></a>            <span class="s1">&#39;state&#39;</span><span class="p">:</span> <span class="n">state</span> <span class="ow">or</span> <span class="n">secrets</span><span class="o">.</span><span class="n">token_urlsafe</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
</span><span id="__span-2-27"><a id="__codelineno-2-27" name="__codelineno-2-27" href="#__codelineno-2-27"></a>        <span class="p">}</span>
</span><span id="__span-2-28"><a id="__codelineno-2-28" name="__codelineno-2-28" href="#__codelineno-2-28"></a>
</span><span id="__span-2-29"><a id="__codelineno-2-29" name="__codelineno-2-29" href="#__codelineno-2-29"></a>        <span class="c1"># Build authorization URL</span>
</span><span id="__span-2-30"><a id="__codelineno-2-30" name="__codelineno-2-30" href="#__codelineno-2-30"></a>        <span class="n">authorization_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">authorization_base_url</span><span class="si">}</span><span class="s2">?</span><span class="si">{</span><span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">urlencode</span><span class="p">(</span><span class="n">params</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="__span-2-31"><a id="__codelineno-2-31" name="__codelineno-2-31" href="#__codelineno-2-31"></a>        <span class="k">return</span> <span class="n">authorization_url</span>
</span><span id="__span-2-32"><a id="__codelineno-2-32" name="__codelineno-2-32" href="#__codelineno-2-32"></a>
</span><span id="__span-2-33"><a id="__codelineno-2-33" name="__codelineno-2-33" href="#__codelineno-2-33"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">exchange_code_for_token</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">authorization_code</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
</span><span id="__span-2-34"><a id="__codelineno-2-34" name="__codelineno-2-34" href="#__codelineno-2-34"></a>                              <span class="n">redirect_uri</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
</span><span id="__span-2-35"><a id="__codelineno-2-35" name="__codelineno-2-35" href="#__codelineno-2-35"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Exchange authorization code for access token&quot;&quot;&quot;</span>
</span><span id="__span-2-36"><a id="__codelineno-2-36" name="__codelineno-2-36" href="#__codelineno-2-36"></a>
</span><span id="__span-2-37"><a id="__codelineno-2-37" name="__codelineno-2-37" href="#__codelineno-2-37"></a>        <span class="c1"># Validate authorization code</span>
</span><span id="__span-2-38"><a id="__codelineno-2-38" name="__codelineno-2-38" href="#__codelineno-2-38"></a>        <span class="k">if</span> <span class="n">authorization_code</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">authorization_codes</span><span class="p">:</span>
</span><span id="__span-2-39"><a id="__codelineno-2-39" name="__codelineno-2-39" href="#__codelineno-2-39"></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="__span-2-40"><a id="__codelineno-2-40" name="__codelineno-2-40" href="#__codelineno-2-40"></a>
</span><span id="__span-2-41"><a id="__codelineno-2-41" name="__codelineno-2-41" href="#__codelineno-2-41"></a>        <span class="n">code_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">authorization_codes</span><span class="p">[</span><span class="n">authorization_code</span><span class="p">]</span>
</span><span id="__span-2-42"><a id="__codelineno-2-42" name="__codelineno-2-42" href="#__codelineno-2-42"></a>
</span><span id="__span-2-43"><a id="__codelineno-2-43" name="__codelineno-2-43" href="#__codelineno-2-43"></a>        <span class="c1"># Check if code has expired (typically 10 minutes)</span>
</span><span id="__span-2-44"><a id="__codelineno-2-44" name="__codelineno-2-44" href="#__codelineno-2-44"></a>        <span class="k">if</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">code_data</span><span class="p">[</span><span class="s1">&#39;expires_at&#39;</span><span class="p">]:</span>
</span><span id="__span-2-45"><a id="__codelineno-2-45" name="__codelineno-2-45" href="#__codelineno-2-45"></a>            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">authorization_codes</span><span class="p">[</span><span class="n">authorization_code</span><span class="p">]</span>
</span><span id="__span-2-46"><a id="__codelineno-2-46" name="__codelineno-2-46" href="#__codelineno-2-46"></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="__span-2-47"><a id="__codelineno-2-47" name="__codelineno-2-47" href="#__codelineno-2-47"></a>
</span><span id="__span-2-48"><a id="__codelineno-2-48" name="__codelineno-2-48" href="#__codelineno-2-48"></a>        <span class="c1"># Generate access token</span>
</span><span id="__span-2-49"><a id="__codelineno-2-49" name="__codelineno-2-49" href="#__codelineno-2-49"></a>        <span class="n">access_token</span> <span class="o">=</span> <span class="n">secrets</span><span class="o">.</span><span class="n">token_urlsafe</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>
</span><span id="__span-2-50"><a id="__codelineno-2-50" name="__codelineno-2-50" href="#__codelineno-2-50"></a>        <span class="n">refresh_token</span> <span class="o">=</span> <span class="n">secrets</span><span class="o">.</span><span class="n">token_urlsafe</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>
</span><span id="__span-2-51"><a id="__codelineno-2-51" name="__codelineno-2-51" href="#__codelineno-2-51"></a>
</span><span id="__span-2-52"><a id="__codelineno-2-52" name="__codelineno-2-52" href="#__codelineno-2-52"></a>        <span class="n">token_data</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-2-53"><a id="__codelineno-2-53" name="__codelineno-2-53" href="#__codelineno-2-53"></a>            <span class="s1">&#39;access_token&#39;</span><span class="p">:</span> <span class="n">access_token</span><span class="p">,</span>
</span><span id="__span-2-54"><a id="__codelineno-2-54" name="__codelineno-2-54" href="#__codelineno-2-54"></a>            <span class="s1">&#39;refresh_token&#39;</span><span class="p">:</span> <span class="n">refresh_token</span><span class="p">,</span>
</span><span id="__span-2-55"><a id="__codelineno-2-55" name="__codelineno-2-55" href="#__codelineno-2-55"></a>            <span class="s1">&#39;token_type&#39;</span><span class="p">:</span> <span class="s1">&#39;Bearer&#39;</span><span class="p">,</span>
</span><span id="__span-2-56"><a id="__codelineno-2-56" name="__codelineno-2-56" href="#__codelineno-2-56"></a>            <span class="s1">&#39;expires_in&#39;</span><span class="p">:</span> <span class="mi">3600</span><span class="p">,</span>  <span class="c1"># 1 hour</span>
</span><span id="__span-2-57"><a id="__codelineno-2-57" name="__codelineno-2-57" href="#__codelineno-2-57"></a>            <span class="s1">&#39;scope&#39;</span><span class="p">:</span> <span class="n">code_data</span><span class="p">[</span><span class="s1">&#39;scope&#39;</span><span class="p">],</span>
</span><span id="__span-2-58"><a id="__codelineno-2-58" name="__codelineno-2-58" href="#__codelineno-2-58"></a>            <span class="s1">&#39;user_id&#39;</span><span class="p">:</span> <span class="n">code_data</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">],</span>
</span><span id="__span-2-59"><a id="__codelineno-2-59" name="__codelineno-2-59" href="#__codelineno-2-59"></a>            <span class="s1">&#39;created_at&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
</span><span id="__span-2-60"><a id="__codelineno-2-60" name="__codelineno-2-60" href="#__codelineno-2-60"></a>        <span class="p">}</span>
</span><span id="__span-2-61"><a id="__codelineno-2-61" name="__codelineno-2-61" href="#__codelineno-2-61"></a>
</span><span id="__span-2-62"><a id="__codelineno-2-62" name="__codelineno-2-62" href="#__codelineno-2-62"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">access_tokens</span><span class="p">[</span><span class="n">access_token</span><span class="p">]</span> <span class="o">=</span> <span class="n">token_data</span>
</span><span id="__span-2-63"><a id="__codelineno-2-63" name="__codelineno-2-63" href="#__codelineno-2-63"></a>
</span><span id="__span-2-64"><a id="__codelineno-2-64" name="__codelineno-2-64" href="#__codelineno-2-64"></a>        <span class="c1"># Remove used authorization code</span>
</span><span id="__span-2-65"><a id="__codelineno-2-65" name="__codelineno-2-65" href="#__codelineno-2-65"></a>        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">authorization_codes</span><span class="p">[</span><span class="n">authorization_code</span><span class="p">]</span>
</span><span id="__span-2-66"><a id="__codelineno-2-66" name="__codelineno-2-66" href="#__codelineno-2-66"></a>
</span><span id="__span-2-67"><a id="__codelineno-2-67" name="__codelineno-2-67" href="#__codelineno-2-67"></a>        <span class="k">return</span> <span class="n">token_data</span>
</span><span id="__span-2-68"><a id="__codelineno-2-68" name="__codelineno-2-68" href="#__codelineno-2-68"></a>
</span><span id="__span-2-69"><a id="__codelineno-2-69" name="__codelineno-2-69" href="#__codelineno-2-69"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">validate_access_token</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">access_token</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
</span><span id="__span-2-70"><a id="__codelineno-2-70" name="__codelineno-2-70" href="#__codelineno-2-70"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate OAuth access token&quot;&quot;&quot;</span>
</span><span id="__span-2-71"><a id="__codelineno-2-71" name="__codelineno-2-71" href="#__codelineno-2-71"></a>
</span><span id="__span-2-72"><a id="__codelineno-2-72" name="__codelineno-2-72" href="#__codelineno-2-72"></a>        <span class="k">if</span> <span class="n">access_token</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">access_tokens</span><span class="p">:</span>
</span><span id="__span-2-73"><a id="__codelineno-2-73" name="__codelineno-2-73" href="#__codelineno-2-73"></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="__span-2-74"><a id="__codelineno-2-74" name="__codelineno-2-74" href="#__codelineno-2-74"></a>
</span><span id="__span-2-75"><a id="__codelineno-2-75" name="__codelineno-2-75" href="#__codelineno-2-75"></a>        <span class="n">token_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">access_tokens</span><span class="p">[</span><span class="n">access_token</span><span class="p">]</span>
</span><span id="__span-2-76"><a id="__codelineno-2-76" name="__codelineno-2-76" href="#__codelineno-2-76"></a>
</span><span id="__span-2-77"><a id="__codelineno-2-77" name="__codelineno-2-77" href="#__codelineno-2-77"></a>        <span class="c1"># Check if token has expired</span>
</span><span id="__span-2-78"><a id="__codelineno-2-78" name="__codelineno-2-78" href="#__codelineno-2-78"></a>        <span class="n">expires_at</span> <span class="o">=</span> <span class="n">token_data</span><span class="p">[</span><span class="s1">&#39;created_at&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">token_data</span><span class="p">[</span><span class="s1">&#39;expires_in&#39;</span><span class="p">])</span>
</span><span id="__span-2-79"><a id="__codelineno-2-79" name="__codelineno-2-79" href="#__codelineno-2-79"></a>        <span class="k">if</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">expires_at</span><span class="p">:</span>
</span><span id="__span-2-80"><a id="__codelineno-2-80" name="__codelineno-2-80" href="#__codelineno-2-80"></a>            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">access_tokens</span><span class="p">[</span><span class="n">access_token</span><span class="p">]</span>
</span><span id="__span-2-81"><a id="__codelineno-2-81" name="__codelineno-2-81" href="#__codelineno-2-81"></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="__span-2-82"><a id="__codelineno-2-82" name="__codelineno-2-82" href="#__codelineno-2-82"></a>
</span><span id="__span-2-83"><a id="__codelineno-2-83" name="__codelineno-2-83" href="#__codelineno-2-83"></a>        <span class="k">return</span> <span class="n">token_data</span>
</span><span id="__span-2-84"><a id="__codelineno-2-84" name="__codelineno-2-84" href="#__codelineno-2-84"></a>
</span><span id="__span-2-85"><a id="__codelineno-2-85" name="__codelineno-2-85" href="#__codelineno-2-85"></a><span class="c1"># OAuth-protected API endpoint</span>
</span><span id="__span-2-86"><a id="__codelineno-2-86" name="__codelineno-2-86" href="#__codelineno-2-86"></a><span class="k">def</span><span class="w"> </span><span class="nf">oauth_required</span><span class="p">(</span><span class="n">scopes_required</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="__span-2-87"><a id="__codelineno-2-87" name="__codelineno-2-87" href="#__codelineno-2-87"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Decorator for OAuth-protected endpoints&quot;&quot;&quot;</span>
</span><span id="__span-2-88"><a id="__codelineno-2-88" name="__codelineno-2-88" href="#__codelineno-2-88"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">decorator</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
</span><span id="__span-2-89"><a id="__codelineno-2-89" name="__codelineno-2-89" href="#__codelineno-2-89"></a>        <span class="k">def</span><span class="w"> </span><span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="__span-2-90"><a id="__codelineno-2-90" name="__codelineno-2-90" href="#__codelineno-2-90"></a>            <span class="c1"># Get access token from Authorization header</span>
</span><span id="__span-2-91"><a id="__codelineno-2-91" name="__codelineno-2-91" href="#__codelineno-2-91"></a>            <span class="c1"># In real implementation: token = request.headers.get(&#39;Authorization&#39;, &#39;&#39;).replace(&#39;Bearer &#39;, &#39;&#39;)</span>
</span><span id="__span-2-92"><a id="__codelineno-2-92" name="__codelineno-2-92" href="#__codelineno-2-92"></a>            <span class="n">token</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;access_token&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
</span><span id="__span-2-93"><a id="__codelineno-2-93" name="__codelineno-2-93" href="#__codelineno-2-93"></a>
</span><span id="__span-2-94"><a id="__codelineno-2-94" name="__codelineno-2-94" href="#__codelineno-2-94"></a>            <span class="n">oauth_manager</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;oauth_manager&#39;</span><span class="p">)</span>
</span><span id="__span-2-95"><a id="__codelineno-2-95" name="__codelineno-2-95" href="#__codelineno-2-95"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">oauth_manager</span><span class="p">:</span>
</span><span id="__span-2-96"><a id="__codelineno-2-96" name="__codelineno-2-96" href="#__codelineno-2-96"></a>                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;OAuth not configured&quot;</span><span class="p">,</span> <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="mi">500</span><span class="p">}</span>
</span><span id="__span-2-97"><a id="__codelineno-2-97" name="__codelineno-2-97" href="#__codelineno-2-97"></a>
</span><span id="__span-2-98"><a id="__codelineno-2-98" name="__codelineno-2-98" href="#__codelineno-2-98"></a>            <span class="c1"># Validate token</span>
</span><span id="__span-2-99"><a id="__codelineno-2-99" name="__codelineno-2-99" href="#__codelineno-2-99"></a>            <span class="n">token_data</span> <span class="o">=</span> <span class="n">oauth_manager</span><span class="o">.</span><span class="n">validate_access_token</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
</span><span id="__span-2-100"><a id="__codelineno-2-100" name="__codelineno-2-100" href="#__codelineno-2-100"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">token_data</span><span class="p">:</span>
</span><span id="__span-2-101"><a id="__codelineno-2-101" name="__codelineno-2-101" href="#__codelineno-2-101"></a>                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Invalid or expired access token&quot;</span><span class="p">,</span> <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="mi">401</span><span class="p">}</span>
</span><span id="__span-2-102"><a id="__codelineno-2-102" name="__codelineno-2-102" href="#__codelineno-2-102"></a>
</span><span id="__span-2-103"><a id="__codelineno-2-103" name="__codelineno-2-103" href="#__codelineno-2-103"></a>            <span class="c1"># Check scopes</span>
</span><span id="__span-2-104"><a id="__codelineno-2-104" name="__codelineno-2-104" href="#__codelineno-2-104"></a>            <span class="k">if</span> <span class="n">scopes_required</span><span class="p">:</span>
</span><span id="__span-2-105"><a id="__codelineno-2-105" name="__codelineno-2-105" href="#__codelineno-2-105"></a>                <span class="n">token_scopes</span> <span class="o">=</span> <span class="n">token_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;scope&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
</span><span id="__span-2-106"><a id="__codelineno-2-106" name="__codelineno-2-106" href="#__codelineno-2-106"></a>                <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">scope</span> <span class="ow">in</span> <span class="n">token_scopes</span> <span class="k">for</span> <span class="n">scope</span> <span class="ow">in</span> <span class="n">scopes_required</span><span class="p">):</span>
</span><span id="__span-2-107"><a id="__codelineno-2-107" name="__codelineno-2-107" href="#__codelineno-2-107"></a>                    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Insufficient scope&quot;</span><span class="p">,</span> <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="mi">403</span><span class="p">}</span>
</span><span id="__span-2-108"><a id="__codelineno-2-108" name="__codelineno-2-108" href="#__codelineno-2-108"></a>
</span><span id="__span-2-109"><a id="__codelineno-2-109" name="__codelineno-2-109" href="#__codelineno-2-109"></a>            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;token_info&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">token_data</span>
</span><span id="__span-2-110"><a id="__codelineno-2-110" name="__codelineno-2-110" href="#__codelineno-2-110"></a>            <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="__span-2-111"><a id="__codelineno-2-111" name="__codelineno-2-111" href="#__codelineno-2-111"></a>
</span><span id="__span-2-112"><a id="__codelineno-2-112" name="__codelineno-2-112" href="#__codelineno-2-112"></a>        <span class="k">return</span> <span class="n">wrapper</span>
</span><span id="__span-2-113"><a id="__codelineno-2-113" name="__codelineno-2-113" href="#__codelineno-2-113"></a>    <span class="k">return</span> <span class="n">decorator</span>
</span><span id="__span-2-114"><a id="__codelineno-2-114" name="__codelineno-2-114" href="#__codelineno-2-114"></a>
</span><span id="__span-2-115"><a id="__codelineno-2-115" name="__codelineno-2-115" href="#__codelineno-2-115"></a><span class="k">def</span><span class="w"> </span><span class="nf">oauth_authentication_example</span><span class="p">():</span>
</span><span id="__span-2-116"><a id="__codelineno-2-116" name="__codelineno-2-116" href="#__codelineno-2-116"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Demonstrate OAuth 2.0 authentication flow&quot;&quot;&quot;</span>
</span><span id="__span-2-117"><a id="__codelineno-2-117" name="__codelineno-2-117" href="#__codelineno-2-117"></a>
</span><span id="__span-2-118"><a id="__codelineno-2-118" name="__codelineno-2-118" href="#__codelineno-2-118"></a>    <span class="n">oauth_manager</span> <span class="o">=</span> <span class="n">OAuth2Manager</span><span class="p">(</span>
</span><span id="__span-2-119"><a id="__codelineno-2-119" name="__codelineno-2-119" href="#__codelineno-2-119"></a>        <span class="n">client_id</span><span class="o">=</span><span class="s2">&quot;your-client-id&quot;</span><span class="p">,</span>
</span><span id="__span-2-120"><a id="__codelineno-2-120" name="__codelineno-2-120" href="#__codelineno-2-120"></a>        <span class="n">client_secret</span><span class="o">=</span><span class="s2">&quot;your-client-secret&quot;</span><span class="p">,</span>
</span><span id="__span-2-121"><a id="__codelineno-2-121" name="__codelineno-2-121" href="#__codelineno-2-121"></a>        <span class="n">authorization_base_url</span><span class="o">=</span><span class="s2">&quot;https://auth.example.com/oauth/authorize&quot;</span><span class="p">,</span>
</span><span id="__span-2-122"><a id="__codelineno-2-122" name="__codelineno-2-122" href="#__codelineno-2-122"></a>        <span class="n">token_url</span><span class="o">=</span><span class="s2">&quot;https://auth.example.com/oauth/token&quot;</span>
</span><span id="__span-2-123"><a id="__codelineno-2-123" name="__codelineno-2-123" href="#__codelineno-2-123"></a>    <span class="p">)</span>
</span><span id="__span-2-124"><a id="__codelineno-2-124" name="__codelineno-2-124" href="#__codelineno-2-124"></a>
</span><span id="__span-2-125"><a id="__codelineno-2-125" name="__codelineno-2-125" href="#__codelineno-2-125"></a>    <span class="c1"># Step 1: Generate authorization URL</span>
</span><span id="__span-2-126"><a id="__codelineno-2-126" name="__codelineno-2-126" href="#__codelineno-2-126"></a>    <span class="n">auth_url</span> <span class="o">=</span> <span class="n">oauth_manager</span><span class="o">.</span><span class="n">generate_authorization_url</span><span class="p">(</span>
</span><span id="__span-2-127"><a id="__codelineno-2-127" name="__codelineno-2-127" href="#__codelineno-2-127"></a>        <span class="n">redirect_uri</span><span class="o">=</span><span class="s2">&quot;https://yourapp.com/callback&quot;</span><span class="p">,</span>
</span><span id="__span-2-128"><a id="__codelineno-2-128" name="__codelineno-2-128" href="#__codelineno-2-128"></a>        <span class="n">scope</span><span class="o">=</span><span class="s2">&quot;read write&quot;</span><span class="p">,</span>
</span><span id="__span-2-129"><a id="__codelineno-2-129" name="__codelineno-2-129" href="#__codelineno-2-129"></a>        <span class="n">state</span><span class="o">=</span><span class="s2">&quot;random-state-value&quot;</span>
</span><span id="__span-2-130"><a id="__codelineno-2-130" name="__codelineno-2-130" href="#__codelineno-2-130"></a>    <span class="p">)</span>
</span><span id="__span-2-131"><a id="__codelineno-2-131" name="__codelineno-2-131" href="#__codelineno-2-131"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Authorization URL: </span><span class="si">{</span><span class="n">auth_url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-2-132"><a id="__codelineno-2-132" name="__codelineno-2-132" href="#__codelineno-2-132"></a>
</span><span id="__span-2-133"><a id="__codelineno-2-133" name="__codelineno-2-133" href="#__codelineno-2-133"></a>    <span class="c1"># Step 2: Simulate user authorization (in real flow, user clicks auth_url)</span>
</span><span id="__span-2-134"><a id="__codelineno-2-134" name="__codelineno-2-134" href="#__codelineno-2-134"></a>    <span class="c1"># This would be handled by the authorization server</span>
</span><span id="__span-2-135"><a id="__codelineno-2-135" name="__codelineno-2-135" href="#__codelineno-2-135"></a>    <span class="n">authorization_code</span> <span class="o">=</span> <span class="n">secrets</span><span class="o">.</span><span class="n">token_urlsafe</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>
</span><span id="__span-2-136"><a id="__codelineno-2-136" name="__codelineno-2-136" href="#__codelineno-2-136"></a>    <span class="n">oauth_manager</span><span class="o">.</span><span class="n">authorization_codes</span><span class="p">[</span><span class="n">authorization_code</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-2-137"><a id="__codelineno-2-137" name="__codelineno-2-137" href="#__codelineno-2-137"></a>        <span class="s1">&#39;user_id&#39;</span><span class="p">:</span> <span class="s1">&#39;user123&#39;</span><span class="p">,</span>
</span><span id="__span-2-138"><a id="__codelineno-2-138" name="__codelineno-2-138" href="#__codelineno-2-138"></a>        <span class="s1">&#39;scope&#39;</span><span class="p">:</span> <span class="s1">&#39;read write&#39;</span><span class="p">,</span>
</span><span id="__span-2-139"><a id="__codelineno-2-139" name="__codelineno-2-139" href="#__codelineno-2-139"></a>        <span class="s1">&#39;expires_at&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</span><span id="__span-2-140"><a id="__codelineno-2-140" name="__codelineno-2-140" href="#__codelineno-2-140"></a>    <span class="p">}</span>
</span><span id="__span-2-141"><a id="__codelineno-2-141" name="__codelineno-2-141" href="#__codelineno-2-141"></a>
</span><span id="__span-2-142"><a id="__codelineno-2-142" name="__codelineno-2-142" href="#__codelineno-2-142"></a>    <span class="c1"># Step 3: Exchange code for token</span>
</span><span id="__span-2-143"><a id="__codelineno-2-143" name="__codelineno-2-143" href="#__codelineno-2-143"></a>    <span class="n">token_data</span> <span class="o">=</span> <span class="n">oauth_manager</span><span class="o">.</span><span class="n">exchange_code_for_token</span><span class="p">(</span>
</span><span id="__span-2-144"><a id="__codelineno-2-144" name="__codelineno-2-144" href="#__codelineno-2-144"></a>        <span class="n">authorization_code</span><span class="o">=</span><span class="n">authorization_code</span><span class="p">,</span>
</span><span id="__span-2-145"><a id="__codelineno-2-145" name="__codelineno-2-145" href="#__codelineno-2-145"></a>        <span class="n">redirect_uri</span><span class="o">=</span><span class="s2">&quot;https://yourapp.com/callback&quot;</span>
</span><span id="__span-2-146"><a id="__codelineno-2-146" name="__codelineno-2-146" href="#__codelineno-2-146"></a>    <span class="p">)</span>
</span><span id="__span-2-147"><a id="__codelineno-2-147" name="__codelineno-2-147" href="#__codelineno-2-147"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Access token data: </span><span class="si">{</span><span class="n">token_data</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-2-148"><a id="__codelineno-2-148" name="__codelineno-2-148" href="#__codelineno-2-148"></a>
</span><span id="__span-2-149"><a id="__codelineno-2-149" name="__codelineno-2-149" href="#__codelineno-2-149"></a>    <span class="c1"># Step 4: Use token to access protected resource</span>
</span><span id="__span-2-150"><a id="__codelineno-2-150" name="__codelineno-2-150" href="#__codelineno-2-150"></a>    <span class="nd">@oauth_required</span><span class="p">([</span><span class="s1">&#39;read&#39;</span><span class="p">])</span>
</span><span id="__span-2-151"><a id="__codelineno-2-151" name="__codelineno-2-151" href="#__codelineno-2-151"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_protected_data</span><span class="p">(</span><span class="n">access_token</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">oauth_manager</span><span class="p">:</span> <span class="n">OAuth2Manager</span><span class="p">,</span> <span class="n">token_info</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
</span><span id="__span-2-152"><a id="__codelineno-2-152" name="__codelineno-2-152" href="#__codelineno-2-152"></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-2-153"><a id="__codelineno-2-153" name="__codelineno-2-153" href="#__codelineno-2-153"></a>            <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="s2">&quot;This is protected data&quot;</span><span class="p">,</span>
</span><span id="__span-2-154"><a id="__codelineno-2-154" name="__codelineno-2-154" href="#__codelineno-2-154"></a>            <span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="n">token_info</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">],</span>
</span><span id="__span-2-155"><a id="__codelineno-2-155" name="__codelineno-2-155" href="#__codelineno-2-155"></a>            <span class="s2">&quot;scopes&quot;</span><span class="p">:</span> <span class="n">token_info</span><span class="p">[</span><span class="s1">&#39;scope&#39;</span><span class="p">]</span>
</span><span id="__span-2-156"><a id="__codelineno-2-156" name="__codelineno-2-156" href="#__codelineno-2-156"></a>        <span class="p">}</span>
</span><span id="__span-2-157"><a id="__codelineno-2-157" name="__codelineno-2-157" href="#__codelineno-2-157"></a>
</span><span id="__span-2-158"><a id="__codelineno-2-158" name="__codelineno-2-158" href="#__codelineno-2-158"></a>    <span class="n">result</span> <span class="o">=</span> <span class="n">get_protected_data</span><span class="p">(</span>
</span><span id="__span-2-159"><a id="__codelineno-2-159" name="__codelineno-2-159" href="#__codelineno-2-159"></a>        <span class="n">access_token</span><span class="o">=</span><span class="n">token_data</span><span class="p">[</span><span class="s1">&#39;access_token&#39;</span><span class="p">],</span>
</span><span id="__span-2-160"><a id="__codelineno-2-160" name="__codelineno-2-160" href="#__codelineno-2-160"></a>        <span class="n">oauth_manager</span><span class="o">=</span><span class="n">oauth_manager</span>
</span><span id="__span-2-161"><a id="__codelineno-2-161" name="__codelineno-2-161" href="#__codelineno-2-161"></a>    <span class="p">)</span>
</span><span id="__span-2-162"><a id="__codelineno-2-162" name="__codelineno-2-162" href="#__codelineno-2-162"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Protected resource access: </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-2-163"><a id="__codelineno-2-163" name="__codelineno-2-163" href="#__codelineno-2-163"></a>
</span><span id="__span-2-164"><a id="__codelineno-2-164" name="__codelineno-2-164" href="#__codelineno-2-164"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
</span><span id="__span-2-165"><a id="__codelineno-2-165" name="__codelineno-2-165" href="#__codelineno-2-165"></a>    <span class="n">oauth_authentication_example</span><span class="p">()</span>
</span></code></pre></div>
<h3 id="choosing-the-right-authentication-method">Choosing the Right Authentication <span class="glossary-term" data-glossary-category="OOP" data-glossary-definition="A function defined within a class that describes the behaviors of objects created from that class." data-glossary-term="Method">Method</span><a class="headerlink" href="#choosing-the-right-authentication-method" title="Permanent link">&para;</a></h3>
<p>Now that we&rsquo;ve covered all three authentication approaches, here&rsquo;s a practical guide for choosing which one to use:</p>
<table>
<thead>
<tr>
<th>Feature</th>
<th><span class="glossary-term" data-glossary-category="Web Development" data-glossary-definition="A set of protocols and tools for building software applications, defining how components interact." data-glossary-full-form="Application Programming Interface" data-glossary-term="API">API</span> Keys</th>
<th>JWT</th>
<th>OAuth 2.0</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Complexity</strong></td>
<td>Simple</td>
<td>Moderate</td>
<td>Complex</td>
</tr>
<tr>
<td><strong>User context</strong></td>
<td>❌ Application-level only</td>
<td>✅ User-specific</td>
<td>✅ User-specific</td>
</tr>
<tr>
<td><strong>Expiration</strong></td>
<td>Manual only</td>
<td>✅ Automatic</td>
<td>✅ Automatic</td>
</tr>
<tr>
<td><strong>Permissions</strong></td>
<td>Basic</td>
<td>✅ Fine-grained</td>
<td>✅ Scoped</td>
</tr>
<tr>
<td><strong>Stateless</strong></td>
<td>✅ Yes</td>
<td>✅ Yes</td>
<td>Partially</td>
</tr>
<tr>
<td><strong>Third-party access</strong></td>
<td>❌ No</td>
<td>❌ No</td>
<td>✅ Yes</td>
</tr>
<tr>
<td><strong>Revocation</strong></td>
<td>Manual</td>
<td>Manual (blacklist required)</td>
<td>✅ Built-in</td>
</tr>
<tr>
<td><strong>Best for</strong></td>
<td>Server-to-server</td>
<td>Web/mobile apps</td>
<td>Third-party integrations</td>
</tr>
</tbody>
</table>
<p><strong>Quick decision tree:</strong></p>
<ol>
<li><strong>Do you need third-party apps to access user data?</strong></li>
<li>Yes → Use <strong>OAuth 2.0</strong></li>
<li>
<p>No → Continue to question 2</p>
</li>
<li>
<p><strong>Do you need to know which specific user is making requests?</strong></p>
</li>
<li>Yes → Use <strong>JWT</strong></li>
<li>
<p>No → Continue to question 3</p>
</li>
<li>
<p><strong>Is this server-to-server communication you control?</strong></p>
</li>
<li>Yes → Use <strong><span class="glossary-term" data-glossary-category="Web Development" data-glossary-definition="A set of protocols and tools for building software applications, defining how components interact." data-glossary-full-form="Application Programming Interface" data-glossary-term="API">API</span> Keys</strong></li>
<li>No → Use <strong>JWT</strong> (safer default)</li>
</ol>
<p><strong>Common combinations:</strong></p>
<p>Real-world applications often use multiple <span class="glossary-term" data-glossary-category="OOP" data-glossary-definition="A function defined within a class that describes the behaviors of objects created from that class." data-glossary-term="Method">methods</span>:</p>
<ul>
<li><strong><span class="glossary-term" data-glossary-category="Web Development" data-glossary-definition="A set of protocols and tools for building software applications, defining how components interact." data-glossary-full-form="Application Programming Interface" data-glossary-term="API">API</span> Keys + JWT</strong>: <span class="glossary-term" data-glossary-category="Web Development" data-glossary-definition="A set of protocols and tools for building software applications, defining how components interact." data-glossary-full-form="Application Programming Interface" data-glossary-term="API">API</span> keys for your mobile app to access your backend, JWT for user authentication within the app</li>
<li><strong>OAuth 2.0 + JWT</strong>: OAuth for third-party login, JWT for maintaining session after authentication</li>
<li><strong>All three</strong>: Large platforms might use all <span class="glossary-term" data-glossary-category="OOP" data-glossary-definition="A function defined within a class that describes the behaviors of objects created from that class." data-glossary-term="Method">methods</span> for different purposes</li>
</ul>
<h2 id="rate-limiting-and-dos-protection">Rate Limiting and DoS Protection<a class="headerlink" href="#rate-limiting-and-dos-protection" title="Permanent link">&para;</a></h2>
<p>Rate limiting is crucial for preventing abuse and ensuring fair resource allocation among <span class="glossary-term" data-glossary-category="Web Development" data-glossary-definition="A set of protocols and tools for building software applications, defining how components interact." data-glossary-full-form="Application Programming Interface" data-glossary-term="API">API</span> consumers.</p>
<h3 id="token-bucket-algorithm-implementation">Token Bucket <span class="glossary-term" data-glossary-category="Programming Fundamentals" data-glossary-definition="A finite sequence of well-defined instructions to solve a problem or perform a computation." data-glossary-term="Algorithm">Algorithm</span> Implementation<a class="headerlink" href="#token-bucket-algorithm-implementation" title="Permanent link">&para;</a></h3>
<div class="language-python highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">threading</span><span class="w"> </span><span class="kn">import</span> <span class="n">Lock</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Optional</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a><span class="nd">@dataclass</span>
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a><span class="k">class</span><span class="w"> </span><span class="nc">TokenBucket</span><span class="p">:</span>
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Token bucket for rate limiting&quot;&quot;&quot;</span>
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a>    <span class="n">capacity</span><span class="p">:</span> <span class="nb">int</span>  <span class="c1"># Maximum number of tokens</span>
</span><span id="__span-3-10"><a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a>    <span class="n">tokens</span><span class="p">:</span> <span class="nb">float</span>  <span class="c1"># Current number of tokens</span>
</span><span id="__span-3-11"><a id="__codelineno-3-11" name="__codelineno-3-11" href="#__codelineno-3-11"></a>    <span class="n">refill_rate</span><span class="p">:</span> <span class="nb">float</span>  <span class="c1"># Tokens added per second</span>
</span><span id="__span-3-12"><a id="__codelineno-3-12" name="__codelineno-3-12" href="#__codelineno-3-12"></a>    <span class="n">last_refill</span><span class="p">:</span> <span class="nb">float</span>  <span class="c1"># Last refill timestamp</span>
</span><span id="__span-3-13"><a id="__codelineno-3-13" name="__codelineno-3-13" href="#__codelineno-3-13"></a>
</span><span id="__span-3-14"><a id="__codelineno-3-14" name="__codelineno-3-14" href="#__codelineno-3-14"></a><span class="k">class</span><span class="w"> </span><span class="nc">RateLimiter</span><span class="p">:</span>
</span><span id="__span-3-15"><a id="__codelineno-3-15" name="__codelineno-3-15" href="#__codelineno-3-15"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Advanced rate limiting with multiple algorithms&quot;&quot;&quot;</span>
</span><span id="__span-3-16"><a id="__codelineno-3-16" name="__codelineno-3-16" href="#__codelineno-3-16"></a>
</span><span id="__span-3-17"><a id="__codelineno-3-17" name="__codelineno-3-17" href="#__codelineno-3-17"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-3-18"><a id="__codelineno-3-18" name="__codelineno-3-18" href="#__codelineno-3-18"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">buckets</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">TokenBucket</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="__span-3-19"><a id="__codelineno-3-19" name="__codelineno-3-19" href="#__codelineno-3-19"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">lock</span> <span class="o">=</span> <span class="n">Lock</span><span class="p">()</span>
</span><span id="__span-3-20"><a id="__codelineno-3-20" name="__codelineno-3-20" href="#__codelineno-3-20"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">request_history</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="__span-3-21"><a id="__codelineno-3-21" name="__codelineno-3-21" href="#__codelineno-3-21"></a>
</span><span id="__span-3-22"><a id="__codelineno-3-22" name="__codelineno-3-22" href="#__codelineno-3-22"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_rate_limit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identifier</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">requests_per_second</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> 
</span><span id="__span-3-23"><a id="__codelineno-3-23" name="__codelineno-3-23" href="#__codelineno-3-23"></a>                         <span class="n">burst_capacity</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TokenBucket</span><span class="p">:</span>
</span><span id="__span-3-24"><a id="__codelineno-3-24" name="__codelineno-3-24" href="#__codelineno-3-24"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a rate limit for an identifier (IP, user, API key)&quot;&quot;&quot;</span>
</span><span id="__span-3-25"><a id="__codelineno-3-25" name="__codelineno-3-25" href="#__codelineno-3-25"></a>
</span><span id="__span-3-26"><a id="__codelineno-3-26" name="__codelineno-3-26" href="#__codelineno-3-26"></a>        <span class="k">if</span> <span class="n">burst_capacity</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-3-27"><a id="__codelineno-3-27" name="__codelineno-3-27" href="#__codelineno-3-27"></a>            <span class="n">burst_capacity</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">requests_per_second</span> <span class="o">*</span> <span class="mi">10</span><span class="p">)</span>  <span class="c1"># Allow 10 seconds of burst</span>
</span><span id="__span-3-28"><a id="__codelineno-3-28" name="__codelineno-3-28" href="#__codelineno-3-28"></a>
</span><span id="__span-3-29"><a id="__codelineno-3-29" name="__codelineno-3-29" href="#__codelineno-3-29"></a>        <span class="n">bucket</span> <span class="o">=</span> <span class="n">TokenBucket</span><span class="p">(</span>
</span><span id="__span-3-30"><a id="__codelineno-3-30" name="__codelineno-3-30" href="#__codelineno-3-30"></a>            <span class="n">capacity</span><span class="o">=</span><span class="n">burst_capacity</span><span class="p">,</span>
</span><span id="__span-3-31"><a id="__codelineno-3-31" name="__codelineno-3-31" href="#__codelineno-3-31"></a>            <span class="n">tokens</span><span class="o">=</span><span class="n">burst_capacity</span><span class="p">,</span>  <span class="c1"># Start with full bucket</span>
</span><span id="__span-3-32"><a id="__codelineno-3-32" name="__codelineno-3-32" href="#__codelineno-3-32"></a>            <span class="n">refill_rate</span><span class="o">=</span><span class="n">requests_per_second</span><span class="p">,</span>
</span><span id="__span-3-33"><a id="__codelineno-3-33" name="__codelineno-3-33" href="#__codelineno-3-33"></a>            <span class="n">last_refill</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="__span-3-34"><a id="__codelineno-3-34" name="__codelineno-3-34" href="#__codelineno-3-34"></a>        <span class="p">)</span>
</span><span id="__span-3-35"><a id="__codelineno-3-35" name="__codelineno-3-35" href="#__codelineno-3-35"></a>
</span><span id="__span-3-36"><a id="__codelineno-3-36" name="__codelineno-3-36" href="#__codelineno-3-36"></a>        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
</span><span id="__span-3-37"><a id="__codelineno-3-37" name="__codelineno-3-37" href="#__codelineno-3-37"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">buckets</span><span class="p">[</span><span class="n">identifier</span><span class="p">]</span> <span class="o">=</span> <span class="n">bucket</span>
</span><span id="__span-3-38"><a id="__codelineno-3-38" name="__codelineno-3-38" href="#__codelineno-3-38"></a>
</span><span id="__span-3-39"><a id="__codelineno-3-39" name="__codelineno-3-39" href="#__codelineno-3-39"></a>        <span class="k">return</span> <span class="n">bucket</span>
</span><span id="__span-3-40"><a id="__codelineno-3-40" name="__codelineno-3-40" href="#__codelineno-3-40"></a>
</span><span id="__span-3-41"><a id="__codelineno-3-41" name="__codelineno-3-41" href="#__codelineno-3-41"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">is_allowed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identifier</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tokens_requested</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
</span><span id="__span-3-42"><a id="__codelineno-3-42" name="__codelineno-3-42" href="#__codelineno-3-42"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if request is allowed under rate limit&quot;&quot;&quot;</span>
</span><span id="__span-3-43"><a id="__codelineno-3-43" name="__codelineno-3-43" href="#__codelineno-3-43"></a>
</span><span id="__span-3-44"><a id="__codelineno-3-44" name="__codelineno-3-44" href="#__codelineno-3-44"></a>        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
</span><span id="__span-3-45"><a id="__codelineno-3-45" name="__codelineno-3-45" href="#__codelineno-3-45"></a>            <span class="c1"># Get or create bucket</span>
</span><span id="__span-3-46"><a id="__codelineno-3-46" name="__codelineno-3-46" href="#__codelineno-3-46"></a>            <span class="k">if</span> <span class="n">identifier</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">buckets</span><span class="p">:</span>
</span><span id="__span-3-47"><a id="__codelineno-3-47" name="__codelineno-3-47" href="#__codelineno-3-47"></a>                <span class="c1"># Default rate limit: 100 requests per second with burst of 1000</span>
</span><span id="__span-3-48"><a id="__codelineno-3-48" name="__codelineno-3-48" href="#__codelineno-3-48"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">create_rate_limit</span><span class="p">(</span><span class="n">identifier</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
</span><span id="__span-3-49"><a id="__codelineno-3-49" name="__codelineno-3-49" href="#__codelineno-3-49"></a>
</span><span id="__span-3-50"><a id="__codelineno-3-50" name="__codelineno-3-50" href="#__codelineno-3-50"></a>            <span class="n">bucket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">buckets</span><span class="p">[</span><span class="n">identifier</span><span class="p">]</span>
</span><span id="__span-3-51"><a id="__codelineno-3-51" name="__codelineno-3-51" href="#__codelineno-3-51"></a>            <span class="n">current_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="__span-3-52"><a id="__codelineno-3-52" name="__codelineno-3-52" href="#__codelineno-3-52"></a>
</span><span id="__span-3-53"><a id="__codelineno-3-53" name="__codelineno-3-53" href="#__codelineno-3-53"></a>            <span class="c1"># Refill tokens based on elapsed time</span>
</span><span id="__span-3-54"><a id="__codelineno-3-54" name="__codelineno-3-54" href="#__codelineno-3-54"></a>            <span class="n">elapsed</span> <span class="o">=</span> <span class="n">current_time</span> <span class="o">-</span> <span class="n">bucket</span><span class="o">.</span><span class="n">last_refill</span>
</span><span id="__span-3-55"><a id="__codelineno-3-55" name="__codelineno-3-55" href="#__codelineno-3-55"></a>            <span class="n">tokens_to_add</span> <span class="o">=</span> <span class="n">elapsed</span> <span class="o">*</span> <span class="n">bucket</span><span class="o">.</span><span class="n">refill_rate</span>
</span><span id="__span-3-56"><a id="__codelineno-3-56" name="__codelineno-3-56" href="#__codelineno-3-56"></a>            <span class="n">bucket</span><span class="o">.</span><span class="n">tokens</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">bucket</span><span class="o">.</span><span class="n">capacity</span><span class="p">,</span> <span class="n">bucket</span><span class="o">.</span><span class="n">tokens</span> <span class="o">+</span> <span class="n">tokens_to_add</span><span class="p">)</span>
</span><span id="__span-3-57"><a id="__codelineno-3-57" name="__codelineno-3-57" href="#__codelineno-3-57"></a>            <span class="n">bucket</span><span class="o">.</span><span class="n">last_refill</span> <span class="o">=</span> <span class="n">current_time</span>
</span><span id="__span-3-58"><a id="__codelineno-3-58" name="__codelineno-3-58" href="#__codelineno-3-58"></a>
</span><span id="__span-3-59"><a id="__codelineno-3-59" name="__codelineno-3-59" href="#__codelineno-3-59"></a>            <span class="c1"># Check if enough tokens available</span>
</span><span id="__span-3-60"><a id="__codelineno-3-60" name="__codelineno-3-60" href="#__codelineno-3-60"></a>            <span class="k">if</span> <span class="n">bucket</span><span class="o">.</span><span class="n">tokens</span> <span class="o">&gt;=</span> <span class="n">tokens_requested</span><span class="p">:</span>
</span><span id="__span-3-61"><a id="__codelineno-3-61" name="__codelineno-3-61" href="#__codelineno-3-61"></a>                <span class="n">bucket</span><span class="o">.</span><span class="n">tokens</span> <span class="o">-=</span> <span class="n">tokens_requested</span>
</span><span id="__span-3-62"><a id="__codelineno-3-62" name="__codelineno-3-62" href="#__codelineno-3-62"></a>
</span><span id="__span-3-63"><a id="__codelineno-3-63" name="__codelineno-3-63" href="#__codelineno-3-63"></a>                <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="p">{</span>
</span><span id="__span-3-64"><a id="__codelineno-3-64" name="__codelineno-3-64" href="#__codelineno-3-64"></a>                    <span class="s2">&quot;allowed&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="__span-3-65"><a id="__codelineno-3-65" name="__codelineno-3-65" href="#__codelineno-3-65"></a>                    <span class="s2">&quot;remaining_tokens&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">bucket</span><span class="o">.</span><span class="n">tokens</span><span class="p">),</span>
</span><span id="__span-3-66"><a id="__codelineno-3-66" name="__codelineno-3-66" href="#__codelineno-3-66"></a>                    <span class="s2">&quot;reset_time&quot;</span><span class="p">:</span> <span class="n">current_time</span> <span class="o">+</span> <span class="p">(</span><span class="n">bucket</span><span class="o">.</span><span class="n">capacity</span> <span class="o">-</span> <span class="n">bucket</span><span class="o">.</span><span class="n">tokens</span><span class="p">)</span> <span class="o">/</span> <span class="n">bucket</span><span class="o">.</span><span class="n">refill_rate</span>
</span><span id="__span-3-67"><a id="__codelineno-3-67" name="__codelineno-3-67" href="#__codelineno-3-67"></a>                <span class="p">}</span>
</span><span id="__span-3-68"><a id="__codelineno-3-68" name="__codelineno-3-68" href="#__codelineno-3-68"></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="__span-3-69"><a id="__codelineno-3-69" name="__codelineno-3-69" href="#__codelineno-3-69"></a>                <span class="c1"># Calculate when enough tokens will be available</span>
</span><span id="__span-3-70"><a id="__codelineno-3-70" name="__codelineno-3-70" href="#__codelineno-3-70"></a>                <span class="n">tokens_needed</span> <span class="o">=</span> <span class="n">tokens_requested</span> <span class="o">-</span> <span class="n">bucket</span><span class="o">.</span><span class="n">tokens</span>
</span><span id="__span-3-71"><a id="__codelineno-3-71" name="__codelineno-3-71" href="#__codelineno-3-71"></a>                <span class="n">wait_time</span> <span class="o">=</span> <span class="n">tokens_needed</span> <span class="o">/</span> <span class="n">bucket</span><span class="o">.</span><span class="n">refill_rate</span>
</span><span id="__span-3-72"><a id="__codelineno-3-72" name="__codelineno-3-72" href="#__codelineno-3-72"></a>
</span><span id="__span-3-73"><a id="__codelineno-3-73" name="__codelineno-3-73" href="#__codelineno-3-73"></a>                <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="p">{</span>
</span><span id="__span-3-74"><a id="__codelineno-3-74" name="__codelineno-3-74" href="#__codelineno-3-74"></a>                    <span class="s2">&quot;allowed&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="__span-3-75"><a id="__codelineno-3-75" name="__codelineno-3-75" href="#__codelineno-3-75"></a>                    <span class="s2">&quot;retry_after&quot;</span><span class="p">:</span> <span class="n">wait_time</span><span class="p">,</span>
</span><span id="__span-3-76"><a id="__codelineno-3-76" name="__codelineno-3-76" href="#__codelineno-3-76"></a>                    <span class="s2">&quot;remaining_tokens&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">bucket</span><span class="o">.</span><span class="n">tokens</span><span class="p">)</span>
</span><span id="__span-3-77"><a id="__codelineno-3-77" name="__codelineno-3-77" href="#__codelineno-3-77"></a>                <span class="p">}</span>
</span><span id="__span-3-78"><a id="__codelineno-3-78" name="__codelineno-3-78" href="#__codelineno-3-78"></a>
</span><span id="__span-3-79"><a id="__codelineno-3-79" name="__codelineno-3-79" href="#__codelineno-3-79"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">sliding_window_check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identifier</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">window_seconds</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3600</span><span class="p">,</span> 
</span><span id="__span-3-80"><a id="__codelineno-3-80" name="__codelineno-3-80" href="#__codelineno-3-80"></a>                           <span class="n">max_requests</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
</span><span id="__span-3-81"><a id="__codelineno-3-81" name="__codelineno-3-81" href="#__codelineno-3-81"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Sliding window rate limiting (alternative algorithm)&quot;&quot;&quot;</span>
</span><span id="__span-3-82"><a id="__codelineno-3-82" name="__codelineno-3-82" href="#__codelineno-3-82"></a>
</span><span id="__span-3-83"><a id="__codelineno-3-83" name="__codelineno-3-83" href="#__codelineno-3-83"></a>        <span class="n">current_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="__span-3-84"><a id="__codelineno-3-84" name="__codelineno-3-84" href="#__codelineno-3-84"></a>        <span class="n">window_start</span> <span class="o">=</span> <span class="n">current_time</span> <span class="o">-</span> <span class="n">window_seconds</span>
</span><span id="__span-3-85"><a id="__codelineno-3-85" name="__codelineno-3-85" href="#__codelineno-3-85"></a>
</span><span id="__span-3-86"><a id="__codelineno-3-86" name="__codelineno-3-86" href="#__codelineno-3-86"></a>        <span class="c1"># Initialize request history if needed</span>
</span><span id="__span-3-87"><a id="__codelineno-3-87" name="__codelineno-3-87" href="#__codelineno-3-87"></a>        <span class="k">if</span> <span class="n">identifier</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_history</span><span class="p">:</span>
</span><span id="__span-3-88"><a id="__codelineno-3-88" name="__codelineno-3-88" href="#__codelineno-3-88"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">request_history</span><span class="p">[</span><span class="n">identifier</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-3-89"><a id="__codelineno-3-89" name="__codelineno-3-89" href="#__codelineno-3-89"></a>
</span><span id="__span-3-90"><a id="__codelineno-3-90" name="__codelineno-3-90" href="#__codelineno-3-90"></a>        <span class="c1"># Remove old requests outside the window</span>
</span><span id="__span-3-91"><a id="__codelineno-3-91" name="__codelineno-3-91" href="#__codelineno-3-91"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">request_history</span><span class="p">[</span><span class="n">identifier</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="__span-3-92"><a id="__codelineno-3-92" name="__codelineno-3-92" href="#__codelineno-3-92"></a>            <span class="n">req_time</span> <span class="k">for</span> <span class="n">req_time</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_history</span><span class="p">[</span><span class="n">identifier</span><span class="p">]</span>
</span><span id="__span-3-93"><a id="__codelineno-3-93" name="__codelineno-3-93" href="#__codelineno-3-93"></a>            <span class="k">if</span> <span class="n">req_time</span> <span class="o">&gt;</span> <span class="n">window_start</span>
</span><span id="__span-3-94"><a id="__codelineno-3-94" name="__codelineno-3-94" href="#__codelineno-3-94"></a>        <span class="p">]</span>
</span><span id="__span-3-95"><a id="__codelineno-3-95" name="__codelineno-3-95" href="#__codelineno-3-95"></a>
</span><span id="__span-3-96"><a id="__codelineno-3-96" name="__codelineno-3-96" href="#__codelineno-3-96"></a>        <span class="c1"># Check if within limit</span>
</span><span id="__span-3-97"><a id="__codelineno-3-97" name="__codelineno-3-97" href="#__codelineno-3-97"></a>        <span class="n">current_requests</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request_history</span><span class="p">[</span><span class="n">identifier</span><span class="p">])</span>
</span><span id="__span-3-98"><a id="__codelineno-3-98" name="__codelineno-3-98" href="#__codelineno-3-98"></a>
</span><span id="__span-3-99"><a id="__codelineno-3-99" name="__codelineno-3-99" href="#__codelineno-3-99"></a>        <span class="k">if</span> <span class="n">current_requests</span> <span class="o">&lt;</span> <span class="n">max_requests</span><span class="p">:</span>
</span><span id="__span-3-100"><a id="__codelineno-3-100" name="__codelineno-3-100" href="#__codelineno-3-100"></a>            <span class="c1"># Add current request</span>
</span><span id="__span-3-101"><a id="__codelineno-3-101" name="__codelineno-3-101" href="#__codelineno-3-101"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">request_history</span><span class="p">[</span><span class="n">identifier</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current_time</span><span class="p">)</span>
</span><span id="__span-3-102"><a id="__codelineno-3-102" name="__codelineno-3-102" href="#__codelineno-3-102"></a>
</span><span id="__span-3-103"><a id="__codelineno-3-103" name="__codelineno-3-103" href="#__codelineno-3-103"></a>            <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="p">{</span>
</span><span id="__span-3-104"><a id="__codelineno-3-104" name="__codelineno-3-104" href="#__codelineno-3-104"></a>                <span class="s2">&quot;allowed&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="__span-3-105"><a id="__codelineno-3-105" name="__codelineno-3-105" href="#__codelineno-3-105"></a>                <span class="s2">&quot;requests_remaining&quot;</span><span class="p">:</span> <span class="n">max_requests</span> <span class="o">-</span> <span class="n">current_requests</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="__span-3-106"><a id="__codelineno-3-106" name="__codelineno-3-106" href="#__codelineno-3-106"></a>                <span class="s2">&quot;window_reset&quot;</span><span class="p">:</span> <span class="n">window_start</span> <span class="o">+</span> <span class="n">window_seconds</span>
</span><span id="__span-3-107"><a id="__codelineno-3-107" name="__codelineno-3-107" href="#__codelineno-3-107"></a>            <span class="p">}</span>
</span><span id="__span-3-108"><a id="__codelineno-3-108" name="__codelineno-3-108" href="#__codelineno-3-108"></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="__span-3-109"><a id="__codelineno-3-109" name="__codelineno-3-109" href="#__codelineno-3-109"></a>            <span class="c1"># Calculate when window will reset</span>
</span><span id="__span-3-110"><a id="__codelineno-3-110" name="__codelineno-3-110" href="#__codelineno-3-110"></a>            <span class="n">oldest_request</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request_history</span><span class="p">[</span><span class="n">identifier</span><span class="p">])</span>
</span><span id="__span-3-111"><a id="__codelineno-3-111" name="__codelineno-3-111" href="#__codelineno-3-111"></a>            <span class="n">reset_time</span> <span class="o">=</span> <span class="n">oldest_request</span> <span class="o">+</span> <span class="n">window_seconds</span>
</span><span id="__span-3-112"><a id="__codelineno-3-112" name="__codelineno-3-112" href="#__codelineno-3-112"></a>
</span><span id="__span-3-113"><a id="__codelineno-3-113" name="__codelineno-3-113" href="#__codelineno-3-113"></a>            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="p">{</span>
</span><span id="__span-3-114"><a id="__codelineno-3-114" name="__codelineno-3-114" href="#__codelineno-3-114"></a>                <span class="s2">&quot;allowed&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="__span-3-115"><a id="__codelineno-3-115" name="__codelineno-3-115" href="#__codelineno-3-115"></a>                <span class="s2">&quot;retry_after&quot;</span><span class="p">:</span> <span class="n">reset_time</span> <span class="o">-</span> <span class="n">current_time</span><span class="p">,</span>
</span><span id="__span-3-116"><a id="__codelineno-3-116" name="__codelineno-3-116" href="#__codelineno-3-116"></a>                <span class="s2">&quot;requests_remaining&quot;</span><span class="p">:</span> <span class="mi">0</span>
</span><span id="__span-3-117"><a id="__codelineno-3-117" name="__codelineno-3-117" href="#__codelineno-3-117"></a>            <span class="p">}</span>
</span><span id="__span-3-118"><a id="__codelineno-3-118" name="__codelineno-3-118" href="#__codelineno-3-118"></a>
</span><span id="__span-3-119"><a id="__codelineno-3-119" name="__codelineno-3-119" href="#__codelineno-3-119"></a><span class="k">class</span><span class="w"> </span><span class="nc">DDoSProtection</span><span class="p">:</span>
</span><span id="__span-3-120"><a id="__codelineno-3-120" name="__codelineno-3-120" href="#__codelineno-3-120"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;DDoS protection with progressive penalties&quot;&quot;&quot;</span>
</span><span id="__span-3-121"><a id="__codelineno-3-121" name="__codelineno-3-121" href="#__codelineno-3-121"></a>
</span><span id="__span-3-122"><a id="__codelineno-3-122" name="__codelineno-3-122" href="#__codelineno-3-122"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-3-123"><a id="__codelineno-3-123" name="__codelineno-3-123" href="#__codelineno-3-123"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">rate_limiter</span> <span class="o">=</span> <span class="n">RateLimiter</span><span class="p">()</span>
</span><span id="__span-3-124"><a id="__codelineno-3-124" name="__codelineno-3-124" href="#__codelineno-3-124"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">suspicious_ips</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="__span-3-125"><a id="__codelineno-3-125" name="__codelineno-3-125" href="#__codelineno-3-125"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">blocked_ips</span><span class="p">:</span> <span class="nb">set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="__span-3-126"><a id="__codelineno-3-126" name="__codelineno-3-126" href="#__codelineno-3-126"></a>
</span><span id="__span-3-127"><a id="__codelineno-3-127" name="__codelineno-3-127" href="#__codelineno-3-127"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">analyze_request_pattern</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ip_address</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
</span><span id="__span-3-128"><a id="__codelineno-3-128" name="__codelineno-3-128" href="#__codelineno-3-128"></a>                              <span class="n">user_agent</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="__span-3-129"><a id="__codelineno-3-129" name="__codelineno-3-129" href="#__codelineno-3-129"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Analyze request patterns for DDoS indicators&quot;&quot;&quot;</span>
</span><span id="__span-3-130"><a id="__codelineno-3-130" name="__codelineno-3-130" href="#__codelineno-3-130"></a>
</span><span id="__span-3-131"><a id="__codelineno-3-131" name="__codelineno-3-131" href="#__codelineno-3-131"></a>        <span class="c1"># Check if IP is already blocked</span>
</span><span id="__span-3-132"><a id="__codelineno-3-132" name="__codelineno-3-132" href="#__codelineno-3-132"></a>        <span class="k">if</span> <span class="n">ip_address</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">blocked_ips</span><span class="p">:</span>
</span><span id="__span-3-133"><a id="__codelineno-3-133" name="__codelineno-3-133" href="#__codelineno-3-133"></a>            <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-3-134"><a id="__codelineno-3-134" name="__codelineno-3-134" href="#__codelineno-3-134"></a>                <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="s2">&quot;block&quot;</span><span class="p">,</span>
</span><span id="__span-3-135"><a id="__codelineno-3-135" name="__codelineno-3-135" href="#__codelineno-3-135"></a>                <span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="s2">&quot;IP previously blocked for suspicious activity&quot;</span>
</span><span id="__span-3-136"><a id="__codelineno-3-136" name="__codelineno-3-136" href="#__codelineno-3-136"></a>            <span class="p">}</span>
</span><span id="__span-3-137"><a id="__codelineno-3-137" name="__codelineno-3-137" href="#__codelineno-3-137"></a>
</span><span id="__span-3-138"><a id="__codelineno-3-138" name="__codelineno-3-138" href="#__codelineno-3-138"></a>        <span class="c1"># Progressive rate limiting based on suspicion level</span>
</span><span id="__span-3-139"><a id="__codelineno-3-139" name="__codelineno-3-139" href="#__codelineno-3-139"></a>        <span class="n">suspicion_level</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_suspicion_level</span><span class="p">(</span><span class="n">ip_address</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">,</span> <span class="n">user_agent</span><span class="p">)</span>
</span><span id="__span-3-140"><a id="__codelineno-3-140" name="__codelineno-3-140" href="#__codelineno-3-140"></a>
</span><span id="__span-3-141"><a id="__codelineno-3-141" name="__codelineno-3-141" href="#__codelineno-3-141"></a>        <span class="k">if</span> <span class="n">suspicion_level</span> <span class="o">==</span> <span class="s2">&quot;low&quot;</span><span class="p">:</span>
</span><span id="__span-3-142"><a id="__codelineno-3-142" name="__codelineno-3-142" href="#__codelineno-3-142"></a>            <span class="n">allowed</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate_limiter</span><span class="o">.</span><span class="n">is_allowed</span><span class="p">(</span><span class="n">ip_address</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="__span-3-143"><a id="__codelineno-3-143" name="__codelineno-3-143" href="#__codelineno-3-143"></a>            <span class="n">requests_per_second</span> <span class="o">=</span> <span class="mi">100</span>
</span><span id="__span-3-144"><a id="__codelineno-3-144" name="__codelineno-3-144" href="#__codelineno-3-144"></a>        <span class="k">elif</span> <span class="n">suspicion_level</span> <span class="o">==</span> <span class="s2">&quot;medium&quot;</span><span class="p">:</span>
</span><span id="__span-3-145"><a id="__codelineno-3-145" name="__codelineno-3-145" href="#__codelineno-3-145"></a>            <span class="n">allowed</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate_limiter</span><span class="o">.</span><span class="n">sliding_window_check</span><span class="p">(</span><span class="n">ip_address</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>
</span><span id="__span-3-146"><a id="__codelineno-3-146" name="__codelineno-3-146" href="#__codelineno-3-146"></a>            <span class="n">requests_per_second</span> <span class="o">=</span> <span class="mi">10</span>
</span><span id="__span-3-147"><a id="__codelineno-3-147" name="__codelineno-3-147" href="#__codelineno-3-147"></a>        <span class="k">else</span><span class="p">:</span>  <span class="c1"># high suspicion</span>
</span><span id="__span-3-148"><a id="__codelineno-3-148" name="__codelineno-3-148" href="#__codelineno-3-148"></a>            <span class="n">allowed</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate_limiter</span><span class="o">.</span><span class="n">sliding_window_check</span><span class="p">(</span><span class="n">ip_address</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
</span><span id="__span-3-149"><a id="__codelineno-3-149" name="__codelineno-3-149" href="#__codelineno-3-149"></a>            <span class="n">requests_per_second</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="__span-3-150"><a id="__codelineno-3-150" name="__codelineno-3-150" href="#__codelineno-3-150"></a>
</span><span id="__span-3-151"><a id="__codelineno-3-151" name="__codelineno-3-151" href="#__codelineno-3-151"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">allowed</span><span class="p">:</span>
</span><span id="__span-3-152"><a id="__codelineno-3-152" name="__codelineno-3-152" href="#__codelineno-3-152"></a>            <span class="c1"># Track consecutive violations</span>
</span><span id="__span-3-153"><a id="__codelineno-3-153" name="__codelineno-3-153" href="#__codelineno-3-153"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_track_violation</span><span class="p">(</span><span class="n">ip_address</span><span class="p">)</span>
</span><span id="__span-3-154"><a id="__codelineno-3-154" name="__codelineno-3-154" href="#__codelineno-3-154"></a>
</span><span id="__span-3-155"><a id="__codelineno-3-155" name="__codelineno-3-155" href="#__codelineno-3-155"></a>            <span class="c1"># Check if IP should be blocked</span>
</span><span id="__span-3-156"><a id="__codelineno-3-156" name="__codelineno-3-156" href="#__codelineno-3-156"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_should_block_ip</span><span class="p">(</span><span class="n">ip_address</span><span class="p">):</span>
</span><span id="__span-3-157"><a id="__codelineno-3-157" name="__codelineno-3-157" href="#__codelineno-3-157"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">blocked_ips</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ip_address</span><span class="p">)</span>
</span><span id="__span-3-158"><a id="__codelineno-3-158" name="__codelineno-3-158" href="#__codelineno-3-158"></a>                <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-3-159"><a id="__codelineno-3-159" name="__codelineno-3-159" href="#__codelineno-3-159"></a>                    <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="s2">&quot;block&quot;</span><span class="p">,</span>
</span><span id="__span-3-160"><a id="__codelineno-3-160" name="__codelineno-3-160" href="#__codelineno-3-160"></a>                    <span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="s2">&quot;Too many rate limit violations&quot;</span>
</span><span id="__span-3-161"><a id="__codelineno-3-161" name="__codelineno-3-161" href="#__codelineno-3-161"></a>                <span class="p">}</span>
</span><span id="__span-3-162"><a id="__codelineno-3-162" name="__codelineno-3-162" href="#__codelineno-3-162"></a>
</span><span id="__span-3-163"><a id="__codelineno-3-163" name="__codelineno-3-163" href="#__codelineno-3-163"></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-3-164"><a id="__codelineno-3-164" name="__codelineno-3-164" href="#__codelineno-3-164"></a>            <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="s2">&quot;allow&quot;</span> <span class="k">if</span> <span class="n">allowed</span> <span class="k">else</span> <span class="s2">&quot;rate_limit&quot;</span><span class="p">,</span>
</span><span id="__span-3-165"><a id="__codelineno-3-165" name="__codelineno-3-165" href="#__codelineno-3-165"></a>            <span class="s2">&quot;suspicion_level&quot;</span><span class="p">:</span> <span class="n">suspicion_level</span><span class="p">,</span>
</span><span id="__span-3-166"><a id="__codelineno-3-166" name="__codelineno-3-166" href="#__codelineno-3-166"></a>            <span class="s2">&quot;rate_info&quot;</span><span class="p">:</span> <span class="n">info</span>
</span><span id="__span-3-167"><a id="__codelineno-3-167" name="__codelineno-3-167" href="#__codelineno-3-167"></a>        <span class="p">}</span>
</span><span id="__span-3-168"><a id="__codelineno-3-168" name="__codelineno-3-168" href="#__codelineno-3-168"></a>
</span><span id="__span-3-169"><a id="__codelineno-3-169" name="__codelineno-3-169" href="#__codelineno-3-169"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_calculate_suspicion_level</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ip_address</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
</span><span id="__span-3-170"><a id="__codelineno-3-170" name="__codelineno-3-170" href="#__codelineno-3-170"></a>                                 <span class="n">user_agent</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="__span-3-171"><a id="__codelineno-3-171" name="__codelineno-3-171" href="#__codelineno-3-171"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate suspicion level based on various factors&quot;&quot;&quot;</span>
</span><span id="__span-3-172"><a id="__codelineno-3-172" name="__codelineno-3-172" href="#__codelineno-3-172"></a>
</span><span id="__span-3-173"><a id="__codelineno-3-173" name="__codelineno-3-173" href="#__codelineno-3-173"></a>        <span class="n">suspicion_score</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="__span-3-174"><a id="__codelineno-3-174" name="__codelineno-3-174" href="#__codelineno-3-174"></a>
</span><span id="__span-3-175"><a id="__codelineno-3-175" name="__codelineno-3-175" href="#__codelineno-3-175"></a>        <span class="c1"># Check user agent</span>
</span><span id="__span-3-176"><a id="__codelineno-3-176" name="__codelineno-3-176" href="#__codelineno-3-176"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">user_agent</span> <span class="ow">or</span> <span class="n">user_agent</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;curl&quot;</span><span class="p">,</span> <span class="s2">&quot;wget&quot;</span><span class="p">,</span> <span class="s2">&quot;python-requests&quot;</span><span class="p">]:</span>
</span><span id="__span-3-177"><a id="__codelineno-3-177" name="__codelineno-3-177" href="#__codelineno-3-177"></a>            <span class="n">suspicion_score</span> <span class="o">+=</span> <span class="mi">2</span>
</span><span id="__span-3-178"><a id="__codelineno-3-178" name="__codelineno-3-178" href="#__codelineno-3-178"></a>
</span><span id="__span-3-179"><a id="__codelineno-3-179" name="__codelineno-3-179" href="#__codelineno-3-179"></a>        <span class="c1"># Check for suspicious endpoints</span>
</span><span id="__span-3-180"><a id="__codelineno-3-180" name="__codelineno-3-180" href="#__codelineno-3-180"></a>        <span class="n">suspicious_endpoints</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;/admin&quot;</span><span class="p">,</span> <span class="s2">&quot;/login&quot;</span><span class="p">,</span> <span class="s2">&quot;/api/auth&quot;</span><span class="p">,</span> <span class="s2">&quot;/.env&quot;</span><span class="p">,</span> <span class="s2">&quot;/config&quot;</span><span class="p">]</span>
</span><span id="__span-3-181"><a id="__codelineno-3-181" name="__codelineno-3-181" href="#__codelineno-3-181"></a>        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">suspicious</span> <span class="ow">in</span> <span class="n">endpoint</span> <span class="k">for</span> <span class="n">suspicious</span> <span class="ow">in</span> <span class="n">suspicious_endpoints</span><span class="p">):</span>
</span><span id="__span-3-182"><a id="__codelineno-3-182" name="__codelineno-3-182" href="#__codelineno-3-182"></a>            <span class="n">suspicion_score</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="__span-3-183"><a id="__codelineno-3-183" name="__codelineno-3-183" href="#__codelineno-3-183"></a>
</span><span id="__span-3-184"><a id="__codelineno-3-184" name="__codelineno-3-184" href="#__codelineno-3-184"></a>        <span class="c1"># Check request frequency from this IP</span>
</span><span id="__span-3-185"><a id="__codelineno-3-185" name="__codelineno-3-185" href="#__codelineno-3-185"></a>        <span class="k">if</span> <span class="n">ip_address</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate_limiter</span><span class="o">.</span><span class="n">request_history</span><span class="p">:</span>
</span><span id="__span-3-186"><a id="__codelineno-3-186" name="__codelineno-3-186" href="#__codelineno-3-186"></a>            <span class="n">recent_requests</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rate_limiter</span><span class="o">.</span><span class="n">request_history</span><span class="p">[</span><span class="n">ip_address</span><span class="p">])</span>
</span><span id="__span-3-187"><a id="__codelineno-3-187" name="__codelineno-3-187" href="#__codelineno-3-187"></a>            <span class="k">if</span> <span class="n">recent_requests</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">:</span>  <span class="c1"># Very high frequency</span>
</span><span id="__span-3-188"><a id="__codelineno-3-188" name="__codelineno-3-188" href="#__codelineno-3-188"></a>                <span class="n">suspicion_score</span> <span class="o">+=</span> <span class="mi">3</span>
</span><span id="__span-3-189"><a id="__codelineno-3-189" name="__codelineno-3-189" href="#__codelineno-3-189"></a>            <span class="k">elif</span> <span class="n">recent_requests</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span>
</span><span id="__span-3-190"><a id="__codelineno-3-190" name="__codelineno-3-190" href="#__codelineno-3-190"></a>                <span class="n">suspicion_score</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="__span-3-191"><a id="__codelineno-3-191" name="__codelineno-3-191" href="#__codelineno-3-191"></a>
</span><span id="__span-3-192"><a id="__codelineno-3-192" name="__codelineno-3-192" href="#__codelineno-3-192"></a>        <span class="c1"># Determine level</span>
</span><span id="__span-3-193"><a id="__codelineno-3-193" name="__codelineno-3-193" href="#__codelineno-3-193"></a>        <span class="k">if</span> <span class="n">suspicion_score</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">:</span>
</span><span id="__span-3-194"><a id="__codelineno-3-194" name="__codelineno-3-194" href="#__codelineno-3-194"></a>            <span class="k">return</span> <span class="s2">&quot;high&quot;</span>
</span><span id="__span-3-195"><a id="__codelineno-3-195" name="__codelineno-3-195" href="#__codelineno-3-195"></a>        <span class="k">elif</span> <span class="n">suspicion_score</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="__span-3-196"><a id="__codelineno-3-196" name="__codelineno-3-196" href="#__codelineno-3-196"></a>            <span class="k">return</span> <span class="s2">&quot;medium&quot;</span>
</span><span id="__span-3-197"><a id="__codelineno-3-197" name="__codelineno-3-197" href="#__codelineno-3-197"></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="__span-3-198"><a id="__codelineno-3-198" name="__codelineno-3-198" href="#__codelineno-3-198"></a>            <span class="k">return</span> <span class="s2">&quot;low&quot;</span>
</span><span id="__span-3-199"><a id="__codelineno-3-199" name="__codelineno-3-199" href="#__codelineno-3-199"></a>
</span><span id="__span-3-200"><a id="__codelineno-3-200" name="__codelineno-3-200" href="#__codelineno-3-200"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_track_violation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ip_address</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="__span-3-201"><a id="__codelineno-3-201" name="__codelineno-3-201" href="#__codelineno-3-201"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Track rate limit violations&quot;&quot;&quot;</span>
</span><span id="__span-3-202"><a id="__codelineno-3-202" name="__codelineno-3-202" href="#__codelineno-3-202"></a>        <span class="k">if</span> <span class="n">ip_address</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">suspicious_ips</span><span class="p">:</span>
</span><span id="__span-3-203"><a id="__codelineno-3-203" name="__codelineno-3-203" href="#__codelineno-3-203"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">suspicious_ips</span><span class="p">[</span><span class="n">ip_address</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-3-204"><a id="__codelineno-3-204" name="__codelineno-3-204" href="#__codelineno-3-204"></a>                <span class="s2">&quot;violations&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="__span-3-205"><a id="__codelineno-3-205" name="__codelineno-3-205" href="#__codelineno-3-205"></a>                <span class="s2">&quot;first_violation&quot;</span><span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="__span-3-206"><a id="__codelineno-3-206" name="__codelineno-3-206" href="#__codelineno-3-206"></a>            <span class="p">}</span>
</span><span id="__span-3-207"><a id="__codelineno-3-207" name="__codelineno-3-207" href="#__codelineno-3-207"></a>
</span><span id="__span-3-208"><a id="__codelineno-3-208" name="__codelineno-3-208" href="#__codelineno-3-208"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">suspicious_ips</span><span class="p">[</span><span class="n">ip_address</span><span class="p">][</span><span class="s2">&quot;violations&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="__span-3-209"><a id="__codelineno-3-209" name="__codelineno-3-209" href="#__codelineno-3-209"></a>
</span><span id="__span-3-210"><a id="__codelineno-3-210" name="__codelineno-3-210" href="#__codelineno-3-210"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_should_block_ip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ip_address</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="__span-3-211"><a id="__codelineno-3-211" name="__codelineno-3-211" href="#__codelineno-3-211"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Determine if IP should be blocked&quot;&quot;&quot;</span>
</span><span id="__span-3-212"><a id="__codelineno-3-212" name="__codelineno-3-212" href="#__codelineno-3-212"></a>        <span class="k">if</span> <span class="n">ip_address</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">suspicious_ips</span><span class="p">:</span>
</span><span id="__span-3-213"><a id="__codelineno-3-213" name="__codelineno-3-213" href="#__codelineno-3-213"></a>            <span class="k">return</span> <span class="kc">False</span>
</span><span id="__span-3-214"><a id="__codelineno-3-214" name="__codelineno-3-214" href="#__codelineno-3-214"></a>
</span><span id="__span-3-215"><a id="__codelineno-3-215" name="__codelineno-3-215" href="#__codelineno-3-215"></a>        <span class="n">violations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">suspicious_ips</span><span class="p">[</span><span class="n">ip_address</span><span class="p">][</span><span class="s2">&quot;violations&quot;</span><span class="p">]</span>
</span><span id="__span-3-216"><a id="__codelineno-3-216" name="__codelineno-3-216" href="#__codelineno-3-216"></a>        <span class="n">first_violation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">suspicious_ips</span><span class="p">[</span><span class="n">ip_address</span><span class="p">][</span><span class="s2">&quot;first_violation&quot;</span><span class="p">]</span>
</span><span id="__span-3-217"><a id="__codelineno-3-217" name="__codelineno-3-217" href="#__codelineno-3-217"></a>
</span><span id="__span-3-218"><a id="__codelineno-3-218" name="__codelineno-3-218" href="#__codelineno-3-218"></a>        <span class="c1"># Block if more than 10 violations in the last hour</span>
</span><span id="__span-3-219"><a id="__codelineno-3-219" name="__codelineno-3-219" href="#__codelineno-3-219"></a>        <span class="k">if</span> <span class="n">violations</span> <span class="o">&gt;</span> <span class="mi">10</span> <span class="ow">and</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">first_violation</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3600</span><span class="p">:</span>
</span><span id="__span-3-220"><a id="__codelineno-3-220" name="__codelineno-3-220" href="#__codelineno-3-220"></a>            <span class="k">return</span> <span class="kc">True</span>
</span><span id="__span-3-221"><a id="__codelineno-3-221" name="__codelineno-3-221" href="#__codelineno-3-221"></a>
</span><span id="__span-3-222"><a id="__codelineno-3-222" name="__codelineno-3-222" href="#__codelineno-3-222"></a>        <span class="k">return</span> <span class="kc">False</span>
</span><span id="__span-3-223"><a id="__codelineno-3-223" name="__codelineno-3-223" href="#__codelineno-3-223"></a>
</span><span id="__span-3-224"><a id="__codelineno-3-224" name="__codelineno-3-224" href="#__codelineno-3-224"></a><span class="k">def</span><span class="w"> </span><span class="nf">rate_limiting_example</span><span class="p">():</span>
</span><span id="__span-3-225"><a id="__codelineno-3-225" name="__codelineno-3-225" href="#__codelineno-3-225"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Demonstrate rate limiting and DDoS protection&quot;&quot;&quot;</span>
</span><span id="__span-3-226"><a id="__codelineno-3-226" name="__codelineno-3-226" href="#__codelineno-3-226"></a>
</span><span id="__span-3-227"><a id="__codelineno-3-227" name="__codelineno-3-227" href="#__codelineno-3-227"></a>    <span class="c1"># Initialize protection systems</span>
</span><span id="__span-3-228"><a id="__codelineno-3-228" name="__codelineno-3-228" href="#__codelineno-3-228"></a>    <span class="n">rate_limiter</span> <span class="o">=</span> <span class="n">RateLimiter</span><span class="p">()</span>
</span><span id="__span-3-229"><a id="__codelineno-3-229" name="__codelineno-3-229" href="#__codelineno-3-229"></a>    <span class="n">ddos_protection</span> <span class="o">=</span> <span class="n">DDoSProtection</span><span class="p">()</span>
</span><span id="__span-3-230"><a id="__codelineno-3-230" name="__codelineno-3-230" href="#__codelineno-3-230"></a>
</span><span id="__span-3-231"><a id="__codelineno-3-231" name="__codelineno-3-231" href="#__codelineno-3-231"></a>    <span class="c1"># Create rate limits for different users</span>
</span><span id="__span-3-232"><a id="__codelineno-3-232" name="__codelineno-3-232" href="#__codelineno-3-232"></a>    <span class="n">rate_limiter</span><span class="o">.</span><span class="n">create_rate_limit</span><span class="p">(</span><span class="s2">&quot;api_key_123&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>  <span class="c1"># 10 req/sec, burst 50</span>
</span><span id="__span-3-233"><a id="__codelineno-3-233" name="__codelineno-3-233" href="#__codelineno-3-233"></a>    <span class="n">rate_limiter</span><span class="o">.</span><span class="n">create_rate_limit</span><span class="p">(</span><span class="s2">&quot;premium_user&quot;</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>  <span class="c1"># Higher limits</span>
</span><span id="__span-3-234"><a id="__codelineno-3-234" name="__codelineno-3-234" href="#__codelineno-3-234"></a>
</span><span id="__span-3-235"><a id="__codelineno-3-235" name="__codelineno-3-235" href="#__codelineno-3-235"></a>    <span class="c1"># Simulate API requests</span>
</span><span id="__span-3-236"><a id="__codelineno-3-236" name="__codelineno-3-236" href="#__codelineno-3-236"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">simulate_api_request</span><span class="p">(</span><span class="n">identifier</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">ip_address</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="__span-3-237"><a id="__codelineno-3-237" name="__codelineno-3-237" href="#__codelineno-3-237"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Simulate an API request with rate limiting&quot;&quot;&quot;</span>
</span><span id="__span-3-238"><a id="__codelineno-3-238" name="__codelineno-3-238" href="#__codelineno-3-238"></a>
</span><span id="__span-3-239"><a id="__codelineno-3-239" name="__codelineno-3-239" href="#__codelineno-3-239"></a>        <span class="c1"># Check DDoS protection</span>
</span><span id="__span-3-240"><a id="__codelineno-3-240" name="__codelineno-3-240" href="#__codelineno-3-240"></a>        <span class="n">ddos_result</span> <span class="o">=</span> <span class="n">ddos_protection</span><span class="o">.</span><span class="n">analyze_request_pattern</span><span class="p">(</span>
</span><span id="__span-3-241"><a id="__codelineno-3-241" name="__codelineno-3-241" href="#__codelineno-3-241"></a>            <span class="n">ip_address</span><span class="o">=</span><span class="n">ip_address</span><span class="p">,</span>
</span><span id="__span-3-242"><a id="__codelineno-3-242" name="__codelineno-3-242" href="#__codelineno-3-242"></a>            <span class="n">endpoint</span><span class="o">=</span><span class="s2">&quot;/api/data&quot;</span><span class="p">,</span>
</span><span id="__span-3-243"><a id="__codelineno-3-243" name="__codelineno-3-243" href="#__codelineno-3-243"></a>            <span class="n">user_agent</span><span class="o">=</span><span class="s2">&quot;Mozilla/5.0 (legitimate browser)&quot;</span>
</span><span id="__span-3-244"><a id="__codelineno-3-244" name="__codelineno-3-244" href="#__codelineno-3-244"></a>        <span class="p">)</span>
</span><span id="__span-3-245"><a id="__codelineno-3-245" name="__codelineno-3-245" href="#__codelineno-3-245"></a>
</span><span id="__span-3-246"><a id="__codelineno-3-246" name="__codelineno-3-246" href="#__codelineno-3-246"></a>        <span class="k">if</span> <span class="n">ddos_result</span><span class="p">[</span><span class="s2">&quot;action&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;block&quot;</span><span class="p">:</span>
</span><span id="__span-3-247"><a id="__codelineno-3-247" name="__codelineno-3-247" href="#__codelineno-3-247"></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="mi">403</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">ddos_result</span><span class="p">[</span><span class="s2">&quot;reason&quot;</span><span class="p">]}</span>
</span><span id="__span-3-248"><a id="__codelineno-3-248" name="__codelineno-3-248" href="#__codelineno-3-248"></a>
</span><span id="__span-3-249"><a id="__codelineno-3-249" name="__codelineno-3-249" href="#__codelineno-3-249"></a>        <span class="c1"># Check rate limiting</span>
</span><span id="__span-3-250"><a id="__codelineno-3-250" name="__codelineno-3-250" href="#__codelineno-3-250"></a>        <span class="n">allowed</span><span class="p">,</span> <span class="n">rate_info</span> <span class="o">=</span> <span class="n">rate_limiter</span><span class="o">.</span><span class="n">is_allowed</span><span class="p">(</span><span class="n">identifier</span><span class="p">)</span>
</span><span id="__span-3-251"><a id="__codelineno-3-251" name="__codelineno-3-251" href="#__codelineno-3-251"></a>
</span><span id="__span-3-252"><a id="__codelineno-3-252" name="__codelineno-3-252" href="#__codelineno-3-252"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">allowed</span><span class="p">:</span>
</span><span id="__span-3-253"><a id="__codelineno-3-253" name="__codelineno-3-253" href="#__codelineno-3-253"></a>            <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-3-254"><a id="__codelineno-3-254" name="__codelineno-3-254" href="#__codelineno-3-254"></a>                <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="mi">429</span><span class="p">,</span>
</span><span id="__span-3-255"><a id="__codelineno-3-255" name="__codelineno-3-255" href="#__codelineno-3-255"></a>                <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Rate limit exceeded&quot;</span><span class="p">,</span>
</span><span id="__span-3-256"><a id="__codelineno-3-256" name="__codelineno-3-256" href="#__codelineno-3-256"></a>                <span class="s2">&quot;retry_after&quot;</span><span class="p">:</span> <span class="n">rate_info</span><span class="p">[</span><span class="s2">&quot;retry_after&quot;</span><span class="p">]</span>
</span><span id="__span-3-257"><a id="__codelineno-3-257" name="__codelineno-3-257" href="#__codelineno-3-257"></a>            <span class="p">}</span>
</span><span id="__span-3-258"><a id="__codelineno-3-258" name="__codelineno-3-258" href="#__codelineno-3-258"></a>
</span><span id="__span-3-259"><a id="__codelineno-3-259" name="__codelineno-3-259" href="#__codelineno-3-259"></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-3-260"><a id="__codelineno-3-260" name="__codelineno-3-260" href="#__codelineno-3-260"></a>            <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
</span><span id="__span-3-261"><a id="__codelineno-3-261" name="__codelineno-3-261" href="#__codelineno-3-261"></a>            <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="s2">&quot;API response data&quot;</span><span class="p">,</span>
</span><span id="__span-3-262"><a id="__codelineno-3-262" name="__codelineno-3-262" href="#__codelineno-3-262"></a>            <span class="s2">&quot;rate_limit_remaining&quot;</span><span class="p">:</span> <span class="n">rate_info</span><span class="p">[</span><span class="s2">&quot;remaining_tokens&quot;</span><span class="p">]</span>
</span><span id="__span-3-263"><a id="__codelineno-3-263" name="__codelineno-3-263" href="#__codelineno-3-263"></a>        <span class="p">}</span>
</span><span id="__span-3-264"><a id="__codelineno-3-264" name="__codelineno-3-264" href="#__codelineno-3-264"></a>
</span><span id="__span-3-265"><a id="__codelineno-3-265" name="__codelineno-3-265" href="#__codelineno-3-265"></a>    <span class="c1"># Test normal usage</span>
</span><span id="__span-3-266"><a id="__codelineno-3-266" name="__codelineno-3-266" href="#__codelineno-3-266"></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
</span><span id="__span-3-267"><a id="__codelineno-3-267" name="__codelineno-3-267" href="#__codelineno-3-267"></a>        <span class="n">result</span> <span class="o">=</span> <span class="n">simulate_api_request</span><span class="p">(</span><span class="s2">&quot;api_key_123&quot;</span><span class="p">,</span> <span class="s2">&quot;192.168.1.100&quot;</span><span class="p">)</span>
</span><span id="__span-3-268"><a id="__codelineno-3-268" name="__codelineno-3-268" href="#__codelineno-3-268"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Request </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-3-269"><a id="__codelineno-3-269" name="__codelineno-3-269" href="#__codelineno-3-269"></a>        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>  <span class="c1"># Small delay between requests</span>
</span><span id="__span-3-270"><a id="__codelineno-3-270" name="__codelineno-3-270" href="#__codelineno-3-270"></a>
</span><span id="__span-3-271"><a id="__codelineno-3-271" name="__codelineno-3-271" href="#__codelineno-3-271"></a>    <span class="c1"># Test rate limit exceeded</span>
</span><span id="__span-3-272"><a id="__codelineno-3-272" name="__codelineno-3-272" href="#__codelineno-3-272"></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">60</span><span class="p">):</span>  <span class="c1"># Try to exceed rate limit</span>
</span><span id="__span-3-273"><a id="__codelineno-3-273" name="__codelineno-3-273" href="#__codelineno-3-273"></a>        <span class="n">result</span> <span class="o">=</span> <span class="n">simulate_api_request</span><span class="p">(</span><span class="s2">&quot;api_key_123&quot;</span><span class="p">,</span> <span class="s2">&quot;192.168.1.100&quot;</span><span class="p">)</span>
</span><span id="__span-3-274"><a id="__codelineno-3-274" name="__codelineno-3-274" href="#__codelineno-3-274"></a>        <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">429</span><span class="p">:</span>
</span><span id="__span-3-275"><a id="__codelineno-3-275" name="__codelineno-3-275" href="#__codelineno-3-275"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Rate limited after </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2"> rapid requests&quot;</span><span class="p">)</span>
</span><span id="__span-3-276"><a id="__codelineno-3-276" name="__codelineno-3-276" href="#__codelineno-3-276"></a>            <span class="k">break</span>
</span><span id="__span-3-277"><a id="__codelineno-3-277" name="__codelineno-3-277" href="#__codelineno-3-277"></a>
</span><span id="__span-3-278"><a id="__codelineno-3-278" name="__codelineno-3-278" href="#__codelineno-3-278"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
</span><span id="__span-3-279"><a id="__codelineno-3-279" name="__codelineno-3-279" href="#__codelineno-3-279"></a>    <span class="n">rate_limiting_example</span><span class="p">()</span>
</span></code></pre></div>
<h2 id="secure-session-management">Secure Session Management<a class="headerlink" href="#secure-session-management" title="Permanent link">&para;</a></h2>
<p>Session management is critical for maintaining authenticated <span class="glossary-term" data-glossary-category="OOP" data-glossary-definition="The set of values of all attributes of an object at a particular point in time during program execution." data-glossary-term="State">state</span> between <span class="glossary-term" data-glossary-category="Web Development" data-glossary-definition="A set of protocols and tools for building software applications, defining how components interact." data-glossary-full-form="Application Programming Interface" data-glossary-term="API">API</span> requests while preventing session-related attacks.</p>
<h3 id="session-security-principles">Session Security Principles<a class="headerlink" href="#session-security-principles" title="Permanent link">&para;</a></h3>
<div class="diagram-container" data-container-id="kroki-diagram-1"><button class="diagram-expand-btn" onclick="openDiagramModal('kroki-diagram-1')">🔍 View Larger</button><div id="kroki-diagram-1" class="diagram-content"><p><svg xmlns="http://www.w3.org/2000/svg" contentStyleType="text/css" data-diagram-type="SEQUENCE" height="533px" preserveAspectRatio="xMaxYMax meet" style="width:622px;height:533px;background:#FFFFFF;" version="1.1" viewBox="0 0 622 533" width="622px" zoomAndPan="magnify" id="Kroki" data-diagram-id="kroki-svg-1"><defs /><g><g><title>Client</title><rect fill="#000000" fill-opacity="0.00000" height="462.125" width="8" x="52.2651" y="36.2969" /><line style="stroke:#000000;stroke-width:1;" x1="56" x2="56" y1="36.2969" y2="498.4219" /></g><g><title><span class="glossary-term" data-glossary-category="Web Development" data-glossary-definition="A set of protocols and tools for building software applications, defining how components interact." data-glossary-full-form="Application Programming Interface" data-glossary-term="API">API</span> Gateway</title><rect fill="#000000" fill-opacity="0.00000" height="462.125" width="8" x="300.1533" y="36.2969" /><line style="stroke:#000000;stroke-width:1;" x1="303.9316" x2="303.9316" y1="36.2969" y2="498.4219" /></g><g><title>Session Store</title><rect fill="#000000" fill-opacity="0.00000" height="462.125" width="8" x="435.9634" y="36.2969" /><line style="stroke:#000000;stroke-width:1;" x1="439.375" x2="439.375" y1="36.2969" y2="498.4219" /></g><g><title><span class="glossary-term" data-glossary-category="Web Development" data-glossary-definition="A set of protocols and tools for building software applications, defining how components interact." data-glossary-full-form="Application Programming Interface" data-glossary-term="API">API</span> Service</title><rect fill="#000000" fill-opacity="0.00000" height="462.125" width="8" x="566.7217" y="36.2969" /><line style="stroke:#000000;stroke-width:1;" x1="570.5518" x2="570.5518" y1="36.2969" y2="498.4219" /></g><g class="participant participant-head" data-participant="Client"><rect fill="#FFFFFF" height="30.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="54.5303" x="29" y="5" /><text fill="#000000" font-family="Arial" font-size="14" lengthAdjust="spacing" textLength="40.5303" x="36" y="24.9951">Client</text></g><g class="participant participant-tail" data-participant="Client"><rect fill="#FFFFFF" height="30.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="54.5303" x="29" y="497.4219" /><text fill="#000000" font-family="Arial" font-size="14" lengthAdjust="spacing" textLength="40.5303" x="36" y="517.417">Client</text></g><g class="participant participant-head" data-participant="Gateway"><rect fill="#FFFFFF" height="30.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="102.4434" x="252.9316" y="5" /><text fill="#000000" font-family="Arial" font-size="14" lengthAdjust="spacing" textLength="88.4434" x="259.9316" y="24.9951"><span class="glossary-term" data-glossary-category="Web Development" data-glossary-definition="A set of protocols and tools for building software applications, defining how components interact." data-glossary-full-form="Application Programming Interface" data-glossary-term="API">API</span> Gateway</text></g><g class="participant participant-tail" data-participant="Gateway"><rect fill="#FFFFFF" height="30.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="102.4434" x="252.9316" y="497.4219" /><text fill="#000000" font-family="Arial" font-size="14" lengthAdjust="spacing" textLength="88.4434" x="259.9316" y="517.417"><span class="glossary-term" data-glossary-category="Web Development" data-glossary-definition="A set of protocols and tools for building software applications, defining how components interact." data-glossary-full-form="Application Programming Interface" data-glossary-term="API">API</span> Gateway</text></g><g class="participant participant-head" data-participant="Session"><rect fill="#FFFFFF" height="30.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="109.1768" x="385.375" y="5" /><text fill="#000000" font-family="Arial" font-size="14" lengthAdjust="spacing" textLength="95.1768" x="392.375" y="24.9951">Session Store</text></g><g class="participant participant-tail" data-participant="Session"><rect fill="#FFFFFF" height="30.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="109.1768" x="385.375" y="497.4219" /><text fill="#000000" font-family="Arial" font-size="14" lengthAdjust="spacing" textLength="95.1768" x="392.375" y="517.417">Session Store</text></g><g class="participant participant-head" data-participant="API"><rect fill="#FFFFFF" height="30.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="92.3398" x="524.5518" y="5" /><text fill="#000000" font-family="Arial" font-size="14" lengthAdjust="spacing" textLength="78.3398" x="531.5518" y="24.9951"><span class="glossary-term" data-glossary-category="Web Development" data-glossary-definition="A set of protocols and tools for building software applications, defining how components interact." data-glossary-full-form="Application Programming Interface" data-glossary-term="API">API</span> Service</text></g><g class="participant participant-tail" data-participant="API"><rect fill="#FFFFFF" height="30.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="92.3398" x="524.5518" y="497.4219" /><text fill="#000000" font-family="Arial" font-size="14" lengthAdjust="spacing" textLength="78.3398" x="531.5518" y="517.417"><span class="glossary-term" data-glossary-category="Web Development" data-glossary-definition="A set of protocols and tools for building software applications, defining how components interact." data-glossary-full-form="Application Programming Interface" data-glossary-term="API">API</span> Service</text></g><g class="message" data-participant-1="Client" data-participant-2="Gateway"><polygon fill="#000000" points="292.1533,63.4297,302.1533,67.4297,292.1533,71.4297,296.1533,67.4297" style="stroke:#000000;stroke-width:1;" /><line style="stroke:#000000;stroke-width:1;" x1="56.2651" x2="298.1533" y1="67.4297" y2="67.4297" /><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="92.8218" x="63.2651" y="62.3638">Login Request</text></g><g class="message" data-participant-1="Gateway" data-participant-2="Session"><polygon fill="#000000" points="427.9634,92.5625,437.9634,96.5625,427.9634,100.5625,431.9634,96.5625" style="stroke:#000000;stroke-width:1;" /><line style="stroke:#000000;stroke-width:1;" x1="304.1533" x2="433.9634" y1="96.5625" y2="96.5625" /><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="97.2144" x="311.1533" y="91.4966">Create Session</text></g><g class="message" data-participant-1="Session" data-participant-2="Gateway"><polygon fill="#000000" points="315.1533,121.6953,305.1533,125.6953,315.1533,129.6953,311.1533,125.6953" style="stroke:#000000;stroke-width:1;" /><line style="stroke:#000000;stroke-width:1;" x1="309.1533" x2="438.9634" y1="125.6953" y2="125.6953" /><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="67.5771" x="321.1533" y="120.6294">Session ID</text></g><g class="message" data-participant-1="Gateway" data-participant-2="Client"><polygon fill="#000000" points="67.2651,150.8281,57.2651,154.8281,67.2651,158.8281,63.2651,154.8281" style="stroke:#000000;stroke-width:1;" /><line style="stroke:#000000;stroke-width:1;" x1="61.2651" x2="303.1533" y1="154.8281" y2="154.8281" /><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="223.8882" x="73.2651" y="149.7622">Session Token (<span class="glossary-term" data-glossary-category="Web Development" data-glossary-definition="The foundation protocol for data communication on the World Wide Web." data-glossary-full-form="Hypertext Transfer Protocol" data-glossary-term="HTTP">HTTP</span>-Only Cookie)</text></g><path d="M10,167.8281 L10,192.8281 L351,192.8281 L351,177.8281 L341,167.8281 L10,167.8281" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;" /><path d="M341,167.8281 L341,177.8281 L351,177.8281 L341,167.8281" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;" /><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="166.334" x="93.0205" y="184.895">Subsequent <span class="glossary-term" data-glossary-category="Web Development" data-glossary-definition="A set of protocols and tools for building software applications, defining how components interact." data-glossary-full-form="Application Programming Interface" data-glossary-term="API">API</span> Requests</text><g class="message" data-participant-1="Client" data-participant-2="Gateway"><polygon fill="#000000" points="292.1533,215.0938,302.1533,219.0938,292.1533,223.0938,296.1533,219.0938" style="stroke:#000000;stroke-width:1;" /><line style="stroke:#000000;stroke-width:1;" x1="56.2651" x2="298.1533" y1="219.0938" y2="219.0938" /><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="195.1016" x="63.2651" y="214.0278"><span class="glossary-term" data-glossary-category="Web Development" data-glossary-definition="A set of protocols and tools for building software applications, defining how components interact." data-glossary-full-form="Application Programming Interface" data-glossary-term="API">API</span> Request + Session Cookie</text></g><g class="message" data-participant-1="Gateway" data-participant-2="Session"><polygon fill="#000000" points="427.9634,244.2266,437.9634,248.2266,427.9634,252.2266,431.9634,248.2266" style="stroke:#000000;stroke-width:1;" /><line style="stroke:#000000;stroke-width:1;" x1="304.1533" x2="433.9634" y1="248.2266" y2="248.2266" /><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="107.1294" x="311.1533" y="243.1606">Validate Session</text></g><g class="message" data-participant-1="Session" data-participant-2="Gateway"><polygon fill="#000000" points="315.1533,273.3594,305.1533,277.3594,315.1533,281.3594,311.1533,277.3594" style="stroke:#000000;stroke-width:1;" /><line style="stroke:#000000;stroke-width:1;" x1="309.1533" x2="438.9634" y1="277.3594" y2="277.3594" /><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="84.7729" x="321.1533" y="272.2935">Session Data</text></g><g class="message" data-participant-1="Gateway" data-participant-2="API"><polygon fill="#000000" points="558.7217,302.4922,568.7217,306.4922,558.7217,310.4922,562.7217,306.4922" style="stroke:#000000;stroke-width:1;" /><line style="stroke:#000000;stroke-width:1;" x1="304.1533" x2="564.7217" y1="306.4922" y2="306.4922" /><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="127.9751" x="311.1533" y="301.4263">Authorized Request</text></g><g class="message" data-participant-1="API" data-participant-2="Gateway"><polygon fill="#000000" points="315.1533,331.625,305.1533,335.625,315.1533,339.625,311.1533,335.625" style="stroke:#000000;stroke-width:1;" /><line style="stroke:#000000;stroke-width:1;" x1="309.1533" x2="569.7217" y1="335.625" y2="335.625" /><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="63.0195" x="321.1533" y="330.5591">Response</text></g><g class="message" data-participant-1="Gateway" data-participant-2="Client"><polygon fill="#000000" points="67.2651,360.7578,57.2651,364.7578,67.2651,368.7578,63.2651,364.7578" style="stroke:#000000;stroke-width:1;" /><line style="stroke:#000000;stroke-width:1;" x1="61.2651" x2="303.1533" y1="364.7578" y2="364.7578" /><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="87.7183" x="73.2651" y="359.6919"><span class="glossary-term" data-glossary-category="Web Development" data-glossary-definition="A set of protocols and tools for building software applications, defining how components interact." data-glossary-full-form="Application Programming Interface" data-glossary-term="API">API</span> Response</text></g><path d="M243,377.7578 L243,402.7578 L499,402.7578 L499,387.7578 L489,377.7578 L243,377.7578" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;" /><path d="M489,377.7578 L489,387.7578 L499,387.7578 L489,377.7578" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;" /><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="168.1431" x="282.7385" y="394.8247">Session Security Features</text><path d="M217,412.8906 L217,482.8906 L390,482.8906 L390,422.8906 L380,412.8906 L217,412.8906" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;" /><path d="M380,412.8906 L380,422.8906 L390,422.8906 L380,412.8906" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;" /><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="113.0771" x="223" y="429.9575">- CSRF Protection</text><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="108.8306" x="223" y="445.0903">- Secure Cookies</text><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="117.5078" x="223" y="460.2231">- Session Rotation</text><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="152.0962" x="223" y="475.356">- Timeout Management</text></g></svg></p></div></div>
<h3 id="comprehensive-session-manager-implementation">Comprehensive Session Manager Implementation<a class="headerlink" href="#comprehensive-session-manager-implementation" title="Permanent link">&para;</a></h3>
<div class="language-python highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">hashlib</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">secrets</span>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Any</span>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">asdict</span>
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a><span class="kn">from</span><span class="w"> </span><span class="nn">threading</span><span class="w"> </span><span class="kn">import</span> <span class="n">Lock</span>
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a><span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a>
</span><span id="__span-4-10"><a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a><span class="nd">@dataclass</span>
</span><span id="__span-4-11"><a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a><span class="k">class</span><span class="w"> </span><span class="nc">SessionData</span><span class="p">:</span>
</span><span id="__span-4-12"><a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Secure session data structure&quot;&quot;&quot;</span>
</span><span id="__span-4-13"><a id="__codelineno-4-13" name="__codelineno-4-13" href="#__codelineno-4-13"></a>    <span class="n">session_id</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-4-14"><a id="__codelineno-4-14" name="__codelineno-4-14" href="#__codelineno-4-14"></a>    <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-4-15"><a id="__codelineno-4-15" name="__codelineno-4-15" href="#__codelineno-4-15"></a>    <span class="n">created_at</span><span class="p">:</span> <span class="n">datetime</span>
</span><span id="__span-4-16"><a id="__codelineno-4-16" name="__codelineno-4-16" href="#__codelineno-4-16"></a>    <span class="n">last_accessed</span><span class="p">:</span> <span class="n">datetime</span>
</span><span id="__span-4-17"><a id="__codelineno-4-17" name="__codelineno-4-17" href="#__codelineno-4-17"></a>    <span class="n">expires_at</span><span class="p">:</span> <span class="n">datetime</span>
</span><span id="__span-4-18"><a id="__codelineno-4-18" name="__codelineno-4-18" href="#__codelineno-4-18"></a>    <span class="n">ip_address</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-4-19"><a id="__codelineno-4-19" name="__codelineno-4-19" href="#__codelineno-4-19"></a>    <span class="n">user_agent</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-4-20"><a id="__codelineno-4-20" name="__codelineno-4-20" href="#__codelineno-4-20"></a>    <span class="n">permissions</span><span class="p">:</span> <span class="nb">list</span>
</span><span id="__span-4-21"><a id="__codelineno-4-21" name="__codelineno-4-21" href="#__codelineno-4-21"></a>    <span class="n">is_active</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="__span-4-22"><a id="__codelineno-4-22" name="__codelineno-4-22" href="#__codelineno-4-22"></a>    <span class="n">csrf_token</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span id="__span-4-23"><a id="__codelineno-4-23" name="__codelineno-4-23" href="#__codelineno-4-23"></a>    <span class="n">login_count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="__span-4-24"><a id="__codelineno-4-24" name="__codelineno-4-24" href="#__codelineno-4-24"></a>
</span><span id="__span-4-25"><a id="__codelineno-4-25" name="__codelineno-4-25" href="#__codelineno-4-25"></a><span class="k">class</span><span class="w"> </span><span class="nc">SecureSessionManager</span><span class="p">:</span>
</span><span id="__span-4-26"><a id="__codelineno-4-26" name="__codelineno-4-26" href="#__codelineno-4-26"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Production-ready session management with security features&quot;&quot;&quot;</span>
</span><span id="__span-4-27"><a id="__codelineno-4-27" name="__codelineno-4-27" href="#__codelineno-4-27"></a>
</span><span id="__span-4-28"><a id="__codelineno-4-28" name="__codelineno-4-28" href="#__codelineno-4-28"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_timeout_minutes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span><span class="p">,</span> 
</span><span id="__span-4-29"><a id="__codelineno-4-29" name="__codelineno-4-29" href="#__codelineno-4-29"></a>                 <span class="n">max_sessions_per_user</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">):</span>
</span><span id="__span-4-30"><a id="__codelineno-4-30" name="__codelineno-4-30" href="#__codelineno-4-30"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sessions</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">SessionData</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="__span-4-31"><a id="__codelineno-4-31" name="__codelineno-4-31" href="#__codelineno-4-31"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">user_sessions</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># user_id -&gt; session_ids</span>
</span><span id="__span-4-32"><a id="__codelineno-4-32" name="__codelineno-4-32" href="#__codelineno-4-32"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">session_timeout</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">session_timeout_minutes</span><span class="p">)</span>
</span><span id="__span-4-33"><a id="__codelineno-4-33" name="__codelineno-4-33" href="#__codelineno-4-33"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">max_sessions</span> <span class="o">=</span> <span class="n">max_sessions_per_user</span>
</span><span id="__span-4-34"><a id="__codelineno-4-34" name="__codelineno-4-34" href="#__codelineno-4-34"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">lock</span> <span class="o">=</span> <span class="n">Lock</span><span class="p">()</span>
</span><span id="__span-4-35"><a id="__codelineno-4-35" name="__codelineno-4-35" href="#__codelineno-4-35"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
</span><span id="__span-4-36"><a id="__codelineno-4-36" name="__codelineno-4-36" href="#__codelineno-4-36"></a>
</span><span id="__span-4-37"><a id="__codelineno-4-37" name="__codelineno-4-37" href="#__codelineno-4-37"></a>        <span class="c1"># Security tracking</span>
</span><span id="__span-4-38"><a id="__codelineno-4-38" name="__codelineno-4-38" href="#__codelineno-4-38"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">failed_logins</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="__span-4-39"><a id="__codelineno-4-39" name="__codelineno-4-39" href="#__codelineno-4-39"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">suspicious_activity</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="__span-4-40"><a id="__codelineno-4-40" name="__codelineno-4-40" href="#__codelineno-4-40"></a>
</span><span id="__span-4-41"><a id="__codelineno-4-41" name="__codelineno-4-41" href="#__codelineno-4-41"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_session</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">ip_address</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
</span><span id="__span-4-42"><a id="__codelineno-4-42" name="__codelineno-4-42" href="#__codelineno-4-42"></a>                      <span class="n">user_agent</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">permissions</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
</span><span id="__span-4-43"><a id="__codelineno-4-43" name="__codelineno-4-43" href="#__codelineno-4-43"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-4-44"><a id="__codelineno-4-44" name="__codelineno-4-44" href="#__codelineno-4-44"></a><span class="sd">        Create a new secure session</span>
</span><span id="__span-4-45"><a id="__codelineno-4-45" name="__codelineno-4-45" href="#__codelineno-4-45"></a><span class="sd">        Returns: (session_id, csrf_token)</span>
</span><span id="__span-4-46"><a id="__codelineno-4-46" name="__codelineno-4-46" href="#__codelineno-4-46"></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="__span-4-47"><a id="__codelineno-4-47" name="__codelineno-4-47" href="#__codelineno-4-47"></a>        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
</span><span id="__span-4-48"><a id="__codelineno-4-48" name="__codelineno-4-48" href="#__codelineno-4-48"></a>            <span class="c1"># Check for too many sessions per user</span>
</span><span id="__span-4-49"><a id="__codelineno-4-49" name="__codelineno-4-49" href="#__codelineno-4-49"></a>            <span class="k">if</span> <span class="n">user_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_sessions</span><span class="p">:</span>
</span><span id="__span-4-50"><a id="__codelineno-4-50" name="__codelineno-4-50" href="#__codelineno-4-50"></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_sessions</span><span class="p">[</span><span class="n">user_id</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_sessions</span><span class="p">:</span>
</span><span id="__span-4-51"><a id="__codelineno-4-51" name="__codelineno-4-51" href="#__codelineno-4-51"></a>                    <span class="c1"># Remove oldest session</span>
</span><span id="__span-4-52"><a id="__codelineno-4-52" name="__codelineno-4-52" href="#__codelineno-4-52"></a>                    <span class="n">oldest_session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_sessions</span><span class="p">[</span><span class="n">user_id</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="__span-4-53"><a id="__codelineno-4-53" name="__codelineno-4-53" href="#__codelineno-4-53"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_revoke_session_internal</span><span class="p">(</span><span class="n">oldest_session</span><span class="p">)</span>
</span><span id="__span-4-54"><a id="__codelineno-4-54" name="__codelineno-4-54" href="#__codelineno-4-54"></a>
</span><span id="__span-4-55"><a id="__codelineno-4-55" name="__codelineno-4-55" href="#__codelineno-4-55"></a>            <span class="c1"># Generate cryptographically secure session ID</span>
</span><span id="__span-4-56"><a id="__codelineno-4-56" name="__codelineno-4-56" href="#__codelineno-4-56"></a>            <span class="n">session_id</span> <span class="o">=</span> <span class="n">secrets</span><span class="o">.</span><span class="n">token_urlsafe</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>
</span><span id="__span-4-57"><a id="__codelineno-4-57" name="__codelineno-4-57" href="#__codelineno-4-57"></a>            <span class="n">csrf_token</span> <span class="o">=</span> <span class="n">secrets</span><span class="o">.</span><span class="n">token_urlsafe</span><span class="p">(</span><span class="mi">24</span><span class="p">)</span>
</span><span id="__span-4-58"><a id="__codelineno-4-58" name="__codelineno-4-58" href="#__codelineno-4-58"></a>
</span><span id="__span-4-59"><a id="__codelineno-4-59" name="__codelineno-4-59" href="#__codelineno-4-59"></a>            <span class="n">current_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
</span><span id="__span-4-60"><a id="__codelineno-4-60" name="__codelineno-4-60" href="#__codelineno-4-60"></a>
</span><span id="__span-4-61"><a id="__codelineno-4-61" name="__codelineno-4-61" href="#__codelineno-4-61"></a>            <span class="c1"># Create session data</span>
</span><span id="__span-4-62"><a id="__codelineno-4-62" name="__codelineno-4-62" href="#__codelineno-4-62"></a>            <span class="n">session_data</span> <span class="o">=</span> <span class="n">SessionData</span><span class="p">(</span>
</span><span id="__span-4-63"><a id="__codelineno-4-63" name="__codelineno-4-63" href="#__codelineno-4-63"></a>                <span class="n">session_id</span><span class="o">=</span><span class="n">session_id</span><span class="p">,</span>
</span><span id="__span-4-64"><a id="__codelineno-4-64" name="__codelineno-4-64" href="#__codelineno-4-64"></a>                <span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span>
</span><span id="__span-4-65"><a id="__codelineno-4-65" name="__codelineno-4-65" href="#__codelineno-4-65"></a>                <span class="n">created_at</span><span class="o">=</span><span class="n">current_time</span><span class="p">,</span>
</span><span id="__span-4-66"><a id="__codelineno-4-66" name="__codelineno-4-66" href="#__codelineno-4-66"></a>                <span class="n">last_accessed</span><span class="o">=</span><span class="n">current_time</span><span class="p">,</span>
</span><span id="__span-4-67"><a id="__codelineno-4-67" name="__codelineno-4-67" href="#__codelineno-4-67"></a>                <span class="n">expires_at</span><span class="o">=</span><span class="n">current_time</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_timeout</span><span class="p">,</span>
</span><span id="__span-4-68"><a id="__codelineno-4-68" name="__codelineno-4-68" href="#__codelineno-4-68"></a>                <span class="n">ip_address</span><span class="o">=</span><span class="n">ip_address</span><span class="p">,</span>
</span><span id="__span-4-69"><a id="__codelineno-4-69" name="__codelineno-4-69" href="#__codelineno-4-69"></a>                <span class="n">user_agent</span><span class="o">=</span><span class="n">user_agent</span><span class="p">,</span>
</span><span id="__span-4-70"><a id="__codelineno-4-70" name="__codelineno-4-70" href="#__codelineno-4-70"></a>                <span class="n">permissions</span><span class="o">=</span><span class="n">permissions</span><span class="p">,</span>
</span><span id="__span-4-71"><a id="__codelineno-4-71" name="__codelineno-4-71" href="#__codelineno-4-71"></a>                <span class="n">csrf_token</span><span class="o">=</span><span class="n">csrf_token</span>
</span><span id="__span-4-72"><a id="__codelineno-4-72" name="__codelineno-4-72" href="#__codelineno-4-72"></a>            <span class="p">)</span>
</span><span id="__span-4-73"><a id="__codelineno-4-73" name="__codelineno-4-73" href="#__codelineno-4-73"></a>
</span><span id="__span-4-74"><a id="__codelineno-4-74" name="__codelineno-4-74" href="#__codelineno-4-74"></a>            <span class="c1"># Store session</span>
</span><span id="__span-4-75"><a id="__codelineno-4-75" name="__codelineno-4-75" href="#__codelineno-4-75"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sessions</span><span class="p">[</span><span class="n">session_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">session_data</span>
</span><span id="__span-4-76"><a id="__codelineno-4-76" name="__codelineno-4-76" href="#__codelineno-4-76"></a>
</span><span id="__span-4-77"><a id="__codelineno-4-77" name="__codelineno-4-77" href="#__codelineno-4-77"></a>            <span class="c1"># Track user sessions</span>
</span><span id="__span-4-78"><a id="__codelineno-4-78" name="__codelineno-4-78" href="#__codelineno-4-78"></a>            <span class="k">if</span> <span class="n">user_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_sessions</span><span class="p">:</span>
</span><span id="__span-4-79"><a id="__codelineno-4-79" name="__codelineno-4-79" href="#__codelineno-4-79"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">user_sessions</span><span class="p">[</span><span class="n">user_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-4-80"><a id="__codelineno-4-80" name="__codelineno-4-80" href="#__codelineno-4-80"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">user_sessions</span><span class="p">[</span><span class="n">user_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">session_id</span><span class="p">)</span>
</span><span id="__span-4-81"><a id="__codelineno-4-81" name="__codelineno-4-81" href="#__codelineno-4-81"></a>
</span><span id="__span-4-82"><a id="__codelineno-4-82" name="__codelineno-4-82" href="#__codelineno-4-82"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Session created for user </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2"> from </span><span class="si">{</span><span class="n">ip_address</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-4-83"><a id="__codelineno-4-83" name="__codelineno-4-83" href="#__codelineno-4-83"></a>
</span><span id="__span-4-84"><a id="__codelineno-4-84" name="__codelineno-4-84" href="#__codelineno-4-84"></a>            <span class="k">return</span> <span class="n">session_id</span><span class="p">,</span> <span class="n">csrf_token</span>
</span><span id="__span-4-85"><a id="__codelineno-4-85" name="__codelineno-4-85" href="#__codelineno-4-85"></a>
</span><span id="__span-4-86"><a id="__codelineno-4-86" name="__codelineno-4-86" href="#__codelineno-4-86"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">validate_session</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">ip_address</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
</span><span id="__span-4-87"><a id="__codelineno-4-87" name="__codelineno-4-87" href="#__codelineno-4-87"></a>                        <span class="n">user_agent</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">csrf_token</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SessionData</span><span class="p">]:</span>
</span><span id="__span-4-88"><a id="__codelineno-4-88" name="__codelineno-4-88" href="#__codelineno-4-88"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-4-89"><a id="__codelineno-4-89" name="__codelineno-4-89" href="#__codelineno-4-89"></a><span class="sd">        Validate session with security checks</span>
</span><span id="__span-4-90"><a id="__codelineno-4-90" name="__codelineno-4-90" href="#__codelineno-4-90"></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="__span-4-91"><a id="__codelineno-4-91" name="__codelineno-4-91" href="#__codelineno-4-91"></a>        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
</span><span id="__span-4-92"><a id="__codelineno-4-92" name="__codelineno-4-92" href="#__codelineno-4-92"></a>            <span class="k">if</span> <span class="n">session_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sessions</span><span class="p">:</span>
</span><span id="__span-4-93"><a id="__codelineno-4-93" name="__codelineno-4-93" href="#__codelineno-4-93"></a>                <span class="k">return</span> <span class="kc">None</span>
</span><span id="__span-4-94"><a id="__codelineno-4-94" name="__codelineno-4-94" href="#__codelineno-4-94"></a>
</span><span id="__span-4-95"><a id="__codelineno-4-95" name="__codelineno-4-95" href="#__codelineno-4-95"></a>            <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sessions</span><span class="p">[</span><span class="n">session_id</span><span class="p">]</span>
</span><span id="__span-4-96"><a id="__codelineno-4-96" name="__codelineno-4-96" href="#__codelineno-4-96"></a>            <span class="n">current_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
</span><span id="__span-4-97"><a id="__codelineno-4-97" name="__codelineno-4-97" href="#__codelineno-4-97"></a>
</span><span id="__span-4-98"><a id="__codelineno-4-98" name="__codelineno-4-98" href="#__codelineno-4-98"></a>            <span class="c1"># Check if session is active</span>
</span><span id="__span-4-99"><a id="__codelineno-4-99" name="__codelineno-4-99" href="#__codelineno-4-99"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">session</span><span class="o">.</span><span class="n">is_active</span><span class="p">:</span>
</span><span id="__span-4-100"><a id="__codelineno-4-100" name="__codelineno-4-100" href="#__codelineno-4-100"></a>                <span class="k">return</span> <span class="kc">None</span>
</span><span id="__span-4-101"><a id="__codelineno-4-101" name="__codelineno-4-101" href="#__codelineno-4-101"></a>
</span><span id="__span-4-102"><a id="__codelineno-4-102" name="__codelineno-4-102" href="#__codelineno-4-102"></a>            <span class="c1"># Check expiration</span>
</span><span id="__span-4-103"><a id="__codelineno-4-103" name="__codelineno-4-103" href="#__codelineno-4-103"></a>            <span class="k">if</span> <span class="n">current_time</span> <span class="o">&gt;</span> <span class="n">session</span><span class="o">.</span><span class="n">expires_at</span><span class="p">:</span>
</span><span id="__span-4-104"><a id="__codelineno-4-104" name="__codelineno-4-104" href="#__codelineno-4-104"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_revoke_session_internal</span><span class="p">(</span><span class="n">session_id</span><span class="p">)</span>
</span><span id="__span-4-105"><a id="__codelineno-4-105" name="__codelineno-4-105" href="#__codelineno-4-105"></a>                <span class="k">return</span> <span class="kc">None</span>
</span><span id="__span-4-106"><a id="__codelineno-4-106" name="__codelineno-4-106" href="#__codelineno-4-106"></a>
</span><span id="__span-4-107"><a id="__codelineno-4-107" name="__codelineno-4-107" href="#__codelineno-4-107"></a>            <span class="c1"># Security checks</span>
</span><span id="__span-4-108"><a id="__codelineno-4-108" name="__codelineno-4-108" href="#__codelineno-4-108"></a>            <span class="n">security_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_perform_security_checks</span><span class="p">(</span>
</span><span id="__span-4-109"><a id="__codelineno-4-109" name="__codelineno-4-109" href="#__codelineno-4-109"></a>                <span class="n">session</span><span class="p">,</span> <span class="n">ip_address</span><span class="p">,</span> <span class="n">user_agent</span><span class="p">,</span> <span class="n">csrf_token</span>
</span><span id="__span-4-110"><a id="__codelineno-4-110" name="__codelineno-4-110" href="#__codelineno-4-110"></a>            <span class="p">)</span>
</span><span id="__span-4-111"><a id="__codelineno-4-111" name="__codelineno-4-111" href="#__codelineno-4-111"></a>
</span><span id="__span-4-112"><a id="__codelineno-4-112" name="__codelineno-4-112" href="#__codelineno-4-112"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">security_result</span><span class="p">[</span><span class="s2">&quot;valid&quot;</span><span class="p">]:</span>
</span><span id="__span-4-113"><a id="__codelineno-4-113" name="__codelineno-4-113" href="#__codelineno-4-113"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="__span-4-114"><a id="__codelineno-4-114" name="__codelineno-4-114" href="#__codelineno-4-114"></a>                    <span class="sa">f</span><span class="s2">&quot;Security check failed for session </span><span class="si">{</span><span class="n">session_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">security_result</span><span class="p">[</span><span class="s1">&#39;reason&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="__span-4-115"><a id="__codelineno-4-115" name="__codelineno-4-115" href="#__codelineno-4-115"></a>                <span class="p">)</span>
</span><span id="__span-4-116"><a id="__codelineno-4-116" name="__codelineno-4-116" href="#__codelineno-4-116"></a>                <span class="k">if</span> <span class="n">security_result</span><span class="p">[</span><span class="s2">&quot;revoke&quot;</span><span class="p">]:</span>
</span><span id="__span-4-117"><a id="__codelineno-4-117" name="__codelineno-4-117" href="#__codelineno-4-117"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_revoke_session_internal</span><span class="p">(</span><span class="n">session_id</span><span class="p">)</span>
</span><span id="__span-4-118"><a id="__codelineno-4-118" name="__codelineno-4-118" href="#__codelineno-4-118"></a>                <span class="k">return</span> <span class="kc">None</span>
</span><span id="__span-4-119"><a id="__codelineno-4-119" name="__codelineno-4-119" href="#__codelineno-4-119"></a>
</span><span id="__span-4-120"><a id="__codelineno-4-120" name="__codelineno-4-120" href="#__codelineno-4-120"></a>            <span class="c1"># Update session activity</span>
</span><span id="__span-4-121"><a id="__codelineno-4-121" name="__codelineno-4-121" href="#__codelineno-4-121"></a>            <span class="n">session</span><span class="o">.</span><span class="n">last_accessed</span> <span class="o">=</span> <span class="n">current_time</span>
</span><span id="__span-4-122"><a id="__codelineno-4-122" name="__codelineno-4-122" href="#__codelineno-4-122"></a>            <span class="n">session</span><span class="o">.</span><span class="n">expires_at</span> <span class="o">=</span> <span class="n">current_time</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_timeout</span>
</span><span id="__span-4-123"><a id="__codelineno-4-123" name="__codelineno-4-123" href="#__codelineno-4-123"></a>
</span><span id="__span-4-124"><a id="__codelineno-4-124" name="__codelineno-4-124" href="#__codelineno-4-124"></a>            <span class="k">return</span> <span class="n">session</span>
</span><span id="__span-4-125"><a id="__codelineno-4-125" name="__codelineno-4-125" href="#__codelineno-4-125"></a>
</span><span id="__span-4-126"><a id="__codelineno-4-126" name="__codelineno-4-126" href="#__codelineno-4-126"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_perform_security_checks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">SessionData</span><span class="p">,</span> <span class="n">ip_address</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
</span><span id="__span-4-127"><a id="__codelineno-4-127" name="__codelineno-4-127" href="#__codelineno-4-127"></a>                                <span class="n">user_agent</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">csrf_token</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="__span-4-128"><a id="__codelineno-4-128" name="__codelineno-4-128" href="#__codelineno-4-128"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Perform comprehensive security validation&quot;&quot;&quot;</span>
</span><span id="__span-4-129"><a id="__codelineno-4-129" name="__codelineno-4-129" href="#__codelineno-4-129"></a>
</span><span id="__span-4-130"><a id="__codelineno-4-130" name="__codelineno-4-130" href="#__codelineno-4-130"></a>        <span class="c1"># IP address validation (detect session hijacking)</span>
</span><span id="__span-4-131"><a id="__codelineno-4-131" name="__codelineno-4-131" href="#__codelineno-4-131"></a>        <span class="k">if</span> <span class="n">session</span><span class="o">.</span><span class="n">ip_address</span> <span class="o">!=</span> <span class="n">ip_address</span><span class="p">:</span>
</span><span id="__span-4-132"><a id="__codelineno-4-132" name="__codelineno-4-132" href="#__codelineno-4-132"></a>            <span class="c1"># Log potential session hijacking</span>
</span><span id="__span-4-133"><a id="__codelineno-4-133" name="__codelineno-4-133" href="#__codelineno-4-133"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="__span-4-134"><a id="__codelineno-4-134" name="__codelineno-4-134" href="#__codelineno-4-134"></a>                <span class="sa">f</span><span class="s2">&quot;IP address mismatch for session </span><span class="si">{</span><span class="n">session</span><span class="o">.</span><span class="n">session_id</span><span class="si">}</span><span class="s2">: &quot;</span>
</span><span id="__span-4-135"><a id="__codelineno-4-135" name="__codelineno-4-135" href="#__codelineno-4-135"></a>                <span class="sa">f</span><span class="s2">&quot;expected </span><span class="si">{</span><span class="n">session</span><span class="o">.</span><span class="n">ip_address</span><span class="si">}</span><span class="s2">, got </span><span class="si">{</span><span class="n">ip_address</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="__span-4-136"><a id="__codelineno-4-136" name="__codelineno-4-136" href="#__codelineno-4-136"></a>            <span class="p">)</span>
</span><span id="__span-4-137"><a id="__codelineno-4-137" name="__codelineno-4-137" href="#__codelineno-4-137"></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;valid&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;revoke&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="s2">&quot;IP address mismatch&quot;</span><span class="p">}</span>
</span><span id="__span-4-138"><a id="__codelineno-4-138" name="__codelineno-4-138" href="#__codelineno-4-138"></a>
</span><span id="__span-4-139"><a id="__codelineno-4-139" name="__codelineno-4-139" href="#__codelineno-4-139"></a>        <span class="c1"># User agent validation (basic fingerprinting)</span>
</span><span id="__span-4-140"><a id="__codelineno-4-140" name="__codelineno-4-140" href="#__codelineno-4-140"></a>        <span class="k">if</span> <span class="n">session</span><span class="o">.</span><span class="n">user_agent</span> <span class="o">!=</span> <span class="n">user_agent</span><span class="p">:</span>
</span><span id="__span-4-141"><a id="__codelineno-4-141" name="__codelineno-4-141" href="#__codelineno-4-141"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="__span-4-142"><a id="__codelineno-4-142" name="__codelineno-4-142" href="#__codelineno-4-142"></a>                <span class="sa">f</span><span class="s2">&quot;User agent mismatch for session </span><span class="si">{</span><span class="n">session</span><span class="o">.</span><span class="n">session_id</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="__span-4-143"><a id="__codelineno-4-143" name="__codelineno-4-143" href="#__codelineno-4-143"></a>            <span class="p">)</span>
</span><span id="__span-4-144"><a id="__codelineno-4-144" name="__codelineno-4-144" href="#__codelineno-4-144"></a>            <span class="c1"># Don&#39;t revoke for user agent changes, but log suspicious activity</span>
</span><span id="__span-4-145"><a id="__codelineno-4-145" name="__codelineno-4-145" href="#__codelineno-4-145"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_track_suspicious_activity</span><span class="p">(</span><span class="n">session</span><span class="o">.</span><span class="n">user_id</span><span class="p">,</span> <span class="s2">&quot;user_agent_change&quot;</span><span class="p">)</span>
</span><span id="__span-4-146"><a id="__codelineno-4-146" name="__codelineno-4-146" href="#__codelineno-4-146"></a>
</span><span id="__span-4-147"><a id="__codelineno-4-147" name="__codelineno-4-147" href="#__codelineno-4-147"></a>        <span class="c1"># CSRF token validation (for state-changing operations)</span>
</span><span id="__span-4-148"><a id="__codelineno-4-148" name="__codelineno-4-148" href="#__codelineno-4-148"></a>        <span class="k">if</span> <span class="n">csrf_token</span> <span class="ow">and</span> <span class="n">csrf_token</span> <span class="o">!=</span> <span class="n">session</span><span class="o">.</span><span class="n">csrf_token</span><span class="p">:</span>
</span><span id="__span-4-149"><a id="__codelineno-4-149" name="__codelineno-4-149" href="#__codelineno-4-149"></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;valid&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;revoke&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="s2">&quot;Invalid CSRF token&quot;</span><span class="p">}</span>
</span><span id="__span-4-150"><a id="__codelineno-4-150" name="__codelineno-4-150" href="#__codelineno-4-150"></a>
</span><span id="__span-4-151"><a id="__codelineno-4-151" name="__codelineno-4-151" href="#__codelineno-4-151"></a>        <span class="c1"># Check for session fixation attacks</span>
</span><span id="__span-4-152"><a id="__codelineno-4-152" name="__codelineno-4-152" href="#__codelineno-4-152"></a>        <span class="n">session_age</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">session</span><span class="o">.</span><span class="n">created_at</span>
</span><span id="__span-4-153"><a id="__codelineno-4-153" name="__codelineno-4-153" href="#__codelineno-4-153"></a>        <span class="k">if</span> <span class="n">session_age</span> <span class="o">&gt;</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">24</span><span class="p">):</span>  <span class="c1"># Force re-authentication after 24 hours</span>
</span><span id="__span-4-154"><a id="__codelineno-4-154" name="__codelineno-4-154" href="#__codelineno-4-154"></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;valid&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;revoke&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="s2">&quot;Session too old&quot;</span><span class="p">}</span>
</span><span id="__span-4-155"><a id="__codelineno-4-155" name="__codelineno-4-155" href="#__codelineno-4-155"></a>
</span><span id="__span-4-156"><a id="__codelineno-4-156" name="__codelineno-4-156" href="#__codelineno-4-156"></a>        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;valid&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;revoke&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="s2">&quot;Valid&quot;</span><span class="p">}</span>
</span><span id="__span-4-157"><a id="__codelineno-4-157" name="__codelineno-4-157" href="#__codelineno-4-157"></a>
</span><span id="__span-4-158"><a id="__codelineno-4-158" name="__codelineno-4-158" href="#__codelineno-4-158"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">refresh_session</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
</span><span id="__span-4-159"><a id="__codelineno-4-159" name="__codelineno-4-159" href="#__codelineno-4-159"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-4-160"><a id="__codelineno-4-160" name="__codelineno-4-160" href="#__codelineno-4-160"></a><span class="sd">        Refresh session with new ID (prevent session fixation)</span>
</span><span id="__span-4-161"><a id="__codelineno-4-161" name="__codelineno-4-161" href="#__codelineno-4-161"></a><span class="sd">        Returns new session ID if successful</span>
</span><span id="__span-4-162"><a id="__codelineno-4-162" name="__codelineno-4-162" href="#__codelineno-4-162"></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="__span-4-163"><a id="__codelineno-4-163" name="__codelineno-4-163" href="#__codelineno-4-163"></a>        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
</span><span id="__span-4-164"><a id="__codelineno-4-164" name="__codelineno-4-164" href="#__codelineno-4-164"></a>            <span class="k">if</span> <span class="n">session_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sessions</span><span class="p">:</span>
</span><span id="__span-4-165"><a id="__codelineno-4-165" name="__codelineno-4-165" href="#__codelineno-4-165"></a>                <span class="k">return</span> <span class="kc">None</span>
</span><span id="__span-4-166"><a id="__codelineno-4-166" name="__codelineno-4-166" href="#__codelineno-4-166"></a>
</span><span id="__span-4-167"><a id="__codelineno-4-167" name="__codelineno-4-167" href="#__codelineno-4-167"></a>            <span class="n">old_session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sessions</span><span class="p">[</span><span class="n">session_id</span><span class="p">]</span>
</span><span id="__span-4-168"><a id="__codelineno-4-168" name="__codelineno-4-168" href="#__codelineno-4-168"></a>
</span><span id="__span-4-169"><a id="__codelineno-4-169" name="__codelineno-4-169" href="#__codelineno-4-169"></a>            <span class="c1"># Generate new session ID</span>
</span><span id="__span-4-170"><a id="__codelineno-4-170" name="__codelineno-4-170" href="#__codelineno-4-170"></a>            <span class="n">new_session_id</span> <span class="o">=</span> <span class="n">secrets</span><span class="o">.</span><span class="n">token_urlsafe</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>
</span><span id="__span-4-171"><a id="__codelineno-4-171" name="__codelineno-4-171" href="#__codelineno-4-171"></a>            <span class="n">new_csrf_token</span> <span class="o">=</span> <span class="n">secrets</span><span class="o">.</span><span class="n">token_urlsafe</span><span class="p">(</span><span class="mi">24</span><span class="p">)</span>
</span><span id="__span-4-172"><a id="__codelineno-4-172" name="__codelineno-4-172" href="#__codelineno-4-172"></a>
</span><span id="__span-4-173"><a id="__codelineno-4-173" name="__codelineno-4-173" href="#__codelineno-4-173"></a>            <span class="c1"># Create new session with same data</span>
</span><span id="__span-4-174"><a id="__codelineno-4-174" name="__codelineno-4-174" href="#__codelineno-4-174"></a>            <span class="n">new_session</span> <span class="o">=</span> <span class="n">SessionData</span><span class="p">(</span>
</span><span id="__span-4-175"><a id="__codelineno-4-175" name="__codelineno-4-175" href="#__codelineno-4-175"></a>                <span class="n">session_id</span><span class="o">=</span><span class="n">new_session_id</span><span class="p">,</span>
</span><span id="__span-4-176"><a id="__codelineno-4-176" name="__codelineno-4-176" href="#__codelineno-4-176"></a>                <span class="n">user_id</span><span class="o">=</span><span class="n">old_session</span><span class="o">.</span><span class="n">user_id</span><span class="p">,</span>
</span><span id="__span-4-177"><a id="__codelineno-4-177" name="__codelineno-4-177" href="#__codelineno-4-177"></a>                <span class="n">created_at</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>  <span class="c1"># Reset creation time</span>
</span><span id="__span-4-178"><a id="__codelineno-4-178" name="__codelineno-4-178" href="#__codelineno-4-178"></a>                <span class="n">last_accessed</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
</span><span id="__span-4-179"><a id="__codelineno-4-179" name="__codelineno-4-179" href="#__codelineno-4-179"></a>                <span class="n">expires_at</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_timeout</span><span class="p">,</span>
</span><span id="__span-4-180"><a id="__codelineno-4-180" name="__codelineno-4-180" href="#__codelineno-4-180"></a>                <span class="n">ip_address</span><span class="o">=</span><span class="n">old_session</span><span class="o">.</span><span class="n">ip_address</span><span class="p">,</span>
</span><span id="__span-4-181"><a id="__codelineno-4-181" name="__codelineno-4-181" href="#__codelineno-4-181"></a>                <span class="n">user_agent</span><span class="o">=</span><span class="n">old_session</span><span class="o">.</span><span class="n">user_agent</span><span class="p">,</span>
</span><span id="__span-4-182"><a id="__codelineno-4-182" name="__codelineno-4-182" href="#__codelineno-4-182"></a>                <span class="n">permissions</span><span class="o">=</span><span class="n">old_session</span><span class="o">.</span><span class="n">permissions</span><span class="p">,</span>
</span><span id="__span-4-183"><a id="__codelineno-4-183" name="__codelineno-4-183" href="#__codelineno-4-183"></a>                <span class="n">csrf_token</span><span class="o">=</span><span class="n">new_csrf_token</span><span class="p">,</span>
</span><span id="__span-4-184"><a id="__codelineno-4-184" name="__codelineno-4-184" href="#__codelineno-4-184"></a>                <span class="n">login_count</span><span class="o">=</span><span class="n">old_session</span><span class="o">.</span><span class="n">login_count</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="__span-4-185"><a id="__codelineno-4-185" name="__codelineno-4-185" href="#__codelineno-4-185"></a>            <span class="p">)</span>
</span><span id="__span-4-186"><a id="__codelineno-4-186" name="__codelineno-4-186" href="#__codelineno-4-186"></a>
</span><span id="__span-4-187"><a id="__codelineno-4-187" name="__codelineno-4-187" href="#__codelineno-4-187"></a>            <span class="c1"># Replace old session</span>
</span><span id="__span-4-188"><a id="__codelineno-4-188" name="__codelineno-4-188" href="#__codelineno-4-188"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sessions</span><span class="p">[</span><span class="n">new_session_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_session</span>
</span><span id="__span-4-189"><a id="__codelineno-4-189" name="__codelineno-4-189" href="#__codelineno-4-189"></a>            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">sessions</span><span class="p">[</span><span class="n">session_id</span><span class="p">]</span>
</span><span id="__span-4-190"><a id="__codelineno-4-190" name="__codelineno-4-190" href="#__codelineno-4-190"></a>
</span><span id="__span-4-191"><a id="__codelineno-4-191" name="__codelineno-4-191" href="#__codelineno-4-191"></a>            <span class="c1"># Update user session tracking</span>
</span><span id="__span-4-192"><a id="__codelineno-4-192" name="__codelineno-4-192" href="#__codelineno-4-192"></a>            <span class="n">user_sessions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_sessions</span><span class="p">[</span><span class="n">old_session</span><span class="o">.</span><span class="n">user_id</span><span class="p">]</span>
</span><span id="__span-4-193"><a id="__codelineno-4-193" name="__codelineno-4-193" href="#__codelineno-4-193"></a>            <span class="n">user_sessions</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">session_id</span><span class="p">)</span>
</span><span id="__span-4-194"><a id="__codelineno-4-194" name="__codelineno-4-194" href="#__codelineno-4-194"></a>            <span class="n">user_sessions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_session_id</span><span class="p">)</span>
</span><span id="__span-4-195"><a id="__codelineno-4-195" name="__codelineno-4-195" href="#__codelineno-4-195"></a>
</span><span id="__span-4-196"><a id="__codelineno-4-196" name="__codelineno-4-196" href="#__codelineno-4-196"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Session refreshed for user </span><span class="si">{</span><span class="n">old_session</span><span class="o">.</span><span class="n">user_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-4-197"><a id="__codelineno-4-197" name="__codelineno-4-197" href="#__codelineno-4-197"></a>
</span><span id="__span-4-198"><a id="__codelineno-4-198" name="__codelineno-4-198" href="#__codelineno-4-198"></a>            <span class="k">return</span> <span class="n">new_session_id</span>
</span><span id="__span-4-199"><a id="__codelineno-4-199" name="__codelineno-4-199" href="#__codelineno-4-199"></a>
</span><span id="__span-4-200"><a id="__codelineno-4-200" name="__codelineno-4-200" href="#__codelineno-4-200"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">revoke_session</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="__span-4-201"><a id="__codelineno-4-201" name="__codelineno-4-201" href="#__codelineno-4-201"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Revoke a specific session&quot;&quot;&quot;</span>
</span><span id="__span-4-202"><a id="__codelineno-4-202" name="__codelineno-4-202" href="#__codelineno-4-202"></a>        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
</span><span id="__span-4-203"><a id="__codelineno-4-203" name="__codelineno-4-203" href="#__codelineno-4-203"></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_revoke_session_internal</span><span class="p">(</span><span class="n">session_id</span><span class="p">)</span>
</span><span id="__span-4-204"><a id="__codelineno-4-204" name="__codelineno-4-204" href="#__codelineno-4-204"></a>
</span><span id="__span-4-205"><a id="__codelineno-4-205" name="__codelineno-4-205" href="#__codelineno-4-205"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_revoke_session_internal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="__span-4-206"><a id="__codelineno-4-206" name="__codelineno-4-206" href="#__codelineno-4-206"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Internal session revocation (assumes lock is held)&quot;&quot;&quot;</span>
</span><span id="__span-4-207"><a id="__codelineno-4-207" name="__codelineno-4-207" href="#__codelineno-4-207"></a>        <span class="k">if</span> <span class="n">session_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sessions</span><span class="p">:</span>
</span><span id="__span-4-208"><a id="__codelineno-4-208" name="__codelineno-4-208" href="#__codelineno-4-208"></a>            <span class="k">return</span> <span class="kc">False</span>
</span><span id="__span-4-209"><a id="__codelineno-4-209" name="__codelineno-4-209" href="#__codelineno-4-209"></a>
</span><span id="__span-4-210"><a id="__codelineno-4-210" name="__codelineno-4-210" href="#__codelineno-4-210"></a>        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sessions</span><span class="p">[</span><span class="n">session_id</span><span class="p">]</span>
</span><span id="__span-4-211"><a id="__codelineno-4-211" name="__codelineno-4-211" href="#__codelineno-4-211"></a>        <span class="n">user_id</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">user_id</span>
</span><span id="__span-4-212"><a id="__codelineno-4-212" name="__codelineno-4-212" href="#__codelineno-4-212"></a>
</span><span id="__span-4-213"><a id="__codelineno-4-213" name="__codelineno-4-213" href="#__codelineno-4-213"></a>        <span class="c1"># Remove from main storage</span>
</span><span id="__span-4-214"><a id="__codelineno-4-214" name="__codelineno-4-214" href="#__codelineno-4-214"></a>        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">sessions</span><span class="p">[</span><span class="n">session_id</span><span class="p">]</span>
</span><span id="__span-4-215"><a id="__codelineno-4-215" name="__codelineno-4-215" href="#__codelineno-4-215"></a>
</span><span id="__span-4-216"><a id="__codelineno-4-216" name="__codelineno-4-216" href="#__codelineno-4-216"></a>        <span class="c1"># Remove from user session tracking</span>
</span><span id="__span-4-217"><a id="__codelineno-4-217" name="__codelineno-4-217" href="#__codelineno-4-217"></a>        <span class="k">if</span> <span class="n">user_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_sessions</span><span class="p">:</span>
</span><span id="__span-4-218"><a id="__codelineno-4-218" name="__codelineno-4-218" href="#__codelineno-4-218"></a>            <span class="k">if</span> <span class="n">session_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_sessions</span><span class="p">[</span><span class="n">user_id</span><span class="p">]:</span>
</span><span id="__span-4-219"><a id="__codelineno-4-219" name="__codelineno-4-219" href="#__codelineno-4-219"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">user_sessions</span><span class="p">[</span><span class="n">user_id</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">session_id</span><span class="p">)</span>
</span><span id="__span-4-220"><a id="__codelineno-4-220" name="__codelineno-4-220" href="#__codelineno-4-220"></a>
</span><span id="__span-4-221"><a id="__codelineno-4-221" name="__codelineno-4-221" href="#__codelineno-4-221"></a>            <span class="c1"># Clean up empty user session list</span>
</span><span id="__span-4-222"><a id="__codelineno-4-222" name="__codelineno-4-222" href="#__codelineno-4-222"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_sessions</span><span class="p">[</span><span class="n">user_id</span><span class="p">]:</span>
</span><span id="__span-4-223"><a id="__codelineno-4-223" name="__codelineno-4-223" href="#__codelineno-4-223"></a>                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_sessions</span><span class="p">[</span><span class="n">user_id</span><span class="p">]</span>
</span><span id="__span-4-224"><a id="__codelineno-4-224" name="__codelineno-4-224" href="#__codelineno-4-224"></a>
</span><span id="__span-4-225"><a id="__codelineno-4-225" name="__codelineno-4-225" href="#__codelineno-4-225"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Session </span><span class="si">{</span><span class="n">session_id</span><span class="si">}</span><span class="s2"> revoked for user </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-4-226"><a id="__codelineno-4-226" name="__codelineno-4-226" href="#__codelineno-4-226"></a>        <span class="k">return</span> <span class="kc">True</span>
</span><span id="__span-4-227"><a id="__codelineno-4-227" name="__codelineno-4-227" href="#__codelineno-4-227"></a>
</span><span id="__span-4-228"><a id="__codelineno-4-228" name="__codelineno-4-228" href="#__codelineno-4-228"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">revoke_all_user_sessions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="__span-4-229"><a id="__codelineno-4-229" name="__codelineno-4-229" href="#__codelineno-4-229"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Revoke all sessions for a specific user&quot;&quot;&quot;</span>
</span><span id="__span-4-230"><a id="__codelineno-4-230" name="__codelineno-4-230" href="#__codelineno-4-230"></a>        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
</span><span id="__span-4-231"><a id="__codelineno-4-231" name="__codelineno-4-231" href="#__codelineno-4-231"></a>            <span class="k">if</span> <span class="n">user_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_sessions</span><span class="p">:</span>
</span><span id="__span-4-232"><a id="__codelineno-4-232" name="__codelineno-4-232" href="#__codelineno-4-232"></a>                <span class="k">return</span> <span class="mi">0</span>
</span><span id="__span-4-233"><a id="__codelineno-4-233" name="__codelineno-4-233" href="#__codelineno-4-233"></a>
</span><span id="__span-4-234"><a id="__codelineno-4-234" name="__codelineno-4-234" href="#__codelineno-4-234"></a>            <span class="n">session_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_sessions</span><span class="p">[</span><span class="n">user_id</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="__span-4-235"><a id="__codelineno-4-235" name="__codelineno-4-235" href="#__codelineno-4-235"></a>            <span class="n">revoked_count</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="__span-4-236"><a id="__codelineno-4-236" name="__codelineno-4-236" href="#__codelineno-4-236"></a>
</span><span id="__span-4-237"><a id="__codelineno-4-237" name="__codelineno-4-237" href="#__codelineno-4-237"></a>            <span class="k">for</span> <span class="n">session_id</span> <span class="ow">in</span> <span class="n">session_ids</span><span class="p">:</span>
</span><span id="__span-4-238"><a id="__codelineno-4-238" name="__codelineno-4-238" href="#__codelineno-4-238"></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_revoke_session_internal</span><span class="p">(</span><span class="n">session_id</span><span class="p">):</span>
</span><span id="__span-4-239"><a id="__codelineno-4-239" name="__codelineno-4-239" href="#__codelineno-4-239"></a>                    <span class="n">revoked_count</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="__span-4-240"><a id="__codelineno-4-240" name="__codelineno-4-240" href="#__codelineno-4-240"></a>
</span><span id="__span-4-241"><a id="__codelineno-4-241" name="__codelineno-4-241" href="#__codelineno-4-241"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Revoked </span><span class="si">{</span><span class="n">revoked_count</span><span class="si">}</span><span class="s2"> sessions for user </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-4-242"><a id="__codelineno-4-242" name="__codelineno-4-242" href="#__codelineno-4-242"></a>            <span class="k">return</span> <span class="n">revoked_count</span>
</span><span id="__span-4-243"><a id="__codelineno-4-243" name="__codelineno-4-243" href="#__codelineno-4-243"></a>
</span><span id="__span-4-244"><a id="__codelineno-4-244" name="__codelineno-4-244" href="#__codelineno-4-244"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">cleanup_expired_sessions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="__span-4-245"><a id="__codelineno-4-245" name="__codelineno-4-245" href="#__codelineno-4-245"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Remove expired sessions (should be run periodically)&quot;&quot;&quot;</span>
</span><span id="__span-4-246"><a id="__codelineno-4-246" name="__codelineno-4-246" href="#__codelineno-4-246"></a>        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
</span><span id="__span-4-247"><a id="__codelineno-4-247" name="__codelineno-4-247" href="#__codelineno-4-247"></a>            <span class="n">current_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
</span><span id="__span-4-248"><a id="__codelineno-4-248" name="__codelineno-4-248" href="#__codelineno-4-248"></a>            <span class="n">expired_sessions</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-4-249"><a id="__codelineno-4-249" name="__codelineno-4-249" href="#__codelineno-4-249"></a>
</span><span id="__span-4-250"><a id="__codelineno-4-250" name="__codelineno-4-250" href="#__codelineno-4-250"></a>            <span class="k">for</span> <span class="n">session_id</span><span class="p">,</span> <span class="n">session</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sessions</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="__span-4-251"><a id="__codelineno-4-251" name="__codelineno-4-251" href="#__codelineno-4-251"></a>                <span class="k">if</span> <span class="n">current_time</span> <span class="o">&gt;</span> <span class="n">session</span><span class="o">.</span><span class="n">expires_at</span><span class="p">:</span>
</span><span id="__span-4-252"><a id="__codelineno-4-252" name="__codelineno-4-252" href="#__codelineno-4-252"></a>                    <span class="n">expired_sessions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">session_id</span><span class="p">)</span>
</span><span id="__span-4-253"><a id="__codelineno-4-253" name="__codelineno-4-253" href="#__codelineno-4-253"></a>
</span><span id="__span-4-254"><a id="__codelineno-4-254" name="__codelineno-4-254" href="#__codelineno-4-254"></a>            <span class="k">for</span> <span class="n">session_id</span> <span class="ow">in</span> <span class="n">expired_sessions</span><span class="p">:</span>
</span><span id="__span-4-255"><a id="__codelineno-4-255" name="__codelineno-4-255" href="#__codelineno-4-255"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_revoke_session_internal</span><span class="p">(</span><span class="n">session_id</span><span class="p">)</span>
</span><span id="__span-4-256"><a id="__codelineno-4-256" name="__codelineno-4-256" href="#__codelineno-4-256"></a>
</span><span id="__span-4-257"><a id="__codelineno-4-257" name="__codelineno-4-257" href="#__codelineno-4-257"></a>            <span class="k">if</span> <span class="n">expired_sessions</span><span class="p">:</span>
</span><span id="__span-4-258"><a id="__codelineno-4-258" name="__codelineno-4-258" href="#__codelineno-4-258"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cleaned up </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">expired_sessions</span><span class="p">)</span><span class="si">}</span><span class="s2"> expired sessions&quot;</span><span class="p">)</span>
</span><span id="__span-4-259"><a id="__codelineno-4-259" name="__codelineno-4-259" href="#__codelineno-4-259"></a>
</span><span id="__span-4-260"><a id="__codelineno-4-260" name="__codelineno-4-260" href="#__codelineno-4-260"></a>            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">expired_sessions</span><span class="p">)</span>
</span><span id="__span-4-261"><a id="__codelineno-4-261" name="__codelineno-4-261" href="#__codelineno-4-261"></a>
</span><span id="__span-4-262"><a id="__codelineno-4-262" name="__codelineno-4-262" href="#__codelineno-4-262"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_user_sessions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
</span><span id="__span-4-263"><a id="__codelineno-4-263" name="__codelineno-4-263" href="#__codelineno-4-263"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get all active sessions for a user&quot;&quot;&quot;</span>
</span><span id="__span-4-264"><a id="__codelineno-4-264" name="__codelineno-4-264" href="#__codelineno-4-264"></a>        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
</span><span id="__span-4-265"><a id="__codelineno-4-265" name="__codelineno-4-265" href="#__codelineno-4-265"></a>            <span class="k">if</span> <span class="n">user_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_sessions</span><span class="p">:</span>
</span><span id="__span-4-266"><a id="__codelineno-4-266" name="__codelineno-4-266" href="#__codelineno-4-266"></a>                <span class="k">return</span> <span class="p">[]</span>
</span><span id="__span-4-267"><a id="__codelineno-4-267" name="__codelineno-4-267" href="#__codelineno-4-267"></a>
</span><span id="__span-4-268"><a id="__codelineno-4-268" name="__codelineno-4-268" href="#__codelineno-4-268"></a>            <span class="n">active_sessions</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-4-269"><a id="__codelineno-4-269" name="__codelineno-4-269" href="#__codelineno-4-269"></a>            <span class="k">for</span> <span class="n">session_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_sessions</span><span class="p">[</span><span class="n">user_id</span><span class="p">]:</span>
</span><span id="__span-4-270"><a id="__codelineno-4-270" name="__codelineno-4-270" href="#__codelineno-4-270"></a>                <span class="k">if</span> <span class="n">session_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sessions</span><span class="p">:</span>
</span><span id="__span-4-271"><a id="__codelineno-4-271" name="__codelineno-4-271" href="#__codelineno-4-271"></a>                    <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sessions</span><span class="p">[</span><span class="n">session_id</span><span class="p">]</span>
</span><span id="__span-4-272"><a id="__codelineno-4-272" name="__codelineno-4-272" href="#__codelineno-4-272"></a>                    <span class="n">active_sessions</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span id="__span-4-273"><a id="__codelineno-4-273" name="__codelineno-4-273" href="#__codelineno-4-273"></a>                        <span class="s1">&#39;session_id&#39;</span><span class="p">:</span> <span class="n">session_id</span><span class="p">,</span>
</span><span id="__span-4-274"><a id="__codelineno-4-274" name="__codelineno-4-274" href="#__codelineno-4-274"></a>                        <span class="s1">&#39;created_at&#39;</span><span class="p">:</span> <span class="n">session</span><span class="o">.</span><span class="n">created_at</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
</span><span id="__span-4-275"><a id="__codelineno-4-275" name="__codelineno-4-275" href="#__codelineno-4-275"></a>                        <span class="s1">&#39;last_accessed&#39;</span><span class="p">:</span> <span class="n">session</span><span class="o">.</span><span class="n">last_accessed</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
</span><span id="__span-4-276"><a id="__codelineno-4-276" name="__codelineno-4-276" href="#__codelineno-4-276"></a>                        <span class="s1">&#39;ip_address&#39;</span><span class="p">:</span> <span class="n">session</span><span class="o">.</span><span class="n">ip_address</span><span class="p">,</span>
</span><span id="__span-4-277"><a id="__codelineno-4-277" name="__codelineno-4-277" href="#__codelineno-4-277"></a>                        <span class="s1">&#39;user_agent&#39;</span><span class="p">:</span> <span class="n">session</span><span class="o">.</span><span class="n">user_agent</span><span class="p">[:</span><span class="mi">50</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;...&#39;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">session</span><span class="o">.</span><span class="n">user_agent</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">50</span> <span class="k">else</span> <span class="n">session</span><span class="o">.</span><span class="n">user_agent</span>
</span><span id="__span-4-278"><a id="__codelineno-4-278" name="__codelineno-4-278" href="#__codelineno-4-278"></a>                    <span class="p">})</span>
</span><span id="__span-4-279"><a id="__codelineno-4-279" name="__codelineno-4-279" href="#__codelineno-4-279"></a>
</span><span id="__span-4-280"><a id="__codelineno-4-280" name="__codelineno-4-280" href="#__codelineno-4-280"></a>            <span class="k">return</span> <span class="n">active_sessions</span>
</span><span id="__span-4-281"><a id="__codelineno-4-281" name="__codelineno-4-281" href="#__codelineno-4-281"></a>
</span><span id="__span-4-282"><a id="__codelineno-4-282" name="__codelineno-4-282" href="#__codelineno-4-282"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_track_suspicious_activity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">activity_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="__span-4-283"><a id="__codelineno-4-283" name="__codelineno-4-283" href="#__codelineno-4-283"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Track suspicious activity for security monitoring&quot;&quot;&quot;</span>
</span><span id="__span-4-284"><a id="__codelineno-4-284" name="__codelineno-4-284" href="#__codelineno-4-284"></a>        <span class="k">if</span> <span class="n">user_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">suspicious_activity</span><span class="p">:</span>
</span><span id="__span-4-285"><a id="__codelineno-4-285" name="__codelineno-4-285" href="#__codelineno-4-285"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">suspicious_activity</span><span class="p">[</span><span class="n">user_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="__span-4-286"><a id="__codelineno-4-286" name="__codelineno-4-286" href="#__codelineno-4-286"></a>
</span><span id="__span-4-287"><a id="__codelineno-4-287" name="__codelineno-4-287" href="#__codelineno-4-287"></a>        <span class="k">if</span> <span class="n">activity_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">suspicious_activity</span><span class="p">[</span><span class="n">user_id</span><span class="p">]:</span>
</span><span id="__span-4-288"><a id="__codelineno-4-288" name="__codelineno-4-288" href="#__codelineno-4-288"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">suspicious_activity</span><span class="p">[</span><span class="n">user_id</span><span class="p">][</span><span class="n">activity_type</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-4-289"><a id="__codelineno-4-289" name="__codelineno-4-289" href="#__codelineno-4-289"></a>
</span><span id="__span-4-290"><a id="__codelineno-4-290" name="__codelineno-4-290" href="#__codelineno-4-290"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">suspicious_activity</span><span class="p">[</span><span class="n">user_id</span><span class="p">][</span><span class="n">activity_type</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
</span><span id="__span-4-291"><a id="__codelineno-4-291" name="__codelineno-4-291" href="#__codelineno-4-291"></a>
</span><span id="__span-4-292"><a id="__codelineno-4-292" name="__codelineno-4-292" href="#__codelineno-4-292"></a>        <span class="c1"># Keep only recent activity (last 24 hours)</span>
</span><span id="__span-4-293"><a id="__codelineno-4-293" name="__codelineno-4-293" href="#__codelineno-4-293"></a>        <span class="n">cutoff</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">24</span><span class="p">)</span>
</span><span id="__span-4-294"><a id="__codelineno-4-294" name="__codelineno-4-294" href="#__codelineno-4-294"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">suspicious_activity</span><span class="p">[</span><span class="n">user_id</span><span class="p">][</span><span class="n">activity_type</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="__span-4-295"><a id="__codelineno-4-295" name="__codelineno-4-295" href="#__codelineno-4-295"></a>            <span class="n">timestamp</span> <span class="k">for</span> <span class="n">timestamp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">suspicious_activity</span><span class="p">[</span><span class="n">user_id</span><span class="p">][</span><span class="n">activity_type</span><span class="p">]</span>
</span><span id="__span-4-296"><a id="__codelineno-4-296" name="__codelineno-4-296" href="#__codelineno-4-296"></a>            <span class="k">if</span> <span class="n">timestamp</span> <span class="o">&gt;</span> <span class="n">cutoff</span>
</span><span id="__span-4-297"><a id="__codelineno-4-297" name="__codelineno-4-297" href="#__codelineno-4-297"></a>        <span class="p">]</span>
</span><span id="__span-4-298"><a id="__codelineno-4-298" name="__codelineno-4-298" href="#__codelineno-4-298"></a>
</span><span id="__span-4-299"><a id="__codelineno-4-299" name="__codelineno-4-299" href="#__codelineno-4-299"></a><span class="k">class</span><span class="w"> </span><span class="nc">SessionSecurityMiddleware</span><span class="p">:</span>
</span><span id="__span-4-300"><a id="__codelineno-4-300" name="__codelineno-4-300" href="#__codelineno-4-300"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Middleware for secure session handling in web applications&quot;&quot;&quot;</span>
</span><span id="__span-4-301"><a id="__codelineno-4-301" name="__codelineno-4-301" href="#__codelineno-4-301"></a>
</span><span id="__span-4-302"><a id="__codelineno-4-302" name="__codelineno-4-302" href="#__codelineno-4-302"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_manager</span><span class="p">:</span> <span class="n">SecureSessionManager</span><span class="p">):</span>
</span><span id="__span-4-303"><a id="__codelineno-4-303" name="__codelineno-4-303" href="#__codelineno-4-303"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">session_manager</span> <span class="o">=</span> <span class="n">session_manager</span>
</span><span id="__span-4-304"><a id="__codelineno-4-304" name="__codelineno-4-304" href="#__codelineno-4-304"></a>
</span><span id="__span-4-305"><a id="__codelineno-4-305" name="__codelineno-4-305" href="#__codelineno-4-305"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">generate_secure_cookie_attributes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
</span><span id="__span-4-306"><a id="__codelineno-4-306" name="__codelineno-4-306" href="#__codelineno-4-306"></a>                                        <span class="n">is_https</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="__span-4-307"><a id="__codelineno-4-307" name="__codelineno-4-307" href="#__codelineno-4-307"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate secure cookie attributes for session&quot;&quot;&quot;</span>
</span><span id="__span-4-308"><a id="__codelineno-4-308" name="__codelineno-4-308" href="#__codelineno-4-308"></a>
</span><span id="__span-4-309"><a id="__codelineno-4-309" name="__codelineno-4-309" href="#__codelineno-4-309"></a>        <span class="n">cookie_attributes</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-4-310"><a id="__codelineno-4-310" name="__codelineno-4-310" href="#__codelineno-4-310"></a>            <span class="s1">&#39;httponly&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>  <span class="c1"># Prevent XSS access to cookies</span>
</span><span id="__span-4-311"><a id="__codelineno-4-311" name="__codelineno-4-311" href="#__codelineno-4-311"></a>            <span class="s1">&#39;secure&#39;</span><span class="p">:</span> <span class="n">is_https</span><span class="p">,</span>  <span class="c1"># Only send over HTTPS</span>
</span><span id="__span-4-312"><a id="__codelineno-4-312" name="__codelineno-4-312" href="#__codelineno-4-312"></a>            <span class="s1">&#39;samesite&#39;</span><span class="p">:</span> <span class="s1">&#39;Strict&#39;</span><span class="p">,</span>  <span class="c1"># CSRF protection</span>
</span><span id="__span-4-313"><a id="__codelineno-4-313" name="__codelineno-4-313" href="#__codelineno-4-313"></a>            <span class="s1">&#39;max_age&#39;</span><span class="p">:</span> <span class="mi">1800</span><span class="p">,</span>  <span class="c1"># 30 minutes</span>
</span><span id="__span-4-314"><a id="__codelineno-4-314" name="__codelineno-4-314" href="#__codelineno-4-314"></a>            <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="s1">&#39;/&#39;</span>  <span class="c1"># Cookie available for entire domain</span>
</span><span id="__span-4-315"><a id="__codelineno-4-315" name="__codelineno-4-315" href="#__codelineno-4-315"></a>        <span class="p">}</span>
</span><span id="__span-4-316"><a id="__codelineno-4-316" name="__codelineno-4-316" href="#__codelineno-4-316"></a>
</span><span id="__span-4-317"><a id="__codelineno-4-317" name="__codelineno-4-317" href="#__codelineno-4-317"></a>        <span class="k">return</span> <span class="n">cookie_attributes</span>
</span><span id="__span-4-318"><a id="__codelineno-4-318" name="__codelineno-4-318" href="#__codelineno-4-318"></a>
</span><span id="__span-4-319"><a id="__codelineno-4-319" name="__codelineno-4-319" href="#__codelineno-4-319"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">validate_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request_data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="__span-4-320"><a id="__codelineno-4-320" name="__codelineno-4-320" href="#__codelineno-4-320"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate request with session security checks&quot;&quot;&quot;</span>
</span><span id="__span-4-321"><a id="__codelineno-4-321" name="__codelineno-4-321" href="#__codelineno-4-321"></a>
</span><span id="__span-4-322"><a id="__codelineno-4-322" name="__codelineno-4-322" href="#__codelineno-4-322"></a>        <span class="n">session_id</span> <span class="o">=</span> <span class="n">request_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;session_id&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
</span><span id="__span-4-323"><a id="__codelineno-4-323" name="__codelineno-4-323" href="#__codelineno-4-323"></a>        <span class="n">ip_address</span> <span class="o">=</span> <span class="n">request_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ip_address&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
</span><span id="__span-4-324"><a id="__codelineno-4-324" name="__codelineno-4-324" href="#__codelineno-4-324"></a>        <span class="n">user_agent</span> <span class="o">=</span> <span class="n">request_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;user_agent&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
</span><span id="__span-4-325"><a id="__codelineno-4-325" name="__codelineno-4-325" href="#__codelineno-4-325"></a>        <span class="n">csrf_token</span> <span class="o">=</span> <span class="n">request_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;csrf_token&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
</span><span id="__span-4-326"><a id="__codelineno-4-326" name="__codelineno-4-326" href="#__codelineno-4-326"></a>
</span><span id="__span-4-327"><a id="__codelineno-4-327" name="__codelineno-4-327" href="#__codelineno-4-327"></a>        <span class="c1"># Validate session</span>
</span><span id="__span-4-328"><a id="__codelineno-4-328" name="__codelineno-4-328" href="#__codelineno-4-328"></a>        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_manager</span><span class="o">.</span><span class="n">validate_session</span><span class="p">(</span>
</span><span id="__span-4-329"><a id="__codelineno-4-329" name="__codelineno-4-329" href="#__codelineno-4-329"></a>            <span class="n">session_id</span><span class="p">,</span> <span class="n">ip_address</span><span class="p">,</span> <span class="n">user_agent</span><span class="p">,</span> <span class="n">csrf_token</span>
</span><span id="__span-4-330"><a id="__codelineno-4-330" name="__codelineno-4-330" href="#__codelineno-4-330"></a>        <span class="p">)</span>
</span><span id="__span-4-331"><a id="__codelineno-4-331" name="__codelineno-4-331" href="#__codelineno-4-331"></a>
</span><span id="__span-4-332"><a id="__codelineno-4-332" name="__codelineno-4-332" href="#__codelineno-4-332"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">session</span><span class="p">:</span>
</span><span id="__span-4-333"><a id="__codelineno-4-333" name="__codelineno-4-333" href="#__codelineno-4-333"></a>            <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-4-334"><a id="__codelineno-4-334" name="__codelineno-4-334" href="#__codelineno-4-334"></a>                <span class="s1">&#39;valid&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="__span-4-335"><a id="__codelineno-4-335" name="__codelineno-4-335" href="#__codelineno-4-335"></a>                <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Invalid or expired session&#39;</span><span class="p">,</span>
</span><span id="__span-4-336"><a id="__codelineno-4-336" name="__codelineno-4-336" href="#__codelineno-4-336"></a>                <span class="s1">&#39;status_code&#39;</span><span class="p">:</span> <span class="mi">401</span>
</span><span id="__span-4-337"><a id="__codelineno-4-337" name="__codelineno-4-337" href="#__codelineno-4-337"></a>            <span class="p">}</span>
</span><span id="__span-4-338"><a id="__codelineno-4-338" name="__codelineno-4-338" href="#__codelineno-4-338"></a>
</span><span id="__span-4-339"><a id="__codelineno-4-339" name="__codelineno-4-339" href="#__codelineno-4-339"></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-4-340"><a id="__codelineno-4-340" name="__codelineno-4-340" href="#__codelineno-4-340"></a>            <span class="s1">&#39;valid&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="__span-4-341"><a id="__codelineno-4-341" name="__codelineno-4-341" href="#__codelineno-4-341"></a>            <span class="s1">&#39;session&#39;</span><span class="p">:</span> <span class="n">session</span><span class="p">,</span>
</span><span id="__span-4-342"><a id="__codelineno-4-342" name="__codelineno-4-342" href="#__codelineno-4-342"></a>            <span class="s1">&#39;user_id&#39;</span><span class="p">:</span> <span class="n">session</span><span class="o">.</span><span class="n">user_id</span><span class="p">,</span>
</span><span id="__span-4-343"><a id="__codelineno-4-343" name="__codelineno-4-343" href="#__codelineno-4-343"></a>            <span class="s1">&#39;permissions&#39;</span><span class="p">:</span> <span class="n">session</span><span class="o">.</span><span class="n">permissions</span>
</span><span id="__span-4-344"><a id="__codelineno-4-344" name="__codelineno-4-344" href="#__codelineno-4-344"></a>        <span class="p">}</span>
</span><span id="__span-4-345"><a id="__codelineno-4-345" name="__codelineno-4-345" href="#__codelineno-4-345"></a>
</span><span id="__span-4-346"><a id="__codelineno-4-346" name="__codelineno-4-346" href="#__codelineno-4-346"></a><span class="k">def</span><span class="w"> </span><span class="nf">session_management_example</span><span class="p">():</span>
</span><span id="__span-4-347"><a id="__codelineno-4-347" name="__codelineno-4-347" href="#__codelineno-4-347"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Demonstrate secure session management&quot;&quot;&quot;</span>
</span><span id="__span-4-348"><a id="__codelineno-4-348" name="__codelineno-4-348" href="#__codelineno-4-348"></a>
</span><span id="__span-4-349"><a id="__codelineno-4-349" name="__codelineno-4-349" href="#__codelineno-4-349"></a>    <span class="c1"># Initialize session manager</span>
</span><span id="__span-4-350"><a id="__codelineno-4-350" name="__codelineno-4-350" href="#__codelineno-4-350"></a>    <span class="n">session_manager</span> <span class="o">=</span> <span class="n">SecureSessionManager</span><span class="p">(</span>
</span><span id="__span-4-351"><a id="__codelineno-4-351" name="__codelineno-4-351" href="#__codelineno-4-351"></a>        <span class="n">session_timeout_minutes</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
</span><span id="__span-4-352"><a id="__codelineno-4-352" name="__codelineno-4-352" href="#__codelineno-4-352"></a>        <span class="n">max_sessions_per_user</span><span class="o">=</span><span class="mi">3</span>
</span><span id="__span-4-353"><a id="__codelineno-4-353" name="__codelineno-4-353" href="#__codelineno-4-353"></a>    <span class="p">)</span>
</span><span id="__span-4-354"><a id="__codelineno-4-354" name="__codelineno-4-354" href="#__codelineno-4-354"></a>
</span><span id="__span-4-355"><a id="__codelineno-4-355" name="__codelineno-4-355" href="#__codelineno-4-355"></a>    <span class="c1"># Create session for user login</span>
</span><span id="__span-4-356"><a id="__codelineno-4-356" name="__codelineno-4-356" href="#__codelineno-4-356"></a>    <span class="n">session_id</span><span class="p">,</span> <span class="n">csrf_token</span> <span class="o">=</span> <span class="n">session_manager</span><span class="o">.</span><span class="n">create_session</span><span class="p">(</span>
</span><span id="__span-4-357"><a id="__codelineno-4-357" name="__codelineno-4-357" href="#__codelineno-4-357"></a>        <span class="n">user_id</span><span class="o">=</span><span class="s2">&quot;user123&quot;</span><span class="p">,</span>
</span><span id="__span-4-358"><a id="__codelineno-4-358" name="__codelineno-4-358" href="#__codelineno-4-358"></a>        <span class="n">ip_address</span><span class="o">=</span><span class="s2">&quot;192.168.1.100&quot;</span><span class="p">,</span>
</span><span id="__span-4-359"><a id="__codelineno-4-359" name="__codelineno-4-359" href="#__codelineno-4-359"></a>        <span class="n">user_agent</span><span class="o">=</span><span class="s2">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36&quot;</span><span class="p">,</span>
</span><span id="__span-4-360"><a id="__codelineno-4-360" name="__codelineno-4-360" href="#__codelineno-4-360"></a>        <span class="n">permissions</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;read&quot;</span><span class="p">,</span> <span class="s2">&quot;write&quot;</span><span class="p">]</span>
</span><span id="__span-4-361"><a id="__codelineno-4-361" name="__codelineno-4-361" href="#__codelineno-4-361"></a>    <span class="p">)</span>
</span><span id="__span-4-362"><a id="__codelineno-4-362" name="__codelineno-4-362" href="#__codelineno-4-362"></a>
</span><span id="__span-4-363"><a id="__codelineno-4-363" name="__codelineno-4-363" href="#__codelineno-4-363"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Session created: </span><span class="si">{</span><span class="n">session_id</span><span class="p">[:</span><span class="mi">16</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
</span><span id="__span-4-364"><a id="__codelineno-4-364" name="__codelineno-4-364" href="#__codelineno-4-364"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;CSRF token: </span><span class="si">{</span><span class="n">csrf_token</span><span class="p">[:</span><span class="mi">16</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
</span><span id="__span-4-365"><a id="__codelineno-4-365" name="__codelineno-4-365" href="#__codelineno-4-365"></a>
</span><span id="__span-4-366"><a id="__codelineno-4-366" name="__codelineno-4-366" href="#__codelineno-4-366"></a>    <span class="c1"># Validate session</span>
</span><span id="__span-4-367"><a id="__codelineno-4-367" name="__codelineno-4-367" href="#__codelineno-4-367"></a>    <span class="n">session</span> <span class="o">=</span> <span class="n">session_manager</span><span class="o">.</span><span class="n">validate_session</span><span class="p">(</span>
</span><span id="__span-4-368"><a id="__codelineno-4-368" name="__codelineno-4-368" href="#__codelineno-4-368"></a>        <span class="n">session_id</span><span class="o">=</span><span class="n">session_id</span><span class="p">,</span>
</span><span id="__span-4-369"><a id="__codelineno-4-369" name="__codelineno-4-369" href="#__codelineno-4-369"></a>        <span class="n">ip_address</span><span class="o">=</span><span class="s2">&quot;192.168.1.100&quot;</span><span class="p">,</span>
</span><span id="__span-4-370"><a id="__codelineno-4-370" name="__codelineno-4-370" href="#__codelineno-4-370"></a>        <span class="n">user_agent</span><span class="o">=</span><span class="s2">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36&quot;</span><span class="p">,</span>
</span><span id="__span-4-371"><a id="__codelineno-4-371" name="__codelineno-4-371" href="#__codelineno-4-371"></a>        <span class="n">csrf_token</span><span class="o">=</span><span class="n">csrf_token</span>
</span><span id="__span-4-372"><a id="__codelineno-4-372" name="__codelineno-4-372" href="#__codelineno-4-372"></a>    <span class="p">)</span>
</span><span id="__span-4-373"><a id="__codelineno-4-373" name="__codelineno-4-373" href="#__codelineno-4-373"></a>
</span><span id="__span-4-374"><a id="__codelineno-4-374" name="__codelineno-4-374" href="#__codelineno-4-374"></a>    <span class="k">if</span> <span class="n">session</span><span class="p">:</span>
</span><span id="__span-4-375"><a id="__codelineno-4-375" name="__codelineno-4-375" href="#__codelineno-4-375"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Session valid for user: </span><span class="si">{</span><span class="n">session</span><span class="o">.</span><span class="n">user_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-4-376"><a id="__codelineno-4-376" name="__codelineno-4-376" href="#__codelineno-4-376"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Permissions: </span><span class="si">{</span><span class="n">session</span><span class="o">.</span><span class="n">permissions</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-4-377"><a id="__codelineno-4-377" name="__codelineno-4-377" href="#__codelineno-4-377"></a>
</span><span id="__span-4-378"><a id="__codelineno-4-378" name="__codelineno-4-378" href="#__codelineno-4-378"></a>    <span class="c1"># Demonstrate session refresh (prevent fixation)</span>
</span><span id="__span-4-379"><a id="__codelineno-4-379" name="__codelineno-4-379" href="#__codelineno-4-379"></a>    <span class="n">new_session_id</span> <span class="o">=</span> <span class="n">session_manager</span><span class="o">.</span><span class="n">refresh_session</span><span class="p">(</span><span class="n">session_id</span><span class="p">)</span>
</span><span id="__span-4-380"><a id="__codelineno-4-380" name="__codelineno-4-380" href="#__codelineno-4-380"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Session refreshed: </span><span class="si">{</span><span class="n">new_session_id</span><span class="p">[:</span><span class="mi">16</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
</span><span id="__span-4-381"><a id="__codelineno-4-381" name="__codelineno-4-381" href="#__codelineno-4-381"></a>
</span><span id="__span-4-382"><a id="__codelineno-4-382" name="__codelineno-4-382" href="#__codelineno-4-382"></a>    <span class="c1"># Show user&#39;s active sessions</span>
</span><span id="__span-4-383"><a id="__codelineno-4-383" name="__codelineno-4-383" href="#__codelineno-4-383"></a>    <span class="n">active_sessions</span> <span class="o">=</span> <span class="n">session_manager</span><span class="o">.</span><span class="n">get_user_sessions</span><span class="p">(</span><span class="s2">&quot;user123&quot;</span><span class="p">)</span>
</span><span id="__span-4-384"><a id="__codelineno-4-384" name="__codelineno-4-384" href="#__codelineno-4-384"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Active sessions for user: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">active_sessions</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-4-385"><a id="__codelineno-4-385" name="__codelineno-4-385" href="#__codelineno-4-385"></a>
</span><span id="__span-4-386"><a id="__codelineno-4-386" name="__codelineno-4-386" href="#__codelineno-4-386"></a>    <span class="c1"># Clean up</span>
</span><span id="__span-4-387"><a id="__codelineno-4-387" name="__codelineno-4-387" href="#__codelineno-4-387"></a>    <span class="n">session_manager</span><span class="o">.</span><span class="n">revoke_all_user_sessions</span><span class="p">(</span><span class="s2">&quot;user123&quot;</span><span class="p">)</span>
</span><span id="__span-4-388"><a id="__codelineno-4-388" name="__codelineno-4-388" href="#__codelineno-4-388"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;All user sessions revoked&quot;</span><span class="p">)</span>
</span><span id="__span-4-389"><a id="__codelineno-4-389" name="__codelineno-4-389" href="#__codelineno-4-389"></a>
</span><span id="__span-4-390"><a id="__codelineno-4-390" name="__codelineno-4-390" href="#__codelineno-4-390"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
</span><span id="__span-4-391"><a id="__codelineno-4-391" name="__codelineno-4-391" href="#__codelineno-4-391"></a>    <span class="n">session_management_example</span><span class="p">()</span>
</span></code></pre></div>
<h2 id="cors-and-cross-origin-security">CORS and Cross-Origin Security<a class="headerlink" href="#cors-and-cross-origin-security" title="Permanent link">&para;</a></h2>
<p>Cross-Origin Resource Sharing (CORS) is a critical security mechanism that controls how web applications can access resources from different domains.</p>
<h3 id="understanding-cors-security-model">Understanding CORS Security Model<a class="headerlink" href="#understanding-cors-security-model" title="Permanent link">&para;</a></h3>
<div class="diagram-container" data-container-id="kroki-diagram-2"><button class="diagram-expand-btn" onclick="openDiagramModal('kroki-diagram-2')">🔍 View Larger</button><div id="kroki-diagram-2" class="diagram-content"><p><svg xmlns="http://www.w3.org/2000/svg" contentStyleType="text/css" data-diagram-type="SEQUENCE" height="745px" preserveAspectRatio="xMaxYMax meet" style="width:565px;height:745px;background:#FFFFFF;" version="1.1" viewBox="0 0 565 745" width="565px" zoomAndPan="magnify" id="Kroki" data-diagram-id="kroki-svg-2"><defs /><g><rect fill="#FFFFFF" height="309.3984" style="stroke:#000000;stroke-width:1;" width="486.0713" x="30" y="367.1875" /><rect fill="#FFFFFF" height="130.3359" style="stroke:none;stroke-width:1;" width="486.0713" x="30" y="546.25" /><g><title>Web Browser</title><rect fill="#000000" fill-opacity="0.00000" height="640.9922" width="8" x="99.416" y="52.5938" /><line style="stroke:#000000;stroke-width:1;" x1="103" x2="103" y1="52.5938" y2="693.5859" /></g><g><title>Client App</title><rect fill="#000000" fill-opacity="0.00000" height="640.9922" width="8" x="266.9531" y="52.5938" /><line style="stroke:#000000;stroke-width:1;" x1="270.0635" x2="270.0635" y1="52.5938" y2="693.5859" /></g><g><title><span class="glossary-term" data-glossary-category="Web Development" data-glossary-definition="A set of protocols and tools for building software applications, defining how components interact." data-glossary-full-form="Application Programming Interface" data-glossary-term="API">API</span> Server</title><rect fill="#000000" fill-opacity="0.00000" height="640.9922" width="8" x="424.457" y="52.5938" /><line style="stroke:#000000;stroke-width:1;" x1="427.8428" x2="427.8428" y1="52.5938" y2="693.5859" /></g><g class="participant participant-head" data-participant="Browser"><rect fill="#FFFFFF" height="30.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="106.832" x="50" y="21.2969" /><text fill="#000000" font-family="Arial" font-size="14" lengthAdjust="spacing" textLength="92.832" x="57" y="41.292">Web Browser</text></g><g class="participant participant-tail" data-participant="Browser"><rect fill="#FFFFFF" height="30.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="106.832" x="50" y="692.5859" /><text fill="#000000" font-family="Arial" font-size="14" lengthAdjust="spacing" textLength="92.832" x="57" y="712.5811">Web Browser</text></g><g class="participant participant-head" data-participant="Client"><rect fill="#FFFFFF" height="46.5938" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="119.7793" x="211.0635" y="5" /><text fill="#000000" font-family="Arial" font-size="14" lengthAdjust="spacing" textLength="72.3311" x="234.7876" y="24.9951">Client App</text><text fill="#000000" font-family="Arial" font-size="14" lengthAdjust="spacing" textLength="105.7793" x="218.0635" y="41.292">(example.com)</text></g><g class="participant participant-tail" data-participant="Client"><rect fill="#FFFFFF" height="46.5938" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="119.7793" x="211.0635" y="692.5859" /><text fill="#000000" font-family="Arial" font-size="14" lengthAdjust="spacing" textLength="72.3311" x="234.7876" y="712.5811">Client App</text><text fill="#000000" font-family="Arial" font-size="14" lengthAdjust="spacing" textLength="105.7793" x="218.0635" y="728.8779">(example.com)</text></g><g class="participant participant-head" data-participant="API"><rect fill="#FFFFFF" height="46.5938" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="135.2285" x="360.8428" y="5" /><text fill="#000000" font-family="Arial" font-size="14" lengthAdjust="spacing" textLength="72.5088" x="392.2026" y="24.9951"><span class="glossary-term" data-glossary-category="Web Development" data-glossary-definition="A set of protocols and tools for building software applications, defining how components interact." data-glossary-full-form="Application Programming Interface" data-glossary-term="API">API</span> Server</text><text fill="#000000" font-family="Arial" font-size="14" lengthAdjust="spacing" textLength="121.2285" x="367.8428" y="41.292">(<span class="glossary-term" data-glossary-category="Web Development" data-glossary-definition="A set of protocols and tools for building software applications, defining how components interact." data-glossary-full-form="Application Programming Interface" data-glossary-term="API">api</span>.service.com)</text></g><g class="participant participant-tail" data-participant="API"><rect fill="#FFFFFF" height="46.5938" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="135.2285" x="360.8428" y="692.5859" /><text fill="#000000" font-family="Arial" font-size="14" lengthAdjust="spacing" textLength="72.5088" x="392.2026" y="712.5811"><span class="glossary-term" data-glossary-category="Web Development" data-glossary-definition="A set of protocols and tools for building software applications, defining how components interact." data-glossary-full-form="Application Programming Interface" data-glossary-term="API">API</span> Server</text><text fill="#000000" font-family="Arial" font-size="14" lengthAdjust="spacing" textLength="121.2285" x="367.8428" y="728.8779">(<span class="glossary-term" data-glossary-category="Web Development" data-glossary-definition="A set of protocols and tools for building software applications, defining how components interact." data-glossary-full-form="Application Programming Interface" data-glossary-term="API">api</span>.service.com)</text></g><g class="message" data-participant-1="Browser" data-participant-2="Client"><polygon fill="#000000" points="258.9531,79.7266,268.9531,83.7266,258.9531,87.7266,262.9531,83.7266" style="stroke:#000000;stroke-width:1;" /><line style="stroke:#000000;stroke-width:1;" x1="103.416" x2="264.9531" y1="83.7266" y2="83.7266" /><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="107.2563" x="110.416" y="78.6606">Load application</text></g><g class="message" data-participant-1="Client" data-participant-2="Browser"><polygon fill="#000000" points="114.416,123.9922,104.416,127.9922,114.416,131.9922,110.416,127.9922" style="stroke:#000000;stroke-width:1;" /><line style="stroke:#000000;stroke-width:1;" x1="108.416" x2="269.9531" y1="127.9922" y2="127.9922" /><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="130.4253" x="120.416" y="107.7935">Make <span class="glossary-term" data-glossary-category="Web Development" data-glossary-definition="A set of protocols and tools for building software applications, defining how components interact." data-glossary-full-form="Application Programming Interface" data-glossary-term="API">API</span> request to</text><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="96.8398" x="120.416" y="122.9263">different origin</text></g><path d="M10,140.9922 L10,165.9922 L197,165.9922 L197,150.9922 L187,140.9922 L10,140.9922" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;" /><path d="M187,140.9922 L187,150.9922 L197,150.9922 L187,140.9922" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;" /><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="166.9751" x="16" y="158.0591">Same-Origin Policy Check</text><g class="message" data-participant-1="Browser" data-participant-2="Browser"><line style="stroke:#000000;stroke-width:1;" x1="103.416" x2="145.416" y1="222.5234" y2="222.5234" /><line style="stroke:#000000;stroke-width:1;" x1="145.416" x2="145.416" y1="222.5234" y2="235.5234" /><line style="stroke:#000000;stroke-width:1;" x1="104.416" x2="145.416" y1="235.5234" y2="235.5234" /><polygon fill="#000000" points="114.416,231.5234,104.416,235.5234,114.416,239.5234,110.416,235.5234" style="stroke:#000000;stroke-width:1;" /><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="135.8843" x="110.416" y="187.1919">Origin: example.com</text><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="153.5371" x="110.416" y="202.3247">Target: <span class="glossary-term" data-glossary-category="Web Development" data-glossary-definition="A set of protocols and tools for building software applications, defining how components interact." data-glossary-full-form="Application Programming Interface" data-glossary-term="API">api</span>.service.com</text><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="120.7261" x="110.416" y="217.4575">(Different origins!)</text></g><g class="message" data-participant-1="Browser" data-participant-2="API"><polygon fill="#000000" points="416.457,290.9219,426.457,294.9219,416.457,298.9219,420.457,294.9219" style="stroke:#000000;stroke-width:1;" /><line style="stroke:#000000;stroke-width:1;" x1="103.416" x2="422.457" y1="294.9219" y2="294.9219" /><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="120.104" x="110.416" y="259.5903">Preflight REQUEST</text><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="120.0596" x="110.416" y="274.7231">OPTIONS /<span class="glossary-term" data-glossary-category="Web Development" data-glossary-definition="A set of protocols and tools for building software applications, defining how components interact." data-glossary-full-form="Application Programming Interface" data-glossary-term="API">api</span>/data</text><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="135.8843" x="110.416" y="289.856">Origin: example.com</text></g><g class="message" data-participant-1="API" data-participant-2="API"><line style="stroke:#000000;stroke-width:1;" x1="428.457" x2="470.457" y1="339.1875" y2="339.1875" /><line style="stroke:#000000;stroke-width:1;" x1="470.457" x2="470.457" y1="339.1875" y2="352.1875" /><line style="stroke:#000000;stroke-width:1;" x1="429.457" x2="470.457" y1="352.1875" y2="352.1875" /><polygon fill="#000000" points="439.457,348.1875,429.457,352.1875,439.457,356.1875,435.457,352.1875" style="stroke:#000000;stroke-width:1;" /><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="123.1191" x="435.457" y="318.9888">Check CORS policy</text><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="110.0874" x="435.457" y="334.1216">for example.com</text></g><path d="M30,367.1875 L94.4429,367.1875 L94.4429,374.3203 L84.4429,384.3203 L30,384.3203 L30,367.1875" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;" /><rect fill="none" height="309.3984" style="stroke:#000000;stroke-width:1;" width="486.0713" x="30" y="367.1875" /><text fill="#000000" font-family="Arial" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="19.4429" x="45" y="380.2544">alt</text><text fill="#000000" font-family="Arial" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="96.8086" x="109.4429" y="379.3979">[CORS Allowed]</text><g class="message" data-participant-1="API" data-participant-2="Browser"><polygon fill="#000000" points="114.416,431.7188,104.416,435.7188,114.416,439.7188,110.416,435.7188" style="stroke:#000000;stroke-width:1;" /><line style="stroke:#000000;stroke-width:1;" x1="108.416" x2="427.457" y1="435.7188" y2="435.7188" /><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="47.7026" x="120.416" y="400.3872">200 OK</text><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="276.6689" x="120.416" y="415.52">Access-Control-Allow-Origin: example.com</text><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="273.584" x="120.416" y="430.6528">Access-Control-Allow-<span class="glossary-term" data-glossary-category="OOP" data-glossary-definition="A function defined within a class that describes the behaviors of objects created from that class." data-glossary-term="Method">Methods</span>: GET, POST</text></g><g class="message" data-participant-1="Browser" data-participant-2="API"><polygon fill="#000000" points="416.457,475.9844,426.457,479.9844,416.457,483.9844,420.457,479.9844" style="stroke:#000000;stroke-width:1;" /><line style="stroke:#000000;stroke-width:1;" x1="103.416" x2="422.457" y1="479.9844" y2="479.9844" /><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="106.4883" x="110.416" y="459.7856">Actual REQUEST</text><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="88.2324" x="110.416" y="474.9185">GET /<span class="glossary-term" data-glossary-category="Web Development" data-glossary-definition="A set of protocols and tools for building software applications, defining how components interact." data-glossary-full-form="Application Programming Interface" data-glossary-term="API">api</span>/data</text></g><g class="message" data-participant-1="API" data-participant-2="Browser"><polygon fill="#000000" points="114.416,505.1172,104.416,509.1172,114.416,513.1172,110.416,509.1172" style="stroke:#000000;stroke-width:1;" /><line style="stroke:#000000;stroke-width:1;" x1="108.416" x2="427.457" y1="509.1172" y2="509.1172" /><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="97.8999" x="120.416" y="504.0513">200 OK + Data</text></g><g class="message" data-participant-1="Browser" data-participant-2="Client"><polygon fill="#000000" points="258.9531,534.25,268.9531,538.25,258.9531,542.25,262.9531,538.25" style="stroke:#000000;stroke-width:1;" /><line style="stroke:#000000;stroke-width:1;" x1="103.416" x2="264.9531" y1="538.25" y2="538.25" /><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="115.7939" x="110.416" y="533.1841">Success response</text></g><line style="stroke:#000000;stroke-width:1;stroke-dasharray:2.0,2.0;" x1="30" x2="516.0713" y1="547.25" y2="547.25" /><text fill="#000000" font-family="Arial" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="91.228" x="35" y="557.4604">[CORS Denied]</text><g class="message" data-participant-1="API" data-participant-2="Browser"><polygon fill="#000000" points="114.416,593.3203,104.416,597.3203,114.416,601.3203,110.416,597.3203" style="stroke:#000000;stroke-width:1;" /><line style="stroke:#000000;stroke-width:1;" x1="108.416" x2="427.457" y1="597.3203" y2="597.3203" /><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="94.3262" x="120.416" y="577.1216">403 Forbidden</text><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="125.252" x="120.416" y="592.2544">(No CORS headers)</text></g><g class="message" data-participant-1="Browser" data-participant-2="Browser"><line style="stroke:#000000;stroke-width:1;" x1="103.416" x2="145.416" y1="626.4531" y2="626.4531" /><line style="stroke:#000000;stroke-width:1;" x1="145.416" x2="145.416" y1="626.4531" y2="639.4531" /><line style="stroke:#000000;stroke-width:1;" x1="104.416" x2="145.416" y1="639.4531" y2="639.4531" /><polygon fill="#000000" points="114.416,635.4531,104.416,639.4531,114.416,643.4531,110.416,639.4531" style="stroke:#000000;stroke-width:1;" /><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="98.6235" x="110.416" y="621.3872">Block response</text></g><g class="message" data-participant-1="Browser" data-participant-2="Client"><polygon fill="#000000" points="258.9531,664.5859,268.9531,668.5859,258.9531,672.5859,262.9531,668.5859" style="stroke:#000000;stroke-width:1;" /><line style="stroke:#000000;stroke-width:1;" x1="103.416" x2="264.9531" y1="668.5859" y2="668.5859" /><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="72.9282" x="110.416" y="663.52">CORS Error</text></g></g></svg></p></div></div>
<h3 id="comprehensive-cors-implementation">Comprehensive CORS Implementation<a class="headerlink" href="#comprehensive-cors-implementation" title="Permanent link">&para;</a></h3>
<div class="language-python highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Union</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">urllib.parse</span><span class="w"> </span><span class="kn">import</span> <span class="n">urlparse</span>
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a>
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a><span class="nd">@dataclass</span>
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a><span class="k">class</span><span class="w"> </span><span class="nc">CORSPolicy</span><span class="p">:</span>
</span><span id="__span-5-8"><a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;CORS policy configuration&quot;&quot;&quot;</span>
</span><span id="__span-5-9"><a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a>    <span class="n">allowed_origins</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span><span id="__span-5-10"><a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a>    <span class="n">allowed_methods</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span><span id="__span-5-11"><a id="__codelineno-5-11" name="__codelineno-5-11" href="#__codelineno-5-11"></a>    <span class="n">allowed_headers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span><span id="__span-5-12"><a id="__codelineno-5-12" name="__codelineno-5-12" href="#__codelineno-5-12"></a>    <span class="n">exposed_headers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span><span id="__span-5-13"><a id="__codelineno-5-13" name="__codelineno-5-13" href="#__codelineno-5-13"></a>    <span class="n">allow_credentials</span><span class="p">:</span> <span class="nb">bool</span>
</span><span id="__span-5-14"><a id="__codelineno-5-14" name="__codelineno-5-14" href="#__codelineno-5-14"></a>    <span class="n">max_age</span><span class="p">:</span> <span class="nb">int</span>  <span class="c1"># Preflight cache duration in seconds</span>
</span><span id="__span-5-15"><a id="__codelineno-5-15" name="__codelineno-5-15" href="#__codelineno-5-15"></a>
</span><span id="__span-5-16"><a id="__codelineno-5-16" name="__codelineno-5-16" href="#__codelineno-5-16"></a><span class="k">class</span><span class="w"> </span><span class="nc">CORSManager</span><span class="p">:</span>
</span><span id="__span-5-17"><a id="__codelineno-5-17" name="__codelineno-5-17" href="#__codelineno-5-17"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Production-ready CORS management with security features&quot;&quot;&quot;</span>
</span><span id="__span-5-18"><a id="__codelineno-5-18" name="__codelineno-5-18" href="#__codelineno-5-18"></a>
</span><span id="__span-5-19"><a id="__codelineno-5-19" name="__codelineno-5-19" href="#__codelineno-5-19"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-5-20"><a id="__codelineno-5-20" name="__codelineno-5-20" href="#__codelineno-5-20"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">policies</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">CORSPolicy</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="__span-5-21"><a id="__codelineno-5-21" name="__codelineno-5-21" href="#__codelineno-5-21"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">default_policy</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">CORSPolicy</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-5-22"><a id="__codelineno-5-22" name="__codelineno-5-22" href="#__codelineno-5-22"></a>
</span><span id="__span-5-23"><a id="__codelineno-5-23" name="__codelineno-5-23" href="#__codelineno-5-23"></a>        <span class="c1"># Security patterns</span>
</span><span id="__span-5-24"><a id="__codelineno-5-24" name="__codelineno-5-24" href="#__codelineno-5-24"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dangerous_origins</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="__span-5-25"><a id="__codelineno-5-25" name="__codelineno-5-25" href="#__codelineno-5-25"></a>            <span class="sa">r</span><span class="s1">&#39;.*\.evil\.com$&#39;</span><span class="p">,</span>
</span><span id="__span-5-26"><a id="__codelineno-5-26" name="__codelineno-5-26" href="#__codelineno-5-26"></a>            <span class="sa">r</span><span class="s1">&#39;.*malicious.*&#39;</span><span class="p">,</span>
</span><span id="__span-5-27"><a id="__codelineno-5-27" name="__codelineno-5-27" href="#__codelineno-5-27"></a>            <span class="sa">r</span><span class="s1">&#39;file://&#39;</span><span class="p">,</span>  <span class="c1"># Block file:// origins</span>
</span><span id="__span-5-28"><a id="__codelineno-5-28" name="__codelineno-5-28" href="#__codelineno-5-28"></a>            <span class="sa">r</span><span class="s1">&#39;data:&#39;</span><span class="p">,</span>    <span class="c1"># Block data: origins</span>
</span><span id="__span-5-29"><a id="__codelineno-5-29" name="__codelineno-5-29" href="#__codelineno-5-29"></a>        <span class="p">]</span>
</span><span id="__span-5-30"><a id="__codelineno-5-30" name="__codelineno-5-30" href="#__codelineno-5-30"></a>
</span><span id="__span-5-31"><a id="__codelineno-5-31" name="__codelineno-5-31" href="#__codelineno-5-31"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">add_policy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">policy_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">policy</span><span class="p">:</span> <span class="n">CORSPolicy</span><span class="p">):</span>
</span><span id="__span-5-32"><a id="__codelineno-5-32" name="__codelineno-5-32" href="#__codelineno-5-32"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a named CORS policy&quot;&quot;&quot;</span>
</span><span id="__span-5-33"><a id="__codelineno-5-33" name="__codelineno-5-33" href="#__codelineno-5-33"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">policies</span><span class="p">[</span><span class="n">policy_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">policy</span>
</span><span id="__span-5-34"><a id="__codelineno-5-34" name="__codelineno-5-34" href="#__codelineno-5-34"></a>
</span><span id="__span-5-35"><a id="__codelineno-5-35" name="__codelineno-5-35" href="#__codelineno-5-35"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">set_default_policy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">policy</span><span class="p">:</span> <span class="n">CORSPolicy</span><span class="p">):</span>
</span><span id="__span-5-36"><a id="__codelineno-5-36" name="__codelineno-5-36" href="#__codelineno-5-36"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Set default CORS policy&quot;&quot;&quot;</span>
</span><span id="__span-5-37"><a id="__codelineno-5-37" name="__codelineno-5-37" href="#__codelineno-5-37"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">default_policy</span> <span class="o">=</span> <span class="n">policy</span>
</span><span id="__span-5-38"><a id="__codelineno-5-38" name="__codelineno-5-38" href="#__codelineno-5-38"></a>
</span><span id="__span-5-39"><a id="__codelineno-5-39" name="__codelineno-5-39" href="#__codelineno-5-39"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_secure_policy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">allowed_origins</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> 
</span><span id="__span-5-40"><a id="__codelineno-5-40" name="__codelineno-5-40" href="#__codelineno-5-40"></a>                           <span class="n">allow_credentials</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CORSPolicy</span><span class="p">:</span>
</span><span id="__span-5-41"><a id="__codelineno-5-41" name="__codelineno-5-41" href="#__codelineno-5-41"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a secure CORS policy with safe defaults&quot;&quot;&quot;</span>
</span><span id="__span-5-42"><a id="__codelineno-5-42" name="__codelineno-5-42" href="#__codelineno-5-42"></a>
</span><span id="__span-5-43"><a id="__codelineno-5-43" name="__codelineno-5-43" href="#__codelineno-5-43"></a>        <span class="c1"># Validate origins for security</span>
</span><span id="__span-5-44"><a id="__codelineno-5-44" name="__codelineno-5-44" href="#__codelineno-5-44"></a>        <span class="n">validated_origins</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-5-45"><a id="__codelineno-5-45" name="__codelineno-5-45" href="#__codelineno-5-45"></a>        <span class="k">for</span> <span class="n">origin</span> <span class="ow">in</span> <span class="n">allowed_origins</span><span class="p">:</span>
</span><span id="__span-5-46"><a id="__codelineno-5-46" name="__codelineno-5-46" href="#__codelineno-5-46"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_safe_origin</span><span class="p">(</span><span class="n">origin</span><span class="p">):</span>
</span><span id="__span-5-47"><a id="__codelineno-5-47" name="__codelineno-5-47" href="#__codelineno-5-47"></a>                <span class="n">validated_origins</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">origin</span><span class="p">)</span>
</span><span id="__span-5-48"><a id="__codelineno-5-48" name="__codelineno-5-48" href="#__codelineno-5-48"></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="__span-5-49"><a id="__codelineno-5-49" name="__codelineno-5-49" href="#__codelineno-5-49"></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Potentially unsafe origin blocked: </span><span class="si">{</span><span class="n">origin</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-5-50"><a id="__codelineno-5-50" name="__codelineno-5-50" href="#__codelineno-5-50"></a>
</span><span id="__span-5-51"><a id="__codelineno-5-51" name="__codelineno-5-51" href="#__codelineno-5-51"></a>        <span class="k">return</span> <span class="n">CORSPolicy</span><span class="p">(</span>
</span><span id="__span-5-52"><a id="__codelineno-5-52" name="__codelineno-5-52" href="#__codelineno-5-52"></a>            <span class="n">allowed_origins</span><span class="o">=</span><span class="n">validated_origins</span><span class="p">,</span>
</span><span id="__span-5-53"><a id="__codelineno-5-53" name="__codelineno-5-53" href="#__codelineno-5-53"></a>            <span class="n">allowed_methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">,</span> <span class="s1">&#39;PUT&#39;</span><span class="p">,</span> <span class="s1">&#39;DELETE&#39;</span><span class="p">,</span> <span class="s1">&#39;OPTIONS&#39;</span><span class="p">],</span>
</span><span id="__span-5-54"><a id="__codelineno-5-54" name="__codelineno-5-54" href="#__codelineno-5-54"></a>            <span class="n">allowed_headers</span><span class="o">=</span><span class="p">[</span>
</span><span id="__span-5-55"><a id="__codelineno-5-55" name="__codelineno-5-55" href="#__codelineno-5-55"></a>                <span class="s1">&#39;Content-Type&#39;</span><span class="p">,</span>
</span><span id="__span-5-56"><a id="__codelineno-5-56" name="__codelineno-5-56" href="#__codelineno-5-56"></a>                <span class="s1">&#39;Authorization&#39;</span><span class="p">,</span> 
</span><span id="__span-5-57"><a id="__codelineno-5-57" name="__codelineno-5-57" href="#__codelineno-5-57"></a>                <span class="s1">&#39;X-Requested-With&#39;</span><span class="p">,</span>
</span><span id="__span-5-58"><a id="__codelineno-5-58" name="__codelineno-5-58" href="#__codelineno-5-58"></a>                <span class="s1">&#39;X-CSRF-Token&#39;</span>
</span><span id="__span-5-59"><a id="__codelineno-5-59" name="__codelineno-5-59" href="#__codelineno-5-59"></a>            <span class="p">],</span>
</span><span id="__span-5-60"><a id="__codelineno-5-60" name="__codelineno-5-60" href="#__codelineno-5-60"></a>            <span class="n">exposed_headers</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;X-Total-Count&#39;</span><span class="p">,</span> <span class="s1">&#39;X-Page-Count&#39;</span><span class="p">],</span>
</span><span id="__span-5-61"><a id="__codelineno-5-61" name="__codelineno-5-61" href="#__codelineno-5-61"></a>            <span class="n">allow_credentials</span><span class="o">=</span><span class="n">allow_credentials</span><span class="p">,</span>
</span><span id="__span-5-62"><a id="__codelineno-5-62" name="__codelineno-5-62" href="#__codelineno-5-62"></a>            <span class="n">max_age</span><span class="o">=</span><span class="mi">86400</span>  <span class="c1"># 24 hours</span>
</span><span id="__span-5-63"><a id="__codelineno-5-63" name="__codelineno-5-63" href="#__codelineno-5-63"></a>        <span class="p">)</span>
</span><span id="__span-5-64"><a id="__codelineno-5-64" name="__codelineno-5-64" href="#__codelineno-5-64"></a>
</span><span id="__span-5-65"><a id="__codelineno-5-65" name="__codelineno-5-65" href="#__codelineno-5-65"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_is_safe_origin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">origin</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="__span-5-66"><a id="__codelineno-5-66" name="__codelineno-5-66" href="#__codelineno-5-66"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate origin against security patterns&quot;&quot;&quot;</span>
</span><span id="__span-5-67"><a id="__codelineno-5-67" name="__codelineno-5-67" href="#__codelineno-5-67"></a>
</span><span id="__span-5-68"><a id="__codelineno-5-68" name="__codelineno-5-68" href="#__codelineno-5-68"></a>        <span class="c1"># Check against dangerous patterns</span>
</span><span id="__span-5-69"><a id="__codelineno-5-69" name="__codelineno-5-69" href="#__codelineno-5-69"></a>        <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dangerous_origins</span><span class="p">:</span>
</span><span id="__span-5-70"><a id="__codelineno-5-70" name="__codelineno-5-70" href="#__codelineno-5-70"></a>            <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">origin</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">):</span>
</span><span id="__span-5-71"><a id="__codelineno-5-71" name="__codelineno-5-71" href="#__codelineno-5-71"></a>                <span class="k">return</span> <span class="kc">False</span>
</span><span id="__span-5-72"><a id="__codelineno-5-72" name="__codelineno-5-72" href="#__codelineno-5-72"></a>
</span><span id="__span-5-73"><a id="__codelineno-5-73" name="__codelineno-5-73" href="#__codelineno-5-73"></a>        <span class="c1"># Validate URL format</span>
</span><span id="__span-5-74"><a id="__codelineno-5-74" name="__codelineno-5-74" href="#__codelineno-5-74"></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="__span-5-75"><a id="__codelineno-5-75" name="__codelineno-5-75" href="#__codelineno-5-75"></a>            <span class="n">parsed</span> <span class="o">=</span> <span class="n">urlparse</span><span class="p">(</span><span class="n">origin</span><span class="p">)</span>
</span><span id="__span-5-76"><a id="__codelineno-5-76" name="__codelineno-5-76" href="#__codelineno-5-76"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">parsed</span><span class="o">.</span><span class="n">scheme</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">parsed</span><span class="o">.</span><span class="n">netloc</span><span class="p">:</span>
</span><span id="__span-5-77"><a id="__codelineno-5-77" name="__codelineno-5-77" href="#__codelineno-5-77"></a>                <span class="k">return</span> <span class="kc">False</span>
</span><span id="__span-5-78"><a id="__codelineno-5-78" name="__codelineno-5-78" href="#__codelineno-5-78"></a>
</span><span id="__span-5-79"><a id="__codelineno-5-79" name="__codelineno-5-79" href="#__codelineno-5-79"></a>            <span class="c1"># Only allow HTTP/HTTPS</span>
</span><span id="__span-5-80"><a id="__codelineno-5-80" name="__codelineno-5-80" href="#__codelineno-5-80"></a>            <span class="k">if</span> <span class="n">parsed</span><span class="o">.</span><span class="n">scheme</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;http&#39;</span><span class="p">,</span> <span class="s1">&#39;https&#39;</span><span class="p">]:</span>
</span><span id="__span-5-81"><a id="__codelineno-5-81" name="__codelineno-5-81" href="#__codelineno-5-81"></a>                <span class="k">return</span> <span class="kc">False</span>
</span><span id="__span-5-82"><a id="__codelineno-5-82" name="__codelineno-5-82" href="#__codelineno-5-82"></a>
</span><span id="__span-5-83"><a id="__codelineno-5-83" name="__codelineno-5-83" href="#__codelineno-5-83"></a>        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="__span-5-84"><a id="__codelineno-5-84" name="__codelineno-5-84" href="#__codelineno-5-84"></a>            <span class="k">return</span> <span class="kc">False</span>
</span><span id="__span-5-85"><a id="__codelineno-5-85" name="__codelineno-5-85" href="#__codelineno-5-85"></a>
</span><span id="__span-5-86"><a id="__codelineno-5-86" name="__codelineno-5-86" href="#__codelineno-5-86"></a>        <span class="k">return</span> <span class="kc">True</span>
</span><span id="__span-5-87"><a id="__codelineno-5-87" name="__codelineno-5-87" href="#__codelineno-5-87"></a>
</span><span id="__span-5-88"><a id="__codelineno-5-88" name="__codelineno-5-88" href="#__codelineno-5-88"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">handle_preflight_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">origin</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">method</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
</span><span id="__span-5-89"><a id="__codelineno-5-89" name="__codelineno-5-89" href="#__codelineno-5-89"></a>                                <span class="n">headers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">policy_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
</span><span id="__span-5-90"><a id="__codelineno-5-90" name="__codelineno-5-90" href="#__codelineno-5-90"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle CORS preflight request&quot;&quot;&quot;</span>
</span><span id="__span-5-91"><a id="__codelineno-5-91" name="__codelineno-5-91" href="#__codelineno-5-91"></a>
</span><span id="__span-5-92"><a id="__codelineno-5-92" name="__codelineno-5-92" href="#__codelineno-5-92"></a>        <span class="c1"># Get applicable policy</span>
</span><span id="__span-5-93"><a id="__codelineno-5-93" name="__codelineno-5-93" href="#__codelineno-5-93"></a>        <span class="n">policy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_policy</span><span class="p">(</span><span class="n">policy_name</span><span class="p">)</span>
</span><span id="__span-5-94"><a id="__codelineno-5-94" name="__codelineno-5-94" href="#__codelineno-5-94"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">policy</span><span class="p">:</span>
</span><span id="__span-5-95"><a id="__codelineno-5-95" name="__codelineno-5-95" href="#__codelineno-5-95"></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_cors_denial</span><span class="p">()</span>
</span><span id="__span-5-96"><a id="__codelineno-5-96" name="__codelineno-5-96" href="#__codelineno-5-96"></a>
</span><span id="__span-5-97"><a id="__codelineno-5-97" name="__codelineno-5-97" href="#__codelineno-5-97"></a>        <span class="c1"># Validate origin</span>
</span><span id="__span-5-98"><a id="__codelineno-5-98" name="__codelineno-5-98" href="#__codelineno-5-98"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_origin_allowed</span><span class="p">(</span><span class="n">origin</span><span class="p">,</span> <span class="n">policy</span><span class="p">):</span>
</span><span id="__span-5-99"><a id="__codelineno-5-99" name="__codelineno-5-99" href="#__codelineno-5-99"></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_cors_denial</span><span class="p">()</span>
</span><span id="__span-5-100"><a id="__codelineno-5-100" name="__codelineno-5-100" href="#__codelineno-5-100"></a>
</span><span id="__span-5-101"><a id="__codelineno-5-101" name="__codelineno-5-101" href="#__codelineno-5-101"></a>        <span class="c1"># Validate method</span>
</span><span id="__span-5-102"><a id="__codelineno-5-102" name="__codelineno-5-102" href="#__codelineno-5-102"></a>        <span class="k">if</span> <span class="n">method</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">policy</span><span class="o">.</span><span class="n">allowed_methods</span><span class="p">:</span>
</span><span id="__span-5-103"><a id="__codelineno-5-103" name="__codelineno-5-103" href="#__codelineno-5-103"></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_cors_denial</span><span class="p">()</span>
</span><span id="__span-5-104"><a id="__codelineno-5-104" name="__codelineno-5-104" href="#__codelineno-5-104"></a>
</span><span id="__span-5-105"><a id="__codelineno-5-105" name="__codelineno-5-105" href="#__codelineno-5-105"></a>        <span class="c1"># Validate headers</span>
</span><span id="__span-5-106"><a id="__codelineno-5-106" name="__codelineno-5-106" href="#__codelineno-5-106"></a>        <span class="k">for</span> <span class="n">header</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">:</span>
</span><span id="__span-5-107"><a id="__codelineno-5-107" name="__codelineno-5-107" href="#__codelineno-5-107"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_header_allowed</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">policy</span><span class="p">):</span>
</span><span id="__span-5-108"><a id="__codelineno-5-108" name="__codelineno-5-108" href="#__codelineno-5-108"></a>                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_cors_denial</span><span class="p">()</span>
</span><span id="__span-5-109"><a id="__codelineno-5-109" name="__codelineno-5-109" href="#__codelineno-5-109"></a>
</span><span id="__span-5-110"><a id="__codelineno-5-110" name="__codelineno-5-110" href="#__codelineno-5-110"></a>        <span class="c1"># Create successful preflight response</span>
</span><span id="__span-5-111"><a id="__codelineno-5-111" name="__codelineno-5-111" href="#__codelineno-5-111"></a>        <span class="n">response_headers</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-5-112"><a id="__codelineno-5-112" name="__codelineno-5-112" href="#__codelineno-5-112"></a>            <span class="s1">&#39;Access-Control-Allow-Origin&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_origin_response</span><span class="p">(</span><span class="n">origin</span><span class="p">,</span> <span class="n">policy</span><span class="p">),</span>
</span><span id="__span-5-113"><a id="__codelineno-5-113" name="__codelineno-5-113" href="#__codelineno-5-113"></a>            <span class="s1">&#39;Access-Control-Allow-Methods&#39;</span><span class="p">:</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">policy</span><span class="o">.</span><span class="n">allowed_methods</span><span class="p">),</span>
</span><span id="__span-5-114"><a id="__codelineno-5-114" name="__codelineno-5-114" href="#__codelineno-5-114"></a>            <span class="s1">&#39;Access-Control-Allow-Headers&#39;</span><span class="p">:</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">policy</span><span class="o">.</span><span class="n">allowed_headers</span><span class="p">),</span>
</span><span id="__span-5-115"><a id="__codelineno-5-115" name="__codelineno-5-115" href="#__codelineno-5-115"></a>            <span class="s1">&#39;Access-Control-Max-Age&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">policy</span><span class="o">.</span><span class="n">max_age</span><span class="p">),</span>
</span><span id="__span-5-116"><a id="__codelineno-5-116" name="__codelineno-5-116" href="#__codelineno-5-116"></a>            <span class="s1">&#39;Vary&#39;</span><span class="p">:</span> <span class="s1">&#39;Origin&#39;</span>  <span class="c1"># Important for caching</span>
</span><span id="__span-5-117"><a id="__codelineno-5-117" name="__codelineno-5-117" href="#__codelineno-5-117"></a>        <span class="p">}</span>
</span><span id="__span-5-118"><a id="__codelineno-5-118" name="__codelineno-5-118" href="#__codelineno-5-118"></a>
</span><span id="__span-5-119"><a id="__codelineno-5-119" name="__codelineno-5-119" href="#__codelineno-5-119"></a>        <span class="k">if</span> <span class="n">policy</span><span class="o">.</span><span class="n">allow_credentials</span><span class="p">:</span>
</span><span id="__span-5-120"><a id="__codelineno-5-120" name="__codelineno-5-120" href="#__codelineno-5-120"></a>            <span class="n">response_headers</span><span class="p">[</span><span class="s1">&#39;Access-Control-Allow-Credentials&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;true&#39;</span>
</span><span id="__span-5-121"><a id="__codelineno-5-121" name="__codelineno-5-121" href="#__codelineno-5-121"></a>
</span><span id="__span-5-122"><a id="__codelineno-5-122" name="__codelineno-5-122" href="#__codelineno-5-122"></a>        <span class="k">return</span> <span class="n">response_headers</span>
</span><span id="__span-5-123"><a id="__codelineno-5-123" name="__codelineno-5-123" href="#__codelineno-5-123"></a>
</span><span id="__span-5-124"><a id="__codelineno-5-124" name="__codelineno-5-124" href="#__codelineno-5-124"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">handle_actual_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">origin</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">policy_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
</span><span id="__span-5-125"><a id="__codelineno-5-125" name="__codelineno-5-125" href="#__codelineno-5-125"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle actual CORS request&quot;&quot;&quot;</span>
</span><span id="__span-5-126"><a id="__codelineno-5-126" name="__codelineno-5-126" href="#__codelineno-5-126"></a>
</span><span id="__span-5-127"><a id="__codelineno-5-127" name="__codelineno-5-127" href="#__codelineno-5-127"></a>        <span class="c1"># Get applicable policy</span>
</span><span id="__span-5-128"><a id="__codelineno-5-128" name="__codelineno-5-128" href="#__codelineno-5-128"></a>        <span class="n">policy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_policy</span><span class="p">(</span><span class="n">policy_name</span><span class="p">)</span>
</span><span id="__span-5-129"><a id="__codelineno-5-129" name="__codelineno-5-129" href="#__codelineno-5-129"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">policy</span><span class="p">:</span>
</span><span id="__span-5-130"><a id="__codelineno-5-130" name="__codelineno-5-130" href="#__codelineno-5-130"></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_cors_denial</span><span class="p">()</span>
</span><span id="__span-5-131"><a id="__codelineno-5-131" name="__codelineno-5-131" href="#__codelineno-5-131"></a>
</span><span id="__span-5-132"><a id="__codelineno-5-132" name="__codelineno-5-132" href="#__codelineno-5-132"></a>        <span class="c1"># Validate origin</span>
</span><span id="__span-5-133"><a id="__codelineno-5-133" name="__codelineno-5-133" href="#__codelineno-5-133"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_origin_allowed</span><span class="p">(</span><span class="n">origin</span><span class="p">,</span> <span class="n">policy</span><span class="p">):</span>
</span><span id="__span-5-134"><a id="__codelineno-5-134" name="__codelineno-5-134" href="#__codelineno-5-134"></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_cors_denial</span><span class="p">()</span>
</span><span id="__span-5-135"><a id="__codelineno-5-135" name="__codelineno-5-135" href="#__codelineno-5-135"></a>
</span><span id="__span-5-136"><a id="__codelineno-5-136" name="__codelineno-5-136" href="#__codelineno-5-136"></a>        <span class="c1"># Create response headers</span>
</span><span id="__span-5-137"><a id="__codelineno-5-137" name="__codelineno-5-137" href="#__codelineno-5-137"></a>        <span class="n">response_headers</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-5-138"><a id="__codelineno-5-138" name="__codelineno-5-138" href="#__codelineno-5-138"></a>            <span class="s1">&#39;Access-Control-Allow-Origin&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_origin_response</span><span class="p">(</span><span class="n">origin</span><span class="p">,</span> <span class="n">policy</span><span class="p">),</span>
</span><span id="__span-5-139"><a id="__codelineno-5-139" name="__codelineno-5-139" href="#__codelineno-5-139"></a>            <span class="s1">&#39;Vary&#39;</span><span class="p">:</span> <span class="s1">&#39;Origin&#39;</span>
</span><span id="__span-5-140"><a id="__codelineno-5-140" name="__codelineno-5-140" href="#__codelineno-5-140"></a>        <span class="p">}</span>
</span><span id="__span-5-141"><a id="__codelineno-5-141" name="__codelineno-5-141" href="#__codelineno-5-141"></a>
</span><span id="__span-5-142"><a id="__codelineno-5-142" name="__codelineno-5-142" href="#__codelineno-5-142"></a>        <span class="k">if</span> <span class="n">policy</span><span class="o">.</span><span class="n">exposed_headers</span><span class="p">:</span>
</span><span id="__span-5-143"><a id="__codelineno-5-143" name="__codelineno-5-143" href="#__codelineno-5-143"></a>            <span class="n">response_headers</span><span class="p">[</span><span class="s1">&#39;Access-Control-Expose-Headers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">policy</span><span class="o">.</span><span class="n">exposed_headers</span><span class="p">)</span>
</span><span id="__span-5-144"><a id="__codelineno-5-144" name="__codelineno-5-144" href="#__codelineno-5-144"></a>
</span><span id="__span-5-145"><a id="__codelineno-5-145" name="__codelineno-5-145" href="#__codelineno-5-145"></a>        <span class="k">if</span> <span class="n">policy</span><span class="o">.</span><span class="n">allow_credentials</span><span class="p">:</span>
</span><span id="__span-5-146"><a id="__codelineno-5-146" name="__codelineno-5-146" href="#__codelineno-5-146"></a>            <span class="n">response_headers</span><span class="p">[</span><span class="s1">&#39;Access-Control-Allow-Credentials&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;true&#39;</span>
</span><span id="__span-5-147"><a id="__codelineno-5-147" name="__codelineno-5-147" href="#__codelineno-5-147"></a>
</span><span id="__span-5-148"><a id="__codelineno-5-148" name="__codelineno-5-148" href="#__codelineno-5-148"></a>        <span class="k">return</span> <span class="n">response_headers</span>
</span><span id="__span-5-149"><a id="__codelineno-5-149" name="__codelineno-5-149" href="#__codelineno-5-149"></a>
</span><span id="__span-5-150"><a id="__codelineno-5-150" name="__codelineno-5-150" href="#__codelineno-5-150"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_get_policy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">policy_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">CORSPolicy</span><span class="p">]:</span>
</span><span id="__span-5-151"><a id="__codelineno-5-151" name="__codelineno-5-151" href="#__codelineno-5-151"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get policy by name or default&quot;&quot;&quot;</span>
</span><span id="__span-5-152"><a id="__codelineno-5-152" name="__codelineno-5-152" href="#__codelineno-5-152"></a>        <span class="k">if</span> <span class="n">policy_name</span> <span class="ow">and</span> <span class="n">policy_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">policies</span><span class="p">:</span>
</span><span id="__span-5-153"><a id="__codelineno-5-153" name="__codelineno-5-153" href="#__codelineno-5-153"></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">policies</span><span class="p">[</span><span class="n">policy_name</span><span class="p">]</span>
</span><span id="__span-5-154"><a id="__codelineno-5-154" name="__codelineno-5-154" href="#__codelineno-5-154"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_policy</span>
</span><span id="__span-5-155"><a id="__codelineno-5-155" name="__codelineno-5-155" href="#__codelineno-5-155"></a>
</span><span id="__span-5-156"><a id="__codelineno-5-156" name="__codelineno-5-156" href="#__codelineno-5-156"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_is_origin_allowed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">origin</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">policy</span><span class="p">:</span> <span class="n">CORSPolicy</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="__span-5-157"><a id="__codelineno-5-157" name="__codelineno-5-157" href="#__codelineno-5-157"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if origin is allowed by policy&quot;&quot;&quot;</span>
</span><span id="__span-5-158"><a id="__codelineno-5-158" name="__codelineno-5-158" href="#__codelineno-5-158"></a>
</span><span id="__span-5-159"><a id="__codelineno-5-159" name="__codelineno-5-159" href="#__codelineno-5-159"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">origin</span><span class="p">:</span>
</span><span id="__span-5-160"><a id="__codelineno-5-160" name="__codelineno-5-160" href="#__codelineno-5-160"></a>            <span class="k">return</span> <span class="kc">False</span>
</span><span id="__span-5-161"><a id="__codelineno-5-161" name="__codelineno-5-161" href="#__codelineno-5-161"></a>
</span><span id="__span-5-162"><a id="__codelineno-5-162" name="__codelineno-5-162" href="#__codelineno-5-162"></a>        <span class="c1"># Check exact matches and wildcards</span>
</span><span id="__span-5-163"><a id="__codelineno-5-163" name="__codelineno-5-163" href="#__codelineno-5-163"></a>        <span class="k">for</span> <span class="n">allowed_origin</span> <span class="ow">in</span> <span class="n">policy</span><span class="o">.</span><span class="n">allowed_origins</span><span class="p">:</span>
</span><span id="__span-5-164"><a id="__codelineno-5-164" name="__codelineno-5-164" href="#__codelineno-5-164"></a>            <span class="k">if</span> <span class="n">allowed_origin</span> <span class="o">==</span> <span class="s1">&#39;*&#39;</span><span class="p">:</span>
</span><span id="__span-5-165"><a id="__codelineno-5-165" name="__codelineno-5-165" href="#__codelineno-5-165"></a>                <span class="c1"># Wildcard only allowed if credentials are disabled</span>
</span><span id="__span-5-166"><a id="__codelineno-5-166" name="__codelineno-5-166" href="#__codelineno-5-166"></a>                <span class="k">return</span> <span class="ow">not</span> <span class="n">policy</span><span class="o">.</span><span class="n">allow_credentials</span>
</span><span id="__span-5-167"><a id="__codelineno-5-167" name="__codelineno-5-167" href="#__codelineno-5-167"></a>            <span class="k">elif</span> <span class="n">allowed_origin</span> <span class="o">==</span> <span class="n">origin</span><span class="p">:</span>
</span><span id="__span-5-168"><a id="__codelineno-5-168" name="__codelineno-5-168" href="#__codelineno-5-168"></a>                <span class="k">return</span> <span class="kc">True</span>
</span><span id="__span-5-169"><a id="__codelineno-5-169" name="__codelineno-5-169" href="#__codelineno-5-169"></a>            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_match_origin_pattern</span><span class="p">(</span><span class="n">origin</span><span class="p">,</span> <span class="n">allowed_origin</span><span class="p">):</span>
</span><span id="__span-5-170"><a id="__codelineno-5-170" name="__codelineno-5-170" href="#__codelineno-5-170"></a>                <span class="k">return</span> <span class="kc">True</span>
</span><span id="__span-5-171"><a id="__codelineno-5-171" name="__codelineno-5-171" href="#__codelineno-5-171"></a>
</span><span id="__span-5-172"><a id="__codelineno-5-172" name="__codelineno-5-172" href="#__codelineno-5-172"></a>        <span class="k">return</span> <span class="kc">False</span>
</span><span id="__span-5-173"><a id="__codelineno-5-173" name="__codelineno-5-173" href="#__codelineno-5-173"></a>
</span><span id="__span-5-174"><a id="__codelineno-5-174" name="__codelineno-5-174" href="#__codelineno-5-174"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_match_origin_pattern</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">origin</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">pattern</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="__span-5-175"><a id="__codelineno-5-175" name="__codelineno-5-175" href="#__codelineno-5-175"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Match origin against pattern (supports simple wildcards)&quot;&quot;&quot;</span>
</span><span id="__span-5-176"><a id="__codelineno-5-176" name="__codelineno-5-176" href="#__codelineno-5-176"></a>
</span><span id="__span-5-177"><a id="__codelineno-5-177" name="__codelineno-5-177" href="#__codelineno-5-177"></a>        <span class="c1"># Convert simple wildcard pattern to regex</span>
</span><span id="__span-5-178"><a id="__codelineno-5-178" name="__codelineno-5-178" href="#__codelineno-5-178"></a>        <span class="k">if</span> <span class="s1">&#39;*&#39;</span> <span class="ow">in</span> <span class="n">pattern</span><span class="p">:</span>
</span><span id="__span-5-179"><a id="__codelineno-5-179" name="__codelineno-5-179" href="#__codelineno-5-179"></a>            <span class="n">regex_pattern</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;[^.]*&#39;</span><span class="p">)</span>
</span><span id="__span-5-180"><a id="__codelineno-5-180" name="__codelineno-5-180" href="#__codelineno-5-180"></a>            <span class="n">regex_pattern</span> <span class="o">=</span> <span class="n">regex_pattern</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;\.&#39;</span><span class="p">)</span>
</span><span id="__span-5-181"><a id="__codelineno-5-181" name="__codelineno-5-181" href="#__codelineno-5-181"></a>            <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;^</span><span class="si">{</span><span class="n">regex_pattern</span><span class="si">}</span><span class="s1">$&#39;</span><span class="p">,</span> <span class="n">origin</span><span class="p">))</span>
</span><span id="__span-5-182"><a id="__codelineno-5-182" name="__codelineno-5-182" href="#__codelineno-5-182"></a>
</span><span id="__span-5-183"><a id="__codelineno-5-183" name="__codelineno-5-183" href="#__codelineno-5-183"></a>        <span class="k">return</span> <span class="n">origin</span> <span class="o">==</span> <span class="n">pattern</span>
</span><span id="__span-5-184"><a id="__codelineno-5-184" name="__codelineno-5-184" href="#__codelineno-5-184"></a>
</span><span id="__span-5-185"><a id="__codelineno-5-185" name="__codelineno-5-185" href="#__codelineno-5-185"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_is_header_allowed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">header</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">policy</span><span class="p">:</span> <span class="n">CORSPolicy</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="__span-5-186"><a id="__codelineno-5-186" name="__codelineno-5-186" href="#__codelineno-5-186"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if header is allowed&quot;&quot;&quot;</span>
</span><span id="__span-5-187"><a id="__codelineno-5-187" name="__codelineno-5-187" href="#__codelineno-5-187"></a>
</span><span id="__span-5-188"><a id="__codelineno-5-188" name="__codelineno-5-188" href="#__codelineno-5-188"></a>        <span class="c1"># Case-insensitive header comparison</span>
</span><span id="__span-5-189"><a id="__codelineno-5-189" name="__codelineno-5-189" href="#__codelineno-5-189"></a>        <span class="n">header_lower</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span><span id="__span-5-190"><a id="__codelineno-5-190" name="__codelineno-5-190" href="#__codelineno-5-190"></a>        <span class="n">allowed_headers_lower</span> <span class="o">=</span> <span class="p">[</span><span class="n">h</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">policy</span><span class="o">.</span><span class="n">allowed_headers</span><span class="p">]</span>
</span><span id="__span-5-191"><a id="__codelineno-5-191" name="__codelineno-5-191" href="#__codelineno-5-191"></a>
</span><span id="__span-5-192"><a id="__codelineno-5-192" name="__codelineno-5-192" href="#__codelineno-5-192"></a>        <span class="k">return</span> <span class="n">header_lower</span> <span class="ow">in</span> <span class="n">allowed_headers_lower</span>
</span><span id="__span-5-193"><a id="__codelineno-5-193" name="__codelineno-5-193" href="#__codelineno-5-193"></a>
</span><span id="__span-5-194"><a id="__codelineno-5-194" name="__codelineno-5-194" href="#__codelineno-5-194"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_get_origin_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">origin</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">policy</span><span class="p">:</span> <span class="n">CORSPolicy</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="__span-5-195"><a id="__codelineno-5-195" name="__codelineno-5-195" href="#__codelineno-5-195"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get appropriate origin response value&quot;&quot;&quot;</span>
</span><span id="__span-5-196"><a id="__codelineno-5-196" name="__codelineno-5-196" href="#__codelineno-5-196"></a>
</span><span id="__span-5-197"><a id="__codelineno-5-197" name="__codelineno-5-197" href="#__codelineno-5-197"></a>        <span class="c1"># If credentials are allowed, must echo exact origin (not wildcard)</span>
</span><span id="__span-5-198"><a id="__codelineno-5-198" name="__codelineno-5-198" href="#__codelineno-5-198"></a>        <span class="k">if</span> <span class="n">policy</span><span class="o">.</span><span class="n">allow_credentials</span><span class="p">:</span>
</span><span id="__span-5-199"><a id="__codelineno-5-199" name="__codelineno-5-199" href="#__codelineno-5-199"></a>            <span class="k">return</span> <span class="n">origin</span>
</span><span id="__span-5-200"><a id="__codelineno-5-200" name="__codelineno-5-200" href="#__codelineno-5-200"></a>
</span><span id="__span-5-201"><a id="__codelineno-5-201" name="__codelineno-5-201" href="#__codelineno-5-201"></a>        <span class="c1"># Check if wildcard is in allowed origins</span>
</span><span id="__span-5-202"><a id="__codelineno-5-202" name="__codelineno-5-202" href="#__codelineno-5-202"></a>        <span class="k">if</span> <span class="s1">&#39;*&#39;</span> <span class="ow">in</span> <span class="n">policy</span><span class="o">.</span><span class="n">allowed_origins</span><span class="p">:</span>
</span><span id="__span-5-203"><a id="__codelineno-5-203" name="__codelineno-5-203" href="#__codelineno-5-203"></a>            <span class="k">return</span> <span class="s1">&#39;*&#39;</span>
</span><span id="__span-5-204"><a id="__codelineno-5-204" name="__codelineno-5-204" href="#__codelineno-5-204"></a>
</span><span id="__span-5-205"><a id="__codelineno-5-205" name="__codelineno-5-205" href="#__codelineno-5-205"></a>        <span class="k">return</span> <span class="n">origin</span>
</span><span id="__span-5-206"><a id="__codelineno-5-206" name="__codelineno-5-206" href="#__codelineno-5-206"></a>
</span><span id="__span-5-207"><a id="__codelineno-5-207" name="__codelineno-5-207" href="#__codelineno-5-207"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_create_cors_denial</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
</span><span id="__span-5-208"><a id="__codelineno-5-208" name="__codelineno-5-208" href="#__codelineno-5-208"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create CORS denial response (empty headers)&quot;&quot;&quot;</span>
</span><span id="__span-5-209"><a id="__codelineno-5-209" name="__codelineno-5-209" href="#__codelineno-5-209"></a>        <span class="k">return</span> <span class="p">{}</span>
</span><span id="__span-5-210"><a id="__codelineno-5-210" name="__codelineno-5-210" href="#__codelineno-5-210"></a>
</span><span id="__span-5-211"><a id="__codelineno-5-211" name="__codelineno-5-211" href="#__codelineno-5-211"></a><span class="k">class</span><span class="w"> </span><span class="nc">CORSSecurityMiddleware</span><span class="p">:</span>
</span><span id="__span-5-212"><a id="__codelineno-5-212" name="__codelineno-5-212" href="#__codelineno-5-212"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;CORS security middleware for web applications&quot;&quot;&quot;</span>
</span><span id="__span-5-213"><a id="__codelineno-5-213" name="__codelineno-5-213" href="#__codelineno-5-213"></a>
</span><span id="__span-5-214"><a id="__codelineno-5-214" name="__codelineno-5-214" href="#__codelineno-5-214"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cors_manager</span><span class="p">:</span> <span class="n">CORSManager</span><span class="p">):</span>
</span><span id="__span-5-215"><a id="__codelineno-5-215" name="__codelineno-5-215" href="#__codelineno-5-215"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cors_manager</span> <span class="o">=</span> <span class="n">cors_manager</span>
</span><span id="__span-5-216"><a id="__codelineno-5-216" name="__codelineno-5-216" href="#__codelineno-5-216"></a>
</span><span id="__span-5-217"><a id="__codelineno-5-217" name="__codelineno-5-217" href="#__codelineno-5-217"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">process_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request_data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> 
</span><span id="__span-5-218"><a id="__codelineno-5-218" name="__codelineno-5-218" href="#__codelineno-5-218"></a>                       <span class="n">policy_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">]]:</span>
</span><span id="__span-5-219"><a id="__codelineno-5-219" name="__codelineno-5-219" href="#__codelineno-5-219"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Process request with CORS handling&quot;&quot;&quot;</span>
</span><span id="__span-5-220"><a id="__codelineno-5-220" name="__codelineno-5-220" href="#__codelineno-5-220"></a>
</span><span id="__span-5-221"><a id="__codelineno-5-221" name="__codelineno-5-221" href="#__codelineno-5-221"></a>        <span class="n">origin</span> <span class="o">=</span> <span class="n">request_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;origin&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
</span><span id="__span-5-222"><a id="__codelineno-5-222" name="__codelineno-5-222" href="#__codelineno-5-222"></a>        <span class="n">method</span> <span class="o">=</span> <span class="n">request_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;method&#39;</span><span class="p">,</span> <span class="s1">&#39;GET&#39;</span><span class="p">)</span>
</span><span id="__span-5-223"><a id="__codelineno-5-223" name="__codelineno-5-223" href="#__codelineno-5-223"></a>
</span><span id="__span-5-224"><a id="__codelineno-5-224" name="__codelineno-5-224" href="#__codelineno-5-224"></a>        <span class="c1"># Handle preflight requests</span>
</span><span id="__span-5-225"><a id="__codelineno-5-225" name="__codelineno-5-225" href="#__codelineno-5-225"></a>        <span class="k">if</span> <span class="n">method</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;OPTIONS&#39;</span><span class="p">:</span>
</span><span id="__span-5-226"><a id="__codelineno-5-226" name="__codelineno-5-226" href="#__codelineno-5-226"></a>            <span class="n">requested_method</span> <span class="o">=</span> <span class="n">request_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;access_control_request_method&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
</span><span id="__span-5-227"><a id="__codelineno-5-227" name="__codelineno-5-227" href="#__codelineno-5-227"></a>            <span class="n">requested_headers</span> <span class="o">=</span> <span class="n">request_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;access_control_request_headers&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
</span><span id="__span-5-228"><a id="__codelineno-5-228" name="__codelineno-5-228" href="#__codelineno-5-228"></a>            <span class="n">requested_headers</span> <span class="o">=</span> <span class="p">[</span><span class="n">h</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">requested_headers</span> <span class="k">if</span> <span class="n">h</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
</span><span id="__span-5-229"><a id="__codelineno-5-229" name="__codelineno-5-229" href="#__codelineno-5-229"></a>
</span><span id="__span-5-230"><a id="__codelineno-5-230" name="__codelineno-5-230" href="#__codelineno-5-230"></a>            <span class="n">cors_headers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cors_manager</span><span class="o">.</span><span class="n">handle_preflight_request</span><span class="p">(</span>
</span><span id="__span-5-231"><a id="__codelineno-5-231" name="__codelineno-5-231" href="#__codelineno-5-231"></a>                <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">,</span>
</span><span id="__span-5-232"><a id="__codelineno-5-232" name="__codelineno-5-232" href="#__codelineno-5-232"></a>                <span class="n">method</span><span class="o">=</span><span class="n">requested_method</span><span class="p">,</span>
</span><span id="__span-5-233"><a id="__codelineno-5-233" name="__codelineno-5-233" href="#__codelineno-5-233"></a>                <span class="n">headers</span><span class="o">=</span><span class="n">requested_headers</span><span class="p">,</span>
</span><span id="__span-5-234"><a id="__codelineno-5-234" name="__codelineno-5-234" href="#__codelineno-5-234"></a>                <span class="n">policy_name</span><span class="o">=</span><span class="n">policy_name</span>
</span><span id="__span-5-235"><a id="__codelineno-5-235" name="__codelineno-5-235" href="#__codelineno-5-235"></a>            <span class="p">)</span>
</span><span id="__span-5-236"><a id="__codelineno-5-236" name="__codelineno-5-236" href="#__codelineno-5-236"></a>
</span><span id="__span-5-237"><a id="__codelineno-5-237" name="__codelineno-5-237" href="#__codelineno-5-237"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">cors_headers</span><span class="p">:</span>
</span><span id="__span-5-238"><a id="__codelineno-5-238" name="__codelineno-5-238" href="#__codelineno-5-238"></a>                <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-5-239"><a id="__codelineno-5-239" name="__codelineno-5-239" href="#__codelineno-5-239"></a>                    <span class="s1">&#39;status_code&#39;</span><span class="p">:</span> <span class="mi">403</span><span class="p">,</span>
</span><span id="__span-5-240"><a id="__codelineno-5-240" name="__codelineno-5-240" href="#__codelineno-5-240"></a>                    <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;CORS policy violation&#39;</span><span class="p">,</span>
</span><span id="__span-5-241"><a id="__codelineno-5-241" name="__codelineno-5-241" href="#__codelineno-5-241"></a>                    <span class="s1">&#39;headers&#39;</span><span class="p">:</span> <span class="p">{}</span>
</span><span id="__span-5-242"><a id="__codelineno-5-242" name="__codelineno-5-242" href="#__codelineno-5-242"></a>                <span class="p">}</span>
</span><span id="__span-5-243"><a id="__codelineno-5-243" name="__codelineno-5-243" href="#__codelineno-5-243"></a>
</span><span id="__span-5-244"><a id="__codelineno-5-244" name="__codelineno-5-244" href="#__codelineno-5-244"></a>            <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-5-245"><a id="__codelineno-5-245" name="__codelineno-5-245" href="#__codelineno-5-245"></a>                <span class="s1">&#39;status_code&#39;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
</span><span id="__span-5-246"><a id="__codelineno-5-246" name="__codelineno-5-246" href="#__codelineno-5-246"></a>                <span class="s1">&#39;headers&#39;</span><span class="p">:</span> <span class="n">cors_headers</span>
</span><span id="__span-5-247"><a id="__codelineno-5-247" name="__codelineno-5-247" href="#__codelineno-5-247"></a>            <span class="p">}</span>
</span><span id="__span-5-248"><a id="__codelineno-5-248" name="__codelineno-5-248" href="#__codelineno-5-248"></a>
</span><span id="__span-5-249"><a id="__codelineno-5-249" name="__codelineno-5-249" href="#__codelineno-5-249"></a>        <span class="c1"># Handle actual requests</span>
</span><span id="__span-5-250"><a id="__codelineno-5-250" name="__codelineno-5-250" href="#__codelineno-5-250"></a>        <span class="n">cors_headers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cors_manager</span><span class="o">.</span><span class="n">handle_actual_request</span><span class="p">(</span>
</span><span id="__span-5-251"><a id="__codelineno-5-251" name="__codelineno-5-251" href="#__codelineno-5-251"></a>            <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">,</span>
</span><span id="__span-5-252"><a id="__codelineno-5-252" name="__codelineno-5-252" href="#__codelineno-5-252"></a>            <span class="n">policy_name</span><span class="o">=</span><span class="n">policy_name</span>
</span><span id="__span-5-253"><a id="__codelineno-5-253" name="__codelineno-5-253" href="#__codelineno-5-253"></a>        <span class="p">)</span>
</span><span id="__span-5-254"><a id="__codelineno-5-254" name="__codelineno-5-254" href="#__codelineno-5-254"></a>
</span><span id="__span-5-255"><a id="__codelineno-5-255" name="__codelineno-5-255" href="#__codelineno-5-255"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">cors_headers</span><span class="p">:</span>
</span><span id="__span-5-256"><a id="__codelineno-5-256" name="__codelineno-5-256" href="#__codelineno-5-256"></a>            <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-5-257"><a id="__codelineno-5-257" name="__codelineno-5-257" href="#__codelineno-5-257"></a>                <span class="s1">&#39;status_code&#39;</span><span class="p">:</span> <span class="mi">403</span><span class="p">,</span>
</span><span id="__span-5-258"><a id="__codelineno-5-258" name="__codelineno-5-258" href="#__codelineno-5-258"></a>                <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;CORS policy violation&#39;</span><span class="p">,</span>
</span><span id="__span-5-259"><a id="__codelineno-5-259" name="__codelineno-5-259" href="#__codelineno-5-259"></a>                <span class="s1">&#39;headers&#39;</span><span class="p">:</span> <span class="p">{}</span>
</span><span id="__span-5-260"><a id="__codelineno-5-260" name="__codelineno-5-260" href="#__codelineno-5-260"></a>            <span class="p">}</span>
</span><span id="__span-5-261"><a id="__codelineno-5-261" name="__codelineno-5-261" href="#__codelineno-5-261"></a>
</span><span id="__span-5-262"><a id="__codelineno-5-262" name="__codelineno-5-262" href="#__codelineno-5-262"></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-5-263"><a id="__codelineno-5-263" name="__codelineno-5-263" href="#__codelineno-5-263"></a>            <span class="s1">&#39;status_code&#39;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
</span><span id="__span-5-264"><a id="__codelineno-5-264" name="__codelineno-5-264" href="#__codelineno-5-264"></a>            <span class="s1">&#39;headers&#39;</span><span class="p">:</span> <span class="n">cors_headers</span>
</span><span id="__span-5-265"><a id="__codelineno-5-265" name="__codelineno-5-265" href="#__codelineno-5-265"></a>        <span class="p">}</span>
</span><span id="__span-5-266"><a id="__codelineno-5-266" name="__codelineno-5-266" href="#__codelineno-5-266"></a>
</span><span id="__span-5-267"><a id="__codelineno-5-267" name="__codelineno-5-267" href="#__codelineno-5-267"></a><span class="k">def</span><span class="w"> </span><span class="nf">cors_security_example</span><span class="p">():</span>
</span><span id="__span-5-268"><a id="__codelineno-5-268" name="__codelineno-5-268" href="#__codelineno-5-268"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Demonstrate CORS security implementation&quot;&quot;&quot;</span>
</span><span id="__span-5-269"><a id="__codelineno-5-269" name="__codelineno-5-269" href="#__codelineno-5-269"></a>
</span><span id="__span-5-270"><a id="__codelineno-5-270" name="__codelineno-5-270" href="#__codelineno-5-270"></a>    <span class="c1"># Initialize CORS manager</span>
</span><span id="__span-5-271"><a id="__codelineno-5-271" name="__codelineno-5-271" href="#__codelineno-5-271"></a>    <span class="n">cors_manager</span> <span class="o">=</span> <span class="n">CORSManager</span><span class="p">()</span>
</span><span id="__span-5-272"><a id="__codelineno-5-272" name="__codelineno-5-272" href="#__codelineno-5-272"></a>
</span><span id="__span-5-273"><a id="__codelineno-5-273" name="__codelineno-5-273" href="#__codelineno-5-273"></a>    <span class="c1"># Create secure policies for different environments</span>
</span><span id="__span-5-274"><a id="__codelineno-5-274" name="__codelineno-5-274" href="#__codelineno-5-274"></a>
</span><span id="__span-5-275"><a id="__codelineno-5-275" name="__codelineno-5-275" href="#__codelineno-5-275"></a>    <span class="c1"># Development policy (more permissive)</span>
</span><span id="__span-5-276"><a id="__codelineno-5-276" name="__codelineno-5-276" href="#__codelineno-5-276"></a>    <span class="n">dev_policy</span> <span class="o">=</span> <span class="n">cors_manager</span><span class="o">.</span><span class="n">create_secure_policy</span><span class="p">(</span>
</span><span id="__span-5-277"><a id="__codelineno-5-277" name="__codelineno-5-277" href="#__codelineno-5-277"></a>        <span class="n">allowed_origins</span><span class="o">=</span><span class="p">[</span>
</span><span id="__span-5-278"><a id="__codelineno-5-278" name="__codelineno-5-278" href="#__codelineno-5-278"></a>            <span class="s1">&#39;http://localhost:3000&#39;</span><span class="p">,</span>
</span><span id="__span-5-279"><a id="__codelineno-5-279" name="__codelineno-5-279" href="#__codelineno-5-279"></a>            <span class="s1">&#39;http://localhost:8080&#39;</span><span class="p">,</span>
</span><span id="__span-5-280"><a id="__codelineno-5-280" name="__codelineno-5-280" href="#__codelineno-5-280"></a>            <span class="s1">&#39;http://127.0.0.1:3000&#39;</span>
</span><span id="__span-5-281"><a id="__codelineno-5-281" name="__codelineno-5-281" href="#__codelineno-5-281"></a>        <span class="p">],</span>
</span><span id="__span-5-282"><a id="__codelineno-5-282" name="__codelineno-5-282" href="#__codelineno-5-282"></a>        <span class="n">allow_credentials</span><span class="o">=</span><span class="kc">True</span>
</span><span id="__span-5-283"><a id="__codelineno-5-283" name="__codelineno-5-283" href="#__codelineno-5-283"></a>    <span class="p">)</span>
</span><span id="__span-5-284"><a id="__codelineno-5-284" name="__codelineno-5-284" href="#__codelineno-5-284"></a>
</span><span id="__span-5-285"><a id="__codelineno-5-285" name="__codelineno-5-285" href="#__codelineno-5-285"></a>    <span class="c1"># Production policy (restrictive)</span>
</span><span id="__span-5-286"><a id="__codelineno-5-286" name="__codelineno-5-286" href="#__codelineno-5-286"></a>    <span class="n">prod_policy</span> <span class="o">=</span> <span class="n">cors_manager</span><span class="o">.</span><span class="n">create_secure_policy</span><span class="p">(</span>
</span><span id="__span-5-287"><a id="__codelineno-5-287" name="__codelineno-5-287" href="#__codelineno-5-287"></a>        <span class="n">allowed_origins</span><span class="o">=</span><span class="p">[</span>
</span><span id="__span-5-288"><a id="__codelineno-5-288" name="__codelineno-5-288" href="#__codelineno-5-288"></a>            <span class="s1">&#39;https://myapp.com&#39;</span><span class="p">,</span>
</span><span id="__span-5-289"><a id="__codelineno-5-289" name="__codelineno-5-289" href="#__codelineno-5-289"></a>            <span class="s1">&#39;https://www.myapp.com&#39;</span><span class="p">,</span>
</span><span id="__span-5-290"><a id="__codelineno-5-290" name="__codelineno-5-290" href="#__codelineno-5-290"></a>            <span class="s1">&#39;https://admin.myapp.com&#39;</span>
</span><span id="__span-5-291"><a id="__codelineno-5-291" name="__codelineno-5-291" href="#__codelineno-5-291"></a>        <span class="p">],</span>
</span><span id="__span-5-292"><a id="__codelineno-5-292" name="__codelineno-5-292" href="#__codelineno-5-292"></a>        <span class="n">allow_credentials</span><span class="o">=</span><span class="kc">True</span>
</span><span id="__span-5-293"><a id="__codelineno-5-293" name="__codelineno-5-293" href="#__codelineno-5-293"></a>    <span class="p">)</span>
</span><span id="__span-5-294"><a id="__codelineno-5-294" name="__codelineno-5-294" href="#__codelineno-5-294"></a>
</span><span id="__span-5-295"><a id="__codelineno-5-295" name="__codelineno-5-295" href="#__codelineno-5-295"></a>    <span class="c1"># Public API policy (no credentials)</span>
</span><span id="__span-5-296"><a id="__codelineno-5-296" name="__codelineno-5-296" href="#__codelineno-5-296"></a>    <span class="n">public_policy</span> <span class="o">=</span> <span class="n">CORSPolicy</span><span class="p">(</span>
</span><span id="__span-5-297"><a id="__codelineno-5-297" name="__codelineno-5-297" href="#__codelineno-5-297"></a>        <span class="n">allowed_origins</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">],</span>
</span><span id="__span-5-298"><a id="__codelineno-5-298" name="__codelineno-5-298" href="#__codelineno-5-298"></a>        <span class="n">allowed_methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;OPTIONS&#39;</span><span class="p">],</span>
</span><span id="__span-5-299"><a id="__codelineno-5-299" name="__codelineno-5-299" href="#__codelineno-5-299"></a>        <span class="n">allowed_headers</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">],</span>
</span><span id="__span-5-300"><a id="__codelineno-5-300" name="__codelineno-5-300" href="#__codelineno-5-300"></a>        <span class="n">exposed_headers</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;X-Rate-Limit-Remaining&#39;</span><span class="p">],</span>
</span><span id="__span-5-301"><a id="__codelineno-5-301" name="__codelineno-5-301" href="#__codelineno-5-301"></a>        <span class="n">allow_credentials</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="__span-5-302"><a id="__codelineno-5-302" name="__codelineno-5-302" href="#__codelineno-5-302"></a>        <span class="n">max_age</span><span class="o">=</span><span class="mi">3600</span>
</span><span id="__span-5-303"><a id="__codelineno-5-303" name="__codelineno-5-303" href="#__codelineno-5-303"></a>    <span class="p">)</span>
</span><span id="__span-5-304"><a id="__codelineno-5-304" name="__codelineno-5-304" href="#__codelineno-5-304"></a>
</span><span id="__span-5-305"><a id="__codelineno-5-305" name="__codelineno-5-305" href="#__codelineno-5-305"></a>    <span class="c1"># Register policies</span>
</span><span id="__span-5-306"><a id="__codelineno-5-306" name="__codelineno-5-306" href="#__codelineno-5-306"></a>    <span class="n">cors_manager</span><span class="o">.</span><span class="n">add_policy</span><span class="p">(</span><span class="s1">&#39;development&#39;</span><span class="p">,</span> <span class="n">dev_policy</span><span class="p">)</span>
</span><span id="__span-5-307"><a id="__codelineno-5-307" name="__codelineno-5-307" href="#__codelineno-5-307"></a>    <span class="n">cors_manager</span><span class="o">.</span><span class="n">add_policy</span><span class="p">(</span><span class="s1">&#39;production&#39;</span><span class="p">,</span> <span class="n">prod_policy</span><span class="p">)</span>
</span><span id="__span-5-308"><a id="__codelineno-5-308" name="__codelineno-5-308" href="#__codelineno-5-308"></a>    <span class="n">cors_manager</span><span class="o">.</span><span class="n">add_policy</span><span class="p">(</span><span class="s1">&#39;public&#39;</span><span class="p">,</span> <span class="n">public_policy</span><span class="p">)</span>
</span><span id="__span-5-309"><a id="__codelineno-5-309" name="__codelineno-5-309" href="#__codelineno-5-309"></a>    <span class="n">cors_manager</span><span class="o">.</span><span class="n">set_default_policy</span><span class="p">(</span><span class="n">prod_policy</span><span class="p">)</span>
</span><span id="__span-5-310"><a id="__codelineno-5-310" name="__codelineno-5-310" href="#__codelineno-5-310"></a>
</span><span id="__span-5-311"><a id="__codelineno-5-311" name="__codelineno-5-311" href="#__codelineno-5-311"></a>    <span class="c1"># Create middleware</span>
</span><span id="__span-5-312"><a id="__codelineno-5-312" name="__codelineno-5-312" href="#__codelineno-5-312"></a>    <span class="n">cors_middleware</span> <span class="o">=</span> <span class="n">CORSSecurityMiddleware</span><span class="p">(</span><span class="n">cors_manager</span><span class="p">)</span>
</span><span id="__span-5-313"><a id="__codelineno-5-313" name="__codelineno-5-313" href="#__codelineno-5-313"></a>
</span><span id="__span-5-314"><a id="__codelineno-5-314" name="__codelineno-5-314" href="#__codelineno-5-314"></a>    <span class="c1"># Simulate preflight request</span>
</span><span id="__span-5-315"><a id="__codelineno-5-315" name="__codelineno-5-315" href="#__codelineno-5-315"></a>    <span class="n">preflight_request</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-5-316"><a id="__codelineno-5-316" name="__codelineno-5-316" href="#__codelineno-5-316"></a>        <span class="s1">&#39;origin&#39;</span><span class="p">:</span> <span class="s1">&#39;https://myapp.com&#39;</span><span class="p">,</span>
</span><span id="__span-5-317"><a id="__codelineno-5-317" name="__codelineno-5-317" href="#__codelineno-5-317"></a>        <span class="s1">&#39;method&#39;</span><span class="p">:</span> <span class="s1">&#39;OPTIONS&#39;</span><span class="p">,</span>
</span><span id="__span-5-318"><a id="__codelineno-5-318" name="__codelineno-5-318" href="#__codelineno-5-318"></a>        <span class="s1">&#39;access_control_request_method&#39;</span><span class="p">:</span> <span class="s1">&#39;POST&#39;</span><span class="p">,</span>
</span><span id="__span-5-319"><a id="__codelineno-5-319" name="__codelineno-5-319" href="#__codelineno-5-319"></a>        <span class="s1">&#39;access_control_request_headers&#39;</span><span class="p">:</span> <span class="s1">&#39;Content-Type, Authorization&#39;</span>
</span><span id="__span-5-320"><a id="__codelineno-5-320" name="__codelineno-5-320" href="#__codelineno-5-320"></a>    <span class="p">}</span>
</span><span id="__span-5-321"><a id="__codelineno-5-321" name="__codelineno-5-321" href="#__codelineno-5-321"></a>
</span><span id="__span-5-322"><a id="__codelineno-5-322" name="__codelineno-5-322" href="#__codelineno-5-322"></a>    <span class="n">result</span> <span class="o">=</span> <span class="n">cors_middleware</span><span class="o">.</span><span class="n">process_request</span><span class="p">(</span><span class="n">preflight_request</span><span class="p">,</span> <span class="s1">&#39;production&#39;</span><span class="p">)</span>
</span><span id="__span-5-323"><a id="__codelineno-5-323" name="__codelineno-5-323" href="#__codelineno-5-323"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Preflight result: </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-5-324"><a id="__codelineno-5-324" name="__codelineno-5-324" href="#__codelineno-5-324"></a>
</span><span id="__span-5-325"><a id="__codelineno-5-325" name="__codelineno-5-325" href="#__codelineno-5-325"></a>    <span class="c1"># Simulate actual request</span>
</span><span id="__span-5-326"><a id="__codelineno-5-326" name="__codelineno-5-326" href="#__codelineno-5-326"></a>    <span class="n">actual_request</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-5-327"><a id="__codelineno-5-327" name="__codelineno-5-327" href="#__codelineno-5-327"></a>        <span class="s1">&#39;origin&#39;</span><span class="p">:</span> <span class="s1">&#39;https://myapp.com&#39;</span><span class="p">,</span>
</span><span id="__span-5-328"><a id="__codelineno-5-328" name="__codelineno-5-328" href="#__codelineno-5-328"></a>        <span class="s1">&#39;method&#39;</span><span class="p">:</span> <span class="s1">&#39;POST&#39;</span>
</span><span id="__span-5-329"><a id="__codelineno-5-329" name="__codelineno-5-329" href="#__codelineno-5-329"></a>    <span class="p">}</span>
</span><span id="__span-5-330"><a id="__codelineno-5-330" name="__codelineno-5-330" href="#__codelineno-5-330"></a>
</span><span id="__span-5-331"><a id="__codelineno-5-331" name="__codelineno-5-331" href="#__codelineno-5-331"></a>    <span class="n">result</span> <span class="o">=</span> <span class="n">cors_middleware</span><span class="o">.</span><span class="n">process_request</span><span class="p">(</span><span class="n">actual_request</span><span class="p">,</span> <span class="s1">&#39;production&#39;</span><span class="p">)</span>
</span><span id="__span-5-332"><a id="__codelineno-5-332" name="__codelineno-5-332" href="#__codelineno-5-332"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Actual request result: </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-5-333"><a id="__codelineno-5-333" name="__codelineno-5-333" href="#__codelineno-5-333"></a>
</span><span id="__span-5-334"><a id="__codelineno-5-334" name="__codelineno-5-334" href="#__codelineno-5-334"></a>    <span class="c1"># Test blocked origin</span>
</span><span id="__span-5-335"><a id="__codelineno-5-335" name="__codelineno-5-335" href="#__codelineno-5-335"></a>    <span class="n">blocked_request</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-5-336"><a id="__codelineno-5-336" name="__codelineno-5-336" href="#__codelineno-5-336"></a>        <span class="s1">&#39;origin&#39;</span><span class="p">:</span> <span class="s1">&#39;https://malicious-site.com&#39;</span><span class="p">,</span>
</span><span id="__span-5-337"><a id="__codelineno-5-337" name="__codelineno-5-337" href="#__codelineno-5-337"></a>        <span class="s1">&#39;method&#39;</span><span class="p">:</span> <span class="s1">&#39;GET&#39;</span>
</span><span id="__span-5-338"><a id="__codelineno-5-338" name="__codelineno-5-338" href="#__codelineno-5-338"></a>    <span class="p">}</span>
</span><span id="__span-5-339"><a id="__codelineno-5-339" name="__codelineno-5-339" href="#__codelineno-5-339"></a>
</span><span id="__span-5-340"><a id="__codelineno-5-340" name="__codelineno-5-340" href="#__codelineno-5-340"></a>    <span class="n">result</span> <span class="o">=</span> <span class="n">cors_middleware</span><span class="o">.</span><span class="n">process_request</span><span class="p">(</span><span class="n">blocked_request</span><span class="p">,</span> <span class="s1">&#39;production&#39;</span><span class="p">)</span>
</span><span id="__span-5-341"><a id="__codelineno-5-341" name="__codelineno-5-341" href="#__codelineno-5-341"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Blocked request result: </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-5-342"><a id="__codelineno-5-342" name="__codelineno-5-342" href="#__codelineno-5-342"></a>
</span><span id="__span-5-343"><a id="__codelineno-5-343" name="__codelineno-5-343" href="#__codelineno-5-343"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
</span><span id="__span-5-344"><a id="__codelineno-5-344" name="__codelineno-5-344" href="#__codelineno-5-344"></a>    <span class="n">cors_security_example</span><span class="p">()</span>
</span></code></pre></div>
<h2 id="api-security-testing"><span class="glossary-term" data-glossary-category="Web Development" data-glossary-definition="A set of protocols and tools for building software applications, defining how components interact." data-glossary-full-form="Application Programming Interface" data-glossary-term="API">API</span> Security Testing<a class="headerlink" href="#api-security-testing" title="Permanent link">&para;</a></h2>
<p>Security testing is essential for identifying vulnerabilities in <span class="glossary-term" data-glossary-category="Web Development" data-glossary-definition="A set of protocols and tools for building software applications, defining how components interact." data-glossary-full-form="Application Programming Interface" data-glossary-term="API">API</span> implementations before they can be exploited by attackers.</p>
<h3 id="security-testing-methodology">Security Testing Methodology<a class="headerlink" href="#security-testing-methodology" title="Permanent link">&para;</a></h3>
<div class="diagram-container" data-container-id="kroki-diagram-3"><button class="diagram-expand-btn" onclick="openDiagramModal('kroki-diagram-3')">🔍 View Larger</button><div id="kroki-diagram-3" class="diagram-content"><p><svg xmlns="http://www.w3.org/2000/svg" contentStyleType="text/css" data-diagram-type="ACTIVITY" height="452px" preserveAspectRatio="xMaxYMax meet" style="width:1351px;height:452px;background:#FFFFFF;" version="1.1" viewBox="0 0 1351 452" width="1351px" zoomAndPan="magnify" id="Kroki" data-diagram-id="kroki-svg-3"><defs /><g><ellipse cx="675.3723" cy="15" fill="#FFFFFF" rx="10" ry="10" style="stroke:#000000;stroke-width:1;" /><path d="M754.2278,41.8516 L754.2278,57.9844 L734.2278,61.9844 L754.2278,65.9844 L754.2278,82.1172 A0,0 0 0 0 754.2278,82.1172 L947.4143,82.1172 A0,0 0 0 0 947.4143,82.1172 L947.4143,51.8516 L937.4143,41.8516 L754.2278,41.8516 A0,0 0 0 0 754.2278,41.8516" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;" /><path d="M937.4143,41.8516 L937.4143,51.8516 L947.4143,51.8516 L937.4143,41.8516" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;" /><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="146.377" x="760.2278" y="58.9185">Identify attack vectors</text><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="172.1865" x="760.2278" y="74.0513">and security requirements</text><rect fill="#FFFFFF" height="33.9688" rx="12.5" ry="12.5" style="stroke:#000000;stroke-width:1;" width="117.7109" x="616.5168" y="45" /><text fill="#000000" font-family="Arial" font-size="12" lengthAdjust="spacing" textLength="97.7109" x="626.5168" y="66.1387">Threat Modeling</text><path d="M749.1565,98.9688 L749.1565,115.1016 L729.1565,119.1016 L749.1565,123.1016 L749.1565,139.2344 A0,0 0 0 0 749.1565,139.2344 L914.9275,139.2344 A0,0 0 0 0 914.9275,139.2344 L914.9275,108.9688 L904.9275,98.9688 L749.1565,98.9688 A0,0 0 0 0 749.1565,98.9688" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;" /><path d="M904.9275,98.9688 L904.9275,108.9688 L914.9275,108.9688 L904.9275,98.9688" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;" /><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="80.6914" x="755.1565" y="116.0356">Code review</text><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="144.771" x="755.1565" y="131.1685">Vulnerability scanning</text><rect fill="#FFFFFF" height="33.9688" rx="12.5" ry="12.5" style="stroke:#000000;stroke-width:1;" width="107.5684" x="621.5881" y="102.1172" /><text fill="#000000" font-family="Arial" font-size="12" lengthAdjust="spacing" textLength="87.5684" x="631.5881" y="123.2559">Static Analysis</text><rect fill="#FFFFFF" height="33.9688" rx="12.5" ry="12.5" style="stroke:#000000;stroke-width:1;" width="120.9629" x="614.8909" y="159.2344" /><text fill="#000000" font-family="Arial" font-size="12" lengthAdjust="spacing" textLength="100.9629" x="624.8909" y="180.373">Dynamic Testing</text><line style="stroke:#000000;stroke-width:1.5;" x1="84.0654" x2="1093.3447" y1="213.2031" y2="213.2031" /><path d="M182.1309,230.0547 L182.1309,246.1875 L162.1309,250.1875 L182.1309,254.1875 L182.1309,270.3203 A0,0 0 0 0 182.1309,270.3203 L343.9473,270.3203 A0,0 0 0 0 343.9473,270.3203 L343.9473,240.0547 L333.9473,230.0547 L182.1309,230.0547 A0,0 0 0 0 182.1309,230.0547" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;" /><path d="M333.9473,230.0547 L333.9473,240.0547 L343.9473,240.0547 L333.9473,230.0547" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;" /><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="107.7959" x="188.1309" y="247.1216">Token validation</text><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="140.8164" x="188.1309" y="262.2544">Session management</text><rect fill="#FFFFFF" height="33.9688" rx="12.5" ry="12.5" style="stroke:#000000;stroke-width:1;" width="156.1309" x="6" y="233.2031" /><text fill="#000000" font-family="Arial" font-size="12" lengthAdjust="spacing" textLength="136.1309" x="16" y="254.3418">Authentication Testing</text><path d="M522.3613,230.0547 L522.3613,246.1875 L502.3613,250.1875 L522.3613,254.1875 L522.3613,270.3203 A0,0 0 0 0 522.3613,270.3203 L669.8193,270.3203 A0,0 0 0 0 669.8193,270.3203 L669.8193,240.0547 L659.8193,230.0547 L522.3613,230.0547 A0,0 0 0 0 522.3613,230.0547" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;" /><path d="M659.8193,230.0547 L659.8193,240.0547 L669.8193,240.0547 L659.8193,230.0547" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;" /><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="100.9849" x="528.3613" y="247.1216">Access controls</text><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="126.458" x="528.3613" y="262.2544">Privilege escalation</text><rect fill="#FFFFFF" height="33.9688" rx="12.5" ry="12.5" style="stroke:#000000;stroke-width:1;" width="148.4141" x="353.9473" y="233.2031" /><text fill="#000000" font-family="Arial" font-size="12" lengthAdjust="spacing" textLength="128.4141" x="363.9473" y="254.3418">Authorization Testing</text><path d="M880.9346,230.0547 L880.9346,246.1875 L860.9346,250.1875 L880.9346,254.1875 L880.9346,270.3203 A0,0 0 0 0 880.9346,270.3203 L1009.375,270.3203 A0,0 0 0 0 1009.375,270.3203 L1009.375,240.0547 L999.375,230.0547 L880.9346,230.0547 A0,0 0 0 0 880.9346,230.0547" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;" /><path d="M999.375,230.0547 L999.375,240.0547 L1009.375,240.0547 L999.375,230.0547" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;" /><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="107.4404" x="886.9346" y="247.1216">Injection attacks</text><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="99.1758" x="886.9346" y="262.2544">Data validation</text><rect fill="#FFFFFF" height="33.9688" rx="12.5" ry="12.5" style="stroke:#000000;stroke-width:1;" width="163.1152" x="697.8193" y="233.2031" /><text fill="#000000" font-family="Arial" font-size="12" lengthAdjust="spacing" textLength="143.1152" x="707.8193" y="254.3418">Input Validation Testing</text><path d="M1187.3145,230.0547 L1187.3145,246.1875 L1167.3145,250.1875 L1187.3145,254.1875 L1187.3145,270.3203 A0,0 0 0 0 1187.3145,270.3203 L1344.7446,270.3203 A0,0 0 0 0 1344.7446,270.3203 L1344.7446,240.0547 L1334.7446,230.0547 L1187.3145,230.0547 A0,0 0 0 0 1187.3145,230.0547" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;" /><path d="M1334.7446,230.0547 L1334.7446,240.0547 L1344.7446,240.0547 L1334.7446,230.0547" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;" /><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="97.043" x="1193.3145" y="247.1216">DoS protection</text><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="136.4302" x="1193.3145" y="262.2544">Resource exhaustion</text><rect fill="#FFFFFF" height="33.9688" rx="12.5" ry="12.5" style="stroke:#000000;stroke-width:1;" width="147.9395" x="1019.375" y="233.2031" /><text fill="#000000" font-family="Arial" font-size="12" lengthAdjust="spacing" textLength="127.9395" x="1029.375" y="254.3418">Rate Limiting Testing</text><line style="stroke:#000000;stroke-width:1.5;" x1="84.0654" x2="1093.3447" y1="290.3203" y2="290.3203" /><path d="M764.1858,307.1719 L764.1858,323.3047 L744.1858,327.3047 L764.1858,331.3047 L764.1858,347.4375 A0,0 0 0 0 764.1858,347.4375 L920.2195,347.4375 A0,0 0 0 0 920.2195,347.4375 L920.2195,317.1719 L910.2195,307.1719 L764.1858,307.1719 A0,0 0 0 0 764.1858,307.1719" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;" /><path d="M910.2195,307.1719 L910.2195,317.1719 L920.2195,317.1719 L910.2195,307.1719" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;" /><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="128.4575" x="770.1858" y="324.2388">Manual exploitation</text><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="135.0337" x="770.1858" y="339.3716">Real-world scenarios</text><rect fill="#FFFFFF" height="33.9688" rx="12.5" ry="12.5" style="stroke:#000000;stroke-width:1;" width="137.627" x="606.5588" y="310.3203" /><text fill="#000000" font-family="Arial" font-size="12" lengthAdjust="spacing" textLength="117.627" x="616.5588" y="331.459">Penetration Testing</text><path d="M789.1584,364.2891 L789.1584,380.4219 L769.1584,384.4219 L789.1584,388.4219 L789.1584,404.5547 A0,0 0 0 0 789.1584,404.5547 L938.3557,404.5547 A0,0 0 0 0 938.3557,404.5547 L938.3557,374.2891 L928.3557,364.2891 L789.1584,364.2891 A0,0 0 0 0 789.1584,364.2891" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;" /><path d="M928.3557,364.2891 L928.3557,374.2891 L938.3557,374.2891 L928.3557,364.2891" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;" /><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="128.1973" x="795.1584" y="381.356">Automated security</text><text fill="#000000" font-family="Arial" font-size="13" lengthAdjust="spacing" textLength="60.8169" x="795.1584" y="396.4888">test suite</text><rect fill="#FFFFFF" height="33.9688" rx="12.5" ry="12.5" style="stroke:#000000;stroke-width:1;" width="187.5723" x="581.5862" y="367.4375" /><text fill="#000000" font-family="Arial" font-size="12" lengthAdjust="spacing" textLength="167.5723" x="591.5862" y="388.5762">Security <span class="glossary-term" data-glossary-category="Automation" data-glossary-definition="A statistical method or machine learning technique for predicting numerical values based on relationships between variables." data-glossary-term="Regression">Regression</span> Testing</text><ellipse cx="675.3723" cy="435.5547" fill="none" rx="11" ry="11" style="stroke:#000000;stroke-width:1;" /><ellipse cx="675.3723" cy="435.5547" fill="#FFFFFF" rx="6" ry="6" style="stroke:#000000;stroke-width:1;" /><line style="stroke:#000000;stroke-width:1;" x1="675.3723" x2="675.3723" y1="25" y2="45" /><polygon fill="#000000" points="671.3723,35,675.3723,45,679.3723,35,675.3723,39" style="stroke:#000000;stroke-width:1;" /><line style="stroke:#000000;stroke-width:1;" x1="675.3723" x2="675.3723" y1="78.9688" y2="102.1172" /><polygon fill="#000000" points="671.3723,92.1172,675.3723,102.1172,679.3723,92.1172,675.3723,96.1172" style="stroke:#000000;stroke-width:1;" /><line style="stroke:#000000;stroke-width:1;" x1="675.3723" x2="675.3723" y1="136.0859" y2="159.2344" /><polygon fill="#000000" points="671.3723,149.2344,675.3723,159.2344,679.3723,149.2344,675.3723,153.2344" style="stroke:#000000;stroke-width:1;" /><line style="stroke:#000000;stroke-width:1;" x1="84.0654" x2="84.0654" y1="214.7031" y2="233.2031" /><polygon fill="#000000" points="80.0654,223.2031,84.0654,233.2031,88.0654,223.2031,84.0654,227.2031" style="stroke:#000000;stroke-width:1;" /><line style="stroke:#000000;stroke-width:1;" x1="428.1543" x2="428.1543" y1="214.7031" y2="233.2031" /><polygon fill="#000000" points="424.1543,223.2031,428.1543,233.2031,432.1543,223.2031,428.1543,227.2031" style="stroke:#000000;stroke-width:1;" /><line style="stroke:#000000;stroke-width:1;" x1="779.377" x2="779.377" y1="214.7031" y2="233.2031" /><polygon fill="#000000" points="775.377,223.2031,779.377,233.2031,783.377,223.2031,779.377,227.2031" style="stroke:#000000;stroke-width:1;" /><line style="stroke:#000000;stroke-width:1;" x1="1093.3447" x2="1093.3447" y1="214.7031" y2="233.2031" /><polygon fill="#000000" points="1089.3447,223.2031,1093.3447,233.2031,1097.3447,223.2031,1093.3447,227.2031" style="stroke:#000000;stroke-width:1;" /><line style="stroke:#000000;stroke-width:1;" x1="84.0654" x2="84.0654" y1="267.1719" y2="290.3203" /><polygon fill="#000000" points="80.0654,280.3203,84.0654,290.3203,88.0654,280.3203,84.0654,284.3203" style="stroke:#000000;stroke-width:1;" /><line style="stroke:#000000;stroke-width:1;" x1="428.1543" x2="428.1543" y1="267.1719" y2="290.3203" /><polygon fill="#000000" points="424.1543,280.3203,428.1543,290.3203,432.1543,280.3203,428.1543,284.3203" style="stroke:#000000;stroke-width:1;" /><line style="stroke:#000000;stroke-width:1;" x1="779.377" x2="779.377" y1="267.1719" y2="290.3203" /><polygon fill="#000000" points="775.377,280.3203,779.377,290.3203,783.377,280.3203,779.377,284.3203" style="stroke:#000000;stroke-width:1;" /><line style="stroke:#000000;stroke-width:1;" x1="1093.3447" x2="1093.3447" y1="267.1719" y2="290.3203" /><polygon fill="#000000" points="1089.3447,280.3203,1093.3447,290.3203,1097.3447,280.3203,1093.3447,284.3203" style="stroke:#000000;stroke-width:1;" /><line style="stroke:#000000;stroke-width:1;" x1="675.3723" x2="675.3723" y1="193.2031" y2="213.2031" /><polygon fill="#000000" points="671.3723,203.2031,675.3723,213.2031,679.3723,203.2031,675.3723,207.2031" style="stroke:#000000;stroke-width:1;" /><line style="stroke:#000000;stroke-width:1;" x1="675.3723" x2="675.3723" y1="291.8203" y2="310.3203" /><polygon fill="#000000" points="671.3723,300.3203,675.3723,310.3203,679.3723,300.3203,675.3723,304.3203" style="stroke:#000000;stroke-width:1;" /><line style="stroke:#000000;stroke-width:1;" x1="675.3723" x2="675.3723" y1="344.2891" y2="367.4375" /><polygon fill="#000000" points="671.3723,357.4375,675.3723,367.4375,679.3723,357.4375,675.3723,361.4375" style="stroke:#000000;stroke-width:1;" /><line style="stroke:#000000;stroke-width:1;" x1="675.3723" x2="675.3723" y1="401.4063" y2="424.5547" /><polygon fill="#000000" points="671.3723,414.5547,675.3723,424.5547,679.3723,414.5547,675.3723,418.5547" style="stroke:#000000;stroke-width:1;" /></g></svg></p></div></div>
<h3 id="automated-security-testing-framework">Automated Security Testing <span class="glossary-term" data-glossary-category="Web Development" data-glossary-definition="A pre-built structure providing a foundation and tools for developing software applications more efficiently." data-glossary-term="Framework">Framework</span><a class="headerlink" href="#automated-security-testing-framework" title="Permanent link">&para;</a></h3>
<div class="language-python highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">random</span>
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">string</span>
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Callable</span>
</span><span id="__span-6-7"><a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a><span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>
</span><span id="__span-6-8"><a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a><span class="kn">from</span><span class="w"> </span><span class="nn">concurrent.futures</span><span class="w"> </span><span class="kn">import</span> <span class="n">ThreadPoolExecutor</span><span class="p">,</span> <span class="n">as_completed</span>
</span><span id="__span-6-9"><a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a><span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
</span><span id="__span-6-10"><a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a><span class="kn">from</span><span class="w"> </span><span class="nn">urllib.parse</span><span class="w"> </span><span class="kn">import</span> <span class="n">urljoin</span><span class="p">,</span> <span class="n">urlparse</span>
</span><span id="__span-6-11"><a id="__codelineno-6-11" name="__codelineno-6-11" href="#__codelineno-6-11"></a>
</span><span id="__span-6-12"><a id="__codelineno-6-12" name="__codelineno-6-12" href="#__codelineno-6-12"></a><span class="nd">@dataclass</span>
</span><span id="__span-6-13"><a id="__codelineno-6-13" name="__codelineno-6-13" href="#__codelineno-6-13"></a><span class="k">class</span><span class="w"> </span><span class="nc">SecurityTestResult</span><span class="p">:</span>
</span><span id="__span-6-14"><a id="__codelineno-6-14" name="__codelineno-6-14" href="#__codelineno-6-14"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Result of a security test&quot;&quot;&quot;</span>
</span><span id="__span-6-15"><a id="__codelineno-6-15" name="__codelineno-6-15" href="#__codelineno-6-15"></a>    <span class="n">test_name</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-6-16"><a id="__codelineno-6-16" name="__codelineno-6-16" href="#__codelineno-6-16"></a>    <span class="n">endpoint</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-6-17"><a id="__codelineno-6-17" name="__codelineno-6-17" href="#__codelineno-6-17"></a>    <span class="n">method</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-6-18"><a id="__codelineno-6-18" name="__codelineno-6-18" href="#__codelineno-6-18"></a>    <span class="n">passed</span><span class="p">:</span> <span class="nb">bool</span>
</span><span id="__span-6-19"><a id="__codelineno-6-19" name="__codelineno-6-19" href="#__codelineno-6-19"></a>    <span class="n">severity</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># &#39;low&#39;, &#39;medium&#39;, &#39;high&#39;, &#39;critical&#39;</span>
</span><span id="__span-6-20"><a id="__codelineno-6-20" name="__codelineno-6-20" href="#__codelineno-6-20"></a>    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-6-21"><a id="__codelineno-6-21" name="__codelineno-6-21" href="#__codelineno-6-21"></a>    <span class="n">details</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
</span><span id="__span-6-22"><a id="__codelineno-6-22" name="__codelineno-6-22" href="#__codelineno-6-22"></a>    <span class="n">remediation</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-6-23"><a id="__codelineno-6-23" name="__codelineno-6-23" href="#__codelineno-6-23"></a>
</span><span id="__span-6-24"><a id="__codelineno-6-24" name="__codelineno-6-24" href="#__codelineno-6-24"></a><span class="nd">@dataclass</span>
</span><span id="__span-6-25"><a id="__codelineno-6-25" name="__codelineno-6-25" href="#__codelineno-6-25"></a><span class="k">class</span><span class="w"> </span><span class="nc">APIEndpoint</span><span class="p">:</span>
</span><span id="__span-6-26"><a id="__codelineno-6-26" name="__codelineno-6-26" href="#__codelineno-6-26"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;API endpoint configuration for testing&quot;&quot;&quot;</span>
</span><span id="__span-6-27"><a id="__codelineno-6-27" name="__codelineno-6-27" href="#__codelineno-6-27"></a>    <span class="n">path</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-6-28"><a id="__codelineno-6-28" name="__codelineno-6-28" href="#__codelineno-6-28"></a>    <span class="n">method</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-6-29"><a id="__codelineno-6-29" name="__codelineno-6-29" href="#__codelineno-6-29"></a>    <span class="n">auth_required</span><span class="p">:</span> <span class="nb">bool</span>
</span><span id="__span-6-30"><a id="__codelineno-6-30" name="__codelineno-6-30" href="#__codelineno-6-30"></a>    <span class="n">parameters</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span>
</span><span id="__span-6-31"><a id="__codelineno-6-31" name="__codelineno-6-31" href="#__codelineno-6-31"></a>    <span class="n">expected_status</span><span class="p">:</span> <span class="nb">int</span>
</span><span id="__span-6-32"><a id="__codelineno-6-32" name="__codelineno-6-32" href="#__codelineno-6-32"></a>
</span><span id="__span-6-33"><a id="__codelineno-6-33" name="__codelineno-6-33" href="#__codelineno-6-33"></a><span class="k">class</span><span class="w"> </span><span class="nc">APISecurityTester</span><span class="p">:</span>
</span><span id="__span-6-34"><a id="__codelineno-6-34" name="__codelineno-6-34" href="#__codelineno-6-34"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Comprehensive API security testing framework&quot;&quot;&quot;</span>
</span><span id="__span-6-35"><a id="__codelineno-6-35" name="__codelineno-6-35" href="#__codelineno-6-35"></a>
</span><span id="__span-6-36"><a id="__codelineno-6-36" name="__codelineno-6-36" href="#__codelineno-6-36"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span><span class="p">):</span>
</span><span id="__span-6-37"><a id="__codelineno-6-37" name="__codelineno-6-37" href="#__codelineno-6-37"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">base_url</span> <span class="o">=</span> <span class="n">base_url</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
</span><span id="__span-6-38"><a id="__codelineno-6-38" name="__codelineno-6-38" href="#__codelineno-6-38"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">timeout</span>
</span><span id="__span-6-39"><a id="__codelineno-6-39" name="__codelineno-6-39" href="#__codelineno-6-39"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>
</span><span id="__span-6-40"><a id="__codelineno-6-40" name="__codelineno-6-40" href="#__codelineno-6-40"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">SecurityTestResult</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-6-41"><a id="__codelineno-6-41" name="__codelineno-6-41" href="#__codelineno-6-41"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
</span><span id="__span-6-42"><a id="__codelineno-6-42" name="__codelineno-6-42" href="#__codelineno-6-42"></a>
</span><span id="__span-6-43"><a id="__codelineno-6-43" name="__codelineno-6-43" href="#__codelineno-6-43"></a>        <span class="c1"># Common payloads for injection testing</span>
</span><span id="__span-6-44"><a id="__codelineno-6-44" name="__codelineno-6-44" href="#__codelineno-6-44"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sql_injection_payloads</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="__span-6-45"><a id="__codelineno-6-45" name="__codelineno-6-45" href="#__codelineno-6-45"></a>            <span class="s2">&quot;&#39; OR &#39;1&#39;=&#39;1&quot;</span><span class="p">,</span>
</span><span id="__span-6-46"><a id="__codelineno-6-46" name="__codelineno-6-46" href="#__codelineno-6-46"></a>            <span class="s2">&quot;&#39;; DROP TABLE users;--&quot;</span><span class="p">,</span>
</span><span id="__span-6-47"><a id="__codelineno-6-47" name="__codelineno-6-47" href="#__codelineno-6-47"></a>            <span class="s2">&quot;1&#39; UNION SELECT NULL,username,password FROM users--&quot;</span><span class="p">,</span>
</span><span id="__span-6-48"><a id="__codelineno-6-48" name="__codelineno-6-48" href="#__codelineno-6-48"></a>            <span class="s2">&quot;admin&#39;--&quot;</span><span class="p">,</span>
</span><span id="__span-6-49"><a id="__codelineno-6-49" name="__codelineno-6-49" href="#__codelineno-6-49"></a>            <span class="s2">&quot;&#39; OR 1=1#&quot;</span>
</span><span id="__span-6-50"><a id="__codelineno-6-50" name="__codelineno-6-50" href="#__codelineno-6-50"></a>        <span class="p">]</span>
</span><span id="__span-6-51"><a id="__codelineno-6-51" name="__codelineno-6-51" href="#__codelineno-6-51"></a>
</span><span id="__span-6-52"><a id="__codelineno-6-52" name="__codelineno-6-52" href="#__codelineno-6-52"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">xss_payloads</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="__span-6-53"><a id="__codelineno-6-53" name="__codelineno-6-53" href="#__codelineno-6-53"></a>            <span class="s2">&quot;&lt;script&gt;alert(&#39;XSS&#39;)&lt;/script&gt;&quot;</span><span class="p">,</span>
</span><span id="__span-6-54"><a id="__codelineno-6-54" name="__codelineno-6-54" href="#__codelineno-6-54"></a>            <span class="s2">&quot;javascript:alert(&#39;XSS&#39;)&quot;</span><span class="p">,</span>
</span><span id="__span-6-55"><a id="__codelineno-6-55" name="__codelineno-6-55" href="#__codelineno-6-55"></a>            <span class="s2">&quot;&lt;img src=x onerror=alert(&#39;XSS&#39;)&gt;&quot;</span><span class="p">,</span>
</span><span id="__span-6-56"><a id="__codelineno-6-56" name="__codelineno-6-56" href="#__codelineno-6-56"></a>            <span class="s2">&quot;&#39;;alert(&#39;XSS&#39;);//&quot;</span><span class="p">,</span>
</span><span id="__span-6-57"><a id="__codelineno-6-57" name="__codelineno-6-57" href="#__codelineno-6-57"></a>            <span class="s2">&quot;&lt;svg onload=alert(&#39;XSS&#39;)&gt;&quot;</span>
</span><span id="__span-6-58"><a id="__codelineno-6-58" name="__codelineno-6-58" href="#__codelineno-6-58"></a>        <span class="p">]</span>
</span><span id="__span-6-59"><a id="__codelineno-6-59" name="__codelineno-6-59" href="#__codelineno-6-59"></a>
</span><span id="__span-6-60"><a id="__codelineno-6-60" name="__codelineno-6-60" href="#__codelineno-6-60"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">path_traversal_payloads</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="__span-6-61"><a id="__codelineno-6-61" name="__codelineno-6-61" href="#__codelineno-6-61"></a>            <span class="s2">&quot;../../../etc/passwd&quot;</span><span class="p">,</span>
</span><span id="__span-6-62"><a id="__codelineno-6-62" name="__codelineno-6-62" href="#__codelineno-6-62"></a>            <span class="s2">&quot;..</span><span class="se">\\</span><span class="s2">..</span><span class="se">\\</span><span class="s2">..</span><span class="se">\\</span><span class="s2">windows</span><span class="se">\\</span><span class="s2">system32</span><span class="se">\\</span><span class="s2">drivers</span><span class="se">\\</span><span class="s2">etc</span><span class="se">\\</span><span class="s2">hosts&quot;</span><span class="p">,</span>
</span><span id="__span-6-63"><a id="__codelineno-6-63" name="__codelineno-6-63" href="#__codelineno-6-63"></a>            <span class="s2">&quot;....//....//....//etc/passwd&quot;</span><span class="p">,</span>
</span><span id="__span-6-64"><a id="__codelineno-6-64" name="__codelineno-6-64" href="#__codelineno-6-64"></a>            <span class="s2">&quot;</span><span class="si">%2e%2e%2f%2e%2e%2f%2e%2e%2f</span><span class="s2">etc</span><span class="si">%2f</span><span class="s2">passwd&quot;</span>
</span><span id="__span-6-65"><a id="__codelineno-6-65" name="__codelineno-6-65" href="#__codelineno-6-65"></a>        <span class="p">]</span>
</span><span id="__span-6-66"><a id="__codelineno-6-66" name="__codelineno-6-66" href="#__codelineno-6-66"></a>
</span><span id="__span-6-67"><a id="__codelineno-6-67" name="__codelineno-6-67" href="#__codelineno-6-67"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">authenticate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">auth_endpoint</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;/auth/login&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="__span-6-68"><a id="__codelineno-6-68" name="__codelineno-6-68" href="#__codelineno-6-68"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Authenticate with the API and store session&quot;&quot;&quot;</span>
</span><span id="__span-6-69"><a id="__codelineno-6-69" name="__codelineno-6-69" href="#__codelineno-6-69"></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="__span-6-70"><a id="__codelineno-6-70" name="__codelineno-6-70" href="#__codelineno-6-70"></a>            <span class="n">auth_data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="n">username</span><span class="p">,</span> <span class="s2">&quot;password&quot;</span><span class="p">:</span> <span class="n">password</span><span class="p">}</span>
</span><span id="__span-6-71"><a id="__codelineno-6-71" name="__codelineno-6-71" href="#__codelineno-6-71"></a>            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
</span><span id="__span-6-72"><a id="__codelineno-6-72" name="__codelineno-6-72" href="#__codelineno-6-72"></a>                <span class="n">urljoin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">auth_endpoint</span><span class="p">),</span>
</span><span id="__span-6-73"><a id="__codelineno-6-73" name="__codelineno-6-73" href="#__codelineno-6-73"></a>                <span class="n">json</span><span class="o">=</span><span class="n">auth_data</span><span class="p">,</span>
</span><span id="__span-6-74"><a id="__codelineno-6-74" name="__codelineno-6-74" href="#__codelineno-6-74"></a>                <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span>
</span><span id="__span-6-75"><a id="__codelineno-6-75" name="__codelineno-6-75" href="#__codelineno-6-75"></a>            <span class="p">)</span>
</span><span id="__span-6-76"><a id="__codelineno-6-76" name="__codelineno-6-76" href="#__codelineno-6-76"></a>
</span><span id="__span-6-77"><a id="__codelineno-6-77" name="__codelineno-6-77" href="#__codelineno-6-77"></a>            <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
</span><span id="__span-6-78"><a id="__codelineno-6-78" name="__codelineno-6-78" href="#__codelineno-6-78"></a>                <span class="c1"># Store authentication token if provided</span>
</span><span id="__span-6-79"><a id="__codelineno-6-79" name="__codelineno-6-79" href="#__codelineno-6-79"></a>                <span class="n">auth_data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</span><span id="__span-6-80"><a id="__codelineno-6-80" name="__codelineno-6-80" href="#__codelineno-6-80"></a>                <span class="k">if</span> <span class="s1">&#39;token&#39;</span> <span class="ow">in</span> <span class="n">auth_data</span><span class="p">:</span>
</span><span id="__span-6-81"><a id="__codelineno-6-81" name="__codelineno-6-81" href="#__codelineno-6-81"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
</span><span id="__span-6-82"><a id="__codelineno-6-82" name="__codelineno-6-82" href="#__codelineno-6-82"></a>                        <span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Bearer </span><span class="si">{</span><span class="n">auth_data</span><span class="p">[</span><span class="s1">&#39;token&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="__span-6-83"><a id="__codelineno-6-83" name="__codelineno-6-83" href="#__codelineno-6-83"></a>                    <span class="p">})</span>
</span><span id="__span-6-84"><a id="__codelineno-6-84" name="__codelineno-6-84" href="#__codelineno-6-84"></a>                <span class="k">return</span> <span class="kc">True</span>
</span><span id="__span-6-85"><a id="__codelineno-6-85" name="__codelineno-6-85" href="#__codelineno-6-85"></a>
</span><span id="__span-6-86"><a id="__codelineno-6-86" name="__codelineno-6-86" href="#__codelineno-6-86"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-6-87"><a id="__codelineno-6-87" name="__codelineno-6-87" href="#__codelineno-6-87"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Authentication failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-6-88"><a id="__codelineno-6-88" name="__codelineno-6-88" href="#__codelineno-6-88"></a>
</span><span id="__span-6-89"><a id="__codelineno-6-89" name="__codelineno-6-89" href="#__codelineno-6-89"></a>        <span class="k">return</span> <span class="kc">False</span>
</span><span id="__span-6-90"><a id="__codelineno-6-90" name="__codelineno-6-90" href="#__codelineno-6-90"></a>
</span><span id="__span-6-91"><a id="__codelineno-6-91" name="__codelineno-6-91" href="#__codelineno-6-91"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_authentication_vulnerabilities</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">endpoints</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">APIEndpoint</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">SecurityTestResult</span><span class="p">]:</span>
</span><span id="__span-6-92"><a id="__codelineno-6-92" name="__codelineno-6-92" href="#__codelineno-6-92"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Test for authentication vulnerabilities&quot;&quot;&quot;</span>
</span><span id="__span-6-93"><a id="__codelineno-6-93" name="__codelineno-6-93" href="#__codelineno-6-93"></a>        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-6-94"><a id="__codelineno-6-94" name="__codelineno-6-94" href="#__codelineno-6-94"></a>
</span><span id="__span-6-95"><a id="__codelineno-6-95" name="__codelineno-6-95" href="#__codelineno-6-95"></a>        <span class="k">for</span> <span class="n">endpoint</span> <span class="ow">in</span> <span class="n">endpoints</span><span class="p">:</span>
</span><span id="__span-6-96"><a id="__codelineno-6-96" name="__codelineno-6-96" href="#__codelineno-6-96"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">endpoint</span><span class="o">.</span><span class="n">auth_required</span><span class="p">:</span>
</span><span id="__span-6-97"><a id="__codelineno-6-97" name="__codelineno-6-97" href="#__codelineno-6-97"></a>                <span class="k">continue</span>
</span><span id="__span-6-98"><a id="__codelineno-6-98" name="__codelineno-6-98" href="#__codelineno-6-98"></a>
</span><span id="__span-6-99"><a id="__codelineno-6-99" name="__codelineno-6-99" href="#__codelineno-6-99"></a>            <span class="c1"># Test 1: Access without authentication</span>
</span><span id="__span-6-100"><a id="__codelineno-6-100" name="__codelineno-6-100" href="#__codelineno-6-100"></a>            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_test_unauthenticated_access</span><span class="p">(</span><span class="n">endpoint</span><span class="p">))</span>
</span><span id="__span-6-101"><a id="__codelineno-6-101" name="__codelineno-6-101" href="#__codelineno-6-101"></a>
</span><span id="__span-6-102"><a id="__codelineno-6-102" name="__codelineno-6-102" href="#__codelineno-6-102"></a>            <span class="c1"># Test 2: Invalid token handling</span>
</span><span id="__span-6-103"><a id="__codelineno-6-103" name="__codelineno-6-103" href="#__codelineno-6-103"></a>            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_test_invalid_token</span><span class="p">(</span><span class="n">endpoint</span><span class="p">))</span>
</span><span id="__span-6-104"><a id="__codelineno-6-104" name="__codelineno-6-104" href="#__codelineno-6-104"></a>
</span><span id="__span-6-105"><a id="__codelineno-6-105" name="__codelineno-6-105" href="#__codelineno-6-105"></a>            <span class="c1"># Test 3: Expired token handling</span>
</span><span id="__span-6-106"><a id="__codelineno-6-106" name="__codelineno-6-106" href="#__codelineno-6-106"></a>            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_test_token_manipulation</span><span class="p">(</span><span class="n">endpoint</span><span class="p">))</span>
</span><span id="__span-6-107"><a id="__codelineno-6-107" name="__codelineno-6-107" href="#__codelineno-6-107"></a>
</span><span id="__span-6-108"><a id="__codelineno-6-108" name="__codelineno-6-108" href="#__codelineno-6-108"></a>        <span class="k">return</span> <span class="n">results</span>
</span><span id="__span-6-109"><a id="__codelineno-6-109" name="__codelineno-6-109" href="#__codelineno-6-109"></a>
</span><span id="__span-6-110"><a id="__codelineno-6-110" name="__codelineno-6-110" href="#__codelineno-6-110"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_test_unauthenticated_access</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">:</span> <span class="n">APIEndpoint</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SecurityTestResult</span><span class="p">:</span>
</span><span id="__span-6-111"><a id="__codelineno-6-111" name="__codelineno-6-111" href="#__codelineno-6-111"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Test access to authenticated endpoint without credentials&quot;&quot;&quot;</span>
</span><span id="__span-6-112"><a id="__codelineno-6-112" name="__codelineno-6-112" href="#__codelineno-6-112"></a>
</span><span id="__span-6-113"><a id="__codelineno-6-113" name="__codelineno-6-113" href="#__codelineno-6-113"></a>        <span class="c1"># Remove authentication headers temporarily</span>
</span><span id="__span-6-114"><a id="__codelineno-6-114" name="__codelineno-6-114" href="#__codelineno-6-114"></a>        <span class="n">original_headers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="__span-6-115"><a id="__codelineno-6-115" name="__codelineno-6-115" href="#__codelineno-6-115"></a>        <span class="k">if</span> <span class="s1">&#39;Authorization&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">headers</span><span class="p">:</span>
</span><span id="__span-6-116"><a id="__codelineno-6-116" name="__codelineno-6-116" href="#__codelineno-6-116"></a>            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Authorization&#39;</span><span class="p">]</span>
</span><span id="__span-6-117"><a id="__codelineno-6-117" name="__codelineno-6-117" href="#__codelineno-6-117"></a>
</span><span id="__span-6-118"><a id="__codelineno-6-118" name="__codelineno-6-118" href="#__codelineno-6-118"></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="__span-6-119"><a id="__codelineno-6-119" name="__codelineno-6-119" href="#__codelineno-6-119"></a>            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">request</span><span class="p">(</span>
</span><span id="__span-6-120"><a id="__codelineno-6-120" name="__codelineno-6-120" href="#__codelineno-6-120"></a>                <span class="n">method</span><span class="o">=</span><span class="n">endpoint</span><span class="o">.</span><span class="n">method</span><span class="p">,</span>
</span><span id="__span-6-121"><a id="__codelineno-6-121" name="__codelineno-6-121" href="#__codelineno-6-121"></a>                <span class="n">url</span><span class="o">=</span><span class="n">urljoin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">.</span><span class="n">path</span><span class="p">),</span>
</span><span id="__span-6-122"><a id="__codelineno-6-122" name="__codelineno-6-122" href="#__codelineno-6-122"></a>                <span class="n">params</span><span class="o">=</span><span class="n">endpoint</span><span class="o">.</span><span class="n">parameters</span> <span class="k">if</span> <span class="n">endpoint</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;GET&#39;</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="__span-6-123"><a id="__codelineno-6-123" name="__codelineno-6-123" href="#__codelineno-6-123"></a>                <span class="n">json</span><span class="o">=</span><span class="n">endpoint</span><span class="o">.</span><span class="n">parameters</span> <span class="k">if</span> <span class="n">endpoint</span><span class="o">.</span><span class="n">method</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">,</span> <span class="s1">&#39;PUT&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="__span-6-124"><a id="__codelineno-6-124" name="__codelineno-6-124" href="#__codelineno-6-124"></a>                <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span>
</span><span id="__span-6-125"><a id="__codelineno-6-125" name="__codelineno-6-125" href="#__codelineno-6-125"></a>            <span class="p">)</span>
</span><span id="__span-6-126"><a id="__codelineno-6-126" name="__codelineno-6-126" href="#__codelineno-6-126"></a>
</span><span id="__span-6-127"><a id="__codelineno-6-127" name="__codelineno-6-127" href="#__codelineno-6-127"></a>            <span class="c1"># Restore headers</span>
</span><span id="__span-6-128"><a id="__codelineno-6-128" name="__codelineno-6-128" href="#__codelineno-6-128"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">headers</span> <span class="o">=</span> <span class="n">original_headers</span>
</span><span id="__span-6-129"><a id="__codelineno-6-129" name="__codelineno-6-129" href="#__codelineno-6-129"></a>
</span><span id="__span-6-130"><a id="__codelineno-6-130" name="__codelineno-6-130" href="#__codelineno-6-130"></a>            <span class="c1"># Should return 401 Unauthorized</span>
</span><span id="__span-6-131"><a id="__codelineno-6-131" name="__codelineno-6-131" href="#__codelineno-6-131"></a>            <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">401</span><span class="p">:</span>
</span><span id="__span-6-132"><a id="__codelineno-6-132" name="__codelineno-6-132" href="#__codelineno-6-132"></a>                <span class="k">return</span> <span class="n">SecurityTestResult</span><span class="p">(</span>
</span><span id="__span-6-133"><a id="__codelineno-6-133" name="__codelineno-6-133" href="#__codelineno-6-133"></a>                    <span class="n">test_name</span><span class="o">=</span><span class="s2">&quot;Unauthenticated Access&quot;</span><span class="p">,</span>
</span><span id="__span-6-134"><a id="__codelineno-6-134" name="__codelineno-6-134" href="#__codelineno-6-134"></a>                    <span class="n">endpoint</span><span class="o">=</span><span class="n">endpoint</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
</span><span id="__span-6-135"><a id="__codelineno-6-135" name="__codelineno-6-135" href="#__codelineno-6-135"></a>                    <span class="n">method</span><span class="o">=</span><span class="n">endpoint</span><span class="o">.</span><span class="n">method</span><span class="p">,</span>
</span><span id="__span-6-136"><a id="__codelineno-6-136" name="__codelineno-6-136" href="#__codelineno-6-136"></a>                    <span class="n">passed</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="__span-6-137"><a id="__codelineno-6-137" name="__codelineno-6-137" href="#__codelineno-6-137"></a>                    <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;medium&quot;</span><span class="p">,</span>
</span><span id="__span-6-138"><a id="__codelineno-6-138" name="__codelineno-6-138" href="#__codelineno-6-138"></a>                    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Endpoint properly requires authentication&quot;</span><span class="p">,</span>
</span><span id="__span-6-139"><a id="__codelineno-6-139" name="__codelineno-6-139" href="#__codelineno-6-139"></a>                    <span class="n">details</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;status_code&quot;</span><span class="p">:</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">},</span>
</span><span id="__span-6-140"><a id="__codelineno-6-140" name="__codelineno-6-140" href="#__codelineno-6-140"></a>                    <span class="n">remediation</span><span class="o">=</span><span class="s2">&quot;Continue current authentication enforcement&quot;</span>
</span><span id="__span-6-141"><a id="__codelineno-6-141" name="__codelineno-6-141" href="#__codelineno-6-141"></a>                <span class="p">)</span>
</span><span id="__span-6-142"><a id="__codelineno-6-142" name="__codelineno-6-142" href="#__codelineno-6-142"></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="__span-6-143"><a id="__codelineno-6-143" name="__codelineno-6-143" href="#__codelineno-6-143"></a>                <span class="k">return</span> <span class="n">SecurityTestResult</span><span class="p">(</span>
</span><span id="__span-6-144"><a id="__codelineno-6-144" name="__codelineno-6-144" href="#__codelineno-6-144"></a>                    <span class="n">test_name</span><span class="o">=</span><span class="s2">&quot;Unauthenticated Access&quot;</span><span class="p">,</span>
</span><span id="__span-6-145"><a id="__codelineno-6-145" name="__codelineno-6-145" href="#__codelineno-6-145"></a>                    <span class="n">endpoint</span><span class="o">=</span><span class="n">endpoint</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
</span><span id="__span-6-146"><a id="__codelineno-6-146" name="__codelineno-6-146" href="#__codelineno-6-146"></a>                    <span class="n">method</span><span class="o">=</span><span class="n">endpoint</span><span class="o">.</span><span class="n">method</span><span class="p">,</span>
</span><span id="__span-6-147"><a id="__codelineno-6-147" name="__codelineno-6-147" href="#__codelineno-6-147"></a>                    <span class="n">passed</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="__span-6-148"><a id="__codelineno-6-148" name="__codelineno-6-148" href="#__codelineno-6-148"></a>                    <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;high&quot;</span><span class="p">,</span>
</span><span id="__span-6-149"><a id="__codelineno-6-149" name="__codelineno-6-149" href="#__codelineno-6-149"></a>                    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Endpoint accessible without authentication&quot;</span><span class="p">,</span>
</span><span id="__span-6-150"><a id="__codelineno-6-150" name="__codelineno-6-150" href="#__codelineno-6-150"></a>                    <span class="n">details</span><span class="o">=</span><span class="p">{</span>
</span><span id="__span-6-151"><a id="__codelineno-6-151" name="__codelineno-6-151" href="#__codelineno-6-151"></a>                        <span class="s2">&quot;status_code&quot;</span><span class="p">:</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span>
</span><span id="__span-6-152"><a id="__codelineno-6-152" name="__codelineno-6-152" href="#__codelineno-6-152"></a>                        <span class="s2">&quot;response_size&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
</span><span id="__span-6-153"><a id="__codelineno-6-153" name="__codelineno-6-153" href="#__codelineno-6-153"></a>                    <span class="p">},</span>
</span><span id="__span-6-154"><a id="__codelineno-6-154" name="__codelineno-6-154" href="#__codelineno-6-154"></a>                    <span class="n">remediation</span><span class="o">=</span><span class="s2">&quot;Implement proper authentication checks&quot;</span>
</span><span id="__span-6-155"><a id="__codelineno-6-155" name="__codelineno-6-155" href="#__codelineno-6-155"></a>                <span class="p">)</span>
</span><span id="__span-6-156"><a id="__codelineno-6-156" name="__codelineno-6-156" href="#__codelineno-6-156"></a>
</span><span id="__span-6-157"><a id="__codelineno-6-157" name="__codelineno-6-157" href="#__codelineno-6-157"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-6-158"><a id="__codelineno-6-158" name="__codelineno-6-158" href="#__codelineno-6-158"></a>            <span class="k">return</span> <span class="n">SecurityTestResult</span><span class="p">(</span>
</span><span id="__span-6-159"><a id="__codelineno-6-159" name="__codelineno-6-159" href="#__codelineno-6-159"></a>                <span class="n">test_name</span><span class="o">=</span><span class="s2">&quot;Unauthenticated Access&quot;</span><span class="p">,</span>
</span><span id="__span-6-160"><a id="__codelineno-6-160" name="__codelineno-6-160" href="#__codelineno-6-160"></a>                <span class="n">endpoint</span><span class="o">=</span><span class="n">endpoint</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
</span><span id="__span-6-161"><a id="__codelineno-6-161" name="__codelineno-6-161" href="#__codelineno-6-161"></a>                <span class="n">method</span><span class="o">=</span><span class="n">endpoint</span><span class="o">.</span><span class="n">method</span><span class="p">,</span>
</span><span id="__span-6-162"><a id="__codelineno-6-162" name="__codelineno-6-162" href="#__codelineno-6-162"></a>                <span class="n">passed</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="__span-6-163"><a id="__codelineno-6-163" name="__codelineno-6-163" href="#__codelineno-6-163"></a>                <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;medium&quot;</span><span class="p">,</span>
</span><span id="__span-6-164"><a id="__codelineno-6-164" name="__codelineno-6-164" href="#__codelineno-6-164"></a>                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Error testing unauthenticated access&quot;</span><span class="p">,</span>
</span><span id="__span-6-165"><a id="__codelineno-6-165" name="__codelineno-6-165" href="#__codelineno-6-165"></a>                <span class="n">details</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)},</span>
</span><span id="__span-6-166"><a id="__codelineno-6-166" name="__codelineno-6-166" href="#__codelineno-6-166"></a>                <span class="n">remediation</span><span class="o">=</span><span class="s2">&quot;Review endpoint implementation&quot;</span>
</span><span id="__span-6-167"><a id="__codelineno-6-167" name="__codelineno-6-167" href="#__codelineno-6-167"></a>            <span class="p">)</span>
</span><span id="__span-6-168"><a id="__codelineno-6-168" name="__codelineno-6-168" href="#__codelineno-6-168"></a>
</span><span id="__span-6-169"><a id="__codelineno-6-169" name="__codelineno-6-169" href="#__codelineno-6-169"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_test_invalid_token</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">:</span> <span class="n">APIEndpoint</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SecurityTestResult</span><span class="p">:</span>
</span><span id="__span-6-170"><a id="__codelineno-6-170" name="__codelineno-6-170" href="#__codelineno-6-170"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Test handling of invalid authentication tokens&quot;&quot;&quot;</span>
</span><span id="__span-6-171"><a id="__codelineno-6-171" name="__codelineno-6-171" href="#__codelineno-6-171"></a>
</span><span id="__span-6-172"><a id="__codelineno-6-172" name="__codelineno-6-172" href="#__codelineno-6-172"></a>        <span class="c1"># Store original authorization</span>
</span><span id="__span-6-173"><a id="__codelineno-6-173" name="__codelineno-6-173" href="#__codelineno-6-173"></a>        <span class="n">original_auth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Authorization&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
</span><span id="__span-6-174"><a id="__codelineno-6-174" name="__codelineno-6-174" href="#__codelineno-6-174"></a>
</span><span id="__span-6-175"><a id="__codelineno-6-175" name="__codelineno-6-175" href="#__codelineno-6-175"></a>        <span class="c1"># Test with invalid token</span>
</span><span id="__span-6-176"><a id="__codelineno-6-176" name="__codelineno-6-176" href="#__codelineno-6-176"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Authorization&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Bearer invalid_token_12345&#39;</span>
</span><span id="__span-6-177"><a id="__codelineno-6-177" name="__codelineno-6-177" href="#__codelineno-6-177"></a>
</span><span id="__span-6-178"><a id="__codelineno-6-178" name="__codelineno-6-178" href="#__codelineno-6-178"></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="__span-6-179"><a id="__codelineno-6-179" name="__codelineno-6-179" href="#__codelineno-6-179"></a>            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">request</span><span class="p">(</span>
</span><span id="__span-6-180"><a id="__codelineno-6-180" name="__codelineno-6-180" href="#__codelineno-6-180"></a>                <span class="n">method</span><span class="o">=</span><span class="n">endpoint</span><span class="o">.</span><span class="n">method</span><span class="p">,</span>
</span><span id="__span-6-181"><a id="__codelineno-6-181" name="__codelineno-6-181" href="#__codelineno-6-181"></a>                <span class="n">url</span><span class="o">=</span><span class="n">urljoin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">.</span><span class="n">path</span><span class="p">),</span>
</span><span id="__span-6-182"><a id="__codelineno-6-182" name="__codelineno-6-182" href="#__codelineno-6-182"></a>                <span class="n">params</span><span class="o">=</span><span class="n">endpoint</span><span class="o">.</span><span class="n">parameters</span> <span class="k">if</span> <span class="n">endpoint</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;GET&#39;</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="__span-6-183"><a id="__codelineno-6-183" name="__codelineno-6-183" href="#__codelineno-6-183"></a>                <span class="n">json</span><span class="o">=</span><span class="n">endpoint</span><span class="o">.</span><span class="n">parameters</span> <span class="k">if</span> <span class="n">endpoint</span><span class="o">.</span><span class="n">method</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">,</span> <span class="s1">&#39;PUT&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="__span-6-184"><a id="__codelineno-6-184" name="__codelineno-6-184" href="#__codelineno-6-184"></a>                <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span>
</span><span id="__span-6-185"><a id="__codelineno-6-185" name="__codelineno-6-185" href="#__codelineno-6-185"></a>            <span class="p">)</span>
</span><span id="__span-6-186"><a id="__codelineno-6-186" name="__codelineno-6-186" href="#__codelineno-6-186"></a>
</span><span id="__span-6-187"><a id="__codelineno-6-187" name="__codelineno-6-187" href="#__codelineno-6-187"></a>            <span class="c1"># Restore original authorization</span>
</span><span id="__span-6-188"><a id="__codelineno-6-188" name="__codelineno-6-188" href="#__codelineno-6-188"></a>            <span class="k">if</span> <span class="n">original_auth</span><span class="p">:</span>
</span><span id="__span-6-189"><a id="__codelineno-6-189" name="__codelineno-6-189" href="#__codelineno-6-189"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Authorization&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">original_auth</span>
</span><span id="__span-6-190"><a id="__codelineno-6-190" name="__codelineno-6-190" href="#__codelineno-6-190"></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="__span-6-191"><a id="__codelineno-6-191" name="__codelineno-6-191" href="#__codelineno-6-191"></a>                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Authorization&#39;</span><span class="p">]</span>
</span><span id="__span-6-192"><a id="__codelineno-6-192" name="__codelineno-6-192" href="#__codelineno-6-192"></a>
</span><span id="__span-6-193"><a id="__codelineno-6-193" name="__codelineno-6-193" href="#__codelineno-6-193"></a>            <span class="c1"># Should return 401 Unauthorized</span>
</span><span id="__span-6-194"><a id="__codelineno-6-194" name="__codelineno-6-194" href="#__codelineno-6-194"></a>            <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">401</span><span class="p">:</span>
</span><span id="__span-6-195"><a id="__codelineno-6-195" name="__codelineno-6-195" href="#__codelineno-6-195"></a>                <span class="k">return</span> <span class="n">SecurityTestResult</span><span class="p">(</span>
</span><span id="__span-6-196"><a id="__codelineno-6-196" name="__codelineno-6-196" href="#__codelineno-6-196"></a>                    <span class="n">test_name</span><span class="o">=</span><span class="s2">&quot;Invalid Token Handling&quot;</span><span class="p">,</span>
</span><span id="__span-6-197"><a id="__codelineno-6-197" name="__codelineno-6-197" href="#__codelineno-6-197"></a>                    <span class="n">endpoint</span><span class="o">=</span><span class="n">endpoint</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
</span><span id="__span-6-198"><a id="__codelineno-6-198" name="__codelineno-6-198" href="#__codelineno-6-198"></a>                    <span class="n">method</span><span class="o">=</span><span class="n">endpoint</span><span class="o">.</span><span class="n">method</span><span class="p">,</span>
</span><span id="__span-6-199"><a id="__codelineno-6-199" name="__codelineno-6-199" href="#__codelineno-6-199"></a>                    <span class="n">passed</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="__span-6-200"><a id="__codelineno-6-200" name="__codelineno-6-200" href="#__codelineno-6-200"></a>                    <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;medium&quot;</span><span class="p">,</span>
</span><span id="__span-6-201"><a id="__codelineno-6-201" name="__codelineno-6-201" href="#__codelineno-6-201"></a>                    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Invalid tokens properly rejected&quot;</span><span class="p">,</span>
</span><span id="__span-6-202"><a id="__codelineno-6-202" name="__codelineno-6-202" href="#__codelineno-6-202"></a>                    <span class="n">details</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;status_code&quot;</span><span class="p">:</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">},</span>
</span><span id="__span-6-203"><a id="__codelineno-6-203" name="__codelineno-6-203" href="#__codelineno-6-203"></a>                    <span class="n">remediation</span><span class="o">=</span><span class="s2">&quot;Continue current token validation&quot;</span>
</span><span id="__span-6-204"><a id="__codelineno-6-204" name="__codelineno-6-204" href="#__codelineno-6-204"></a>                <span class="p">)</span>
</span><span id="__span-6-205"><a id="__codelineno-6-205" name="__codelineno-6-205" href="#__codelineno-6-205"></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="__span-6-206"><a id="__codelineno-6-206" name="__codelineno-6-206" href="#__codelineno-6-206"></a>                <span class="k">return</span> <span class="n">SecurityTestResult</span><span class="p">(</span>
</span><span id="__span-6-207"><a id="__codelineno-6-207" name="__codelineno-6-207" href="#__codelineno-6-207"></a>                    <span class="n">test_name</span><span class="o">=</span><span class="s2">&quot;Invalid Token Handling&quot;</span><span class="p">,</span>
</span><span id="__span-6-208"><a id="__codelineno-6-208" name="__codelineno-6-208" href="#__codelineno-6-208"></a>                    <span class="n">endpoint</span><span class="o">=</span><span class="n">endpoint</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
</span><span id="__span-6-209"><a id="__codelineno-6-209" name="__codelineno-6-209" href="#__codelineno-6-209"></a>                    <span class="n">method</span><span class="o">=</span><span class="n">endpoint</span><span class="o">.</span><span class="n">method</span><span class="p">,</span>
</span><span id="__span-6-210"><a id="__codelineno-6-210" name="__codelineno-6-210" href="#__codelineno-6-210"></a>                    <span class="n">passed</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="__span-6-211"><a id="__codelineno-6-211" name="__codelineno-6-211" href="#__codelineno-6-211"></a>                    <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;high&quot;</span><span class="p">,</span>
</span><span id="__span-6-212"><a id="__codelineno-6-212" name="__codelineno-6-212" href="#__codelineno-6-212"></a>                    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Invalid token accepted or poor error handling&quot;</span><span class="p">,</span>
</span><span id="__span-6-213"><a id="__codelineno-6-213" name="__codelineno-6-213" href="#__codelineno-6-213"></a>                    <span class="n">details</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;status_code&quot;</span><span class="p">:</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">},</span>
</span><span id="__span-6-214"><a id="__codelineno-6-214" name="__codelineno-6-214" href="#__codelineno-6-214"></a>                    <span class="n">remediation</span><span class="o">=</span><span class="s2">&quot;Implement proper token validation and error handling&quot;</span>
</span><span id="__span-6-215"><a id="__codelineno-6-215" name="__codelineno-6-215" href="#__codelineno-6-215"></a>                <span class="p">)</span>
</span><span id="__span-6-216"><a id="__codelineno-6-216" name="__codelineno-6-216" href="#__codelineno-6-216"></a>
</span><span id="__span-6-217"><a id="__codelineno-6-217" name="__codelineno-6-217" href="#__codelineno-6-217"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-6-218"><a id="__codelineno-6-218" name="__codelineno-6-218" href="#__codelineno-6-218"></a>            <span class="k">return</span> <span class="n">SecurityTestResult</span><span class="p">(</span>
</span><span id="__span-6-219"><a id="__codelineno-6-219" name="__codelineno-6-219" href="#__codelineno-6-219"></a>                <span class="n">test_name</span><span class="o">=</span><span class="s2">&quot;Invalid Token Handling&quot;</span><span class="p">,</span>
</span><span id="__span-6-220"><a id="__codelineno-6-220" name="__codelineno-6-220" href="#__codelineno-6-220"></a>                <span class="n">endpoint</span><span class="o">=</span><span class="n">endpoint</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
</span><span id="__span-6-221"><a id="__codelineno-6-221" name="__codelineno-6-221" href="#__codelineno-6-221"></a>                <span class="n">method</span><span class="o">=</span><span class="n">endpoint</span><span class="o">.</span><span class="n">method</span><span class="p">,</span>
</span><span id="__span-6-222"><a id="__codelineno-6-222" name="__codelineno-6-222" href="#__codelineno-6-222"></a>                <span class="n">passed</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="__span-6-223"><a id="__codelineno-6-223" name="__codelineno-6-223" href="#__codelineno-6-223"></a>                <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;medium&quot;</span><span class="p">,</span>
</span><span id="__span-6-224"><a id="__codelineno-6-224" name="__codelineno-6-224" href="#__codelineno-6-224"></a>                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Error testing invalid token&quot;</span><span class="p">,</span>
</span><span id="__span-6-225"><a id="__codelineno-6-225" name="__codelineno-6-225" href="#__codelineno-6-225"></a>                <span class="n">details</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)},</span>
</span><span id="__span-6-226"><a id="__codelineno-6-226" name="__codelineno-6-226" href="#__codelineno-6-226"></a>                <span class="n">remediation</span><span class="o">=</span><span class="s2">&quot;Review token validation implementation&quot;</span>
</span><span id="__span-6-227"><a id="__codelineno-6-227" name="__codelineno-6-227" href="#__codelineno-6-227"></a>            <span class="p">)</span>
</span><span id="__span-6-228"><a id="__codelineno-6-228" name="__codelineno-6-228" href="#__codelineno-6-228"></a>
</span><span id="__span-6-229"><a id="__codelineno-6-229" name="__codelineno-6-229" href="#__codelineno-6-229"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_test_token_manipulation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">:</span> <span class="n">APIEndpoint</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SecurityTestResult</span><span class="p">:</span>
</span><span id="__span-6-230"><a id="__codelineno-6-230" name="__codelineno-6-230" href="#__codelineno-6-230"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Test for token manipulation vulnerabilities&quot;&quot;&quot;</span>
</span><span id="__span-6-231"><a id="__codelineno-6-231" name="__codelineno-6-231" href="#__codelineno-6-231"></a>
</span><span id="__span-6-232"><a id="__codelineno-6-232" name="__codelineno-6-232" href="#__codelineno-6-232"></a>        <span class="n">original_auth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Authorization&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
</span><span id="__span-6-233"><a id="__codelineno-6-233" name="__codelineno-6-233" href="#__codelineno-6-233"></a>
</span><span id="__span-6-234"><a id="__codelineno-6-234" name="__codelineno-6-234" href="#__codelineno-6-234"></a>        <span class="c1"># Test various token manipulations</span>
</span><span id="__span-6-235"><a id="__codelineno-6-235" name="__codelineno-6-235" href="#__codelineno-6-235"></a>        <span class="n">manipulated_tokens</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="__span-6-236"><a id="__codelineno-6-236" name="__codelineno-6-236" href="#__codelineno-6-236"></a>            <span class="s1">&#39;Bearer &#39;</span><span class="p">,</span>  <span class="c1"># Empty token</span>
</span><span id="__span-6-237"><a id="__codelineno-6-237" name="__codelineno-6-237" href="#__codelineno-6-237"></a>            <span class="s1">&#39;Bearer null&#39;</span><span class="p">,</span>  <span class="c1"># Null token</span>
</span><span id="__span-6-238"><a id="__codelineno-6-238" name="__codelineno-6-238" href="#__codelineno-6-238"></a>            <span class="s1">&#39;Bearer eyJhbGciOiJub25lIn0.eyJzdWIiOiJhZG1pbiJ9.&#39;</span><span class="p">,</span>  <span class="c1"># None algorithm JWT</span>
</span><span id="__span-6-239"><a id="__codelineno-6-239" name="__codelineno-6-239" href="#__codelineno-6-239"></a>            <span class="s1">&#39;Basic YWRtaW46YWRtaW4=&#39;</span><span class="p">,</span>  <span class="c1"># Different auth scheme</span>
</span><span id="__span-6-240"><a id="__codelineno-6-240" name="__codelineno-6-240" href="#__codelineno-6-240"></a>        <span class="p">]</span>
</span><span id="__span-6-241"><a id="__codelineno-6-241" name="__codelineno-6-241" href="#__codelineno-6-241"></a>
</span><span id="__span-6-242"><a id="__codelineno-6-242" name="__codelineno-6-242" href="#__codelineno-6-242"></a>        <span class="n">vulnerabilities_found</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-6-243"><a id="__codelineno-6-243" name="__codelineno-6-243" href="#__codelineno-6-243"></a>
</span><span id="__span-6-244"><a id="__codelineno-6-244" name="__codelineno-6-244" href="#__codelineno-6-244"></a>        <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">manipulated_tokens</span><span class="p">:</span>
</span><span id="__span-6-245"><a id="__codelineno-6-245" name="__codelineno-6-245" href="#__codelineno-6-245"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Authorization&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">token</span>
</span><span id="__span-6-246"><a id="__codelineno-6-246" name="__codelineno-6-246" href="#__codelineno-6-246"></a>
</span><span id="__span-6-247"><a id="__codelineno-6-247" name="__codelineno-6-247" href="#__codelineno-6-247"></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="__span-6-248"><a id="__codelineno-6-248" name="__codelineno-6-248" href="#__codelineno-6-248"></a>                <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">request</span><span class="p">(</span>
</span><span id="__span-6-249"><a id="__codelineno-6-249" name="__codelineno-6-249" href="#__codelineno-6-249"></a>                    <span class="n">method</span><span class="o">=</span><span class="n">endpoint</span><span class="o">.</span><span class="n">method</span><span class="p">,</span>
</span><span id="__span-6-250"><a id="__codelineno-6-250" name="__codelineno-6-250" href="#__codelineno-6-250"></a>                    <span class="n">url</span><span class="o">=</span><span class="n">urljoin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">.</span><span class="n">path</span><span class="p">),</span>
</span><span id="__span-6-251"><a id="__codelineno-6-251" name="__codelineno-6-251" href="#__codelineno-6-251"></a>                    <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span>
</span><span id="__span-6-252"><a id="__codelineno-6-252" name="__codelineno-6-252" href="#__codelineno-6-252"></a>                <span class="p">)</span>
</span><span id="__span-6-253"><a id="__codelineno-6-253" name="__codelineno-6-253" href="#__codelineno-6-253"></a>
</span><span id="__span-6-254"><a id="__codelineno-6-254" name="__codelineno-6-254" href="#__codelineno-6-254"></a>                <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">401</span><span class="p">:</span>
</span><span id="__span-6-255"><a id="__codelineno-6-255" name="__codelineno-6-255" href="#__codelineno-6-255"></a>                    <span class="n">vulnerabilities_found</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span id="__span-6-256"><a id="__codelineno-6-256" name="__codelineno-6-256" href="#__codelineno-6-256"></a>                        <span class="s1">&#39;token&#39;</span><span class="p">:</span> <span class="n">token</span><span class="p">,</span>
</span><span id="__span-6-257"><a id="__codelineno-6-257" name="__codelineno-6-257" href="#__codelineno-6-257"></a>                        <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span>
</span><span id="__span-6-258"><a id="__codelineno-6-258" name="__codelineno-6-258" href="#__codelineno-6-258"></a>                    <span class="p">})</span>
</span><span id="__span-6-259"><a id="__codelineno-6-259" name="__codelineno-6-259" href="#__codelineno-6-259"></a>
</span><span id="__span-6-260"><a id="__codelineno-6-260" name="__codelineno-6-260" href="#__codelineno-6-260"></a>            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="__span-6-261"><a id="__codelineno-6-261" name="__codelineno-6-261" href="#__codelineno-6-261"></a>                <span class="k">pass</span>
</span><span id="__span-6-262"><a id="__codelineno-6-262" name="__codelineno-6-262" href="#__codelineno-6-262"></a>
</span><span id="__span-6-263"><a id="__codelineno-6-263" name="__codelineno-6-263" href="#__codelineno-6-263"></a>        <span class="c1"># Restore original authorization</span>
</span><span id="__span-6-264"><a id="__codelineno-6-264" name="__codelineno-6-264" href="#__codelineno-6-264"></a>        <span class="k">if</span> <span class="n">original_auth</span><span class="p">:</span>
</span><span id="__span-6-265"><a id="__codelineno-6-265" name="__codelineno-6-265" href="#__codelineno-6-265"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Authorization&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">original_auth</span>
</span><span id="__span-6-266"><a id="__codelineno-6-266" name="__codelineno-6-266" href="#__codelineno-6-266"></a>
</span><span id="__span-6-267"><a id="__codelineno-6-267" name="__codelineno-6-267" href="#__codelineno-6-267"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">vulnerabilities_found</span><span class="p">:</span>
</span><span id="__span-6-268"><a id="__codelineno-6-268" name="__codelineno-6-268" href="#__codelineno-6-268"></a>            <span class="k">return</span> <span class="n">SecurityTestResult</span><span class="p">(</span>
</span><span id="__span-6-269"><a id="__codelineno-6-269" name="__codelineno-6-269" href="#__codelineno-6-269"></a>                <span class="n">test_name</span><span class="o">=</span><span class="s2">&quot;Token Manipulation&quot;</span><span class="p">,</span>
</span><span id="__span-6-270"><a id="__codelineno-6-270" name="__codelineno-6-270" href="#__codelineno-6-270"></a>                <span class="n">endpoint</span><span class="o">=</span><span class="n">endpoint</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
</span><span id="__span-6-271"><a id="__codelineno-6-271" name="__codelineno-6-271" href="#__codelineno-6-271"></a>                <span class="n">method</span><span class="o">=</span><span class="n">endpoint</span><span class="o">.</span><span class="n">method</span><span class="p">,</span>
</span><span id="__span-6-272"><a id="__codelineno-6-272" name="__codelineno-6-272" href="#__codelineno-6-272"></a>                <span class="n">passed</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="__span-6-273"><a id="__codelineno-6-273" name="__codelineno-6-273" href="#__codelineno-6-273"></a>                <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;medium&quot;</span><span class="p">,</span>
</span><span id="__span-6-274"><a id="__codelineno-6-274" name="__codelineno-6-274" href="#__codelineno-6-274"></a>                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Token manipulation attempts properly blocked&quot;</span><span class="p">,</span>
</span><span id="__span-6-275"><a id="__codelineno-6-275" name="__codelineno-6-275" href="#__codelineno-6-275"></a>                <span class="n">details</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;manipulations_tested&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">manipulated_tokens</span><span class="p">)},</span>
</span><span id="__span-6-276"><a id="__codelineno-6-276" name="__codelineno-6-276" href="#__codelineno-6-276"></a>                <span class="n">remediation</span><span class="o">=</span><span class="s2">&quot;Continue current token validation&quot;</span>
</span><span id="__span-6-277"><a id="__codelineno-6-277" name="__codelineno-6-277" href="#__codelineno-6-277"></a>            <span class="p">)</span>
</span><span id="__span-6-278"><a id="__codelineno-6-278" name="__codelineno-6-278" href="#__codelineno-6-278"></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="__span-6-279"><a id="__codelineno-6-279" name="__codelineno-6-279" href="#__codelineno-6-279"></a>            <span class="k">return</span> <span class="n">SecurityTestResult</span><span class="p">(</span>
</span><span id="__span-6-280"><a id="__codelineno-6-280" name="__codelineno-6-280" href="#__codelineno-6-280"></a>                <span class="n">test_name</span><span class="o">=</span><span class="s2">&quot;Token Manipulation&quot;</span><span class="p">,</span>
</span><span id="__span-6-281"><a id="__codelineno-6-281" name="__codelineno-6-281" href="#__codelineno-6-281"></a>                <span class="n">endpoint</span><span class="o">=</span><span class="n">endpoint</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
</span><span id="__span-6-282"><a id="__codelineno-6-282" name="__codelineno-6-282" href="#__codelineno-6-282"></a>                <span class="n">method</span><span class="o">=</span><span class="n">endpoint</span><span class="o">.</span><span class="n">method</span><span class="p">,</span>
</span><span id="__span-6-283"><a id="__codelineno-6-283" name="__codelineno-6-283" href="#__codelineno-6-283"></a>                <span class="n">passed</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="__span-6-284"><a id="__codelineno-6-284" name="__codelineno-6-284" href="#__codelineno-6-284"></a>                <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;high&quot;</span><span class="p">,</span>
</span><span id="__span-6-285"><a id="__codelineno-6-285" name="__codelineno-6-285" href="#__codelineno-6-285"></a>                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Vulnerable to token manipulation&quot;</span><span class="p">,</span>
</span><span id="__span-6-286"><a id="__codelineno-6-286" name="__codelineno-6-286" href="#__codelineno-6-286"></a>                <span class="n">details</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;vulnerabilities&quot;</span><span class="p">:</span> <span class="n">vulnerabilities_found</span><span class="p">},</span>
</span><span id="__span-6-287"><a id="__codelineno-6-287" name="__codelineno-6-287" href="#__codelineno-6-287"></a>                <span class="n">remediation</span><span class="o">=</span><span class="s2">&quot;Implement stronger token validation and proper error handling&quot;</span>
</span><span id="__span-6-288"><a id="__codelineno-6-288" name="__codelineno-6-288" href="#__codelineno-6-288"></a>            <span class="p">)</span>
</span><span id="__span-6-289"><a id="__codelineno-6-289" name="__codelineno-6-289" href="#__codelineno-6-289"></a>
</span><span id="__span-6-290"><a id="__codelineno-6-290" name="__codelineno-6-290" href="#__codelineno-6-290"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_injection_vulnerabilities</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">endpoints</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">APIEndpoint</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">SecurityTestResult</span><span class="p">]:</span>
</span><span id="__span-6-291"><a id="__codelineno-6-291" name="__codelineno-6-291" href="#__codelineno-6-291"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Test for injection vulnerabilities&quot;&quot;&quot;</span>
</span><span id="__span-6-292"><a id="__codelineno-6-292" name="__codelineno-6-292" href="#__codelineno-6-292"></a>        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-6-293"><a id="__codelineno-6-293" name="__codelineno-6-293" href="#__codelineno-6-293"></a>
</span><span id="__span-6-294"><a id="__codelineno-6-294" name="__codelineno-6-294" href="#__codelineno-6-294"></a>        <span class="k">for</span> <span class="n">endpoint</span> <span class="ow">in</span> <span class="n">endpoints</span><span class="p">:</span>
</span><span id="__span-6-295"><a id="__codelineno-6-295" name="__codelineno-6-295" href="#__codelineno-6-295"></a>            <span class="c1"># Test SQL injection</span>
</span><span id="__span-6-296"><a id="__codelineno-6-296" name="__codelineno-6-296" href="#__codelineno-6-296"></a>            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_test_sql_injection</span><span class="p">(</span><span class="n">endpoint</span><span class="p">))</span>
</span><span id="__span-6-297"><a id="__codelineno-6-297" name="__codelineno-6-297" href="#__codelineno-6-297"></a>
</span><span id="__span-6-298"><a id="__codelineno-6-298" name="__codelineno-6-298" href="#__codelineno-6-298"></a>            <span class="c1"># Test XSS</span>
</span><span id="__span-6-299"><a id="__codelineno-6-299" name="__codelineno-6-299" href="#__codelineno-6-299"></a>            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_test_xss_injection</span><span class="p">(</span><span class="n">endpoint</span><span class="p">))</span>
</span><span id="__span-6-300"><a id="__codelineno-6-300" name="__codelineno-6-300" href="#__codelineno-6-300"></a>
</span><span id="__span-6-301"><a id="__codelineno-6-301" name="__codelineno-6-301" href="#__codelineno-6-301"></a>            <span class="c1"># Test path traversal</span>
</span><span id="__span-6-302"><a id="__codelineno-6-302" name="__codelineno-6-302" href="#__codelineno-6-302"></a>            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_test_path_traversal</span><span class="p">(</span><span class="n">endpoint</span><span class="p">))</span>
</span><span id="__span-6-303"><a id="__codelineno-6-303" name="__codelineno-6-303" href="#__codelineno-6-303"></a>
</span><span id="__span-6-304"><a id="__codelineno-6-304" name="__codelineno-6-304" href="#__codelineno-6-304"></a>        <span class="k">return</span> <span class="n">results</span>
</span><span id="__span-6-305"><a id="__codelineno-6-305" name="__codelineno-6-305" href="#__codelineno-6-305"></a>
</span><span id="__span-6-306"><a id="__codelineno-6-306" name="__codelineno-6-306" href="#__codelineno-6-306"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_test_sql_injection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">:</span> <span class="n">APIEndpoint</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SecurityTestResult</span><span class="p">:</span>
</span><span id="__span-6-307"><a id="__codelineno-6-307" name="__codelineno-6-307" href="#__codelineno-6-307"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Test for SQL injection vulnerabilities&quot;&quot;&quot;</span>
</span><span id="__span-6-308"><a id="__codelineno-6-308" name="__codelineno-6-308" href="#__codelineno-6-308"></a>
</span><span id="__span-6-309"><a id="__codelineno-6-309" name="__codelineno-6-309" href="#__codelineno-6-309"></a>        <span class="n">vulnerabilities_found</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-6-310"><a id="__codelineno-6-310" name="__codelineno-6-310" href="#__codelineno-6-310"></a>
</span><span id="__span-6-311"><a id="__codelineno-6-311" name="__codelineno-6-311" href="#__codelineno-6-311"></a>        <span class="k">for</span> <span class="n">payload</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sql_injection_payloads</span><span class="p">:</span>
</span><span id="__span-6-312"><a id="__codelineno-6-312" name="__codelineno-6-312" href="#__codelineno-6-312"></a>            <span class="c1"># Test in different parameter positions</span>
</span><span id="__span-6-313"><a id="__codelineno-6-313" name="__codelineno-6-313" href="#__codelineno-6-313"></a>            <span class="k">for</span> <span class="n">param_name</span> <span class="ow">in</span> <span class="n">endpoint</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="__span-6-314"><a id="__codelineno-6-314" name="__codelineno-6-314" href="#__codelineno-6-314"></a>                <span class="n">test_params</span> <span class="o">=</span> <span class="n">endpoint</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="__span-6-315"><a id="__codelineno-6-315" name="__codelineno-6-315" href="#__codelineno-6-315"></a>                <span class="n">test_params</span><span class="p">[</span><span class="n">param_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">payload</span>
</span><span id="__span-6-316"><a id="__codelineno-6-316" name="__codelineno-6-316" href="#__codelineno-6-316"></a>
</span><span id="__span-6-317"><a id="__codelineno-6-317" name="__codelineno-6-317" href="#__codelineno-6-317"></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="__span-6-318"><a id="__codelineno-6-318" name="__codelineno-6-318" href="#__codelineno-6-318"></a>                    <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">request</span><span class="p">(</span>
</span><span id="__span-6-319"><a id="__codelineno-6-319" name="__codelineno-6-319" href="#__codelineno-6-319"></a>                        <span class="n">method</span><span class="o">=</span><span class="n">endpoint</span><span class="o">.</span><span class="n">method</span><span class="p">,</span>
</span><span id="__span-6-320"><a id="__codelineno-6-320" name="__codelineno-6-320" href="#__codelineno-6-320"></a>                        <span class="n">url</span><span class="o">=</span><span class="n">urljoin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">.</span><span class="n">path</span><span class="p">),</span>
</span><span id="__span-6-321"><a id="__codelineno-6-321" name="__codelineno-6-321" href="#__codelineno-6-321"></a>                        <span class="n">params</span><span class="o">=</span><span class="n">test_params</span> <span class="k">if</span> <span class="n">endpoint</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;GET&#39;</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="__span-6-322"><a id="__codelineno-6-322" name="__codelineno-6-322" href="#__codelineno-6-322"></a>                        <span class="n">json</span><span class="o">=</span><span class="n">test_params</span> <span class="k">if</span> <span class="n">endpoint</span><span class="o">.</span><span class="n">method</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">,</span> <span class="s1">&#39;PUT&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="__span-6-323"><a id="__codelineno-6-323" name="__codelineno-6-323" href="#__codelineno-6-323"></a>                        <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span>
</span><span id="__span-6-324"><a id="__codelineno-6-324" name="__codelineno-6-324" href="#__codelineno-6-324"></a>                    <span class="p">)</span>
</span><span id="__span-6-325"><a id="__codelineno-6-325" name="__codelineno-6-325" href="#__codelineno-6-325"></a>
</span><span id="__span-6-326"><a id="__codelineno-6-326" name="__codelineno-6-326" href="#__codelineno-6-326"></a>                    <span class="c1"># Look for SQL error indicators</span>
</span><span id="__span-6-327"><a id="__codelineno-6-327" name="__codelineno-6-327" href="#__codelineno-6-327"></a>                    <span class="n">response_text</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span><span id="__span-6-328"><a id="__codelineno-6-328" name="__codelineno-6-328" href="#__codelineno-6-328"></a>                    <span class="n">sql_errors</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="__span-6-329"><a id="__codelineno-6-329" name="__codelineno-6-329" href="#__codelineno-6-329"></a>                        <span class="s1">&#39;sql syntax&#39;</span><span class="p">,</span> <span class="s1">&#39;mysql_fetch&#39;</span><span class="p">,</span> <span class="s1">&#39;ora-&#39;</span><span class="p">,</span> <span class="s1">&#39;postgresql&#39;</span><span class="p">,</span>
</span><span id="__span-6-330"><a id="__codelineno-6-330" name="__codelineno-6-330" href="#__codelineno-6-330"></a>                        <span class="s1">&#39;sqlite_&#39;</span><span class="p">,</span> <span class="s1">&#39;database error&#39;</span><span class="p">,</span> <span class="s1">&#39;sql statement&#39;</span><span class="p">,</span>
</span><span id="__span-6-331"><a id="__codelineno-6-331" name="__codelineno-6-331" href="#__codelineno-6-331"></a>                        <span class="s1">&#39;syntax error&#39;</span><span class="p">,</span> <span class="s1">&#39;table does not exist&#39;</span>
</span><span id="__span-6-332"><a id="__codelineno-6-332" name="__codelineno-6-332" href="#__codelineno-6-332"></a>                    <span class="p">]</span>
</span><span id="__span-6-333"><a id="__codelineno-6-333" name="__codelineno-6-333" href="#__codelineno-6-333"></a>
</span><span id="__span-6-334"><a id="__codelineno-6-334" name="__codelineno-6-334" href="#__codelineno-6-334"></a>                    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">error</span> <span class="ow">in</span> <span class="n">response_text</span> <span class="k">for</span> <span class="n">error</span> <span class="ow">in</span> <span class="n">sql_errors</span><span class="p">):</span>
</span><span id="__span-6-335"><a id="__codelineno-6-335" name="__codelineno-6-335" href="#__codelineno-6-335"></a>                        <span class="n">vulnerabilities_found</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span id="__span-6-336"><a id="__codelineno-6-336" name="__codelineno-6-336" href="#__codelineno-6-336"></a>                            <span class="s1">&#39;parameter&#39;</span><span class="p">:</span> <span class="n">param_name</span><span class="p">,</span>
</span><span id="__span-6-337"><a id="__codelineno-6-337" name="__codelineno-6-337" href="#__codelineno-6-337"></a>                            <span class="s1">&#39;payload&#39;</span><span class="p">:</span> <span class="n">payload</span><span class="p">,</span>
</span><span id="__span-6-338"><a id="__codelineno-6-338" name="__codelineno-6-338" href="#__codelineno-6-338"></a>                            <span class="s1">&#39;status_code&#39;</span><span class="p">:</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span>
</span><span id="__span-6-339"><a id="__codelineno-6-339" name="__codelineno-6-339" href="#__codelineno-6-339"></a>                            <span class="s1">&#39;error_indicators&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">err</span> <span class="k">for</span> <span class="n">err</span> <span class="ow">in</span> <span class="n">sql_errors</span> <span class="k">if</span> <span class="n">err</span> <span class="ow">in</span> <span class="n">response_text</span><span class="p">]</span>
</span><span id="__span-6-340"><a id="__codelineno-6-340" name="__codelineno-6-340" href="#__codelineno-6-340"></a>                        <span class="p">})</span>
</span><span id="__span-6-341"><a id="__codelineno-6-341" name="__codelineno-6-341" href="#__codelineno-6-341"></a>
</span><span id="__span-6-342"><a id="__codelineno-6-342" name="__codelineno-6-342" href="#__codelineno-6-342"></a>                    <span class="c1"># Also check for unusual response times (blind SQL injection)</span>
</span><span id="__span-6-343"><a id="__codelineno-6-343" name="__codelineno-6-343" href="#__codelineno-6-343"></a>                    <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">elapsed</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
</span><span id="__span-6-344"><a id="__codelineno-6-344" name="__codelineno-6-344" href="#__codelineno-6-344"></a>                        <span class="n">vulnerabilities_found</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span id="__span-6-345"><a id="__codelineno-6-345" name="__codelineno-6-345" href="#__codelineno-6-345"></a>                            <span class="s1">&#39;parameter&#39;</span><span class="p">:</span> <span class="n">param_name</span><span class="p">,</span>
</span><span id="__span-6-346"><a id="__codelineno-6-346" name="__codelineno-6-346" href="#__codelineno-6-346"></a>                            <span class="s1">&#39;payload&#39;</span><span class="p">:</span> <span class="n">payload</span><span class="p">,</span>
</span><span id="__span-6-347"><a id="__codelineno-6-347" name="__codelineno-6-347" href="#__codelineno-6-347"></a>                            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;time_based_blind&#39;</span><span class="p">,</span>
</span><span id="__span-6-348"><a id="__codelineno-6-348" name="__codelineno-6-348" href="#__codelineno-6-348"></a>                            <span class="s1">&#39;response_time&#39;</span><span class="p">:</span> <span class="n">response</span><span class="o">.</span><span class="n">elapsed</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
</span><span id="__span-6-349"><a id="__codelineno-6-349" name="__codelineno-6-349" href="#__codelineno-6-349"></a>                        <span class="p">})</span>
</span><span id="__span-6-350"><a id="__codelineno-6-350" name="__codelineno-6-350" href="#__codelineno-6-350"></a>
</span><span id="__span-6-351"><a id="__codelineno-6-351" name="__codelineno-6-351" href="#__codelineno-6-351"></a>                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-6-352"><a id="__codelineno-6-352" name="__codelineno-6-352" href="#__codelineno-6-352"></a>                    <span class="c1"># Connection errors might indicate successful injection</span>
</span><span id="__span-6-353"><a id="__codelineno-6-353" name="__codelineno-6-353" href="#__codelineno-6-353"></a>                    <span class="k">if</span> <span class="s1">&#39;timeout&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
</span><span id="__span-6-354"><a id="__codelineno-6-354" name="__codelineno-6-354" href="#__codelineno-6-354"></a>                        <span class="n">vulnerabilities_found</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span id="__span-6-355"><a id="__codelineno-6-355" name="__codelineno-6-355" href="#__codelineno-6-355"></a>                            <span class="s1">&#39;parameter&#39;</span><span class="p">:</span> <span class="n">param_name</span><span class="p">,</span>
</span><span id="__span-6-356"><a id="__codelineno-6-356" name="__codelineno-6-356" href="#__codelineno-6-356"></a>                            <span class="s1">&#39;payload&#39;</span><span class="p">:</span> <span class="n">payload</span><span class="p">,</span>
</span><span id="__span-6-357"><a id="__codelineno-6-357" name="__codelineno-6-357" href="#__codelineno-6-357"></a>                            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;timeout&#39;</span><span class="p">,</span>
</span><span id="__span-6-358"><a id="__codelineno-6-358" name="__codelineno-6-358" href="#__codelineno-6-358"></a>                            <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span id="__span-6-359"><a id="__codelineno-6-359" name="__codelineno-6-359" href="#__codelineno-6-359"></a>                        <span class="p">})</span>
</span><span id="__span-6-360"><a id="__codelineno-6-360" name="__codelineno-6-360" href="#__codelineno-6-360"></a>
</span><span id="__span-6-361"><a id="__codelineno-6-361" name="__codelineno-6-361" href="#__codelineno-6-361"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">vulnerabilities_found</span><span class="p">:</span>
</span><span id="__span-6-362"><a id="__codelineno-6-362" name="__codelineno-6-362" href="#__codelineno-6-362"></a>            <span class="k">return</span> <span class="n">SecurityTestResult</span><span class="p">(</span>
</span><span id="__span-6-363"><a id="__codelineno-6-363" name="__codelineno-6-363" href="#__codelineno-6-363"></a>                <span class="n">test_name</span><span class="o">=</span><span class="s2">&quot;SQL Injection&quot;</span><span class="p">,</span>
</span><span id="__span-6-364"><a id="__codelineno-6-364" name="__codelineno-6-364" href="#__codelineno-6-364"></a>                <span class="n">endpoint</span><span class="o">=</span><span class="n">endpoint</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
</span><span id="__span-6-365"><a id="__codelineno-6-365" name="__codelineno-6-365" href="#__codelineno-6-365"></a>                <span class="n">method</span><span class="o">=</span><span class="n">endpoint</span><span class="o">.</span><span class="n">method</span><span class="p">,</span>
</span><span id="__span-6-366"><a id="__codelineno-6-366" name="__codelineno-6-366" href="#__codelineno-6-366"></a>                <span class="n">passed</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="__span-6-367"><a id="__codelineno-6-367" name="__codelineno-6-367" href="#__codelineno-6-367"></a>                <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;critical&quot;</span><span class="p">,</span>
</span><span id="__span-6-368"><a id="__codelineno-6-368" name="__codelineno-6-368" href="#__codelineno-6-368"></a>                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;No SQL injection vulnerabilities detected&quot;</span><span class="p">,</span>
</span><span id="__span-6-369"><a id="__codelineno-6-369" name="__codelineno-6-369" href="#__codelineno-6-369"></a>                <span class="n">details</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;payloads_tested&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sql_injection_payloads</span><span class="p">)},</span>
</span><span id="__span-6-370"><a id="__codelineno-6-370" name="__codelineno-6-370" href="#__codelineno-6-370"></a>                <span class="n">remediation</span><span class="o">=</span><span class="s2">&quot;Continue using parameterized queries&quot;</span>
</span><span id="__span-6-371"><a id="__codelineno-6-371" name="__codelineno-6-371" href="#__codelineno-6-371"></a>            <span class="p">)</span>
</span><span id="__span-6-372"><a id="__codelineno-6-372" name="__codelineno-6-372" href="#__codelineno-6-372"></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="__span-6-373"><a id="__codelineno-6-373" name="__codelineno-6-373" href="#__codelineno-6-373"></a>            <span class="k">return</span> <span class="n">SecurityTestResult</span><span class="p">(</span>
</span><span id="__span-6-374"><a id="__codelineno-6-374" name="__codelineno-6-374" href="#__codelineno-6-374"></a>                <span class="n">test_name</span><span class="o">=</span><span class="s2">&quot;SQL Injection&quot;</span><span class="p">,</span>
</span><span id="__span-6-375"><a id="__codelineno-6-375" name="__codelineno-6-375" href="#__codelineno-6-375"></a>                <span class="n">endpoint</span><span class="o">=</span><span class="n">endpoint</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
</span><span id="__span-6-376"><a id="__codelineno-6-376" name="__codelineno-6-376" href="#__codelineno-6-376"></a>                <span class="n">method</span><span class="o">=</span><span class="n">endpoint</span><span class="o">.</span><span class="n">method</span><span class="p">,</span>
</span><span id="__span-6-377"><a id="__codelineno-6-377" name="__codelineno-6-377" href="#__codelineno-6-377"></a>                <span class="n">passed</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="__span-6-378"><a id="__codelineno-6-378" name="__codelineno-6-378" href="#__codelineno-6-378"></a>                <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;critical&quot;</span><span class="p">,</span>
</span><span id="__span-6-379"><a id="__codelineno-6-379" name="__codelineno-6-379" href="#__codelineno-6-379"></a>                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;SQL injection vulnerability detected&quot;</span><span class="p">,</span>
</span><span id="__span-6-380"><a id="__codelineno-6-380" name="__codelineno-6-380" href="#__codelineno-6-380"></a>                <span class="n">details</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;vulnerabilities&quot;</span><span class="p">:</span> <span class="n">vulnerabilities_found</span><span class="p">},</span>
</span><span id="__span-6-381"><a id="__codelineno-6-381" name="__codelineno-6-381" href="#__codelineno-6-381"></a>                <span class="n">remediation</span><span class="o">=</span><span class="s2">&quot;Use parameterized queries and input validation&quot;</span>
</span><span id="__span-6-382"><a id="__codelineno-6-382" name="__codelineno-6-382" href="#__codelineno-6-382"></a>            <span class="p">)</span>
</span><span id="__span-6-383"><a id="__codelineno-6-383" name="__codelineno-6-383" href="#__codelineno-6-383"></a>
</span><span id="__span-6-384"><a id="__codelineno-6-384" name="__codelineno-6-384" href="#__codelineno-6-384"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_test_xss_injection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">:</span> <span class="n">APIEndpoint</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SecurityTestResult</span><span class="p">:</span>
</span><span id="__span-6-385"><a id="__codelineno-6-385" name="__codelineno-6-385" href="#__codelineno-6-385"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Test for XSS vulnerabilities&quot;&quot;&quot;</span>
</span><span id="__span-6-386"><a id="__codelineno-6-386" name="__codelineno-6-386" href="#__codelineno-6-386"></a>
</span><span id="__span-6-387"><a id="__codelineno-6-387" name="__codelineno-6-387" href="#__codelineno-6-387"></a>        <span class="n">vulnerabilities_found</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-6-388"><a id="__codelineno-6-388" name="__codelineno-6-388" href="#__codelineno-6-388"></a>
</span><span id="__span-6-389"><a id="__codelineno-6-389" name="__codelineno-6-389" href="#__codelineno-6-389"></a>        <span class="k">for</span> <span class="n">payload</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xss_payloads</span><span class="p">:</span>
</span><span id="__span-6-390"><a id="__codelineno-6-390" name="__codelineno-6-390" href="#__codelineno-6-390"></a>            <span class="k">for</span> <span class="n">param_name</span> <span class="ow">in</span> <span class="n">endpoint</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="__span-6-391"><a id="__codelineno-6-391" name="__codelineno-6-391" href="#__codelineno-6-391"></a>                <span class="n">test_params</span> <span class="o">=</span> <span class="n">endpoint</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="__span-6-392"><a id="__codelineno-6-392" name="__codelineno-6-392" href="#__codelineno-6-392"></a>                <span class="n">test_params</span><span class="p">[</span><span class="n">param_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">payload</span>
</span><span id="__span-6-393"><a id="__codelineno-6-393" name="__codelineno-6-393" href="#__codelineno-6-393"></a>
</span><span id="__span-6-394"><a id="__codelineno-6-394" name="__codelineno-6-394" href="#__codelineno-6-394"></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="__span-6-395"><a id="__codelineno-6-395" name="__codelineno-6-395" href="#__codelineno-6-395"></a>                    <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">request</span><span class="p">(</span>
</span><span id="__span-6-396"><a id="__codelineno-6-396" name="__codelineno-6-396" href="#__codelineno-6-396"></a>                        <span class="n">method</span><span class="o">=</span><span class="n">endpoint</span><span class="o">.</span><span class="n">method</span><span class="p">,</span>
</span><span id="__span-6-397"><a id="__codelineno-6-397" name="__codelineno-6-397" href="#__codelineno-6-397"></a>                        <span class="n">url</span><span class="o">=</span><span class="n">urljoin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">.</span><span class="n">path</span><span class="p">),</span>
</span><span id="__span-6-398"><a id="__codelineno-6-398" name="__codelineno-6-398" href="#__codelineno-6-398"></a>                        <span class="n">params</span><span class="o">=</span><span class="n">test_params</span> <span class="k">if</span> <span class="n">endpoint</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;GET&#39;</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="__span-6-399"><a id="__codelineno-6-399" name="__codelineno-6-399" href="#__codelineno-6-399"></a>                        <span class="n">json</span><span class="o">=</span><span class="n">test_params</span> <span class="k">if</span> <span class="n">endpoint</span><span class="o">.</span><span class="n">method</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">,</span> <span class="s1">&#39;PUT&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="__span-6-400"><a id="__codelineno-6-400" name="__codelineno-6-400" href="#__codelineno-6-400"></a>                        <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span>
</span><span id="__span-6-401"><a id="__codelineno-6-401" name="__codelineno-6-401" href="#__codelineno-6-401"></a>                    <span class="p">)</span>
</span><span id="__span-6-402"><a id="__codelineno-6-402" name="__codelineno-6-402" href="#__codelineno-6-402"></a>
</span><span id="__span-6-403"><a id="__codelineno-6-403" name="__codelineno-6-403" href="#__codelineno-6-403"></a>                    <span class="c1"># Check if payload is reflected in response</span>
</span><span id="__span-6-404"><a id="__codelineno-6-404" name="__codelineno-6-404" href="#__codelineno-6-404"></a>                    <span class="k">if</span> <span class="n">payload</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>
</span><span id="__span-6-405"><a id="__codelineno-6-405" name="__codelineno-6-405" href="#__codelineno-6-405"></a>                        <span class="n">vulnerabilities_found</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span id="__span-6-406"><a id="__codelineno-6-406" name="__codelineno-6-406" href="#__codelineno-6-406"></a>                            <span class="s1">&#39;parameter&#39;</span><span class="p">:</span> <span class="n">param_name</span><span class="p">,</span>
</span><span id="__span-6-407"><a id="__codelineno-6-407" name="__codelineno-6-407" href="#__codelineno-6-407"></a>                            <span class="s1">&#39;payload&#39;</span><span class="p">:</span> <span class="n">payload</span><span class="p">,</span>
</span><span id="__span-6-408"><a id="__codelineno-6-408" name="__codelineno-6-408" href="#__codelineno-6-408"></a>                            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;reflected_xss&#39;</span>
</span><span id="__span-6-409"><a id="__codelineno-6-409" name="__codelineno-6-409" href="#__codelineno-6-409"></a>                        <span class="p">})</span>
</span><span id="__span-6-410"><a id="__codelineno-6-410" name="__codelineno-6-410" href="#__codelineno-6-410"></a>
</span><span id="__span-6-411"><a id="__codelineno-6-411" name="__codelineno-6-411" href="#__codelineno-6-411"></a>                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="__span-6-412"><a id="__codelineno-6-412" name="__codelineno-6-412" href="#__codelineno-6-412"></a>                    <span class="k">pass</span>
</span><span id="__span-6-413"><a id="__codelineno-6-413" name="__codelineno-6-413" href="#__codelineno-6-413"></a>
</span><span id="__span-6-414"><a id="__codelineno-6-414" name="__codelineno-6-414" href="#__codelineno-6-414"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">vulnerabilities_found</span><span class="p">:</span>
</span><span id="__span-6-415"><a id="__codelineno-6-415" name="__codelineno-6-415" href="#__codelineno-6-415"></a>            <span class="k">return</span> <span class="n">SecurityTestResult</span><span class="p">(</span>
</span><span id="__span-6-416"><a id="__codelineno-6-416" name="__codelineno-6-416" href="#__codelineno-6-416"></a>                <span class="n">test_name</span><span class="o">=</span><span class="s2">&quot;Cross-Site Scripting (XSS)&quot;</span><span class="p">,</span>
</span><span id="__span-6-417"><a id="__codelineno-6-417" name="__codelineno-6-417" href="#__codelineno-6-417"></a>                <span class="n">endpoint</span><span class="o">=</span><span class="n">endpoint</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
</span><span id="__span-6-418"><a id="__codelineno-6-418" name="__codelineno-6-418" href="#__codelineno-6-418"></a>                <span class="n">method</span><span class="o">=</span><span class="n">endpoint</span><span class="o">.</span><span class="n">method</span><span class="p">,</span>
</span><span id="__span-6-419"><a id="__codelineno-6-419" name="__codelineno-6-419" href="#__codelineno-6-419"></a>                <span class="n">passed</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="__span-6-420"><a id="__codelineno-6-420" name="__codelineno-6-420" href="#__codelineno-6-420"></a>                <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;high&quot;</span><span class="p">,</span>
</span><span id="__span-6-421"><a id="__codelineno-6-421" name="__codelineno-6-421" href="#__codelineno-6-421"></a>                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;No XSS vulnerabilities detected&quot;</span><span class="p">,</span>
</span><span id="__span-6-422"><a id="__codelineno-6-422" name="__codelineno-6-422" href="#__codelineno-6-422"></a>                <span class="n">details</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;payloads_tested&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xss_payloads</span><span class="p">)},</span>
</span><span id="__span-6-423"><a id="__codelineno-6-423" name="__codelineno-6-423" href="#__codelineno-6-423"></a>                <span class="n">remediation</span><span class="o">=</span><span class="s2">&quot;Continue proper output encoding&quot;</span>
</span><span id="__span-6-424"><a id="__codelineno-6-424" name="__codelineno-6-424" href="#__codelineno-6-424"></a>            <span class="p">)</span>
</span><span id="__span-6-425"><a id="__codelineno-6-425" name="__codelineno-6-425" href="#__codelineno-6-425"></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="__span-6-426"><a id="__codelineno-6-426" name="__codelineno-6-426" href="#__codelineno-6-426"></a>            <span class="k">return</span> <span class="n">SecurityTestResult</span><span class="p">(</span>
</span><span id="__span-6-427"><a id="__codelineno-6-427" name="__codelineno-6-427" href="#__codelineno-6-427"></a>                <span class="n">test_name</span><span class="o">=</span><span class="s2">&quot;Cross-Site Scripting (XSS)&quot;</span><span class="p">,</span>
</span><span id="__span-6-428"><a id="__codelineno-6-428" name="__codelineno-6-428" href="#__codelineno-6-428"></a>                <span class="n">endpoint</span><span class="o">=</span><span class="n">endpoint</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
</span><span id="__span-6-429"><a id="__codelineno-6-429" name="__codelineno-6-429" href="#__codelineno-6-429"></a>                <span class="n">method</span><span class="o">=</span><span class="n">endpoint</span><span class="o">.</span><span class="n">method</span><span class="p">,</span>
</span><span id="__span-6-430"><a id="__codelineno-6-430" name="__codelineno-6-430" href="#__codelineno-6-430"></a>                <span class="n">passed</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="__span-6-431"><a id="__codelineno-6-431" name="__codelineno-6-431" href="#__codelineno-6-431"></a>                <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;high&quot;</span><span class="p">,</span>
</span><span id="__span-6-432"><a id="__codelineno-6-432" name="__codelineno-6-432" href="#__codelineno-6-432"></a>                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;XSS vulnerability detected&quot;</span><span class="p">,</span>
</span><span id="__span-6-433"><a id="__codelineno-6-433" name="__codelineno-6-433" href="#__codelineno-6-433"></a>                <span class="n">details</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;vulnerabilities&quot;</span><span class="p">:</span> <span class="n">vulnerabilities_found</span><span class="p">},</span>
</span><span id="__span-6-434"><a id="__codelineno-6-434" name="__codelineno-6-434" href="#__codelineno-6-434"></a>                <span class="n">remediation</span><span class="o">=</span><span class="s2">&quot;Implement proper input validation and output encoding&quot;</span>
</span><span id="__span-6-435"><a id="__codelineno-6-435" name="__codelineno-6-435" href="#__codelineno-6-435"></a>            <span class="p">)</span>
</span><span id="__span-6-436"><a id="__codelineno-6-436" name="__codelineno-6-436" href="#__codelineno-6-436"></a>
</span><span id="__span-6-437"><a id="__codelineno-6-437" name="__codelineno-6-437" href="#__codelineno-6-437"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_test_path_traversal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">:</span> <span class="n">APIEndpoint</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SecurityTestResult</span><span class="p">:</span>
</span><span id="__span-6-438"><a id="__codelineno-6-438" name="__codelineno-6-438" href="#__codelineno-6-438"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Test for path traversal vulnerabilities&quot;&quot;&quot;</span>
</span><span id="__span-6-439"><a id="__codelineno-6-439" name="__codelineno-6-439" href="#__codelineno-6-439"></a>
</span><span id="__span-6-440"><a id="__codelineno-6-440" name="__codelineno-6-440" href="#__codelineno-6-440"></a>        <span class="n">vulnerabilities_found</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-6-441"><a id="__codelineno-6-441" name="__codelineno-6-441" href="#__codelineno-6-441"></a>
</span><span id="__span-6-442"><a id="__codelineno-6-442" name="__codelineno-6-442" href="#__codelineno-6-442"></a>        <span class="k">for</span> <span class="n">payload</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">path_traversal_payloads</span><span class="p">:</span>
</span><span id="__span-6-443"><a id="__codelineno-6-443" name="__codelineno-6-443" href="#__codelineno-6-443"></a>            <span class="k">for</span> <span class="n">param_name</span> <span class="ow">in</span> <span class="n">endpoint</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="__span-6-444"><a id="__codelineno-6-444" name="__codelineno-6-444" href="#__codelineno-6-444"></a>                <span class="n">test_params</span> <span class="o">=</span> <span class="n">endpoint</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="__span-6-445"><a id="__codelineno-6-445" name="__codelineno-6-445" href="#__codelineno-6-445"></a>                <span class="n">test_params</span><span class="p">[</span><span class="n">param_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">payload</span>
</span><span id="__span-6-446"><a id="__codelineno-6-446" name="__codelineno-6-446" href="#__codelineno-6-446"></a>
</span><span id="__span-6-447"><a id="__codelineno-6-447" name="__codelineno-6-447" href="#__codelineno-6-447"></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="__span-6-448"><a id="__codelineno-6-448" name="__codelineno-6-448" href="#__codelineno-6-448"></a>                    <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">request</span><span class="p">(</span>
</span><span id="__span-6-449"><a id="__codelineno-6-449" name="__codelineno-6-449" href="#__codelineno-6-449"></a>                        <span class="n">method</span><span class="o">=</span><span class="n">endpoint</span><span class="o">.</span><span class="n">method</span><span class="p">,</span>
</span><span id="__span-6-450"><a id="__codelineno-6-450" name="__codelineno-6-450" href="#__codelineno-6-450"></a>                        <span class="n">url</span><span class="o">=</span><span class="n">urljoin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">.</span><span class="n">path</span><span class="p">),</span>
</span><span id="__span-6-451"><a id="__codelineno-6-451" name="__codelineno-6-451" href="#__codelineno-6-451"></a>                        <span class="n">params</span><span class="o">=</span><span class="n">test_params</span> <span class="k">if</span> <span class="n">endpoint</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;GET&#39;</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="__span-6-452"><a id="__codelineno-6-452" name="__codelineno-6-452" href="#__codelineno-6-452"></a>                        <span class="n">json</span><span class="o">=</span><span class="n">test_params</span> <span class="k">if</span> <span class="n">endpoint</span><span class="o">.</span><span class="n">method</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">,</span> <span class="s1">&#39;PUT&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="__span-6-453"><a id="__codelineno-6-453" name="__codelineno-6-453" href="#__codelineno-6-453"></a>                        <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span>
</span><span id="__span-6-454"><a id="__codelineno-6-454" name="__codelineno-6-454" href="#__codelineno-6-454"></a>                    <span class="p">)</span>
</span><span id="__span-6-455"><a id="__codelineno-6-455" name="__codelineno-6-455" href="#__codelineno-6-455"></a>
</span><span id="__span-6-456"><a id="__codelineno-6-456" name="__codelineno-6-456" href="#__codelineno-6-456"></a>                    <span class="c1"># Look for system file indicators</span>
</span><span id="__span-6-457"><a id="__codelineno-6-457" name="__codelineno-6-457" href="#__codelineno-6-457"></a>                    <span class="n">response_text</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span><span id="__span-6-458"><a id="__codelineno-6-458" name="__codelineno-6-458" href="#__codelineno-6-458"></a>                    <span class="n">system_indicators</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="__span-6-459"><a id="__codelineno-6-459" name="__codelineno-6-459" href="#__codelineno-6-459"></a>                        <span class="s1">&#39;root:&#39;</span><span class="p">,</span> <span class="s1">&#39;bin/bash&#39;</span><span class="p">,</span> <span class="s1">&#39;windows</span><span class="se">\\</span><span class="s1">system32&#39;</span><span class="p">,</span>
</span><span id="__span-6-460"><a id="__codelineno-6-460" name="__codelineno-6-460" href="#__codelineno-6-460"></a>                        <span class="s1">&#39;/etc/passwd&#39;</span><span class="p">,</span> <span class="s1">&#39;localhost&#39;</span><span class="p">,</span> <span class="s1">&#39;127.0.0.1&#39;</span>
</span><span id="__span-6-461"><a id="__codelineno-6-461" name="__codelineno-6-461" href="#__codelineno-6-461"></a>                    <span class="p">]</span>
</span><span id="__span-6-462"><a id="__codelineno-6-462" name="__codelineno-6-462" href="#__codelineno-6-462"></a>
</span><span id="__span-6-463"><a id="__codelineno-6-463" name="__codelineno-6-463" href="#__codelineno-6-463"></a>                    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">indicator</span> <span class="ow">in</span> <span class="n">response_text</span> <span class="k">for</span> <span class="n">indicator</span> <span class="ow">in</span> <span class="n">system_indicators</span><span class="p">):</span>
</span><span id="__span-6-464"><a id="__codelineno-6-464" name="__codelineno-6-464" href="#__codelineno-6-464"></a>                        <span class="n">vulnerabilities_found</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span id="__span-6-465"><a id="__codelineno-6-465" name="__codelineno-6-465" href="#__codelineno-6-465"></a>                            <span class="s1">&#39;parameter&#39;</span><span class="p">:</span> <span class="n">param_name</span><span class="p">,</span>
</span><span id="__span-6-466"><a id="__codelineno-6-466" name="__codelineno-6-466" href="#__codelineno-6-466"></a>                            <span class="s1">&#39;payload&#39;</span><span class="p">:</span> <span class="n">payload</span><span class="p">,</span>
</span><span id="__span-6-467"><a id="__codelineno-6-467" name="__codelineno-6-467" href="#__codelineno-6-467"></a>                            <span class="s1">&#39;indicators&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">ind</span> <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="n">system_indicators</span> <span class="k">if</span> <span class="n">ind</span> <span class="ow">in</span> <span class="n">response_text</span><span class="p">]</span>
</span><span id="__span-6-468"><a id="__codelineno-6-468" name="__codelineno-6-468" href="#__codelineno-6-468"></a>                        <span class="p">})</span>
</span><span id="__span-6-469"><a id="__codelineno-6-469" name="__codelineno-6-469" href="#__codelineno-6-469"></a>
</span><span id="__span-6-470"><a id="__codelineno-6-470" name="__codelineno-6-470" href="#__codelineno-6-470"></a>                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="__span-6-471"><a id="__codelineno-6-471" name="__codelineno-6-471" href="#__codelineno-6-471"></a>                    <span class="k">pass</span>
</span><span id="__span-6-472"><a id="__codelineno-6-472" name="__codelineno-6-472" href="#__codelineno-6-472"></a>
</span><span id="__span-6-473"><a id="__codelineno-6-473" name="__codelineno-6-473" href="#__codelineno-6-473"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">vulnerabilities_found</span><span class="p">:</span>
</span><span id="__span-6-474"><a id="__codelineno-6-474" name="__codelineno-6-474" href="#__codelineno-6-474"></a>            <span class="k">return</span> <span class="n">SecurityTestResult</span><span class="p">(</span>
</span><span id="__span-6-475"><a id="__codelineno-6-475" name="__codelineno-6-475" href="#__codelineno-6-475"></a>                <span class="n">test_name</span><span class="o">=</span><span class="s2">&quot;Path Traversal&quot;</span><span class="p">,</span>
</span><span id="__span-6-476"><a id="__codelineno-6-476" name="__codelineno-6-476" href="#__codelineno-6-476"></a>                <span class="n">endpoint</span><span class="o">=</span><span class="n">endpoint</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
</span><span id="__span-6-477"><a id="__codelineno-6-477" name="__codelineno-6-477" href="#__codelineno-6-477"></a>                <span class="n">method</span><span class="o">=</span><span class="n">endpoint</span><span class="o">.</span><span class="n">method</span><span class="p">,</span>
</span><span id="__span-6-478"><a id="__codelineno-6-478" name="__codelineno-6-478" href="#__codelineno-6-478"></a>                <span class="n">passed</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="__span-6-479"><a id="__codelineno-6-479" name="__codelineno-6-479" href="#__codelineno-6-479"></a>                <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;high&quot;</span><span class="p">,</span>
</span><span id="__span-6-480"><a id="__codelineno-6-480" name="__codelineno-6-480" href="#__codelineno-6-480"></a>                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;No path traversal vulnerabilities detected&quot;</span><span class="p">,</span>
</span><span id="__span-6-481"><a id="__codelineno-6-481" name="__codelineno-6-481" href="#__codelineno-6-481"></a>                <span class="n">details</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;payloads_tested&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path_traversal_payloads</span><span class="p">)},</span>
</span><span id="__span-6-482"><a id="__codelineno-6-482" name="__codelineno-6-482" href="#__codelineno-6-482"></a>                <span class="n">remediation</span><span class="o">=</span><span class="s2">&quot;Continue proper file path validation&quot;</span>
</span><span id="__span-6-483"><a id="__codelineno-6-483" name="__codelineno-6-483" href="#__codelineno-6-483"></a>            <span class="p">)</span>
</span><span id="__span-6-484"><a id="__codelineno-6-484" name="__codelineno-6-484" href="#__codelineno-6-484"></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="__span-6-485"><a id="__codelineno-6-485" name="__codelineno-6-485" href="#__codelineno-6-485"></a>            <span class="k">return</span> <span class="n">SecurityTestResult</span><span class="p">(</span>
</span><span id="__span-6-486"><a id="__codelineno-6-486" name="__codelineno-6-486" href="#__codelineno-6-486"></a>                <span class="n">test_name</span><span class="o">=</span><span class="s2">&quot;Path Traversal&quot;</span><span class="p">,</span>
</span><span id="__span-6-487"><a id="__codelineno-6-487" name="__codelineno-6-487" href="#__codelineno-6-487"></a>                <span class="n">endpoint</span><span class="o">=</span><span class="n">endpoint</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
</span><span id="__span-6-488"><a id="__codelineno-6-488" name="__codelineno-6-488" href="#__codelineno-6-488"></a>                <span class="n">method</span><span class="o">=</span><span class="n">endpoint</span><span class="o">.</span><span class="n">method</span><span class="p">,</span>
</span><span id="__span-6-489"><a id="__codelineno-6-489" name="__codelineno-6-489" href="#__codelineno-6-489"></a>                <span class="n">passed</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="__span-6-490"><a id="__codelineno-6-490" name="__codelineno-6-490" href="#__codelineno-6-490"></a>                <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;high&quot;</span><span class="p">,</span>
</span><span id="__span-6-491"><a id="__codelineno-6-491" name="__codelineno-6-491" href="#__codelineno-6-491"></a>                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Path traversal vulnerability detected&quot;</span><span class="p">,</span>
</span><span id="__span-6-492"><a id="__codelineno-6-492" name="__codelineno-6-492" href="#__codelineno-6-492"></a>                <span class="n">details</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;vulnerabilities&quot;</span><span class="p">:</span> <span class="n">vulnerabilities_found</span><span class="p">},</span>
</span><span id="__span-6-493"><a id="__codelineno-6-493" name="__codelineno-6-493" href="#__codelineno-6-493"></a>                <span class="n">remediation</span><span class="o">=</span><span class="s2">&quot;Implement proper file path validation and sandboxing&quot;</span>
</span><span id="__span-6-494"><a id="__codelineno-6-494" name="__codelineno-6-494" href="#__codelineno-6-494"></a>            <span class="p">)</span>
</span><span id="__span-6-495"><a id="__codelineno-6-495" name="__codelineno-6-495" href="#__codelineno-6-495"></a>
</span><span id="__span-6-496"><a id="__codelineno-6-496" name="__codelineno-6-496" href="#__codelineno-6-496"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_rate_limiting</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">:</span> <span class="n">APIEndpoint</span><span class="p">,</span> 
</span><span id="__span-6-497"><a id="__codelineno-6-497" name="__codelineno-6-497" href="#__codelineno-6-497"></a>                          <span class="n">requests_count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> 
</span><span id="__span-6-498"><a id="__codelineno-6-498" name="__codelineno-6-498" href="#__codelineno-6-498"></a>                          <span class="n">time_window</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">60</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SecurityTestResult</span><span class="p">:</span>
</span><span id="__span-6-499"><a id="__codelineno-6-499" name="__codelineno-6-499" href="#__codelineno-6-499"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Test rate limiting implementation&quot;&quot;&quot;</span>
</span><span id="__span-6-500"><a id="__codelineno-6-500" name="__codelineno-6-500" href="#__codelineno-6-500"></a>
</span><span id="__span-6-501"><a id="__codelineno-6-501" name="__codelineno-6-501" href="#__codelineno-6-501"></a>        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="__span-6-502"><a id="__codelineno-6-502" name="__codelineno-6-502" href="#__codelineno-6-502"></a>        <span class="n">status_codes</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-6-503"><a id="__codelineno-6-503" name="__codelineno-6-503" href="#__codelineno-6-503"></a>        <span class="n">response_times</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-6-504"><a id="__codelineno-6-504" name="__codelineno-6-504" href="#__codelineno-6-504"></a>
</span><span id="__span-6-505"><a id="__codelineno-6-505" name="__codelineno-6-505" href="#__codelineno-6-505"></a>        <span class="c1"># Send rapid requests</span>
</span><span id="__span-6-506"><a id="__codelineno-6-506" name="__codelineno-6-506" href="#__codelineno-6-506"></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">requests_count</span><span class="p">):</span>
</span><span id="__span-6-507"><a id="__codelineno-6-507" name="__codelineno-6-507" href="#__codelineno-6-507"></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="__span-6-508"><a id="__codelineno-6-508" name="__codelineno-6-508" href="#__codelineno-6-508"></a>                <span class="n">request_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="__span-6-509"><a id="__codelineno-6-509" name="__codelineno-6-509" href="#__codelineno-6-509"></a>                <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">request</span><span class="p">(</span>
</span><span id="__span-6-510"><a id="__codelineno-6-510" name="__codelineno-6-510" href="#__codelineno-6-510"></a>                    <span class="n">method</span><span class="o">=</span><span class="n">endpoint</span><span class="o">.</span><span class="n">method</span><span class="p">,</span>
</span><span id="__span-6-511"><a id="__codelineno-6-511" name="__codelineno-6-511" href="#__codelineno-6-511"></a>                    <span class="n">url</span><span class="o">=</span><span class="n">urljoin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">.</span><span class="n">path</span><span class="p">),</span>
</span><span id="__span-6-512"><a id="__codelineno-6-512" name="__codelineno-6-512" href="#__codelineno-6-512"></a>                    <span class="n">params</span><span class="o">=</span><span class="n">endpoint</span><span class="o">.</span><span class="n">parameters</span> <span class="k">if</span> <span class="n">endpoint</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;GET&#39;</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="__span-6-513"><a id="__codelineno-6-513" name="__codelineno-6-513" href="#__codelineno-6-513"></a>                    <span class="n">json</span><span class="o">=</span><span class="n">endpoint</span><span class="o">.</span><span class="n">parameters</span> <span class="k">if</span> <span class="n">endpoint</span><span class="o">.</span><span class="n">method</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">,</span> <span class="s1">&#39;PUT&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="__span-6-514"><a id="__codelineno-6-514" name="__codelineno-6-514" href="#__codelineno-6-514"></a>                    <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span>
</span><span id="__span-6-515"><a id="__codelineno-6-515" name="__codelineno-6-515" href="#__codelineno-6-515"></a>                <span class="p">)</span>
</span><span id="__span-6-516"><a id="__codelineno-6-516" name="__codelineno-6-516" href="#__codelineno-6-516"></a>                <span class="n">request_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">request_start</span>
</span><span id="__span-6-517"><a id="__codelineno-6-517" name="__codelineno-6-517" href="#__codelineno-6-517"></a>
</span><span id="__span-6-518"><a id="__codelineno-6-518" name="__codelineno-6-518" href="#__codelineno-6-518"></a>                <span class="n">status_codes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">)</span>
</span><span id="__span-6-519"><a id="__codelineno-6-519" name="__codelineno-6-519" href="#__codelineno-6-519"></a>                <span class="n">response_times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">request_time</span><span class="p">)</span>
</span><span id="__span-6-520"><a id="__codelineno-6-520" name="__codelineno-6-520" href="#__codelineno-6-520"></a>
</span><span id="__span-6-521"><a id="__codelineno-6-521" name="__codelineno-6-521" href="#__codelineno-6-521"></a>                <span class="c1"># Short delay to avoid overwhelming the server</span>
</span><span id="__span-6-522"><a id="__codelineno-6-522" name="__codelineno-6-522" href="#__codelineno-6-522"></a>                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
</span><span id="__span-6-523"><a id="__codelineno-6-523" name="__codelineno-6-523" href="#__codelineno-6-523"></a>
</span><span id="__span-6-524"><a id="__codelineno-6-524" name="__codelineno-6-524" href="#__codelineno-6-524"></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-6-525"><a id="__codelineno-6-525" name="__codelineno-6-525" href="#__codelineno-6-525"></a>                <span class="n">status_codes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># Connection error</span>
</span><span id="__span-6-526"><a id="__codelineno-6-526" name="__codelineno-6-526" href="#__codelineno-6-526"></a>                <span class="n">response_times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span>
</span><span id="__span-6-527"><a id="__codelineno-6-527" name="__codelineno-6-527" href="#__codelineno-6-527"></a>
</span><span id="__span-6-528"><a id="__codelineno-6-528" name="__codelineno-6-528" href="#__codelineno-6-528"></a>        <span class="n">total_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
</span><span id="__span-6-529"><a id="__codelineno-6-529" name="__codelineno-6-529" href="#__codelineno-6-529"></a>
</span><span id="__span-6-530"><a id="__codelineno-6-530" name="__codelineno-6-530" href="#__codelineno-6-530"></a>        <span class="c1"># Analyze results</span>
</span><span id="__span-6-531"><a id="__codelineno-6-531" name="__codelineno-6-531" href="#__codelineno-6-531"></a>        <span class="n">rate_limited_responses</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">status_codes</span> <span class="k">if</span> <span class="n">code</span> <span class="o">==</span> <span class="mi">429</span><span class="p">)</span>
</span><span id="__span-6-532"><a id="__codelineno-6-532" name="__codelineno-6-532" href="#__codelineno-6-532"></a>        <span class="n">successful_responses</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">status_codes</span> <span class="k">if</span> <span class="mi">200</span> <span class="o">&lt;=</span> <span class="n">code</span> <span class="o">&lt;</span> <span class="mi">300</span><span class="p">)</span>
</span><span id="__span-6-533"><a id="__codelineno-6-533" name="__codelineno-6-533" href="#__codelineno-6-533"></a>
</span><span id="__span-6-534"><a id="__codelineno-6-534" name="__codelineno-6-534" href="#__codelineno-6-534"></a>        <span class="k">if</span> <span class="n">rate_limited_responses</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="__span-6-535"><a id="__codelineno-6-535" name="__codelineno-6-535" href="#__codelineno-6-535"></a>            <span class="k">return</span> <span class="n">SecurityTestResult</span><span class="p">(</span>
</span><span id="__span-6-536"><a id="__codelineno-6-536" name="__codelineno-6-536" href="#__codelineno-6-536"></a>                <span class="n">test_name</span><span class="o">=</span><span class="s2">&quot;Rate Limiting&quot;</span><span class="p">,</span>
</span><span id="__span-6-537"><a id="__codelineno-6-537" name="__codelineno-6-537" href="#__codelineno-6-537"></a>                <span class="n">endpoint</span><span class="o">=</span><span class="n">endpoint</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
</span><span id="__span-6-538"><a id="__codelineno-6-538" name="__codelineno-6-538" href="#__codelineno-6-538"></a>                <span class="n">method</span><span class="o">=</span><span class="n">endpoint</span><span class="o">.</span><span class="n">method</span><span class="p">,</span>
</span><span id="__span-6-539"><a id="__codelineno-6-539" name="__codelineno-6-539" href="#__codelineno-6-539"></a>                <span class="n">passed</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="__span-6-540"><a id="__codelineno-6-540" name="__codelineno-6-540" href="#__codelineno-6-540"></a>                <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;medium&quot;</span><span class="p">,</span>
</span><span id="__span-6-541"><a id="__codelineno-6-541" name="__codelineno-6-541" href="#__codelineno-6-541"></a>                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Rate limiting is implemented&quot;</span><span class="p">,</span>
</span><span id="__span-6-542"><a id="__codelineno-6-542" name="__codelineno-6-542" href="#__codelineno-6-542"></a>                <span class="n">details</span><span class="o">=</span><span class="p">{</span>
</span><span id="__span-6-543"><a id="__codelineno-6-543" name="__codelineno-6-543" href="#__codelineno-6-543"></a>                    <span class="s2">&quot;total_requests&quot;</span><span class="p">:</span> <span class="n">requests_count</span><span class="p">,</span>
</span><span id="__span-6-544"><a id="__codelineno-6-544" name="__codelineno-6-544" href="#__codelineno-6-544"></a>                    <span class="s2">&quot;rate_limited&quot;</span><span class="p">:</span> <span class="n">rate_limited_responses</span><span class="p">,</span>
</span><span id="__span-6-545"><a id="__codelineno-6-545" name="__codelineno-6-545" href="#__codelineno-6-545"></a>                    <span class="s2">&quot;successful&quot;</span><span class="p">:</span> <span class="n">successful_responses</span><span class="p">,</span>
</span><span id="__span-6-546"><a id="__codelineno-6-546" name="__codelineno-6-546" href="#__codelineno-6-546"></a>                    <span class="s2">&quot;total_time&quot;</span><span class="p">:</span> <span class="n">total_time</span><span class="p">,</span>
</span><span id="__span-6-547"><a id="__codelineno-6-547" name="__codelineno-6-547" href="#__codelineno-6-547"></a>                    <span class="s2">&quot;avg_response_time&quot;</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="n">response_times</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">response_times</span><span class="p">)</span>
</span><span id="__span-6-548"><a id="__codelineno-6-548" name="__codelineno-6-548" href="#__codelineno-6-548"></a>                <span class="p">},</span>
</span><span id="__span-6-549"><a id="__codelineno-6-549" name="__codelineno-6-549" href="#__codelineno-6-549"></a>                <span class="n">remediation</span><span class="o">=</span><span class="s2">&quot;Continue current rate limiting implementation&quot;</span>
</span><span id="__span-6-550"><a id="__codelineno-6-550" name="__codelineno-6-550" href="#__codelineno-6-550"></a>            <span class="p">)</span>
</span><span id="__span-6-551"><a id="__codelineno-6-551" name="__codelineno-6-551" href="#__codelineno-6-551"></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="__span-6-552"><a id="__codelineno-6-552" name="__codelineno-6-552" href="#__codelineno-6-552"></a>            <span class="k">return</span> <span class="n">SecurityTestResult</span><span class="p">(</span>
</span><span id="__span-6-553"><a id="__codelineno-6-553" name="__codelineno-6-553" href="#__codelineno-6-553"></a>                <span class="n">test_name</span><span class="o">=</span><span class="s2">&quot;Rate Limiting&quot;</span><span class="p">,</span>
</span><span id="__span-6-554"><a id="__codelineno-6-554" name="__codelineno-6-554" href="#__codelineno-6-554"></a>                <span class="n">endpoint</span><span class="o">=</span><span class="n">endpoint</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
</span><span id="__span-6-555"><a id="__codelineno-6-555" name="__codelineno-6-555" href="#__codelineno-6-555"></a>                <span class="n">method</span><span class="o">=</span><span class="n">endpoint</span><span class="o">.</span><span class="n">method</span><span class="p">,</span>
</span><span id="__span-6-556"><a id="__codelineno-6-556" name="__codelineno-6-556" href="#__codelineno-6-556"></a>                <span class="n">passed</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="__span-6-557"><a id="__codelineno-6-557" name="__codelineno-6-557" href="#__codelineno-6-557"></a>                <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;medium&quot;</span><span class="p">,</span>
</span><span id="__span-6-558"><a id="__codelineno-6-558" name="__codelineno-6-558" href="#__codelineno-6-558"></a>                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;No rate limiting detected&quot;</span><span class="p">,</span>
</span><span id="__span-6-559"><a id="__codelineno-6-559" name="__codelineno-6-559" href="#__codelineno-6-559"></a>                <span class="n">details</span><span class="o">=</span><span class="p">{</span>
</span><span id="__span-6-560"><a id="__codelineno-6-560" name="__codelineno-6-560" href="#__codelineno-6-560"></a>                    <span class="s2">&quot;total_requests&quot;</span><span class="p">:</span> <span class="n">requests_count</span><span class="p">,</span>
</span><span id="__span-6-561"><a id="__codelineno-6-561" name="__codelineno-6-561" href="#__codelineno-6-561"></a>                    <span class="s2">&quot;successful&quot;</span><span class="p">:</span> <span class="n">successful_responses</span><span class="p">,</span>
</span><span id="__span-6-562"><a id="__codelineno-6-562" name="__codelineno-6-562" href="#__codelineno-6-562"></a>                    <span class="s2">&quot;total_time&quot;</span><span class="p">:</span> <span class="n">total_time</span>
</span><span id="__span-6-563"><a id="__codelineno-6-563" name="__codelineno-6-563" href="#__codelineno-6-563"></a>                <span class="p">},</span>
</span><span id="__span-6-564"><a id="__codelineno-6-564" name="__codelineno-6-564" href="#__codelineno-6-564"></a>                <span class="n">remediation</span><span class="o">=</span><span class="s2">&quot;Implement rate limiting to prevent abuse&quot;</span>
</span><span id="__span-6-565"><a id="__codelineno-6-565" name="__codelineno-6-565" href="#__codelineno-6-565"></a>            <span class="p">)</span>
</span><span id="__span-6-566"><a id="__codelineno-6-566" name="__codelineno-6-566" href="#__codelineno-6-566"></a>
</span><span id="__span-6-567"><a id="__codelineno-6-567" name="__codelineno-6-567" href="#__codelineno-6-567"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_cors_configuration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">:</span> <span class="n">APIEndpoint</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SecurityTestResult</span><span class="p">:</span>
</span><span id="__span-6-568"><a id="__codelineno-6-568" name="__codelineno-6-568" href="#__codelineno-6-568"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Test CORS configuration security&quot;&quot;&quot;</span>
</span><span id="__span-6-569"><a id="__codelineno-6-569" name="__codelineno-6-569" href="#__codelineno-6-569"></a>
</span><span id="__span-6-570"><a id="__codelineno-6-570" name="__codelineno-6-570" href="#__codelineno-6-570"></a>        <span class="n">cors_issues</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-6-571"><a id="__codelineno-6-571" name="__codelineno-6-571" href="#__codelineno-6-571"></a>
</span><span id="__span-6-572"><a id="__codelineno-6-572" name="__codelineno-6-572" href="#__codelineno-6-572"></a>        <span class="c1"># Test with malicious origin</span>
</span><span id="__span-6-573"><a id="__codelineno-6-573" name="__codelineno-6-573" href="#__codelineno-6-573"></a>        <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Origin&#39;</span><span class="p">:</span> <span class="s1">&#39;https://evil.com&#39;</span><span class="p">}</span>
</span><span id="__span-6-574"><a id="__codelineno-6-574" name="__codelineno-6-574" href="#__codelineno-6-574"></a>
</span><span id="__span-6-575"><a id="__codelineno-6-575" name="__codelineno-6-575" href="#__codelineno-6-575"></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="__span-6-576"><a id="__codelineno-6-576" name="__codelineno-6-576" href="#__codelineno-6-576"></a>            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">request</span><span class="p">(</span>
</span><span id="__span-6-577"><a id="__codelineno-6-577" name="__codelineno-6-577" href="#__codelineno-6-577"></a>                <span class="n">method</span><span class="o">=</span><span class="n">endpoint</span><span class="o">.</span><span class="n">method</span><span class="p">,</span>
</span><span id="__span-6-578"><a id="__codelineno-6-578" name="__codelineno-6-578" href="#__codelineno-6-578"></a>                <span class="n">url</span><span class="o">=</span><span class="n">urljoin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">.</span><span class="n">path</span><span class="p">),</span>
</span><span id="__span-6-579"><a id="__codelineno-6-579" name="__codelineno-6-579" href="#__codelineno-6-579"></a>                <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span>
</span><span id="__span-6-580"><a id="__codelineno-6-580" name="__codelineno-6-580" href="#__codelineno-6-580"></a>                <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span>
</span><span id="__span-6-581"><a id="__codelineno-6-581" name="__codelineno-6-581" href="#__codelineno-6-581"></a>            <span class="p">)</span>
</span><span id="__span-6-582"><a id="__codelineno-6-582" name="__codelineno-6-582" href="#__codelineno-6-582"></a>
</span><span id="__span-6-583"><a id="__codelineno-6-583" name="__codelineno-6-583" href="#__codelineno-6-583"></a>            <span class="n">cors_origin</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Access-Control-Allow-Origin&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
</span><span id="__span-6-584"><a id="__codelineno-6-584" name="__codelineno-6-584" href="#__codelineno-6-584"></a>            <span class="n">cors_credentials</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Access-Control-Allow-Credentials&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
</span><span id="__span-6-585"><a id="__codelineno-6-585" name="__codelineno-6-585" href="#__codelineno-6-585"></a>
</span><span id="__span-6-586"><a id="__codelineno-6-586" name="__codelineno-6-586" href="#__codelineno-6-586"></a>            <span class="c1"># Check for overly permissive CORS</span>
</span><span id="__span-6-587"><a id="__codelineno-6-587" name="__codelineno-6-587" href="#__codelineno-6-587"></a>            <span class="k">if</span> <span class="n">cors_origin</span> <span class="o">==</span> <span class="s1">&#39;*&#39;</span> <span class="ow">and</span> <span class="n">cors_credentials</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
</span><span id="__span-6-588"><a id="__codelineno-6-588" name="__codelineno-6-588" href="#__codelineno-6-588"></a>                <span class="n">cors_issues</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span id="__span-6-589"><a id="__codelineno-6-589" name="__codelineno-6-589" href="#__codelineno-6-589"></a>                    <span class="s1">&#39;issue&#39;</span><span class="p">:</span> <span class="s1">&#39;Wildcard origin with credentials&#39;</span><span class="p">,</span>
</span><span id="__span-6-590"><a id="__codelineno-6-590" name="__codelineno-6-590" href="#__codelineno-6-590"></a>                    <span class="s1">&#39;severity&#39;</span><span class="p">:</span> <span class="s1">&#39;high&#39;</span>
</span><span id="__span-6-591"><a id="__codelineno-6-591" name="__codelineno-6-591" href="#__codelineno-6-591"></a>                <span class="p">})</span>
</span><span id="__span-6-592"><a id="__codelineno-6-592" name="__codelineno-6-592" href="#__codelineno-6-592"></a>
</span><span id="__span-6-593"><a id="__codelineno-6-593" name="__codelineno-6-593" href="#__codelineno-6-593"></a>            <span class="k">if</span> <span class="n">cors_origin</span> <span class="o">==</span> <span class="s1">&#39;https://evil.com&#39;</span><span class="p">:</span>
</span><span id="__span-6-594"><a id="__codelineno-6-594" name="__codelineno-6-594" href="#__codelineno-6-594"></a>                <span class="n">cors_issues</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span id="__span-6-595"><a id="__codelineno-6-595" name="__codelineno-6-595" href="#__codelineno-6-595"></a>                    <span class="s1">&#39;issue&#39;</span><span class="p">:</span> <span class="s1">&#39;Malicious origin accepted&#39;</span><span class="p">,</span>
</span><span id="__span-6-596"><a id="__codelineno-6-596" name="__codelineno-6-596" href="#__codelineno-6-596"></a>                    <span class="s1">&#39;severity&#39;</span><span class="p">:</span> <span class="s1">&#39;high&#39;</span>
</span><span id="__span-6-597"><a id="__codelineno-6-597" name="__codelineno-6-597" href="#__codelineno-6-597"></a>                <span class="p">})</span>
</span><span id="__span-6-598"><a id="__codelineno-6-598" name="__codelineno-6-598" href="#__codelineno-6-598"></a>
</span><span id="__span-6-599"><a id="__codelineno-6-599" name="__codelineno-6-599" href="#__codelineno-6-599"></a>            <span class="c1"># Test preflight request</span>
</span><span id="__span-6-600"><a id="__codelineno-6-600" name="__codelineno-6-600" href="#__codelineno-6-600"></a>            <span class="n">preflight_response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">options</span><span class="p">(</span>
</span><span id="__span-6-601"><a id="__codelineno-6-601" name="__codelineno-6-601" href="#__codelineno-6-601"></a>                <span class="n">url</span><span class="o">=</span><span class="n">urljoin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">.</span><span class="n">path</span><span class="p">),</span>
</span><span id="__span-6-602"><a id="__codelineno-6-602" name="__codelineno-6-602" href="#__codelineno-6-602"></a>                <span class="n">headers</span><span class="o">=</span><span class="p">{</span>
</span><span id="__span-6-603"><a id="__codelineno-6-603" name="__codelineno-6-603" href="#__codelineno-6-603"></a>                    <span class="s1">&#39;Origin&#39;</span><span class="p">:</span> <span class="s1">&#39;https://evil.com&#39;</span><span class="p">,</span>
</span><span id="__span-6-604"><a id="__codelineno-6-604" name="__codelineno-6-604" href="#__codelineno-6-604"></a>                    <span class="s1">&#39;Access-Control-Request-Method&#39;</span><span class="p">:</span> <span class="s1">&#39;POST&#39;</span><span class="p">,</span>
</span><span id="__span-6-605"><a id="__codelineno-6-605" name="__codelineno-6-605" href="#__codelineno-6-605"></a>                    <span class="s1">&#39;Access-Control-Request-Headers&#39;</span><span class="p">:</span> <span class="s1">&#39;Content-Type&#39;</span>
</span><span id="__span-6-606"><a id="__codelineno-6-606" name="__codelineno-6-606" href="#__codelineno-6-606"></a>                <span class="p">},</span>
</span><span id="__span-6-607"><a id="__codelineno-6-607" name="__codelineno-6-607" href="#__codelineno-6-607"></a>                <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span>
</span><span id="__span-6-608"><a id="__codelineno-6-608" name="__codelineno-6-608" href="#__codelineno-6-608"></a>            <span class="p">)</span>
</span><span id="__span-6-609"><a id="__codelineno-6-609" name="__codelineno-6-609" href="#__codelineno-6-609"></a>
</span><span id="__span-6-610"><a id="__codelineno-6-610" name="__codelineno-6-610" href="#__codelineno-6-610"></a>            <span class="k">if</span> <span class="n">preflight_response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
</span><span id="__span-6-611"><a id="__codelineno-6-611" name="__codelineno-6-611" href="#__codelineno-6-611"></a>                <span class="n">allowed_methods</span> <span class="o">=</span> <span class="n">preflight_response</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Access-Control-Allow-Methods&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
</span><span id="__span-6-612"><a id="__codelineno-6-612" name="__codelineno-6-612" href="#__codelineno-6-612"></a>                <span class="k">if</span> <span class="s1">&#39;DELETE&#39;</span> <span class="ow">in</span> <span class="n">allowed_methods</span> <span class="ow">or</span> <span class="s1">&#39;PUT&#39;</span> <span class="ow">in</span> <span class="n">allowed_methods</span><span class="p">:</span>
</span><span id="__span-6-613"><a id="__codelineno-6-613" name="__codelineno-6-613" href="#__codelineno-6-613"></a>                    <span class="n">cors_issues</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span id="__span-6-614"><a id="__codelineno-6-614" name="__codelineno-6-614" href="#__codelineno-6-614"></a>                        <span class="s1">&#39;issue&#39;</span><span class="p">:</span> <span class="s1">&#39;Dangerous methods allowed in CORS&#39;</span><span class="p">,</span>
</span><span id="__span-6-615"><a id="__codelineno-6-615" name="__codelineno-6-615" href="#__codelineno-6-615"></a>                        <span class="s1">&#39;methods&#39;</span><span class="p">:</span> <span class="n">allowed_methods</span><span class="p">,</span>
</span><span id="__span-6-616"><a id="__codelineno-6-616" name="__codelineno-6-616" href="#__codelineno-6-616"></a>                        <span class="s1">&#39;severity&#39;</span><span class="p">:</span> <span class="s1">&#39;medium&#39;</span>
</span><span id="__span-6-617"><a id="__codelineno-6-617" name="__codelineno-6-617" href="#__codelineno-6-617"></a>                    <span class="p">})</span>
</span><span id="__span-6-618"><a id="__codelineno-6-618" name="__codelineno-6-618" href="#__codelineno-6-618"></a>
</span><span id="__span-6-619"><a id="__codelineno-6-619" name="__codelineno-6-619" href="#__codelineno-6-619"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-6-620"><a id="__codelineno-6-620" name="__codelineno-6-620" href="#__codelineno-6-620"></a>            <span class="n">cors_issues</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span id="__span-6-621"><a id="__codelineno-6-621" name="__codelineno-6-621" href="#__codelineno-6-621"></a>                <span class="s1">&#39;issue&#39;</span><span class="p">:</span> <span class="s1">&#39;Error testing CORS&#39;</span><span class="p">,</span>
</span><span id="__span-6-622"><a id="__codelineno-6-622" name="__codelineno-6-622" href="#__codelineno-6-622"></a>                <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
</span><span id="__span-6-623"><a id="__codelineno-6-623" name="__codelineno-6-623" href="#__codelineno-6-623"></a>                <span class="s1">&#39;severity&#39;</span><span class="p">:</span> <span class="s1">&#39;low&#39;</span>
</span><span id="__span-6-624"><a id="__codelineno-6-624" name="__codelineno-6-624" href="#__codelineno-6-624"></a>            <span class="p">})</span>
</span><span id="__span-6-625"><a id="__codelineno-6-625" name="__codelineno-6-625" href="#__codelineno-6-625"></a>
</span><span id="__span-6-626"><a id="__codelineno-6-626" name="__codelineno-6-626" href="#__codelineno-6-626"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">cors_issues</span><span class="p">:</span>
</span><span id="__span-6-627"><a id="__codelineno-6-627" name="__codelineno-6-627" href="#__codelineno-6-627"></a>            <span class="k">return</span> <span class="n">SecurityTestResult</span><span class="p">(</span>
</span><span id="__span-6-628"><a id="__codelineno-6-628" name="__codelineno-6-628" href="#__codelineno-6-628"></a>                <span class="n">test_name</span><span class="o">=</span><span class="s2">&quot;CORS Configuration&quot;</span><span class="p">,</span>
</span><span id="__span-6-629"><a id="__codelineno-6-629" name="__codelineno-6-629" href="#__codelineno-6-629"></a>                <span class="n">endpoint</span><span class="o">=</span><span class="n">endpoint</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
</span><span id="__span-6-630"><a id="__codelineno-6-630" name="__codelineno-6-630" href="#__codelineno-6-630"></a>                <span class="n">method</span><span class="o">=</span><span class="n">endpoint</span><span class="o">.</span><span class="n">method</span><span class="p">,</span>
</span><span id="__span-6-631"><a id="__codelineno-6-631" name="__codelineno-6-631" href="#__codelineno-6-631"></a>                <span class="n">passed</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="__span-6-632"><a id="__codelineno-6-632" name="__codelineno-6-632" href="#__codelineno-6-632"></a>                <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;medium&quot;</span><span class="p">,</span>
</span><span id="__span-6-633"><a id="__codelineno-6-633" name="__codelineno-6-633" href="#__codelineno-6-633"></a>                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;CORS configuration appears secure&quot;</span><span class="p">,</span>
</span><span id="__span-6-634"><a id="__codelineno-6-634" name="__codelineno-6-634" href="#__codelineno-6-634"></a>                <span class="n">details</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;cors_headers&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">)},</span>
</span><span id="__span-6-635"><a id="__codelineno-6-635" name="__codelineno-6-635" href="#__codelineno-6-635"></a>                <span class="n">remediation</span><span class="o">=</span><span class="s2">&quot;Continue current CORS policy&quot;</span>
</span><span id="__span-6-636"><a id="__codelineno-6-636" name="__codelineno-6-636" href="#__codelineno-6-636"></a>            <span class="p">)</span>
</span><span id="__span-6-637"><a id="__codelineno-6-637" name="__codelineno-6-637" href="#__codelineno-6-637"></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="__span-6-638"><a id="__codelineno-6-638" name="__codelineno-6-638" href="#__codelineno-6-638"></a>            <span class="k">return</span> <span class="n">SecurityTestResult</span><span class="p">(</span>
</span><span id="__span-6-639"><a id="__codelineno-6-639" name="__codelineno-6-639" href="#__codelineno-6-639"></a>                <span class="n">test_name</span><span class="o">=</span><span class="s2">&quot;CORS Configuration&quot;</span><span class="p">,</span>
</span><span id="__span-6-640"><a id="__codelineno-6-640" name="__codelineno-6-640" href="#__codelineno-6-640"></a>                <span class="n">endpoint</span><span class="o">=</span><span class="n">endpoint</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
</span><span id="__span-6-641"><a id="__codelineno-6-641" name="__codelineno-6-641" href="#__codelineno-6-641"></a>                <span class="n">method</span><span class="o">=</span><span class="n">endpoint</span><span class="o">.</span><span class="n">method</span><span class="p">,</span>
</span><span id="__span-6-642"><a id="__codelineno-6-642" name="__codelineno-6-642" href="#__codelineno-6-642"></a>                <span class="n">passed</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="__span-6-643"><a id="__codelineno-6-643" name="__codelineno-6-643" href="#__codelineno-6-643"></a>                <span class="n">severity</span><span class="o">=</span><span class="s2">&quot;medium&quot;</span><span class="p">,</span>
</span><span id="__span-6-644"><a id="__codelineno-6-644" name="__codelineno-6-644" href="#__codelineno-6-644"></a>                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;CORS configuration issues detected&quot;</span><span class="p">,</span>
</span><span id="__span-6-645"><a id="__codelineno-6-645" name="__codelineno-6-645" href="#__codelineno-6-645"></a>                <span class="n">details</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;issues&quot;</span><span class="p">:</span> <span class="n">cors_issues</span><span class="p">},</span>
</span><span id="__span-6-646"><a id="__codelineno-6-646" name="__codelineno-6-646" href="#__codelineno-6-646"></a>                <span class="n">remediation</span><span class="o">=</span><span class="s2">&quot;Review and tighten CORS policy&quot;</span>
</span><span id="__span-6-647"><a id="__codelineno-6-647" name="__codelineno-6-647" href="#__codelineno-6-647"></a>            <span class="p">)</span>
</span><span id="__span-6-648"><a id="__codelineno-6-648" name="__codelineno-6-648" href="#__codelineno-6-648"></a>
</span><span id="__span-6-649"><a id="__codelineno-6-649" name="__codelineno-6-649" href="#__codelineno-6-649"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">generate_security_report</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="__span-6-650"><a id="__codelineno-6-650" name="__codelineno-6-650" href="#__codelineno-6-650"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate comprehensive security test report&quot;&quot;&quot;</span>
</span><span id="__span-6-651"><a id="__codelineno-6-651" name="__codelineno-6-651" href="#__codelineno-6-651"></a>
</span><span id="__span-6-652"><a id="__codelineno-6-652" name="__codelineno-6-652" href="#__codelineno-6-652"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">:</span>
</span><span id="__span-6-653"><a id="__codelineno-6-653" name="__codelineno-6-653" href="#__codelineno-6-653"></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;No test results available&quot;</span><span class="p">}</span>
</span><span id="__span-6-654"><a id="__codelineno-6-654" name="__codelineno-6-654" href="#__codelineno-6-654"></a>
</span><span id="__span-6-655"><a id="__codelineno-6-655" name="__codelineno-6-655" href="#__codelineno-6-655"></a>        <span class="c1"># Categorize results</span>
</span><span id="__span-6-656"><a id="__codelineno-6-656" name="__codelineno-6-656" href="#__codelineno-6-656"></a>        <span class="n">passed_tests</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">passed</span><span class="p">]</span>
</span><span id="__span-6-657"><a id="__codelineno-6-657" name="__codelineno-6-657" href="#__codelineno-6-657"></a>        <span class="n">failed_tests</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">r</span><span class="o">.</span><span class="n">passed</span><span class="p">]</span>
</span><span id="__span-6-658"><a id="__codelineno-6-658" name="__codelineno-6-658" href="#__codelineno-6-658"></a>
</span><span id="__span-6-659"><a id="__codelineno-6-659" name="__codelineno-6-659" href="#__codelineno-6-659"></a>        <span class="c1"># Count by severity</span>
</span><span id="__span-6-660"><a id="__codelineno-6-660" name="__codelineno-6-660" href="#__codelineno-6-660"></a>        <span class="n">severity_counts</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-6-661"><a id="__codelineno-6-661" name="__codelineno-6-661" href="#__codelineno-6-661"></a>            <span class="s1">&#39;critical&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">([</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">failed_tests</span> <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">severity</span> <span class="o">==</span> <span class="s1">&#39;critical&#39;</span><span class="p">]),</span>
</span><span id="__span-6-662"><a id="__codelineno-6-662" name="__codelineno-6-662" href="#__codelineno-6-662"></a>            <span class="s1">&#39;high&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">([</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">failed_tests</span> <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">severity</span> <span class="o">==</span> <span class="s1">&#39;high&#39;</span><span class="p">]),</span>
</span><span id="__span-6-663"><a id="__codelineno-6-663" name="__codelineno-6-663" href="#__codelineno-6-663"></a>            <span class="s1">&#39;medium&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">([</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">failed_tests</span> <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">severity</span> <span class="o">==</span> <span class="s1">&#39;medium&#39;</span><span class="p">]),</span>
</span><span id="__span-6-664"><a id="__codelineno-6-664" name="__codelineno-6-664" href="#__codelineno-6-664"></a>            <span class="s1">&#39;low&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">([</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">failed_tests</span> <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">severity</span> <span class="o">==</span> <span class="s1">&#39;low&#39;</span><span class="p">])</span>
</span><span id="__span-6-665"><a id="__codelineno-6-665" name="__codelineno-6-665" href="#__codelineno-6-665"></a>        <span class="p">}</span>
</span><span id="__span-6-666"><a id="__codelineno-6-666" name="__codelineno-6-666" href="#__codelineno-6-666"></a>
</span><span id="__span-6-667"><a id="__codelineno-6-667" name="__codelineno-6-667" href="#__codelineno-6-667"></a>        <span class="c1"># Calculate security score</span>
</span><span id="__span-6-668"><a id="__codelineno-6-668" name="__codelineno-6-668" href="#__codelineno-6-668"></a>        <span class="n">total_tests</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">)</span>
</span><span id="__span-6-669"><a id="__codelineno-6-669" name="__codelineno-6-669" href="#__codelineno-6-669"></a>        <span class="n">security_score</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">passed_tests</span><span class="p">)</span> <span class="o">/</span> <span class="n">total_tests</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span> <span class="k">if</span> <span class="n">total_tests</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
</span><span id="__span-6-670"><a id="__codelineno-6-670" name="__codelineno-6-670" href="#__codelineno-6-670"></a>
</span><span id="__span-6-671"><a id="__codelineno-6-671" name="__codelineno-6-671" href="#__codelineno-6-671"></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-6-672"><a id="__codelineno-6-672" name="__codelineno-6-672" href="#__codelineno-6-672"></a>            <span class="s1">&#39;summary&#39;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-6-673"><a id="__codelineno-6-673" name="__codelineno-6-673" href="#__codelineno-6-673"></a>                <span class="s1">&#39;total_tests&#39;</span><span class="p">:</span> <span class="n">total_tests</span><span class="p">,</span>
</span><span id="__span-6-674"><a id="__codelineno-6-674" name="__codelineno-6-674" href="#__codelineno-6-674"></a>                <span class="s1">&#39;passed&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">passed_tests</span><span class="p">),</span>
</span><span id="__span-6-675"><a id="__codelineno-6-675" name="__codelineno-6-675" href="#__codelineno-6-675"></a>                <span class="s1">&#39;failed&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">failed_tests</span><span class="p">),</span>
</span><span id="__span-6-676"><a id="__codelineno-6-676" name="__codelineno-6-676" href="#__codelineno-6-676"></a>                <span class="s1">&#39;security_score&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">security_score</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="__span-6-677"><a id="__codelineno-6-677" name="__codelineno-6-677" href="#__codelineno-6-677"></a>            <span class="p">},</span>
</span><span id="__span-6-678"><a id="__codelineno-6-678" name="__codelineno-6-678" href="#__codelineno-6-678"></a>            <span class="s1">&#39;severity_breakdown&#39;</span><span class="p">:</span> <span class="n">severity_counts</span><span class="p">,</span>
</span><span id="__span-6-679"><a id="__codelineno-6-679" name="__codelineno-6-679" href="#__codelineno-6-679"></a>            <span class="s1">&#39;failed_tests&#39;</span><span class="p">:</span> <span class="p">[</span>
</span><span id="__span-6-680"><a id="__codelineno-6-680" name="__codelineno-6-680" href="#__codelineno-6-680"></a>                <span class="p">{</span>
</span><span id="__span-6-681"><a id="__codelineno-6-681" name="__codelineno-6-681" href="#__codelineno-6-681"></a>                    <span class="s1">&#39;test&#39;</span><span class="p">:</span> <span class="n">test</span><span class="o">.</span><span class="n">test_name</span><span class="p">,</span>
</span><span id="__span-6-682"><a id="__codelineno-6-682" name="__codelineno-6-682" href="#__codelineno-6-682"></a>                    <span class="s1">&#39;endpoint&#39;</span><span class="p">:</span> <span class="n">test</span><span class="o">.</span><span class="n">endpoint</span><span class="p">,</span>
</span><span id="__span-6-683"><a id="__codelineno-6-683" name="__codelineno-6-683" href="#__codelineno-6-683"></a>                    <span class="s1">&#39;severity&#39;</span><span class="p">:</span> <span class="n">test</span><span class="o">.</span><span class="n">severity</span><span class="p">,</span>
</span><span id="__span-6-684"><a id="__codelineno-6-684" name="__codelineno-6-684" href="#__codelineno-6-684"></a>                    <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="n">test</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
</span><span id="__span-6-685"><a id="__codelineno-6-685" name="__codelineno-6-685" href="#__codelineno-6-685"></a>                    <span class="s1">&#39;remediation&#39;</span><span class="p">:</span> <span class="n">test</span><span class="o">.</span><span class="n">remediation</span>
</span><span id="__span-6-686"><a id="__codelineno-6-686" name="__codelineno-6-686" href="#__codelineno-6-686"></a>                <span class="p">}</span>
</span><span id="__span-6-687"><a id="__codelineno-6-687" name="__codelineno-6-687" href="#__codelineno-6-687"></a>                <span class="k">for</span> <span class="n">test</span> <span class="ow">in</span> <span class="n">failed_tests</span>
</span><span id="__span-6-688"><a id="__codelineno-6-688" name="__codelineno-6-688" href="#__codelineno-6-688"></a>            <span class="p">],</span>
</span><span id="__span-6-689"><a id="__codelineno-6-689" name="__codelineno-6-689" href="#__codelineno-6-689"></a>            <span class="s1">&#39;recommendations&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_recommendations</span><span class="p">(</span><span class="n">failed_tests</span><span class="p">)</span>
</span><span id="__span-6-690"><a id="__codelineno-6-690" name="__codelineno-6-690" href="#__codelineno-6-690"></a>        <span class="p">}</span>
</span><span id="__span-6-691"><a id="__codelineno-6-691" name="__codelineno-6-691" href="#__codelineno-6-691"></a>
</span><span id="__span-6-692"><a id="__codelineno-6-692" name="__codelineno-6-692" href="#__codelineno-6-692"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_generate_recommendations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">failed_tests</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">SecurityTestResult</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
</span><span id="__span-6-693"><a id="__codelineno-6-693" name="__codelineno-6-693" href="#__codelineno-6-693"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate security recommendations based on test results&quot;&quot;&quot;</span>
</span><span id="__span-6-694"><a id="__codelineno-6-694" name="__codelineno-6-694" href="#__codelineno-6-694"></a>
</span><span id="__span-6-695"><a id="__codelineno-6-695" name="__codelineno-6-695" href="#__codelineno-6-695"></a>        <span class="n">recommendations</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-6-696"><a id="__codelineno-6-696" name="__codelineno-6-696" href="#__codelineno-6-696"></a>
</span><span id="__span-6-697"><a id="__codelineno-6-697" name="__codelineno-6-697" href="#__codelineno-6-697"></a>        <span class="c1"># Check for critical issues</span>
</span><span id="__span-6-698"><a id="__codelineno-6-698" name="__codelineno-6-698" href="#__codelineno-6-698"></a>        <span class="n">critical_tests</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">failed_tests</span> <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">severity</span> <span class="o">==</span> <span class="s1">&#39;critical&#39;</span><span class="p">]</span>
</span><span id="__span-6-699"><a id="__codelineno-6-699" name="__codelineno-6-699" href="#__codelineno-6-699"></a>        <span class="k">if</span> <span class="n">critical_tests</span><span class="p">:</span>
</span><span id="__span-6-700"><a id="__codelineno-6-700" name="__codelineno-6-700" href="#__codelineno-6-700"></a>            <span class="n">recommendations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="__span-6-701"><a id="__codelineno-6-701" name="__codelineno-6-701" href="#__codelineno-6-701"></a>                <span class="s2">&quot;CRITICAL: Address SQL injection vulnerabilities immediately using parameterized queries&quot;</span>
</span><span id="__span-6-702"><a id="__codelineno-6-702" name="__codelineno-6-702" href="#__codelineno-6-702"></a>            <span class="p">)</span>
</span><span id="__span-6-703"><a id="__codelineno-6-703" name="__codelineno-6-703" href="#__codelineno-6-703"></a>
</span><span id="__span-6-704"><a id="__codelineno-6-704" name="__codelineno-6-704" href="#__codelineno-6-704"></a>        <span class="c1"># Check for authentication issues</span>
</span><span id="__span-6-705"><a id="__codelineno-6-705" name="__codelineno-6-705" href="#__codelineno-6-705"></a>        <span class="n">auth_tests</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">failed_tests</span> <span class="k">if</span> <span class="s1">&#39;authentication&#39;</span> <span class="ow">in</span> <span class="n">t</span><span class="o">.</span><span class="n">test_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
</span><span id="__span-6-706"><a id="__codelineno-6-706" name="__codelineno-6-706" href="#__codelineno-6-706"></a>        <span class="k">if</span> <span class="n">auth_tests</span><span class="p">:</span>
</span><span id="__span-6-707"><a id="__codelineno-6-707" name="__codelineno-6-707" href="#__codelineno-6-707"></a>            <span class="n">recommendations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="__span-6-708"><a id="__codelineno-6-708" name="__codelineno-6-708" href="#__codelineno-6-708"></a>                <span class="s2">&quot;Strengthen authentication mechanisms and token validation&quot;</span>
</span><span id="__span-6-709"><a id="__codelineno-6-709" name="__codelineno-6-709" href="#__codelineno-6-709"></a>            <span class="p">)</span>
</span><span id="__span-6-710"><a id="__codelineno-6-710" name="__codelineno-6-710" href="#__codelineno-6-710"></a>
</span><span id="__span-6-711"><a id="__codelineno-6-711" name="__codelineno-6-711" href="#__codelineno-6-711"></a>        <span class="c1"># Check for injection issues</span>
</span><span id="__span-6-712"><a id="__codelineno-6-712" name="__codelineno-6-712" href="#__codelineno-6-712"></a>        <span class="n">injection_tests</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">failed_tests</span> <span class="k">if</span> <span class="nb">any</span><span class="p">(</span>
</span><span id="__span-6-713"><a id="__codelineno-6-713" name="__codelineno-6-713" href="#__codelineno-6-713"></a>            <span class="n">word</span> <span class="ow">in</span> <span class="n">t</span><span class="o">.</span><span class="n">test_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;injection&#39;</span><span class="p">,</span> <span class="s1">&#39;xss&#39;</span><span class="p">,</span> <span class="s1">&#39;traversal&#39;</span><span class="p">]</span>
</span><span id="__span-6-714"><a id="__codelineno-6-714" name="__codelineno-6-714" href="#__codelineno-6-714"></a>        <span class="p">)]</span>
</span><span id="__span-6-715"><a id="__codelineno-6-715" name="__codelineno-6-715" href="#__codelineno-6-715"></a>        <span class="k">if</span> <span class="n">injection_tests</span><span class="p">:</span>
</span><span id="__span-6-716"><a id="__codelineno-6-716" name="__codelineno-6-716" href="#__codelineno-6-716"></a>            <span class="n">recommendations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="__span-6-717"><a id="__codelineno-6-717" name="__codelineno-6-717" href="#__codelineno-6-717"></a>                <span class="s2">&quot;Implement comprehensive input validation and output encoding&quot;</span>
</span><span id="__span-6-718"><a id="__codelineno-6-718" name="__codelineno-6-718" href="#__codelineno-6-718"></a>            <span class="p">)</span>
</span><span id="__span-6-719"><a id="__codelineno-6-719" name="__codelineno-6-719" href="#__codelineno-6-719"></a>
</span><span id="__span-6-720"><a id="__codelineno-6-720" name="__codelineno-6-720" href="#__codelineno-6-720"></a>        <span class="c1"># Check for CORS issues</span>
</span><span id="__span-6-721"><a id="__codelineno-6-721" name="__codelineno-6-721" href="#__codelineno-6-721"></a>        <span class="n">cors_tests</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">failed_tests</span> <span class="k">if</span> <span class="s1">&#39;cors&#39;</span> <span class="ow">in</span> <span class="n">t</span><span class="o">.</span><span class="n">test_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
</span><span id="__span-6-722"><a id="__codelineno-6-722" name="__codelineno-6-722" href="#__codelineno-6-722"></a>        <span class="k">if</span> <span class="n">cors_tests</span><span class="p">:</span>
</span><span id="__span-6-723"><a id="__codelineno-6-723" name="__codelineno-6-723" href="#__codelineno-6-723"></a>            <span class="n">recommendations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="__span-6-724"><a id="__codelineno-6-724" name="__codelineno-6-724" href="#__codelineno-6-724"></a>                <span class="s2">&quot;Review and tighten CORS policies to prevent cross-origin attacks&quot;</span>
</span><span id="__span-6-725"><a id="__codelineno-6-725" name="__codelineno-6-725" href="#__codelineno-6-725"></a>            <span class="p">)</span>
</span><span id="__span-6-726"><a id="__codelineno-6-726" name="__codelineno-6-726" href="#__codelineno-6-726"></a>
</span><span id="__span-6-727"><a id="__codelineno-6-727" name="__codelineno-6-727" href="#__codelineno-6-727"></a>        <span class="k">return</span> <span class="n">recommendations</span>
</span><span id="__span-6-728"><a id="__codelineno-6-728" name="__codelineno-6-728" href="#__codelineno-6-728"></a>
</span><span id="__span-6-729"><a id="__codelineno-6-729" name="__codelineno-6-729" href="#__codelineno-6-729"></a><span class="k">def</span><span class="w"> </span><span class="nf">security_testing_example</span><span class="p">():</span>
</span><span id="__span-6-730"><a id="__codelineno-6-730" name="__codelineno-6-730" href="#__codelineno-6-730"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Demonstrate API security testing&quot;&quot;&quot;</span>
</span><span id="__span-6-731"><a id="__codelineno-6-731" name="__codelineno-6-731" href="#__codelineno-6-731"></a>
</span><span id="__span-6-732"><a id="__codelineno-6-732" name="__codelineno-6-732" href="#__codelineno-6-732"></a>    <span class="c1"># Initialize security tester</span>
</span><span id="__span-6-733"><a id="__codelineno-6-733" name="__codelineno-6-733" href="#__codelineno-6-733"></a>    <span class="n">tester</span> <span class="o">=</span> <span class="n">APISecurityTester</span><span class="p">(</span><span class="s2">&quot;https://api.example.com&quot;</span><span class="p">)</span>
</span><span id="__span-6-734"><a id="__codelineno-6-734" name="__codelineno-6-734" href="#__codelineno-6-734"></a>
</span><span id="__span-6-735"><a id="__codelineno-6-735" name="__codelineno-6-735" href="#__codelineno-6-735"></a>    <span class="c1"># Define test endpoints</span>
</span><span id="__span-6-736"><a id="__codelineno-6-736" name="__codelineno-6-736" href="#__codelineno-6-736"></a>    <span class="n">test_endpoints</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="__span-6-737"><a id="__codelineno-6-737" name="__codelineno-6-737" href="#__codelineno-6-737"></a>        <span class="n">APIEndpoint</span><span class="p">(</span>
</span><span id="__span-6-738"><a id="__codelineno-6-738" name="__codelineno-6-738" href="#__codelineno-6-738"></a>            <span class="n">path</span><span class="o">=</span><span class="s2">&quot;/api/users&quot;</span><span class="p">,</span>
</span><span id="__span-6-739"><a id="__codelineno-6-739" name="__codelineno-6-739" href="#__codelineno-6-739"></a>            <span class="n">method</span><span class="o">=</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span>
</span><span id="__span-6-740"><a id="__codelineno-6-740" name="__codelineno-6-740" href="#__codelineno-6-740"></a>            <span class="n">auth_required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="__span-6-741"><a id="__codelineno-6-741" name="__codelineno-6-741" href="#__codelineno-6-741"></a>            <span class="n">parameters</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;page&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="s2">&quot;limit&quot;</span><span class="p">:</span> <span class="s2">&quot;10&quot;</span><span class="p">},</span>
</span><span id="__span-6-742"><a id="__codelineno-6-742" name="__codelineno-6-742" href="#__codelineno-6-742"></a>            <span class="n">expected_status</span><span class="o">=</span><span class="mi">200</span>
</span><span id="__span-6-743"><a id="__codelineno-6-743" name="__codelineno-6-743" href="#__codelineno-6-743"></a>        <span class="p">),</span>
</span><span id="__span-6-744"><a id="__codelineno-6-744" name="__codelineno-6-744" href="#__codelineno-6-744"></a>        <span class="n">APIEndpoint</span><span class="p">(</span>
</span><span id="__span-6-745"><a id="__codelineno-6-745" name="__codelineno-6-745" href="#__codelineno-6-745"></a>            <span class="n">path</span><span class="o">=</span><span class="s2">&quot;/api/users&quot;</span><span class="p">,</span>
</span><span id="__span-6-746"><a id="__codelineno-6-746" name="__codelineno-6-746" href="#__codelineno-6-746"></a>            <span class="n">method</span><span class="o">=</span><span class="s2">&quot;POST&quot;</span><span class="p">,</span>
</span><span id="__span-6-747"><a id="__codelineno-6-747" name="__codelineno-6-747" href="#__codelineno-6-747"></a>            <span class="n">auth_required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="__span-6-748"><a id="__codelineno-6-748" name="__codelineno-6-748" href="#__codelineno-6-748"></a>            <span class="n">parameters</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;test&quot;</span><span class="p">,</span> <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;test@example.com&quot;</span><span class="p">},</span>
</span><span id="__span-6-749"><a id="__codelineno-6-749" name="__codelineno-6-749" href="#__codelineno-6-749"></a>            <span class="n">expected_status</span><span class="o">=</span><span class="mi">201</span>
</span><span id="__span-6-750"><a id="__codelineno-6-750" name="__codelineno-6-750" href="#__codelineno-6-750"></a>        <span class="p">),</span>
</span><span id="__span-6-751"><a id="__codelineno-6-751" name="__codelineno-6-751" href="#__codelineno-6-751"></a>        <span class="n">APIEndpoint</span><span class="p">(</span>
</span><span id="__span-6-752"><a id="__codelineno-6-752" name="__codelineno-6-752" href="#__codelineno-6-752"></a>            <span class="n">path</span><span class="o">=</span><span class="s2">&quot;/api/files&quot;</span><span class="p">,</span>
</span><span id="__span-6-753"><a id="__codelineno-6-753" name="__codelineno-6-753" href="#__codelineno-6-753"></a>            <span class="n">method</span><span class="o">=</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span>
</span><span id="__span-6-754"><a id="__codelineno-6-754" name="__codelineno-6-754" href="#__codelineno-6-754"></a>            <span class="n">auth_required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="__span-6-755"><a id="__codelineno-6-755" name="__codelineno-6-755" href="#__codelineno-6-755"></a>            <span class="n">parameters</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;filename&quot;</span><span class="p">:</span> <span class="s2">&quot;document.pdf&quot;</span><span class="p">},</span>
</span><span id="__span-6-756"><a id="__codelineno-6-756" name="__codelineno-6-756" href="#__codelineno-6-756"></a>            <span class="n">expected_status</span><span class="o">=</span><span class="mi">200</span>
</span><span id="__span-6-757"><a id="__codelineno-6-757" name="__codelineno-6-757" href="#__codelineno-6-757"></a>        <span class="p">)</span>
</span><span id="__span-6-758"><a id="__codelineno-6-758" name="__codelineno-6-758" href="#__codelineno-6-758"></a>    <span class="p">]</span>
</span><span id="__span-6-759"><a id="__codelineno-6-759" name="__codelineno-6-759" href="#__codelineno-6-759"></a>
</span><span id="__span-6-760"><a id="__codelineno-6-760" name="__codelineno-6-760" href="#__codelineno-6-760"></a>    <span class="c1"># Authenticate (if needed)</span>
</span><span id="__span-6-761"><a id="__codelineno-6-761" name="__codelineno-6-761" href="#__codelineno-6-761"></a>    <span class="k">if</span> <span class="n">tester</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="s2">&quot;testuser&quot;</span><span class="p">,</span> <span class="s2">&quot;testpass&quot;</span><span class="p">):</span>
</span><span id="__span-6-762"><a id="__codelineno-6-762" name="__codelineno-6-762" href="#__codelineno-6-762"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Authentication successful&quot;</span><span class="p">)</span>
</span><span id="__span-6-763"><a id="__codelineno-6-763" name="__codelineno-6-763" href="#__codelineno-6-763"></a>
</span><span id="__span-6-764"><a id="__codelineno-6-764" name="__codelineno-6-764" href="#__codelineno-6-764"></a>    <span class="c1"># Run security tests</span>
</span><span id="__span-6-765"><a id="__codelineno-6-765" name="__codelineno-6-765" href="#__codelineno-6-765"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Running authentication tests...&quot;</span><span class="p">)</span>
</span><span id="__span-6-766"><a id="__codelineno-6-766" name="__codelineno-6-766" href="#__codelineno-6-766"></a>    <span class="n">auth_results</span> <span class="o">=</span> <span class="n">tester</span><span class="o">.</span><span class="n">test_authentication_vulnerabilities</span><span class="p">(</span><span class="n">test_endpoints</span><span class="p">)</span>
</span><span id="__span-6-767"><a id="__codelineno-6-767" name="__codelineno-6-767" href="#__codelineno-6-767"></a>    <span class="n">tester</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">auth_results</span><span class="p">)</span>
</span><span id="__span-6-768"><a id="__codelineno-6-768" name="__codelineno-6-768" href="#__codelineno-6-768"></a>
</span><span id="__span-6-769"><a id="__codelineno-6-769" name="__codelineno-6-769" href="#__codelineno-6-769"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Running injection tests...&quot;</span><span class="p">)</span>
</span><span id="__span-6-770"><a id="__codelineno-6-770" name="__codelineno-6-770" href="#__codelineno-6-770"></a>    <span class="n">injection_results</span> <span class="o">=</span> <span class="n">tester</span><span class="o">.</span><span class="n">test_injection_vulnerabilities</span><span class="p">(</span><span class="n">test_endpoints</span><span class="p">)</span>
</span><span id="__span-6-771"><a id="__codelineno-6-771" name="__codelineno-6-771" href="#__codelineno-6-771"></a>    <span class="n">tester</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">injection_results</span><span class="p">)</span>
</span><span id="__span-6-772"><a id="__codelineno-6-772" name="__codelineno-6-772" href="#__codelineno-6-772"></a>
</span><span id="__span-6-773"><a id="__codelineno-6-773" name="__codelineno-6-773" href="#__codelineno-6-773"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Running rate limiting tests...&quot;</span><span class="p">)</span>
</span><span id="__span-6-774"><a id="__codelineno-6-774" name="__codelineno-6-774" href="#__codelineno-6-774"></a>    <span class="k">for</span> <span class="n">endpoint</span> <span class="ow">in</span> <span class="n">test_endpoints</span><span class="p">:</span>
</span><span id="__span-6-775"><a id="__codelineno-6-775" name="__codelineno-6-775" href="#__codelineno-6-775"></a>        <span class="n">rate_result</span> <span class="o">=</span> <span class="n">tester</span><span class="o">.</span><span class="n">test_rate_limiting</span><span class="p">(</span><span class="n">endpoint</span><span class="p">)</span>
</span><span id="__span-6-776"><a id="__codelineno-6-776" name="__codelineno-6-776" href="#__codelineno-6-776"></a>        <span class="n">tester</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rate_result</span><span class="p">)</span>
</span><span id="__span-6-777"><a id="__codelineno-6-777" name="__codelineno-6-777" href="#__codelineno-6-777"></a>
</span><span id="__span-6-778"><a id="__codelineno-6-778" name="__codelineno-6-778" href="#__codelineno-6-778"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Running CORS tests...&quot;</span><span class="p">)</span>
</span><span id="__span-6-779"><a id="__codelineno-6-779" name="__codelineno-6-779" href="#__codelineno-6-779"></a>    <span class="k">for</span> <span class="n">endpoint</span> <span class="ow">in</span> <span class="n">test_endpoints</span><span class="p">:</span>
</span><span id="__span-6-780"><a id="__codelineno-6-780" name="__codelineno-6-780" href="#__codelineno-6-780"></a>        <span class="n">cors_result</span> <span class="o">=</span> <span class="n">tester</span><span class="o">.</span><span class="n">test_cors_configuration</span><span class="p">(</span><span class="n">endpoint</span><span class="p">)</span>
</span><span id="__span-6-781"><a id="__codelineno-6-781" name="__codelineno-6-781" href="#__codelineno-6-781"></a>        <span class="n">tester</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cors_result</span><span class="p">)</span>
</span><span id="__span-6-782"><a id="__codelineno-6-782" name="__codelineno-6-782" href="#__codelineno-6-782"></a>
</span><span id="__span-6-783"><a id="__codelineno-6-783" name="__codelineno-6-783" href="#__codelineno-6-783"></a>    <span class="c1"># Generate report</span>
</span><span id="__span-6-784"><a id="__codelineno-6-784" name="__codelineno-6-784" href="#__codelineno-6-784"></a>    <span class="n">report</span> <span class="o">=</span> <span class="n">tester</span><span class="o">.</span><span class="n">generate_security_report</span><span class="p">()</span>
</span><span id="__span-6-785"><a id="__codelineno-6-785" name="__codelineno-6-785" href="#__codelineno-6-785"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Security Test Report:&quot;</span><span class="p">)</span>
</span><span id="__span-6-786"><a id="__codelineno-6-786" name="__codelineno-6-786" href="#__codelineno-6-786"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Security Score: </span><span class="si">{</span><span class="n">report</span><span class="p">[</span><span class="s1">&#39;summary&#39;</span><span class="p">][</span><span class="s1">&#39;security_score&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</span><span id="__span-6-787"><a id="__codelineno-6-787" name="__codelineno-6-787" href="#__codelineno-6-787"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tests Passed: </span><span class="si">{</span><span class="n">report</span><span class="p">[</span><span class="s1">&#39;summary&#39;</span><span class="p">][</span><span class="s1">&#39;passed&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">report</span><span class="p">[</span><span class="s1">&#39;summary&#39;</span><span class="p">][</span><span class="s1">&#39;total_tests&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-6-788"><a id="__codelineno-6-788" name="__codelineno-6-788" href="#__codelineno-6-788"></a>
</span><span id="__span-6-789"><a id="__codelineno-6-789" name="__codelineno-6-789" href="#__codelineno-6-789"></a>    <span class="k">if</span> <span class="n">report</span><span class="p">[</span><span class="s1">&#39;failed_tests&#39;</span><span class="p">]:</span>
</span><span id="__span-6-790"><a id="__codelineno-6-790" name="__codelineno-6-790" href="#__codelineno-6-790"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Failed Tests:&quot;</span><span class="p">)</span>
</span><span id="__span-6-791"><a id="__codelineno-6-791" name="__codelineno-6-791" href="#__codelineno-6-791"></a>        <span class="k">for</span> <span class="n">test</span> <span class="ow">in</span> <span class="n">report</span><span class="p">[</span><span class="s1">&#39;failed_tests&#39;</span><span class="p">]:</span>
</span><span id="__span-6-792"><a id="__codelineno-6-792" name="__codelineno-6-792" href="#__codelineno-6-792"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- </span><span class="si">{</span><span class="n">test</span><span class="p">[</span><span class="s1">&#39;test&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">test</span><span class="p">[</span><span class="s1">&#39;severity&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="n">test</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-6-793"><a id="__codelineno-6-793" name="__codelineno-6-793" href="#__codelineno-6-793"></a>
</span><span id="__span-6-794"><a id="__codelineno-6-794" name="__codelineno-6-794" href="#__codelineno-6-794"></a>    <span class="k">if</span> <span class="n">report</span><span class="p">[</span><span class="s1">&#39;recommendations&#39;</span><span class="p">]:</span>
</span><span id="__span-6-795"><a id="__codelineno-6-795" name="__codelineno-6-795" href="#__codelineno-6-795"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Recommendations:&quot;</span><span class="p">)</span>
</span><span id="__span-6-796"><a id="__codelineno-6-796" name="__codelineno-6-796" href="#__codelineno-6-796"></a>        <span class="k">for</span> <span class="n">rec</span> <span class="ow">in</span> <span class="n">report</span><span class="p">[</span><span class="s1">&#39;recommendations&#39;</span><span class="p">]:</span>
</span><span id="__span-6-797"><a id="__codelineno-6-797" name="__codelineno-6-797" href="#__codelineno-6-797"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- </span><span class="si">{</span><span class="n">rec</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-6-798"><a id="__codelineno-6-798" name="__codelineno-6-798" href="#__codelineno-6-798"></a>
</span><span id="__span-6-799"><a id="__codelineno-6-799" name="__codelineno-6-799" href="#__codelineno-6-799"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
</span><span id="__span-6-800"><a id="__codelineno-6-800" name="__codelineno-6-800" href="#__codelineno-6-800"></a>    <span class="n">security_testing_example</span><span class="p">()</span>
</span></code></pre></div>
<h2 id="building-a-complete-secure-rest-api">Building a Complete Secure REST <span class="glossary-term" data-glossary-category="Web Development" data-glossary-definition="A set of protocols and tools for building software applications, defining how components interact." data-glossary-full-form="Application Programming Interface" data-glossary-term="API">API</span><a class="headerlink" href="#building-a-complete-secure-rest-api" title="Permanent link">&para;</a></h2>
<p>Now we&rsquo;ll integrate all the security concepts covered into a complete, production-ready REST <span class="glossary-term" data-glossary-category="Web Development" data-glossary-definition="A set of protocols and tools for building software applications, defining how components interact." data-glossary-full-form="Application Programming Interface" data-glossary-term="API">API</span> with comprehensive security features.</p>
<h3 id="secure-api-architecture">Secure <span class="glossary-term" data-glossary-category="Web Development" data-glossary-definition="A set of protocols and tools for building software applications, defining how components interact." data-glossary-full-form="Application Programming Interface" data-glossary-term="API">API</span> Architecture<a class="headerlink" href="#secure-api-architecture" title="Permanent link">&para;</a></h3>
<div class="diagram-container" data-container-id="kroki-diagram-4"><button class="diagram-expand-btn" onclick="openDiagramModal('kroki-diagram-4')">🔍 View Larger</button><div id="kroki-diagram-4" class="diagram-content"><p><svg xmlns="http://www.w3.org/2000/svg" contentStyleType="text/css" data-diagram-type="DESCRIPTION" height="798px" preserveAspectRatio="xMaxYMax meet" style="width:596px;height:798px;background:#FFFFFF;" version="1.1" viewBox="0 0 596 798" width="596px" zoomAndPan="magnify" id="Kroki" data-diagram-id="kroki-svg-4"><defs /><g><g class="cluster" data-entity="Client Layer" data-source-line="5" data-uid="ent0002" id="cluster_Client Layer"><path d="M14.5,11 L110.2939,11 A3.75,3.75 0 0 1 112.7939,13.5 L119.7939,33.2969 L482.5,33.2969 A2.5,2.5 0 0 1 485,35.7969 L485,105.8 A2.5,2.5 0 0 1 482.5,108.3 L14.5,108.3 A2.5,2.5 0 0 1 12,105.8 L12,13.5 A2.5,2.5 0 0 1 14.5,11" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;" /><line style="stroke:#000000;stroke-width:1;" x1="12" x2="119.7939" y1="33.2969" y2="33.2969" /><text fill="#000000" font-family="Arial" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="94.7939" x="16" y="25.9951">Client Layer</text></g><g class="cluster" data-entity="Security Layer" data-source-line="11" data-uid="ent0006" id="cluster_Security Layer"><path d="M186.5,132.3 L301.6328,132.3 A3.75,3.75 0 0 1 304.1328,134.8 L311.1328,154.5969 L357.5,154.5969 A2.5,2.5 0 0 1 360,157.0969 L360,545.99 A2.5,2.5 0 0 1 357.5,548.49 L186.5,548.49 A2.5,2.5 0 0 1 184,545.99 L184,134.8 A2.5,2.5 0 0 1 186.5,132.3" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;" /><line style="stroke:#000000;stroke-width:1;" x1="184" x2="311.1328" y1="154.5969" y2="154.5969" /><text fill="#000000" font-family="Arial" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="114.1328" x="188" y="147.2951">Security Layer</text></g><g class="cluster" data-entity="API Layer" data-source-line="18" data-uid="ent0011" id="cluster_API Layer"><path d="M13.5,572.49 L89.5723,572.49 A3.75,3.75 0 0 1 92.0723,574.99 L99.0723,594.7869 L537.5,594.7869 A2.5,2.5 0 0 1 540,597.2869 L540,667.28 A2.5,2.5 0 0 1 537.5,669.78 L13.5,669.78 A2.5,2.5 0 0 1 11,667.28 L11,574.99 A2.5,2.5 0 0 1 13.5,572.49" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;" /><line style="stroke:#000000;stroke-width:1;" x1="11" x2="99.0723" y1="594.7869" y2="594.7869" /><text fill="#000000" font-family="Arial" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="75.0723" x="15" y="587.4851"><span class="glossary-term" data-glossary-category="Web Development" data-glossary-definition="A set of protocols and tools for building software applications, defining how components interact." data-glossary-full-form="Application Programming Interface" data-glossary-term="API">API</span> Layer</text></g><g class="cluster" data-entity="Data Layer" data-source-line="24" data-uid="ent0015" id="cluster_Data Layer"><path d="M44.5,693.78 L131.4756,693.78 A3.75,3.75 0 0 1 133.9756,696.28 L140.9756,716.0769 L586.5,716.0769 A2.5,2.5 0 0 1 589,718.5769 L589,788.58 A2.5,2.5 0 0 1 586.5,791.08 L44.5,791.08 A2.5,2.5 0 0 1 42,788.58 L42,696.28 A2.5,2.5 0 0 1 44.5,693.78" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;" /><line style="stroke:#000000;stroke-width:1;" x1="42" x2="140.9756" y1="716.0769" y2="716.0769" /><text fill="#000000" font-family="Arial" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="85.9756" x="46" y="708.7751">Data Layer</text></g><g class="entity" data-entity="Web App" data-source-line="6" data-uid="ent0003" id="entity_Web App"><rect fill="#FFFFFF" height="46.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="103.1436" x="365.43" y="46" /><rect fill="#FFFFFF" height="10" style="stroke:#000000;stroke-width:1;" width="15" x="448.5736" y="51" /><rect fill="#FFFFFF" height="2" style="stroke:#000000;stroke-width:1;" width="4" x="446.5736" y="53" /><rect fill="#FFFFFF" height="2" style="stroke:#000000;stroke-width:1;" width="4" x="446.5736" y="57" /><text fill="#000000" font-family="Arial" font-size="14" lengthAdjust="spacing" textLength="63.1436" x="380.43" y="78.9951">Web App</text></g><g class="entity" data-entity="Mobile App" data-source-line="7" data-uid="ent0004" id="entity_Mobile App"><rect fill="#FFFFFF" height="46.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="117.7246" x="213.14" y="46" /><rect fill="#FFFFFF" height="10" style="stroke:#000000;stroke-width:1;" width="15" x="310.8646" y="51" /><rect fill="#FFFFFF" height="2" style="stroke:#000000;stroke-width:1;" width="4" x="308.8646" y="53" /><rect fill="#FFFFFF" height="2" style="stroke:#000000;stroke-width:1;" width="4" x="308.8646" y="57" /><text fill="#000000" font-family="Arial" font-size="14" lengthAdjust="spacing" textLength="77.7246" x="228.14" y="78.9951">Mobile App</text></g><g class="entity" data-entity="Third-party App" data-source-line="8" data-uid="ent0005" id="entity_Third-party App"><rect fill="#FFFFFF" height="46.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="149.8057" x="28.1" y="46" /><rect fill="#FFFFFF" height="10" style="stroke:#000000;stroke-width:1;" width="15" x="157.9057" y="51" /><rect fill="#FFFFFF" height="2" style="stroke:#000000;stroke-width:1;" width="4" x="155.9057" y="53" /><rect fill="#FFFFFF" height="2" style="stroke:#000000;stroke-width:1;" width="4" x="155.9057" y="57" /><text fill="#000000" font-family="Arial" font-size="14" lengthAdjust="spacing" textLength="109.8057" x="43.1" y="78.9951">Third-party App</text></g><g class="entity" data-entity="RL" data-source-line="12" data-uid="ent0007" id="entity_RL"><rect fill="#FFFFFF" height="46.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="125.9346" x="209.03" y="167.3" /><rect fill="#FFFFFF" height="10" style="stroke:#000000;stroke-width:1;" width="15" x="314.9646" y="172.3" /><rect fill="#FFFFFF" height="2" style="stroke:#000000;stroke-width:1;" width="4" x="312.9646" y="174.3" /><rect fill="#FFFFFF" height="2" style="stroke:#000000;stroke-width:1;" width="4" x="312.9646" y="178.3" /><text fill="#000000" font-family="Arial" font-size="14" lengthAdjust="spacing" textLength="85.9346" x="224.03" y="200.2951">Rate Limiter</text></g><g class="entity" data-entity="CORS" data-source-line="13" data-uid="ent0008" id="entity_CORS"><rect fill="#FFFFFF" height="46.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="138.9844" x="202.51" y="273.6" /><rect fill="#FFFFFF" height="10" style="stroke:#000000;stroke-width:1;" width="15" x="321.4944" y="278.6" /><rect fill="#FFFFFF" height="2" style="stroke:#000000;stroke-width:1;" width="4" x="319.4944" y="280.6" /><rect fill="#FFFFFF" height="2" style="stroke:#000000;stroke-width:1;" width="4" x="319.4944" y="284.6" /><text fill="#000000" font-family="Arial" font-size="14" lengthAdjust="spacing" textLength="98.9844" x="217.51" y="306.5951">CORS Handler</text></g><g class="entity" data-entity="Auth" data-source-line="14" data-uid="ent0009" id="entity_Auth"><rect fill="#FFFFFF" height="46.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="142.7715" x="200.61" y="379.89" /><rect fill="#FFFFFF" height="10" style="stroke:#000000;stroke-width:1;" width="15" x="323.3815" y="384.89" /><rect fill="#FFFFFF" height="2" style="stroke:#000000;stroke-width:1;" width="4" x="321.3815" y="386.89" /><rect fill="#FFFFFF" height="2" style="stroke:#000000;stroke-width:1;" width="4" x="321.3815" y="390.89" /><text fill="#000000" font-family="Arial" font-size="14" lengthAdjust="spacing" textLength="102.7715" x="215.61" y="412.8851">Authentication</text></g><g class="entity" data-entity="Validator" data-source-line="15" data-uid="ent0010" id="entity_Validator"><rect fill="#FFFFFF" height="46.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="143.9131" x="200.04" y="486.19" /><rect fill="#FFFFFF" height="10" style="stroke:#000000;stroke-width:1;" width="15" x="323.9531" y="491.19" /><rect fill="#FFFFFF" height="2" style="stroke:#000000;stroke-width:1;" width="4" x="321.9531" y="493.19" /><rect fill="#FFFFFF" height="2" style="stroke:#000000;stroke-width:1;" width="4" x="321.9531" y="497.19" /><text fill="#000000" font-family="Arial" font-size="14" lengthAdjust="spacing" textLength="103.9131" x="215.04" y="519.1851">Input Validator</text></g><g class="entity" data-entity="User Controller" data-source-line="19" data-uid="ent0012" id="entity_User Controller"><rect fill="#FFFFFF" height="46.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="145.5332" x="378.23" y="607.49" /><rect fill="#FFFFFF" height="10" style="stroke:#000000;stroke-width:1;" width="15" x="503.7632" y="612.49" /><rect fill="#FFFFFF" height="2" style="stroke:#000000;stroke-width:1;" width="4" x="501.7632" y="614.49" /><rect fill="#FFFFFF" height="2" style="stroke:#000000;stroke-width:1;" width="4" x="501.7632" y="618.49" /><text fill="#000000" font-family="Arial" font-size="14" lengthAdjust="spacing" textLength="105.5332" x="393.23" y="640.4851">User Controller</text></g><g class="entity" data-entity="Post Controller" data-source-line="20" data-uid="ent0013" id="entity_Post Controller"><rect fill="#FFFFFF" height="46.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="143.4141" x="200.29" y="607.49" /><rect fill="#FFFFFF" height="10" style="stroke:#000000;stroke-width:1;" width="15" x="323.7041" y="612.49" /><rect fill="#FFFFFF" height="2" style="stroke:#000000;stroke-width:1;" width="4" x="321.7041" y="614.49" /><rect fill="#FFFFFF" height="2" style="stroke:#000000;stroke-width:1;" width="4" x="321.7041" y="618.49" /><text fill="#000000" font-family="Arial" font-size="14" lengthAdjust="spacing" textLength="103.4141" x="215.29" y="640.4851">Post Controller</text></g><g class="entity" data-entity="File Controller" data-source-line="21" data-uid="ent0014" id="entity_File Controller"><rect fill="#FFFFFF" height="46.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="138.0684" x="26.97" y="607.49" /><rect fill="#FFFFFF" height="10" style="stroke:#000000;stroke-width:1;" width="15" x="145.0384" y="612.49" /><rect fill="#FFFFFF" height="2" style="stroke:#000000;stroke-width:1;" width="4" x="143.0384" y="614.49" /><rect fill="#FFFFFF" height="2" style="stroke:#000000;stroke-width:1;" width="4" x="143.0384" y="618.49" /><text fill="#000000" font-family="Arial" font-size="14" lengthAdjust="spacing" textLength="98.0684" x="41.97" y="640.4851">File Controller</text></g><g class="entity" data-entity="Session Store" data-source-line="25" data-uid="ent0016" id="entity_Session Store"><rect fill="#FFFFFF" height="46.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="135.1768" x="437.41" y="728.78" /><rect fill="#FFFFFF" height="10" style="stroke:#000000;stroke-width:1;" width="15" x="552.5868" y="733.78" /><rect fill="#FFFFFF" height="2" style="stroke:#000000;stroke-width:1;" width="4" x="550.5868" y="735.78" /><rect fill="#FFFFFF" height="2" style="stroke:#000000;stroke-width:1;" width="4" x="550.5868" y="739.78" /><text fill="#000000" font-family="Arial" font-size="14" lengthAdjust="spacing" textLength="95.1768" x="452.41" y="761.7751">Session Store</text></g><g class="entity" data-entity="User Database" data-source-line="26" data-uid="ent0017" id="entity_User Database"><rect fill="#FFFFFF" height="46.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="143.1611" x="259.42" y="728.78" /><rect fill="#FFFFFF" height="10" style="stroke:#000000;stroke-width:1;" width="15" x="382.5811" y="733.78" /><rect fill="#FFFFFF" height="2" style="stroke:#000000;stroke-width:1;" width="4" x="380.5811" y="735.78" /><rect fill="#FFFFFF" height="2" style="stroke:#000000;stroke-width:1;" width="4" x="380.5811" y="739.78" /><text fill="#000000" font-family="Arial" font-size="14" lengthAdjust="spacing" textLength="103.1611" x="274.42" y="761.7751">User <span class="glossary-term" data-glossary-category="Web Development" data-glossary-definition="An organized collection of structured data stored electronically in a computer system, typically accessed via a database management system." data-glossary-term="Database">Database</span></text></g><g class="entity" data-entity="Content Database" data-source-line="27" data-uid="ent0018" id="entity_Content Database"><rect fill="#FFFFFF" height="46.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="166.9297" x="57.54" y="728.78" /><rect fill="#FFFFFF" height="10" style="stroke:#000000;stroke-width:1;" width="15" x="204.4697" y="733.78" /><rect fill="#FFFFFF" height="2" style="stroke:#000000;stroke-width:1;" width="4" x="202.4697" y="735.78" /><rect fill="#FFFFFF" height="2" style="stroke:#000000;stroke-width:1;" width="4" x="202.4697" y="739.78" /><text fill="#000000" font-family="Arial" font-size="14" lengthAdjust="spacing" textLength="126.9297" x="72.54" y="761.7751">Content <span class="glossary-term" data-glossary-category="Web Development" data-glossary-definition="An organized collection of structured data stored electronically in a computer system, typically accessed via a database management system." data-glossary-term="Database">Database</span></text></g><g class="link" data-entity-1="Web App" data-entity-2="RL" data-source-line="30" data-uid="lnk19" id="link_Web App_RL"><path d="M389.73,92.59 C363.8,113.92 329.6627,141.9971 303.7827,163.2971" fill="none" id="Web App-to-RL" style="stroke:#000000;stroke-width:1;" /><polygon fill="#000000" points="299.15,167.11,308.641,164.4792,303.0106,163.9326,303.5572,158.3022,299.15,167.11" style="stroke:#000000;stroke-width:1;" /></g><g class="link" data-entity-1="Mobile App" data-entity-2="RL" data-source-line="31" data-uid="lnk20" id="link_Mobile App_RL"><path d="M272,92.59 C272,113.92 272,139.81 272,161.11" fill="none" id="Mobile App-to-RL" style="stroke:#000000;stroke-width:1;" /><polygon fill="#000000" points="272,167.11,276,158.11,272,162.11,268,158.11,272,167.11" style="stroke:#000000;stroke-width:1;" /></g><g class="link" data-entity-1="Third-party App" data-entity-2="RL" data-source-line="32" data-uid="lnk21" id="link_Third-party App_RL"><path d="M134.79,92.59 C164.91,113.85 204.9985,142.1495 235.1685,163.4495" fill="none" id="Third-party App-to-RL" style="stroke:#000000;stroke-width:1;" /><polygon fill="#000000" points="240.07,166.91,235.0247,158.4516,235.9854,164.0263,230.4107,164.987,240.07,166.91" style="stroke:#000000;stroke-width:1;" /></g><g class="link" data-entity-1="RL" data-entity-2="CORS" data-source-line="34" data-uid="lnk22" id="link_RL_CORS"><path d="M272,214.08 C272,231.57 272,249.67 272,267.16" fill="none" id="RL-to-CORS" style="stroke:#000000;stroke-width:1;" /><polygon fill="#000000" points="272,273.16,276,264.16,272,268.16,268,264.16,272,273.16" style="stroke:#000000;stroke-width:1;" /></g><g class="link" data-entity-1="CORS" data-entity-2="Auth" data-source-line="35" data-uid="lnk23" id="link_CORS_Auth"><path d="M272,320.37 C272,337.87 272,355.97 272,373.45" fill="none" id="CORS-to-Auth" style="stroke:#000000;stroke-width:1;" /><polygon fill="#000000" points="272,379.45,276,370.45,272,374.45,268,370.45,272,379.45" style="stroke:#000000;stroke-width:1;" /></g><g class="link" data-entity-1="Auth" data-entity-2="Validator" data-source-line="36" data-uid="lnk24" id="link_Auth_Validator"><path d="M272,426.67 C272,444.17 272,462.27 272,479.75" fill="none" id="Auth-to-Validator" style="stroke:#000000;stroke-width:1;" /><polygon fill="#000000" points="272,485.75,276,476.75,272,480.75,268,476.75,272,485.75" style="stroke:#000000;stroke-width:1;" /></g><g class="link" data-entity-1="Validator" data-entity-2="User Controller" data-source-line="37" data-uid="lnk25" id="link_Validator_User Controller"><path d="M310.53,532.86 C326.35,542.35 344.73,553.67 361,564.49 C381.4,578.05 398.8893,590.6177 416.1893,603.4377" fill="none" id="Validator-to-User Controller" style="stroke:#000000;stroke-width:1;" /><polygon fill="#000000" points="421.01,607.01,416.1606,598.4378,416.9928,604.0331,411.3975,604.8653,421.01,607.01" style="stroke:#000000;stroke-width:1;" /></g><g class="link" data-entity-1="Validator" data-entity-2="Post Controller" data-source-line="38" data-uid="lnk26" id="link_Validator_Post Controller"><path d="M272,532.78 C272,554.11 272,580 272,601.3" fill="none" id="Validator-to-Post Controller" style="stroke:#000000;stroke-width:1;" /><polygon fill="#000000" points="272,607.3,276,598.3,272,602.3,268,598.3,272,607.3" style="stroke:#000000;stroke-width:1;" /></g><g class="link" data-entity-1="Validator" data-entity-2="File Controller" data-source-line="39" data-uid="lnk27" id="link_Validator_File Controller"><path d="M233.38,532.73 C217.55,542.2 199.18,553.54 183,564.49 C162.99,578.02 145.9923,590.6372 129.2423,603.5472" fill="none" id="Validator-to-File Controller" style="stroke:#000000;stroke-width:1;" /><polygon fill="#000000" points="124.49,607.21,134.0603,604.884,128.4502,604.1577,129.1765,598.5476,124.49,607.21" style="stroke:#000000;stroke-width:1;" /></g><g class="link" data-entity-1="User Controller" data-entity-2="Session Store" data-source-line="41" data-uid="lnk28" id="link_User Controller_Session Store"><path d="M461.16,654.07 C470.81,675.4 482.7751,701.8342 492.4151,723.1242" fill="none" id="User Controller-to-Session Store" style="stroke:#000000;stroke-width:1;" /><polygon fill="#000000" points="494.89,728.59,494.8215,718.7414,492.8276,724.0352,487.5338,722.0412,494.89,728.59" style="stroke:#000000;stroke-width:1;" /></g><g class="link" data-entity-1="User Controller" data-entity-2="User Database" data-source-line="42" data-uid="lnk29" id="link_User Controller_User Database"><path d="M428.43,654.07 C406.97,675.4 379.1455,703.0703 357.7255,724.3603" fill="none" id="User Controller-to-User Database" style="stroke:#000000;stroke-width:1;" /><polygon fill="#000000" points="353.47,728.59,362.6731,725.0825,357.0163,725.0652,357.0335,719.4084,353.47,728.59" style="stroke:#000000;stroke-width:1;" /></g><g class="link" data-entity-1="Post Controller" data-entity-2="Content Database" data-source-line="43" data-uid="lnk30" id="link_Post Controller_Content Database"><path d="M247.36,654.07 C223.94,675.4 193.3463,703.2603 169.9663,724.5503" fill="none" id="Post Controller-to-Content Database" style="stroke:#000000;stroke-width:1;" /><polygon fill="#000000" points="165.53,728.59,174.8776,725.4879,169.2269,725.2236,169.4913,719.5729,165.53,728.59" style="stroke:#000000;stroke-width:1;" /></g><g class="link" data-entity-1="File Controller" data-entity-2="Content Database" data-source-line="44" data-uid="lnk31" id="link_File Controller_Content Database"><path d="M104.46,654.07 C112.51,675.4 122.4226,701.686 130.4526,722.976" fill="none" id="File Controller-to-Content Database" style="stroke:#000000;stroke-width:1;" /><polygon fill="#000000" points="132.57,728.59,133.1365,718.7574,130.8055,723.9117,125.6512,721.5807,132.57,728.59" style="stroke:#000000;stroke-width:1;" /></g></g></svg></p></div></div>
<h3 id="complete-secure-api-implementation">Complete Secure <span class="glossary-term" data-glossary-category="Web Development" data-glossary-definition="A set of protocols and tools for building software applications, defining how components interact." data-glossary-full-form="Application Programming Interface" data-glossary-term="API">API</span> Implementation<a class="headerlink" href="#complete-secure-api-implementation" title="Permanent link">&para;</a></h3>
<div class="language-python highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">jsonify</span><span class="p">,</span> <span class="n">g</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">werkzeug.security</span><span class="w"> </span><span class="kn">import</span> <span class="n">generate_password_hash</span><span class="p">,</span> <span class="n">check_password_hash</span>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">wraps</span>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">sqlite3</span>
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">secrets</span>
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
</span><span id="__span-7-7"><a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a><span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
</span><span id="__span-7-8"><a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a><span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
</span><span id="__span-7-9"><a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
</span><span id="__span-7-10"><a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">List</span>
</span><span id="__span-7-11"><a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a>
</span><span id="__span-7-12"><a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a><span class="c1"># Import our security components</span>
</span><span id="__span-7-13"><a id="__codelineno-7-13" name="__codelineno-7-13" href="#__codelineno-7-13"></a><span class="c1"># (In a real application, these would be in separate modules)</span>
</span><span id="__span-7-14"><a id="__codelineno-7-14" name="__codelineno-7-14" href="#__codelineno-7-14"></a>
</span><span id="__span-7-15"><a id="__codelineno-7-15" name="__codelineno-7-15" href="#__codelineno-7-15"></a><span class="k">class</span><span class="w"> </span><span class="nc">SecureTaskAPI</span><span class="p">:</span>
</span><span id="__span-7-16"><a id="__codelineno-7-16" name="__codelineno-7-16" href="#__codelineno-7-16"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Complete secure REST API for task management&quot;&quot;&quot;</span>
</span><span id="__span-7-17"><a id="__codelineno-7-17" name="__codelineno-7-17" href="#__codelineno-7-17"></a>
</span><span id="__span-7-18"><a id="__codelineno-7-18" name="__codelineno-7-18" href="#__codelineno-7-18"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-7-19"><a id="__codelineno-7-19" name="__codelineno-7-19" href="#__codelineno-7-19"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
</span><span id="__span-7-20"><a id="__codelineno-7-20" name="__codelineno-7-20" href="#__codelineno-7-20"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;SECRET_KEY&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">secrets</span><span class="o">.</span><span class="n">token_urlsafe</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>
</span><span id="__span-7-21"><a id="__codelineno-7-21" name="__codelineno-7-21" href="#__codelineno-7-21"></a>
</span><span id="__span-7-22"><a id="__codelineno-7-22" name="__codelineno-7-22" href="#__codelineno-7-22"></a>        <span class="c1"># Initialize security components</span>
</span><span id="__span-7-23"><a id="__codelineno-7-23" name="__codelineno-7-23" href="#__codelineno-7-23"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">jwt_manager</span> <span class="o">=</span> <span class="n">JWTManager</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;SECRET_KEY&#39;</span><span class="p">])</span>
</span><span id="__span-7-24"><a id="__codelineno-7-24" name="__codelineno-7-24" href="#__codelineno-7-24"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">rate_limiter</span> <span class="o">=</span> <span class="n">RateLimiter</span><span class="p">()</span>
</span><span id="__span-7-25"><a id="__codelineno-7-25" name="__codelineno-7-25" href="#__codelineno-7-25"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cors_manager</span> <span class="o">=</span> <span class="n">CORSManager</span><span class="p">()</span>
</span><span id="__span-7-26"><a id="__codelineno-7-26" name="__codelineno-7-26" href="#__codelineno-7-26"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">session_manager</span> <span class="o">=</span> <span class="n">SecureSessionManager</span><span class="p">()</span>
</span><span id="__span-7-27"><a id="__codelineno-7-27" name="__codelineno-7-27" href="#__codelineno-7-27"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">security_tester</span> <span class="o">=</span> <span class="n">APISecurityTester</span><span class="p">(</span><span class="s2">&quot;http://localhost:5000&quot;</span><span class="p">)</span>
</span><span id="__span-7-28"><a id="__codelineno-7-28" name="__codelineno-7-28" href="#__codelineno-7-28"></a>
</span><span id="__span-7-29"><a id="__codelineno-7-29" name="__codelineno-7-29" href="#__codelineno-7-29"></a>        <span class="c1"># Setup database</span>
</span><span id="__span-7-30"><a id="__codelineno-7-30" name="__codelineno-7-30" href="#__codelineno-7-30"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">init_database</span><span class="p">()</span>
</span><span id="__span-7-31"><a id="__codelineno-7-31" name="__codelineno-7-31" href="#__codelineno-7-31"></a>
</span><span id="__span-7-32"><a id="__codelineno-7-32" name="__codelineno-7-32" href="#__codelineno-7-32"></a>        <span class="c1"># Configure CORS policies</span>
</span><span id="__span-7-33"><a id="__codelineno-7-33" name="__codelineno-7-33" href="#__codelineno-7-33"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">setup_cors_policies</span><span class="p">()</span>
</span><span id="__span-7-34"><a id="__codelineno-7-34" name="__codelineno-7-34" href="#__codelineno-7-34"></a>
</span><span id="__span-7-35"><a id="__codelineno-7-35" name="__codelineno-7-35" href="#__codelineno-7-35"></a>        <span class="c1"># Setup rate limiting</span>
</span><span id="__span-7-36"><a id="__codelineno-7-36" name="__codelineno-7-36" href="#__codelineno-7-36"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">setup_rate_limiting</span><span class="p">()</span>
</span><span id="__span-7-37"><a id="__codelineno-7-37" name="__codelineno-7-37" href="#__codelineno-7-37"></a>
</span><span id="__span-7-38"><a id="__codelineno-7-38" name="__codelineno-7-38" href="#__codelineno-7-38"></a>        <span class="c1"># Register routes</span>
</span><span id="__span-7-39"><a id="__codelineno-7-39" name="__codelineno-7-39" href="#__codelineno-7-39"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">register_routes</span><span class="p">()</span>
</span><span id="__span-7-40"><a id="__codelineno-7-40" name="__codelineno-7-40" href="#__codelineno-7-40"></a>
</span><span id="__span-7-41"><a id="__codelineno-7-41" name="__codelineno-7-41" href="#__codelineno-7-41"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">init_database</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-7-42"><a id="__codelineno-7-42" name="__codelineno-7-42" href="#__codelineno-7-42"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize SQLite database with secure schema&quot;&quot;&quot;</span>
</span><span id="__span-7-43"><a id="__codelineno-7-43" name="__codelineno-7-43" href="#__codelineno-7-43"></a>        <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;secure_tasks.db&#39;</span><span class="p">)</span>
</span><span id="__span-7-44"><a id="__codelineno-7-44" name="__codelineno-7-44" href="#__codelineno-7-44"></a>        <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
</span><span id="__span-7-45"><a id="__codelineno-7-45" name="__codelineno-7-45" href="#__codelineno-7-45"></a>
</span><span id="__span-7-46"><a id="__codelineno-7-46" name="__codelineno-7-46" href="#__codelineno-7-46"></a>        <span class="c1"># Users table with security features</span>
</span><span id="__span-7-47"><a id="__codelineno-7-47" name="__codelineno-7-47" href="#__codelineno-7-47"></a>        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;</span>
</span><span id="__span-7-48"><a id="__codelineno-7-48" name="__codelineno-7-48" href="#__codelineno-7-48"></a><span class="s1">            CREATE TABLE IF NOT EXISTS users (</span>
</span><span id="__span-7-49"><a id="__codelineno-7-49" name="__codelineno-7-49" href="#__codelineno-7-49"></a><span class="s1">                id INTEGER PRIMARY KEY AUTOINCREMENT,</span>
</span><span id="__span-7-50"><a id="__codelineno-7-50" name="__codelineno-7-50" href="#__codelineno-7-50"></a><span class="s1">                username TEXT UNIQUE NOT NULL,</span>
</span><span id="__span-7-51"><a id="__codelineno-7-51" name="__codelineno-7-51" href="#__codelineno-7-51"></a><span class="s1">                email TEXT UNIQUE NOT NULL,</span>
</span><span id="__span-7-52"><a id="__codelineno-7-52" name="__codelineno-7-52" href="#__codelineno-7-52"></a><span class="s1">                password_hash TEXT NOT NULL,</span>
</span><span id="__span-7-53"><a id="__codelineno-7-53" name="__codelineno-7-53" href="#__codelineno-7-53"></a><span class="s1">                salt TEXT NOT NULL,</span>
</span><span id="__span-7-54"><a id="__codelineno-7-54" name="__codelineno-7-54" href="#__codelineno-7-54"></a><span class="s1">                is_active BOOLEAN DEFAULT 1,</span>
</span><span id="__span-7-55"><a id="__codelineno-7-55" name="__codelineno-7-55" href="#__codelineno-7-55"></a><span class="s1">                failed_login_attempts INTEGER DEFAULT 0,</span>
</span><span id="__span-7-56"><a id="__codelineno-7-56" name="__codelineno-7-56" href="#__codelineno-7-56"></a><span class="s1">                last_failed_login TIMESTAMP,</span>
</span><span id="__span-7-57"><a id="__codelineno-7-57" name="__codelineno-7-57" href="#__codelineno-7-57"></a><span class="s1">                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,</span>
</span><span id="__span-7-58"><a id="__codelineno-7-58" name="__codelineno-7-58" href="#__codelineno-7-58"></a><span class="s1">                updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP</span>
</span><span id="__span-7-59"><a id="__codelineno-7-59" name="__codelineno-7-59" href="#__codelineno-7-59"></a><span class="s1">            )</span>
</span><span id="__span-7-60"><a id="__codelineno-7-60" name="__codelineno-7-60" href="#__codelineno-7-60"></a><span class="s1">        &#39;&#39;&#39;</span><span class="p">)</span>
</span><span id="__span-7-61"><a id="__codelineno-7-61" name="__codelineno-7-61" href="#__codelineno-7-61"></a>
</span><span id="__span-7-62"><a id="__codelineno-7-62" name="__codelineno-7-62" href="#__codelineno-7-62"></a>        <span class="c1"># Tasks table</span>
</span><span id="__span-7-63"><a id="__codelineno-7-63" name="__codelineno-7-63" href="#__codelineno-7-63"></a>        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;</span>
</span><span id="__span-7-64"><a id="__codelineno-7-64" name="__codelineno-7-64" href="#__codelineno-7-64"></a><span class="s1">            CREATE TABLE IF NOT EXISTS tasks (</span>
</span><span id="__span-7-65"><a id="__codelineno-7-65" name="__codelineno-7-65" href="#__codelineno-7-65"></a><span class="s1">                id INTEGER PRIMARY KEY AUTOINCREMENT,</span>
</span><span id="__span-7-66"><a id="__codelineno-7-66" name="__codelineno-7-66" href="#__codelineno-7-66"></a><span class="s1">                user_id INTEGER NOT NULL,</span>
</span><span id="__span-7-67"><a id="__codelineno-7-67" name="__codelineno-7-67" href="#__codelineno-7-67"></a><span class="s1">                title TEXT NOT NULL,</span>
</span><span id="__span-7-68"><a id="__codelineno-7-68" name="__codelineno-7-68" href="#__codelineno-7-68"></a><span class="s1">                description TEXT,</span>
</span><span id="__span-7-69"><a id="__codelineno-7-69" name="__codelineno-7-69" href="#__codelineno-7-69"></a><span class="s1">                status TEXT DEFAULT &#39;pending&#39;,</span>
</span><span id="__span-7-70"><a id="__codelineno-7-70" name="__codelineno-7-70" href="#__codelineno-7-70"></a><span class="s1">                priority INTEGER DEFAULT 1,</span>
</span><span id="__span-7-71"><a id="__codelineno-7-71" name="__codelineno-7-71" href="#__codelineno-7-71"></a><span class="s1">                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,</span>
</span><span id="__span-7-72"><a id="__codelineno-7-72" name="__codelineno-7-72" href="#__codelineno-7-72"></a><span class="s1">                updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,</span>
</span><span id="__span-7-73"><a id="__codelineno-7-73" name="__codelineno-7-73" href="#__codelineno-7-73"></a><span class="s1">                FOREIGN KEY (user_id) REFERENCES users (id)</span>
</span><span id="__span-7-74"><a id="__codelineno-7-74" name="__codelineno-7-74" href="#__codelineno-7-74"></a><span class="s1">            )</span>
</span><span id="__span-7-75"><a id="__codelineno-7-75" name="__codelineno-7-75" href="#__codelineno-7-75"></a><span class="s1">        &#39;&#39;&#39;</span><span class="p">)</span>
</span><span id="__span-7-76"><a id="__codelineno-7-76" name="__codelineno-7-76" href="#__codelineno-7-76"></a>
</span><span id="__span-7-77"><a id="__codelineno-7-77" name="__codelineno-7-77" href="#__codelineno-7-77"></a>        <span class="c1"># API keys table</span>
</span><span id="__span-7-78"><a id="__codelineno-7-78" name="__codelineno-7-78" href="#__codelineno-7-78"></a>        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;</span>
</span><span id="__span-7-79"><a id="__codelineno-7-79" name="__codelineno-7-79" href="#__codelineno-7-79"></a><span class="s1">            CREATE TABLE IF NOT EXISTS api_keys (</span>
</span><span id="__span-7-80"><a id="__codelineno-7-80" name="__codelineno-7-80" href="#__codelineno-7-80"></a><span class="s1">                id INTEGER PRIMARY KEY AUTOINCREMENT,</span>
</span><span id="__span-7-81"><a id="__codelineno-7-81" name="__codelineno-7-81" href="#__codelineno-7-81"></a><span class="s1">                key_id TEXT UNIQUE NOT NULL,</span>
</span><span id="__span-7-82"><a id="__codelineno-7-82" name="__codelineno-7-82" href="#__codelineno-7-82"></a><span class="s1">                key_hash TEXT NOT NULL,</span>
</span><span id="__span-7-83"><a id="__codelineno-7-83" name="__codelineno-7-83" href="#__codelineno-7-83"></a><span class="s1">                user_id INTEGER NOT NULL,</span>
</span><span id="__span-7-84"><a id="__codelineno-7-84" name="__codelineno-7-84" href="#__codelineno-7-84"></a><span class="s1">                name TEXT NOT NULL,</span>
</span><span id="__span-7-85"><a id="__codelineno-7-85" name="__codelineno-7-85" href="#__codelineno-7-85"></a><span class="s1">                permissions TEXT NOT NULL,</span>
</span><span id="__span-7-86"><a id="__codelineno-7-86" name="__codelineno-7-86" href="#__codelineno-7-86"></a><span class="s1">                is_active BOOLEAN DEFAULT 1,</span>
</span><span id="__span-7-87"><a id="__codelineno-7-87" name="__codelineno-7-87" href="#__codelineno-7-87"></a><span class="s1">                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,</span>
</span><span id="__span-7-88"><a id="__codelineno-7-88" name="__codelineno-7-88" href="#__codelineno-7-88"></a><span class="s1">                expires_at TIMESTAMP,</span>
</span><span id="__span-7-89"><a id="__codelineno-7-89" name="__codelineno-7-89" href="#__codelineno-7-89"></a><span class="s1">                FOREIGN KEY (user_id) REFERENCES users (id)</span>
</span><span id="__span-7-90"><a id="__codelineno-7-90" name="__codelineno-7-90" href="#__codelineno-7-90"></a><span class="s1">            )</span>
</span><span id="__span-7-91"><a id="__codelineno-7-91" name="__codelineno-7-91" href="#__codelineno-7-91"></a><span class="s1">        &#39;&#39;&#39;</span><span class="p">)</span>
</span><span id="__span-7-92"><a id="__codelineno-7-92" name="__codelineno-7-92" href="#__codelineno-7-92"></a>
</span><span id="__span-7-93"><a id="__codelineno-7-93" name="__codelineno-7-93" href="#__codelineno-7-93"></a>        <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span><span id="__span-7-94"><a id="__codelineno-7-94" name="__codelineno-7-94" href="#__codelineno-7-94"></a>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="__span-7-95"><a id="__codelineno-7-95" name="__codelineno-7-95" href="#__codelineno-7-95"></a>
</span><span id="__span-7-96"><a id="__codelineno-7-96" name="__codelineno-7-96" href="#__codelineno-7-96"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">setup_cors_policies</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-7-97"><a id="__codelineno-7-97" name="__codelineno-7-97" href="#__codelineno-7-97"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Configure CORS policies for different environments&quot;&quot;&quot;</span>
</span><span id="__span-7-98"><a id="__codelineno-7-98" name="__codelineno-7-98" href="#__codelineno-7-98"></a>
</span><span id="__span-7-99"><a id="__codelineno-7-99" name="__codelineno-7-99" href="#__codelineno-7-99"></a>        <span class="c1"># Development policy</span>
</span><span id="__span-7-100"><a id="__codelineno-7-100" name="__codelineno-7-100" href="#__codelineno-7-100"></a>        <span class="n">dev_policy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cors_manager</span><span class="o">.</span><span class="n">create_secure_policy</span><span class="p">(</span>
</span><span id="__span-7-101"><a id="__codelineno-7-101" name="__codelineno-7-101" href="#__codelineno-7-101"></a>            <span class="n">allowed_origins</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;http://localhost:3000&#39;</span><span class="p">,</span> <span class="s1">&#39;http://127.0.0.1:3000&#39;</span><span class="p">],</span>
</span><span id="__span-7-102"><a id="__codelineno-7-102" name="__codelineno-7-102" href="#__codelineno-7-102"></a>            <span class="n">allow_credentials</span><span class="o">=</span><span class="kc">True</span>
</span><span id="__span-7-103"><a id="__codelineno-7-103" name="__codelineno-7-103" href="#__codelineno-7-103"></a>        <span class="p">)</span>
</span><span id="__span-7-104"><a id="__codelineno-7-104" name="__codelineno-7-104" href="#__codelineno-7-104"></a>
</span><span id="__span-7-105"><a id="__codelineno-7-105" name="__codelineno-7-105" href="#__codelineno-7-105"></a>        <span class="c1"># Production policy</span>
</span><span id="__span-7-106"><a id="__codelineno-7-106" name="__codelineno-7-106" href="#__codelineno-7-106"></a>        <span class="n">prod_policy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cors_manager</span><span class="o">.</span><span class="n">create_secure_policy</span><span class="p">(</span>
</span><span id="__span-7-107"><a id="__codelineno-7-107" name="__codelineno-7-107" href="#__codelineno-7-107"></a>            <span class="n">allowed_origins</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;https://taskapp.com&#39;</span><span class="p">,</span> <span class="s1">&#39;https://api.taskapp.com&#39;</span><span class="p">],</span>
</span><span id="__span-7-108"><a id="__codelineno-7-108" name="__codelineno-7-108" href="#__codelineno-7-108"></a>            <span class="n">allow_credentials</span><span class="o">=</span><span class="kc">True</span>
</span><span id="__span-7-109"><a id="__codelineno-7-109" name="__codelineno-7-109" href="#__codelineno-7-109"></a>        <span class="p">)</span>
</span><span id="__span-7-110"><a id="__codelineno-7-110" name="__codelineno-7-110" href="#__codelineno-7-110"></a>
</span><span id="__span-7-111"><a id="__codelineno-7-111" name="__codelineno-7-111" href="#__codelineno-7-111"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cors_manager</span><span class="o">.</span><span class="n">add_policy</span><span class="p">(</span><span class="s1">&#39;development&#39;</span><span class="p">,</span> <span class="n">dev_policy</span><span class="p">)</span>
</span><span id="__span-7-112"><a id="__codelineno-7-112" name="__codelineno-7-112" href="#__codelineno-7-112"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cors_manager</span><span class="o">.</span><span class="n">add_policy</span><span class="p">(</span><span class="s1">&#39;production&#39;</span><span class="p">,</span> <span class="n">prod_policy</span><span class="p">)</span>
</span><span id="__span-7-113"><a id="__codelineno-7-113" name="__codelineno-7-113" href="#__codelineno-7-113"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cors_manager</span><span class="o">.</span><span class="n">set_default_policy</span><span class="p">(</span><span class="n">dev_policy</span><span class="p">)</span>  <span class="c1"># Use dev for demo</span>
</span><span id="__span-7-114"><a id="__codelineno-7-114" name="__codelineno-7-114" href="#__codelineno-7-114"></a>
</span><span id="__span-7-115"><a id="__codelineno-7-115" name="__codelineno-7-115" href="#__codelineno-7-115"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">setup_rate_limiting</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-7-116"><a id="__codelineno-7-116" name="__codelineno-7-116" href="#__codelineno-7-116"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Configure rate limiting for different endpoints&quot;&quot;&quot;</span>
</span><span id="__span-7-117"><a id="__codelineno-7-117" name="__codelineno-7-117" href="#__codelineno-7-117"></a>
</span><span id="__span-7-118"><a id="__codelineno-7-118" name="__codelineno-7-118" href="#__codelineno-7-118"></a>        <span class="c1"># Different limits for different endpoint types</span>
</span><span id="__span-7-119"><a id="__codelineno-7-119" name="__codelineno-7-119" href="#__codelineno-7-119"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">rate_limiter</span><span class="o">.</span><span class="n">create_rate_limit</span><span class="p">(</span><span class="s1">&#39;auth_endpoint&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>      <span class="c1"># 5 req/sec, burst 50</span>
</span><span id="__span-7-120"><a id="__codelineno-7-120" name="__codelineno-7-120" href="#__codelineno-7-120"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">rate_limiter</span><span class="o">.</span><span class="n">create_rate_limit</span><span class="p">(</span><span class="s1">&#39;api_endpoint&#39;</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">500</span><span class="p">)</span>     <span class="c1"># 50 req/sec, burst 500</span>
</span><span id="__span-7-121"><a id="__codelineno-7-121" name="__codelineno-7-121" href="#__codelineno-7-121"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">rate_limiter</span><span class="o">.</span><span class="n">create_rate_limit</span><span class="p">(</span><span class="s1">&#39;public_endpoint&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>  <span class="c1"># 10 req/sec, burst 100</span>
</span><span id="__span-7-122"><a id="__codelineno-7-122" name="__codelineno-7-122" href="#__codelineno-7-122"></a>
</span><span id="__span-7-123"><a id="__codelineno-7-123" name="__codelineno-7-123" href="#__codelineno-7-123"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_db_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-7-124"><a id="__codelineno-7-124" name="__codelineno-7-124" href="#__codelineno-7-124"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get database connection with security considerations&quot;&quot;&quot;</span>
</span><span id="__span-7-125"><a id="__codelineno-7-125" name="__codelineno-7-125" href="#__codelineno-7-125"></a>        <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;secure_tasks.db&#39;</span><span class="p">)</span>
</span><span id="__span-7-126"><a id="__codelineno-7-126" name="__codelineno-7-126" href="#__codelineno-7-126"></a>        <span class="n">conn</span><span class="o">.</span><span class="n">row_factory</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">Row</span>  <span class="c1"># Enable column access by name</span>
</span><span id="__span-7-127"><a id="__codelineno-7-127" name="__codelineno-7-127" href="#__codelineno-7-127"></a>
</span><span id="__span-7-128"><a id="__codelineno-7-128" name="__codelineno-7-128" href="#__codelineno-7-128"></a>        <span class="c1"># Enable foreign key constraints</span>
</span><span id="__span-7-129"><a id="__codelineno-7-129" name="__codelineno-7-129" href="#__codelineno-7-129"></a>        <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;PRAGMA foreign_keys = ON&#39;</span><span class="p">)</span>
</span><span id="__span-7-130"><a id="__codelineno-7-130" name="__codelineno-7-130" href="#__codelineno-7-130"></a>
</span><span id="__span-7-131"><a id="__codelineno-7-131" name="__codelineno-7-131" href="#__codelineno-7-131"></a>        <span class="k">return</span> <span class="n">conn</span>
</span><span id="__span-7-132"><a id="__codelineno-7-132" name="__codelineno-7-132" href="#__codelineno-7-132"></a>
</span><span id="__span-7-133"><a id="__codelineno-7-133" name="__codelineno-7-133" href="#__codelineno-7-133"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">validate_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">rules</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
</span><span id="__span-7-134"><a id="__codelineno-7-134" name="__codelineno-7-134" href="#__codelineno-7-134"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Comprehensive input validation&quot;&quot;&quot;</span>
</span><span id="__span-7-135"><a id="__codelineno-7-135" name="__codelineno-7-135" href="#__codelineno-7-135"></a>        <span class="n">errors</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="__span-7-136"><a id="__codelineno-7-136" name="__codelineno-7-136" href="#__codelineno-7-136"></a>
</span><span id="__span-7-137"><a id="__codelineno-7-137" name="__codelineno-7-137" href="#__codelineno-7-137"></a>        <span class="k">for</span> <span class="n">field</span><span class="p">,</span> <span class="n">rule</span> <span class="ow">in</span> <span class="n">rules</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="__span-7-138"><a id="__codelineno-7-138" name="__codelineno-7-138" href="#__codelineno-7-138"></a>            <span class="n">value</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
</span><span id="__span-7-139"><a id="__codelineno-7-139" name="__codelineno-7-139" href="#__codelineno-7-139"></a>
</span><span id="__span-7-140"><a id="__codelineno-7-140" name="__codelineno-7-140" href="#__codelineno-7-140"></a>            <span class="c1"># Required field check</span>
</span><span id="__span-7-141"><a id="__codelineno-7-141" name="__codelineno-7-141" href="#__codelineno-7-141"></a>            <span class="k">if</span> <span class="n">rule</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;required&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
</span><span id="__span-7-142"><a id="__codelineno-7-142" name="__codelineno-7-142" href="#__codelineno-7-142"></a>                <span class="n">errors</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s2"> is required&quot;</span>
</span><span id="__span-7-143"><a id="__codelineno-7-143" name="__codelineno-7-143" href="#__codelineno-7-143"></a>                <span class="k">continue</span>
</span><span id="__span-7-144"><a id="__codelineno-7-144" name="__codelineno-7-144" href="#__codelineno-7-144"></a>
</span><span id="__span-7-145"><a id="__codelineno-7-145" name="__codelineno-7-145" href="#__codelineno-7-145"></a>            <span class="c1"># Type validation</span>
</span><span id="__span-7-146"><a id="__codelineno-7-146" name="__codelineno-7-146" href="#__codelineno-7-146"></a>            <span class="n">expected_type</span> <span class="o">=</span> <span class="n">rule</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
</span><span id="__span-7-147"><a id="__codelineno-7-147" name="__codelineno-7-147" href="#__codelineno-7-147"></a>            <span class="k">if</span> <span class="n">value</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">expected_type</span><span class="p">):</span>
</span><span id="__span-7-148"><a id="__codelineno-7-148" name="__codelineno-7-148" href="#__codelineno-7-148"></a>                <span class="n">errors</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s2"> must be of type </span><span class="si">{</span><span class="n">expected_type</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="__span-7-149"><a id="__codelineno-7-149" name="__codelineno-7-149" href="#__codelineno-7-149"></a>                <span class="k">continue</span>
</span><span id="__span-7-150"><a id="__codelineno-7-150" name="__codelineno-7-150" href="#__codelineno-7-150"></a>
</span><span id="__span-7-151"><a id="__codelineno-7-151" name="__codelineno-7-151" href="#__codelineno-7-151"></a>            <span class="c1"># Length validation</span>
</span><span id="__span-7-152"><a id="__codelineno-7-152" name="__codelineno-7-152" href="#__codelineno-7-152"></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="__span-7-153"><a id="__codelineno-7-153" name="__codelineno-7-153" href="#__codelineno-7-153"></a>                <span class="n">min_length</span> <span class="o">=</span> <span class="n">rule</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;min_length&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="__span-7-154"><a id="__codelineno-7-154" name="__codelineno-7-154" href="#__codelineno-7-154"></a>                <span class="n">max_length</span> <span class="o">=</span> <span class="n">rule</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max_length&#39;</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">))</span>
</span><span id="__span-7-155"><a id="__codelineno-7-155" name="__codelineno-7-155" href="#__codelineno-7-155"></a>
</span><span id="__span-7-156"><a id="__codelineno-7-156" name="__codelineno-7-156" href="#__codelineno-7-156"></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">min_length</span><span class="p">:</span>
</span><span id="__span-7-157"><a id="__codelineno-7-157" name="__codelineno-7-157" href="#__codelineno-7-157"></a>                    <span class="n">errors</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s2"> must be at least </span><span class="si">{</span><span class="n">min_length</span><span class="si">}</span><span class="s2"> characters&quot;</span>
</span><span id="__span-7-158"><a id="__codelineno-7-158" name="__codelineno-7-158" href="#__codelineno-7-158"></a>                    <span class="k">continue</span>
</span><span id="__span-7-159"><a id="__codelineno-7-159" name="__codelineno-7-159" href="#__codelineno-7-159"></a>
</span><span id="__span-7-160"><a id="__codelineno-7-160" name="__codelineno-7-160" href="#__codelineno-7-160"></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_length</span><span class="p">:</span>
</span><span id="__span-7-161"><a id="__codelineno-7-161" name="__codelineno-7-161" href="#__codelineno-7-161"></a>                    <span class="n">errors</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s2"> must be at most </span><span class="si">{</span><span class="n">max_length</span><span class="si">}</span><span class="s2"> characters&quot;</span>
</span><span id="__span-7-162"><a id="__codelineno-7-162" name="__codelineno-7-162" href="#__codelineno-7-162"></a>                    <span class="k">continue</span>
</span><span id="__span-7-163"><a id="__codelineno-7-163" name="__codelineno-7-163" href="#__codelineno-7-163"></a>
</span><span id="__span-7-164"><a id="__codelineno-7-164" name="__codelineno-7-164" href="#__codelineno-7-164"></a>            <span class="c1"># Pattern validation (regex)</span>
</span><span id="__span-7-165"><a id="__codelineno-7-165" name="__codelineno-7-165" href="#__codelineno-7-165"></a>            <span class="n">pattern</span> <span class="o">=</span> <span class="n">rule</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pattern&#39;</span><span class="p">)</span>
</span><span id="__span-7-166"><a id="__codelineno-7-166" name="__codelineno-7-166" href="#__codelineno-7-166"></a>            <span class="k">if</span> <span class="n">pattern</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="__span-7-167"><a id="__codelineno-7-167" name="__codelineno-7-167" href="#__codelineno-7-167"></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
</span><span id="__span-7-168"><a id="__codelineno-7-168" name="__codelineno-7-168" href="#__codelineno-7-168"></a>                    <span class="n">errors</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s2"> format is invalid&quot;</span>
</span><span id="__span-7-169"><a id="__codelineno-7-169" name="__codelineno-7-169" href="#__codelineno-7-169"></a>                    <span class="k">continue</span>
</span><span id="__span-7-170"><a id="__codelineno-7-170" name="__codelineno-7-170" href="#__codelineno-7-170"></a>
</span><span id="__span-7-171"><a id="__codelineno-7-171" name="__codelineno-7-171" href="#__codelineno-7-171"></a>            <span class="c1"># Custom validation function</span>
</span><span id="__span-7-172"><a id="__codelineno-7-172" name="__codelineno-7-172" href="#__codelineno-7-172"></a>            <span class="n">validator</span> <span class="o">=</span> <span class="n">rule</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;validator&#39;</span><span class="p">)</span>
</span><span id="__span-7-173"><a id="__codelineno-7-173" name="__codelineno-7-173" href="#__codelineno-7-173"></a>            <span class="k">if</span> <span class="n">validator</span> <span class="ow">and</span> <span class="nb">callable</span><span class="p">(</span><span class="n">validator</span><span class="p">):</span>
</span><span id="__span-7-174"><a id="__codelineno-7-174" name="__codelineno-7-174" href="#__codelineno-7-174"></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">validator</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
</span><span id="__span-7-175"><a id="__codelineno-7-175" name="__codelineno-7-175" href="#__codelineno-7-175"></a>                    <span class="n">errors</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s2"> validation failed&quot;</span>
</span><span id="__span-7-176"><a id="__codelineno-7-176" name="__codelineno-7-176" href="#__codelineno-7-176"></a>
</span><span id="__span-7-177"><a id="__codelineno-7-177" name="__codelineno-7-177" href="#__codelineno-7-177"></a>        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">errors</span>
</span><span id="__span-7-178"><a id="__codelineno-7-178" name="__codelineno-7-178" href="#__codelineno-7-178"></a>
</span><span id="__span-7-179"><a id="__codelineno-7-179" name="__codelineno-7-179" href="#__codelineno-7-179"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">sanitize_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="__span-7-180"><a id="__codelineno-7-180" name="__codelineno-7-180" href="#__codelineno-7-180"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Sanitize input data to prevent injection attacks&quot;&quot;&quot;</span>
</span><span id="__span-7-181"><a id="__codelineno-7-181" name="__codelineno-7-181" href="#__codelineno-7-181"></a>        <span class="n">sanitized</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="__span-7-182"><a id="__codelineno-7-182" name="__codelineno-7-182" href="#__codelineno-7-182"></a>
</span><span id="__span-7-183"><a id="__codelineno-7-183" name="__codelineno-7-183" href="#__codelineno-7-183"></a>        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="__span-7-184"><a id="__codelineno-7-184" name="__codelineno-7-184" href="#__codelineno-7-184"></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="__span-7-185"><a id="__codelineno-7-185" name="__codelineno-7-185" href="#__codelineno-7-185"></a>                <span class="c1"># Remove potential SQL injection characters</span>
</span><span id="__span-7-186"><a id="__codelineno-7-186" name="__codelineno-7-186" href="#__codelineno-7-186"></a>                <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;&#39;&#39;&quot;</span><span class="p">)</span>  <span class="c1"># Escape single quotes</span>
</span><span id="__span-7-187"><a id="__codelineno-7-187" name="__codelineno-7-187" href="#__codelineno-7-187"></a>                <span class="n">value</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[&lt;&gt;&quot;</span><span class="se">\&#39;</span><span class="s1">]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>  <span class="c1"># Remove XSS characters</span>
</span><span id="__span-7-188"><a id="__codelineno-7-188" name="__codelineno-7-188" href="#__codelineno-7-188"></a>
</span><span id="__span-7-189"><a id="__codelineno-7-189" name="__codelineno-7-189" href="#__codelineno-7-189"></a>                <span class="c1"># Limit length to prevent buffer overflow</span>
</span><span id="__span-7-190"><a id="__codelineno-7-190" name="__codelineno-7-190" href="#__codelineno-7-190"></a>                <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">[:</span><span class="mi">1000</span><span class="p">]</span>
</span><span id="__span-7-191"><a id="__codelineno-7-191" name="__codelineno-7-191" href="#__codelineno-7-191"></a>
</span><span id="__span-7-192"><a id="__codelineno-7-192" name="__codelineno-7-192" href="#__codelineno-7-192"></a>                <span class="n">sanitized</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span><span id="__span-7-193"><a id="__codelineno-7-193" name="__codelineno-7-193" href="#__codelineno-7-193"></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="__span-7-194"><a id="__codelineno-7-194" name="__codelineno-7-194" href="#__codelineno-7-194"></a>                <span class="n">sanitized</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
</span><span id="__span-7-195"><a id="__codelineno-7-195" name="__codelineno-7-195" href="#__codelineno-7-195"></a>
</span><span id="__span-7-196"><a id="__codelineno-7-196" name="__codelineno-7-196" href="#__codelineno-7-196"></a>        <span class="k">return</span> <span class="n">sanitized</span>
</span><span id="__span-7-197"><a id="__codelineno-7-197" name="__codelineno-7-197" href="#__codelineno-7-197"></a>
</span><span id="__span-7-198"><a id="__codelineno-7-198" name="__codelineno-7-198" href="#__codelineno-7-198"></a>    <span class="c1"># Security decorators</span>
</span><span id="__span-7-199"><a id="__codelineno-7-199" name="__codelineno-7-199" href="#__codelineno-7-199"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">require_auth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">permissions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="__span-7-200"><a id="__codelineno-7-200" name="__codelineno-7-200" href="#__codelineno-7-200"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Decorator for endpoints requiring authentication&quot;&quot;&quot;</span>
</span><span id="__span-7-201"><a id="__codelineno-7-201" name="__codelineno-7-201" href="#__codelineno-7-201"></a>        <span class="k">def</span><span class="w"> </span><span class="nf">decorator</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
</span><span id="__span-7-202"><a id="__codelineno-7-202" name="__codelineno-7-202" href="#__codelineno-7-202"></a>            <span class="nd">@wraps</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</span><span id="__span-7-203"><a id="__codelineno-7-203" name="__codelineno-7-203" href="#__codelineno-7-203"></a>            <span class="k">def</span><span class="w"> </span><span class="nf">decorated_function</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="__span-7-204"><a id="__codelineno-7-204" name="__codelineno-7-204" href="#__codelineno-7-204"></a>                <span class="c1"># Check rate limiting first</span>
</span><span id="__span-7-205"><a id="__codelineno-7-205" name="__codelineno-7-205" href="#__codelineno-7-205"></a>                <span class="n">client_ip</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">remote_addr</span>
</span><span id="__span-7-206"><a id="__codelineno-7-206" name="__codelineno-7-206" href="#__codelineno-7-206"></a>                <span class="n">allowed</span><span class="p">,</span> <span class="n">rate_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate_limiter</span><span class="o">.</span><span class="n">is_allowed</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;auth_</span><span class="si">{</span><span class="n">client_ip</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-7-207"><a id="__codelineno-7-207" name="__codelineno-7-207" href="#__codelineno-7-207"></a>
</span><span id="__span-7-208"><a id="__codelineno-7-208" name="__codelineno-7-208" href="#__codelineno-7-208"></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">allowed</span><span class="p">:</span>
</span><span id="__span-7-209"><a id="__codelineno-7-209" name="__codelineno-7-209" href="#__codelineno-7-209"></a>                    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
</span><span id="__span-7-210"><a id="__codelineno-7-210" name="__codelineno-7-210" href="#__codelineno-7-210"></a>                        <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Rate limit exceeded&#39;</span><span class="p">,</span>
</span><span id="__span-7-211"><a id="__codelineno-7-211" name="__codelineno-7-211" href="#__codelineno-7-211"></a>                        <span class="s1">&#39;retry_after&#39;</span><span class="p">:</span> <span class="n">rate_info</span><span class="p">[</span><span class="s1">&#39;retry_after&#39;</span><span class="p">]</span>
</span><span id="__span-7-212"><a id="__codelineno-7-212" name="__codelineno-7-212" href="#__codelineno-7-212"></a>                    <span class="p">}),</span> <span class="mi">429</span>
</span><span id="__span-7-213"><a id="__codelineno-7-213" name="__codelineno-7-213" href="#__codelineno-7-213"></a>
</span><span id="__span-7-214"><a id="__codelineno-7-214" name="__codelineno-7-214" href="#__codelineno-7-214"></a>                <span class="c1"># Get token from header</span>
</span><span id="__span-7-215"><a id="__codelineno-7-215" name="__codelineno-7-215" href="#__codelineno-7-215"></a>                <span class="n">auth_header</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Authorization&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
</span><span id="__span-7-216"><a id="__codelineno-7-216" name="__codelineno-7-216" href="#__codelineno-7-216"></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">auth_header</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;Bearer &#39;</span><span class="p">):</span>
</span><span id="__span-7-217"><a id="__codelineno-7-217" name="__codelineno-7-217" href="#__codelineno-7-217"></a>                    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Missing or invalid authorization header&#39;</span><span class="p">}),</span> <span class="mi">401</span>
</span><span id="__span-7-218"><a id="__codelineno-7-218" name="__codelineno-7-218" href="#__codelineno-7-218"></a>
</span><span id="__span-7-219"><a id="__codelineno-7-219" name="__codelineno-7-219" href="#__codelineno-7-219"></a>                <span class="n">token</span> <span class="o">=</span> <span class="n">auth_header</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;Bearer &#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
</span><span id="__span-7-220"><a id="__codelineno-7-220" name="__codelineno-7-220" href="#__codelineno-7-220"></a>
</span><span id="__span-7-221"><a id="__codelineno-7-221" name="__codelineno-7-221" href="#__codelineno-7-221"></a>                <span class="c1"># Validate JWT token</span>
</span><span id="__span-7-222"><a id="__codelineno-7-222" name="__codelineno-7-222" href="#__codelineno-7-222"></a>                <span class="n">payload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jwt_manager</span><span class="o">.</span><span class="n">validate_token</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
</span><span id="__span-7-223"><a id="__codelineno-7-223" name="__codelineno-7-223" href="#__codelineno-7-223"></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">payload</span><span class="p">:</span>
</span><span id="__span-7-224"><a id="__codelineno-7-224" name="__codelineno-7-224" href="#__codelineno-7-224"></a>                    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Invalid or expired token&#39;</span><span class="p">}),</span> <span class="mi">401</span>
</span><span id="__span-7-225"><a id="__codelineno-7-225" name="__codelineno-7-225" href="#__codelineno-7-225"></a>
</span><span id="__span-7-226"><a id="__codelineno-7-226" name="__codelineno-7-226" href="#__codelineno-7-226"></a>                <span class="c1"># Check permissions</span>
</span><span id="__span-7-227"><a id="__codelineno-7-227" name="__codelineno-7-227" href="#__codelineno-7-227"></a>                <span class="k">if</span> <span class="n">permissions</span><span class="p">:</span>
</span><span id="__span-7-228"><a id="__codelineno-7-228" name="__codelineno-7-228" href="#__codelineno-7-228"></a>                    <span class="n">user_permissions</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;permissions&#39;</span><span class="p">,</span> <span class="p">[])</span>
</span><span id="__span-7-229"><a id="__codelineno-7-229" name="__codelineno-7-229" href="#__codelineno-7-229"></a>                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">perm</span> <span class="ow">in</span> <span class="n">user_permissions</span> <span class="k">for</span> <span class="n">perm</span> <span class="ow">in</span> <span class="n">permissions</span><span class="p">):</span>
</span><span id="__span-7-230"><a id="__codelineno-7-230" name="__codelineno-7-230" href="#__codelineno-7-230"></a>                        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Insufficient permissions&#39;</span><span class="p">}),</span> <span class="mi">403</span>
</span><span id="__span-7-231"><a id="__codelineno-7-231" name="__codelineno-7-231" href="#__codelineno-7-231"></a>
</span><span id="__span-7-232"><a id="__codelineno-7-232" name="__codelineno-7-232" href="#__codelineno-7-232"></a>                <span class="c1"># Store user info for use in endpoint</span>
</span><span id="__span-7-233"><a id="__codelineno-7-233" name="__codelineno-7-233" href="#__codelineno-7-233"></a>                <span class="n">g</span><span class="o">.</span><span class="n">current_user</span> <span class="o">=</span> <span class="n">payload</span>
</span><span id="__span-7-234"><a id="__codelineno-7-234" name="__codelineno-7-234" href="#__codelineno-7-234"></a>
</span><span id="__span-7-235"><a id="__codelineno-7-235" name="__codelineno-7-235" href="#__codelineno-7-235"></a>                <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="__span-7-236"><a id="__codelineno-7-236" name="__codelineno-7-236" href="#__codelineno-7-236"></a>            <span class="k">return</span> <span class="n">decorated_function</span>
</span><span id="__span-7-237"><a id="__codelineno-7-237" name="__codelineno-7-237" href="#__codelineno-7-237"></a>        <span class="k">return</span> <span class="n">decorator</span>
</span><span id="__span-7-238"><a id="__codelineno-7-238" name="__codelineno-7-238" href="#__codelineno-7-238"></a>
</span><span id="__span-7-239"><a id="__codelineno-7-239" name="__codelineno-7-239" href="#__codelineno-7-239"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">require_cors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">policy_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="__span-7-240"><a id="__codelineno-7-240" name="__codelineno-7-240" href="#__codelineno-7-240"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Decorator for CORS handling&quot;&quot;&quot;</span>
</span><span id="__span-7-241"><a id="__codelineno-7-241" name="__codelineno-7-241" href="#__codelineno-7-241"></a>        <span class="k">def</span><span class="w"> </span><span class="nf">decorator</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
</span><span id="__span-7-242"><a id="__codelineno-7-242" name="__codelineno-7-242" href="#__codelineno-7-242"></a>            <span class="nd">@wraps</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</span><span id="__span-7-243"><a id="__codelineno-7-243" name="__codelineno-7-243" href="#__codelineno-7-243"></a>            <span class="k">def</span><span class="w"> </span><span class="nf">decorated_function</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="__span-7-244"><a id="__codelineno-7-244" name="__codelineno-7-244" href="#__codelineno-7-244"></a>                <span class="n">origin</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Origin&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
</span><span id="__span-7-245"><a id="__codelineno-7-245" name="__codelineno-7-245" href="#__codelineno-7-245"></a>
</span><span id="__span-7-246"><a id="__codelineno-7-246" name="__codelineno-7-246" href="#__codelineno-7-246"></a>                <span class="c1"># Handle preflight requests</span>
</span><span id="__span-7-247"><a id="__codelineno-7-247" name="__codelineno-7-247" href="#__codelineno-7-247"></a>                <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;OPTIONS&#39;</span><span class="p">:</span>
</span><span id="__span-7-248"><a id="__codelineno-7-248" name="__codelineno-7-248" href="#__codelineno-7-248"></a>                    <span class="n">cors_headers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cors_manager</span><span class="o">.</span><span class="n">handle_preflight_request</span><span class="p">(</span>
</span><span id="__span-7-249"><a id="__codelineno-7-249" name="__codelineno-7-249" href="#__codelineno-7-249"></a>                        <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">,</span>
</span><span id="__span-7-250"><a id="__codelineno-7-250" name="__codelineno-7-250" href="#__codelineno-7-250"></a>                        <span class="n">method</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Access-Control-Request-Method&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
</span><span id="__span-7-251"><a id="__codelineno-7-251" name="__codelineno-7-251" href="#__codelineno-7-251"></a>                        <span class="n">headers</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Access-Control-Request-Headers&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">),</span>
</span><span id="__span-7-252"><a id="__codelineno-7-252" name="__codelineno-7-252" href="#__codelineno-7-252"></a>                        <span class="n">policy_name</span><span class="o">=</span><span class="n">policy_name</span>
</span><span id="__span-7-253"><a id="__codelineno-7-253" name="__codelineno-7-253" href="#__codelineno-7-253"></a>                    <span class="p">)</span>
</span><span id="__span-7-254"><a id="__codelineno-7-254" name="__codelineno-7-254" href="#__codelineno-7-254"></a>
</span><span id="__span-7-255"><a id="__codelineno-7-255" name="__codelineno-7-255" href="#__codelineno-7-255"></a>                    <span class="k">if</span> <span class="ow">not</span> <span class="n">cors_headers</span><span class="p">:</span>
</span><span id="__span-7-256"><a id="__codelineno-7-256" name="__codelineno-7-256" href="#__codelineno-7-256"></a>                        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;CORS policy violation&#39;</span><span class="p">}),</span> <span class="mi">403</span>
</span><span id="__span-7-257"><a id="__codelineno-7-257" name="__codelineno-7-257" href="#__codelineno-7-257"></a>
</span><span id="__span-7-258"><a id="__codelineno-7-258" name="__codelineno-7-258" href="#__codelineno-7-258"></a>                    <span class="n">response</span> <span class="o">=</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;preflight ok&#39;</span><span class="p">})</span>
</span><span id="__span-7-259"><a id="__codelineno-7-259" name="__codelineno-7-259" href="#__codelineno-7-259"></a>                    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">cors_headers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="__span-7-260"><a id="__codelineno-7-260" name="__codelineno-7-260" href="#__codelineno-7-260"></a>                        <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
</span><span id="__span-7-261"><a id="__codelineno-7-261" name="__codelineno-7-261" href="#__codelineno-7-261"></a>
</span><span id="__span-7-262"><a id="__codelineno-7-262" name="__codelineno-7-262" href="#__codelineno-7-262"></a>                    <span class="k">return</span> <span class="n">response</span>
</span><span id="__span-7-263"><a id="__codelineno-7-263" name="__codelineno-7-263" href="#__codelineno-7-263"></a>
</span><span id="__span-7-264"><a id="__codelineno-7-264" name="__codelineno-7-264" href="#__codelineno-7-264"></a>                <span class="c1"># Handle actual request</span>
</span><span id="__span-7-265"><a id="__codelineno-7-265" name="__codelineno-7-265" href="#__codelineno-7-265"></a>                <span class="n">cors_headers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cors_manager</span><span class="o">.</span><span class="n">handle_actual_request</span><span class="p">(</span><span class="n">origin</span><span class="p">,</span> <span class="n">policy_name</span><span class="p">)</span>
</span><span id="__span-7-266"><a id="__codelineno-7-266" name="__codelineno-7-266" href="#__codelineno-7-266"></a>
</span><span id="__span-7-267"><a id="__codelineno-7-267" name="__codelineno-7-267" href="#__codelineno-7-267"></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">cors_headers</span><span class="p">:</span>
</span><span id="__span-7-268"><a id="__codelineno-7-268" name="__codelineno-7-268" href="#__codelineno-7-268"></a>                    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;CORS policy violation&#39;</span><span class="p">}),</span> <span class="mi">403</span>
</span><span id="__span-7-269"><a id="__codelineno-7-269" name="__codelineno-7-269" href="#__codelineno-7-269"></a>
</span><span id="__span-7-270"><a id="__codelineno-7-270" name="__codelineno-7-270" href="#__codelineno-7-270"></a>                <span class="c1"># Execute the actual function</span>
</span><span id="__span-7-271"><a id="__codelineno-7-271" name="__codelineno-7-271" href="#__codelineno-7-271"></a>                <span class="n">response</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="__span-7-272"><a id="__codelineno-7-272" name="__codelineno-7-272" href="#__codelineno-7-272"></a>
</span><span id="__span-7-273"><a id="__codelineno-7-273" name="__codelineno-7-273" href="#__codelineno-7-273"></a>                <span class="c1"># Add CORS headers to response</span>
</span><span id="__span-7-274"><a id="__codelineno-7-274" name="__codelineno-7-274" href="#__codelineno-7-274"></a>                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="s1">&#39;headers&#39;</span><span class="p">):</span>
</span><span id="__span-7-275"><a id="__codelineno-7-275" name="__codelineno-7-275" href="#__codelineno-7-275"></a>                    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">cors_headers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="__span-7-276"><a id="__codelineno-7-276" name="__codelineno-7-276" href="#__codelineno-7-276"></a>                        <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
</span><span id="__span-7-277"><a id="__codelineno-7-277" name="__codelineno-7-277" href="#__codelineno-7-277"></a>
</span><span id="__span-7-278"><a id="__codelineno-7-278" name="__codelineno-7-278" href="#__codelineno-7-278"></a>                <span class="k">return</span> <span class="n">response</span>
</span><span id="__span-7-279"><a id="__codelineno-7-279" name="__codelineno-7-279" href="#__codelineno-7-279"></a>            <span class="k">return</span> <span class="n">decorated_function</span>
</span><span id="__span-7-280"><a id="__codelineno-7-280" name="__codelineno-7-280" href="#__codelineno-7-280"></a>        <span class="k">return</span> <span class="n">decorator</span>
</span><span id="__span-7-281"><a id="__codelineno-7-281" name="__codelineno-7-281" href="#__codelineno-7-281"></a>
</span><span id="__span-7-282"><a id="__codelineno-7-282" name="__codelineno-7-282" href="#__codelineno-7-282"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">register_routes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-7-283"><a id="__codelineno-7-283" name="__codelineno-7-283" href="#__codelineno-7-283"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Register all API routes with security&quot;&quot;&quot;</span>
</span><span id="__span-7-284"><a id="__codelineno-7-284" name="__codelineno-7-284" href="#__codelineno-7-284"></a>
</span><span id="__span-7-285"><a id="__codelineno-7-285" name="__codelineno-7-285" href="#__codelineno-7-285"></a>        <span class="c1"># Authentication endpoints</span>
</span><span id="__span-7-286"><a id="__codelineno-7-286" name="__codelineno-7-286" href="#__codelineno-7-286"></a>        <span class="nd">@self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/auth/register&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">,</span> <span class="s1">&#39;OPTIONS&#39;</span><span class="p">])</span>
</span><span id="__span-7-287"><a id="__codelineno-7-287" name="__codelineno-7-287" href="#__codelineno-7-287"></a>        <span class="nd">@self</span><span class="o">.</span><span class="n">require_cors</span><span class="p">()</span>
</span><span id="__span-7-288"><a id="__codelineno-7-288" name="__codelineno-7-288" href="#__codelineno-7-288"></a>        <span class="k">def</span><span class="w"> </span><span class="nf">register</span><span class="p">():</span>
</span><span id="__span-7-289"><a id="__codelineno-7-289" name="__codelineno-7-289" href="#__codelineno-7-289"></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;User registration with security validation&quot;&quot;&quot;</span>
</span><span id="__span-7-290"><a id="__codelineno-7-290" name="__codelineno-7-290" href="#__codelineno-7-290"></a>            <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;OPTIONS&#39;</span><span class="p">:</span>
</span><span id="__span-7-291"><a id="__codelineno-7-291" name="__codelineno-7-291" href="#__codelineno-7-291"></a>                <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">200</span>  <span class="c1"># Handled by decorator</span>
</span><span id="__span-7-292"><a id="__codelineno-7-292" name="__codelineno-7-292" href="#__codelineno-7-292"></a>
</span><span id="__span-7-293"><a id="__codelineno-7-293" name="__codelineno-7-293" href="#__codelineno-7-293"></a>            <span class="c1"># Rate limiting for registration</span>
</span><span id="__span-7-294"><a id="__codelineno-7-294" name="__codelineno-7-294" href="#__codelineno-7-294"></a>            <span class="n">client_ip</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">remote_addr</span>
</span><span id="__span-7-295"><a id="__codelineno-7-295" name="__codelineno-7-295" href="#__codelineno-7-295"></a>            <span class="n">allowed</span><span class="p">,</span> <span class="n">rate_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate_limiter</span><span class="o">.</span><span class="n">sliding_window_check</span><span class="p">(</span>
</span><span id="__span-7-296"><a id="__codelineno-7-296" name="__codelineno-7-296" href="#__codelineno-7-296"></a>                <span class="sa">f</span><span class="s2">&quot;register_</span><span class="si">{</span><span class="n">client_ip</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="mi">3600</span><span class="p">,</span> <span class="mi">5</span>  <span class="c1"># 5 registrations per hour</span>
</span><span id="__span-7-297"><a id="__codelineno-7-297" name="__codelineno-7-297" href="#__codelineno-7-297"></a>            <span class="p">)</span>
</span><span id="__span-7-298"><a id="__codelineno-7-298" name="__codelineno-7-298" href="#__codelineno-7-298"></a>
</span><span id="__span-7-299"><a id="__codelineno-7-299" name="__codelineno-7-299" href="#__codelineno-7-299"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">allowed</span><span class="p">:</span>
</span><span id="__span-7-300"><a id="__codelineno-7-300" name="__codelineno-7-300" href="#__codelineno-7-300"></a>                <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
</span><span id="__span-7-301"><a id="__codelineno-7-301" name="__codelineno-7-301" href="#__codelineno-7-301"></a>                    <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Registration rate limit exceeded&#39;</span><span class="p">,</span>
</span><span id="__span-7-302"><a id="__codelineno-7-302" name="__codelineno-7-302" href="#__codelineno-7-302"></a>                    <span class="s1">&#39;retry_after&#39;</span><span class="p">:</span> <span class="n">rate_info</span><span class="p">[</span><span class="s1">&#39;retry_after&#39;</span><span class="p">]</span>
</span><span id="__span-7-303"><a id="__codelineno-7-303" name="__codelineno-7-303" href="#__codelineno-7-303"></a>                <span class="p">}),</span> <span class="mi">429</span>
</span><span id="__span-7-304"><a id="__codelineno-7-304" name="__codelineno-7-304" href="#__codelineno-7-304"></a>
</span><span id="__span-7-305"><a id="__codelineno-7-305" name="__codelineno-7-305" href="#__codelineno-7-305"></a>            <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>
</span><span id="__span-7-306"><a id="__codelineno-7-306" name="__codelineno-7-306" href="#__codelineno-7-306"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
</span><span id="__span-7-307"><a id="__codelineno-7-307" name="__codelineno-7-307" href="#__codelineno-7-307"></a>                <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Invalid JSON data&#39;</span><span class="p">}),</span> <span class="mi">400</span>
</span><span id="__span-7-308"><a id="__codelineno-7-308" name="__codelineno-7-308" href="#__codelineno-7-308"></a>
</span><span id="__span-7-309"><a id="__codelineno-7-309" name="__codelineno-7-309" href="#__codelineno-7-309"></a>            <span class="c1"># Input validation</span>
</span><span id="__span-7-310"><a id="__codelineno-7-310" name="__codelineno-7-310" href="#__codelineno-7-310"></a>            <span class="n">validation_rules</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-7-311"><a id="__codelineno-7-311" name="__codelineno-7-311" href="#__codelineno-7-311"></a>                <span class="s1">&#39;username&#39;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-7-312"><a id="__codelineno-7-312" name="__codelineno-7-312" href="#__codelineno-7-312"></a>                    <span class="s1">&#39;required&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="__span-7-313"><a id="__codelineno-7-313" name="__codelineno-7-313" href="#__codelineno-7-313"></a>                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="__span-7-314"><a id="__codelineno-7-314" name="__codelineno-7-314" href="#__codelineno-7-314"></a>                    <span class="s1">&#39;min_length&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
</span><span id="__span-7-315"><a id="__codelineno-7-315" name="__codelineno-7-315" href="#__codelineno-7-315"></a>                    <span class="s1">&#39;max_length&#39;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>
</span><span id="__span-7-316"><a id="__codelineno-7-316" name="__codelineno-7-316" href="#__codelineno-7-316"></a>                    <span class="s1">&#39;pattern&#39;</span><span class="p">:</span> <span class="sa">r</span><span class="s1">&#39;^[a-zA-Z0-9_]+$&#39;</span>
</span><span id="__span-7-317"><a id="__codelineno-7-317" name="__codelineno-7-317" href="#__codelineno-7-317"></a>                <span class="p">},</span>
</span><span id="__span-7-318"><a id="__codelineno-7-318" name="__codelineno-7-318" href="#__codelineno-7-318"></a>                <span class="s1">&#39;email&#39;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-7-319"><a id="__codelineno-7-319" name="__codelineno-7-319" href="#__codelineno-7-319"></a>                    <span class="s1">&#39;required&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="__span-7-320"><a id="__codelineno-7-320" name="__codelineno-7-320" href="#__codelineno-7-320"></a>                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="__span-7-321"><a id="__codelineno-7-321" name="__codelineno-7-321" href="#__codelineno-7-321"></a>                    <span class="s1">&#39;pattern&#39;</span><span class="p">:</span> <span class="sa">r</span><span class="s1">&#39;^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$&#39;</span>
</span><span id="__span-7-322"><a id="__codelineno-7-322" name="__codelineno-7-322" href="#__codelineno-7-322"></a>                <span class="p">},</span>
</span><span id="__span-7-323"><a id="__codelineno-7-323" name="__codelineno-7-323" href="#__codelineno-7-323"></a>                <span class="s1">&#39;password&#39;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-7-324"><a id="__codelineno-7-324" name="__codelineno-7-324" href="#__codelineno-7-324"></a>                    <span class="s1">&#39;required&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="__span-7-325"><a id="__codelineno-7-325" name="__codelineno-7-325" href="#__codelineno-7-325"></a>                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="__span-7-326"><a id="__codelineno-7-326" name="__codelineno-7-326" href="#__codelineno-7-326"></a>                    <span class="s1">&#39;min_length&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>
</span><span id="__span-7-327"><a id="__codelineno-7-327" name="__codelineno-7-327" href="#__codelineno-7-327"></a>                    <span class="s1">&#39;validator&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="nb">any</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">isupper</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">p</span><span class="p">)</span> <span class="ow">and</span> 
</span><span id="__span-7-328"><a id="__codelineno-7-328" name="__codelineno-7-328" href="#__codelineno-7-328"></a>                                         <span class="nb">any</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">islower</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">p</span><span class="p">)</span> <span class="ow">and</span> 
</span><span id="__span-7-329"><a id="__codelineno-7-329" name="__codelineno-7-329" href="#__codelineno-7-329"></a>                                         <span class="nb">any</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">p</span><span class="p">)</span>
</span><span id="__span-7-330"><a id="__codelineno-7-330" name="__codelineno-7-330" href="#__codelineno-7-330"></a>                <span class="p">}</span>
</span><span id="__span-7-331"><a id="__codelineno-7-331" name="__codelineno-7-331" href="#__codelineno-7-331"></a>            <span class="p">}</span>
</span><span id="__span-7-332"><a id="__codelineno-7-332" name="__codelineno-7-332" href="#__codelineno-7-332"></a>
</span><span id="__span-7-333"><a id="__codelineno-7-333" name="__codelineno-7-333" href="#__codelineno-7-333"></a>            <span class="n">is_valid</span><span class="p">,</span> <span class="n">errors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_input</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">validation_rules</span><span class="p">)</span>
</span><span id="__span-7-334"><a id="__codelineno-7-334" name="__codelineno-7-334" href="#__codelineno-7-334"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_valid</span><span class="p">:</span>
</span><span id="__span-7-335"><a id="__codelineno-7-335" name="__codelineno-7-335" href="#__codelineno-7-335"></a>                <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Validation failed&#39;</span><span class="p">,</span> <span class="s1">&#39;details&#39;</span><span class="p">:</span> <span class="n">errors</span><span class="p">}),</span> <span class="mi">400</span>
</span><span id="__span-7-336"><a id="__codelineno-7-336" name="__codelineno-7-336" href="#__codelineno-7-336"></a>
</span><span id="__span-7-337"><a id="__codelineno-7-337" name="__codelineno-7-337" href="#__codelineno-7-337"></a>            <span class="c1"># Sanitize input</span>
</span><span id="__span-7-338"><a id="__codelineno-7-338" name="__codelineno-7-338" href="#__codelineno-7-338"></a>            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sanitize_input</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span id="__span-7-339"><a id="__codelineno-7-339" name="__codelineno-7-339" href="#__codelineno-7-339"></a>
</span><span id="__span-7-340"><a id="__codelineno-7-340" name="__codelineno-7-340" href="#__codelineno-7-340"></a>            <span class="n">conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_db_connection</span><span class="p">()</span>
</span><span id="__span-7-341"><a id="__codelineno-7-341" name="__codelineno-7-341" href="#__codelineno-7-341"></a>            <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
</span><span id="__span-7-342"><a id="__codelineno-7-342" name="__codelineno-7-342" href="#__codelineno-7-342"></a>
</span><span id="__span-7-343"><a id="__codelineno-7-343" name="__codelineno-7-343" href="#__codelineno-7-343"></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="__span-7-344"><a id="__codelineno-7-344" name="__codelineno-7-344" href="#__codelineno-7-344"></a>                <span class="c1"># Check if user already exists</span>
</span><span id="__span-7-345"><a id="__codelineno-7-345" name="__codelineno-7-345" href="#__codelineno-7-345"></a>                <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;SELECT id FROM users WHERE username = ? OR email = ?&#39;</span><span class="p">,</span> 
</span><span id="__span-7-346"><a id="__codelineno-7-346" name="__codelineno-7-346" href="#__codelineno-7-346"></a>                             <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">]))</span>
</span><span id="__span-7-347"><a id="__codelineno-7-347" name="__codelineno-7-347" href="#__codelineno-7-347"></a>                <span class="k">if</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">():</span>
</span><span id="__span-7-348"><a id="__codelineno-7-348" name="__codelineno-7-348" href="#__codelineno-7-348"></a>                    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;User already exists&#39;</span><span class="p">}),</span> <span class="mi">409</span>
</span><span id="__span-7-349"><a id="__codelineno-7-349" name="__codelineno-7-349" href="#__codelineno-7-349"></a>
</span><span id="__span-7-350"><a id="__codelineno-7-350" name="__codelineno-7-350" href="#__codelineno-7-350"></a>                <span class="c1"># Generate salt and hash password</span>
</span><span id="__span-7-351"><a id="__codelineno-7-351" name="__codelineno-7-351" href="#__codelineno-7-351"></a>                <span class="n">salt</span> <span class="o">=</span> <span class="n">secrets</span><span class="o">.</span><span class="n">token_hex</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
</span><span id="__span-7-352"><a id="__codelineno-7-352" name="__codelineno-7-352" href="#__codelineno-7-352"></a>                <span class="n">password_hash</span> <span class="o">=</span> <span class="n">generate_password_hash</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">salt</span><span class="p">)</span>
</span><span id="__span-7-353"><a id="__codelineno-7-353" name="__codelineno-7-353" href="#__codelineno-7-353"></a>
</span><span id="__span-7-354"><a id="__codelineno-7-354" name="__codelineno-7-354" href="#__codelineno-7-354"></a>                <span class="c1"># Insert user</span>
</span><span id="__span-7-355"><a id="__codelineno-7-355" name="__codelineno-7-355" href="#__codelineno-7-355"></a>                <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;</span>
</span><span id="__span-7-356"><a id="__codelineno-7-356" name="__codelineno-7-356" href="#__codelineno-7-356"></a><span class="s1">                    INSERT INTO users (username, email, password_hash, salt)</span>
</span><span id="__span-7-357"><a id="__codelineno-7-357" name="__codelineno-7-357" href="#__codelineno-7-357"></a><span class="s1">                    VALUES (?, ?, ?, ?)</span>
</span><span id="__span-7-358"><a id="__codelineno-7-358" name="__codelineno-7-358" href="#__codelineno-7-358"></a><span class="s1">                &#39;&#39;&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">],</span> <span class="n">password_hash</span><span class="p">,</span> <span class="n">salt</span><span class="p">))</span>
</span><span id="__span-7-359"><a id="__codelineno-7-359" name="__codelineno-7-359" href="#__codelineno-7-359"></a>
</span><span id="__span-7-360"><a id="__codelineno-7-360" name="__codelineno-7-360" href="#__codelineno-7-360"></a>                <span class="n">user_id</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">lastrowid</span>
</span><span id="__span-7-361"><a id="__codelineno-7-361" name="__codelineno-7-361" href="#__codelineno-7-361"></a>                <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span><span id="__span-7-362"><a id="__codelineno-7-362" name="__codelineno-7-362" href="#__codelineno-7-362"></a>
</span><span id="__span-7-363"><a id="__codelineno-7-363" name="__codelineno-7-363" href="#__codelineno-7-363"></a>                <span class="c1"># Generate JWT token</span>
</span><span id="__span-7-364"><a id="__codelineno-7-364" name="__codelineno-7-364" href="#__codelineno-7-364"></a>                <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jwt_manager</span><span class="o">.</span><span class="n">generate_token</span><span class="p">(</span>
</span><span id="__span-7-365"><a id="__codelineno-7-365" name="__codelineno-7-365" href="#__codelineno-7-365"></a>                    <span class="n">user_id</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">user_id</span><span class="p">),</span>
</span><span id="__span-7-366"><a id="__codelineno-7-366" name="__codelineno-7-366" href="#__codelineno-7-366"></a>                    <span class="n">permissions</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;read&#39;</span><span class="p">,</span> <span class="s1">&#39;write&#39;</span><span class="p">]</span>
</span><span id="__span-7-367"><a id="__codelineno-7-367" name="__codelineno-7-367" href="#__codelineno-7-367"></a>                <span class="p">)</span>
</span><span id="__span-7-368"><a id="__codelineno-7-368" name="__codelineno-7-368" href="#__codelineno-7-368"></a>
</span><span id="__span-7-369"><a id="__codelineno-7-369" name="__codelineno-7-369" href="#__codelineno-7-369"></a>                <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
</span><span id="__span-7-370"><a id="__codelineno-7-370" name="__codelineno-7-370" href="#__codelineno-7-370"></a>                    <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;User registered successfully&#39;</span><span class="p">,</span>
</span><span id="__span-7-371"><a id="__codelineno-7-371" name="__codelineno-7-371" href="#__codelineno-7-371"></a>                    <span class="s1">&#39;token&#39;</span><span class="p">:</span> <span class="n">token</span><span class="p">,</span>
</span><span id="__span-7-372"><a id="__codelineno-7-372" name="__codelineno-7-372" href="#__codelineno-7-372"></a>                    <span class="s1">&#39;user&#39;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-7-373"><a id="__codelineno-7-373" name="__codelineno-7-373" href="#__codelineno-7-373"></a>                        <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">,</span>
</span><span id="__span-7-374"><a id="__codelineno-7-374" name="__codelineno-7-374" href="#__codelineno-7-374"></a>                        <span class="s1">&#39;username&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">],</span>
</span><span id="__span-7-375"><a id="__codelineno-7-375" name="__codelineno-7-375" href="#__codelineno-7-375"></a>                        <span class="s1">&#39;email&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">]</span>
</span><span id="__span-7-376"><a id="__codelineno-7-376" name="__codelineno-7-376" href="#__codelineno-7-376"></a>                    <span class="p">}</span>
</span><span id="__span-7-377"><a id="__codelineno-7-377" name="__codelineno-7-377" href="#__codelineno-7-377"></a>                <span class="p">}),</span> <span class="mi">201</span>
</span><span id="__span-7-378"><a id="__codelineno-7-378" name="__codelineno-7-378" href="#__codelineno-7-378"></a>
</span><span id="__span-7-379"><a id="__codelineno-7-379" name="__codelineno-7-379" href="#__codelineno-7-379"></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-7-380"><a id="__codelineno-7-380" name="__codelineno-7-380" href="#__codelineno-7-380"></a>                <span class="n">conn</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
</span><span id="__span-7-381"><a id="__codelineno-7-381" name="__codelineno-7-381" href="#__codelineno-7-381"></a>                <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Registration failed&#39;</span><span class="p">}),</span> <span class="mi">500</span>
</span><span id="__span-7-382"><a id="__codelineno-7-382" name="__codelineno-7-382" href="#__codelineno-7-382"></a>
</span><span id="__span-7-383"><a id="__codelineno-7-383" name="__codelineno-7-383" href="#__codelineno-7-383"></a>            <span class="k">finally</span><span class="p">:</span>
</span><span id="__span-7-384"><a id="__codelineno-7-384" name="__codelineno-7-384" href="#__codelineno-7-384"></a>                <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="__span-7-385"><a id="__codelineno-7-385" name="__codelineno-7-385" href="#__codelineno-7-385"></a>
</span><span id="__span-7-386"><a id="__codelineno-7-386" name="__codelineno-7-386" href="#__codelineno-7-386"></a>        <span class="nd">@self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/auth/login&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">,</span> <span class="s1">&#39;OPTIONS&#39;</span><span class="p">])</span>
</span><span id="__span-7-387"><a id="__codelineno-7-387" name="__codelineno-7-387" href="#__codelineno-7-387"></a>        <span class="nd">@self</span><span class="o">.</span><span class="n">require_cors</span><span class="p">()</span>
</span><span id="__span-7-388"><a id="__codelineno-7-388" name="__codelineno-7-388" href="#__codelineno-7-388"></a>        <span class="k">def</span><span class="w"> </span><span class="nf">login</span><span class="p">():</span>
</span><span id="__span-7-389"><a id="__codelineno-7-389" name="__codelineno-7-389" href="#__codelineno-7-389"></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;User login with brute force protection&quot;&quot;&quot;</span>
</span><span id="__span-7-390"><a id="__codelineno-7-390" name="__codelineno-7-390" href="#__codelineno-7-390"></a>            <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;OPTIONS&#39;</span><span class="p">:</span>
</span><span id="__span-7-391"><a id="__codelineno-7-391" name="__codelineno-7-391" href="#__codelineno-7-391"></a>                <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">200</span>
</span><span id="__span-7-392"><a id="__codelineno-7-392" name="__codelineno-7-392" href="#__codelineno-7-392"></a>
</span><span id="__span-7-393"><a id="__codelineno-7-393" name="__codelineno-7-393" href="#__codelineno-7-393"></a>            <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>
</span><span id="__span-7-394"><a id="__codelineno-7-394" name="__codelineno-7-394" href="#__codelineno-7-394"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
</span><span id="__span-7-395"><a id="__codelineno-7-395" name="__codelineno-7-395" href="#__codelineno-7-395"></a>                <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Invalid JSON data&#39;</span><span class="p">}),</span> <span class="mi">400</span>
</span><span id="__span-7-396"><a id="__codelineno-7-396" name="__codelineno-7-396" href="#__codelineno-7-396"></a>
</span><span id="__span-7-397"><a id="__codelineno-7-397" name="__codelineno-7-397" href="#__codelineno-7-397"></a>            <span class="c1"># Input validation</span>
</span><span id="__span-7-398"><a id="__codelineno-7-398" name="__codelineno-7-398" href="#__codelineno-7-398"></a>            <span class="n">validation_rules</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-7-399"><a id="__codelineno-7-399" name="__codelineno-7-399" href="#__codelineno-7-399"></a>                <span class="s1">&#39;username&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;required&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">},</span>
</span><span id="__span-7-400"><a id="__codelineno-7-400" name="__codelineno-7-400" href="#__codelineno-7-400"></a>                <span class="s1">&#39;password&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;required&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">}</span>
</span><span id="__span-7-401"><a id="__codelineno-7-401" name="__codelineno-7-401" href="#__codelineno-7-401"></a>            <span class="p">}</span>
</span><span id="__span-7-402"><a id="__codelineno-7-402" name="__codelineno-7-402" href="#__codelineno-7-402"></a>
</span><span id="__span-7-403"><a id="__codelineno-7-403" name="__codelineno-7-403" href="#__codelineno-7-403"></a>            <span class="n">is_valid</span><span class="p">,</span> <span class="n">errors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_input</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">validation_rules</span><span class="p">)</span>
</span><span id="__span-7-404"><a id="__codelineno-7-404" name="__codelineno-7-404" href="#__codelineno-7-404"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_valid</span><span class="p">:</span>
</span><span id="__span-7-405"><a id="__codelineno-7-405" name="__codelineno-7-405" href="#__codelineno-7-405"></a>                <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Validation failed&#39;</span><span class="p">,</span> <span class="s1">&#39;details&#39;</span><span class="p">:</span> <span class="n">errors</span><span class="p">}),</span> <span class="mi">400</span>
</span><span id="__span-7-406"><a id="__codelineno-7-406" name="__codelineno-7-406" href="#__codelineno-7-406"></a>
</span><span id="__span-7-407"><a id="__codelineno-7-407" name="__codelineno-7-407" href="#__codelineno-7-407"></a>            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sanitize_input</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span id="__span-7-408"><a id="__codelineno-7-408" name="__codelineno-7-408" href="#__codelineno-7-408"></a>
</span><span id="__span-7-409"><a id="__codelineno-7-409" name="__codelineno-7-409" href="#__codelineno-7-409"></a>            <span class="n">conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_db_connection</span><span class="p">()</span>
</span><span id="__span-7-410"><a id="__codelineno-7-410" name="__codelineno-7-410" href="#__codelineno-7-410"></a>            <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
</span><span id="__span-7-411"><a id="__codelineno-7-411" name="__codelineno-7-411" href="#__codelineno-7-411"></a>
</span><span id="__span-7-412"><a id="__codelineno-7-412" name="__codelineno-7-412" href="#__codelineno-7-412"></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="__span-7-413"><a id="__codelineno-7-413" name="__codelineno-7-413" href="#__codelineno-7-413"></a>                <span class="c1"># Get user with security info</span>
</span><span id="__span-7-414"><a id="__codelineno-7-414" name="__codelineno-7-414" href="#__codelineno-7-414"></a>                <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;</span>
</span><span id="__span-7-415"><a id="__codelineno-7-415" name="__codelineno-7-415" href="#__codelineno-7-415"></a><span class="s1">                    SELECT id, username, email, password_hash, salt, </span>
</span><span id="__span-7-416"><a id="__codelineno-7-416" name="__codelineno-7-416" href="#__codelineno-7-416"></a><span class="s1">                           failed_login_attempts, last_failed_login, is_active</span>
</span><span id="__span-7-417"><a id="__codelineno-7-417" name="__codelineno-7-417" href="#__codelineno-7-417"></a><span class="s1">                    FROM users WHERE username = ?</span>
</span><span id="__span-7-418"><a id="__codelineno-7-418" name="__codelineno-7-418" href="#__codelineno-7-418"></a><span class="s1">                &#39;&#39;&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">],))</span>
</span><span id="__span-7-419"><a id="__codelineno-7-419" name="__codelineno-7-419" href="#__codelineno-7-419"></a>
</span><span id="__span-7-420"><a id="__codelineno-7-420" name="__codelineno-7-420" href="#__codelineno-7-420"></a>                <span class="n">user</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
</span><span id="__span-7-421"><a id="__codelineno-7-421" name="__codelineno-7-421" href="#__codelineno-7-421"></a>
</span><span id="__span-7-422"><a id="__codelineno-7-422" name="__codelineno-7-422" href="#__codelineno-7-422"></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">user</span><span class="p">[</span><span class="s1">&#39;is_active&#39;</span><span class="p">]:</span>
</span><span id="__span-7-423"><a id="__codelineno-7-423" name="__codelineno-7-423" href="#__codelineno-7-423"></a>                    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Invalid credentials&#39;</span><span class="p">}),</span> <span class="mi">401</span>
</span><span id="__span-7-424"><a id="__codelineno-7-424" name="__codelineno-7-424" href="#__codelineno-7-424"></a>
</span><span id="__span-7-425"><a id="__codelineno-7-425" name="__codelineno-7-425" href="#__codelineno-7-425"></a>                <span class="c1"># Check for account lockout (brute force protection)</span>
</span><span id="__span-7-426"><a id="__codelineno-7-426" name="__codelineno-7-426" href="#__codelineno-7-426"></a>                <span class="k">if</span> <span class="n">user</span><span class="p">[</span><span class="s1">&#39;failed_login_attempts&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">:</span>
</span><span id="__span-7-427"><a id="__codelineno-7-427" name="__codelineno-7-427" href="#__codelineno-7-427"></a>                    <span class="n">last_failed</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="n">user</span><span class="p">[</span><span class="s1">&#39;last_failed_login&#39;</span><span class="p">])</span> <span class="k">if</span> <span class="n">user</span><span class="p">[</span><span class="s1">&#39;last_failed_login&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="__span-7-428"><a id="__codelineno-7-428" name="__codelineno-7-428" href="#__codelineno-7-428"></a>                    <span class="k">if</span> <span class="n">last_failed</span> <span class="ow">and</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">last_failed</span> <span class="o">&lt;</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">15</span><span class="p">):</span>
</span><span id="__span-7-429"><a id="__codelineno-7-429" name="__codelineno-7-429" href="#__codelineno-7-429"></a>                        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
</span><span id="__span-7-430"><a id="__codelineno-7-430" name="__codelineno-7-430" href="#__codelineno-7-430"></a>                            <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Account temporarily locked due to failed login attempts&#39;</span>
</span><span id="__span-7-431"><a id="__codelineno-7-431" name="__codelineno-7-431" href="#__codelineno-7-431"></a>                        <span class="p">}),</span> <span class="mi">423</span>
</span><span id="__span-7-432"><a id="__codelineno-7-432" name="__codelineno-7-432" href="#__codelineno-7-432"></a>
</span><span id="__span-7-433"><a id="__codelineno-7-433" name="__codelineno-7-433" href="#__codelineno-7-433"></a>                <span class="c1"># Verify password</span>
</span><span id="__span-7-434"><a id="__codelineno-7-434" name="__codelineno-7-434" href="#__codelineno-7-434"></a>                <span class="k">if</span> <span class="n">check_password_hash</span><span class="p">(</span><span class="n">user</span><span class="p">[</span><span class="s1">&#39;password_hash&#39;</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">user</span><span class="p">[</span><span class="s1">&#39;salt&#39;</span><span class="p">]):</span>
</span><span id="__span-7-435"><a id="__codelineno-7-435" name="__codelineno-7-435" href="#__codelineno-7-435"></a>                    <span class="c1"># Reset failed attempts on successful login</span>
</span><span id="__span-7-436"><a id="__codelineno-7-436" name="__codelineno-7-436" href="#__codelineno-7-436"></a>                    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;</span>
</span><span id="__span-7-437"><a id="__codelineno-7-437" name="__codelineno-7-437" href="#__codelineno-7-437"></a><span class="s1">                        UPDATE users SET failed_login_attempts = 0, last_failed_login = NULL </span>
</span><span id="__span-7-438"><a id="__codelineno-7-438" name="__codelineno-7-438" href="#__codelineno-7-438"></a><span class="s1">                        WHERE id = ?</span>
</span><span id="__span-7-439"><a id="__codelineno-7-439" name="__codelineno-7-439" href="#__codelineno-7-439"></a><span class="s1">                    &#39;&#39;&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">user</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],))</span>
</span><span id="__span-7-440"><a id="__codelineno-7-440" name="__codelineno-7-440" href="#__codelineno-7-440"></a>                    <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span><span id="__span-7-441"><a id="__codelineno-7-441" name="__codelineno-7-441" href="#__codelineno-7-441"></a>
</span><span id="__span-7-442"><a id="__codelineno-7-442" name="__codelineno-7-442" href="#__codelineno-7-442"></a>                    <span class="c1"># Generate JWT token</span>
</span><span id="__span-7-443"><a id="__codelineno-7-443" name="__codelineno-7-443" href="#__codelineno-7-443"></a>                    <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jwt_manager</span><span class="o">.</span><span class="n">generate_token</span><span class="p">(</span>
</span><span id="__span-7-444"><a id="__codelineno-7-444" name="__codelineno-7-444" href="#__codelineno-7-444"></a>                        <span class="n">user_id</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">user</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]),</span>
</span><span id="__span-7-445"><a id="__codelineno-7-445" name="__codelineno-7-445" href="#__codelineno-7-445"></a>                        <span class="n">permissions</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;read&#39;</span><span class="p">,</span> <span class="s1">&#39;write&#39;</span><span class="p">]</span>
</span><span id="__span-7-446"><a id="__codelineno-7-446" name="__codelineno-7-446" href="#__codelineno-7-446"></a>                    <span class="p">)</span>
</span><span id="__span-7-447"><a id="__codelineno-7-447" name="__codelineno-7-447" href="#__codelineno-7-447"></a>
</span><span id="__span-7-448"><a id="__codelineno-7-448" name="__codelineno-7-448" href="#__codelineno-7-448"></a>                    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
</span><span id="__span-7-449"><a id="__codelineno-7-449" name="__codelineno-7-449" href="#__codelineno-7-449"></a>                        <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;Login successful&#39;</span><span class="p">,</span>
</span><span id="__span-7-450"><a id="__codelineno-7-450" name="__codelineno-7-450" href="#__codelineno-7-450"></a>                        <span class="s1">&#39;token&#39;</span><span class="p">:</span> <span class="n">token</span><span class="p">,</span>
</span><span id="__span-7-451"><a id="__codelineno-7-451" name="__codelineno-7-451" href="#__codelineno-7-451"></a>                        <span class="s1">&#39;user&#39;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-7-452"><a id="__codelineno-7-452" name="__codelineno-7-452" href="#__codelineno-7-452"></a>                            <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">user</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span>
</span><span id="__span-7-453"><a id="__codelineno-7-453" name="__codelineno-7-453" href="#__codelineno-7-453"></a>                            <span class="s1">&#39;username&#39;</span><span class="p">:</span> <span class="n">user</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">],</span>
</span><span id="__span-7-454"><a id="__codelineno-7-454" name="__codelineno-7-454" href="#__codelineno-7-454"></a>                            <span class="s1">&#39;email&#39;</span><span class="p">:</span> <span class="n">user</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">]</span>
</span><span id="__span-7-455"><a id="__codelineno-7-455" name="__codelineno-7-455" href="#__codelineno-7-455"></a>                        <span class="p">}</span>
</span><span id="__span-7-456"><a id="__codelineno-7-456" name="__codelineno-7-456" href="#__codelineno-7-456"></a>                    <span class="p">}),</span> <span class="mi">200</span>
</span><span id="__span-7-457"><a id="__codelineno-7-457" name="__codelineno-7-457" href="#__codelineno-7-457"></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="__span-7-458"><a id="__codelineno-7-458" name="__codelineno-7-458" href="#__codelineno-7-458"></a>                    <span class="c1"># Increment failed login attempts</span>
</span><span id="__span-7-459"><a id="__codelineno-7-459" name="__codelineno-7-459" href="#__codelineno-7-459"></a>                    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;</span>
</span><span id="__span-7-460"><a id="__codelineno-7-460" name="__codelineno-7-460" href="#__codelineno-7-460"></a><span class="s1">                        UPDATE users SET </span>
</span><span id="__span-7-461"><a id="__codelineno-7-461" name="__codelineno-7-461" href="#__codelineno-7-461"></a><span class="s1">                            failed_login_attempts = failed_login_attempts + 1,</span>
</span><span id="__span-7-462"><a id="__codelineno-7-462" name="__codelineno-7-462" href="#__codelineno-7-462"></a><span class="s1">                            last_failed_login = CURRENT_TIMESTAMP</span>
</span><span id="__span-7-463"><a id="__codelineno-7-463" name="__codelineno-7-463" href="#__codelineno-7-463"></a><span class="s1">                        WHERE id = ?</span>
</span><span id="__span-7-464"><a id="__codelineno-7-464" name="__codelineno-7-464" href="#__codelineno-7-464"></a><span class="s1">                    &#39;&#39;&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">user</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],))</span>
</span><span id="__span-7-465"><a id="__codelineno-7-465" name="__codelineno-7-465" href="#__codelineno-7-465"></a>                    <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span><span id="__span-7-466"><a id="__codelineno-7-466" name="__codelineno-7-466" href="#__codelineno-7-466"></a>
</span><span id="__span-7-467"><a id="__codelineno-7-467" name="__codelineno-7-467" href="#__codelineno-7-467"></a>                    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Invalid credentials&#39;</span><span class="p">}),</span> <span class="mi">401</span>
</span><span id="__span-7-468"><a id="__codelineno-7-468" name="__codelineno-7-468" href="#__codelineno-7-468"></a>
</span><span id="__span-7-469"><a id="__codelineno-7-469" name="__codelineno-7-469" href="#__codelineno-7-469"></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-7-470"><a id="__codelineno-7-470" name="__codelineno-7-470" href="#__codelineno-7-470"></a>                <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Login failed&#39;</span><span class="p">}),</span> <span class="mi">500</span>
</span><span id="__span-7-471"><a id="__codelineno-7-471" name="__codelineno-7-471" href="#__codelineno-7-471"></a>
</span><span id="__span-7-472"><a id="__codelineno-7-472" name="__codelineno-7-472" href="#__codelineno-7-472"></a>            <span class="k">finally</span><span class="p">:</span>
</span><span id="__span-7-473"><a id="__codelineno-7-473" name="__codelineno-7-473" href="#__codelineno-7-473"></a>                <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="__span-7-474"><a id="__codelineno-7-474" name="__codelineno-7-474" href="#__codelineno-7-474"></a>
</span><span id="__span-7-475"><a id="__codelineno-7-475" name="__codelineno-7-475" href="#__codelineno-7-475"></a>        <span class="c1"># Task management endpoints</span>
</span><span id="__span-7-476"><a id="__codelineno-7-476" name="__codelineno-7-476" href="#__codelineno-7-476"></a>        <span class="nd">@self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/tasks&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;OPTIONS&#39;</span><span class="p">])</span>
</span><span id="__span-7-477"><a id="__codelineno-7-477" name="__codelineno-7-477" href="#__codelineno-7-477"></a>        <span class="nd">@self</span><span class="o">.</span><span class="n">require_cors</span><span class="p">()</span>
</span><span id="__span-7-478"><a id="__codelineno-7-478" name="__codelineno-7-478" href="#__codelineno-7-478"></a>        <span class="nd">@self</span><span class="o">.</span><span class="n">require_auth</span><span class="p">([</span><span class="s1">&#39;read&#39;</span><span class="p">])</span>
</span><span id="__span-7-479"><a id="__codelineno-7-479" name="__codelineno-7-479" href="#__codelineno-7-479"></a>        <span class="k">def</span><span class="w"> </span><span class="nf">get_tasks</span><span class="p">():</span>
</span><span id="__span-7-480"><a id="__codelineno-7-480" name="__codelineno-7-480" href="#__codelineno-7-480"></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;Get user&#39;s tasks with pagination&quot;&quot;&quot;</span>
</span><span id="__span-7-481"><a id="__codelineno-7-481" name="__codelineno-7-481" href="#__codelineno-7-481"></a>            <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;OPTIONS&#39;</span><span class="p">:</span>
</span><span id="__span-7-482"><a id="__codelineno-7-482" name="__codelineno-7-482" href="#__codelineno-7-482"></a>                <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">200</span>
</span><span id="__span-7-483"><a id="__codelineno-7-483" name="__codelineno-7-483" href="#__codelineno-7-483"></a>
</span><span id="__span-7-484"><a id="__codelineno-7-484" name="__codelineno-7-484" href="#__codelineno-7-484"></a>            <span class="c1"># Get pagination parameters</span>
</span><span id="__span-7-485"><a id="__codelineno-7-485" name="__codelineno-7-485" href="#__codelineno-7-485"></a>            <span class="n">page</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;page&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span><span id="__span-7-486"><a id="__codelineno-7-486" name="__codelineno-7-486" href="#__codelineno-7-486"></a>            <span class="n">limit</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;limit&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">),</span> <span class="mi">100</span><span class="p">)</span>  <span class="c1"># Cap at 100</span>
</span><span id="__span-7-487"><a id="__codelineno-7-487" name="__codelineno-7-487" href="#__codelineno-7-487"></a>            <span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">page</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">limit</span>
</span><span id="__span-7-488"><a id="__codelineno-7-488" name="__codelineno-7-488" href="#__codelineno-7-488"></a>
</span><span id="__span-7-489"><a id="__codelineno-7-489" name="__codelineno-7-489" href="#__codelineno-7-489"></a>            <span class="c1"># Get filter parameters</span>
</span><span id="__span-7-490"><a id="__codelineno-7-490" name="__codelineno-7-490" href="#__codelineno-7-490"></a>            <span class="n">status_filter</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
</span><span id="__span-7-491"><a id="__codelineno-7-491" name="__codelineno-7-491" href="#__codelineno-7-491"></a>            <span class="n">priority_filter</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;priority&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span><span id="__span-7-492"><a id="__codelineno-7-492" name="__codelineno-7-492" href="#__codelineno-7-492"></a>
</span><span id="__span-7-493"><a id="__codelineno-7-493" name="__codelineno-7-493" href="#__codelineno-7-493"></a>            <span class="n">conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_db_connection</span><span class="p">()</span>
</span><span id="__span-7-494"><a id="__codelineno-7-494" name="__codelineno-7-494" href="#__codelineno-7-494"></a>            <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
</span><span id="__span-7-495"><a id="__codelineno-7-495" name="__codelineno-7-495" href="#__codelineno-7-495"></a>
</span><span id="__span-7-496"><a id="__codelineno-7-496" name="__codelineno-7-496" href="#__codelineno-7-496"></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="__span-7-497"><a id="__codelineno-7-497" name="__codelineno-7-497" href="#__codelineno-7-497"></a>                <span class="c1"># Build query with filters</span>
</span><span id="__span-7-498"><a id="__codelineno-7-498" name="__codelineno-7-498" href="#__codelineno-7-498"></a>                <span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;</span>
</span><span id="__span-7-499"><a id="__codelineno-7-499" name="__codelineno-7-499" href="#__codelineno-7-499"></a><span class="s1">                    SELECT id, title, description, status, priority, created_at, updated_at</span>
</span><span id="__span-7-500"><a id="__codelineno-7-500" name="__codelineno-7-500" href="#__codelineno-7-500"></a><span class="s1">                    FROM tasks WHERE user_id = ?</span>
</span><span id="__span-7-501"><a id="__codelineno-7-501" name="__codelineno-7-501" href="#__codelineno-7-501"></a><span class="s1">                &#39;&#39;&#39;</span>
</span><span id="__span-7-502"><a id="__codelineno-7-502" name="__codelineno-7-502" href="#__codelineno-7-502"></a>                <span class="n">params</span> <span class="o">=</span> <span class="p">[</span><span class="n">g</span><span class="o">.</span><span class="n">current_user</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]]</span>
</span><span id="__span-7-503"><a id="__codelineno-7-503" name="__codelineno-7-503" href="#__codelineno-7-503"></a>
</span><span id="__span-7-504"><a id="__codelineno-7-504" name="__codelineno-7-504" href="#__codelineno-7-504"></a>                <span class="k">if</span> <span class="n">status_filter</span><span class="p">:</span>
</span><span id="__span-7-505"><a id="__codelineno-7-505" name="__codelineno-7-505" href="#__codelineno-7-505"></a>                    <span class="n">query</span> <span class="o">+=</span> <span class="s1">&#39; AND status = ?&#39;</span>
</span><span id="__span-7-506"><a id="__codelineno-7-506" name="__codelineno-7-506" href="#__codelineno-7-506"></a>                    <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">status_filter</span><span class="p">)</span>
</span><span id="__span-7-507"><a id="__codelineno-7-507" name="__codelineno-7-507" href="#__codelineno-7-507"></a>
</span><span id="__span-7-508"><a id="__codelineno-7-508" name="__codelineno-7-508" href="#__codelineno-7-508"></a>                <span class="k">if</span> <span class="n">priority_filter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-7-509"><a id="__codelineno-7-509" name="__codelineno-7-509" href="#__codelineno-7-509"></a>                    <span class="n">query</span> <span class="o">+=</span> <span class="s1">&#39; AND priority = ?&#39;</span>
</span><span id="__span-7-510"><a id="__codelineno-7-510" name="__codelineno-7-510" href="#__codelineno-7-510"></a>                    <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">priority_filter</span><span class="p">)</span>
</span><span id="__span-7-511"><a id="__codelineno-7-511" name="__codelineno-7-511" href="#__codelineno-7-511"></a>
</span><span id="__span-7-512"><a id="__codelineno-7-512" name="__codelineno-7-512" href="#__codelineno-7-512"></a>                <span class="n">query</span> <span class="o">+=</span> <span class="s1">&#39; ORDER BY created_at DESC LIMIT ? OFFSET ?&#39;</span>
</span><span id="__span-7-513"><a id="__codelineno-7-513" name="__codelineno-7-513" href="#__codelineno-7-513"></a>                <span class="n">params</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">limit</span><span class="p">,</span> <span class="n">offset</span><span class="p">])</span>
</span><span id="__span-7-514"><a id="__codelineno-7-514" name="__codelineno-7-514" href="#__codelineno-7-514"></a>
</span><span id="__span-7-515"><a id="__codelineno-7-515" name="__codelineno-7-515" href="#__codelineno-7-515"></a>                <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
</span><span id="__span-7-516"><a id="__codelineno-7-516" name="__codelineno-7-516" href="#__codelineno-7-516"></a>                <span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span><span class="nb">dict</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()]</span>
</span><span id="__span-7-517"><a id="__codelineno-7-517" name="__codelineno-7-517" href="#__codelineno-7-517"></a>
</span><span id="__span-7-518"><a id="__codelineno-7-518" name="__codelineno-7-518" href="#__codelineno-7-518"></a>                <span class="c1"># Get total count for pagination</span>
</span><span id="__span-7-519"><a id="__codelineno-7-519" name="__codelineno-7-519" href="#__codelineno-7-519"></a>                <span class="n">count_query</span> <span class="o">=</span> <span class="s1">&#39;SELECT COUNT(*) FROM tasks WHERE user_id = ?&#39;</span>
</span><span id="__span-7-520"><a id="__codelineno-7-520" name="__codelineno-7-520" href="#__codelineno-7-520"></a>                <span class="n">count_params</span> <span class="o">=</span> <span class="p">[</span><span class="n">g</span><span class="o">.</span><span class="n">current_user</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]]</span>
</span><span id="__span-7-521"><a id="__codelineno-7-521" name="__codelineno-7-521" href="#__codelineno-7-521"></a>
</span><span id="__span-7-522"><a id="__codelineno-7-522" name="__codelineno-7-522" href="#__codelineno-7-522"></a>                <span class="k">if</span> <span class="n">status_filter</span><span class="p">:</span>
</span><span id="__span-7-523"><a id="__codelineno-7-523" name="__codelineno-7-523" href="#__codelineno-7-523"></a>                    <span class="n">count_query</span> <span class="o">+=</span> <span class="s1">&#39; AND status = ?&#39;</span>
</span><span id="__span-7-524"><a id="__codelineno-7-524" name="__codelineno-7-524" href="#__codelineno-7-524"></a>                    <span class="n">count_params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">status_filter</span><span class="p">)</span>
</span><span id="__span-7-525"><a id="__codelineno-7-525" name="__codelineno-7-525" href="#__codelineno-7-525"></a>
</span><span id="__span-7-526"><a id="__codelineno-7-526" name="__codelineno-7-526" href="#__codelineno-7-526"></a>                <span class="k">if</span> <span class="n">priority_filter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-7-527"><a id="__codelineno-7-527" name="__codelineno-7-527" href="#__codelineno-7-527"></a>                    <span class="n">count_query</span> <span class="o">+=</span> <span class="s1">&#39; AND priority = ?&#39;</span>
</span><span id="__span-7-528"><a id="__codelineno-7-528" name="__codelineno-7-528" href="#__codelineno-7-528"></a>                    <span class="n">count_params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">priority_filter</span><span class="p">)</span>
</span><span id="__span-7-529"><a id="__codelineno-7-529" name="__codelineno-7-529" href="#__codelineno-7-529"></a>
</span><span id="__span-7-530"><a id="__codelineno-7-530" name="__codelineno-7-530" href="#__codelineno-7-530"></a>                <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">count_query</span><span class="p">,</span> <span class="n">count_params</span><span class="p">)</span>
</span><span id="__span-7-531"><a id="__codelineno-7-531" name="__codelineno-7-531" href="#__codelineno-7-531"></a>                <span class="n">total_count</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="__span-7-532"><a id="__codelineno-7-532" name="__codelineno-7-532" href="#__codelineno-7-532"></a>
</span><span id="__span-7-533"><a id="__codelineno-7-533" name="__codelineno-7-533" href="#__codelineno-7-533"></a>                <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
</span><span id="__span-7-534"><a id="__codelineno-7-534" name="__codelineno-7-534" href="#__codelineno-7-534"></a>                    <span class="s1">&#39;tasks&#39;</span><span class="p">:</span> <span class="n">tasks</span><span class="p">,</span>
</span><span id="__span-7-535"><a id="__codelineno-7-535" name="__codelineno-7-535" href="#__codelineno-7-535"></a>                    <span class="s1">&#39;pagination&#39;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-7-536"><a id="__codelineno-7-536" name="__codelineno-7-536" href="#__codelineno-7-536"></a>                        <span class="s1">&#39;page&#39;</span><span class="p">:</span> <span class="n">page</span><span class="p">,</span>
</span><span id="__span-7-537"><a id="__codelineno-7-537" name="__codelineno-7-537" href="#__codelineno-7-537"></a>                        <span class="s1">&#39;limit&#39;</span><span class="p">:</span> <span class="n">limit</span><span class="p">,</span>
</span><span id="__span-7-538"><a id="__codelineno-7-538" name="__codelineno-7-538" href="#__codelineno-7-538"></a>                        <span class="s1">&#39;total&#39;</span><span class="p">:</span> <span class="n">total_count</span><span class="p">,</span>
</span><span id="__span-7-539"><a id="__codelineno-7-539" name="__codelineno-7-539" href="#__codelineno-7-539"></a>                        <span class="s1">&#39;pages&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">total_count</span> <span class="o">+</span> <span class="n">limit</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">limit</span>
</span><span id="__span-7-540"><a id="__codelineno-7-540" name="__codelineno-7-540" href="#__codelineno-7-540"></a>                    <span class="p">}</span>
</span><span id="__span-7-541"><a id="__codelineno-7-541" name="__codelineno-7-541" href="#__codelineno-7-541"></a>                <span class="p">}),</span> <span class="mi">200</span>
</span><span id="__span-7-542"><a id="__codelineno-7-542" name="__codelineno-7-542" href="#__codelineno-7-542"></a>
</span><span id="__span-7-543"><a id="__codelineno-7-543" name="__codelineno-7-543" href="#__codelineno-7-543"></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-7-544"><a id="__codelineno-7-544" name="__codelineno-7-544" href="#__codelineno-7-544"></a>                <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Failed to fetch tasks&#39;</span><span class="p">}),</span> <span class="mi">500</span>
</span><span id="__span-7-545"><a id="__codelineno-7-545" name="__codelineno-7-545" href="#__codelineno-7-545"></a>
</span><span id="__span-7-546"><a id="__codelineno-7-546" name="__codelineno-7-546" href="#__codelineno-7-546"></a>            <span class="k">finally</span><span class="p">:</span>
</span><span id="__span-7-547"><a id="__codelineno-7-547" name="__codelineno-7-547" href="#__codelineno-7-547"></a>                <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="__span-7-548"><a id="__codelineno-7-548" name="__codelineno-7-548" href="#__codelineno-7-548"></a>
</span><span id="__span-7-549"><a id="__codelineno-7-549" name="__codelineno-7-549" href="#__codelineno-7-549"></a>        <span class="nd">@self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/tasks&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">,</span> <span class="s1">&#39;OPTIONS&#39;</span><span class="p">])</span>
</span><span id="__span-7-550"><a id="__codelineno-7-550" name="__codelineno-7-550" href="#__codelineno-7-550"></a>        <span class="nd">@self</span><span class="o">.</span><span class="n">require_cors</span><span class="p">()</span>
</span><span id="__span-7-551"><a id="__codelineno-7-551" name="__codelineno-7-551" href="#__codelineno-7-551"></a>        <span class="nd">@self</span><span class="o">.</span><span class="n">require_auth</span><span class="p">([</span><span class="s1">&#39;write&#39;</span><span class="p">])</span>
</span><span id="__span-7-552"><a id="__codelineno-7-552" name="__codelineno-7-552" href="#__codelineno-7-552"></a>        <span class="k">def</span><span class="w"> </span><span class="nf">create_task</span><span class="p">():</span>
</span><span id="__span-7-553"><a id="__codelineno-7-553" name="__codelineno-7-553" href="#__codelineno-7-553"></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;Create a new task&quot;&quot;&quot;</span>
</span><span id="__span-7-554"><a id="__codelineno-7-554" name="__codelineno-7-554" href="#__codelineno-7-554"></a>            <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;OPTIONS&#39;</span><span class="p">:</span>
</span><span id="__span-7-555"><a id="__codelineno-7-555" name="__codelineno-7-555" href="#__codelineno-7-555"></a>                <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">200</span>
</span><span id="__span-7-556"><a id="__codelineno-7-556" name="__codelineno-7-556" href="#__codelineno-7-556"></a>
</span><span id="__span-7-557"><a id="__codelineno-7-557" name="__codelineno-7-557" href="#__codelineno-7-557"></a>            <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>
</span><span id="__span-7-558"><a id="__codelineno-7-558" name="__codelineno-7-558" href="#__codelineno-7-558"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
</span><span id="__span-7-559"><a id="__codelineno-7-559" name="__codelineno-7-559" href="#__codelineno-7-559"></a>                <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Invalid JSON data&#39;</span><span class="p">}),</span> <span class="mi">400</span>
</span><span id="__span-7-560"><a id="__codelineno-7-560" name="__codelineno-7-560" href="#__codelineno-7-560"></a>
</span><span id="__span-7-561"><a id="__codelineno-7-561" name="__codelineno-7-561" href="#__codelineno-7-561"></a>            <span class="c1"># Input validation</span>
</span><span id="__span-7-562"><a id="__codelineno-7-562" name="__codelineno-7-562" href="#__codelineno-7-562"></a>            <span class="n">validation_rules</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-7-563"><a id="__codelineno-7-563" name="__codelineno-7-563" href="#__codelineno-7-563"></a>                <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-7-564"><a id="__codelineno-7-564" name="__codelineno-7-564" href="#__codelineno-7-564"></a>                    <span class="s1">&#39;required&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="__span-7-565"><a id="__codelineno-7-565" name="__codelineno-7-565" href="#__codelineno-7-565"></a>                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="__span-7-566"><a id="__codelineno-7-566" name="__codelineno-7-566" href="#__codelineno-7-566"></a>                    <span class="s1">&#39;min_length&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="__span-7-567"><a id="__codelineno-7-567" name="__codelineno-7-567" href="#__codelineno-7-567"></a>                    <span class="s1">&#39;max_length&#39;</span><span class="p">:</span> <span class="mi">200</span>
</span><span id="__span-7-568"><a id="__codelineno-7-568" name="__codelineno-7-568" href="#__codelineno-7-568"></a>                <span class="p">},</span>
</span><span id="__span-7-569"><a id="__codelineno-7-569" name="__codelineno-7-569" href="#__codelineno-7-569"></a>                <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-7-570"><a id="__codelineno-7-570" name="__codelineno-7-570" href="#__codelineno-7-570"></a>                    <span class="s1">&#39;required&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="__span-7-571"><a id="__codelineno-7-571" name="__codelineno-7-571" href="#__codelineno-7-571"></a>                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="__span-7-572"><a id="__codelineno-7-572" name="__codelineno-7-572" href="#__codelineno-7-572"></a>                    <span class="s1">&#39;max_length&#39;</span><span class="p">:</span> <span class="mi">1000</span>
</span><span id="__span-7-573"><a id="__codelineno-7-573" name="__codelineno-7-573" href="#__codelineno-7-573"></a>                <span class="p">},</span>
</span><span id="__span-7-574"><a id="__codelineno-7-574" name="__codelineno-7-574" href="#__codelineno-7-574"></a>                <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-7-575"><a id="__codelineno-7-575" name="__codelineno-7-575" href="#__codelineno-7-575"></a>                    <span class="s1">&#39;required&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="__span-7-576"><a id="__codelineno-7-576" name="__codelineno-7-576" href="#__codelineno-7-576"></a>                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="__span-7-577"><a id="__codelineno-7-577" name="__codelineno-7-577" href="#__codelineno-7-577"></a>                    <span class="s1">&#39;validator&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">s</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;pending&#39;</span><span class="p">,</span> <span class="s1">&#39;in_progress&#39;</span><span class="p">,</span> <span class="s1">&#39;completed&#39;</span><span class="p">]</span>
</span><span id="__span-7-578"><a id="__codelineno-7-578" name="__codelineno-7-578" href="#__codelineno-7-578"></a>                <span class="p">},</span>
</span><span id="__span-7-579"><a id="__codelineno-7-579" name="__codelineno-7-579" href="#__codelineno-7-579"></a>                <span class="s1">&#39;priority&#39;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-7-580"><a id="__codelineno-7-580" name="__codelineno-7-580" href="#__codelineno-7-580"></a>                    <span class="s1">&#39;required&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="__span-7-581"><a id="__codelineno-7-581" name="__codelineno-7-581" href="#__codelineno-7-581"></a>                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="__span-7-582"><a id="__codelineno-7-582" name="__codelineno-7-582" href="#__codelineno-7-582"></a>                    <span class="s1">&#39;validator&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="mi">1</span> <span class="o">&lt;=</span> <span class="n">p</span> <span class="o">&lt;=</span> <span class="mi">5</span>
</span><span id="__span-7-583"><a id="__codelineno-7-583" name="__codelineno-7-583" href="#__codelineno-7-583"></a>                <span class="p">}</span>
</span><span id="__span-7-584"><a id="__codelineno-7-584" name="__codelineno-7-584" href="#__codelineno-7-584"></a>            <span class="p">}</span>
</span><span id="__span-7-585"><a id="__codelineno-7-585" name="__codelineno-7-585" href="#__codelineno-7-585"></a>
</span><span id="__span-7-586"><a id="__codelineno-7-586" name="__codelineno-7-586" href="#__codelineno-7-586"></a>            <span class="n">is_valid</span><span class="p">,</span> <span class="n">errors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_input</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">validation_rules</span><span class="p">)</span>
</span><span id="__span-7-587"><a id="__codelineno-7-587" name="__codelineno-7-587" href="#__codelineno-7-587"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_valid</span><span class="p">:</span>
</span><span id="__span-7-588"><a id="__codelineno-7-588" name="__codelineno-7-588" href="#__codelineno-7-588"></a>                <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Validation failed&#39;</span><span class="p">,</span> <span class="s1">&#39;details&#39;</span><span class="p">:</span> <span class="n">errors</span><span class="p">}),</span> <span class="mi">400</span>
</span><span id="__span-7-589"><a id="__codelineno-7-589" name="__codelineno-7-589" href="#__codelineno-7-589"></a>
</span><span id="__span-7-590"><a id="__codelineno-7-590" name="__codelineno-7-590" href="#__codelineno-7-590"></a>            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sanitize_input</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span id="__span-7-591"><a id="__codelineno-7-591" name="__codelineno-7-591" href="#__codelineno-7-591"></a>
</span><span id="__span-7-592"><a id="__codelineno-7-592" name="__codelineno-7-592" href="#__codelineno-7-592"></a>            <span class="n">conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_db_connection</span><span class="p">()</span>
</span><span id="__span-7-593"><a id="__codelineno-7-593" name="__codelineno-7-593" href="#__codelineno-7-593"></a>            <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
</span><span id="__span-7-594"><a id="__codelineno-7-594" name="__codelineno-7-594" href="#__codelineno-7-594"></a>
</span><span id="__span-7-595"><a id="__codelineno-7-595" name="__codelineno-7-595" href="#__codelineno-7-595"></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="__span-7-596"><a id="__codelineno-7-596" name="__codelineno-7-596" href="#__codelineno-7-596"></a>                <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;</span>
</span><span id="__span-7-597"><a id="__codelineno-7-597" name="__codelineno-7-597" href="#__codelineno-7-597"></a><span class="s1">                    INSERT INTO tasks (user_id, title, description, status, priority)</span>
</span><span id="__span-7-598"><a id="__codelineno-7-598" name="__codelineno-7-598" href="#__codelineno-7-598"></a><span class="s1">                    VALUES (?, ?, ?, ?, ?)</span>
</span><span id="__span-7-599"><a id="__codelineno-7-599" name="__codelineno-7-599" href="#__codelineno-7-599"></a><span class="s1">                &#39;&#39;&#39;</span><span class="p">,</span> <span class="p">(</span>
</span><span id="__span-7-600"><a id="__codelineno-7-600" name="__codelineno-7-600" href="#__codelineno-7-600"></a>                    <span class="n">g</span><span class="o">.</span><span class="n">current_user</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">],</span>
</span><span id="__span-7-601"><a id="__codelineno-7-601" name="__codelineno-7-601" href="#__codelineno-7-601"></a>                    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">],</span>
</span><span id="__span-7-602"><a id="__codelineno-7-602" name="__codelineno-7-602" href="#__codelineno-7-602"></a>                    <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
</span><span id="__span-7-603"><a id="__codelineno-7-603" name="__codelineno-7-603" href="#__codelineno-7-603"></a>                    <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">,</span> <span class="s1">&#39;pending&#39;</span><span class="p">),</span>
</span><span id="__span-7-604"><a id="__codelineno-7-604" name="__codelineno-7-604" href="#__codelineno-7-604"></a>                    <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;priority&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="__span-7-605"><a id="__codelineno-7-605" name="__codelineno-7-605" href="#__codelineno-7-605"></a>                <span class="p">))</span>
</span><span id="__span-7-606"><a id="__codelineno-7-606" name="__codelineno-7-606" href="#__codelineno-7-606"></a>
</span><span id="__span-7-607"><a id="__codelineno-7-607" name="__codelineno-7-607" href="#__codelineno-7-607"></a>                <span class="n">task_id</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">lastrowid</span>
</span><span id="__span-7-608"><a id="__codelineno-7-608" name="__codelineno-7-608" href="#__codelineno-7-608"></a>                <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span><span id="__span-7-609"><a id="__codelineno-7-609" name="__codelineno-7-609" href="#__codelineno-7-609"></a>
</span><span id="__span-7-610"><a id="__codelineno-7-610" name="__codelineno-7-610" href="#__codelineno-7-610"></a>                <span class="c1"># Fetch the created task</span>
</span><span id="__span-7-611"><a id="__codelineno-7-611" name="__codelineno-7-611" href="#__codelineno-7-611"></a>                <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;</span>
</span><span id="__span-7-612"><a id="__codelineno-7-612" name="__codelineno-7-612" href="#__codelineno-7-612"></a><span class="s1">                    SELECT id, title, description, status, priority, created_at, updated_at</span>
</span><span id="__span-7-613"><a id="__codelineno-7-613" name="__codelineno-7-613" href="#__codelineno-7-613"></a><span class="s1">                    FROM tasks WHERE id = ?</span>
</span><span id="__span-7-614"><a id="__codelineno-7-614" name="__codelineno-7-614" href="#__codelineno-7-614"></a><span class="s1">                &#39;&#39;&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">task_id</span><span class="p">,))</span>
</span><span id="__span-7-615"><a id="__codelineno-7-615" name="__codelineno-7-615" href="#__codelineno-7-615"></a>
</span><span id="__span-7-616"><a id="__codelineno-7-616" name="__codelineno-7-616" href="#__codelineno-7-616"></a>                <span class="n">task</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">())</span>
</span><span id="__span-7-617"><a id="__codelineno-7-617" name="__codelineno-7-617" href="#__codelineno-7-617"></a>
</span><span id="__span-7-618"><a id="__codelineno-7-618" name="__codelineno-7-618" href="#__codelineno-7-618"></a>                <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
</span><span id="__span-7-619"><a id="__codelineno-7-619" name="__codelineno-7-619" href="#__codelineno-7-619"></a>                    <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;Task created successfully&#39;</span><span class="p">,</span>
</span><span id="__span-7-620"><a id="__codelineno-7-620" name="__codelineno-7-620" href="#__codelineno-7-620"></a>                    <span class="s1">&#39;task&#39;</span><span class="p">:</span> <span class="n">task</span>
</span><span id="__span-7-621"><a id="__codelineno-7-621" name="__codelineno-7-621" href="#__codelineno-7-621"></a>                <span class="p">}),</span> <span class="mi">201</span>
</span><span id="__span-7-622"><a id="__codelineno-7-622" name="__codelineno-7-622" href="#__codelineno-7-622"></a>
</span><span id="__span-7-623"><a id="__codelineno-7-623" name="__codelineno-7-623" href="#__codelineno-7-623"></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-7-624"><a id="__codelineno-7-624" name="__codelineno-7-624" href="#__codelineno-7-624"></a>                <span class="n">conn</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
</span><span id="__span-7-625"><a id="__codelineno-7-625" name="__codelineno-7-625" href="#__codelineno-7-625"></a>                <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Failed to create task&#39;</span><span class="p">}),</span> <span class="mi">500</span>
</span><span id="__span-7-626"><a id="__codelineno-7-626" name="__codelineno-7-626" href="#__codelineno-7-626"></a>
</span><span id="__span-7-627"><a id="__codelineno-7-627" name="__codelineno-7-627" href="#__codelineno-7-627"></a>            <span class="k">finally</span><span class="p">:</span>
</span><span id="__span-7-628"><a id="__codelineno-7-628" name="__codelineno-7-628" href="#__codelineno-7-628"></a>                <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="__span-7-629"><a id="__codelineno-7-629" name="__codelineno-7-629" href="#__codelineno-7-629"></a>
</span><span id="__span-7-630"><a id="__codelineno-7-630" name="__codelineno-7-630" href="#__codelineno-7-630"></a>        <span class="nd">@self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/tasks/&lt;int:task_id&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;PUT&#39;</span><span class="p">,</span> <span class="s1">&#39;OPTIONS&#39;</span><span class="p">])</span>
</span><span id="__span-7-631"><a id="__codelineno-7-631" name="__codelineno-7-631" href="#__codelineno-7-631"></a>        <span class="nd">@self</span><span class="o">.</span><span class="n">require_cors</span><span class="p">()</span>
</span><span id="__span-7-632"><a id="__codelineno-7-632" name="__codelineno-7-632" href="#__codelineno-7-632"></a>        <span class="nd">@self</span><span class="o">.</span><span class="n">require_auth</span><span class="p">([</span><span class="s1">&#39;write&#39;</span><span class="p">])</span>
</span><span id="__span-7-633"><a id="__codelineno-7-633" name="__codelineno-7-633" href="#__codelineno-7-633"></a>        <span class="k">def</span><span class="w"> </span><span class="nf">update_task</span><span class="p">(</span><span class="n">task_id</span><span class="p">):</span>
</span><span id="__span-7-634"><a id="__codelineno-7-634" name="__codelineno-7-634" href="#__codelineno-7-634"></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;Update an existing task&quot;&quot;&quot;</span>
</span><span id="__span-7-635"><a id="__codelineno-7-635" name="__codelineno-7-635" href="#__codelineno-7-635"></a>            <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;OPTIONS&#39;</span><span class="p">:</span>
</span><span id="__span-7-636"><a id="__codelineno-7-636" name="__codelineno-7-636" href="#__codelineno-7-636"></a>                <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">200</span>
</span><span id="__span-7-637"><a id="__codelineno-7-637" name="__codelineno-7-637" href="#__codelineno-7-637"></a>
</span><span id="__span-7-638"><a id="__codelineno-7-638" name="__codelineno-7-638" href="#__codelineno-7-638"></a>            <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>
</span><span id="__span-7-639"><a id="__codelineno-7-639" name="__codelineno-7-639" href="#__codelineno-7-639"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
</span><span id="__span-7-640"><a id="__codelineno-7-640" name="__codelineno-7-640" href="#__codelineno-7-640"></a>                <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Invalid JSON data&#39;</span><span class="p">}),</span> <span class="mi">400</span>
</span><span id="__span-7-641"><a id="__codelineno-7-641" name="__codelineno-7-641" href="#__codelineno-7-641"></a>
</span><span id="__span-7-642"><a id="__codelineno-7-642" name="__codelineno-7-642" href="#__codelineno-7-642"></a>            <span class="c1"># Input validation (same as create)</span>
</span><span id="__span-7-643"><a id="__codelineno-7-643" name="__codelineno-7-643" href="#__codelineno-7-643"></a>            <span class="n">validation_rules</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-7-644"><a id="__codelineno-7-644" name="__codelineno-7-644" href="#__codelineno-7-644"></a>                <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-7-645"><a id="__codelineno-7-645" name="__codelineno-7-645" href="#__codelineno-7-645"></a>                    <span class="s1">&#39;required&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="__span-7-646"><a id="__codelineno-7-646" name="__codelineno-7-646" href="#__codelineno-7-646"></a>                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="__span-7-647"><a id="__codelineno-7-647" name="__codelineno-7-647" href="#__codelineno-7-647"></a>                    <span class="s1">&#39;min_length&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="__span-7-648"><a id="__codelineno-7-648" name="__codelineno-7-648" href="#__codelineno-7-648"></a>                    <span class="s1">&#39;max_length&#39;</span><span class="p">:</span> <span class="mi">200</span>
</span><span id="__span-7-649"><a id="__codelineno-7-649" name="__codelineno-7-649" href="#__codelineno-7-649"></a>                <span class="p">},</span>
</span><span id="__span-7-650"><a id="__codelineno-7-650" name="__codelineno-7-650" href="#__codelineno-7-650"></a>                <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-7-651"><a id="__codelineno-7-651" name="__codelineno-7-651" href="#__codelineno-7-651"></a>                    <span class="s1">&#39;required&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="__span-7-652"><a id="__codelineno-7-652" name="__codelineno-7-652" href="#__codelineno-7-652"></a>                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="__span-7-653"><a id="__codelineno-7-653" name="__codelineno-7-653" href="#__codelineno-7-653"></a>                    <span class="s1">&#39;max_length&#39;</span><span class="p">:</span> <span class="mi">1000</span>
</span><span id="__span-7-654"><a id="__codelineno-7-654" name="__codelineno-7-654" href="#__codelineno-7-654"></a>                <span class="p">},</span>
</span><span id="__span-7-655"><a id="__codelineno-7-655" name="__codelineno-7-655" href="#__codelineno-7-655"></a>                <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-7-656"><a id="__codelineno-7-656" name="__codelineno-7-656" href="#__codelineno-7-656"></a>                    <span class="s1">&#39;required&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="__span-7-657"><a id="__codelineno-7-657" name="__codelineno-7-657" href="#__codelineno-7-657"></a>                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="__span-7-658"><a id="__codelineno-7-658" name="__codelineno-7-658" href="#__codelineno-7-658"></a>                    <span class="s1">&#39;validator&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">s</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;pending&#39;</span><span class="p">,</span> <span class="s1">&#39;in_progress&#39;</span><span class="p">,</span> <span class="s1">&#39;completed&#39;</span><span class="p">]</span>
</span><span id="__span-7-659"><a id="__codelineno-7-659" name="__codelineno-7-659" href="#__codelineno-7-659"></a>                <span class="p">},</span>
</span><span id="__span-7-660"><a id="__codelineno-7-660" name="__codelineno-7-660" href="#__codelineno-7-660"></a>                <span class="s1">&#39;priority&#39;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-7-661"><a id="__codelineno-7-661" name="__codelineno-7-661" href="#__codelineno-7-661"></a>                    <span class="s1">&#39;required&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="__span-7-662"><a id="__codelineno-7-662" name="__codelineno-7-662" href="#__codelineno-7-662"></a>                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="__span-7-663"><a id="__codelineno-7-663" name="__codelineno-7-663" href="#__codelineno-7-663"></a>                    <span class="s1">&#39;validator&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="mi">1</span> <span class="o">&lt;=</span> <span class="n">p</span> <span class="o">&lt;=</span> <span class="mi">5</span>
</span><span id="__span-7-664"><a id="__codelineno-7-664" name="__codelineno-7-664" href="#__codelineno-7-664"></a>                <span class="p">}</span>
</span><span id="__span-7-665"><a id="__codelineno-7-665" name="__codelineno-7-665" href="#__codelineno-7-665"></a>            <span class="p">}</span>
</span><span id="__span-7-666"><a id="__codelineno-7-666" name="__codelineno-7-666" href="#__codelineno-7-666"></a>
</span><span id="__span-7-667"><a id="__codelineno-7-667" name="__codelineno-7-667" href="#__codelineno-7-667"></a>            <span class="n">is_valid</span><span class="p">,</span> <span class="n">errors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_input</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">validation_rules</span><span class="p">)</span>
</span><span id="__span-7-668"><a id="__codelineno-7-668" name="__codelineno-7-668" href="#__codelineno-7-668"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_valid</span><span class="p">:</span>
</span><span id="__span-7-669"><a id="__codelineno-7-669" name="__codelineno-7-669" href="#__codelineno-7-669"></a>                <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Validation failed&#39;</span><span class="p">,</span> <span class="s1">&#39;details&#39;</span><span class="p">:</span> <span class="n">errors</span><span class="p">}),</span> <span class="mi">400</span>
</span><span id="__span-7-670"><a id="__codelineno-7-670" name="__codelineno-7-670" href="#__codelineno-7-670"></a>
</span><span id="__span-7-671"><a id="__codelineno-7-671" name="__codelineno-7-671" href="#__codelineno-7-671"></a>            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sanitize_input</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span id="__span-7-672"><a id="__codelineno-7-672" name="__codelineno-7-672" href="#__codelineno-7-672"></a>
</span><span id="__span-7-673"><a id="__codelineno-7-673" name="__codelineno-7-673" href="#__codelineno-7-673"></a>            <span class="n">conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_db_connection</span><span class="p">()</span>
</span><span id="__span-7-674"><a id="__codelineno-7-674" name="__codelineno-7-674" href="#__codelineno-7-674"></a>            <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
</span><span id="__span-7-675"><a id="__codelineno-7-675" name="__codelineno-7-675" href="#__codelineno-7-675"></a>
</span><span id="__span-7-676"><a id="__codelineno-7-676" name="__codelineno-7-676" href="#__codelineno-7-676"></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="__span-7-677"><a id="__codelineno-7-677" name="__codelineno-7-677" href="#__codelineno-7-677"></a>                <span class="c1"># Check if task exists and belongs to user</span>
</span><span id="__span-7-678"><a id="__codelineno-7-678" name="__codelineno-7-678" href="#__codelineno-7-678"></a>                <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;</span>
</span><span id="__span-7-679"><a id="__codelineno-7-679" name="__codelineno-7-679" href="#__codelineno-7-679"></a><span class="s1">                    SELECT id FROM tasks WHERE id = ? AND user_id = ?</span>
</span><span id="__span-7-680"><a id="__codelineno-7-680" name="__codelineno-7-680" href="#__codelineno-7-680"></a><span class="s1">                &#39;&#39;&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">task_id</span><span class="p">,</span> <span class="n">g</span><span class="o">.</span><span class="n">current_user</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]))</span>
</span><span id="__span-7-681"><a id="__codelineno-7-681" name="__codelineno-7-681" href="#__codelineno-7-681"></a>
</span><span id="__span-7-682"><a id="__codelineno-7-682" name="__codelineno-7-682" href="#__codelineno-7-682"></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">():</span>
</span><span id="__span-7-683"><a id="__codelineno-7-683" name="__codelineno-7-683" href="#__codelineno-7-683"></a>                    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Task not found&#39;</span><span class="p">}),</span> <span class="mi">404</span>
</span><span id="__span-7-684"><a id="__codelineno-7-684" name="__codelineno-7-684" href="#__codelineno-7-684"></a>
</span><span id="__span-7-685"><a id="__codelineno-7-685" name="__codelineno-7-685" href="#__codelineno-7-685"></a>                <span class="c1"># Build update query dynamically</span>
</span><span id="__span-7-686"><a id="__codelineno-7-686" name="__codelineno-7-686" href="#__codelineno-7-686"></a>                <span class="n">update_fields</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-7-687"><a id="__codelineno-7-687" name="__codelineno-7-687" href="#__codelineno-7-687"></a>                <span class="n">update_values</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-7-688"><a id="__codelineno-7-688" name="__codelineno-7-688" href="#__codelineno-7-688"></a>
</span><span id="__span-7-689"><a id="__codelineno-7-689" name="__codelineno-7-689" href="#__codelineno-7-689"></a>                <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="s1">&#39;status&#39;</span><span class="p">,</span> <span class="s1">&#39;priority&#39;</span><span class="p">]:</span>
</span><span id="__span-7-690"><a id="__codelineno-7-690" name="__codelineno-7-690" href="#__codelineno-7-690"></a>                    <span class="k">if</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
</span><span id="__span-7-691"><a id="__codelineno-7-691" name="__codelineno-7-691" href="#__codelineno-7-691"></a>                        <span class="n">update_fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s2"> = ?&quot;</span><span class="p">)</span>
</span><span id="__span-7-692"><a id="__codelineno-7-692" name="__codelineno-7-692" href="#__codelineno-7-692"></a>                        <span class="n">update_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">field</span><span class="p">])</span>
</span><span id="__span-7-693"><a id="__codelineno-7-693" name="__codelineno-7-693" href="#__codelineno-7-693"></a>
</span><span id="__span-7-694"><a id="__codelineno-7-694" name="__codelineno-7-694" href="#__codelineno-7-694"></a>                <span class="k">if</span> <span class="n">update_fields</span><span class="p">:</span>
</span><span id="__span-7-695"><a id="__codelineno-7-695" name="__codelineno-7-695" href="#__codelineno-7-695"></a>                    <span class="n">update_fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;updated_at = CURRENT_TIMESTAMP&quot;</span><span class="p">)</span>
</span><span id="__span-7-696"><a id="__codelineno-7-696" name="__codelineno-7-696" href="#__codelineno-7-696"></a>                    <span class="n">update_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">task_id</span><span class="p">)</span>
</span><span id="__span-7-697"><a id="__codelineno-7-697" name="__codelineno-7-697" href="#__codelineno-7-697"></a>
</span><span id="__span-7-698"><a id="__codelineno-7-698" name="__codelineno-7-698" href="#__codelineno-7-698"></a>                    <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;UPDATE tasks SET </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">update_fields</span><span class="p">)</span><span class="si">}</span><span class="s2"> WHERE id = ?&quot;</span>
</span><span id="__span-7-699"><a id="__codelineno-7-699" name="__codelineno-7-699" href="#__codelineno-7-699"></a>                    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">update_values</span><span class="p">)</span>
</span><span id="__span-7-700"><a id="__codelineno-7-700" name="__codelineno-7-700" href="#__codelineno-7-700"></a>                    <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span><span id="__span-7-701"><a id="__codelineno-7-701" name="__codelineno-7-701" href="#__codelineno-7-701"></a>
</span><span id="__span-7-702"><a id="__codelineno-7-702" name="__codelineno-7-702" href="#__codelineno-7-702"></a>                <span class="c1"># Fetch updated task</span>
</span><span id="__span-7-703"><a id="__codelineno-7-703" name="__codelineno-7-703" href="#__codelineno-7-703"></a>                <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;</span>
</span><span id="__span-7-704"><a id="__codelineno-7-704" name="__codelineno-7-704" href="#__codelineno-7-704"></a><span class="s1">                    SELECT id, title, description, status, priority, created_at, updated_at</span>
</span><span id="__span-7-705"><a id="__codelineno-7-705" name="__codelineno-7-705" href="#__codelineno-7-705"></a><span class="s1">                    FROM tasks WHERE id = ?</span>
</span><span id="__span-7-706"><a id="__codelineno-7-706" name="__codelineno-7-706" href="#__codelineno-7-706"></a><span class="s1">                &#39;&#39;&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">task_id</span><span class="p">,))</span>
</span><span id="__span-7-707"><a id="__codelineno-7-707" name="__codelineno-7-707" href="#__codelineno-7-707"></a>
</span><span id="__span-7-708"><a id="__codelineno-7-708" name="__codelineno-7-708" href="#__codelineno-7-708"></a>                <span class="n">task</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">())</span>
</span><span id="__span-7-709"><a id="__codelineno-7-709" name="__codelineno-7-709" href="#__codelineno-7-709"></a>
</span><span id="__span-7-710"><a id="__codelineno-7-710" name="__codelineno-7-710" href="#__codelineno-7-710"></a>                <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
</span><span id="__span-7-711"><a id="__codelineno-7-711" name="__codelineno-7-711" href="#__codelineno-7-711"></a>                    <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;Task updated successfully&#39;</span><span class="p">,</span>
</span><span id="__span-7-712"><a id="__codelineno-7-712" name="__codelineno-7-712" href="#__codelineno-7-712"></a>                    <span class="s1">&#39;task&#39;</span><span class="p">:</span> <span class="n">task</span>
</span><span id="__span-7-713"><a id="__codelineno-7-713" name="__codelineno-7-713" href="#__codelineno-7-713"></a>                <span class="p">}),</span> <span class="mi">200</span>
</span><span id="__span-7-714"><a id="__codelineno-7-714" name="__codelineno-7-714" href="#__codelineno-7-714"></a>
</span><span id="__span-7-715"><a id="__codelineno-7-715" name="__codelineno-7-715" href="#__codelineno-7-715"></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-7-716"><a id="__codelineno-7-716" name="__codelineno-7-716" href="#__codelineno-7-716"></a>                <span class="n">conn</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
</span><span id="__span-7-717"><a id="__codelineno-7-717" name="__codelineno-7-717" href="#__codelineno-7-717"></a>                <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Failed to update task&#39;</span><span class="p">}),</span> <span class="mi">500</span>
</span><span id="__span-7-718"><a id="__codelineno-7-718" name="__codelineno-7-718" href="#__codelineno-7-718"></a>
</span><span id="__span-7-719"><a id="__codelineno-7-719" name="__codelineno-7-719" href="#__codelineno-7-719"></a>            <span class="k">finally</span><span class="p">:</span>
</span><span id="__span-7-720"><a id="__codelineno-7-720" name="__codelineno-7-720" href="#__codelineno-7-720"></a>                <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="__span-7-721"><a id="__codelineno-7-721" name="__codelineno-7-721" href="#__codelineno-7-721"></a>
</span><span id="__span-7-722"><a id="__codelineno-7-722" name="__codelineno-7-722" href="#__codelineno-7-722"></a>        <span class="nd">@self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/tasks/&lt;int:task_id&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;DELETE&#39;</span><span class="p">,</span> <span class="s1">&#39;OPTIONS&#39;</span><span class="p">])</span>
</span><span id="__span-7-723"><a id="__codelineno-7-723" name="__codelineno-7-723" href="#__codelineno-7-723"></a>        <span class="nd">@self</span><span class="o">.</span><span class="n">require_cors</span><span class="p">()</span>
</span><span id="__span-7-724"><a id="__codelineno-7-724" name="__codelineno-7-724" href="#__codelineno-7-724"></a>        <span class="nd">@self</span><span class="o">.</span><span class="n">require_auth</span><span class="p">([</span><span class="s1">&#39;write&#39;</span><span class="p">])</span>
</span><span id="__span-7-725"><a id="__codelineno-7-725" name="__codelineno-7-725" href="#__codelineno-7-725"></a>        <span class="k">def</span><span class="w"> </span><span class="nf">delete_task</span><span class="p">(</span><span class="n">task_id</span><span class="p">):</span>
</span><span id="__span-7-726"><a id="__codelineno-7-726" name="__codelineno-7-726" href="#__codelineno-7-726"></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;Delete a task&quot;&quot;&quot;</span>
</span><span id="__span-7-727"><a id="__codelineno-7-727" name="__codelineno-7-727" href="#__codelineno-7-727"></a>            <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;OPTIONS&#39;</span><span class="p">:</span>
</span><span id="__span-7-728"><a id="__codelineno-7-728" name="__codelineno-7-728" href="#__codelineno-7-728"></a>                <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">200</span>
</span><span id="__span-7-729"><a id="__codelineno-7-729" name="__codelineno-7-729" href="#__codelineno-7-729"></a>
</span><span id="__span-7-730"><a id="__codelineno-7-730" name="__codelineno-7-730" href="#__codelineno-7-730"></a>            <span class="n">conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_db_connection</span><span class="p">()</span>
</span><span id="__span-7-731"><a id="__codelineno-7-731" name="__codelineno-7-731" href="#__codelineno-7-731"></a>            <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
</span><span id="__span-7-732"><a id="__codelineno-7-732" name="__codelineno-7-732" href="#__codelineno-7-732"></a>
</span><span id="__span-7-733"><a id="__codelineno-7-733" name="__codelineno-7-733" href="#__codelineno-7-733"></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="__span-7-734"><a id="__codelineno-7-734" name="__codelineno-7-734" href="#__codelineno-7-734"></a>                <span class="c1"># Check if task exists and belongs to user</span>
</span><span id="__span-7-735"><a id="__codelineno-7-735" name="__codelineno-7-735" href="#__codelineno-7-735"></a>                <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;</span>
</span><span id="__span-7-736"><a id="__codelineno-7-736" name="__codelineno-7-736" href="#__codelineno-7-736"></a><span class="s1">                    SELECT id FROM tasks WHERE id = ? AND user_id = ?</span>
</span><span id="__span-7-737"><a id="__codelineno-7-737" name="__codelineno-7-737" href="#__codelineno-7-737"></a><span class="s1">                &#39;&#39;&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">task_id</span><span class="p">,</span> <span class="n">g</span><span class="o">.</span><span class="n">current_user</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]))</span>
</span><span id="__span-7-738"><a id="__codelineno-7-738" name="__codelineno-7-738" href="#__codelineno-7-738"></a>
</span><span id="__span-7-739"><a id="__codelineno-7-739" name="__codelineno-7-739" href="#__codelineno-7-739"></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">():</span>
</span><span id="__span-7-740"><a id="__codelineno-7-740" name="__codelineno-7-740" href="#__codelineno-7-740"></a>                    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Task not found&#39;</span><span class="p">}),</span> <span class="mi">404</span>
</span><span id="__span-7-741"><a id="__codelineno-7-741" name="__codelineno-7-741" href="#__codelineno-7-741"></a>
</span><span id="__span-7-742"><a id="__codelineno-7-742" name="__codelineno-7-742" href="#__codelineno-7-742"></a>                <span class="c1"># Delete the task</span>
</span><span id="__span-7-743"><a id="__codelineno-7-743" name="__codelineno-7-743" href="#__codelineno-7-743"></a>                <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;DELETE FROM tasks WHERE id = ?&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">task_id</span><span class="p">,))</span>
</span><span id="__span-7-744"><a id="__codelineno-7-744" name="__codelineno-7-744" href="#__codelineno-7-744"></a>                <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span><span id="__span-7-745"><a id="__codelineno-7-745" name="__codelineno-7-745" href="#__codelineno-7-745"></a>
</span><span id="__span-7-746"><a id="__codelineno-7-746" name="__codelineno-7-746" href="#__codelineno-7-746"></a>                <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;Task deleted successfully&#39;</span><span class="p">}),</span> <span class="mi">200</span>
</span><span id="__span-7-747"><a id="__codelineno-7-747" name="__codelineno-7-747" href="#__codelineno-7-747"></a>
</span><span id="__span-7-748"><a id="__codelineno-7-748" name="__codelineno-7-748" href="#__codelineno-7-748"></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-7-749"><a id="__codelineno-7-749" name="__codelineno-7-749" href="#__codelineno-7-749"></a>                <span class="n">conn</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
</span><span id="__span-7-750"><a id="__codelineno-7-750" name="__codelineno-7-750" href="#__codelineno-7-750"></a>                <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Failed to delete task&#39;</span><span class="p">}),</span> <span class="mi">500</span>
</span><span id="__span-7-751"><a id="__codelineno-7-751" name="__codelineno-7-751" href="#__codelineno-7-751"></a>
</span><span id="__span-7-752"><a id="__codelineno-7-752" name="__codelineno-7-752" href="#__codelineno-7-752"></a>            <span class="k">finally</span><span class="p">:</span>
</span><span id="__span-7-753"><a id="__codelineno-7-753" name="__codelineno-7-753" href="#__codelineno-7-753"></a>                <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="__span-7-754"><a id="__codelineno-7-754" name="__codelineno-7-754" href="#__codelineno-7-754"></a>
</span><span id="__span-7-755"><a id="__codelineno-7-755" name="__codelineno-7-755" href="#__codelineno-7-755"></a>        <span class="c1"># Health check endpoint</span>
</span><span id="__span-7-756"><a id="__codelineno-7-756" name="__codelineno-7-756" href="#__codelineno-7-756"></a>        <span class="nd">@self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/health&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
</span><span id="__span-7-757"><a id="__codelineno-7-757" name="__codelineno-7-757" href="#__codelineno-7-757"></a>        <span class="k">def</span><span class="w"> </span><span class="nf">health_check</span><span class="p">():</span>
</span><span id="__span-7-758"><a id="__codelineno-7-758" name="__codelineno-7-758" href="#__codelineno-7-758"></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;API health check&quot;&quot;&quot;</span>
</span><span id="__span-7-759"><a id="__codelineno-7-759" name="__codelineno-7-759" href="#__codelineno-7-759"></a>            <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
</span><span id="__span-7-760"><a id="__codelineno-7-760" name="__codelineno-7-760" href="#__codelineno-7-760"></a>                <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;healthy&#39;</span><span class="p">,</span>
</span><span id="__span-7-761"><a id="__codelineno-7-761" name="__codelineno-7-761" href="#__codelineno-7-761"></a>                <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
</span><span id="__span-7-762"><a id="__codelineno-7-762" name="__codelineno-7-762" href="#__codelineno-7-762"></a>                <span class="s1">&#39;version&#39;</span><span class="p">:</span> <span class="s1">&#39;1.0.0&#39;</span>
</span><span id="__span-7-763"><a id="__codelineno-7-763" name="__codelineno-7-763" href="#__codelineno-7-763"></a>            <span class="p">}),</span> <span class="mi">200</span>
</span><span id="__span-7-764"><a id="__codelineno-7-764" name="__codelineno-7-764" href="#__codelineno-7-764"></a>
</span><span id="__span-7-765"><a id="__codelineno-7-765" name="__codelineno-7-765" href="#__codelineno-7-765"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="__span-7-766"><a id="__codelineno-7-766" name="__codelineno-7-766" href="#__codelineno-7-766"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Run the secure API server&quot;&quot;&quot;</span>
</span><span id="__span-7-767"><a id="__codelineno-7-767" name="__codelineno-7-767" href="#__codelineno-7-767"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Starting Secure Task API...&quot;</span><span class="p">)</span>
</span><span id="__span-7-768"><a id="__codelineno-7-768" name="__codelineno-7-768" href="#__codelineno-7-768"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Available endpoints:&quot;</span><span class="p">)</span>
</span><span id="__span-7-769"><a id="__codelineno-7-769" name="__codelineno-7-769" href="#__codelineno-7-769"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;POST   /api/auth/register&quot;</span><span class="p">)</span>
</span><span id="__span-7-770"><a id="__codelineno-7-770" name="__codelineno-7-770" href="#__codelineno-7-770"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;POST   /api/auth/login&quot;</span><span class="p">)</span>
</span><span id="__span-7-771"><a id="__codelineno-7-771" name="__codelineno-7-771" href="#__codelineno-7-771"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;GET    /api/tasks&quot;</span><span class="p">)</span>
</span><span id="__span-7-772"><a id="__codelineno-7-772" name="__codelineno-7-772" href="#__codelineno-7-772"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;POST   /api/tasks&quot;</span><span class="p">)</span>
</span><span id="__span-7-773"><a id="__codelineno-7-773" name="__codelineno-7-773" href="#__codelineno-7-773"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;PUT    /api/tasks/&lt;id&gt;&quot;</span><span class="p">)</span>
</span><span id="__span-7-774"><a id="__codelineno-7-774" name="__codelineno-7-774" href="#__codelineno-7-774"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;DELETE /api/tasks/&lt;id&gt;&quot;</span><span class="p">)</span>
</span><span id="__span-7-775"><a id="__codelineno-7-775" name="__codelineno-7-775" href="#__codelineno-7-775"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;GET    /api/health&quot;</span><span class="p">)</span>
</span><span id="__span-7-776"><a id="__codelineno-7-776" name="__codelineno-7-776" href="#__codelineno-7-776"></a>
</span><span id="__span-7-777"><a id="__codelineno-7-777" name="__codelineno-7-777" href="#__codelineno-7-777"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="s1">&#39;0.0.0.0&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">5000</span><span class="p">)</span>
</span><span id="__span-7-778"><a id="__codelineno-7-778" name="__codelineno-7-778" href="#__codelineno-7-778"></a>
</span><span id="__span-7-779"><a id="__codelineno-7-779" name="__codelineno-7-779" href="#__codelineno-7-779"></a><span class="k">def</span><span class="w"> </span><span class="nf">api_demonstration</span><span class="p">():</span>
</span><span id="__span-7-780"><a id="__codelineno-7-780" name="__codelineno-7-780" href="#__codelineno-7-780"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Demonstrate the complete secure API&quot;&quot;&quot;</span>
</span><span id="__span-7-781"><a id="__codelineno-7-781" name="__codelineno-7-781" href="#__codelineno-7-781"></a>
</span><span id="__span-7-782"><a id="__codelineno-7-782" name="__codelineno-7-782" href="#__codelineno-7-782"></a>    <span class="c1"># Create and configure the API</span>
</span><span id="__span-7-783"><a id="__codelineno-7-783" name="__codelineno-7-783" href="#__codelineno-7-783"></a>    <span class="n">api</span> <span class="o">=</span> <span class="n">SecureTaskAPI</span><span class="p">()</span>
</span><span id="__span-7-784"><a id="__codelineno-7-784" name="__codelineno-7-784" href="#__codelineno-7-784"></a>
</span><span id="__span-7-785"><a id="__codelineno-7-785" name="__codelineno-7-785" href="#__codelineno-7-785"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Secure Task API initialized with:&quot;</span><span class="p">)</span>
</span><span id="__span-7-786"><a id="__codelineno-7-786" name="__codelineno-7-786" href="#__codelineno-7-786"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;✓ JWT Authentication&quot;</span><span class="p">)</span>
</span><span id="__span-7-787"><a id="__codelineno-7-787" name="__codelineno-7-787" href="#__codelineno-7-787"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;✓ Rate Limiting&quot;</span><span class="p">)</span>
</span><span id="__span-7-788"><a id="__codelineno-7-788" name="__codelineno-7-788" href="#__codelineno-7-788"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;✓ CORS Protection&quot;</span><span class="p">)</span>
</span><span id="__span-7-789"><a id="__codelineno-7-789" name="__codelineno-7-789" href="#__codelineno-7-789"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;✓ Input Validation&quot;</span><span class="p">)</span>
</span><span id="__span-7-790"><a id="__codelineno-7-790" name="__codelineno-7-790" href="#__codelineno-7-790"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;✓ SQL Injection Prevention&quot;</span><span class="p">)</span>
</span><span id="__span-7-791"><a id="__codelineno-7-791" name="__codelineno-7-791" href="#__codelineno-7-791"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;✓ Session Management&quot;</span><span class="p">)</span>
</span><span id="__span-7-792"><a id="__codelineno-7-792" name="__codelineno-7-792" href="#__codelineno-7-792"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;✓ Brute Force Protection&quot;</span><span class="p">)</span>
</span><span id="__span-7-793"><a id="__codelineno-7-793" name="__codelineno-7-793" href="#__codelineno-7-793"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;✓ Comprehensive Logging&quot;</span><span class="p">)</span>
</span><span id="__span-7-794"><a id="__codelineno-7-794" name="__codelineno-7-794" href="#__codelineno-7-794"></a>
</span><span id="__span-7-795"><a id="__codelineno-7-795" name="__codelineno-7-795" href="#__codelineno-7-795"></a>    <span class="c1"># In a real application, you would call api.run()</span>
</span><span id="__span-7-796"><a id="__codelineno-7-796" name="__codelineno-7-796" href="#__codelineno-7-796"></a>    <span class="c1"># For demonstration, we&#39;ll show the security features</span>
</span><span id="__span-7-797"><a id="__codelineno-7-797" name="__codelineno-7-797" href="#__codelineno-7-797"></a>
</span><span id="__span-7-798"><a id="__codelineno-7-798" name="__codelineno-7-798" href="#__codelineno-7-798"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">API Security Features:&quot;</span><span class="p">)</span>
</span><span id="__span-7-799"><a id="__codelineno-7-799" name="__codelineno-7-799" href="#__codelineno-7-799"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;1. Authentication: JWT tokens with expiration&quot;</span><span class="p">)</span>
</span><span id="__span-7-800"><a id="__codelineno-7-800" name="__codelineno-7-800" href="#__codelineno-7-800"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;2. Authorization: Permission-based access control&quot;</span><span class="p">)</span>
</span><span id="__span-7-801"><a id="__codelineno-7-801" name="__codelineno-7-801" href="#__codelineno-7-801"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;3. Rate Limiting: Prevents abuse and DoS attacks&quot;</span><span class="p">)</span>
</span><span id="__span-7-802"><a id="__codelineno-7-802" name="__codelineno-7-802" href="#__codelineno-7-802"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;4. Input Validation: Comprehensive data validation&quot;</span><span class="p">)</span>
</span><span id="__span-7-803"><a id="__codelineno-7-803" name="__codelineno-7-803" href="#__codelineno-7-803"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;5. CORS: Configurable cross-origin policies&quot;</span><span class="p">)</span>
</span><span id="__span-7-804"><a id="__codelineno-7-804" name="__codelineno-7-804" href="#__codelineno-7-804"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;6. SQL Injection: Parameterized queries&quot;</span><span class="p">)</span>
</span><span id="__span-7-805"><a id="__codelineno-7-805" name="__codelineno-7-805" href="#__codelineno-7-805"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;7. XSS Prevention: Input sanitization&quot;</span><span class="p">)</span>
</span><span id="__span-7-806"><a id="__codelineno-7-806" name="__codelineno-7-806" href="#__codelineno-7-806"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;8. Brute Force: Account lockout mechanisms&quot;</span><span class="p">)</span>
</span><span id="__span-7-807"><a id="__codelineno-7-807" name="__codelineno-7-807" href="#__codelineno-7-807"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;9. Session Security: Secure session management&quot;</span><span class="p">)</span>
</span><span id="__span-7-808"><a id="__codelineno-7-808" name="__codelineno-7-808" href="#__codelineno-7-808"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;10. Error Handling: Safe error messages&quot;</span><span class="p">)</span>
</span><span id="__span-7-809"><a id="__codelineno-7-809" name="__codelineno-7-809" href="#__codelineno-7-809"></a>
</span><span id="__span-7-810"><a id="__codelineno-7-810" name="__codelineno-7-810" href="#__codelineno-7-810"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
</span><span id="__span-7-811"><a id="__codelineno-7-811" name="__codelineno-7-811" href="#__codelineno-7-811"></a>    <span class="n">api_demonstration</span><span class="p">()</span>
</span></code></pre></div>
<h2 id="summary-and-best-practices">Summary and Best Practices<a class="headerlink" href="#summary-and-best-practices" title="Permanent link">&para;</a></h2>
<p>This section has covered comprehensive <span class="glossary-term" data-glossary-category="Web Development" data-glossary-definition="A set of protocols and tools for building software applications, defining how components interact." data-glossary-full-form="Application Programming Interface" data-glossary-term="API">API</span> security through practical implementation. Here are the key takeaways:</p>
<h3 id="essential-security-principles">Essential Security Principles<a class="headerlink" href="#essential-security-principles" title="Permanent link">&para;</a></h3>
<ol>
<li>
<p><strong>Defense in Depth</strong>: Multiple layers of security controls</p>
</li>
<li>
<p><strong>Fail Securely</strong>: Default to secure states when errors occur</p>
</li>
<li>
<p><strong>Least Privilege</strong>: Grant minimum necessary permissions</p>
</li>
<li>
<p><strong>Security by Design</strong>: Build security from the ground up</p>
</li>
</ol>
<h3 id="implementation-checklist">Implementation Checklist<a class="headerlink" href="#implementation-checklist" title="Permanent link">&para;</a></h3>
<details class="example">
<summary>Authentication Security</summary>
<h4 id="api-keys"><span class="glossary-term" data-glossary-category="Web Development" data-glossary-definition="A set of protocols and tools for building software applications, defining how components interact." data-glossary-full-form="Application Programming Interface" data-glossary-term="API">API</span> Keys<a class="headerlink" href="#api-keys" title="Permanent link">&para;</a></h4>
<ul>
<li>
<p>Cryptographically secure generation</p>
</li>
<li>
<p>Secure storage (hash, never plain text)</p>
</li>
<li>
<p>Expiration and revocation mechanisms</p>
</li>
<li>
<p>Rate limiting integration</p>
</li>
</ul>
<h4 id="jwt-tokens">JWT Tokens<a class="headerlink" href="#jwt-tokens" title="Permanent link">&para;</a></h4>
<ul>
<li>
<p>Strong secret keys</p>
</li>
<li>
<p>Token expiration policies</p>
</li>
<li>
<p>Blacklist capabilities</p>
</li>
<li>
<p>Permission-based access control</p>
</li>
</ul>
<h4 id="oauth-20">OAuth 2.0<a class="headerlink" href="#oauth-20" title="Permanent link">&para;</a></h4>
<ul>
<li>
<p>Proper flow implementation</p>
</li>
<li>
<p>Scope validation</p>
</li>
<li>
<p><span class="glossary-term" data-glossary-category="OOP" data-glossary-definition="The set of values of all attributes of an object at a particular point in time during program execution." data-glossary-term="State">State</span> parameter for CSRF protection</p>
</li>
<li>
<p>Secure token storage</p>
</li>
</ul>
</details>
<details class="example">
<summary>Rate Limiting &amp; DoS Protection</summary>
<h4 id="token-bucket-algorithm">Token Bucket <span class="glossary-term" data-glossary-category="Programming Fundamentals" data-glossary-definition="A finite sequence of well-defined instructions to solve a problem or perform a computation." data-glossary-term="Algorithm">Algorithm</span><a class="headerlink" href="#token-bucket-algorithm" title="Permanent link">&para;</a></h4>
<ul>
<li>
<p>Configurable rates per identifier</p>
</li>
<li>
<p>Burst capacity management</p>
</li>
<li>
<p>Thread-safe implementation</p>
</li>
</ul>
<h4 id="progressive-penalties">Progressive Penalties<a class="headerlink" href="#progressive-penalties" title="Permanent link">&para;</a></h4>
<ul>
<li>
<p>Suspicion level calculation</p>
</li>
<li>
<p><span class="glossary-term" data-glossary-category="Web Development" data-glossary-definition="A suite of communication protocols used to interconnect network devices on the internet and most private networks." data-glossary-full-form="Transmission Control Protocol/Internet Protocol" data-glossary-term="TCP/IP">IP</span>-based blocking</p>
</li>
<li>
<p>Pattern recognition</p>
</li>
<li>
<p>Automated responses</p>
</li>
</ul>
</details>
<details class="example">
<summary>Session Management</summary>
<h4 id="secure-session-ids">Secure Session IDs<a class="headerlink" href="#secure-session-ids" title="Permanent link">&para;</a></h4>
<ul>
<li>
<p>Cryptographically random generation</p>
</li>
<li>
<p>Session rotation to prevent fixation</p>
</li>
<li>
<p>Timeout management</p>
</li>
<li>
<p><span class="glossary-term" data-glossary-category="Web Development" data-glossary-definition="A suite of communication protocols used to interconnect network devices on the internet and most private networks." data-glossary-full-form="Transmission Control Protocol/Internet Protocol" data-glossary-term="TCP/IP">IP</span> and user agent validation</p>
</li>
</ul>
<h4 id="security-features">Security Features<a class="headerlink" href="#security-features" title="Permanent link">&para;</a></h4>
<ul>
<li>
<p>CSRF token protection</p>
</li>
<li>
<p>Concurrent session limits</p>
</li>
<li>
<p>Suspicious activity tracking</p>
</li>
<li>
<p>Secure cookie <span class="glossary-term" data-glossary-category="OOP" data-glossary-definition="A named property or characteristic of an object in object-oriented programming, storing data about the object." data-glossary-term="Attribute">attributes</span></p>
</li>
</ul>
</details>
<details class="example">
<summary>CORS Security</summary>
<h4 id="origin-validation">Origin Validation<a class="headerlink" href="#origin-validation" title="Permanent link">&para;</a></h4>
<ul>
<li>
<p>Whitelist-based origin control</p>
</li>
<li>
<p>Pattern matching with security checks</p>
</li>
<li>
<p>Credential-aware policies</p>
</li>
<li>
<p>Preflight request handling</p>
</li>
</ul>
<h4 id="security-patterns">Security Patterns<a class="headerlink" href="#security-patterns" title="Permanent link">&para;</a></h4>
<ul>
<li>
<p>Dangerous origin blocking</p>
</li>
<li>
<p><span class="glossary-term" data-glossary-category="OOP" data-glossary-definition="A function defined within a class that describes the behaviors of objects created from that class." data-glossary-term="Method">Method</span> restriction</p>
</li>
<li>
<p>Header validation</p>
</li>
<li>
<p>Environment-specific policies</p>
</li>
</ul>
</details>
<details class="example">
<summary>Security Testing</summary>
<h4 id="automated-testing">Automated Testing<a class="headerlink" href="#automated-testing" title="Permanent link">&para;</a></h4>
<ul>
<li>
<p>Authentication vulnerability tests</p>
</li>
<li>
<p>Injection attack simulation</p>
</li>
<li>
<p>Rate limiting verification</p>
</li>
<li>
<p>CORS policy validation</p>
</li>
</ul>
<h4 id="comprehensive-coverage">Comprehensive Coverage<a class="headerlink" href="#comprehensive-coverage" title="Permanent link">&para;</a></h4>
<ul>
<li>
<p><span class="glossary-term" data-glossary-category="Web Development" data-glossary-definition="A standardized programming language used for managing and manipulating relational databases." data-glossary-full-form="Structured Query Language" data-glossary-term="SQL">SQL</span> injection with real payloads</p>
</li>
<li>
<p>XSS detection mechanisms</p>
</li>
<li>
<p>Path traversal testing</p>
</li>
<li>
<p>Security score calculation</p>
</li>
</ul>
</details>
<h3 id="production-deployment-considerations">Production Deployment Considerations<a class="headerlink" href="#production-deployment-considerations" title="Permanent link">&para;</a></h3>
<ol>
<li>
<p><strong><span class="glossary-term" data-glossary-category="Web Development" data-glossary-definition="The foundation protocol for data communication on the World Wide Web. HTTPS is the secure version using encryption." data-glossary-full-form="Hypertext Transfer Protocol (Secure)" data-glossary-term="HTTPS">HTTPS</span> Only</strong>: Never deploy <span class="glossary-term" data-glossary-category="Web Development" data-glossary-definition="A set of protocols and tools for building software applications, defining how components interact." data-glossary-full-form="Application Programming Interface" data-glossary-term="API">APIs</span> without <span class="glossary-term" data-glossary-category="Security" data-glossary-definition="A cryptographic protocol designed to provide secure communication over a computer network, the successor to SSL." data-glossary-full-form="Transport Layer Security" data-glossary-term="TLS">TLS</span> encryption</p>
</li>
<li>
<p><strong>Environment Separation</strong>: Different security policies for dev/<span class="glossary-term" data-glossary-category="Project Management" data-glossary-definition="A pre-production environment that mirrors the production environment, used for final testing before deployment." data-glossary-term="Staging">staging</span>/production</p>
</li>
<li>
<p><strong>Monitoring</strong>: Comprehensive logging and alerting</p>
</li>
<li>
<p><strong>Updates</strong>: Regular security patches and dependency updates</p>
</li>
<li>
<p><strong>Backup</strong>: Secure data backup and recovery <span class="glossary-term" data-glossary-category="Programming Fundamentals" data-glossary-definition="A reusable block of code that performs a specific task but does not return a value, similar to a void function." data-glossary-term="Procedure">procedures</span></p>
</li>
</ol>
<h3 id="common-pitfalls-to-avoid">Common Pitfalls to Avoid<a class="headerlink" href="#common-pitfalls-to-avoid" title="Permanent link">&para;</a></h3>
<ul>
<li>
<p><strong>Overly Permissive CORS</strong>: Never use <code>*</code> with credentials enabled</p>
</li>
<li>
<p><strong>Weak Rate Limiting</strong>: Implement multiple rate limiting strategies</p>
</li>
<li>
<p><strong>Poor Error Messages</strong>: Don&rsquo;t leak sensitive information in errors</p>
</li>
<li>
<p><strong>Insufficient Logging</strong>: Log security events for monitoring</p>
</li>
<li>
<p><strong>Hardcoded Secrets</strong>: Use environment <span class="glossary-term" data-glossary-category="Programming Fundamentals" data-glossary-definition="A named storage location in memory that holds a value which can change during program execution." data-glossary-term="Variable">variables</span> for sensitive data</p>
</li>
</ul>
<p>This comprehensive implementation provides a solid foundation for building secure <span class="glossary-term" data-glossary-category="Web Development" data-glossary-definition="A set of protocols and tools for building software applications, defining how components interact." data-glossary-full-form="Application Programming Interface" data-glossary-term="API">APIs</span> that protect against real-world threats while maintaining usability and performance.</p>
<h2 id="practice-questions-and-exercises">Practice Questions and Exercises<a class="headerlink" href="#practice-questions-and-exercises" title="Permanent link">&para;</a></h2>
<details class="tip">
<summary>Quick Review Questions</summary>
<ol>
<li>
<p>What are the three main components of a JWT token and what information does each contain?</p>
</li>
<li>
<p>Explain the difference between symmetric and asymmetric encryption in the context of <span class="glossary-term" data-glossary-category="Web Development" data-glossary-definition="A set of protocols and tools for building software applications, defining how components interact." data-glossary-full-form="Application Programming Interface" data-glossary-term="API">API</span> security.</p>
</li>
<li>
<p>How does the token bucket <span class="glossary-term" data-glossary-category="Programming Fundamentals" data-glossary-definition="A finite sequence of well-defined instructions to solve a problem or perform a computation." data-glossary-term="Algorithm">algorithm</span> prevent DoS attacks while allowing legitimate burst traffic?</p>
</li>
<li>
<p>What is the purpose of the <code>OPTIONS</code> <span class="glossary-term" data-glossary-category="OOP" data-glossary-definition="A function defined within a class that describes the behaviors of objects created from that class." data-glossary-term="Method">method</span> in CORS preflight requests?</p>
</li>
<li>
<p>Why should <span class="glossary-term" data-glossary-category="Web Development" data-glossary-definition="A set of protocols and tools for building software applications, defining how components interact." data-glossary-full-form="Application Programming Interface" data-glossary-term="API">API</span> keys be stored as hashes rather than plain text?</p>
</li>
<li>
<p>What security vulnerabilities does session rotation help prevent?</p>
</li>
<li>
<p>Explain how rate limiting can be implemented at different layers of an <span class="glossary-term" data-glossary-category="Web Development" data-glossary-definition="A set of protocols and tools for building software applications, defining how components interact." data-glossary-full-form="Application Programming Interface" data-glossary-term="API">API</span> architecture.</p>
</li>
<li>
<p>What is the significance of the <code>nonce</code> parameter in OAuth 2.0 flows?</p>
</li>
<li>
<p>How do CSRF tokens protect against cross-site request forgery attacks?</p>
</li>
<li>
<p>What are the key indicators that an <span class="glossary-term" data-glossary-category="Web Development" data-glossary-definition="A set of protocols and tools for building software applications, defining how components interact." data-glossary-full-form="Application Programming Interface" data-glossary-term="API">API</span> security testing <span class="glossary-term" data-glossary-category="Web Development" data-glossary-definition="A pre-built structure providing a foundation and tools for developing software applications more efficiently." data-glossary-term="Framework">framework</span> should monitor?</p>
</li>
</ol>
</details>
<details class="example">
<summary>Practical Programming Exercises</summary>
<h3 id="exercise-1-secure-registration-system">Exercise 1: Secure Registration System<a class="headerlink" href="#exercise-1-secure-registration-system" title="Permanent link">&para;</a></h3>
<p>Implement a user registration system that includes:</p>
<ul>
<li>
<p>Password strength validation (minimum 8 characters, mixed case, numbers, symbols)</p>
</li>
<li>
<p>Email verification with time-limited tokens</p>
</li>
<li>
<p>Rate limiting for registration attempts</p>
</li>
<li>
<p><span class="glossary-term" data-glossary-category="Web Development" data-glossary-definition="A standardized programming language used for managing and manipulating relational databases." data-glossary-full-form="Structured Query Language" data-glossary-term="SQL">SQL</span> injection prevention</p>
</li>
<li>
<p>Input sanitization for all fields</p>
</li>
</ul>
<p><strong>Requirements:</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">SecureRegistration</span><span class="p">:</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">validate_password</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span>
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">generate_verification_token</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span>
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">verify_email_token</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span>
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">register_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span>
</span></code></pre></div>
<h3 id="exercise-2-api-rate-limiter">Exercise 2: <span class="glossary-term" data-glossary-category="Web Development" data-glossary-definition="A set of protocols and tools for building software applications, defining how components interact." data-glossary-full-form="Application Programming Interface" data-glossary-term="API">API</span> Rate Limiter<a class="headerlink" href="#exercise-2-api-rate-limiter" title="Permanent link">&para;</a></h3>
<p>Create a configurable rate limiting system with:</p>
<ul>
<li>
<p>Multiple rate limiting strategies (fixed window, sliding window, token bucket)</p>
</li>
<li>
<p>Per-user and per-<span class="glossary-term" data-glossary-category="Web Development" data-glossary-definition="A suite of communication protocols used to interconnect network devices on the internet and most private networks." data-glossary-full-form="Transmission Control Protocol/Internet Protocol" data-glossary-term="TCP/IP">IP</span> tracking</p>
</li>
<li>
<p>Redis backend for distributed applications</p>
</li>
<li>
<p>Automatic rate limit adjustment based on server load</p>
</li>
</ul>
<p><strong>Requirements:</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">AdvancedRateLimiter</span><span class="p">:</span>
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">set_rate_limit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identifier</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">window</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span>
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">check_rate_limit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identifier</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]</span>
</span><span id="__span-9-4"><a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">reset_rate_limit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identifier</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span>
</span><span id="__span-9-5"><a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_rate_limit_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identifier</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span>
</span></code></pre></div>
<h3 id="exercise-3-cors-security-manager">Exercise 3: CORS Security Manager<a class="headerlink" href="#exercise-3-cors-security-manager" title="Permanent link">&para;</a></h3>
<p>Build a comprehensive CORS management system with:</p>
<ul>
<li>
<p>Environment-specific policies</p>
</li>
<li>
<p>Origin pattern matching with wildcards</p>
</li>
<li>
<p>Security validation for dangerous combinations</p>
</li>
<li>
<p>Real-time policy updates without service restart</p>
</li>
</ul>
<p><strong>Requirements:</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">EnhancedCORSManager</span><span class="p">:</span>
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_policy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span>
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">validate_origin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">origin</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">policy</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span>
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">handle_preflight</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span>
</span><span id="__span-10-5"><a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">update_policy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">updates</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span>
</span></code></pre></div>
<h3 id="exercise-4-security-testing-suite">Exercise 4: Security Testing Suite<a class="headerlink" href="#exercise-4-security-testing-suite" title="Permanent link">&para;</a></h3>
<p>Develop an automated security testing <span class="glossary-term" data-glossary-category="Web Development" data-glossary-definition="A pre-built structure providing a foundation and tools for developing software applications more efficiently." data-glossary-term="Framework">framework</span> for:</p>
<ul>
<li>
<p>Authentication bypass testing</p>
</li>
<li>
<p>Authorization escalation detection</p>
</li>
<li>
<p>Input validation verification</p>
</li>
<li>
<p>Rate limiting effectiveness</p>
</li>
<li>
<p>Session security validation</p>
</li>
</ul>
<p><strong>Requirements:</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">SecurityTestSuite</span><span class="p">:</span>
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_authentication</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">api_endpoint</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span>
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_authorization</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_roles</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">dict</span>
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_input_validation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">endpoints</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">dict</span>
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">generate_security_report</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span>
</span></code></pre></div>
</details>
<details class="warning">
<summary>Case Study Analysis</summary>
<h3 id="case-study-e-commerce-api-security-breach">Case Study: E-commerce <span class="glossary-term" data-glossary-category="Web Development" data-glossary-definition="A set of protocols and tools for building software applications, defining how components interact." data-glossary-full-form="Application Programming Interface" data-glossary-term="API">API</span> Security Breach<a class="headerlink" href="#case-study-e-commerce-api-security-breach" title="Permanent link">&para;</a></h3>
<p><strong>Scenario:</strong> An e-commerce platform suffered a security breach where attackers:</p>
<ol>
<li>
<p>Exploited weak <span class="glossary-term" data-glossary-category="Web Development" data-glossary-definition="A set of protocols and tools for building software applications, defining how components interact." data-glossary-full-form="Application Programming Interface" data-glossary-term="API">API</span> authentication to access user accounts</p>
</li>
<li>
<p>Used <span class="glossary-term" data-glossary-category="Web Development" data-glossary-definition="A standardized programming language used for managing and manipulating relational databases." data-glossary-full-form="Structured Query Language" data-glossary-term="SQL">SQL</span> injection to extract customer payment data</p>
</li>
<li>
<p>Performed credential stuffing attacks due to lack of rate limiting</p>
</li>
<li>
<p>Bypassed CORS protections through domain spoofing</p>
</li>
</ol>
<p><strong>Analysis Questions:</strong></p>
<ol>
<li>
<p><strong>Authentication Vulnerabilities:</strong></p>
</li>
<li>
<p>What specific authentication weaknesses likely enabled the account access?</p>
</li>
<li>
<p>How could JWT implementation flaws contribute to this breach?</p>
</li>
<li>
<p>What multi-factor authentication strategies could have prevented this?</p>
</li>
<li>
<p><strong>Injection Prevention:</strong></p>
</li>
<li>
<p>Which input validation techniques would have stopped the <span class="glossary-term" data-glossary-category="Web Development" data-glossary-definition="A standardized programming language used for managing and manipulating relational databases." data-glossary-full-form="Structured Query Language" data-glossary-term="SQL">SQL</span> injection?</p>
</li>
<li>
<p>How should parameterized queries be implemented in the <span class="glossary-term" data-glossary-category="Web Development" data-glossary-definition="A set of protocols and tools for building software applications, defining how components interact." data-glossary-full-form="Application Programming Interface" data-glossary-term="API">API</span> layer?</p>
</li>
<li>
<p>What role does output encoding play in preventing data extraction?</p>
</li>
<li>
<p><strong>Rate Limiting Failures:</strong></p>
</li>
<li>
<p>Why might traditional rate limiting have failed against credential stuffing?</p>
</li>
<li>
<p>How could progressive penalties have detected the attack pattern?</p>
</li>
<li>
<p>What rate limiting strategies work best for authentication endpoints?</p>
</li>
<li>
<p><strong>CORS Bypass Analysis:</strong></p>
</li>
<li>
<p>How do attackers typically bypass CORS protections?</p>
</li>
<li>
<p>What origin validation techniques prevent domain spoofing?</p>
</li>
<li>
<p>How should CORS policies be configured for financial applications?</p>
</li>
</ol>
<p><strong>Remediation Plan:</strong></p>
<p>Design a comprehensive security improvement plan that addresses each vulnerability type with specific technical controls and monitoring mechanisms.</p>
</details>
<h2 id="summary-checklist">Summary Checklist<a class="headerlink" href="#summary-checklist" title="Permanent link">&para;</a></h2>
<p>Use this checklist to ensure comprehensive <span class="glossary-term" data-glossary-category="Web Development" data-glossary-definition="A set of protocols and tools for building software applications, defining how components interact." data-glossary-full-form="Application Programming Interface" data-glossary-term="API">API</span> security implementation:</p>
<h3 id="authentication-authorization">Authentication &amp; Authorization<a class="headerlink" href="#authentication-authorization" title="Permanent link">&para;</a></h3>
<ul class="task-list">
<li class="task-list-item">
<p><input type="checkbox" disabled/> Strong password policies enforced</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Multi-factor authentication implemented</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> JWT tokens with proper expiration</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> <span class="glossary-term" data-glossary-category="Web Development" data-glossary-definition="A set of protocols and tools for building software applications, defining how components interact." data-glossary-full-form="Application Programming Interface" data-glossary-term="API">API</span> key rotation mechanisms</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> OAuth 2.0 secure flows</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Permission-based access control</p>
</li>
</ul>
<h3 id="rate-limiting-dos-protection">Rate Limiting &amp; DoS Protection<a class="headerlink" href="#rate-limiting-dos-protection" title="Permanent link">&para;</a></h3>
<ul class="task-list">
<li class="task-list-item">
<p><input type="checkbox" disabled/> Multiple rate limiting strategies</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Progressive penalty systems</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> <span class="glossary-term" data-glossary-category="Web Development" data-glossary-definition="A suite of communication protocols used to interconnect network devices on the internet and most private networks." data-glossary-full-form="Transmission Control Protocol/Internet Protocol" data-glossary-term="TCP/IP">IP</span>-based blocking capabilities</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Burst traffic handling</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Distributed rate limiting support</p>
</li>
</ul>
<h3 id="input-validation-sanitization">Input Validation &amp; Sanitization<a class="headerlink" href="#input-validation-sanitization" title="Permanent link">&para;</a></h3>
<ul class="task-list">
<li class="task-list-item">
<p><input type="checkbox" disabled/> Comprehensive validation rules</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> <span class="glossary-term" data-glossary-category="Web Development" data-glossary-definition="A standardized programming language used for managing and manipulating relational databases." data-glossary-full-form="Structured Query Language" data-glossary-term="SQL">SQL</span> injection prevention</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> XSS protection mechanisms</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> File upload security</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Parameter tampering protection</p>
</li>
</ul>
<h3 id="session-management">Session Management<a class="headerlink" href="#session-management" title="Permanent link">&para;</a></h3>
<ul class="task-list">
<li class="task-list-item">
<p><input type="checkbox" disabled/> Secure session ID generation</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Session rotation implementation</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Timeout management</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Concurrent session limits</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> CSRF protection</p>
</li>
</ul>
<h3 id="cors-cross-origin-security">CORS &amp; Cross-Origin Security<a class="headerlink" href="#cors-cross-origin-security" title="Permanent link">&para;</a></h3>
<ul class="task-list">
<li class="task-list-item">
<p><input type="checkbox" disabled/> Whitelist-based origin control</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Preflight request handling</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Credential policy management</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Environment-specific policies</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Security header implementation</p>
</li>
</ul>
<h3 id="monitoring-testing">Monitoring &amp; Testing<a class="headerlink" href="#monitoring-testing" title="Permanent link">&para;</a></h3>
<ul class="task-list">
<li class="task-list-item">
<p><input type="checkbox" disabled/> Automated security testing</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Vulnerability scanning</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Security event logging</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Incident response <span class="glossary-term" data-glossary-category="Programming Fundamentals" data-glossary-definition="A reusable block of code that performs a specific task but does not return a value, similar to a void function." data-glossary-term="Procedure">procedures</span></p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Regular security <span class="glossary-term" data-glossary-category="Security" data-glossary-definition="A systematic examination and verification of an organization&#39;s records, processes, or systems to ensure compliance and identify improvements." data-glossary-term="Audit">audits</span></p>
</li>
</ul>
<h3 id="deployment-security">Deployment Security<a class="headerlink" href="#deployment-security" title="Permanent link">&para;</a></h3>
<ul class="task-list">
<li class="task-list-item">
<p><input type="checkbox" disabled/> <span class="glossary-term" data-glossary-category="Web Development" data-glossary-definition="The foundation protocol for data communication on the World Wide Web. HTTPS is the secure version using encryption." data-glossary-full-form="Hypertext Transfer Protocol (Secure)" data-glossary-term="HTTPS">HTTPS</span> enforcement</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Secure configuration management</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Environment separation</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Secret management</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Regular updates and patches</p>
</li>
</ul>







  
    
  
  


  <aside class="md-source-file">
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="Last update">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date" title="October 31, 2025 01:04:13 UTC">October 31, 2025</span>
  </span>

    
    
    
    
  </aside>


  



  <form class="md-feedback" name="feedback" hidden>
    <fieldset>
      <legend class="md-feedback__title">
        Was this page helpful?
      </legend>
      <div class="md-feedback__inner">
        <div class="md-feedback__list">
          
            <button class="md-feedback__icon md-icon" type="submit" title="This page was helpful" data-md-value="1">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 12a8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8 8 8 0 0 0 8-8m2 0a10 10 0 0 1-10 10A10 10 0 0 1 2 12 10 10 0 0 1 12 2a10 10 0 0 1 10 10M10 9.5c0 .8-.7 1.5-1.5 1.5S7 10.3 7 9.5 7.7 8 8.5 8s1.5.7 1.5 1.5m7 0c0 .8-.7 1.5-1.5 1.5S14 10.3 14 9.5 14.7 8 15.5 8s1.5.7 1.5 1.5m-5 7.73c-1.75 0-3.29-.73-4.19-1.81L9.23 14c.45.72 1.52 1.23 2.77 1.23s2.32-.51 2.77-1.23l1.42 1.42c-.9 1.08-2.44 1.81-4.19 1.81"/></svg>
            </button>
          
            <button class="md-feedback__icon md-icon" type="submit" title="This page could be improved" data-md-value="0">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 12a8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8 8 8 0 0 0 8-8m2 0a10 10 0 0 1-10 10A10 10 0 0 1 2 12 10 10 0 0 1 12 2a10 10 0 0 1 10 10m-6.5-4c.8 0 1.5.7 1.5 1.5s-.7 1.5-1.5 1.5-1.5-.7-1.5-1.5.7-1.5 1.5-1.5M10 9.5c0 .8-.7 1.5-1.5 1.5S7 10.3 7 9.5 7.7 8 8.5 8s1.5.7 1.5 1.5m2 4.5c1.75 0 3.29.72 4.19 1.81l-1.42 1.42C14.32 16.5 13.25 16 12 16s-2.32.5-2.77 1.23l-1.42-1.42C8.71 14.72 10.25 14 12 14"/></svg>
            </button>
          
        </div>
        <div class="md-feedback__note">
          
            <div data-md-value="1" hidden>
              
              
                
              
              
              
                
                
              
              Thanks for your feedback!
            </div>
          
            <div data-md-value="0" hidden>
              
              
                
              
              
              
                
                
              
              Thanks for your feedback! Help us improve this page by creating an <a href="https://github.com/Eatham532/Software-Engineering-HSC-Textbook/issues/new/choose" target="_blank" rel="noopener">issue</a> on github.
            </div>
          
        </div>
      </div>
    </fieldset>
  </form>


                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        

<!-- Footer -->
<footer class="md-footer">
  
    <!-- Custom footer with left/right layout -->
    <div class="md-footer__inner md-grid">
      <!-- Left side: Copyright and cookie settings -->
      <div class="md-footer__left">
        <div class="md-footer__copyright">
          
            Copyright &copy; 2025 Eatham532 – <a href="#__consent">Change cookie settings</a>

          
        </div>
      </div>

      <!-- Right side: Page name and BETA -->
      <div class="md-footer__right">
        <div class="md-footer__page-info">
          <span class="md-footer__page-title">Content</span>
          
            <span class="md-footer__beta-badge">BETA</span>
          
        </div>
      </div>
    </div>
  
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
      <div class="md-progress" data-md-component="progress" role="progressbar"></div>
    
    
      <div class="md-consent" data-md-component="consent" id="__consent" hidden>
        <div class="md-consent__overlay"></div>
        <aside class="md-consent__inner">
          <form class="md-consent__form md-grid md-typeset" name="consent">
            



<h4>Cookie consent</h4>
<p>We use cookies to recognize your repeated visits and preferences, as well as to measure the effectiveness of the textbook. With your consent, you're helping us to make software engineering education better for everyone.</p>
<input class="md-toggle" type="checkbox" id="__settings" >
<div class="md-consent__settings">
  <ul class="task-list">
    
    
    
      
        
  
  
    
    
  
  <li class="task-list-item">
    <label class="task-list-control">
      <input type="checkbox" name="github" checked>
      <span class="task-list-indicator"></span>
      GitHub
    </label>
  </li>

      
    
    
      
        
  
  
    
    
  
  <li class="task-list-item">
    <label class="task-list-control">
      <input type="checkbox" name="analytics" checked>
      <span class="task-list-indicator"></span>
      Google Analytics
    </label>
  </li>

      
    
  </ul>
</div>
<div class="md-consent__controls">
  
    
      <button class="md-button md-button--primary">Accept</button>
    
    
    
  
    
    
    
      <label class="md-button" for="__settings">Manage settings</label>
    
  
</div>
          </form>
        </aside>
      </div>
      <script>var consent=__md_get("__consent");if(consent)for(var input of document.forms.consent.elements)input.name&&(input.checked=consent[input.name]||!1);else"file:"!==location.protocol&&setTimeout((function(){document.querySelector("[data-md-component=consent]").hidden=!1}),250);var form=document.forms.consent;for(var action of["submit","reset"])form.addEventListener(action,(function(e){if(e.preventDefault(),"reset"===e.type)for(var n of document.forms.consent.elements)n.name&&(n.checked=!1);__md_set("__consent",Object.fromEntries(Array.from(new FormData(form).keys()).map((function(e){return[e,!0]})))),location.hash="",location.reload()}))</script>
    
    
      
      <script id="__config" type="application/json">{"base": "../../../..", "features": ["navigation.tabs", "navigation.top", "navigation.instant", "navigation.instant.prefetch", "navigation.instant.progress", "navigation.prune", "search.highlight", "search.suggest", "content.code.annotate", "content.code.copy", "content.code.select", "content.tabs.link", "content.action.edit", "content.action.view", "toc.follow"], "search": "../../../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
        <script src="../../../../assets/diagram-modal.js"></script>
      
        <script src="../../../../assets/quiz.js"></script>
      
        <script src="../../../../assets/ide-utils.js"></script>
      
        <script src="../../../../assets/code-blocks.js"></script>
      
        <script src="../../../../assets/glossary.js"></script>
      
    
  </body>
</html>